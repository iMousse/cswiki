<!DOCTYPE html>
<html lang="zh-CN" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>微服务保护 | 知识小册子</title>
    <meta name="description" content="搭建个人的知识体系,一个好的知识体系和学习方法会让自己事半功倍">
    <meta name="generator" content="VitePress v1.0.0-rc.40">
    <link rel="preload stylesheet" href="/cswiki/assets/style.1gwXlvdp.css" as="style">
    
    <script type="module" src="/cswiki/assets/app.2vCm0yC_.js"></script>
    <link rel="preload" href="/cswiki/assets/inter-roman-latin.bvIUbFQP.woff2" as="font" type="font/woff2" crossorigin="">
    <link rel="modulepreload" href="/cswiki/assets/chunks/framework.syB9hai_.js">
    <link rel="modulepreload" href="/cswiki/assets/chunks/theme.uUQzhaIk.js">
    <link rel="modulepreload" href="/cswiki/assets/chunks/c4Diagram-0115bee6.i_vYzi03.js">
    <link rel="modulepreload" href="/cswiki/assets/chunks/flowDiagram-786cd8ff.w8qFEUTX.js">
    <link rel="modulepreload" href="/cswiki/assets/chunks/flowDiagram-v2-65161881.Tc8CMeIO.js">
    <link rel="modulepreload" href="/cswiki/assets/chunks/erDiagram-de1b0455.hOU3imRp.js">
    <link rel="modulepreload" href="/cswiki/assets/chunks/gitGraphDiagram-5269e1d6.OJGvbDea.js">
    <link rel="modulepreload" href="/cswiki/assets/chunks/ganttDiagram-f2041c70.7VH6eOrL.js">
    <link rel="modulepreload" href="/cswiki/assets/chunks/infoDiagram-3fa6ea12.Pe3xPMMm.js">
    <link rel="modulepreload" href="/cswiki/assets/chunks/pieDiagram-6d9582b9.ArD9KJpC.js">
    <link rel="modulepreload" href="/cswiki/assets/chunks/quadrantDiagram-a1c81500.rOfpzr64.js">
    <link rel="modulepreload" href="/cswiki/assets/chunks/requirementDiagram-3256a2fe.SviItEW9.js">
    <link rel="modulepreload" href="/cswiki/assets/chunks/sequenceDiagram-25152a15.KRTAgHI7.js">
    <link rel="modulepreload" href="/cswiki/assets/chunks/classDiagram-819d3ad4.mJAv3kX_.js">
    <link rel="modulepreload" href="/cswiki/assets/chunks/classDiagram-v2-c4607319.F-yEFAA3.js">
    <link rel="modulepreload" href="/cswiki/assets/chunks/stateDiagram-693ac5fb.UnIsTY0k.js">
    <link rel="modulepreload" href="/cswiki/assets/chunks/stateDiagram-v2-8f2bb0da.eVbfuf3j.js">
    <link rel="modulepreload" href="/cswiki/assets/chunks/journeyDiagram-9f355b40.7OfKtIPQ.js">
    <link rel="modulepreload" href="/cswiki/assets/chunks/flowchart-elk-definition-3f2388fe.wgxuFnug.js">
    <link rel="modulepreload" href="/cswiki/assets/chunks/timeline-definition-0c903a0d.Pt1w-4h0.js">
    <link rel="modulepreload" href="/cswiki/assets/chunks/mindmap-definition-35a1e92c.ylT5bySP.js">
    <link rel="modulepreload" href="/cswiki/assets/chunks/sankeyDiagram-ebb0d63f.-9xs8Gkd.js">
    <link rel="modulepreload" href="/cswiki/assets/chunks/virtual_mermaid-config.AhCe4kHV.js">
    <link rel="modulepreload" href="/cswiki/assets/src_base_cloud_07高级篇-微服务保护.md.vVZ1Sc_-.lean.js">
    <link rel="icon" href="/favicon.ico">
    <meta name="author" content="mousse">
    <meta name="keywords" content="慕斯的知识小册子">
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">
    <meta name="theme-color" content="#3c8772">
    <meta property="og:type" content="website">
    <meta property="og:locale" content="zh_CN">
    <meta property="og:title" content="知识小册子">
    <meta property="og:description" content="搭建个人的知识体系,一个好的知识体系和学习方法会让自己事半功倍">
    <meta property="og:site_name" content="知识小册子">
    <meta property="og:image" content="/logo.svg">
    <script id="check-dark-mode">(()=>{const e=localStorage.getItem("vitepress-theme-appearance")||"auto",a=window.matchMedia("(prefers-color-scheme: dark)").matches;(!e||e==="auto"?a:e==="dark")&&document.documentElement.classList.add("dark")})();</script>
    <script id="check-mac-os">document.documentElement.classList.toggle("mac",/Mac|iPhone|iPod|iPad/i.test(navigator.platform));</script>
  </head>
  <body>
    <div id="app"><div class="Layout" data-v-83d41759><!--[--><!--]--><!--[--><span tabindex="-1" data-v-40879362></span><a href="#VPContent" class="VPSkipLink visually-hidden" data-v-40879362> Skip to content </a><!--]--><!----><header class="VPNav" data-v-83d41759 data-v-0b69728b><div class="VPNavBar has-sidebar" data-v-0b69728b data-v-0ec8604f><div class="wrapper" data-v-0ec8604f><div class="container" data-v-0ec8604f><div class="title" data-v-0ec8604f><div class="VPNavBarTitle has-sidebar" data-v-0ec8604f data-v-e5f52478><a class="title" href="/cswiki/" data-v-e5f52478><!--[--><!--]--><!--[--><img class="VPImage logo" src="/cswiki/logo.svg" alt data-v-22195471><!--]--><!--[-->知识小册子<!--]--><!--[--><!--]--></a></div></div><div class="content" data-v-0ec8604f><div class="content-body" data-v-0ec8604f><!--[--><!--]--><div class="VPNavBarSearch search" data-v-0ec8604f><!--[--><!----><div id="local-search"><button type="button" class="DocSearch DocSearch-Button" aria-label="搜索文档"><span class="DocSearch-Button-Container"><svg class="DocSearch-Search-Icon" width="20" height="20" viewBox="0 0 20 20" aria-label="search icon"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">搜索文档</span></span><span class="DocSearch-Button-Keys"><kbd class="DocSearch-Button-Key"></kbd><kbd class="DocSearch-Button-Key">K</kbd></span></button></div><!--]--></div><nav aria-labelledby="main-nav-aria-label" class="VPNavBarMenu menu" data-v-0ec8604f data-v-6ba9474d><span id="main-nav-aria-label" class="visually-hidden" data-v-6ba9474d>Main Navigation</span><!--[--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/cswiki/" tabindex="0" data-v-6ba9474d data-v-5c7cab49><!--[--><span data-v-5c7cab49>📌 技术博客</span><!--]--></a><!--]--><!--[--><div class="VPFlyout VPNavBarMenuGroup" data-v-6ba9474d data-v-8e60bb69><button type="button" class="button" aria-haspopup="true" aria-expanded="false" data-v-8e60bb69><span class="text" data-v-8e60bb69><!----><span data-v-8e60bb69>📝 基础知识</span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="text-icon" data-v-8e60bb69><path d="M12,16c-0.3,0-0.5-0.1-0.7-0.3l-6-6c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l5.3,5.3l5.3-5.3c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-6,6C12.5,15.9,12.3,16,12,16z"></path></svg></span></button><div class="menu" data-v-8e60bb69><div class="VPMenu" data-v-8e60bb69 data-v-32b6ed9e><div class="items" data-v-32b6ed9e><!--[--><!--[--><div class="VPMenuGroup" data-v-32b6ed9e data-v-8b276347><!----><!--[--><!--[--><div class="VPMenuLink" data-v-8b276347 data-v-d8ac4ebe><a class="VPLink link" href="/cswiki/src/base/java/index" data-v-d8ac4ebe><!--[-->☕️ Java基础<!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-8b276347 data-v-d8ac4ebe><a class="VPLink link" href="/cswiki/src/base/jvm/index" data-v-d8ac4ebe><!--[-->🖥 JVM入门<!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-8b276347 data-v-d8ac4ebe><a class="VPLink link" href="/cswiki/src/base/juc/index" data-v-d8ac4ebe><!--[-->🔥 并发编程<!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-8b276347 data-v-d8ac4ebe><a class="VPLink link" href="/cswiki/src/base/netty/index" data-v-d8ac4ebe><!--[-->🌐 网络编程<!--]--></a></div><!--]--><!--]--></div><!--]--><!--[--><div class="VPMenuGroup" data-v-32b6ed9e data-v-8b276347><!----><!--[--><!--[--><div class="VPMenuLink" data-v-8b276347 data-v-d8ac4ebe><a class="VPLink link" href="/cswiki/src/base/alg/index" data-v-d8ac4ebe><!--[-->🧩 数据结构<!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-8b276347 data-v-d8ac4ebe><a class="VPLink link" href="/cswiki/src/base/gof/index" data-v-d8ac4ebe><!--[-->📝 设计模式<!--]--></a></div><!--]--><!--]--></div><!--]--><!--[--><div class="VPMenuGroup" data-v-32b6ed9e data-v-8b276347><!----><!--[--><!--[--><div class="VPMenuLink" data-v-8b276347 data-v-d8ac4ebe><a class="VPLink link" href="/cswiki/src/base/mysql/index" data-v-d8ac4ebe><!--[-->📊 数据库<!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-8b276347 data-v-d8ac4ebe><a class="VPLink link" href="/cswiki/src/base/linux/index" data-v-d8ac4ebe><!--[-->👨‍💻 服务器<!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-8b276347 data-v-d8ac4ebe><a class="VPLink link" href="/cswiki/src/base/spring/index" data-v-d8ac4ebe><!--[-->🌱 Spring<!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-8b276347 data-v-d8ac4ebe><a class="VPLink link" href="/cswiki/src/base/cloud/index" data-v-d8ac4ebe><!--[-->☁️ 微服务<!--]--></a></div><!--]--><!--]--></div><!--]--><!--]--></div><!--[--><!--]--></div></div></div><!--]--><!--[--><div class="VPFlyout VPNavBarMenuGroup" data-v-6ba9474d data-v-8e60bb69><button type="button" class="button" aria-haspopup="true" aria-expanded="false" data-v-8e60bb69><span class="text" data-v-8e60bb69><!----><span data-v-8e60bb69>🛠️ 项目实战</span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="text-icon" data-v-8e60bb69><path d="M12,16c-0.3,0-0.5-0.1-0.7-0.3l-6-6c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l5.3,5.3l5.3-5.3c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-6,6C12.5,15.9,12.3,16,12,16z"></path></svg></span></button><div class="menu" data-v-8e60bb69><div class="VPMenu" data-v-8e60bb69 data-v-32b6ed9e><div class="items" data-v-32b6ed9e><!--[--><!--[--><div class="VPMenuGroup" data-v-32b6ed9e data-v-8b276347><!----><!--[--><!--[--><div class="VPMenuLink" data-v-8b276347 data-v-d8ac4ebe><a class="VPLink link" href="/cswiki/src/project/redis/index" data-v-d8ac4ebe><!--[-->🔖️ 黑马点评<!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-8b276347 data-v-d8ac4ebe><a class="VPLink link" href="/cswiki/src/project/topnews/index" data-v-d8ac4ebe><!--[-->📰 黑马头条<!--]--></a></div><!--]--><!--]--></div><!--]--><!--[--><div class="VPMenuGroup" data-v-32b6ed9e data-v-8b276347><!----><!--[--><!--[--><div class="VPMenuLink" data-v-8b276347 data-v-d8ac4ebe><a class="VPLink link" href="/cswiki/src/project/college/index" data-v-d8ac4ebe><!--[-->📚 天机学堂<!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-8b276347 data-v-d8ac4ebe><a class="VPLink link" href="/cswiki/src/project/express/index" data-v-d8ac4ebe><!--[-->🚚 神领物流<!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-8b276347 data-v-d8ac4ebe><a class="VPLink link" href="/cswiki/src/project/shop/index" data-v-d8ac4ebe><!--[-->🛒 谷粒商城<!--]--></a></div><!--]--><!--]--></div><!--]--><!--[--><div class="VPMenuGroup" data-v-32b6ed9e data-v-8b276347><!----><!--[--><!--[--><div class="VPMenuLink" data-v-8b276347 data-v-d8ac4ebe><a class="VPLink link" href="/cswiki/src/project/takeout/index" data-v-d8ac4ebe><!--[-->🍜 谷粒外卖<!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-8b276347 data-v-d8ac4ebe><a class="VPLink link" href="/cswiki/src/project/health/index" data-v-d8ac4ebe><!--[-->🏄 谷粒健康<!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-8b276347 data-v-d8ac4ebe><a class="VPLink link" href="/cswiki/src/project/social/index" data-v-d8ac4ebe><!--[-->🧑‍🤝‍🧑 谷粒交友<!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-8b276347 data-v-d8ac4ebe><a class="VPLink link" href="/cswiki/src/project/rent/index" data-v-d8ac4ebe><!--[-->🏠 谷粒租房<!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-8b276347 data-v-d8ac4ebe><a class="VPLink link" href="/cswiki/src/project/financial/index" data-v-d8ac4ebe><!--[-->📈 谷粒金融<!--]--></a></div><!--]--><!--]--></div><!--]--><!--]--></div><!--[--><!--]--></div></div></div><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/cswiki/src/base/summarize/index" tabindex="0" data-v-6ba9474d data-v-5c7cab49><!--[--><span data-v-5c7cab49>💼 面试宝典</span><!--]--></a><!--]--><!--]--></nav><!----><div class="VPNavBarAppearance appearance" data-v-0ec8604f data-v-f8a5715e><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title="Switch to dark theme" aria-checked="false" data-v-f8a5715e data-v-a55d2cd3 data-v-43317611><span class="check" data-v-43317611><span class="icon" data-v-43317611><!--[--><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="sun" data-v-a55d2cd3><path d="M12,18c-3.3,0-6-2.7-6-6s2.7-6,6-6s6,2.7,6,6S15.3,18,12,18zM12,8c-2.2,0-4,1.8-4,4c0,2.2,1.8,4,4,4c2.2,0,4-1.8,4-4C16,9.8,14.2,8,12,8z"></path><path d="M12,4c-0.6,0-1-0.4-1-1V1c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,3.6,12.6,4,12,4z"></path><path d="M12,24c-0.6,0-1-0.4-1-1v-2c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,23.6,12.6,24,12,24z"></path><path d="M5.6,6.6c-0.3,0-0.5-0.1-0.7-0.3L3.5,4.9c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C6.2,6.5,5.9,6.6,5.6,6.6z"></path><path d="M19.8,20.8c-0.3,0-0.5-0.1-0.7-0.3l-1.4-1.4c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C20.3,20.7,20,20.8,19.8,20.8z"></path><path d="M3,13H1c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S3.6,13,3,13z"></path><path d="M23,13h-2c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S23.6,13,23,13z"></path><path d="M4.2,20.8c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C4.7,20.7,4.5,20.8,4.2,20.8z"></path><path d="M18.4,6.6c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C18.9,6.5,18.6,6.6,18.4,6.6z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="moon" data-v-a55d2cd3><path d="M12.1,22c-0.3,0-0.6,0-0.9,0c-5.5-0.5-9.5-5.4-9-10.9c0.4-4.8,4.2-8.6,9-9c0.4,0,0.8,0.2,1,0.5c0.2,0.3,0.2,0.8-0.1,1.1c-2,2.7-1.4,6.4,1.3,8.4c2.1,1.6,5,1.6,7.1,0c0.3-0.2,0.7-0.3,1.1-0.1c0.3,0.2,0.5,0.6,0.5,1c-0.2,2.7-1.5,5.1-3.6,6.8C16.6,21.2,14.4,22,12.1,22zM9.3,4.4c-2.9,1-5,3.6-5.2,6.8c-0.4,4.4,2.8,8.3,7.2,8.7c2.1,0.2,4.2-0.4,5.8-1.8c1.1-0.9,1.9-2.1,2.4-3.4c-2.5,0.9-5.3,0.5-7.5-1.1C9.2,11.4,8.1,7.7,9.3,4.4z"></path></svg><!--]--></span></span></button></div><div class="VPSocialLinks VPNavBarSocialLinks social-links" data-v-0ec8604f data-v-9b69f4c1 data-v-0ed08415><!--[--><a class="VPSocialLink no-icon" href="https://github.com/Charles7c/charles7c.github.io" aria-label="github" target="_blank" rel="noopener" data-v-0ed08415 data-v-c77ec717><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>GitHub</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a><a class="VPSocialLink no-icon" href="https://gitee.com/Charles7c/charles7c" aria-label target="_blank" rel="noopener" data-v-0ed08415 data-v-c77ec717><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>码云</title><path d="M11.984 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.016 0zm6.09 5.333c.328 0 .593.266.592.593v1.482a.594.594 0 0 1-.593.592H9.777c-.982 0-1.778.796-1.778 1.778v5.63c0 .327.266.592.593.592h5.63c.982 0 1.778-.796 1.778-1.778v-.296a.593.593 0 0 0-.592-.593h-4.15a.592.592 0 0 1-.592-.592v-1.482a.593.593 0 0 1 .593-.592h6.815c.327 0 .593.265.593.592v3.408a4 4 0 0 1-4 4H5.926a.593.593 0 0 1-.593-.593V9.778a4.444 4.444 0 0 1 4.445-4.444h8.296Z"/></svg></a><!--]--></div><div class="VPFlyout VPNavBarExtra extra" data-v-0ec8604f data-v-b9614353 data-v-8e60bb69><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-8e60bb69><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="icon" data-v-8e60bb69><circle cx="12" cy="12" r="2"></circle><circle cx="19" cy="12" r="2"></circle><circle cx="5" cy="12" r="2"></circle></svg></button><div class="menu" data-v-8e60bb69><div class="VPMenu" data-v-8e60bb69 data-v-32b6ed9e><!----><!--[--><!--[--><!----><div class="group" data-v-b9614353><div class="item appearance" data-v-b9614353><p class="label" data-v-b9614353>切换日光/暗黑模式</p><div class="appearance-action" data-v-b9614353><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title="Switch to dark theme" aria-checked="false" data-v-b9614353 data-v-a55d2cd3 data-v-43317611><span class="check" data-v-43317611><span class="icon" data-v-43317611><!--[--><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="sun" data-v-a55d2cd3><path d="M12,18c-3.3,0-6-2.7-6-6s2.7-6,6-6s6,2.7,6,6S15.3,18,12,18zM12,8c-2.2,0-4,1.8-4,4c0,2.2,1.8,4,4,4c2.2,0,4-1.8,4-4C16,9.8,14.2,8,12,8z"></path><path d="M12,4c-0.6,0-1-0.4-1-1V1c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,3.6,12.6,4,12,4z"></path><path d="M12,24c-0.6,0-1-0.4-1-1v-2c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,23.6,12.6,24,12,24z"></path><path d="M5.6,6.6c-0.3,0-0.5-0.1-0.7-0.3L3.5,4.9c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C6.2,6.5,5.9,6.6,5.6,6.6z"></path><path d="M19.8,20.8c-0.3,0-0.5-0.1-0.7-0.3l-1.4-1.4c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C20.3,20.7,20,20.8,19.8,20.8z"></path><path d="M3,13H1c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S3.6,13,3,13z"></path><path d="M23,13h-2c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S23.6,13,23,13z"></path><path d="M4.2,20.8c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C4.7,20.7,4.5,20.8,4.2,20.8z"></path><path d="M18.4,6.6c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C18.9,6.5,18.6,6.6,18.4,6.6z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="moon" data-v-a55d2cd3><path d="M12.1,22c-0.3,0-0.6,0-0.9,0c-5.5-0.5-9.5-5.4-9-10.9c0.4-4.8,4.2-8.6,9-9c0.4,0,0.8,0.2,1,0.5c0.2,0.3,0.2,0.8-0.1,1.1c-2,2.7-1.4,6.4,1.3,8.4c2.1,1.6,5,1.6,7.1,0c0.3-0.2,0.7-0.3,1.1-0.1c0.3,0.2,0.5,0.6,0.5,1c-0.2,2.7-1.5,5.1-3.6,6.8C16.6,21.2,14.4,22,12.1,22zM9.3,4.4c-2.9,1-5,3.6-5.2,6.8c-0.4,4.4,2.8,8.3,7.2,8.7c2.1,0.2,4.2-0.4,5.8-1.8c1.1-0.9,1.9-2.1,2.4-3.4c-2.5,0.9-5.3,0.5-7.5-1.1C9.2,11.4,8.1,7.7,9.3,4.4z"></path></svg><!--]--></span></span></button></div></div></div><div class="group" data-v-b9614353><div class="item social-links" data-v-b9614353><div class="VPSocialLinks social-links-list" data-v-b9614353 data-v-0ed08415><!--[--><a class="VPSocialLink no-icon" href="https://github.com/Charles7c/charles7c.github.io" aria-label="github" target="_blank" rel="noopener" data-v-0ed08415 data-v-c77ec717><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>GitHub</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a><a class="VPSocialLink no-icon" href="https://gitee.com/Charles7c/charles7c" aria-label target="_blank" rel="noopener" data-v-0ed08415 data-v-c77ec717><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>码云</title><path d="M11.984 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.016 0zm6.09 5.333c.328 0 .593.266.592.593v1.482a.594.594 0 0 1-.593.592H9.777c-.982 0-1.778.796-1.778 1.778v5.63c0 .327.266.592.593.592h5.63c.982 0 1.778-.796 1.778-1.778v-.296a.593.593 0 0 0-.592-.593h-4.15a.592.592 0 0 1-.592-.592v-1.482a.593.593 0 0 1 .593-.592h6.815c.327 0 .593.265.593.592v3.408a4 4 0 0 1-4 4H5.926a.593.593 0 0 1-.593-.593V9.778a4.444 4.444 0 0 1 4.445-4.444h8.296Z"/></svg></a><!--]--></div></div></div><!--]--><!--]--></div></div></div><!--[--><!--]--><button type="button" class="VPNavBarHamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="VPNavScreen" data-v-0ec8604f data-v-a6fa7f77><span class="container" data-v-a6fa7f77><span class="top" data-v-a6fa7f77></span><span class="middle" data-v-a6fa7f77></span><span class="bottom" data-v-a6fa7f77></span></span></button></div></div></div></div><div class="divider" data-v-0ec8604f><div class="divider-line" data-v-0ec8604f></div></div></div><!----></header><div class="VPLocalNav has-sidebar empty" data-v-83d41759 data-v-f4225638><div class="container" data-v-f4225638><button class="menu" aria-expanded="false" aria-controls="VPSidebarNav" data-v-f4225638><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="menu-icon" data-v-f4225638><path d="M17,11H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h14c0.6,0,1,0.4,1,1S17.6,11,17,11z"></path><path d="M21,7H3C2.4,7,2,6.6,2,6s0.4-1,1-1h18c0.6,0,1,0.4,1,1S21.6,7,21,7z"></path><path d="M21,15H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h18c0.6,0,1,0.4,1,1S21.6,15,21,15z"></path><path d="M17,19H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h14c0.6,0,1,0.4,1,1S17.6,19,17,19z"></path></svg><span class="menu-text" data-v-f4225638>文章</span></button><div class="VPLocalNavOutlineDropdown" style="--vp-vh:0px;" data-v-f4225638 data-v-560fa4a6><button data-v-560fa4a6>返回顶部</button><!----></div></div></div><aside class="VPSidebar" data-v-83d41759 data-v-93fad516><div class="curtain" data-v-93fad516></div><nav class="nav" id="VPSidebarNav" aria-labelledby="sidebar-aria-label" tabindex="-1" data-v-93fad516><span class="visually-hidden" id="sidebar-aria-label" data-v-93fad516> Sidebar Navigation </span><!--[--><!--]--><!--[--><div class="group" data-v-93fad516><section class="VPSidebarItem level-0 collapsible" data-v-93fad516 data-v-d1e013f8><div class="item" role="button" tabindex="0" data-v-d1e013f8><div class="indicator" data-v-d1e013f8></div><h2 class="text" data-v-d1e013f8>Cloud 实用篇</h2><div class="caret" role="button" aria-label="toggle section" tabindex="0" data-v-d1e013f8><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="caret-icon" data-v-d1e013f8><path d="M9,19c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l5.3-5.3L8.3,6.7c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l6,6c0.4,0.4,0.4,1,0,1.4l-6,6C9.5,18.9,9.3,19,9,19z"></path></svg></div></div><div class="items" data-v-d1e013f8><!--[--><div class="VPSidebarItem level-1 is-link" data-v-d1e013f8 data-v-d1e013f8><div class="item" data-v-d1e013f8><div class="indicator" data-v-d1e013f8></div><a class="VPLink link link" href="/cswiki/src/base/cloud/01%E5%AE%9E%E7%94%A8%E7%AF%87-%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%B2%BB%E7%90%86" data-v-d1e013f8><!--[--><p class="text" data-v-d1e013f8>微服务治理</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-d1e013f8 data-v-d1e013f8><div class="item" data-v-d1e013f8><div class="indicator" data-v-d1e013f8></div><a class="VPLink link link" href="/cswiki/src/base/cloud/02%E5%AE%9E%E7%94%A8%E7%AF%87-%E5%AE%B9%E5%99%A8%E7%AE%A1%E7%90%86" data-v-d1e013f8><!--[--><p class="text" data-v-d1e013f8>容器管理</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-d1e013f8 data-v-d1e013f8><div class="item" data-v-d1e013f8><div class="indicator" data-v-d1e013f8></div><a class="VPLink link link" href="/cswiki/src/base/cloud/03%E5%AE%9E%E7%94%A8%E7%AF%87-%E5%BC%82%E6%AD%A5%E9%80%9A%E4%BF%A1" data-v-d1e013f8><!--[--><p class="text" data-v-d1e013f8>异步通信</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-d1e013f8 data-v-d1e013f8><div class="item" data-v-d1e013f8><div class="indicator" data-v-d1e013f8></div><a class="VPLink link link" href="/cswiki/src/base/cloud/04%E5%AE%9E%E7%94%A8%E7%AF%87-%E6%96%87%E6%A1%A3%E6%95%B0%E6%8D%AE%E5%BA%93" data-v-d1e013f8><!--[--><p class="text" data-v-d1e013f8>文档数据库</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-d1e013f8 data-v-d1e013f8><div class="item" data-v-d1e013f8><div class="indicator" data-v-d1e013f8></div><a class="VPLink link link" href="/cswiki/src/base/cloud/06%E5%AE%9E%E7%94%A8%E7%AF%87-%E5%88%86%E5%B8%83%E5%BC%8F%E7%BC%93%E5%AD%98" data-v-d1e013f8><!--[--><p class="text" data-v-d1e013f8>分布式缓存</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><div class="group" data-v-93fad516><section class="VPSidebarItem level-0 collapsible has-active" data-v-93fad516 data-v-d1e013f8><div class="item" role="button" tabindex="0" data-v-d1e013f8><div class="indicator" data-v-d1e013f8></div><h2 class="text" data-v-d1e013f8>Cloud 高级篇</h2><div class="caret" role="button" aria-label="toggle section" tabindex="0" data-v-d1e013f8><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="caret-icon" data-v-d1e013f8><path d="M9,19c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l5.3-5.3L8.3,6.7c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l6,6c0.4,0.4,0.4,1,0,1.4l-6,6C9.5,18.9,9.3,19,9,19z"></path></svg></div></div><div class="items" data-v-d1e013f8><!--[--><div class="VPSidebarItem level-1 is-link" data-v-d1e013f8 data-v-d1e013f8><div class="item" data-v-d1e013f8><div class="indicator" data-v-d1e013f8></div><a class="VPLink link link" href="/cswiki/src/base/cloud/05%E5%AE%9E%E7%94%A8%E7%AF%87-%E5%88%86%E5%B8%83%E5%BC%8F%E6%90%9C%E7%B4%A2" data-v-d1e013f8><!--[--><p class="text" data-v-d1e013f8>分布式搜索</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-d1e013f8 data-v-d1e013f8><div class="item" data-v-d1e013f8><div class="indicator" data-v-d1e013f8></div><a class="VPLink link link" href="/cswiki/src/base/cloud/08%E9%AB%98%E7%BA%A7%E7%AF%87-%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1" data-v-d1e013f8><!--[--><p class="text" data-v-d1e013f8>分布式事务</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-d1e013f8 data-v-d1e013f8><div class="item" data-v-d1e013f8><div class="indicator" data-v-d1e013f8></div><a class="VPLink link link" href="/cswiki/src/base/cloud/07%E9%AB%98%E7%BA%A7%E7%AF%87-%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%BF%9D%E6%8A%A4" data-v-d1e013f8><!--[--><p class="text" data-v-d1e013f8>微服务保护</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-d1e013f8 data-v-d1e013f8><div class="item" data-v-d1e013f8><div class="indicator" data-v-d1e013f8></div><a class="VPLink link link" href="/cswiki/src/base/cloud/09%E9%AB%98%E7%BA%A7%E7%AF%87-%E5%8F%AF%E9%9D%A0%E6%B6%88%E6%81%AF%E6%9C%8D%E5%8A%A1" data-v-d1e013f8><!--[--><p class="text" data-v-d1e013f8>可靠消息服务</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-d1e013f8 data-v-d1e013f8><div class="item" data-v-d1e013f8><div class="indicator" data-v-d1e013f8></div><a class="VPLink link link" href="/cswiki/src/base/cloud/10%E9%AB%98%E7%BA%A7%E7%AF%87-%E5%A4%9A%E7%BA%A7%E7%BC%93%E5%AD%98%E6%8A%80%E6%9C%AF" data-v-d1e013f8><!--[--><p class="text" data-v-d1e013f8>多级缓存技术</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-d1e013f8 data-v-d1e013f8><div class="item" data-v-d1e013f8><div class="indicator" data-v-d1e013f8></div><a class="VPLink link link" href="/cswiki/src/base/cloud/11%E9%9D%A2%E8%AF%95%E7%AF%87-%E5%BE%AE%E6%9C%8D%E5%8A%A1%E9%9D%A2%E8%AF%95%E9%A2%98" data-v-d1e013f8><!--[--><p class="text" data-v-d1e013f8>微服务面试题</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><div class="group" data-v-93fad516><section class="VPSidebarItem level-0 collapsible" data-v-93fad516 data-v-d1e013f8><div class="item" role="button" tabindex="0" data-v-d1e013f8><div class="indicator" data-v-d1e013f8></div><h2 class="text" data-v-d1e013f8>Cloud 操作篇</h2><div class="caret" role="button" aria-label="toggle section" tabindex="0" data-v-d1e013f8><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="caret-icon" data-v-d1e013f8><path d="M9,19c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l5.3-5.3L8.3,6.7c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l6,6c0.4,0.4,0.4,1,0,1.4l-6,6C9.5,18.9,9.3,19,9,19z"></path></svg></div></div><div class="items" data-v-d1e013f8><!--[--><div class="VPSidebarItem level-1 is-link" data-v-d1e013f8 data-v-d1e013f8><div class="item" data-v-d1e013f8><div class="indicator" data-v-d1e013f8></div><a class="VPLink link link" href="/cswiki/src/base/cloud%C2%A1/00%E6%93%8D%E4%BD%9C%E7%AF%87-%E5%AE%89%E8%A3%85Nacos" data-v-d1e013f8><!--[--><p class="text" data-v-d1e013f8>安装Nacos</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-d1e013f8 data-v-d1e013f8><div class="item" data-v-d1e013f8><div class="indicator" data-v-d1e013f8></div><a class="VPLink link link" href="/cswiki/src/base/cloud%C2%A1/00%E6%93%8D%E4%BD%9C%E7%AF%87-%E5%AE%89%E8%A3%85Seata" data-v-d1e013f8><!--[--><p class="text" data-v-d1e013f8>安装Seata</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-d1e013f8 data-v-d1e013f8><div class="item" data-v-d1e013f8><div class="indicator" data-v-d1e013f8></div><a class="VPLink link link" href="/cswiki/src/base/cloud%C2%A1/00%E6%93%8D%E4%BD%9C%E7%AF%87-%E5%AE%89%E8%A3%85Docker" data-v-d1e013f8><!--[--><p class="text" data-v-d1e013f8>安装Docker</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-d1e013f8 data-v-d1e013f8><div class="item" data-v-d1e013f8><div class="indicator" data-v-d1e013f8></div><a class="VPLink link link" href="/cswiki/src/base/cloud%C2%A1/00%E6%93%8D%E4%BD%9C%E7%AF%87-%E5%AE%89%E8%A3%85Redis" data-v-d1e013f8><!--[--><p class="text" data-v-d1e013f8>安装Redis</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-d1e013f8 data-v-d1e013f8><div class="item" data-v-d1e013f8><div class="indicator" data-v-d1e013f8></div><a class="VPLink link link" href="/cswiki/src/base/cloud%C2%A1/00%E6%93%8D%E4%BD%9C%E7%AF%87-%E5%AE%89%E8%A3%85MQ" data-v-d1e013f8><!--[--><p class="text" data-v-d1e013f8>安装MQ</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-d1e013f8 data-v-d1e013f8><div class="item" data-v-d1e013f8><div class="indicator" data-v-d1e013f8></div><a class="VPLink link link" href="/cswiki/src/base/cloud%C2%A1/00%E6%93%8D%E4%BD%9C%E7%AF%87-%E5%AE%89%E8%A3%85ELK" data-v-d1e013f8><!--[--><p class="text" data-v-d1e013f8>安装ELK</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-d1e013f8 data-v-d1e013f8><div class="item" data-v-d1e013f8><div class="indicator" data-v-d1e013f8></div><a class="VPLink link link" href="/cswiki/src/base/cloud%C2%A1/00%E6%93%8D%E4%BD%9C%E7%AF%87-%E5%A4%9A%E7%BA%A7%E7%BC%93%E5%AD%98%E6%A1%88%E4%BE%8B" data-v-d1e013f8><!--[--><p class="text" data-v-d1e013f8>多级缓存案例</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><!--]--><!--[--><!--]--></nav></aside><div class="VPContent has-sidebar" id="VPContent" data-v-83d41759 data-v-7f2b530e><div class="VPDoc has-sidebar has-aside" data-v-7f2b530e data-v-7b451c74><!--[--><!--]--><div class="container" data-v-7b451c74><div class="aside" data-v-7b451c74><div class="aside-curtain" data-v-7b451c74></div><div class="aside-container" data-v-7b451c74><div class="aside-content" data-v-7b451c74><div class="VPDocAside" data-v-7b451c74 data-v-ae5a1c99><!--[--><!--]--><!--[--><!--]--><div class="VPDocAsideOutline" role="navigation" data-v-ae5a1c99 data-v-34b44e06><div class="content" data-v-34b44e06><div class="outline-marker" data-v-34b44e06></div><div class="outline-title" role="heading" aria-level="2" data-v-34b44e06>章节导航</div><nav aria-labelledby="doc-outline-aria-label" data-v-34b44e06><span class="visually-hidden" id="doc-outline-aria-label" data-v-34b44e06> Table of Contents for current page </span><ul class="VPDocOutlineItem root" data-v-34b44e06 data-v-ff6ff475><!--[--><!--]--></ul></nav></div></div><!--[--><!--]--><div class="spacer" data-v-ae5a1c99></div><!--[--><!--]--><!----><!--[--><!--]--><!--[--><!--]--></div></div></div></div><div class="content" data-v-7b451c74><div class="content-container" data-v-7b451c74><!--[--><!--]--><main class="main" data-v-7b451c74><div style="position:relative;" class="vp-doc _cswiki_src_base_cloud_07%E9%AB%98%E7%BA%A7%E7%AF%87-%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%BF%9D%E6%8A%A4" data-v-7b451c74><div><h1 id="微服务保护" tabindex="-1">微服务保护 <a class="header-anchor" href="#微服务保护" aria-label="Permalink to &quot;微服务保护&quot;">​</a></h1><!----><h2 id="初识sentinel" tabindex="-1">初识Sentinel <a class="header-anchor" href="#初识sentinel" aria-label="Permalink to &quot;初识Sentinel&quot;">​</a></h2><h3 id="雪崩问题及解决方案" tabindex="-1">雪崩问题及解决方案 <a class="header-anchor" href="#雪崩问题及解决方案" aria-label="Permalink to &quot;雪崩问题及解决方案&quot;">​</a></h3><h4 id="雪崩问题" tabindex="-1">雪崩问题 <a class="header-anchor" href="#雪崩问题" aria-label="Permalink to &quot;雪崩问题&quot;">​</a></h4><p>微服务中，服务间调用关系错综复杂，一个微服务往往依赖于多个其它微服务。</p><p><img src="/cswiki/assets/1533829099748.Ii3GuyF9.png" alt="1533829099748" loading="lazy"></p><p>如图，如果服务 提供者I 发生了故障，当前的应用的部分业务因为依赖于 服务I，因此也会被阻塞。此时，其它不依赖于 服务I 的业务似乎不受影响。</p><p><img src="/cswiki/assets/1533829198240.0vVybwQ9.png" alt="1533829198240" loading="lazy"></p><p>但是，依赖服务I的业务请求被阻塞，用户不会得到响应，则tomcat的这个线程不会释放，于是越来越多的用户请求到来，越来越多的线程会阻塞：</p><p><img src="/cswiki/assets/1533829307389.Mzj9D3C-.png" alt="1533829307389" loading="lazy"></p><p>服务器支持的线程和并发数有限，请求一直阻塞，会导致服务器资源耗尽，从而导致所有其它服务都不可用，那么当前服务也就不可用了。</p><p>那么，依赖于当前服务的其它服务随着时间的推移，最终也都会变的不可用，形成级联失败，雪崩就发生了：</p><p><img src="/cswiki/assets/image-20210715172710340.e_J4rzzB.png" alt="image-20210715172710340" loading="lazy"></p><h4 id="超时处理" tabindex="-1">超时处理 <a class="header-anchor" href="#超时处理" aria-label="Permalink to &quot;超时处理&quot;">​</a></h4><p>解决雪崩问题的常见方式有四种：</p><p>超时处理：设定超时时间，请求超过一定时间没有响应就返回错误信息，不会无休止等待</p><p><img src="/cswiki/assets/image-20210715172820438.y2e_A7ki.png" alt="image-20210715172820438" loading="lazy"></p><h4 id="仓壁模式" tabindex="-1">仓壁模式 <a class="header-anchor" href="#仓壁模式" aria-label="Permalink to &quot;仓壁模式&quot;">​</a></h4><p>方案2：仓壁模式</p><p>仓壁模式来源于船舱的设计：</p><p><img src="/cswiki/assets/image-20210715172946352.89vxB_9L.png" alt="image-20210715172946352" loading="lazy"></p><p>船舱都会被隔板分离为多个独立空间，当船体破损时，只会导致部分空间进入，将故障控制在一定范围内，避免整个船体都被淹没。</p><p>于此类似，我们可以限定每个业务能使用的线程数，避免耗尽整个tomcat的资源，因此也叫线程隔离。</p><p><img src="/cswiki/assets/image-20210715173215243.mKdbDjVz.png" alt="image-20210715173215243" loading="lazy"></p><h4 id="断路器" tabindex="-1">断路器 <a class="header-anchor" href="#断路器" aria-label="Permalink to &quot;断路器&quot;">​</a></h4><p>断路器模式：由<strong>断路器</strong>统计业务执行的异常比例，如果超出阈值则会<strong>熔断</strong>该业务，拦截访问该业务的一切请求。</p><p>断路器会统计访问某个服务的请求数量，异常比例：</p><p><img src="/cswiki/assets/image-20210715173327075.ussnrA8A.png" alt="image-20210715173327075" loading="lazy"></p><p>当发现访问服务D的请求异常比例过高时，认为服务D有导致雪崩的风险，会拦截访问服务D的一切请求，形成熔断：</p><p><img src="/cswiki/assets/image-20210715173428073.Fa4wNeZ7.png" alt="image-20210715173428073" loading="lazy"></p><h4 id="限流" tabindex="-1">限流 <a class="header-anchor" href="#限流" aria-label="Permalink to &quot;限流&quot;">​</a></h4><p><strong>流量控制</strong>：限制业务访问的QPS，避免服务因流量的突增而故障。</p><p><img src="/cswiki/assets/image-20210715173555158.BU-yCOYu.png" alt="image-20210715173555158" loading="lazy"></p><h4 id="总结" tabindex="-1">总结 <a class="header-anchor" href="#总结" aria-label="Permalink to &quot;总结&quot;">​</a></h4><p>什么是雪崩问题？</p><ul><li>微服务之间相互调用，因为调用链中的一个服务故障，引起整个链路都无法访问的情况。</li></ul><p>解决雪崩问题的常见方式有四种</p><ul><li>超时处理：设定超时时间，请求超过一定时间没有</li></ul><p>可以认为：</p><p><strong>限流</strong>是对服务的保护，避免因瞬间高并发流量而导致服务故障，进而避免雪崩。是一种<strong>预防</strong>措施。</p><p><strong>超时处理、线程隔离、降级熔断</strong>是在部分服务故障时，将故障控制在一定范围，避免雪崩。是一种<strong>补救</strong>措施。</p><h3 id="服务保护技术对比" tabindex="-1">服务保护技术对比 <a class="header-anchor" href="#服务保护技术对比" aria-label="Permalink to &quot;服务保护技术对比&quot;">​</a></h3><p>在SpringCloud当中支持多种服务保护技术：</p><ul><li><a href="https://github.com/Netflix/Hystrix" target="_blank" rel="noreferrer">Netfix Hystrix</a></li><li><a href="https://github.com/alibaba/Sentinel" target="_blank" rel="noreferrer">Sentinel</a></li><li><a href="https://github.com/resilience4j/resilience4j" target="_blank" rel="noreferrer">Resilience4J</a></li></ul><p>早期比较流行的是Hystrix框架，但目前国内实用最广泛的还是阿里巴巴的Sentinel框架，这里我们做下对比：</p><table><thead><tr><th></th><th><strong>Sentinel</strong></th><th><strong>Hystrix</strong></th></tr></thead><tbody><tr><td>隔离策略</td><td>信号量隔离</td><td>线程池隔离/信号量隔离</td></tr><tr><td>熔断降级策略</td><td>基于慢调用比例或异常比例</td><td>基于失败比率</td></tr><tr><td>实时指标实现</td><td>滑动窗口</td><td>滑动窗口（基于 RxJava）</td></tr><tr><td>规则配置</td><td>支持多种数据源</td><td>支持多种数据源</td></tr><tr><td>扩展性</td><td>多个扩展点</td><td>插件的形式</td></tr><tr><td>基于注解的支持</td><td>支持</td><td>支持</td></tr><tr><td>限流</td><td>基于 QPS，支持基于调用关系的限流</td><td>有限的支持</td></tr><tr><td>流量整形</td><td>支持慢启动、匀速排队模式</td><td>不支持</td></tr><tr><td>系统自适应保护</td><td>支持</td><td>不支持</td></tr><tr><td>控制台</td><td>开箱即用，可配置规则、查看秒级监控、机器发现等</td><td>不完善</td></tr><tr><td>常见框架的适配</td><td>Servlet、Spring Cloud、Dubbo、gRPC 等</td><td>Servlet、Spring Cloud Netflix</td></tr></tbody></table><h3 id="sentinel介绍和安装" tabindex="-1">Sentinel介绍和安装 <a class="header-anchor" href="#sentinel介绍和安装" aria-label="Permalink to &quot;Sentinel介绍和安装&quot;">​</a></h3><h4 id="初识sentinel-1" tabindex="-1">.初识Sentinel <a class="header-anchor" href="#初识sentinel-1" aria-label="Permalink to &quot;.初识Sentinel&quot;">​</a></h4><p>Sentinel是阿里巴巴开源的一款微服务流量控制组件。官网地址：<a href="https://sentinelguard.io/zh-cn/index.html" target="_blank" rel="noreferrer">https://sentinelguard.io/zh-cn/index.html</a></p><p>Sentinel 具有以下特征:</p><p>•<strong>丰富的应用场景</strong>：Sentinel 承接了阿里巴巴近 10 年的双十一大促流量的核心场景，例如秒杀（即突发流量控制在系统容量可以承受的范围）、消息削峰填谷、集群流量控制、实时熔断下游不可用应用等。</p><p>•<strong>完备的实时监控</strong>：Sentinel 同时提供实时的监控功能。您可以在控制台中看到接入应用的单台机器秒级数据，甚至 500 台以下规模的集群的汇总运行情况。</p><p>•<strong>广泛的开源生态</strong>：Sentinel 提供开箱即用的与其它开源框架/库的整合模块，例如与 Spring Cloud、Dubbo、gRPC 的整合。您只需要引入相应的依赖并进行简单的配置即可快速地接入 Sentinel。</p><p>•<strong>完善的</strong> <strong>SPI</strong> <strong>扩展点</strong>：Sentinel 提供简单易用、完善的 SPI 扩展接口。您可以通过实现扩展接口来快速地定制逻辑。例如定制规则管理、适配动态数据源等。</p><h4 id="安装sentinel" tabindex="-1">.安装Sentinel <a class="header-anchor" href="#安装sentinel" aria-label="Permalink to &quot;.安装Sentinel&quot;">​</a></h4><p>1）下载</p><p>sentinel官方提供了UI控制台，方便我们对系统做限流设置。大家可以在<a href="https://github.com/alibaba/Sentinel/releases" target="_blank" rel="noreferrer">GitHub</a>下载。</p><p>课前资料也提供了下载好的jar包：</p><p><img src="/cswiki/assets/image-20210715174252531.ORquSYWa.png" alt="image-20210715174252531" loading="lazy"></p><p>2）运行</p><p>将jar包放到任意非中文目录，执行命令：</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">java</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -jar</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> sentinel-dashboard-1.8.1.jar</span></span></code></pre></div><p>如果要修改Sentinel的默认端口、账户、密码，可以通过下列配置：</p><table><thead><tr><th><strong>配置项</strong></th><th><strong>默认值</strong></th><th><strong>说明</strong></th></tr></thead><tbody><tr><td>server.port</td><td>8080</td><td>服务端口</td></tr><tr><td>sentinel.dashboard.auth.username</td><td>sentinel</td><td>默认用户名</td></tr><tr><td>sentinel.dashboard.auth.password</td><td>sentinel</td><td>默认密码</td></tr></tbody></table><p>例如，修改端口：</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">java</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -Dserver.port=8090</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -jar</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> sentinel-dashboard-1.8.1.jar</span></span></code></pre></div><p>3）访问</p><p>访问http://localhost:8080页面，就可以看到sentinel的控制台了：</p><p><img src="/cswiki/assets/image-20210715190827846.VvMsIzy0.png" alt="image-20210715190827846" loading="lazy"></p><p>需要输入账号和密码，默认都是：sentinel</p><p>登录后，发现一片空白，什么都没有：</p><p><img src="/cswiki/assets/image-20210715191134448.bPlE_6Bf.png" alt="image-20210715191134448" loading="lazy"></p><p>这是因为我们还没有与微服务整合。</p><h3 id="微服务整合sentinel" tabindex="-1">微服务整合Sentinel <a class="header-anchor" href="#微服务整合sentinel" aria-label="Permalink to &quot;微服务整合Sentinel&quot;">​</a></h3><p>我们在order-service中整合sentinel，并连接sentinel的控制台，步骤如下：</p><p>1）引入sentinel依赖</p><div class="language-xml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">xml</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">&lt;!--sentinel--&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">dependency</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">groupId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;com.alibaba.cloud&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">groupId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">artifactId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;spring-cloud-starter-alibaba-sentinel&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">artifactId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">dependency</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span></code></pre></div><p>2）配置控制台</p><p>修改application.yaml文件，添加下面内容：</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">server</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  port</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">8088</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">spring</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  cloud</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    sentinel</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      transport</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">        dashboard</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">localhost:8080</span></span></code></pre></div><p>3）访问order-service的任意端点</p><p>打开浏览器，访问<a href="http://localhost:8088/order/101%EF%BC%8C%E8%BF%99%E6%A0%B7%E6%89%8D%E8%83%BD%E8%A7%A6%E5%8F%91sentinel%E7%9A%84%E7%9B%91%E6%8E%A7%E3%80%82" target="_blank" rel="noreferrer">http://localhost:8088/order/101，这样才能触发sentinel的监控。</a></p><p>然后再访问sentinel的控制台，查看效果：</p><p><img src="/cswiki/assets/image-20210715191241799.QpAiWCKY.png" alt="image-20210715191241799" loading="lazy"></p><h2 id="流量控制" tabindex="-1">流量控制 <a class="header-anchor" href="#流量控制" aria-label="Permalink to &quot;流量控制&quot;">​</a></h2><p>雪崩问题虽然有四种方案，但是限流是避免服务因突发的流量而发生故障，是对微服务雪崩问题的预防。我们先学习这种模式。</p><h3 id="簇点链路" tabindex="-1">簇点链路 <a class="header-anchor" href="#簇点链路" aria-label="Permalink to &quot;簇点链路&quot;">​</a></h3><p>当请求进入微服务时，首先会访问DispatcherServlet，然后进入Controller、Service、Mapper，这样的一个调用链就叫做<strong>簇点链路</strong>。簇点链路中被监控的每一个接口就是一个<strong>资源</strong>。</p><p>默认情况下sentinel会监控SpringMVC的每一个端点（Endpoint，也就是controller中的方法），因此SpringMVC的每一个端点（Endpoint）就是调用链路中的一个资源。</p><p orderId="">例如，我们刚才访问的order-service中的OrderController中的端点：/order/</p><p><img src="/cswiki/assets/image-20210715191757319.-5BApyeO.png" alt="image-20210715191757319" loading="lazy"></p><p>流控、熔断等都是针对簇点链路中的资源来设置的，因此我们可以点击对应资源后面的按钮来设置规则：</p><ul><li>流控：流量控制</li><li>降级：降级熔断</li><li>热点：热点参数限流，是限流的一种</li><li>授权：请求的权限控制</li></ul><h3 id="快速入门" tabindex="-1">快速入门 <a class="header-anchor" href="#快速入门" aria-label="Permalink to &quot;快速入门&quot;">​</a></h3><h4 id="示例" tabindex="-1">.示例 <a class="header-anchor" href="#示例" aria-label="Permalink to &quot;.示例&quot;">​</a></h4><p>点击资源/order/{orderId}后面的流控按钮，就可以弹出表单。</p><p><img src="/cswiki/assets/image-20210715191757319.-5BApyeO.png" alt="image-20210715191757319" loading="lazy"></p><p>表单中可以填写限流规则，如下：</p><p><img src="/cswiki/assets/image-20210715192010657.weD26r07.png" alt="image-20210715192010657" loading="lazy"></p><p>其含义是限制 /order/{orderId}这个资源的单机QPS为1，即每秒只允许1次请求，超出的请求会被拦截并报错。</p><h4 id="练习" tabindex="-1">.练习： <a class="header-anchor" href="#练习" aria-label="Permalink to &quot;.练习：&quot;">​</a></h4><p>需求：给 /order/{orderId}这个资源设置流控规则，QPS不能超过 5，然后测试。</p><p>1）首先在sentinel控制台添加限流规则</p><p><img src="/cswiki/assets/image-20210715192455429.hn8v_RzJ.png" alt="image-20210715192455429" loading="lazy"></p><p>2）利用jmeter测试</p><p>如果没有用过jmeter，可以参考课前资料提供的文档《Jmeter快速入门.md》</p><p>课前资料提供了编写好的Jmeter测试样例：</p><p><img src="/cswiki/assets/image-20210715200431615.NkXl8JLM.png" alt="image-20210715200431615" loading="lazy"></p><p>打开jmeter，导入课前资料提供的测试样例：</p><p><img src="/cswiki/assets/image-20210715200537171.CvDz7rFQ.png" alt="image-20210715200537171" loading="lazy"></p><p>选择：</p><p><img src="/cswiki/assets/image-20210715200635414.zr-Fi_XT.png" alt="image-20210715200635414" loading="lazy"></p><p>20个用户，2秒内运行完，QPS是10，超过了5.</p><p>选中<code>流控入门，QPS&lt;5</code>右键运行：</p><p><img src="/cswiki/assets/image-20210715200804594.EdzWxfgZ.png" alt="image-20210715200804594" loading="lazy"></p><blockquote><p>注意，不要点击菜单中的执行按钮来运行。</p></blockquote><p>结果：</p><p><img src="/cswiki/assets/image-20210715200853671.YoytVKMv.png" alt="image-20210715200853671" loading="lazy"></p><p>可以看到，成功的请求每次只有5个</p><h3 id="流控模式" tabindex="-1">流控模式 <a class="header-anchor" href="#流控模式" aria-label="Permalink to &quot;流控模式&quot;">​</a></h3><p>在添加限流规则时，点击高级选项，可以选择三种<strong>流控模式</strong>：</p><ul><li>直接：统计当前资源的请求，触发阈值时对当前资源直接限流，也是默认的模式</li><li>关联：统计与当前资源相关的另一个资源，触发阈值时，对当前资源限流</li><li>链路：统计从指定链路访问到本资源的请求，触发阈值时，对指定链路限流</li></ul><p><img src="/cswiki/assets/image-20210715201827886.7HINIoji.png" alt="image-20210715201827886" loading="lazy"></p><p>快速入门测试的就是直接模式。</p><h4 id="关联模式" tabindex="-1">.关联模式 <a class="header-anchor" href="#关联模式" aria-label="Permalink to &quot;.关联模式&quot;">​</a></h4><p><strong>关联模式</strong>：统计与当前资源相关的另一个资源，触发阈值时，对当前资源限流</p><p><strong>配置规则</strong>：</p><p><img src="/cswiki/assets/image-20210715202540786.aWakLmfd.png" alt="image-20210715202540786" loading="lazy"></p><p><strong>语法说明</strong>：当/write资源访问量触发阈值时，就会对/read资源限流，避免影响/write资源。</p><p><strong>使用场景</strong>：比如用户支付时需要修改订单状态，同时用户要查询订单。查询和修改操作会争抢数据库锁，产生竞争。业务需求是优先支付和更新订单的业务，因此当修改订单业务触发阈值时，需要对查询订单业务限流。</p><p><strong>需求说明</strong>：</p><ul><li><p>在OrderController新建两个端点：/order/query和/order/update，无需实现业务</p></li><li><p>配置流控规则，当/order/ update资源被访问的QPS超过5时，对/order/query请求限流</p></li></ul><p>1）定义/order/query端点，模拟订单查询</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">GetMapping</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;/query&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> String </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">queryOrder</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;查询订单成功&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>2）定义/order/update端点，模拟订单更新</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">GetMapping</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;/update&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> String </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">updateOrder</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;更新订单成功&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>重启服务，查看sentinel控制台的簇点链路：</p><p><img src="/cswiki/assets/image-20210716101805951.RnMUUWjW.png" alt="image-20210716101805951" loading="lazy"></p><p>3）配置流控规则</p><p>对哪个端点限流，就点击哪个端点后面的按钮。我们是对订单查询/order/query限流，因此点击它后面的按钮：</p><p><img src="/cswiki/assets/image-20210716101934499.j6XahGP7.png" alt="image-20210716101934499" loading="lazy"></p><p>在表单中填写流控规则：</p><p><img src="/cswiki/assets/image-20210716102103814.i-KibMKQ.png" alt="image-20210716102103814" loading="lazy"></p><p>4）在Jmeter测试</p><p>选择《流控模式-关联》：</p><p><img src="/cswiki/assets/image-20210716102416266.4kjTBQ2i.png" alt="image-20210716102416266" loading="lazy"></p><p>可以看到1000个用户，100秒，因此QPS为10，超过了我们设定的阈值：5</p><p>查看http请求：</p><p><img src="/cswiki/assets/image-20210716102532554.8z0WFo58.png" alt="image-20210716102532554" loading="lazy"></p><p>请求的目标是/order/update，这样这个断点就会触发阈值。</p><p>但限流的目标是/order/query，我们在浏览器访问，可以发现：</p><p><img src="/cswiki/assets/image-20210716102636030.qKVaKQsX.png" alt="image-20210716102636030" loading="lazy"></p><p>确实被限流了。</p><p>5）总结</p><p><img src="/cswiki/assets/image-20210716103143002.hwoGeS2H.png" alt="image-20210716103143002" loading="lazy"></p><h4 id="链路模式" tabindex="-1">.链路模式 <a class="header-anchor" href="#链路模式" aria-label="Permalink to &quot;.链路模式&quot;">​</a></h4><p><strong>链路模式</strong>：只针对从指定链路访问到本资源的请求做统计，判断是否超过阈值。</p><p><strong>配置示例</strong>：</p><p>例如有两条请求链路：</p><ul><li><p>/test1 --&gt; /common</p></li><li><p>/test2 --&gt; /common</p></li></ul><p>如果只希望统计从/test2进入到/common的请求，则可以这样配置：</p><p><img src="/cswiki/assets/image-20210716103536346.w4PjH2Sv.png" alt="image-20210716103536346" loading="lazy"></p><p><strong>实战案例</strong></p><p>需求：有查询订单和创建订单业务，两者都需要查询商品。针对从查询订单进入到查询商品的请求统计，并设置限流。</p><p>步骤：</p><ol><li><p>在OrderService中添加一个queryGoods方法，不用实现业务</p></li><li><p>在OrderController中，改造/order/query端点，调用OrderService中的queryGoods方法</p></li><li><p>在OrderController中添加一个/order/save的端点，调用OrderService的queryGoods方法</p></li><li><p>给queryGoods设置限流规则，从/order/query进入queryGoods的方法限制QPS必须小于2</p></li></ol><p>实现：</p><h5 id="_1-添加查询商品方法" tabindex="-1">1）添加查询商品方法 <a class="header-anchor" href="#_1-添加查询商品方法" aria-label="Permalink to &quot;1）添加查询商品方法&quot;">​</a></h5><p>在order-service服务中，给OrderService类添加一个queryGoods方法：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> queryGoods</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(){</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    System.err.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">println</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;查询商品&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h5 id="_2-查询订单时-查询商品" tabindex="-1">2）查询订单时，查询商品 <a class="header-anchor" href="#_2-查询订单时-查询商品" aria-label="Permalink to &quot;2）查询订单时，查询商品&quot;">​</a></h5><p>在order-service的OrderController中，修改/order/query端点的业务逻辑：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">GetMapping</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;/query&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> String </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">queryOrder</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 查询商品</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    orderService.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">queryGoods</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 查询订单</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    System.out.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">println</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;查询订单&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;查询订单成功&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h5 id="_3-新增订单-查询商品" tabindex="-1">3）新增订单，查询商品 <a class="header-anchor" href="#_3-新增订单-查询商品" aria-label="Permalink to &quot;3）新增订单，查询商品&quot;">​</a></h5><p>在order-service的OrderController中，修改/order/save端点，模拟新增订单：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">GetMapping</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;/save&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> String </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">saveOrder</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 查询商品</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    orderService.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">queryGoods</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 查询订单</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    System.err.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">println</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;新增订单&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;新增订单成功&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h5 id="_4-给查询商品添加资源标记" tabindex="-1">4）给查询商品添加资源标记 <a class="header-anchor" href="#_4-给查询商品添加资源标记" aria-label="Permalink to &quot;4）给查询商品添加资源标记&quot;">​</a></h5><p>默认情况下，OrderService中的方法是不被Sentinel监控的，需要我们自己通过注解来标记要监控的方法。</p><p>给OrderService的queryGoods方法添加@SentinelResource注解：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SentinelResource</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;goods&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> queryGoods</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(){</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    System.err.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">println</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;查询商品&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>链路模式中，是对不同来源的两个链路做监控。但是sentinel默认会给进入SpringMVC的所有请求设置同一个root资源，会导致链路模式失效。</p><p>我们需要关闭这种对SpringMVC的资源聚合，修改order-service服务的application.yml文件：</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">spring</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  cloud</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    sentinel</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      web-context-unify</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">false</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> # 关闭context整合</span></span></code></pre></div><p>重启服务，访问/order/query和/order/save，可以查看到sentinel的簇点链路规则中，出现了新的资源：</p><p><img src="/cswiki/assets/image-20210716105227163.rlGumZxD.png" alt="image-20210716105227163" loading="lazy"></p><h5 id="_5-添加流控规则" tabindex="-1">5）添加流控规则 <a class="header-anchor" href="#_5-添加流控规则" aria-label="Permalink to &quot;5）添加流控规则&quot;">​</a></h5><p>点击goods资源后面的流控按钮，在弹出的表单中填写下面信息：</p><p><img src="/cswiki/assets/image-20210716105408723.8xVGNJ3d.png" alt="image-20210716105408723" loading="lazy"></p><p>只统计从/order/query进入/goods的资源，QPS阈值为2，超出则被限流。</p><h5 id="_6-jmeter测试" tabindex="-1">6）Jmeter测试 <a class="header-anchor" href="#_6-jmeter测试" aria-label="Permalink to &quot;6）Jmeter测试&quot;">​</a></h5><p>选择《流控模式-链路》：</p><p><img src="/cswiki/assets/image-20210716105612312.lcbTUgmN.png" alt="image-20210716105612312" loading="lazy"></p><p>可以看到这里200个用户，50秒内发完，QPS为4，超过了我们设定的阈值2</p><p>一个http请求是访问/order/save：</p><p><img src="/cswiki/assets/image-20210716105812789.xt1XKigx.png" alt="image-20210716105812789" loading="lazy"></p><p>运行的结果：</p><p><img src="/cswiki/assets/image-20210716110027064._I0EIUbC.png" alt="image-20210716110027064" loading="lazy"></p><p>完全不受影响。</p><p>另一个是访问/order/query：</p><p><img src="/cswiki/assets/image-20210716105855951.XovLTWDH.png" alt="image-20210716105855951" loading="lazy"></p><p>运行结果：</p><p><img src="/cswiki/assets/image-20210716105956401.bPwAT91L.png" alt="image-20210716105956401" loading="lazy"></p><p>每次只有2个通过。</p><h4 id="总结-1" tabindex="-1">.总结 <a class="header-anchor" href="#总结-1" aria-label="Permalink to &quot;.总结&quot;">​</a></h4><p>流控模式有哪些？</p><p>•直接：对当前资源限流</p><p>•关联：高优先级资源触发阈值，对低优先级资源限流。</p><p>•链路：阈值统计时，只统计从指定资源进入当前资源的请求，是对请求来源的限流</p><h3 id="流控效果" tabindex="-1">流控效果 <a class="header-anchor" href="#流控效果" aria-label="Permalink to &quot;流控效果&quot;">​</a></h3><p>在流控的高级选项中，还有一个流控效果选项：</p><p><img src="/cswiki/assets/image-20210716110225104.PI6-Ihm7.png" alt="image-20210716110225104" loading="lazy"></p><p>流控效果是指请求达到流控阈值时应该采取的措施，包括三种：</p><ul><li><p>快速失败：达到阈值后，新的请求会被立即拒绝并抛出FlowException异常。是默认的处理方式。</p></li><li><p>warm up：预热模式，对超出阈值的请求同样是拒绝并抛出异常。但这种模式阈值会动态变化，从一个较小值逐渐增加到最大阈值。</p></li><li><p>排队等待：让所有的请求按照先后次序排队执行，两个请求的间隔不能小于指定时长</p></li></ul><h4 id="warm-up" tabindex="-1">.warm up <a class="header-anchor" href="#warm-up" aria-label="Permalink to &quot;.warm up&quot;">​</a></h4><p>阈值一般是一个微服务能承担的最大QPS，但是一个服务刚刚启动时，一切资源尚未初始化（<strong>冷启动</strong>），如果直接将QPS跑到最大值，可能导致服务瞬间宕机。</p><p>warm up也叫<strong>预热模式</strong>，是应对服务冷启动的一种方案。请求阈值初始值是 maxThreshold / coldFactor，持续指定时长后，逐渐提高到maxThreshold值。而coldFactor的默认值是3.</p><p>例如，我设置QPS的maxThreshold为10，预热时间为5秒，那么初始阈值就是 10 / 3 ，也就是3，然后在5秒后逐渐增长到10.</p><p><img src="/cswiki/assets/image-20210716110629796.ciE_BjYW.png" alt="image-20210716110629796" loading="lazy"></p><p><strong>案例</strong></p><p>需求：给/order/{orderId}这个资源设置限流，最大QPS为10，利用warm up效果，预热时长为5秒</p><h5 id="_1-配置流控规则" tabindex="-1">1）配置流控规则： <a class="header-anchor" href="#_1-配置流控规则" aria-label="Permalink to &quot;1）配置流控规则：&quot;">​</a></h5><p><img src="/cswiki/assets/image-20210716111012387.Q4VbjaDG.png" alt="image-20210716111012387" loading="lazy"></p><h5 id="_2-jmeter测试" tabindex="-1">2）Jmeter测试 <a class="header-anchor" href="#_2-jmeter测试" aria-label="Permalink to &quot;2）Jmeter测试&quot;">​</a></h5><p>选择《流控效果，warm up》：</p><p><img src="/cswiki/assets/image-20210716111136699.szVgMcer.png" alt="image-20210716111136699" loading="lazy"></p><p>QPS为10.</p><p>刚刚启动时，大部分请求失败，成功的只有3个，说明QPS被限定在3：</p><p><img src="/cswiki/assets/image-20210716111303701.0Rc7JLTZ.png" alt="image-20210716111303701" loading="lazy"></p><p>随着时间推移，成功比例越来越高：</p><p><img src="/cswiki/assets/image-20210716111404717.yyQ4X-m4.png" alt="image-20210716111404717" loading="lazy"></p><p>到Sentinel控制台查看实时监控：</p><p><img src="/cswiki/assets/image-20210716111526480.wORIildk.png" alt="image-20210716111526480" loading="lazy"></p><p>一段时间后：</p><p><img src="/cswiki/assets/image-20210716111658541.rg2OSxRq.png" alt="image-20210716111658541" loading="lazy"></p><h4 id="排队等待" tabindex="-1">.排队等待 <a class="header-anchor" href="#排队等待" aria-label="Permalink to &quot;.排队等待&quot;">​</a></h4><p>当请求超过QPS阈值时，快速失败和warm up 会拒绝新的请求并抛出异常。</p><p>而排队等待则是让所有请求进入一个队列中，然后按照阈值允许的时间间隔依次执行。后来的请求必须等待前面执行完成，如果请求预期的等待时间超出最大时长，则会被拒绝。</p><p>工作原理</p><p>例如：QPS = 5，意味着每200ms处理一个队列中的请求；timeout = 2000，意味着<strong>预期等待时长</strong>超过2000ms的请求会被拒绝并抛出异常。</p><p>那什么叫做预期等待时长呢？</p><p>比如现在一下子来了12 个请求，因为每200ms执行一个请求，那么：</p><ul><li>第6个请求的<strong>预期等待时长</strong> = 200 * （6 - 1） = 1000ms</li><li>第12个请求的预期等待时长 = 200 * （12-1） = 2200ms</li></ul><p>现在，第1秒同时接收到10个请求，但第2秒只有1个请求，此时QPS的曲线这样的：</p><p><img src="/cswiki/assets/image-20210716113147176.u77elxti.png" alt="image-20210716113147176" loading="lazy"></p><p>如果使用队列模式做流控，所有进入的请求都要排队，以固定的200ms的间隔执行，QPS会变的很平滑：</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAssAAAFeCAYAAABzS1K2AAAOrUlEQVR4nO3dO1IbaReA4dN/zVIkBy5WIK0AOyFySiaFkEw24WSToBAyp0ROjFYgrYAicPde+g/E1eZgDJL69jxVVGEbzGdu887htLqo67oOAADgF/9r+gAAANBWYhkAABJiGQAAEmIZAAASYhkAABJiGQAAEmIZAAASYhkAABJiGQAAEmIZAAASYhkAABJiGQAAEmIZAAASYhkAABJiGQAAEmIZAAASYhkAABJiGQAAEmIZAAASYhkAABJiGQAAEmIZAAASYhkAABJiecuKomj6CAAAbIlY3qK7UBbMAAD9IJYBACAhlrfk52my6TIAQPeJZQAASIjlLcimyKbLAADdJpYBACAhlgEAICGW3+l3qxZWMQAAukssAwBAQiwDAEBCLL/Da1csrGIAAHSTWAYAgIRY3hPTZQCA7hHLbyR+AQD6TywDAEBCLL/BW6fKptEAAN3yV9MH6KK6rp/9/ccxnL0MAADdYbIMAAAJsQwAAAmxDAAACbEMAAAJsQwAAAmxDAAACbEMAAAJsQwAAAmxDAAACbEMAAAJsQwAAAmxDAAACbEMAAAJsQwAAAmxDAAACbEMAAAJsQwAAAmxDAAACbEMAAAJsQwAAAmxDAAAiW7GclVFtVzEYj6P6XQa0/kiqle/6jLm02kURfHwNJ3GfLF89d8BAMAwFHVd100f4lWqRUyPL2O9Xv/6Z5OzKFcnMfrtXzGN8ekzr3//98zianUeh288YlEU98935d0KAECuO5Pl8uYhlCeTmMxmMZv8wetXizi+C+XJWVyVddR1HXVdRnk1i0lExPoiPs2XWz44AABd1Z1YHv8dZVluAne1itX5eRwdvP7Vl/+dxjrifgp9eD+GHsXo8DxWV7PNLy/+jYV9DAAAokuxPBrFaPS7RYvMMr5dbJ6bfPn8/LrG4VFscnkdl9/VMgAAXYrl96h+xHVEREziy+csuA/j6Ha4vL787mI/AAAGEsvlzWYFIw7iwwvD6fHH2yXo9U2UezgWAADtNohYrn5cN30EAAA6aBCx/FqjD39wxSAAAL0nlp91HT8sLQMADJ5YftbLu80AAAyDWAYAgIRYfsSFgAAAPDaIWH64cO/lXeTy5u522B9jvPNTAQDQdoOI5cd357tJH0C5ivvB8sGH5+/yBwDAoAwjlmMcd/cbufi2fP5Fqu9xeTtYnh0d7udYAAC02kBieRQn/9zey/riU0wXP+1iVMuYH59u7vI3OYu/tTIAADGYWI6Iw/O4uu3l9ek4imIa0+k0ptMiivGnuNiUcpx9PbGCAQBARAwpliPi8LyMq7NZbDYy1rFer2N9u3oRk1lclas4UcoAANwq6rqumz5EI6oq7pcxRqOtTJOLorh/fqjvVgCAPhluLO+AWAYA6JdBrWEAAMCfEMsAAJAQywAAkBDLAACQEMsAAJAQywAAkBDLAACQEMsAAJAQywAAkBDLAACQEMsAAJAQywAAkBDLAACQEMsAAJAQywAAkBDLAACQEMsAAJAQywAAkBDLAACQEMsAAJAQywAAkBDLAACQEMsAAJAQywAAkBDLAACQEMsAAJAQywAAkBDLAACQEMsAAJAQywAAkBDLAACQEMsAAJAQywAAkBDLAACQEMsAAJAQywAAkBDLAACQEMsAAJAQywAAkBDLAACQEMsAAJAQywAAkBDLAACQEMsAAJAQywAAkBDLAACQEMsAAJAQywAAkBDLAACQEMsAAJAQywAAkBDLAACQEMsAAJAQywAAkBDLAACQEMsAAJAQywAAkBDLAACQEMsAAJAQywAAkBDLAACQEMsAAJAQywAAkPir6QNAHxRF0djbruu6sbcNAH0nluEFTUbwa733jGIbAHJiGaIbUbwrb/m3C+ynhvz5A33l+xx3xDKDs4uwafKbahOh9ta32fX/+IhigOERy/Re39cU3nu+fQag2ASga8QyvfSnUdb2IN6lt/zbRe/zhvx5BNBXYpleEMf79db3X9cj2+cNwPCIZTrtNfElcNrDxwKArhHLdI5ABgD2RSzTGb+LZIEMAGybWKbVBDIA0CSxTCuJZACgDcQyrfJSJAtkAGDfxDKtIJIBgDYSyzQuC2WRDAA0TSzTGJEMALSdWGbvRDIA0BVimb16LpRFMgDQVmKZvTBNBgC6SCyzc6bJAEBXiWV2xjQZAOg6scxOmCYDAH3wv6YPQP8IZQCgL0yW2aqfQ1kkAwBdJpbZCtNkAKCPrGHwbkIZAOgrscy7CGUAoM+sYfBm9pMBgL4zWeZNhDIAMARimT8mlAGAoRDL/BGhDAAMiVjm1YQyADA0YplXEcoAwBCJZX5LKAMAQyWWeZFQBgCGTCyTEsoAwNCJZZ4llAEAxDLPEMoAABtimSeEMgDAA7HMPaEMAPCUWCYihDIAwHPEMgAAJMQypsoAAAmxPHBCGQAgJ5a5J5QBAJ4SywP281QZAICnxPJAWb8AAPg9sTxAQhkA4HXE8sAJZQCAnFgeGHvKAACvJ5YHxPoFAMCfEcsDJZQBAH5PLA/E46myUAYAeB2xPAD2lAEA3kYsD4ypMgDA64nlnjNVBgB4O7HcYx79AgDgfcTyQAhlAIA/J5Z7yvoFAMD7ieUesn4BALAdYrnnhDIAwNuJ5Z6xfgEAsD1iucdMlQEA3kcs94ipMgDAdonlnjJVBgB4P7HcE6bKAADbJ5Z7yFQZAGA7xHIPPJ4qC2UAgO0Ryx1n/QIAYHfEco+YKgMAbJdY7jBTZQCA3RLLPWGqDACwfWK5o0yVAQB2Tyz3gKkyAMBuiOUOMlUGANgPsdxxpsoAALsjljvGVBkAYH/EcoeZKgMA7JZYBgCAhFjukMcrGKbKAAC7J5YBACAhljvCVBkAYP/EMgAAJMRyB3i4OACAZojljrGCAQCwP2K55UyVAQCaI5Y7xFQZAGC/xHKLmSoDADRLLHeEqTIAwP6JZQAASIjllrKCAQDQPLHcAVYwAACaIZZbyFQZAKAdxHLLmSoDADRHLAMAQEIst8zjFQxTZQCAZollAABIiGUAAEiI5RaxggEA0C5iGQAAEmK5JTy2MgBA+4jlFrKCAQDQDmIZAAASYrkFXNgHANBOYhkAABJiGQAAEmK5YVYwAADaSywDAEBCLAMAQEIsN8gKBgBAu4llAABIiGUAAEiI5YZYwQAAaD+xDAAACbEMAAAJsdwAKxgAAN0glgEAICGWAQAgIZb3zAoGAEB3iGUAAEiIZQAASIjlPXq8ggEAQPuJ5YbYVwYAaD+xDAAACbG8J1YwAAC6Ryw3wAoGAEA3iGUAAEiIZQAASIjlPbCvDADQTWJ5z+wrAwB0h1gGAICEWAYAgIRY3rHH+8pWMAAAukUsAwBAQiwDAEBCLO+Qh4wDAOg2sbwn9pUBALpHLAMAQEIsAwBAQizviH1lAIDuE8t7YF8ZAKCbxPKemDQDAHSPWAYAgIRY3rG6rk2VAQA6SiwDAECi17FcVcuYT6dRFMXD03Qa88Uyqj2dwVQZAKC7irqnD9VQLaYxPl3nLzCZxdXqPA63+DZ/F8Y9fVcDAD1y1zO6ZaOfk+VqEcd3oTw5i6uyjrquo67LKK9mMYmIWF/Ep/myyVMCALTW45/MD1kvJ8vLeRGfLiJichbl6iRGv75AFJsXiLNyFSe/vMDbvPTJ1MN3MwDQQ35S/lQPJ8vL+HaxeW7y5fOvoRwRcXgUs4iIWMfl931tLwMAdN/QJs79i+XqR1xHRMQkvnzORsaHcbSp5Vhfft/5xX5D+z8wAHiLoUVYHwzhY9a/WC5vYrOtfBAfXlivGH+cbJ5Z30S5h2MBAPRZX8O5d7Fc/bhu+ghPmCoDAEPTp2juXSy/1ujDQdNHAFqgr5MQgDbow/fYv5o+QPOu40cVcfjOR8TIPgm6/MkBQ+PrFdrD1yNtMdjJ8oOXd5sBABguk2UAAHaiD9duDTaWt30hYF3XT35k1IdPDhgCX7fQHr4e22EbKzB9+vj1bg3j4cK9zS5ypry5ux32xxhv6W1vbqld9+oTBADgNfraQb2L5cd357tJH0C5ivvB8sGH5+/yBwDsVV9jq8+G8DHrXyzHOO7uN3Lxbfn8i1Tf4/J2sDw7OtzPsYBWGsI3eoBtGtr3zR7G8ihO/rm9l/XFp5guftrFqJYxPz7d3OVvchZ/a2UAgBcNLZAfK+qe/quX8yI+Xdz9ahKTSUTEOtbrh987K1dxYgcDAOCeCy2f6m0sR1SxXPwX/55exPrnP5rM4urr+btvRAIAQL/1OJYfqaq4X8YYjVzQBwDAqwwjlgEA4A16eIEfANAZ1TLm02lMp0UUxdOn6XQei+ULN02APTBZBgCaUy1iOj799fqixyZnUa5OrFHSCJNlAKBBn+OfqzLKsn7y8GR1eRVns9sbJ6xP4/jnh4KFPTFZBgBa6/6hYE2XaYjJMgDQWodHtzcaW99E2exRGCixDAC01/hjbJYxruOHTQwa8FfTBwDYu6qKqvwe37/dxOX1dcTBl/h67se70Erlze3FfwfxwRcpDRDLwDBUi5geX8Z6/dw191/2fhzgdZbfLjbPTD7GuNmjMFDWMIBhKG8eQnkyiclsFncX2gMtVS3i37tW/vLZT39ohFgGhmH8d5RluXlIqtUqVufncXTQ9KGAXBWL49vHX56cxdcTqUwzrGEAwzAamUpBhyzn4zjdlHKcfXVNAc0xWQYAWmU5n24eWzkmMbtahaEyTTJZBgBaoorlfPwklM8Pmz4TQyeWAYAWqGIxfbR6UZoo0w7WMACAZlXLmN+F8mQWV0KZFjFZBgAaUy3ncfzp4v5RL8qVi/loF7EMADSiWs5jvFlQjslZGSvjZFrIGgYA0Iwf1/fPrk/HURTFy0/TRVQNHpdhEssAAJCwhgEANGJ0sor6pOlTwMtMlgEAICGWAQAgIZYBACAhlgEAICGWAQAgUdR1XTd9CAAAaCOTZQAASIhlAABIiGUAAEiIZQAASIhlAABIiGUAAEiIZQAASIhlAABIiGUAAEiIZQAASIhlAABI/B9dL2XCBqYOYgAAAABJRU5ErkJggg==" alt="image-20210716113426524" loading="lazy"></p><p>平滑的QPS曲线，对于服务器来说是更友好的。</p><p><strong>案例</strong></p><p>需求：给/order/{orderId}这个资源设置限流，最大QPS为10，利用排队的流控效果，超时时长设置为5s</p><h5 id="_1-添加流控规则" tabindex="-1">1）添加流控规则 <a class="header-anchor" href="#_1-添加流控规则" aria-label="Permalink to &quot;1）添加流控规则&quot;">​</a></h5><p><img src="/cswiki/assets/image-20210716114048918.XhSbdMZI.png" alt="image-20210716114048918" loading="lazy"></p><h5 id="_2-jmeter测试-1" tabindex="-1">2）Jmeter测试 <a class="header-anchor" href="#_2-jmeter测试-1" aria-label="Permalink to &quot;2）Jmeter测试&quot;">​</a></h5><p>选择《流控效果，队列》：</p><p><img src="/cswiki/assets/image-20210716114243558.33oxsUgO.png" alt="image-20210716114243558" loading="lazy"></p><p>QPS为15，已经超过了我们设定的10。</p><p>如果是之前的 快速失败、warmup模式，超出的请求应该会直接报错。</p><p>但是我们看看队列模式的运行结果：</p><p><img src="/cswiki/assets/image-20210716114429361.mjCnUuV3.png" alt="image-20210716114429361" loading="lazy"></p><p>全部都通过了。</p><p>再去sentinel查看实时监控的QPS曲线：</p><p><img src="/cswiki/assets/image-20210716114522935.mMMW6Ox6.png" alt="image-20210716114522935" loading="lazy"></p><p>QPS非常平滑，一致保持在10，但是超出的请求没有被拒绝，而是放入队列。因此<strong>响应时间</strong>（等待时间）会越来越长。</p><p>当队列满了以后，才会有部分请求失败：</p><p><img src="/cswiki/assets/image-20210716114651137.WtplRG0O.png" alt="image-20210716114651137" loading="lazy"></p><h4 id="总结-2" tabindex="-1">.总结 <a class="header-anchor" href="#总结-2" aria-label="Permalink to &quot;.总结&quot;">​</a></h4><p>流控效果有哪些？</p><ul><li><p>快速失败：QPS超过阈值时，拒绝新的请求</p></li><li><p>warm up： QPS超过阈值时，拒绝新的请求；QPS阈值是逐渐提升的，可以避免冷启动时高并发导致服务宕机。</p></li><li><p>排队等待：请求会进入队列，按照阈值允许的时间间隔依次执行请求；如果请求预期等待时长大于超时时间，直接拒绝</p></li></ul><h3 id="热点参数限流" tabindex="-1">热点参数限流 <a class="header-anchor" href="#热点参数限流" aria-label="Permalink to &quot;热点参数限流&quot;">​</a></h3><p>之前的限流是统计访问某个资源的所有请求，判断是否超过QPS阈值。而热点参数限流是<strong>分别统计参数值相同的请求</strong>，判断是否超过QPS阈值。</p><h4 id="全局参数限流" tabindex="-1">.全局参数限流 <a class="header-anchor" href="#全局参数限流" aria-label="Permalink to &quot;.全局参数限流&quot;">​</a></h4><p>例如，一个根据id查询商品的接口：</p><p><img src="/cswiki/assets/image-20210716115014663.lhxSpqKr.png" alt="image-20210716115014663" loading="lazy"></p><p>访问/goods/{id}的请求中，id参数值会有变化，热点参数限流会根据参数值分别统计QPS，统计结果：</p><p><img src="/cswiki/assets/image-20210716115131463.dZSbuedx.png" alt="image-20210716115131463" loading="lazy"></p><p>当id=1的请求触发阈值被限流时，id值不为1的请求不受影响。</p><p>配置示例：</p><p><img src="/cswiki/assets/image-20210716115232426.qMFM61hO.png" alt="image-20210716115232426" loading="lazy"></p><p>代表的含义是：对hot这个资源的0号参数（第一个参数）做统计，每1秒<strong>相同参数值</strong>的请求数不能超过5</p><h4 id="热点参数限流-1" tabindex="-1">.热点参数限流 <a class="header-anchor" href="#热点参数限流-1" aria-label="Permalink to &quot;.热点参数限流&quot;">​</a></h4><p>刚才的配置中，对查询商品这个接口的所有商品一视同仁，QPS都限定为5.</p><p>而在实际开发中，可能部分商品是热点商品，例如秒杀商品，我们希望这部分商品的QPS限制与其它商品不一样，高一些。那就需要配置热点参数限流的高级选项了：</p><p><img src="/cswiki/assets/image-20210716115717523.DS_2aI_d.png" alt="image-20210716115717523" loading="lazy"></p><p>结合上一个配置，这里的含义是对0号的long类型参数限流，每1秒相同参数的QPS不能超过5，有两个例外：</p><p>•如果参数值是100，则每1秒允许的QPS为10</p><p>•如果参数值是101，则每1秒允许的QPS为15</p><h4 id="案例" tabindex="-1">.案例 <a class="header-anchor" href="#案例" aria-label="Permalink to &quot;.案例&quot;">​</a></h4><p><strong>案例需求</strong>：给/order/{orderId}这个资源添加热点参数限流，规则如下：</p><p>•默认的热点参数规则是每1秒请求量不超过2</p><p>•给102这个参数设置例外：每1秒请求量不超过4</p><p>•给103这个参数设置例外：每1秒请求量不超过10</p><p><strong>注意事项</strong>：热点参数限流对默认的SpringMVC资源无效，需要利用@SentinelResource注解标记资源</p><h5 id="_1-标记资源" tabindex="-1">1）标记资源 <a class="header-anchor" href="#_1-标记资源" aria-label="Permalink to &quot;1）标记资源&quot;">​</a></h5><p>给order-service中的OrderController中的/order/{orderId}资源添加注解：</p><p><img src="/cswiki/assets/image-20210716120033572.ByEM8v64.png" alt="image-20210716120033572" loading="lazy"></p><h5 id="_2-热点参数限流规则" tabindex="-1">2）热点参数限流规则 <a class="header-anchor" href="#_2-热点参数限流规则" aria-label="Permalink to &quot;2）热点参数限流规则&quot;">​</a></h5><p>访问该接口，可以看到我们标记的hot资源出现了：</p><p><img src="/cswiki/assets/image-20210716120208509.psbSef6M.png" alt="image-20210716120208509" loading="lazy"></p><p>这里不要点击hot后面的按钮，页面有BUG</p><p>点击左侧菜单中<strong>热点规则</strong>菜单：</p><p><img src="/cswiki/assets/image-20210716120319009.w2f3W18J.png" alt="image-20210716120319009" loading="lazy"></p><p>点击新增，填写表单：</p><p><img src="/cswiki/assets/image-20210716120536714.ui5Kd8VN.png" alt="image-20210716120536714" loading="lazy"></p><h5 id="_3-jmeter测试" tabindex="-1">3）Jmeter测试 <a class="header-anchor" href="#_3-jmeter测试" aria-label="Permalink to &quot;3）Jmeter测试&quot;">​</a></h5><p>选择《热点参数限流 QPS1》：</p><p><img src="/cswiki/assets/image-20210716120754527.dfqaUK-z.png" alt="image-20210716120754527" loading="lazy"></p><p>这里发起请求的QPS为5.</p><p>包含3个http请求：</p><p>普通参数，QPS阈值为2</p><p><img src="/cswiki/assets/image-20210716120840501.LoZBTwYu.png" alt="image-20210716120840501" loading="lazy"></p><p>运行结果：</p><p><img src="/cswiki/assets/image-20210716121105567.WihBnM3o.png" alt="image-20210716121105567" loading="lazy"></p><p>例外项，QPS阈值为4</p><p><img src="/cswiki/assets/image-20210716120900365.Kxn7M112.png" alt="image-20210716120900365" loading="lazy"></p><p>运行结果：</p><p><img src="/cswiki/assets/image-20210716121201630.9ZO9Z0TR.png" alt="image-20210716121201630" loading="lazy"></p><p>例外项，QPS阈值为10</p><p><img src="/cswiki/assets/image-20210716120919131.pmfTxFhI.png" alt="image-20210716120919131" loading="lazy"></p><p>运行结果：</p><p><img src="/cswiki/assets/image-20210716121220305.mBIlYRWE.png" alt="image-20210716121220305" loading="lazy"></p><h2 id="隔离和降级" tabindex="-1">隔离和降级 <a class="header-anchor" href="#隔离和降级" aria-label="Permalink to &quot;隔离和降级&quot;">​</a></h2><p>限流是一种预防措施，虽然限流可以尽量避免因高并发而引起的服务故障，但服务还会因为其它原因而故障。</p><p>而要将这些故障控制在一定范围，避免雪崩，就要靠<strong>线程隔离</strong>（舱壁模式）和<strong>熔断降级</strong>手段了。</p><p><strong>线程隔离</strong>之前讲到过：调用者在调用服务提供者时，给每个调用的请求分配独立线程池，出现故障时，最多消耗这个线程池内资源，避免把调用者的所有资源耗尽。</p><p><img src="/cswiki/assets/image-20210715173215243.mKdbDjVz.png" alt="image-20210715173215243" loading="lazy"></p><p><strong>熔断降级</strong>：是在调用方这边加入断路器，统计对服务提供者的调用，如果调用的失败比例过高，则熔断该业务，不允许访问该服务的提供者了。</p><p><img src="/cswiki/assets/image-20210715173428073.Fa4wNeZ7.png" alt="image-20210715173428073" loading="lazy"></p><p>可以看到，不管是线程隔离还是熔断降级，都是对<strong>客户端</strong>（调用方）的保护。需要在<strong>调用方</strong> 发起远程调用时做线程隔离、或者服务熔断。</p><p>而我们的微服务远程调用都是基于Feign来完成的，因此我们需要将Feign与Sentinel整合，在Feign里面实现线程隔离和服务熔断。</p><h3 id="feignclient整合sentinel" tabindex="-1">FeignClient整合Sentinel <a class="header-anchor" href="#feignclient整合sentinel" aria-label="Permalink to &quot;FeignClient整合Sentinel&quot;">​</a></h3><p>SpringCloud中，微服务调用都是通过Feign来实现的，因此做客户端保护必须整合Feign和Sentinel。</p><h4 id="修改配置-开启sentinel功能" tabindex="-1">.修改配置，开启sentinel功能 <a class="header-anchor" href="#修改配置-开启sentinel功能" aria-label="Permalink to &quot;.修改配置，开启sentinel功能&quot;">​</a></h4><p>修改OrderService的application.yml文件，开启Feign的Sentinel功能：</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">feign</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  sentinel</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    enabled</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> # 开启feign对sentinel的支持</span></span></code></pre></div><h4 id="编写失败降级逻辑" tabindex="-1">.编写失败降级逻辑 <a class="header-anchor" href="#编写失败降级逻辑" aria-label="Permalink to &quot;.编写失败降级逻辑&quot;">​</a></h4><p>业务失败后，不能直接报错，而应该返回用户一个友好提示或者默认结果，这个就是失败降级逻辑。</p><p>给FeignClient编写失败后的降级逻辑</p><p>①方式一：FallbackClass，无法对远程调用的异常做处理</p><p>②方式二：FallbackFactory，可以对远程调用的异常做处理，我们选择这种</p><p>这里我们演示方式二的失败降级处理。</p><p><strong>步骤一</strong>：在feing-api项目中定义类，实现FallbackFactory：</p><p><img src="/cswiki/assets/image-20210716122403502.FZ58Zouw.png" alt="image-20210716122403502" loading="lazy"></p><p>代码：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">package</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> cn.itcast.feign.clients.fallback;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> cn.itcast.feign.clients.UserClient;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> cn.itcast.feign.pojo.User;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> feign.hystrix.FallbackFactory;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> lombok.extern.slf4j.Slf4j;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Slf4j</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> UserClientFallbackFactory</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> implements</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> FallbackFactory</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">UserClient</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Override</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> UserClient </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">create</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(Throwable </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">throwable</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> UserClient</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Override</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            public</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> User </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">findById</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(Long </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                log.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;查询用户异常&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, throwable);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">                return</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> User</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        };</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p><strong>步骤二</strong>：在feing-api项目中的DefaultFeignConfiguration类中将UserClientFallbackFactory注册为一个Bean：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Bean</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> UserClientFallbackFactory </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">userClientFallbackFactory</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(){</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> UserClientFallbackFactory</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p><strong>步骤三</strong>：在feing-api项目中的UserClient接口中使用UserClientFallbackFactory：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> cn.itcast.feign.clients.fallback.UserClientFallbackFactory;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> cn.itcast.feign.pojo.User;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> org.springframework.cloud.openfeign.FeignClient;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> org.springframework.web.bind.annotation.GetMapping;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> org.springframework.web.bind.annotation.PathVariable;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">FeignClient</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">value</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;userservice&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">fallbackFactory</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> UserClientFallbackFactory.class)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> interface</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> UserClient</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">GetMapping</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;/user/{id}&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    User </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">findById</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">PathVariable</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;id&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) Long </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>重启后，访问一次订单查询业务，然后查看sentinel控制台，可以看到新的簇点链路：</p><p><img src="/cswiki/assets/image-20210716123705780.yGRr1ExI.png" alt="image-20210716123705780" loading="lazy"></p><h4 id="总结-3" tabindex="-1">.总结 <a class="header-anchor" href="#总结-3" aria-label="Permalink to &quot;.总结&quot;">​</a></h4><p>Sentinel支持的雪崩解决方案：</p><ul><li>线程隔离（仓壁模式）</li><li>降级熔断</li></ul><p>Feign整合Sentinel的步骤：</p><ul><li>在application.yml中配置：feign.sentienl.enable=true</li><li>给FeignClient编写FallbackFactory并注册为Bean</li><li>将FallbackFactory配置到FeignClient</li></ul><h3 id="线程隔离-舱壁模式" tabindex="-1">线程隔离（舱壁模式） <a class="header-anchor" href="#线程隔离-舱壁模式" aria-label="Permalink to &quot;线程隔离（舱壁模式）&quot;">​</a></h3><h4 id="线程隔离的实现方式" tabindex="-1">.线程隔离的实现方式 <a class="header-anchor" href="#线程隔离的实现方式" aria-label="Permalink to &quot;.线程隔离的实现方式&quot;">​</a></h4><p>线程隔离有两种方式实现：</p><ul><li><p>线程池隔离</p></li><li><p>信号量隔离（Sentinel默认采用）</p></li></ul><p>如图：</p><p><img src="/cswiki/assets/image-20210716123036937.xNtmcNUA.png" alt="image-20210716123036937" loading="lazy"></p><p><strong>线程池隔离</strong>：给每个服务调用业务分配一个线程池，利用线程池本身实现隔离效果</p><p><strong>信号量隔离</strong>：不创建线程池，而是计数器模式，记录业务使用的线程数量，达到信号量上限时，禁止新的请求。</p><p>两者的优缺点：</p><p><img src="/cswiki/assets/image-20210716123240518.dKVAPpb1.png" alt="image-20210716123240518" loading="lazy"></p><h4 id="sentinel的线程隔离" tabindex="-1">.sentinel的线程隔离 <a class="header-anchor" href="#sentinel的线程隔离" aria-label="Permalink to &quot;.sentinel的线程隔离&quot;">​</a></h4><p><strong>用法说明</strong>：</p><p>在添加限流规则时，可以选择两种阈值类型：</p><p><img src="/cswiki/assets/image-20210716123411217.ojzo0rc2.png" alt="image-20210716123411217" loading="lazy"></p><ul><li><p>QPS：就是每秒的请求数，在快速入门中已经演示过</p></li><li><p>线程数：是该资源能使用用的tomcat线程数的最大值。也就是通过限制线程数量，实现<strong>线程隔离</strong>（舱壁模式）。</p></li></ul><p><strong>案例需求</strong>：给 order-service服务中的UserClient的查询用户接口设置流控规则，线程数不能超过 2。然后利用jemeter测试。</p><h5 id="_1-配置隔离规则" tabindex="-1">1）配置隔离规则 <a class="header-anchor" href="#_1-配置隔离规则" aria-label="Permalink to &quot;1）配置隔离规则&quot;">​</a></h5><p>选择feign接口后面的流控按钮：</p><p><img src="/cswiki/assets/image-20210716123831992.a68CV_-z.png" alt="image-20210716123831992" loading="lazy"></p><p>填写表单：</p><p><img src="/cswiki/assets/image-20210716123936844.MM72UWAQ.png" alt="image-20210716123936844" loading="lazy"></p><h5 id="_2-jmeter测试-2" tabindex="-1">2）Jmeter测试 <a class="header-anchor" href="#_2-jmeter测试-2" aria-label="Permalink to &quot;2）Jmeter测试&quot;">​</a></h5><p>选择《阈值类型-线程数&lt;2》：</p><p><img src="/cswiki/assets/image-20210716124229894.9I5L1mYC.png" alt="image-20210716124229894" loading="lazy"></p><p>一次发生10个请求，有较大概率并发线程数超过2，而超出的请求会走之前定义的失败降级逻辑。</p><p>查看运行结果：</p><p><img src="/cswiki/assets/image-20210716124147820.11kPSRln.png" alt="image-20210716124147820" loading="lazy"></p><p>发现虽然结果都是通过了，不过部分请求得到的响应是降级返回的null信息。</p><h4 id="总结-4" tabindex="-1">.总结 <a class="header-anchor" href="#总结-4" aria-label="Permalink to &quot;.总结&quot;">​</a></h4><p>线程隔离的两种手段是？</p><ul><li><p>信号量隔离</p></li><li><p>线程池隔离</p></li></ul><p>信号量隔离的特点是？</p><ul><li>基于计数器模式，简单，开销小</li></ul><p>线程池隔离的特点是？</p><ul><li>基于线程池模式，有额外开销，但隔离控制更强</li></ul><h3 id="熔断降级" tabindex="-1">熔断降级 <a class="header-anchor" href="#熔断降级" aria-label="Permalink to &quot;熔断降级&quot;">​</a></h3><p>熔断降级是解决雪崩问题的重要手段。其思路是由<strong>断路器</strong>统计服务调用的异常比例、慢请求比例，如果超出阈值则会<strong>熔断</strong>该服务。即拦截访问该服务的一切请求；而当服务恢复时，断路器会放行访问该服务的请求。</p><p>断路器控制熔断和放行是通过状态机来完成的：</p><p><img src="/cswiki/assets/image-20210716130958518.r9VvaCjb.png" alt="image-20210716130958518" loading="lazy"></p><p>状态机包括三个状态：</p><ul><li>closed：关闭状态，断路器放行所有请求，并开始统计异常比例、慢请求比例。超过阈值则切换到open状态</li><li>open：打开状态，服务调用被<strong>熔断</strong>，访问被熔断服务的请求会被拒绝，快速失败，直接走降级逻辑。Open状态5秒后会进入half-open状态</li><li>half-open：半开状态，放行一次请求，根据执行结果来判断接下来的操作。 <ul><li>请求成功：则切换到closed状态</li><li>请求失败：则切换到open状态</li></ul></li></ul><p>断路器熔断策略有三种：慢调用、异常比例、异常数</p><h4 id="慢调用" tabindex="-1">.慢调用 <a class="header-anchor" href="#慢调用" aria-label="Permalink to &quot;.慢调用&quot;">​</a></h4><p><strong>慢调用</strong>：业务的响应时长（RT）大于指定时长的请求认定为慢调用请求。在指定时间内，如果请求数量超过设定的最小数量，慢调用比例大于设定的阈值，则触发熔断。</p><p>例如：</p><p><img src="/cswiki/assets/image-20210716145934347.SCcOOI8C.png" alt="image-20210716145934347" loading="lazy"></p><p>解读：RT超过500ms的调用是慢调用，统计最近10000ms内的请求，如果请求量超过10次，并且慢调用比例不低于0.5，则触发熔断，熔断时长为5秒。然后进入half-open状态，放行一次请求做测试。</p><p><strong>案例</strong></p><p>需求：给 UserClient的查询用户接口设置降级规则，慢调用的RT阈值为50ms，统计时间为1秒，最小请求数量为5，失败阈值比例为0.4，熔断时长为5</p><h5 id="_1-设置慢调用" tabindex="-1">1）设置慢调用 <a class="header-anchor" href="#_1-设置慢调用" aria-label="Permalink to &quot;1）设置慢调用&quot;">​</a></h5><p>修改user-service中的/user/{id}这个接口的业务。通过休眠模拟一个延迟时间：</p><p><img src="/cswiki/assets/image-20210716150234787.0Gk7N-aF.png" alt="image-20210716150234787" loading="lazy"></p><p>此时，orderId=101的订单，关联的是id为1的用户，调用时长为60ms：</p><p><img src="/cswiki/assets/image-20210716150510956.ZRZTbIqx.png" alt="image-20210716150510956" loading="lazy"></p><p>orderId=102的订单，关联的是id为2的用户，调用时长为非常短；</p><p><img src="/cswiki/assets/image-20210716150605208.oHrwwrAd.png" alt="image-20210716150605208" loading="lazy"></p><h5 id="_2-设置熔断规则" tabindex="-1">2）设置熔断规则 <a class="header-anchor" href="#_2-设置熔断规则" aria-label="Permalink to &quot;2）设置熔断规则&quot;">​</a></h5><p>下面，给feign接口设置降级规则：</p><p><img src="/cswiki/assets/image-20210716150654094.tsTf3UFu.png" alt="image-20210716150654094" loading="lazy"></p><p>规则：</p><p><img src="/cswiki/assets/image-20210716150740434.HivabPtf.png" alt="image-20210716150740434" loading="lazy"></p><p>超过50ms的请求都会被认为是慢请求</p><h5 id="_3-测试" tabindex="-1">3）测试 <a class="header-anchor" href="#_3-测试" aria-label="Permalink to &quot;3）测试&quot;">​</a></h5><p>在浏览器访问：<a href="http://localhost:8088/order/101%EF%BC%8C%E5%BF%AB%E9%80%9F%E5%88%B7%E6%96%B05%E6%AC%A1%EF%BC%8C%E5%8F%AF%E4%BB%A5%E5%8F%91%E7%8E%B0%EF%BC%9A" target="_blank" rel="noreferrer">http://localhost:8088/order/101，快速刷新5次，可以发现：</a></p><p><img src="/cswiki/assets/image-20210716150911004.p9cRZ_4x.png" alt="image-20210716150911004" loading="lazy"></p><p>触发了熔断，请求时长缩短至5ms，快速失败了，并且走降级逻辑，返回的null</p><p>在浏览器访问：<a href="http://localhost:8088/order/102%EF%BC%8C%E7%AB%9F%E7%84%B6%E4%B9%9F%E8%A2%AB%E7%86%94%E6%96%AD%E4%BA%86%EF%BC%9A" target="_blank" rel="noreferrer">http://localhost:8088/order/102，竟然也被熔断了：</a></p><p><img src="/cswiki/assets/image-20210716151107785.mrFCLr8t.png" alt="image-20210716151107785" loading="lazy"></p><h4 id="异常比例、异常数" tabindex="-1">.异常比例、异常数 <a class="header-anchor" href="#异常比例、异常数" aria-label="Permalink to &quot;.异常比例、异常数&quot;">​</a></h4><p><strong>异常比例或异常数</strong>：统计指定时间内的调用，如果调用次数超过指定请求数，并且出现异常的比例达到设定的比例阈值（或超过指定异常数），则触发熔断。</p><p>例如，一个异常比例设置：</p><p><img src="/cswiki/assets/image-20210716131430682.RUDaXLZc.png" alt="image-20210716131430682" loading="lazy"></p><p>解读：统计最近1000ms内的请求，如果请求量超过10次，并且异常比例不低于0.4，则触发熔断。</p><p>一个异常数设置：</p><p><img src="/cswiki/assets/image-20210716131522912.KDkK-kkh.png" alt="image-20210716131522912" loading="lazy"></p><p>解读：统计最近1000ms内的请求，如果请求量超过10次，并且异常比例不低于2次，则触发熔断。</p><p><strong>案例</strong></p><p>需求：给 UserClient的查询用户接口设置降级规则，统计时间为1秒，最小请求数量为5，失败阈值比例为0.4，熔断时长为5s</p><h5 id="_1-设置异常请求" tabindex="-1">1）设置异常请求 <a class="header-anchor" href="#_1-设置异常请求" aria-label="Permalink to &quot;1）设置异常请求&quot;">​</a></h5><p>首先，修改user-service中的/user/{id}这个接口的业务。手动抛出异常，以触发异常比例的熔断：</p><p><img src="/cswiki/assets/image-20210716151348183.eDcftanF.png" alt="image-20210716151348183" loading="lazy"></p><p>也就是说，id 为 2时，就会触发异常</p><h5 id="_2-设置熔断规则-1" tabindex="-1">2）设置熔断规则 <a class="header-anchor" href="#_2-设置熔断规则-1" aria-label="Permalink to &quot;2）设置熔断规则&quot;">​</a></h5><p>下面，给feign接口设置降级规则：</p><p><img src="/cswiki/assets/image-20210716150654094.tsTf3UFu.png" alt="image-20210716150654094" loading="lazy"></p><p>规则：</p><p><img src="/cswiki/assets/image-20210716151538785.eMEOPnbV.png" alt="image-20210716151538785" loading="lazy"></p><p>在5次请求中，只要异常比例超过0.4，也就是有2次以上的异常，就会触发熔断。</p><h5 id="_3-测试-1" tabindex="-1">3）测试 <a class="header-anchor" href="#_3-测试-1" aria-label="Permalink to &quot;3）测试&quot;">​</a></h5><p>在浏览器快速访问：<a href="http://localhost:8088/order/102%EF%BC%8C%E5%BF%AB%E9%80%9F%E5%88%B7%E6%96%B05%E6%AC%A1%EF%BC%8C%E8%A7%A6%E5%8F%91%E7%86%94%E6%96%AD%EF%BC%9A" target="_blank" rel="noreferrer">http://localhost:8088/order/102，快速刷新5次，触发熔断：</a></p><p><img src="/cswiki/assets/image-20210716151722916.5Kb1i2TL.png" alt="image-20210716151722916" loading="lazy"></p><p>此时，我们去访问本来应该正常的103：</p><p><img src="/cswiki/assets/image-20210716151844817.KT-vISGP.png" alt="image-20210716151844817" loading="lazy"></p><h2 id="授权规则" tabindex="-1">授权规则 <a class="header-anchor" href="#授权规则" aria-label="Permalink to &quot;授权规则&quot;">​</a></h2><p>授权规则可以对请求方来源做判断和控制。</p><h3 id="授权规则-1" tabindex="-1">授权规则 <a class="header-anchor" href="#授权规则-1" aria-label="Permalink to &quot;授权规则&quot;">​</a></h3><h4 id="基本规则" tabindex="-1">.基本规则 <a class="header-anchor" href="#基本规则" aria-label="Permalink to &quot;.基本规则&quot;">​</a></h4><p>授权规则可以对调用方的来源做控制，有白名单和黑名单两种方式。</p><ul><li><p>白名单：来源（origin）在白名单内的调用者允许访问</p></li><li><p>黑名单：来源（origin）在黑名单内的调用者不允许访问</p></li></ul><p>点击左侧菜单的授权，可以看到授权规则：</p><p><img src="/cswiki/assets/image-20210716152010750.Jyz3Y_vv.png" alt="image-20210716152010750" loading="lazy"></p><ul><li orderId=""><p>资源名：就是受保护的资源，例如/order/</p></li><li><p>流控应用：是来源者的名单，</p><ul><li>如果是勾选白名单，则名单中的来源被许可访问。</li><li>如果是勾选黑名单，则名单中的来源被禁止访问。</li></ul></li></ul><p>比如：</p><p><img src="/cswiki/assets/image-20210716152349191.QRepsEDX.png" alt="image-20210716152349191" loading="lazy"></p><p>我们允许请求从gateway到order-service，不允许浏览器访问order-service，那么白名单中就要填写<strong>网关的来源名称（origin）</strong>。</p><h4 id="如何获取origin" tabindex="-1">.如何获取origin <a class="header-anchor" href="#如何获取origin" aria-label="Permalink to &quot;.如何获取origin&quot;">​</a></h4><p>Sentinel是通过RequestOriginParser这个接口的parseOrigin来获取请求的来源的。</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> interface</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> RequestOriginParser</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    /**</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">     * 从请求request对象中获取origin，获取方式自定义</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">     */</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    String </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">parseOrigin</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(HttpServletRequest </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">request</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>这个方法的作用就是从request对象中，获取请求者的origin值并返回。</p><p>默认情况下，sentinel不管请求者从哪里来，返回值永远是default，也就是说一切请求的来源都被认为是一样的值default。</p><p>因此，我们需要自定义这个接口的实现，让<strong>不同的请求，返回不同的origin</strong>。</p><p>例如order-service服务中，我们定义一个RequestOriginParser的实现类：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">package</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> cn.itcast.order.sentinel;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.alibaba.csp.sentinel.adapter.spring.webmvc.callback.RequestOriginParser;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> org.springframework.stereotype.Component;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> org.springframework.util.StringUtils;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> javax.servlet.http.HttpServletRequest;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Component</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> HeaderOriginParser</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> implements</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> RequestOriginParser</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Override</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> String </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">parseOrigin</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(HttpServletRequest </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">request</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 1.获取请求头</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        String origin </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> request.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getHeader</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;origin&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 2.非空判断</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (StringUtils.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">isEmpty</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(origin)) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            origin </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;blank&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> origin;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>我们会尝试从request-header中获取origin值。</p><h4 id="给网关添加请求头" tabindex="-1">.给网关添加请求头 <a class="header-anchor" href="#给网关添加请求头" aria-label="Permalink to &quot;.给网关添加请求头&quot;">​</a></h4><p>既然获取请求origin的方式是从reques-header中获取origin值，我们必须让<strong>所有从gateway路由到微服务的请求都带上origin头</strong>。</p><p>这个需要利用之前学习的一个GatewayFilter来实现，AddRequestHeaderGatewayFilter。</p><p>修改gateway服务中的application.yml，添加一个defaultFilter：</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">spring</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  cloud</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    gateway</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      default-filters</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">AddRequestHeader=origin,gateway</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      routes</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">       # ...略</span></span></code></pre></div><p>这样，从gateway路由的所有请求都会带上origin头，值为gateway。而从其它地方到达微服务的请求则没有这个头。</p><h4 id="配置授权规则" tabindex="-1">.配置授权规则 <a class="header-anchor" href="#配置授权规则" aria-label="Permalink to &quot;.配置授权规则&quot;">​</a></h4><p>接下来，我们添加一个授权规则，放行origin值为gateway的请求。</p><p><img src="/cswiki/assets/image-20210716153250134.5lXOkOYc.png" alt="image-20210716153250134" loading="lazy"></p><p>配置如下：</p><p><img src="/cswiki/assets/image-20210716153301069.lKPKq4Yt.png" alt="image-20210716153301069" loading="lazy"></p><p>现在，我们直接跳过网关，访问order-service服务：</p><p><img src="/cswiki/assets/image-20210716153348396.813LZSj_.png" alt="image-20210716153348396" loading="lazy"></p><p>通过网关访问：</p><p><img src="/cswiki/assets/image-20210716153434095.ySejYZP3.png" alt="image-20210716153434095" loading="lazy"></p><h3 id="自定义异常结果" tabindex="-1">自定义异常结果 <a class="header-anchor" href="#自定义异常结果" aria-label="Permalink to &quot;自定义异常结果&quot;">​</a></h3><p>默认情况下，发生限流、降级、授权拦截时，都会抛出异常到调用方。异常结果都是flow limmiting（限流）。这样不够友好，无法得知是限流还是降级还是授权拦截。</p><h4 id="异常类型" tabindex="-1">.异常类型 <a class="header-anchor" href="#异常类型" aria-label="Permalink to &quot;.异常类型&quot;">​</a></h4><p>而如果要自定义异常时的返回结果，需要实现BlockExceptionHandler接口：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> interface</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> BlockExceptionHandler</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    /**</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">     * 处理请求被限流、降级、授权拦截时抛出的异常：BlockException</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">     */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> handle</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(HttpServletRequest </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">request</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, HttpServletResponse </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">response</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, BlockException </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">e</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">throws</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Exception;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>这个方法有三个参数：</p><ul><li>HttpServletRequest request：request对象</li><li>HttpServletResponse response：response对象</li><li>BlockException e：被sentinel拦截时抛出的异常</li></ul><p>这里的BlockException包含多个不同的子类：</p><table><thead><tr><th><strong>异常</strong></th><th><strong>说明</strong></th></tr></thead><tbody><tr><td>FlowException</td><td>限流异常</td></tr><tr><td>ParamFlowException</td><td>热点参数限流的异常</td></tr><tr><td>DegradeException</td><td>降级异常</td></tr><tr><td>AuthorityException</td><td>授权规则异常</td></tr><tr><td>SystemBlockException</td><td>系统规则异常</td></tr></tbody></table><h4 id="自定义异常处理" tabindex="-1">.自定义异常处理 <a class="header-anchor" href="#自定义异常处理" aria-label="Permalink to &quot;.自定义异常处理&quot;">​</a></h4><p>下面，我们就在order-service定义一个自定义异常处理类：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">package</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> cn.itcast.order.sentinel;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.alibaba.csp.sentinel.adapter.spring.webmvc.callback.BlockExceptionHandler;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.alibaba.csp.sentinel.slots.block.BlockException;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.alibaba.csp.sentinel.slots.block.authority.AuthorityException;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.alibaba.csp.sentinel.slots.block.degrade.DegradeException;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.alibaba.csp.sentinel.slots.block.flow.FlowException;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.alibaba.csp.sentinel.slots.block.flow.param.ParamFlowException;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> org.springframework.stereotype.Component;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> javax.servlet.http.HttpServletRequest;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> javax.servlet.http.HttpServletResponse;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Component</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> SentinelExceptionHandler</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> implements</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> BlockExceptionHandler</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Override</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> handle</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(HttpServletRequest </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">request</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, HttpServletResponse </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">response</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, BlockException </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">e</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">throws</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Exception {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        String msg </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;未知异常&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> status </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 429</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (e </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">instanceof</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> FlowException) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            msg </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;请求被限流了&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">else</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (e </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">instanceof</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ParamFlowException) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            msg </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;请求被热点参数限流&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">else</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (e </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">instanceof</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> DegradeException) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            msg </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;请求被降级了&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">else</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (e </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">instanceof</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> AuthorityException) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            msg </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;没有权限访问&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            status </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 401</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        response.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setContentType</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;application/json;charset=utf-8&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        response.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setStatus</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(status);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        response.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getWriter</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">println</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;{</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">msg</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">: &quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> +</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> msg </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">status</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">: &quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> +</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> status </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;}&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>重启测试，在不同场景下，会返回不同的异常消息.</p><p>限流：</p><p><img src="/cswiki/assets/image-20210716153938887.4ujuQZlh.png" alt="image-20210716153938887" loading="lazy"></p><p>授权拦截时：</p><p><img src="/cswiki/assets/image-20210716154012736.PCvvI5iX.png" alt="image-20210716154012736" loading="lazy"></p><h2 id="规则持久化" tabindex="-1">规则持久化 <a class="header-anchor" href="#规则持久化" aria-label="Permalink to &quot;规则持久化&quot;">​</a></h2><p>现在，sentinel的所有规则都是内存存储，重启后所有规则都会丢失。在生产环境下，我们必须确保这些规则的持久化，避免丢失。</p><h3 id="规则管理模式" tabindex="-1">规则管理模式 <a class="header-anchor" href="#规则管理模式" aria-label="Permalink to &quot;规则管理模式&quot;">​</a></h3><p>规则是否能持久化，取决于规则管理模式，sentinel支持三种规则管理模式：</p><ul><li>原始模式：Sentinel的默认模式，将规则保存在内存，重启服务会丢失。</li><li>pull模式</li><li>push模式</li></ul><h4 id="pull模式" tabindex="-1">.pull模式 <a class="header-anchor" href="#pull模式" aria-label="Permalink to &quot;.pull模式&quot;">​</a></h4><p>pull模式：控制台将配置的规则推送到Sentinel客户端，而客户端会将配置规则保存在本地文件或数据库中。以后会定时去本地文件或数据库中查询，更新本地规则。</p><p><img src="/cswiki/assets/image-20210716154155238.Fq2Pk3Ix.png" alt="image-20210716154155238" loading="lazy"></p><h4 id="push模式" tabindex="-1">.push模式 <a class="header-anchor" href="#push模式" aria-label="Permalink to &quot;.push模式&quot;">​</a></h4><p>push模式：控制台将配置规则推送到远程配置中心，例如Nacos。Sentinel客户端监听Nacos，获取配置变更的推送消息，完成本地配置更新。</p><p><img src="/cswiki/assets/image-20210716154215456.yGc1zp5I.png" alt="image-20210716154215456" loading="lazy"></p><h3 id="实现push模式" tabindex="-1">实现push模式 <a class="header-anchor" href="#实现push模式" aria-label="Permalink to &quot;实现push模式&quot;">​</a></h3><p>详细步骤可以参考课前资料的《sentinel规则持久化》：</p><p><img src="/cswiki/assets/image-20210716154255466.jnn3LdMe.png" alt="image-20210716154255466" loading="lazy"></p></div></div></main><footer class="VPDocFooter" data-v-7b451c74 data-v-ffe8a71c><!--[--><!--]--><div class="edit-info" data-v-ffe8a71c><!----><div class="last-updated" data-v-ffe8a71c><p class="VPLastUpdated" data-v-ffe8a71c data-v-fc47d7a3>最后更新: <time datetime="2024-11-03T15:45:53.000Z" data-v-fc47d7a3></time></p></div></div><nav class="prev-next" data-v-ffe8a71c><div class="pager" data-v-ffe8a71c><a class="VPLink link pager-link prev" href="/cswiki/src/base/cloud/08%E9%AB%98%E7%BA%A7%E7%AF%87-%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1" data-v-ffe8a71c><!--[--><span class="desc" data-v-ffe8a71c>上一篇</span><span class="title" data-v-ffe8a71c>分布式事务</span><!--]--></a></div><div class="pager" data-v-ffe8a71c><a class="VPLink link pager-link next" href="/cswiki/src/base/cloud/09%E9%AB%98%E7%BA%A7%E7%AF%87-%E5%8F%AF%E9%9D%A0%E6%B6%88%E6%81%AF%E6%9C%8D%E5%8A%A1" data-v-ffe8a71c><!--[--><span class="desc" data-v-ffe8a71c>下一篇</span><span class="title" data-v-ffe8a71c>可靠消息服务</span><!--]--></a></div></nav></footer><!--[--><!--]--></div></div></div><!--[--><!--]--></div></div><!----><!--[--><!--]--></div></div>
    <script>window.__VP_HASH_MAP__=JSON.parse("{\"src_base_alg_index.md\":\"MyjqLDYd\",\"src_base_alg_01-数据结构与算法.md\":\"swVJqwCL\",\"index.md\":\"f0C03zif\",\"src_base_cloud_00操作篇-多级缓存案例.md\":\"8_JwsqcT\",\"src_base_cloud_00操作篇-安装docker.md\":\"ieGtpKRS\",\"src_base_cloud_00操作篇-安装nacos.md\":\"psz_g1rz\",\"src_base_cloud_00操作篇-安装mq.md\":\"q6UQ4zdp\",\"src_base_cloud_00操作篇-安装elk.md\":\"7LTyXvCf\",\"src_base_cloud_00操作篇-安装redis.md\":\"yEapRJPQ\",\"src_base_cloud_00操作篇-安装seata.md\":\"xITEHdL7\",\"src_base_cloud_02实用篇-容器管理.md\":\"Gg4_8yMU\",\"src_base_cloud_03实用篇-异步通信.md\":\"M6EGZRsI\",\"src_base_cloud_01实用篇-微服务治理.md\":\"wZNaW1Dr\",\"src_base_cloud_04实用篇-文档数据库.md\":\"F9NZz0Xh\",\"src_base_cloud_06实用篇-分布式缓存.md\":\"7hBkVwHm\",\"src_base_cloud_07高级篇-微服务保护.md\":\"vVZ1Sc_-\",\"src_base_cloud_08高级篇-分布式事务.md\":\"YmY-tyOZ\",\"src_base_cloud_09高级篇-可靠消息服务.md\":\"ezluIOj5\",\"src_base_cloud_index.md\":\"x6LZ6at3\",\"src_base_gof_01-设计模式入门.md\":\"Twc37v3L\",\"src_base_gof_02-uml类图.md\":\"sWH0206E\",\"src_base_cloud_10高级篇-多级缓存技术.md\":\"zpvNe4F3\",\"src_base_gof_03-六大原则.md\":\"7RTrJ7i-\",\"src_base_java_index.md\":\"RuqkmUqQ\",\"src_base_java_02-java集合.md\":\"0n9EXxZ6\",\"src_base_gof_04-创建者模式.md\":\"b1frCBy4\",\"src_base_cloud_05实用篇-分布式搜索.md\":\"Jgf5Dkdn\",\"src_base_juc_index.md\":\"PaLiUrD8\",\"src_base_gof_05-结构者模式.md\":\"9g8L9w-C\",\"src_base_juc_juc-apply-fork.md\":\"chWd-M1K\",\"src_base_java_01-java基础.md\":\"md-1gUI3\",\"src_base_juc_juc-apply-sync-async.md\":\"eFEJlU6M\",\"src_base_juc_juc-apply-plan.md\":\"t-mDvOux\",\"src_base_juc_juc-model-order.md\":\"MCOMPkKQ\",\"src_base_juc_juc-practice-batch.md\":\"N5w5aatx\",\"src_base_index.md\":\"CjSWuIry\",\"src_base_juc_juc-apply-cache.md\":\"JNrm_IxU\",\"src_base_juc_juc-model-product.md\":\"4BO5eSyG\",\"src_base_juc_juc-apply-exclusive.md\":\"bIP5b6BO\",\"src_base_juc_juc-model-termination.md\":\"f73FDwtU\",\"src_base_juc_juc-model-flyweight.md\":\"MeMO8A-2\",\"src_base_juc_juc-model-work-queue.md\":\"XkDclUp4\",\"src_base_juc_juc-apply-limit.md\":\"NCDUtiTQ\",\"src_base_juc_juc-model-balking.md\":\"S_STGEAT\",\"src_base_juc_juc-model-protect.md\":\"_3Xj9QMh\",\"src_base_juc_juc-share-final.md\":\"DRG4E_3x\",\"src_base_gof_index.md\":\"tdFYM8T2\",\"src_base_juc_juc-share-memory.md\":\"uF0YU9wr\",\"src_base_gof_07-设计模式实践.md\":\"3pM7Hysx\",\"src_base_cloud_11面试篇-微服务面试题.md\":\"6sbImYjw\",\"src_base_gof_06-行为者模式.md\":\"NjgRVFuv\",\"src_base_juc_juc-base.md\":\"sQLMluUy\",\"src_base_juc_juc-share-nosync.md\":\"IstEXNbk\",\"src_base_juc_juc-share-nolock.md\":\"XNhUgHzY\",\"src_base_juc_juc-theory-linked-blocking-queue.md\":\"R4XZm-5Q\",\"src_base_juc_juc-theory-semaphore.md\":\"FiAMhhzE\",\"src_base_juc_juc-theory-reentrant-read-write-lock.md\":\"tbvcX5gF\",\"src_base_juc_juc-theory-concurrent-map.md\":\"_SJqSKh9\",\"src_base_juc_juc-theory-reentrant-lock.md\":\"q33YKaIa\",\"src_base_juc_juc-tool-collections.md\":\"AZ-r1bi3\",\"src_base_juc_juc-theory-volatile.md\":\"X0JD0EVi\",\"src_base_juc_juc-theory-synchronized.md\":\"ortKAKD1\",\"src_base_juc_juc-tool-locks.md\":\"QqirRWne\",\"src_base_juc_juc-tool-tools.md\":\"mlDt0KWi\",\"src_base_jvm_index.md\":\"pG-O5aN6\",\"src_base_jvm_jvm-base.md\":\"P2eALBsa\",\"src_base_jvm_jvm-senior-graal-vm.md\":\"DAXKHlHc\",\"src_base_jvm_jvm-base-bytecode.md\":\"Eduzz1IX\",\"src_base_jvm_jvm-base-gc.md\":\"yHGH2n2l\",\"src_base_jvm_jvm-base-runtime.md\":\"SJFPW7gj\",\"src_base_juc_juc-tools-atomic.md\":\"PtnZWSZA\",\"src_base_jvm_jvm-senior-new-gc.md\":\"dpq5rMqs\",\"src_base_jvm_jvm-senior-java-agent.md\":\"DJX5UP0-\",\"src_base_jvm_jvm-tuning-gc.md\":\"4pZlx7pb\",\"src_base_jvm_jvm-tuning-function.md\":\"PcqhGm4c\",\"src_base_jvm_jvm-summarize.md\":\"lXUmnuJu\",\"src_base_juc_juc-tools-pool.md\":\"C8EmaMBl\",\"src_base_jvm_jvm-theory.md\":\"x8DndpNx\",\"src_base_juc_juc-share-monitor.md\":\"swk3kHpR\",\"src_base_mysql_01-mysql基础.md\":\"pSdd5XcZ\",\"src_base_linux_01-初始linux.md\":\"StuIZGWa\",\"src_base_mysql_02-mysql进阶-sql优化.md\":\"20xgs4Kx\",\"src_base_mysql_02-mysql进阶-innodb引擎.md\":\"30d9HhSj\",\"src_base_linux_index.md\":\"Ua07q16P\",\"src_base_mysql_02-mysql进阶-事务.md\":\"l0NBH66L\",\"src_base_mysql_02-mysql进阶-索引.md\":\"REsen0SR\",\"src_base_mysql_02-mysql进阶-锁.md\":\"PMNnnXzf\",\"src_base_mysql_02-mysql进阶-数据库架构.md\":\"YLupdM1c\",\"src_base_jvm_jvm-tuning-memory.md\":\"YHGnaTrS\",\"src_base_mysql_03-mysql运维-分库分表.md\":\"ZPVC0_Nv\",\"src_base_mysql_03-mysql运维-日志文件.md\":\"EVJyUbT0\",\"src_base_mysql_03-mysql运维-主从复制.md\":\"0NeuLHW7\",\"src_base_mysql_03-mysql运维-管理工具.md\":\"xRHTtOaI\",\"src_base_mysql_03-mysql运维-性能优化.md\":\"pfkINVF5\",\"src_base_mysql_04-mysql实践-sql练习.md\":\"nR54OvyS\",\"src_base_mysql_04-mysql实践-sql记录.md\":\"zDd4TSxB\",\"src_base_mysql_03-mysql运维-读写分离.md\":\"1F8rT23t\",\"src_base_netty_index.md\":\"LXYE7ddD\",\"src_base_mysql_index.md\":\"gBKktBqs\",\"src_base_mysql_02-mysql进阶.md\":\"T5tdgmYR\",\"src_base_netty_netty-base.md\":\"D6_0Bxi7\",\"src_base_netty_netty-code.md\":\"Grh9C4dp\",\"src_base_spring_spring-aop.md\":\"egWS7_n6\",\"src_base_spring_index.md\":\"EM8AQAEi\",\"src_base_netty_netty-senior.md\":\"uOf6JuG2\",\"src_base_spring_spring-boot.md\":\"lwm3hvPj\",\"src_base_spring_spring-other.md\":\"OtlMdl2o\",\"src_base_spring_spring-mvc.md\":\"5rWSZLcQ\",\"src_base_summarize_java-base.md\":\"N6OvBOHs\",\"src_base_summarize_interview.md\":\"uYScr83e\",\"src_base_summarize_index.md\":\"W6h6egw0\",\"src_base_summarize_gof.md\":\"xAWvlZXo\",\"src_base_spring_spring-bean.md\":\"_YU0p9zf\",\"src_base_netty_non-blocking-io.md\":\"DFxvqtOp\",\"src_base_summarize_java-collection.md\":\"TPwn8ugY\",\"src_base_summarize_java-netty.md\":\"x2pFfzzl\",\"src_base_summarize_java-concurrent.md\":\"O6EMT7LI\",\"src_base_summarize_message-queue.md\":\"Ell0PlTC\",\"src_base_summarize_java-virtual.md\":\"hz7oczTc\",\"src_base_summarize_project-practice.md\":\"30CvZcCs\",\"src_base_summarize_mysql.md\":\"DMXSPE9L\",\"src_base_summarize_spring-cloud.md\":\"O0nrcLKs\",\"src_project_college_00-内网穿透.md\":\"5epNi5lB\",\"src_base_summarize_redis.md\":\"p4RA2Evg\",\"src_base_summarize_spring.md\":\"p2oG9Onm\",\"src_project_college_00-自定义部署.md\":\"0qnGyG9p\",\"src_project_college_00-虚拟机导入.md\":\"BtH_ekVp\",\"src_project_college_01-初识项目.md\":\"N-RietTZ\",\"src_project_college_02-我的课表.md\":\"afiNyrhG\",\"src_project_college_04-学习记录.md\":\"-_Tk7_j3\",\"src_project_college_05-问答系统.md\":\"6sGCsZA2\",\"src_project_college_03-学习计划.md\":\"4Z-MQRjM\",\"src_project_college_06-点赞系统.md\":\"q1yTK1XB\",\"src_project_college_07-积分系统.md\":\"QODLJGwf\",\"src_project_college_08-排行榜功能.md\":\"w4I0TgA_\",\"src_project_college_10-领取优惠券.md\":\"yV-JqecF\",\"src_project_college_13-项目部署.md\":\"xn_xcUER\",\"src_project_college_index.md\":\"L3og0vVF\",\"src_project_college_14-项目实战.md\":\"4YLTJHkc\",\"src_project_college_11-优惠券优化.md\":\"HRTnYaCG\",\"src_project_college_09-优惠券管理.md\":\"U9eTVbeF\",\"src_project_express_00-常见问题.md\":\"CUeyIsM4\",\"src_project_express_00-基础服务.md\":\"376SObFF\",\"src_project_express_00-基础工具.md\":\"a8pWbL0u\",\"src_project_college_12-优惠券使用.md\":\"Y4bejsfW\",\"src_project_express_01-初识项目.md\":\"GbRCqzxN\",\"src_project_express_03-运费服务.md\":\"QyKspbxC\",\"src_project_express_10-持续集成.md\":\"qHyIEOH-\",\"src_project_express_06-运输任务.md\":\"LwysKUvo\",\"src_project_express_09-物流服务.md\":\"qs-XdeKm\",\"src_project_express_index.md\":\"GDw4KM25\",\"src_project_express_12-项目实战.md\":\"fA_7fIIF\",\"src_project_express_05-调度服务.md\":\"nnBYTdYo\",\"src_project_express_08-派件调度.md\":\"z8faVzxd\",\"src_project_health_index.md\":\"MOoLLfU7\",\"src_project_financial_index.md\":\"_dipptdR\",\"src_project_express_02-支付服务.md\":\"rPszblZo\",\"src_project_index.md\":\"-uzkkdVO\",\"src_project_redis_02-redis实战-黑马点评.md\":\"8LxFzK1e\",\"src_project_express_11-项目运维.md\":\"p0kc39qy\",\"src_project_express_07-作业范围.md\":\"OoM_JyMv\",\"src_project_express_04-路线服务.md\":\"TLkJQBID\",\"src_project_redis_01-redis基础.md\":\"WBJYPgIp\",\"src_project_redis_03-redis实战-短信登录.md\":\"bEoJ6kN_\",\"src_project_redis_10-redis实战-uv统计.md\":\"GavO2Vq4\",\"src_project_redis_07-redis实战-好友关注.md\":\"j-rgE_B_\",\"src_project_redis_09-redis实战-用户签到.md\":\"6BYgiJ-G\",\"src_project_redis_08-redis实战-附近商户.md\":\"jvOX54uo\",\"src_project_redis_06-redis实战-达人探店.md\":\"ofOd3WsL\",\"src_project_redis_04-redis实战-商户查询.md\":\"pZWuWyzt\",\"src_project_redis_index.md\":\"wSkhV2NJ\",\"src_project_shop_index.md\":\"kVFuNBWp\",\"src_project_redis_14-redis原理-内存策略.md\":\"brnCtCg0\",\"src_project_rent_index.md\":\"Iybh37Ms\",\"src_project_social_index.md\":\"_llU1edg\",\"src_project_takeout_index.md\":\"kGycznV8\",\"src_project_redis_11-redis实践.md\":\"fKvuEAZv\",\"src_project_redis_13-redis原理-网络模型.md\":\"j5UYhDcX\",\"src_project_redis_12-redis原理-数据结构.md\":\"hN1W-Abs\",\"src_project_topnews_00-虚拟机导入.md\":\"BYKu4wH1\",\"src_project_topnews_00-自定义部署.md\":\"t__659DY\",\"src_project_redis_05-redis实战-优惠券秒杀.md\":\"JZ34CXjc\",\"src_project_topnews_01-初识项目.md\":\"HwhS9NNx\",\"src_project_topnews_00-自定义服务.md\":\"cakq0AAd\",\"src_project_topnews_03-文章发布.md\":\"b7gsko2z\",\"src_project_topnews_02-文章查看.md\":\"Lfi0FXnC\",\"src_project_topnews_04-文章审核.md\":\"9ehA9QUe\",\"src_project_topnews_06-文章上架.md\":\"_rXw-Qjr\",\"src_project_topnews_05-延迟发布.md\":\"sVaq0_ZS\",\"src_project_topnews_07-文章搜索.md\":\"M9jsEy7e\",\"src_project_topnews_08-平台管理.md\":\"kCaSxZN0\",\"src_project_topnews_09-用户行为.md\":\"o98DyDMW\",\"src_project_topnews_12-多级缓存.md\":\"OEkgLTv_\",\"src_project_topnews_10-定时计算.md\":\"Xev9SMdC\",\"src_project_topnews_11-实时计算.md\":\"JpQNVF9K\",\"src_project_topnews_13-持续集成.md\":\"McstQZye\",\"src_study_english_01-英语学习.md\":\"26mQ_RqO\",\"src_project_topnews_index.md\":\"DjOImstG\",\"src_study_book_01-图书学习.md\":\"8q-i_wqh\",\"src_study_index.md\":\"3lPmpv7w\",\"src_study_method_04-提升专注力.md\":\"la1bup_b\",\"src_study_method_03-结构思维.md\":\"MIYiCZwc\",\"src_study_method_02-养成好习惯.md\":\"kMBM7_Fu\",\"src_study_movie_01-电影影片.md\":\"YJ6rn4p5\",\"src_study_method_01-高效搜索.md\":\"FtdLWAQk\",\"src_study_method_05-面试技巧.md\":\"Qer4h2XN\",\"src_project_topnews_14-项目实战.md\":\"n0RxpO08\"}");window.__VP_SITE_DATA__=JSON.parse("{\"lang\":\"zh-CN\",\"dir\":\"ltr\",\"title\":\"知识小册子\",\"description\":\"搭建个人的知识体系,一个好的知识体系和学习方法会让自己事半功倍\",\"base\":\"/cswiki/\",\"head\":[],\"router\":{\"prefetchLinks\":true},\"appearance\":true,\"themeConfig\":{\"nav\":[{\"text\":\"📌 技术博客\",\"link\":\"/\"},{\"text\":\"📝 基础知识\",\"items\":[{\"items\":[{\"text\":\"☕️ Java基础\",\"link\":\"/src/base/java/index\"},{\"text\":\"🖥 JVM入门\",\"link\":\"/src/base/jvm/index\"},{\"text\":\"🔥 并发编程\",\"link\":\"/src/base/juc/index\"},{\"text\":\"🌐 网络编程\",\"link\":\"/src/base/netty/index\"}]},{\"items\":[{\"text\":\"🧩 数据结构\",\"link\":\"/src/base/alg/index\"},{\"text\":\"📝 设计模式\",\"link\":\"/src/base/gof/index\"}]},{\"items\":[{\"text\":\"📊 数据库\",\"link\":\"/src/base/mysql/index\"},{\"text\":\"👨‍💻 服务器\",\"link\":\"/src/base/linux/index\"},{\"text\":\"🌱 Spring\",\"link\":\"/src/base/spring/index\"},{\"text\":\"☁️ 微服务\",\"link\":\"/src/base/cloud/index\"}]}]},{\"text\":\"🛠️ 项目实战\",\"items\":[{\"items\":[{\"text\":\"🔖️ 黑马点评\",\"link\":\"/src/project/redis/index\"},{\"text\":\"📰 黑马头条\",\"link\":\"/src/project/topnews/index\"}]},{\"items\":[{\"text\":\"📚 天机学堂\",\"link\":\"/src/project/college/index\"},{\"text\":\"🚚 神领物流\",\"link\":\"/src/project/express/index\"},{\"text\":\"🛒 谷粒商城\",\"link\":\"/src/project/shop/index\"}]},{\"items\":[{\"text\":\"🍜 谷粒外卖\",\"link\":\"/src/project/takeout/index\"},{\"text\":\"🏄 谷粒健康\",\"link\":\"/src/project/health/index\"},{\"text\":\"🧑‍🤝‍🧑 谷粒交友\",\"link\":\"/src/project/social/index\"},{\"text\":\"🏠 谷粒租房\",\"link\":\"/src/project/rent/index\"},{\"text\":\"📈 谷粒金融\",\"link\":\"/src/project/financial/index\"}]}],\"activeMatch\":\"/src/project\"},{\"text\":\"💼 面试宝典\",\"link\":\"/src/base/summarize/index\",\"activeMatch\":\"/src/base/summarize\"}],\"sidebar\":{\"/src/study\":[{\"text\":\"学习方法\",\"link\":\"\",\"items\":[{\"text\":\"高效搜索\",\"link\":\"/src/study/method/01-高效搜索\"},{\"text\":\"养成好习惯\",\"link\":\"/src/study/method/02-养成好习惯\"},{\"text\":\"结构思维\",\"link\":\"/src/study/method/03-结构思维\"},{\"text\":\"提升专注力\",\"link\":\"/src/study/method/04-提升专注力\"}]}],\"/src/base/java\":[{\"text\":\"Java基础\",\"base\":\"/src/base/java/\",\"link\":\"01-Java基础\"},{\"text\":\"Java集合\",\"base\":\"/src/base/java/\",\"link\":\"02-Java集合\"}],\"/src/base/jvm\":[{\"text\":\"JVM\",\"base\":\"/src/base/jvm/\",\"collapsed\":false,\"items\":[{\"text\":\"虚拟机基础\",\"items\":[{\"text\":\"JVM入门\",\"link\":\"jvm-base\"},{\"text\":\"字节码与类的加载\",\"link\":\"jvm-base-bytecode\"},{\"text\":\"运行时数据区\",\"link\":\"jvm-base-runtime\"},{\"text\":\"垃圾回收\",\"link\":\"jvm-base-gc\"}]},{\"text\":\"虚拟机实战\",\"items\":[{\"text\":\"内存调优\",\"link\":\"jvm-tuning-memory\"},{\"text\":\"GC调优\",\"link\":\"jvm-tuning-gc\"},{\"text\":\"性能调优\",\"link\":\"jvm-tuning-function\"}]},{\"text\":\"虚拟机高级\",\"items\":[{\"text\":\"GraalVM\",\"link\":\"jvm-senior-graal-vm\"},{\"text\":\"新一代GC\",\"link\":\"jvm-senior-new-gc\"},{\"text\":\"Java工具\",\"link\":\"jvm-senior-java-agent\"}]},{\"text\":\"虚拟机原理\",\"link\":\"jvm-theory\",\"items\":[]},{\"text\":\"虚拟机总结\",\"link\":\"jvm-summarize\"}]}],\"/src/base/juc\":[{\"text\":\"并发编程\",\"base\":\"/src/base/juc/\",\"collapsed\":false,\"items\":[{\"text\":\"并发编程基础\",\"link\":\"juc-base\"},{\"text\":\"并发编程理论\",\"base\":\"/src/base/juc/juc-share-\",\"items\":[{\"text\":\"共享模型之管程\",\"link\":\"monitor\"},{\"text\":\"共享模型之内存\",\"link\":\"memory\"},{\"text\":\"共享模型之无锁\",\"link\":\"nolock\"},{\"text\":\"共享模型之不可变\",\"link\":\"final\"},{\"text\":\"共享模型之无同步方案\",\"link\":\"nosync\"}]},{\"text\":\"并发编程工具\",\"base\":\"/src/base/juc/juc-tool-\",\"items\":[{\"text\":\"线程池\",\"link\":\"pool\"},{\"text\":\"Locks\",\"link\":\"locks\"},{\"text\":\"Tools\",\"link\":\"tools\"},{\"text\":\"Atomic\",\"link\":\"atomic\"},{\"text\":\"Collections\",\"link\":\"collections\"}]},{\"text\":\"并发编程应用\",\"base\":\"/src/base/juc/juc-apply-\",\"items\":[{\"text\":\"同步和异步\",\"link\":\"sync-async\"},{\"text\":\"限制\",\"link\":\"limit\"},{\"text\":\"互斥\",\"link\":\"exclusive\"},{\"text\":\"缓存\",\"link\":\"cache\"},{\"text\":\"分治\",\"link\":\"fork\"},{\"text\":\"统筹\",\"link\":\"plan\"}]},{\"text\":\"并发编程模式\",\"base\":\"/src/base/juc/juc-model\",\"items\":[{\"text\":\"同步模式之保护者暂停\",\"link\":\"protect\"},{\"text\":\"同步模式之顺序控制\",\"link\":\"order\"},{\"text\":\"同步模式之Balking\",\"link\":\"balking\"},{\"text\":\"异步模式之生产者消费者\",\"link\":\"product\"},{\"text\":\"异步模式之工作线程\",\"link\":\"work-queue\"},{\"text\":\"终止模式之两阶段终止\",\"link\":\"termination\"},{\"text\":\"共享模式之享元\",\"link\":\"flyweight\"}]},{\"text\":\"* 并发编程原理\",\"base\":\"/src/base/juc/juc-theory-\",\"items\":[{\"text\":\"synchronized原理\",\"link\":\"synchronized\"},{\"text\":\"volatile原理\",\"link\":\"volatile\"},{\"text\":\"ReentrantLock原理\",\"link\":\"reentrant-lock\"},{\"text\":\"读写锁原理\",\"link\":\"reentrant-read-write-lock\"},{\"text\":\"Semaphore原理\",\"link\":\"semaphore\"},{\"text\":\"ConcurrentMap原理\",\"link\":\"concurrent-map\"},{\"text\":\"LinkedBlockingQueue原理\",\"link\":\"linked-blocking-queue\"}]},{\"text\":\"并发编程场景\",\"base\":\"/src/base/juc/juc-practice\",\"items\":[{\"text\":\"批量数据导入\",\"link\":\"batch\"}]}]}],\"/src/base/netty\":[{\"text\":\"网络编程\",\"collapsed\":false,\"base\":\"/src/base/netty/\",\"items\":[{\"text\":\"Java NIO\",\"link\":\"non-blocking-io\"},{\"text\":\"Netty\",\"items\":[{\"text\":\"Netty 基础\",\"link\":\"netty-base\"},{\"text\":\"Netty 高级\",\"link\":\"netty-senior\"},{\"text\":\"*Netty 源码\",\"link\":\"netty-code\"}]},{\"text\":\"Nginx\"}]}],\"/src/base/mysql\":[{\"text\":\"数据库\",\"base\":\"/src/base/mysql/\",\"items\":[{\"text\":\"MySQL基础\",\"link\":\"01-MySQL基础\"},{\"text\":\"MySQL进阶\",\"base\":\"/src/base/mysql/02-\",\"link\":\"MySQL进阶\",\"items\":[{\"text\":\"数据库架构\",\"link\":\"MySQL进阶-数据库架构\"},{\"text\":\"索引\",\"link\":\"MySQL进阶-索引\"},{\"text\":\"SQL优化\",\"link\":\"MySQL进阶-SQL优化\"},{\"text\":\"锁\",\"link\":\"MySQL进阶-锁\"},{\"text\":\"InnoDB引擎\",\"link\":\"MySQL进阶-InnoDB引擎\"}]},{\"text\":\"MySQL运维\",\"base\":\"/src/base/mysql/03-MySQL运维-\",\"items\":[{\"text\":\"管理工具\",\"link\":\"管理工具\"},{\"text\":\"日志文件\",\"link\":\"日志文件\"},{\"text\":\"主从复制\",\"link\":\"主从复制\"},{\"text\":\"分库分表\",\"link\":\"分库分表\"},{\"text\":\"读写分离\",\"link\":\"读写分离\"}]},{\"text\":\"MySQL实践\",\"base\":\"/src/base/mysql/04-MySQL实践-\",\"items\":[{\"text\":\"SQL记录\",\"link\":\"SQL记录\"},{\"text\":\"SQL练习\",\"link\":\"SQL练习\"}]}]}],\"/src/base/gof\":[{\"text\":\"设计模式\",\"collapsed\":false,\"base\":\"/src/base/gof/\",\"items\":[{\"text\":\"设计模式入门\",\"link\":\"01-设计模式入门\"},{\"text\":\"UML类图\",\"link\":\"02-UML类图\"},{\"text\":\"六大原则\",\"link\":\"03-六大原则\"},{\"text\":\"创建者模式\",\"link\":\"04-创建者模式\"},{\"text\":\"结构者模式\",\"link\":\"05-结构者模式\"},{\"text\":\"行为者模式\",\"link\":\"06-行为者模式\"},{\"text\":\"设计模式实践\",\"link\":\"07-设计模式实践\"}]}],\"/src/base/spring\":[{\"text\":\"Spring原理篇\",\"collapsed\":false,\"base\":\"/src/base/spring/\",\"items\":[{\"text\":\"Spring-Bean\",\"link\":\"01-Spring-Bean\"},{\"text\":\"Spring-AOP\",\"link\":\"02-Spring-AOP\"},{\"text\":\"Spring-Boot\",\"link\":\"03-Spring-Boot\"},{\"text\":\"Spring-MVC\",\"link\":\"04-Spring-MVC\"},{\"text\":\"Spring-Other\",\"link\":\"05-Spring-Other\"}]},{\"text\":\"Spring集成篇\",\"collapsed\":false}],\"/src/base/cloud\":[{\"text\":\"Cloud 实用篇\",\"base\":\"/src/base/cloud/\",\"collapsed\":false,\"items\":[{\"text\":\"微服务治理\",\"link\":\"01实用篇-微服务治理\"},{\"text\":\"容器管理\",\"link\":\"02实用篇-容器管理\"},{\"text\":\"异步通信\",\"link\":\"03实用篇-异步通信\"},{\"text\":\"文档数据库\",\"link\":\"04实用篇-文档数据库\"},{\"text\":\"分布式缓存\",\"link\":\"06实用篇-分布式缓存\"}]},{\"text\":\"Cloud 高级篇\",\"base\":\"/src/base/cloud/\",\"collapsed\":false,\"items\":[{\"text\":\"分布式搜索\",\"link\":\"05实用篇-分布式搜索\"},{\"text\":\"分布式事务\",\"link\":\"08高级篇-分布式事务\"},{\"text\":\"微服务保护\",\"link\":\"07高级篇-微服务保护\"},{\"text\":\"可靠消息服务\",\"link\":\"09高级篇-可靠消息服务\"},{\"text\":\"多级缓存技术\",\"link\":\"10高级篇-多级缓存技术\"},{\"text\":\"微服务面试题\",\"link\":\"11面试篇-微服务面试题\"}]},{\"text\":\"Cloud 操作篇\",\"base\":\"/src/base/cloud¡/00操作篇-\",\"collapsed\":false,\"items\":[{\"text\":\"安装Nacos\",\"link\":\"安装Nacos\"},{\"text\":\"安装Seata\",\"link\":\"安装Seata\"},{\"text\":\"安装Docker\",\"link\":\"安装Docker\"},{\"text\":\"安装Redis\",\"link\":\"安装Redis\"},{\"text\":\"安装MQ\",\"link\":\"安装MQ\"},{\"text\":\"安装ELK\",\"link\":\"安装ELK\"},{\"text\":\"多级缓存案例\",\"link\":\"多级缓存案例\"}]}],\"/src/project/redis\":[{\"text\":\"黑马点评\",\"collapsed\":false,\"base\":\"/src/project/redis/\",\"items\":[{\"text\":\"Redis基础\",\"link\":\"01-Redis基础\"},{\"text\":\"Redis实战\",\"base\":\"/src/project/redis/\",\"items\":[{\"text\":\"黑马点评\",\"link\":\"02-Redis实战-黑马点评\"},{\"text\":\"短信登录\",\"link\":\"03-Redis实战-短信登录\"},{\"text\":\"商户查询\",\"link\":\"04-Redis实战-商户查询\"},{\"text\":\"* 优惠券秒杀\",\"link\":\"05-Redis实战-优惠券秒杀\"},{\"text\":\"达人探店\",\"link\":\"06-Redis实战-达人探店\"},{\"text\":\"好友关注\",\"link\":\"07-Redis实战-好友关注\"},{\"text\":\"附近商户\",\"link\":\"08-Redis实战-附近商户\"},{\"text\":\"用户签到\",\"link\":\"09-Redis实战-用户签到\"},{\"text\":\"UV统计\",\"link\":\"10-Redis实战-UV统计\"}]},{\"text\":\"* Redis实践\",\"link\":\"11-Redis实践\"},{\"text\":\"* Redis原理\",\"base\":\"/src/project/redis/\",\"items\":[{\"text\":\"数据结构\",\"link\":\"12-Redis原理-数据结构\"},{\"text\":\"网络模型\",\"link\":\"13-Redis原理-网络模型\"},{\"text\":\"内存策略\",\"link\":\"14-Redis原理-内存策略\"}]}]}],\"/src/project/topnews\":[{\"text\":\"黑马点评\",\"collapsed\":false,\"base\":\"/src/project/topnews/\",\"items\":[{\"text\":\"Day01-初识项目\",\"link\":\"01-初识项目\",\"items\":[{\"text\":\"虚拟机导入\",\"link\":\"00-虚拟机导入\"},{\"text\":\"自定义部署\",\"link\":\"00-自定义部署\"},{\"text\":\"自定义服务\",\"link\":\"00-自定义服务\"}]},{\"text\":\"Day02-文章查看\",\"link\":\"02-文章查看\"},{\"text\":\"Day03-文章发布\",\"link\":\"03-文章发布\"},{\"text\":\"Day04-文章审核\",\"link\":\"04-文章审核\"},{\"text\":\"Day05-延迟发布\",\"link\":\"05-延迟发布\"},{\"text\":\"Day06-文章上架\",\"link\":\"06-文章上架\"},{\"text\":\"Day07-文章搜索\",\"link\":\"07-文章搜索\"},{\"text\":\"Day08-平台管理\",\"link\":\"08-平台管理\"},{\"text\":\"Day09-用户行为\",\"link\":\"09-用户行为\"},{\"text\":\"Day10-定时计算\",\"link\":\"10-定时计算\"},{\"text\":\"Day11-实时计算\",\"link\":\"11-实时计算\"},{\"text\":\"Day12-多级缓存\",\"link\":\"12-多级缓存\"},{\"text\":\"Day13-持续集成\",\"link\":\"13-持续集成\"},{\"text\":\"Day14-项目实战\",\"link\":\"14-项目实战\"}]}],\"/src/project/college\":[{\"text\":\"天机学堂\",\"collapsed\":false,\"base\":\"/src/project/college/\",\"items\":[{\"text\":\"01-初识项目\",\"link\":\"01-初识项目\",\"items\":[{\"text\":\"虚拟机导入\",\"link\":\"00-虚拟机导入\"},{\"text\":\"自定义部署\",\"link\":\"00-自定义部署\"},{\"text\":\"内网穿透\",\"link\":\"00-内网穿透\"}]},{\"text\":\"02-我的课表\",\"link\":\"02-我的课表\"},{\"text\":\"03-学习计划\",\"link\":\"03-学习计划\"},{\"text\":\"04-学习记录\",\"link\":\"04-学习记录\"},{\"text\":\"05-问答系统\",\"link\":\"05-问答系统\"},{\"text\":\"06-点赞系统\",\"link\":\"06-点赞系统\"},{\"text\":\"07-积分系统\",\"link\":\"07-积分系统\"},{\"text\":\"08-排行榜功能\",\"link\":\"08-排行榜功能\"},{\"text\":\"09-优惠券管理\",\"link\":\"09-优惠券管理\"},{\"text\":\"10-领取优惠券\",\"link\":\"10-领取优惠券\"},{\"text\":\"11-优惠券优化\",\"link\":\"11-优惠券优化\"},{\"text\":\"12-优惠券使用\",\"link\":\"12-优惠券使用\"},{\"text\":\"13-项目部署\",\"link\":\"13-项目部署\"},{\"text\":\"14-项目实战\",\"link\":\"13-项目实战\"}]}],\"/src/project/express\":[{\"text\":\"神领物流\",\"collapsed\":false,\"base\":\"/src/project/express/\",\"items\":[{\"text\":\"01-初识项目\",\"link\":\"01-初识项目\",\"items\":[{\"text\":\"基础服务\",\"link\":\"00-基础服务\"},{\"text\":\"基础工具\",\"link\":\"00-基础工具\"},{\"text\":\"常见问题\",\"link\":\"00-常见问题\"}]},{\"text\":\"02-支付服务\",\"link\":\"02-支付服务\"},{\"text\":\"03-运费服务\",\"link\":\"03-运费服务\"},{\"text\":\"04-路线服务\",\"link\":\"04-路线服务\"},{\"text\":\"05-调度服务\",\"link\":\"05-调度服务\"},{\"text\":\"06-运输任务\",\"link\":\"06-运输任务\"},{\"text\":\"07-作业范围\",\"link\":\"07-作业范围\"},{\"text\":\"08-派件调度\",\"link\":\"08-派件调度\"},{\"text\":\"09-物流服务\",\"link\":\"09-物流服务\"},{\"text\":\"10-持续集成\",\"link\":\"10-持续集成\"},{\"text\":\"11-项目运维\",\"link\":\"11-项目运维\"},{\"text\":\"12-项目实战\",\"link\":\"12-项目实战\"}]}],\"/src/base/summarize\":[{\"text\":\"基础知识\",\"collapsed\":false,\"base\":\"/src/base/summarize/\",\"items\":[{\"text\":\"Java基础\",\"link\":\"java-base\"},{\"text\":\"Java集合\",\"link\":\"java-collection\"},{\"text\":\"Java虚拟机\",\"link\":\"java-virtual\"},{\"text\":\"并发编程篇\",\"link\":\"java-concurrent\"},{\"text\":\"网络编程篇\",\"link\":\"java-netty\"}]},{\"text\":\"服务框架\",\"collapsed\":false,\"base\":\"/src/base/summarize/\",\"items\":[{\"text\":\"数据库篇\",\"link\":\"mysql\"},{\"text\":\"缓存篇\",\"link\":\"redis\"},{\"text\":\"框架篇\",\"link\":\"spring\"},{\"text\":\"微服务篇\",\"link\":\"spring-cloud\"},{\"text\":\"中间件篇\",\"link\":\"message-queue\"}]},{\"text\":\"场景技术\",\"collapsed\":false,\"base\":\"/src/base/summarize/\",\"items\":[{\"text\":\"设计模式篇\",\"link\":\"gof\"},{\"text\":\"场景技术篇\",\"link\":\"project-practice\"},{\"text\":\"知识点汇总\",\"link\":\"index\"},{\"text\":\"面试准备篇\",\"link\":\"interview\"}]}]},\"logo\":\"/logo.svg\",\"outline\":{\"level\":\"deep\",\"label\":\"章节导航\"},\"darkModeSwitchLabel\":\"切换日光/暗黑模式\",\"sidebarMenuLabel\":\"文章\",\"returnToTopLabel\":\"返回顶部\",\"lastUpdatedText\":\"最后更新\",\"docFooter\":{\"prev\":\"上一篇\",\"next\":\"下一篇\"},\"search\":{\"provider\":\"local\",\"options\":{\"locales\":{\"root\":{\"translations\":{\"button\":{\"buttonText\":\"搜索文档\",\"buttonAriaLabel\":\"搜索文档\"},\"modal\":{\"noResultsText\":\"无法找到相关结果\",\"resetButtonTitle\":\"清除查询条件\",\"footer\":{\"selectText\":\"选择\",\"navigateText\":\"切换\"}}}}}}},\"socialLinks\":[{\"icon\":\"github\",\"link\":\"https://github.com/Charles7c/charles7c.github.io\"},{\"icon\":{\"svg\":\"<svg role=\\\"img\\\" viewBox=\\\"0 0 24 24\\\" xmlns=\\\"http://www.w3.org/2000/svg\\\"><title>码云</title><path d=\\\"M11.984 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.016 0zm6.09 5.333c.328 0 .593.266.592.593v1.482a.594.594 0 0 1-.593.592H9.777c-.982 0-1.778.796-1.778 1.778v5.63c0 .327.266.592.593.592h5.63c.982 0 1.778-.796 1.778-1.778v-.296a.593.593 0 0 0-.592-.593h-4.15a.592.592 0 0 1-.592-.592v-1.482a.593.593 0 0 1 .593-.592h6.815c.327 0 .593.265.593.592v3.408a4 4 0 0 1-4 4H5.926a.593.593 0 0 1-.593-.593V9.778a4.444 4.444 0 0 1 4.445-4.444h8.296Z\\\"/></svg>\"},\"link\":\"https://gitee.com/Charles7c/charles7c\"}],\"commentConfig\":{\"type\":\"gitalk\",\"showComment\":false},\"footerConfig\":{\"showFooter\":true,\"message\":\"Released under the MIT License.\",\"copyright\":\"Copyright © 2019-2024 Cookie Mousse\"}},\"locales\":{},\"scrollOffset\":134,\"cleanUrls\":true}");</script>
    
  </body>
</html>
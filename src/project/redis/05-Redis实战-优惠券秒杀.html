<!DOCTYPE html>
<html lang="zh-CN" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>çŸ¥è¯†å°å†Œå­</title>
    <meta name="description" content="æ­å»ºä¸ªäººçš„çŸ¥è¯†ä½“ç³»,ä¸€ä¸ªå¥½çš„çŸ¥è¯†ä½“ç³»å’Œå­¦ä¹ æ–¹æ³•ä¼šè®©è‡ªå·±äº‹åŠåŠŸå€">
    <meta name="generator" content="VitePress v1.0.0-rc.40">
    <link rel="preload stylesheet" href="/cswiki/assets/style.1gwXlvdp.css" as="style">
    
    <script type="module" src="/cswiki/assets/app.uqj3VK2n.js"></script>
    <link rel="preload" href="/cswiki/assets/inter-roman-latin.bvIUbFQP.woff2" as="font" type="font/woff2" crossorigin="">
    <link rel="modulepreload" href="/cswiki/assets/chunks/framework.syB9hai_.js">
    <link rel="modulepreload" href="/cswiki/assets/chunks/theme.tajzFOQp.js">
    <link rel="modulepreload" href="/cswiki/assets/chunks/c4Diagram-0115bee6.G6Ek8_u-.js">
    <link rel="modulepreload" href="/cswiki/assets/chunks/flowDiagram-786cd8ff.Ts0ROTf7.js">
    <link rel="modulepreload" href="/cswiki/assets/chunks/flowDiagram-v2-65161881.Z4amkIH3.js">
    <link rel="modulepreload" href="/cswiki/assets/chunks/erDiagram-de1b0455.yuzMSa84.js">
    <link rel="modulepreload" href="/cswiki/assets/chunks/gitGraphDiagram-5269e1d6.DfmCxOTM.js">
    <link rel="modulepreload" href="/cswiki/assets/chunks/ganttDiagram-f2041c70.sdnu_nPl.js">
    <link rel="modulepreload" href="/cswiki/assets/chunks/infoDiagram-3fa6ea12.GvlQCFcf.js">
    <link rel="modulepreload" href="/cswiki/assets/chunks/pieDiagram-6d9582b9.wz-WdCCY.js">
    <link rel="modulepreload" href="/cswiki/assets/chunks/quadrantDiagram-a1c81500.Hq5ZACNK.js">
    <link rel="modulepreload" href="/cswiki/assets/chunks/requirementDiagram-3256a2fe.PKq4LDao.js">
    <link rel="modulepreload" href="/cswiki/assets/chunks/sequenceDiagram-25152a15.KU0gcCGu.js">
    <link rel="modulepreload" href="/cswiki/assets/chunks/classDiagram-819d3ad4.6z0OECJx.js">
    <link rel="modulepreload" href="/cswiki/assets/chunks/classDiagram-v2-c4607319.HDMQK2ty.js">
    <link rel="modulepreload" href="/cswiki/assets/chunks/stateDiagram-693ac5fb.F7xpFsJd.js">
    <link rel="modulepreload" href="/cswiki/assets/chunks/stateDiagram-v2-8f2bb0da.l7gBnZmy.js">
    <link rel="modulepreload" href="/cswiki/assets/chunks/journeyDiagram-9f355b40.y1ptOrfl.js">
    <link rel="modulepreload" href="/cswiki/assets/chunks/flowchart-elk-definition-3f2388fe.DlMS3Xvy.js">
    <link rel="modulepreload" href="/cswiki/assets/chunks/timeline-definition-0c903a0d.AYdkHRSL.js">
    <link rel="modulepreload" href="/cswiki/assets/chunks/mindmap-definition-35a1e92c.4sblmM2v.js">
    <link rel="modulepreload" href="/cswiki/assets/chunks/sankeyDiagram-ebb0d63f.SAz6guht.js">
    <link rel="modulepreload" href="/cswiki/assets/chunks/virtual_mermaid-config.AhCe4kHV.js">
    <link rel="modulepreload" href="/cswiki/assets/src_project_redis_05-Rediså®æˆ˜-ä¼˜æƒ åˆ¸ç§’æ€.md.JZ34CXjc.lean.js">
    <link rel="icon" href="/favicon.ico">
    <meta name="author" content="mousse">
    <meta name="keywords" content="æ…•æ–¯çš„çŸ¥è¯†å°å†Œå­">
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">
    <meta name="theme-color" content="#3c8772">
    <meta property="og:type" content="website">
    <meta property="og:locale" content="zh_CN">
    <meta property="og:title" content="çŸ¥è¯†å°å†Œå­">
    <meta property="og:description" content="æ­å»ºä¸ªäººçš„çŸ¥è¯†ä½“ç³»,ä¸€ä¸ªå¥½çš„çŸ¥è¯†ä½“ç³»å’Œå­¦ä¹ æ–¹æ³•ä¼šè®©è‡ªå·±äº‹åŠåŠŸå€">
    <meta property="og:site_name" content="çŸ¥è¯†å°å†Œå­">
    <meta property="og:image" content="/logo.svg">
    <script id="check-dark-mode">(()=>{const e=localStorage.getItem("vitepress-theme-appearance")||"auto",a=window.matchMedia("(prefers-color-scheme: dark)").matches;(!e||e==="auto"?a:e==="dark")&&document.documentElement.classList.add("dark")})();</script>
    <script id="check-mac-os">document.documentElement.classList.toggle("mac",/Mac|iPhone|iPod|iPad/i.test(navigator.platform));</script>
  </head>
  <body>
    <div id="app"><div class="Layout" data-v-83d41759><!--[--><!--]--><!--[--><span tabindex="-1" data-v-40879362></span><a href="#VPContent" class="VPSkipLink visually-hidden" data-v-40879362> Skip to content </a><!--]--><!----><header class="VPNav" data-v-83d41759 data-v-0b69728b><div class="VPNavBar has-sidebar" data-v-0b69728b data-v-0ec8604f><div class="wrapper" data-v-0ec8604f><div class="container" data-v-0ec8604f><div class="title" data-v-0ec8604f><div class="VPNavBarTitle has-sidebar" data-v-0ec8604f data-v-e5f52478><a class="title" href="/cswiki/" data-v-e5f52478><!--[--><!--]--><!--[--><img class="VPImage logo" src="/cswiki/logo.svg" alt data-v-22195471><!--]--><!--[-->çŸ¥è¯†å°å†Œå­<!--]--><!--[--><!--]--></a></div></div><div class="content" data-v-0ec8604f><div class="content-body" data-v-0ec8604f><!--[--><!--]--><div class="VPNavBarSearch search" data-v-0ec8604f><!--[--><!----><div id="local-search"><button type="button" class="DocSearch DocSearch-Button" aria-label="æœç´¢æ–‡æ¡£"><span class="DocSearch-Button-Container"><svg class="DocSearch-Search-Icon" width="20" height="20" viewBox="0 0 20 20" aria-label="search icon"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">æœç´¢æ–‡æ¡£</span></span><span class="DocSearch-Button-Keys"><kbd class="DocSearch-Button-Key"></kbd><kbd class="DocSearch-Button-Key">K</kbd></span></button></div><!--]--></div><nav aria-labelledby="main-nav-aria-label" class="VPNavBarMenu menu" data-v-0ec8604f data-v-6ba9474d><span id="main-nav-aria-label" class="visually-hidden" data-v-6ba9474d>Main Navigation</span><!--[--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/cswiki/" tabindex="0" data-v-6ba9474d data-v-5c7cab49><!--[--><span data-v-5c7cab49>ğŸ“Œ æŠ€æœ¯åšå®¢</span><!--]--></a><!--]--><!--[--><div class="VPFlyout VPNavBarMenuGroup" data-v-6ba9474d data-v-8e60bb69><button type="button" class="button" aria-haspopup="true" aria-expanded="false" data-v-8e60bb69><span class="text" data-v-8e60bb69><!----><span data-v-8e60bb69>ğŸ“ åŸºç¡€çŸ¥è¯†</span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="text-icon" data-v-8e60bb69><path d="M12,16c-0.3,0-0.5-0.1-0.7-0.3l-6-6c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l5.3,5.3l5.3-5.3c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-6,6C12.5,15.9,12.3,16,12,16z"></path></svg></span></button><div class="menu" data-v-8e60bb69><div class="VPMenu" data-v-8e60bb69 data-v-32b6ed9e><div class="items" data-v-32b6ed9e><!--[--><!--[--><div class="VPMenuGroup" data-v-32b6ed9e data-v-8b276347><!----><!--[--><!--[--><div class="VPMenuLink" data-v-8b276347 data-v-d8ac4ebe><a class="VPLink link" href="/cswiki/src/base/java/index" data-v-d8ac4ebe><!--[-->â˜•ï¸ JavaåŸºç¡€<!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-8b276347 data-v-d8ac4ebe><a class="VPLink link" href="/cswiki/src/base/jvm/index" data-v-d8ac4ebe><!--[-->ğŸ–¥ JVMå…¥é—¨<!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-8b276347 data-v-d8ac4ebe><a class="VPLink link" href="/cswiki/src/base/juc/index" data-v-d8ac4ebe><!--[-->ğŸ”¥ å¹¶å‘ç¼–ç¨‹<!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-8b276347 data-v-d8ac4ebe><a class="VPLink link" href="/cswiki/src/base/netty/index" data-v-d8ac4ebe><!--[-->ğŸŒ ç½‘ç»œç¼–ç¨‹<!--]--></a></div><!--]--><!--]--></div><!--]--><!--[--><div class="VPMenuGroup" data-v-32b6ed9e data-v-8b276347><!----><!--[--><!--[--><div class="VPMenuLink" data-v-8b276347 data-v-d8ac4ebe><a class="VPLink link" href="/cswiki/src/base/alg/index" data-v-d8ac4ebe><!--[-->ğŸ§© æ•°æ®ç»“æ„<!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-8b276347 data-v-d8ac4ebe><a class="VPLink link" href="/cswiki/src/base/gof/index" data-v-d8ac4ebe><!--[-->ğŸ“ è®¾è®¡æ¨¡å¼<!--]--></a></div><!--]--><!--]--></div><!--]--><!--[--><div class="VPMenuGroup" data-v-32b6ed9e data-v-8b276347><!----><!--[--><!--[--><div class="VPMenuLink" data-v-8b276347 data-v-d8ac4ebe><a class="VPLink link" href="/cswiki/src/base/mysql/index" data-v-d8ac4ebe><!--[-->ğŸ“Š æ•°æ®åº“<!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-8b276347 data-v-d8ac4ebe><a class="VPLink link" href="/cswiki/src/base/linux/index" data-v-d8ac4ebe><!--[-->ğŸ‘¨â€ğŸ’» æœåŠ¡å™¨<!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-8b276347 data-v-d8ac4ebe><a class="VPLink link" href="/cswiki/src/base/spring/index" data-v-d8ac4ebe><!--[-->ğŸŒ± Spring<!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-8b276347 data-v-d8ac4ebe><a class="VPLink link" href="/cswiki/src/base/cloud/index" data-v-d8ac4ebe><!--[-->â˜ï¸ å¾®æœåŠ¡<!--]--></a></div><!--]--><!--]--></div><!--]--><!--]--></div><!--[--><!--]--></div></div></div><!--]--><!--[--><div class="VPFlyout VPNavBarMenuGroup active" data-v-6ba9474d data-v-8e60bb69><button type="button" class="button" aria-haspopup="true" aria-expanded="false" data-v-8e60bb69><span class="text" data-v-8e60bb69><!----><span data-v-8e60bb69>ğŸ› ï¸ é¡¹ç›®å®æˆ˜</span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="text-icon" data-v-8e60bb69><path d="M12,16c-0.3,0-0.5-0.1-0.7-0.3l-6-6c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l5.3,5.3l5.3-5.3c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-6,6C12.5,15.9,12.3,16,12,16z"></path></svg></span></button><div class="menu" data-v-8e60bb69><div class="VPMenu" data-v-8e60bb69 data-v-32b6ed9e><div class="items" data-v-32b6ed9e><!--[--><!--[--><div class="VPMenuGroup" data-v-32b6ed9e data-v-8b276347><!----><!--[--><!--[--><div class="VPMenuLink" data-v-8b276347 data-v-d8ac4ebe><a class="VPLink link" href="/cswiki/src/project/redis/index" data-v-d8ac4ebe><!--[-->ğŸ”–ï¸ é»‘é©¬ç‚¹è¯„<!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-8b276347 data-v-d8ac4ebe><a class="VPLink link" href="/cswiki/src/project/topnews/index" data-v-d8ac4ebe><!--[-->ğŸ“° é»‘é©¬å¤´æ¡<!--]--></a></div><!--]--><!--]--></div><!--]--><!--[--><div class="VPMenuGroup" data-v-32b6ed9e data-v-8b276347><!----><!--[--><!--[--><div class="VPMenuLink" data-v-8b276347 data-v-d8ac4ebe><a class="VPLink link" href="/cswiki/src/project/college/index" data-v-d8ac4ebe><!--[-->ğŸ“š å¤©æœºå­¦å ‚<!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-8b276347 data-v-d8ac4ebe><a class="VPLink link" href="/cswiki/src/project/express/index" data-v-d8ac4ebe><!--[-->ğŸšš ç¥é¢†ç‰©æµ<!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-8b276347 data-v-d8ac4ebe><a class="VPLink link" href="/cswiki/src/project/shop/index" data-v-d8ac4ebe><!--[-->ğŸ›’ è°·ç²’å•†åŸ<!--]--></a></div><!--]--><!--]--></div><!--]--><!--[--><div class="VPMenuGroup" data-v-32b6ed9e data-v-8b276347><!----><!--[--><!--[--><div class="VPMenuLink" data-v-8b276347 data-v-d8ac4ebe><a class="VPLink link" href="/cswiki/src/project/takeout/index" data-v-d8ac4ebe><!--[-->ğŸœ è°·ç²’å¤–å–<!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-8b276347 data-v-d8ac4ebe><a class="VPLink link" href="/cswiki/src/project/health/index" data-v-d8ac4ebe><!--[-->ğŸ„ è°·ç²’å¥åº·<!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-8b276347 data-v-d8ac4ebe><a class="VPLink link" href="/cswiki/src/project/social/index" data-v-d8ac4ebe><!--[-->ğŸ§‘â€ğŸ¤â€ğŸ§‘ è°·ç²’äº¤å‹<!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-8b276347 data-v-d8ac4ebe><a class="VPLink link" href="/cswiki/src/project/rent/index" data-v-d8ac4ebe><!--[-->ğŸ  è°·ç²’ç§Ÿæˆ¿<!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-8b276347 data-v-d8ac4ebe><a class="VPLink link" href="/cswiki/src/project/financial/index" data-v-d8ac4ebe><!--[-->ğŸ“ˆ è°·ç²’é‡‘è<!--]--></a></div><!--]--><!--]--></div><!--]--><!--]--></div><!--[--><!--]--></div></div></div><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/cswiki/src/base/summarize/index" tabindex="0" data-v-6ba9474d data-v-5c7cab49><!--[--><span data-v-5c7cab49>ğŸ’¼ é¢è¯•å®å…¸</span><!--]--></a><!--]--><!--]--></nav><!----><div class="VPNavBarAppearance appearance" data-v-0ec8604f data-v-f8a5715e><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title="Switch to dark theme" aria-checked="false" data-v-f8a5715e data-v-a55d2cd3 data-v-43317611><span class="check" data-v-43317611><span class="icon" data-v-43317611><!--[--><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="sun" data-v-a55d2cd3><path d="M12,18c-3.3,0-6-2.7-6-6s2.7-6,6-6s6,2.7,6,6S15.3,18,12,18zM12,8c-2.2,0-4,1.8-4,4c0,2.2,1.8,4,4,4c2.2,0,4-1.8,4-4C16,9.8,14.2,8,12,8z"></path><path d="M12,4c-0.6,0-1-0.4-1-1V1c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,3.6,12.6,4,12,4z"></path><path d="M12,24c-0.6,0-1-0.4-1-1v-2c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,23.6,12.6,24,12,24z"></path><path d="M5.6,6.6c-0.3,0-0.5-0.1-0.7-0.3L3.5,4.9c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C6.2,6.5,5.9,6.6,5.6,6.6z"></path><path d="M19.8,20.8c-0.3,0-0.5-0.1-0.7-0.3l-1.4-1.4c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C20.3,20.7,20,20.8,19.8,20.8z"></path><path d="M3,13H1c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S3.6,13,3,13z"></path><path d="M23,13h-2c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S23.6,13,23,13z"></path><path d="M4.2,20.8c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C4.7,20.7,4.5,20.8,4.2,20.8z"></path><path d="M18.4,6.6c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C18.9,6.5,18.6,6.6,18.4,6.6z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="moon" data-v-a55d2cd3><path d="M12.1,22c-0.3,0-0.6,0-0.9,0c-5.5-0.5-9.5-5.4-9-10.9c0.4-4.8,4.2-8.6,9-9c0.4,0,0.8,0.2,1,0.5c0.2,0.3,0.2,0.8-0.1,1.1c-2,2.7-1.4,6.4,1.3,8.4c2.1,1.6,5,1.6,7.1,0c0.3-0.2,0.7-0.3,1.1-0.1c0.3,0.2,0.5,0.6,0.5,1c-0.2,2.7-1.5,5.1-3.6,6.8C16.6,21.2,14.4,22,12.1,22zM9.3,4.4c-2.9,1-5,3.6-5.2,6.8c-0.4,4.4,2.8,8.3,7.2,8.7c2.1,0.2,4.2-0.4,5.8-1.8c1.1-0.9,1.9-2.1,2.4-3.4c-2.5,0.9-5.3,0.5-7.5-1.1C9.2,11.4,8.1,7.7,9.3,4.4z"></path></svg><!--]--></span></span></button></div><div class="VPSocialLinks VPNavBarSocialLinks social-links" data-v-0ec8604f data-v-9b69f4c1 data-v-0ed08415><!--[--><a class="VPSocialLink no-icon" href="https://github.com/Charles7c/charles7c.github.io" aria-label="github" target="_blank" rel="noopener" data-v-0ed08415 data-v-c77ec717><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>GitHub</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a><a class="VPSocialLink no-icon" href="https://gitee.com/Charles7c/charles7c" aria-label target="_blank" rel="noopener" data-v-0ed08415 data-v-c77ec717><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>ç äº‘</title><path d="M11.984 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.016 0zm6.09 5.333c.328 0 .593.266.592.593v1.482a.594.594 0 0 1-.593.592H9.777c-.982 0-1.778.796-1.778 1.778v5.63c0 .327.266.592.593.592h5.63c.982 0 1.778-.796 1.778-1.778v-.296a.593.593 0 0 0-.592-.593h-4.15a.592.592 0 0 1-.592-.592v-1.482a.593.593 0 0 1 .593-.592h6.815c.327 0 .593.265.593.592v3.408a4 4 0 0 1-4 4H5.926a.593.593 0 0 1-.593-.593V9.778a4.444 4.444 0 0 1 4.445-4.444h8.296Z"/></svg></a><!--]--></div><div class="VPFlyout VPNavBarExtra extra" data-v-0ec8604f data-v-b9614353 data-v-8e60bb69><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-8e60bb69><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="icon" data-v-8e60bb69><circle cx="12" cy="12" r="2"></circle><circle cx="19" cy="12" r="2"></circle><circle cx="5" cy="12" r="2"></circle></svg></button><div class="menu" data-v-8e60bb69><div class="VPMenu" data-v-8e60bb69 data-v-32b6ed9e><!----><!--[--><!--[--><!----><div class="group" data-v-b9614353><div class="item appearance" data-v-b9614353><p class="label" data-v-b9614353>åˆ‡æ¢æ—¥å…‰/æš—é»‘æ¨¡å¼</p><div class="appearance-action" data-v-b9614353><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title="Switch to dark theme" aria-checked="false" data-v-b9614353 data-v-a55d2cd3 data-v-43317611><span class="check" data-v-43317611><span class="icon" data-v-43317611><!--[--><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="sun" data-v-a55d2cd3><path d="M12,18c-3.3,0-6-2.7-6-6s2.7-6,6-6s6,2.7,6,6S15.3,18,12,18zM12,8c-2.2,0-4,1.8-4,4c0,2.2,1.8,4,4,4c2.2,0,4-1.8,4-4C16,9.8,14.2,8,12,8z"></path><path d="M12,4c-0.6,0-1-0.4-1-1V1c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,3.6,12.6,4,12,4z"></path><path d="M12,24c-0.6,0-1-0.4-1-1v-2c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,23.6,12.6,24,12,24z"></path><path d="M5.6,6.6c-0.3,0-0.5-0.1-0.7-0.3L3.5,4.9c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C6.2,6.5,5.9,6.6,5.6,6.6z"></path><path d="M19.8,20.8c-0.3,0-0.5-0.1-0.7-0.3l-1.4-1.4c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C20.3,20.7,20,20.8,19.8,20.8z"></path><path d="M3,13H1c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S3.6,13,3,13z"></path><path d="M23,13h-2c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S23.6,13,23,13z"></path><path d="M4.2,20.8c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C4.7,20.7,4.5,20.8,4.2,20.8z"></path><path d="M18.4,6.6c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C18.9,6.5,18.6,6.6,18.4,6.6z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="moon" data-v-a55d2cd3><path d="M12.1,22c-0.3,0-0.6,0-0.9,0c-5.5-0.5-9.5-5.4-9-10.9c0.4-4.8,4.2-8.6,9-9c0.4,0,0.8,0.2,1,0.5c0.2,0.3,0.2,0.8-0.1,1.1c-2,2.7-1.4,6.4,1.3,8.4c2.1,1.6,5,1.6,7.1,0c0.3-0.2,0.7-0.3,1.1-0.1c0.3,0.2,0.5,0.6,0.5,1c-0.2,2.7-1.5,5.1-3.6,6.8C16.6,21.2,14.4,22,12.1,22zM9.3,4.4c-2.9,1-5,3.6-5.2,6.8c-0.4,4.4,2.8,8.3,7.2,8.7c2.1,0.2,4.2-0.4,5.8-1.8c1.1-0.9,1.9-2.1,2.4-3.4c-2.5,0.9-5.3,0.5-7.5-1.1C9.2,11.4,8.1,7.7,9.3,4.4z"></path></svg><!--]--></span></span></button></div></div></div><div class="group" data-v-b9614353><div class="item social-links" data-v-b9614353><div class="VPSocialLinks social-links-list" data-v-b9614353 data-v-0ed08415><!--[--><a class="VPSocialLink no-icon" href="https://github.com/Charles7c/charles7c.github.io" aria-label="github" target="_blank" rel="noopener" data-v-0ed08415 data-v-c77ec717><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>GitHub</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a><a class="VPSocialLink no-icon" href="https://gitee.com/Charles7c/charles7c" aria-label target="_blank" rel="noopener" data-v-0ed08415 data-v-c77ec717><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>ç äº‘</title><path d="M11.984 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.016 0zm6.09 5.333c.328 0 .593.266.592.593v1.482a.594.594 0 0 1-.593.592H9.777c-.982 0-1.778.796-1.778 1.778v5.63c0 .327.266.592.593.592h5.63c.982 0 1.778-.796 1.778-1.778v-.296a.593.593 0 0 0-.592-.593h-4.15a.592.592 0 0 1-.592-.592v-1.482a.593.593 0 0 1 .593-.592h6.815c.327 0 .593.265.593.592v3.408a4 4 0 0 1-4 4H5.926a.593.593 0 0 1-.593-.593V9.778a4.444 4.444 0 0 1 4.445-4.444h8.296Z"/></svg></a><!--]--></div></div></div><!--]--><!--]--></div></div></div><!--[--><!--]--><button type="button" class="VPNavBarHamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="VPNavScreen" data-v-0ec8604f data-v-a6fa7f77><span class="container" data-v-a6fa7f77><span class="top" data-v-a6fa7f77></span><span class="middle" data-v-a6fa7f77></span><span class="bottom" data-v-a6fa7f77></span></span></button></div></div></div></div><div class="divider" data-v-0ec8604f><div class="divider-line" data-v-0ec8604f></div></div></div><!----></header><div class="VPLocalNav has-sidebar empty" data-v-83d41759 data-v-f4225638><div class="container" data-v-f4225638><button class="menu" aria-expanded="false" aria-controls="VPSidebarNav" data-v-f4225638><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="menu-icon" data-v-f4225638><path d="M17,11H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h14c0.6,0,1,0.4,1,1S17.6,11,17,11z"></path><path d="M21,7H3C2.4,7,2,6.6,2,6s0.4-1,1-1h18c0.6,0,1,0.4,1,1S21.6,7,21,7z"></path><path d="M21,15H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h18c0.6,0,1,0.4,1,1S21.6,15,21,15z"></path><path d="M17,19H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h14c0.6,0,1,0.4,1,1S17.6,19,17,19z"></path></svg><span class="menu-text" data-v-f4225638>æ–‡ç« </span></button><div class="VPLocalNavOutlineDropdown" style="--vp-vh:0px;" data-v-f4225638 data-v-560fa4a6><button data-v-560fa4a6>è¿”å›é¡¶éƒ¨</button><!----></div></div></div><aside class="VPSidebar" data-v-83d41759 data-v-93fad516><div class="curtain" data-v-93fad516></div><nav class="nav" id="VPSidebarNav" aria-labelledby="sidebar-aria-label" tabindex="-1" data-v-93fad516><span class="visually-hidden" id="sidebar-aria-label" data-v-93fad516> Sidebar Navigation </span><!--[--><!--]--><!--[--><div class="group" data-v-93fad516><section class="VPSidebarItem level-0 collapsible has-active" data-v-93fad516 data-v-d1e013f8><div class="item" role="button" tabindex="0" data-v-d1e013f8><div class="indicator" data-v-d1e013f8></div><h2 class="text" data-v-d1e013f8>é»‘é©¬ç‚¹è¯„</h2><div class="caret" role="button" aria-label="toggle section" tabindex="0" data-v-d1e013f8><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="caret-icon" data-v-d1e013f8><path d="M9,19c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l5.3-5.3L8.3,6.7c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l6,6c0.4,0.4,0.4,1,0,1.4l-6,6C9.5,18.9,9.3,19,9,19z"></path></svg></div></div><div class="items" data-v-d1e013f8><!--[--><div class="VPSidebarItem level-1 is-link" data-v-d1e013f8 data-v-d1e013f8><div class="item" data-v-d1e013f8><div class="indicator" data-v-d1e013f8></div><a class="VPLink link link" href="/cswiki/src/project/redis/01-Redis%E5%9F%BA%E7%A1%80" data-v-d1e013f8><!--[--><p class="text" data-v-d1e013f8>RedisåŸºç¡€</p><!--]--></a><!----></div><!----></div><section class="VPSidebarItem level-1 has-active" data-v-d1e013f8 data-v-d1e013f8><div class="item" role="button" tabindex="0" data-v-d1e013f8><div class="indicator" data-v-d1e013f8></div><h3 class="text" data-v-d1e013f8>Rediså®æˆ˜</h3><!----></div><div class="items" data-v-d1e013f8><!--[--><div class="VPSidebarItem level-2 is-link" data-v-d1e013f8 data-v-d1e013f8><div class="item" data-v-d1e013f8><div class="indicator" data-v-d1e013f8></div><a class="VPLink link link" href="/cswiki/src/project/redis/02-Redis%E5%AE%9E%E6%88%98-%E9%BB%91%E9%A9%AC%E7%82%B9%E8%AF%84" data-v-d1e013f8><!--[--><p class="text" data-v-d1e013f8>é»‘é©¬ç‚¹è¯„</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-2 is-link" data-v-d1e013f8 data-v-d1e013f8><div class="item" data-v-d1e013f8><div class="indicator" data-v-d1e013f8></div><a class="VPLink link link" href="/cswiki/src/project/redis/03-Redis%E5%AE%9E%E6%88%98-%E7%9F%AD%E4%BF%A1%E7%99%BB%E5%BD%95" data-v-d1e013f8><!--[--><p class="text" data-v-d1e013f8>çŸ­ä¿¡ç™»å½•</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-2 is-link" data-v-d1e013f8 data-v-d1e013f8><div class="item" data-v-d1e013f8><div class="indicator" data-v-d1e013f8></div><a class="VPLink link link" href="/cswiki/src/project/redis/04-Redis%E5%AE%9E%E6%88%98-%E5%95%86%E6%88%B7%E6%9F%A5%E8%AF%A2" data-v-d1e013f8><!--[--><p class="text" data-v-d1e013f8>å•†æˆ·æŸ¥è¯¢</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-2 is-link" data-v-d1e013f8 data-v-d1e013f8><div class="item" data-v-d1e013f8><div class="indicator" data-v-d1e013f8></div><a class="VPLink link link" href="/cswiki/src/project/redis/05-Redis%E5%AE%9E%E6%88%98-%E4%BC%98%E6%83%A0%E5%88%B8%E7%A7%92%E6%9D%80" data-v-d1e013f8><!--[--><p class="text" data-v-d1e013f8>* ä¼˜æƒ åˆ¸ç§’æ€</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-2 is-link" data-v-d1e013f8 data-v-d1e013f8><div class="item" data-v-d1e013f8><div class="indicator" data-v-d1e013f8></div><a class="VPLink link link" href="/cswiki/src/project/redis/06-Redis%E5%AE%9E%E6%88%98-%E8%BE%BE%E4%BA%BA%E6%8E%A2%E5%BA%97" data-v-d1e013f8><!--[--><p class="text" data-v-d1e013f8>è¾¾äººæ¢åº—</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-2 is-link" data-v-d1e013f8 data-v-d1e013f8><div class="item" data-v-d1e013f8><div class="indicator" data-v-d1e013f8></div><a class="VPLink link link" href="/cswiki/src/project/redis/07-Redis%E5%AE%9E%E6%88%98-%E5%A5%BD%E5%8F%8B%E5%85%B3%E6%B3%A8" data-v-d1e013f8><!--[--><p class="text" data-v-d1e013f8>å¥½å‹å…³æ³¨</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-2 is-link" data-v-d1e013f8 data-v-d1e013f8><div class="item" data-v-d1e013f8><div class="indicator" data-v-d1e013f8></div><a class="VPLink link link" href="/cswiki/src/project/redis/08-Redis%E5%AE%9E%E6%88%98-%E9%99%84%E8%BF%91%E5%95%86%E6%88%B7" data-v-d1e013f8><!--[--><p class="text" data-v-d1e013f8>é™„è¿‘å•†æˆ·</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-2 is-link" data-v-d1e013f8 data-v-d1e013f8><div class="item" data-v-d1e013f8><div class="indicator" data-v-d1e013f8></div><a class="VPLink link link" href="/cswiki/src/project/redis/09-Redis%E5%AE%9E%E6%88%98-%E7%94%A8%E6%88%B7%E7%AD%BE%E5%88%B0" data-v-d1e013f8><!--[--><p class="text" data-v-d1e013f8>ç”¨æˆ·ç­¾åˆ°</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-2 is-link" data-v-d1e013f8 data-v-d1e013f8><div class="item" data-v-d1e013f8><div class="indicator" data-v-d1e013f8></div><a class="VPLink link link" href="/cswiki/src/project/redis/10-Redis%E5%AE%9E%E6%88%98-UV%E7%BB%9F%E8%AE%A1" data-v-d1e013f8><!--[--><p class="text" data-v-d1e013f8>UVç»Ÿè®¡</p><!--]--></a><!----></div><!----></div><!--]--></div></section><div class="VPSidebarItem level-1 is-link" data-v-d1e013f8 data-v-d1e013f8><div class="item" data-v-d1e013f8><div class="indicator" data-v-d1e013f8></div><a class="VPLink link link" href="/cswiki/src/project/redis/11-Redis%E5%AE%9E%E8%B7%B5" data-v-d1e013f8><!--[--><p class="text" data-v-d1e013f8>* Rediså®è·µ</p><!--]--></a><!----></div><!----></div><section class="VPSidebarItem level-1" data-v-d1e013f8 data-v-d1e013f8><div class="item" role="button" tabindex="0" data-v-d1e013f8><div class="indicator" data-v-d1e013f8></div><h3 class="text" data-v-d1e013f8>* RedisåŸç†</h3><!----></div><div class="items" data-v-d1e013f8><!--[--><div class="VPSidebarItem level-2 is-link" data-v-d1e013f8 data-v-d1e013f8><div class="item" data-v-d1e013f8><div class="indicator" data-v-d1e013f8></div><a class="VPLink link link" href="/cswiki/src/project/redis/12-Redis%E5%8E%9F%E7%90%86-%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84" data-v-d1e013f8><!--[--><p class="text" data-v-d1e013f8>æ•°æ®ç»“æ„</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-2 is-link" data-v-d1e013f8 data-v-d1e013f8><div class="item" data-v-d1e013f8><div class="indicator" data-v-d1e013f8></div><a class="VPLink link link" href="/cswiki/src/project/redis/13-Redis%E5%8E%9F%E7%90%86-%E7%BD%91%E7%BB%9C%E6%A8%A1%E5%9E%8B" data-v-d1e013f8><!--[--><p class="text" data-v-d1e013f8>ç½‘ç»œæ¨¡å‹</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-2 is-link" data-v-d1e013f8 data-v-d1e013f8><div class="item" data-v-d1e013f8><div class="indicator" data-v-d1e013f8></div><a class="VPLink link link" href="/cswiki/src/project/redis/14-Redis%E5%8E%9F%E7%90%86-%E5%86%85%E5%AD%98%E7%AD%96%E7%95%A5" data-v-d1e013f8><!--[--><p class="text" data-v-d1e013f8>å†…å­˜ç­–ç•¥</p><!--]--></a><!----></div><!----></div><!--]--></div></section><!--]--></div></section></div><!--]--><!--[--><!--]--></nav></aside><div class="VPContent has-sidebar" id="VPContent" data-v-83d41759 data-v-7f2b530e><div class="VPDoc has-sidebar has-aside" data-v-7f2b530e data-v-7b451c74><!--[--><!--]--><div class="container" data-v-7b451c74><div class="aside" data-v-7b451c74><div class="aside-curtain" data-v-7b451c74></div><div class="aside-container" data-v-7b451c74><div class="aside-content" data-v-7b451c74><div class="VPDocAside" data-v-7b451c74 data-v-ae5a1c99><!--[--><!--]--><!--[--><!--]--><div class="VPDocAsideOutline" role="navigation" data-v-ae5a1c99 data-v-34b44e06><div class="content" data-v-34b44e06><div class="outline-marker" data-v-34b44e06></div><div class="outline-title" role="heading" aria-level="2" data-v-34b44e06>ç« èŠ‚å¯¼èˆª</div><nav aria-labelledby="doc-outline-aria-label" data-v-34b44e06><span class="visually-hidden" id="doc-outline-aria-label" data-v-34b44e06> Table of Contents for current page </span><ul class="VPDocOutlineItem root" data-v-34b44e06 data-v-ff6ff475><!--[--><!--]--></ul></nav></div></div><!--[--><!--]--><div class="spacer" data-v-ae5a1c99></div><!--[--><!--]--><!----><!--[--><!--]--><!--[--><!--]--></div></div></div></div><div class="content" data-v-7b451c74><div class="content-container" data-v-7b451c74><!--[--><!--]--><main class="main" data-v-7b451c74><div style="position:relative;" class="vp-doc _cswiki_src_project_redis_05-Redis%E5%AE%9E%E6%88%98-%E4%BC%98%E6%83%A0%E5%88%B8%E7%A7%92%E6%9D%80" data-v-7b451c74><div><nav class="table-of-contents"><ul><li><a href="#ä¼˜æƒ å·ç§’æ€">ä¼˜æƒ å·ç§’æ€</a><ul><li><a href="#å…¨å±€idç”Ÿæˆ">å…¨å±€IDç”Ÿæˆ</a></li><li><a href="#å®ç°ä¼˜æƒ åˆ¸ç§’æ€">å®ç°ä¼˜æƒ åˆ¸ç§’æ€</a><ul><li><a href="#æ·»åŠ ä¼˜æƒ å·">æ·»åŠ ä¼˜æƒ å·</a></li><li><a href="#å®ç°ç§’æ€ä¸‹å•">å®ç°ç§’æ€ä¸‹å•</a></li><li><a href="#åº“å­˜è¶…å–é—®é¢˜">åº“å­˜è¶…å–é—®é¢˜</a></li><li><a href="#å®ç°ä¸€äººä¸€å•">å®ç°ä¸€äººä¸€å•</a></li></ul></li><li><a href="#åˆ†å¸ƒå¼é”">åˆ†å¸ƒå¼é”</a><ul><li><a href="#åŸºæœ¬åŸç†">åŸºæœ¬åŸç†</a></li><li><a href="#æ ¸å¿ƒæ€è·¯">æ ¸å¿ƒæ€è·¯</a></li><li><a href="#å®ç°åˆ†å¸ƒå¼é”ç‰ˆæœ¬">å®ç°åˆ†å¸ƒå¼é”ç‰ˆæœ¬</a></li><li><a href="#åˆ†å¸ƒå¼é”è¯¯åˆ è¯´æ˜">åˆ†å¸ƒå¼é”è¯¯åˆ è¯´æ˜</a></li><li><a href="#è§£å†³åˆ†å¸ƒå¼é”è¯¯åˆ ">è§£å†³åˆ†å¸ƒå¼é”è¯¯åˆ </a></li><li><a href="#åˆ†å¸ƒå¼é”çš„åŸå­æ€§é—®é¢˜">åˆ†å¸ƒå¼é”çš„åŸå­æ€§é—®é¢˜</a></li><li><a href="#luaè§£å†³åŸå­æ€§é—®é¢˜">Luaè§£å†³åŸå­æ€§é—®é¢˜</a></li><li><a href="#è°ƒç”¨luaè„šæœ¬æ”¹é€ åˆ†å¸ƒå¼é”">è°ƒç”¨Luaè„šæœ¬æ”¹é€ åˆ†å¸ƒå¼é”</a></li></ul></li><li><a href="#redission">Redission</a><ul><li><a href="#åŠŸèƒ½ä»‹ç»">åŠŸèƒ½ä»‹ç»</a></li><li><a href="#å¿«é€Ÿå…¥é—¨">å¿«é€Ÿå…¥é—¨</a></li><li><a href="#å¯é‡å…¥é”åŸç†">å¯é‡å…¥é”åŸç†</a></li><li><a href="#é”é‡è¯•å’Œwatchdogæœºåˆ¶">é”é‡è¯•å’ŒWatchDogæœºåˆ¶</a></li><li><a href="#é”çš„mutilockåŸç†">é”çš„MutiLockåŸç†</a></li></ul></li><li><a href="#ç§’æ€ä¼˜åŒ–">ç§’æ€ä¼˜åŒ–</a><ul><li><a href="#å¼‚æ­¥ç§’æ€æ€è·¯">å¼‚æ­¥ç§’æ€æ€è·¯</a></li><li><a href="#ç§’æ€èµ„æ ¼åˆ¤æ–­">ç§’æ€èµ„æ ¼åˆ¤æ–­</a></li><li><a href="#é˜»å¡é˜Ÿåˆ—å®ç°">é˜»å¡é˜Ÿåˆ—å®ç°</a></li></ul></li><li><a href="#æ¶ˆæ¯é˜Ÿåˆ—">æ¶ˆæ¯é˜Ÿåˆ—</a><ul><li><a href="#è®¤è¯†æ¶ˆæ¯é˜Ÿåˆ—">è®¤è¯†æ¶ˆæ¯é˜Ÿåˆ—</a></li><li><a href="#åŸºäºlistå®ç°æ¶ˆæ¯é˜Ÿåˆ—">åŸºäºListå®ç°æ¶ˆæ¯é˜Ÿåˆ—</a></li><li><a href="#åŸºäºpubsubçš„æ¶ˆæ¯é˜Ÿåˆ—">åŸºäºPubSubçš„æ¶ˆæ¯é˜Ÿåˆ—</a></li><li><a href="#åŸºäºstreamçš„æ¶ˆæ¯é˜Ÿåˆ—">åŸºäºStreamçš„æ¶ˆæ¯é˜Ÿåˆ—</a></li><li><a href="#åŸºäºstreamçš„æ¶ˆæ¯é˜Ÿåˆ—-æ¶ˆè´¹è€…ç»„">åŸºäºStreamçš„æ¶ˆæ¯é˜Ÿåˆ—-æ¶ˆè´¹è€…ç»„</a></li><li><a href="#å®ç°å¼‚æ­¥ç§’æ€ä¸‹å•">å®ç°å¼‚æ­¥ç§’æ€ä¸‹å•</a></li></ul></li></ul></li></ul></nav><h2 id="ä¼˜æƒ å·ç§’æ€" tabindex="-1">ä¼˜æƒ å·ç§’æ€ <a class="header-anchor" href="#ä¼˜æƒ å·ç§’æ€" aria-label="Permalink to &quot;ä¼˜æƒ å·ç§’æ€&quot;">â€‹</a></h2><h3 id="å…¨å±€idç”Ÿæˆ" tabindex="-1">å…¨å±€IDç”Ÿæˆ <a class="header-anchor" href="#å…¨å±€idç”Ÿæˆ" aria-label="Permalink to &quot;å…¨å±€IDç”Ÿæˆ&quot;">â€‹</a></h3><p>æ¯ä¸ªåº—é“ºéƒ½å¯ä»¥å‘å¸ƒä¼˜æƒ åˆ¸ï¼š</p><p><img src="https://mugrain.oss-cn-hangzhou.aliyuncs.com/cswiki/1653362612286.png" alt="1653362612286" loading="lazy"></p><p>å½“ç”¨æˆ·æŠ¢è´­æ—¶ï¼Œå°±ä¼šç”Ÿæˆè®¢å•å¹¶ä¿å­˜åˆ° <code>tb_voucher_order</code> è¿™å¼ è¡¨ä¸­ï¼Œè€Œè®¢å•è¡¨å¦‚æœä½¿ç”¨æ•°æ®åº“è‡ªå¢ ID å°±å­˜åœ¨ä¸€äº›é—®é¢˜ï¼š</p><ul><li>ID çš„è§„å¾‹æ€§å¤ªæ˜æ˜¾</li><li>å—å•è¡¨æ•°æ®é‡çš„é™åˆ¶</li></ul><br><p>åœºæ™¯åˆ†æä¸€ï¼šå¦‚æœæˆ‘ä»¬çš„ ID å…·æœ‰å¤ªæ˜æ˜¾çš„è§„åˆ™ï¼Œç”¨æˆ·æˆ–è€…è¯´å•†ä¸šå¯¹æ‰‹å¾ˆå®¹æ˜“çŒœæµ‹å‡ºæ¥æˆ‘ä»¬çš„ä¸€äº›æ•æ„Ÿä¿¡æ¯ï¼Œæ¯”å¦‚å•†åŸåœ¨ä¸€å¤©æ—¶é—´å†…ï¼Œå–å‡ºäº†å¤šå°‘å•ï¼Œè¿™æ˜æ˜¾ä¸åˆé€‚ã€‚</p><p>åœºæ™¯åˆ†æäºŒï¼šéšç€æˆ‘ä»¬å•†åŸè§„æ¨¡è¶Šæ¥è¶Šå¤§ï¼ŒMySQL çš„å•è¡¨çš„å®¹é‡ä¸å®œè¶…è¿‡ 500Wï¼Œæ•°æ®é‡è¿‡å¤§ä¹‹åï¼Œæˆ‘ä»¬è¦è¿›è¡Œæ‹†åº“æ‹†è¡¨ï¼Œä½†æ‹†åˆ†è¡¨äº†ä¹‹åï¼Œä»–ä»¬ä»é€»è¾‘ä¸Šè®²ä»–ä»¬æ˜¯åŒä¸€å¼ è¡¨ï¼Œæ‰€ä»¥ä»–ä»¬çš„ ID æ˜¯ä¸èƒ½ä¸€æ ·çš„ï¼Œ äºæ˜¯ä¹æˆ‘ä»¬éœ€è¦ä¿è¯ ID çš„å”¯ä¸€æ€§ã€‚</p><br><p><strong>å…¨å±€IDç”Ÿæˆå™¨</strong>ï¼Œæ˜¯ä¸€ç§åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸‹ç”¨æ¥ç”Ÿæˆå…¨å±€å”¯ä¸€ ID çš„å·¥å…·ï¼Œä¸€èˆ¬è¦æ»¡è¶³ä¸‹åˆ—ç‰¹æ€§ï¼š</p><p><img src="https://mugrain.oss-cn-hangzhou.aliyuncs.com/cswiki/image-20240314092559673.png" alt="image-20240314092559673" loading="lazy"></p><p>ä¸ºäº†å¢åŠ  ID çš„å®‰å…¨æ€§ï¼Œæˆ‘ä»¬å¯ä»¥ä¸ç›´æ¥ä½¿ç”¨ Redis è‡ªå¢çš„æ•°å€¼ï¼Œè€Œæ˜¯æ‹¼æ¥ä¸€äº›å…¶å®ƒä¿¡æ¯ï¼š</p><p><img src="https://mugrain.oss-cn-hangzhou.aliyuncs.com/cswiki/image-20240314092627426.png" alt="image-20240314092627426" loading="lazy"></p><p>IDçš„ç»„æˆéƒ¨åˆ†ï¼š</p><ul><li>ç¬¦å·ä½ï¼š1bitï¼Œæ°¸è¿œä¸º0</li><li>æ—¶é—´æˆ³ï¼š31bitï¼Œä»¥ç§’ä¸ºå•ä½ï¼Œå¯ä»¥ä½¿ç”¨69å¹´</li><li>åºåˆ—å·ï¼š32bitï¼Œç§’å†…çš„è®¡æ•°å™¨ï¼Œæ”¯æŒæ¯ç§’äº§ç”Ÿ2^32ä¸ªä¸åŒID</li></ul><br><p><strong>Rediså®ç°å…¨å±€å”¯ä¸€ID</strong></p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">package</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.hmdp.utils;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> org.springframework.data.redis.core.StringRedisTemplate;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> org.springframework.stereotype.Component;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> java.time.LocalDateTime;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> java.time.ZoneOffset;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> java.time.format.DateTimeFormatter;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Component</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> RedisIdWorker</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    /**</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">     * å¼€å§‹æ—¶é—´æˆ³</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">     */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    private</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> final</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> long</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> BEGIN_TIMESTAMP </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1640995200L</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    /**</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">     * åºåˆ—å·çš„ä½æ•°</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">     */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    private</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> final</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> COUNT_BITS </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 32</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    private</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> StringRedisTemplate stringRedisTemplate;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> RedisIdWorker</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(StringRedisTemplate </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">stringRedisTemplate</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.stringRedisTemplate </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> stringRedisTemplate;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> long</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> nextId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(String </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">keyPrefix</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 1.ç”Ÿæˆæ—¶é—´æˆ³ </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        LocalDateTime now </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> LocalDateTime.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">now</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        long</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> nowSecond </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> now.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">toEpochSecond</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(ZoneOffset.UTC);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        long</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> timestamp </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> nowSecond </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> BEGIN_TIMESTAMP;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 2.ç”Ÿæˆåºåˆ—å·</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        String date </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> now.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">format</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(DateTimeFormatter.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ofPattern</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;yyyy:MM:dd&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">));</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        long</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> count </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> stringRedisTemplate.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">opsForValue</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">increment</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;icr:&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> +</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> keyPrefix </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;:&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> +</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> date);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 3.æ—¶é—´æˆ³å‘å·¦ç§»åŠ¨32ä½å¹¶æ‹¼æ¥ count è¿”å›</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> timestamp </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> COUNT_BITS </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> count;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><br><p><strong>æµ‹è¯•ç±»</strong></p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Autowired</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">private</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> RedisIdWorker redisIdWorker;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">private</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ExecutorService es </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Executors.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">newFixedThreadPool</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">500</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Test</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> testDate</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() throws InterruptedException {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    CountDownLatch latch </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> CountDownLatch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">300</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    Runnable task </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> () </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 100</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; i</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">++</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            long</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> redisIdWorker.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">nextId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;order&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            System.out.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">println</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;id = &quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> +</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> id);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        latch.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">countDown</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    };</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    long</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> begin </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> System.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">currentTimeMillis</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 300</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; i</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">++</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        es.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">submit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(task);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    latch.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    long</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> end </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> System.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">currentTimeMillis</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    System.out.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">println</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;time = &quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> +</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (end </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> begin));</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Test</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> testIdByte64</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    long</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> order </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> redisIdWorker.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">nextId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;order&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    System.out.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">println</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;order = &quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> +</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> order);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    long</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> decimal </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> order; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// åè¿›åˆ¶æ•°</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    String binary </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// å­˜å‚¨äºŒè¿›åˆ¶å­—ç¬¦ä¸²</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    while</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (decimal </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // æŠŠä½™æ•°æ”¾åœ¨å‰é¢</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        binary </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> decimal </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">%</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> +</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> binary;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // æŠŠå•†ä½œä¸ºæ–°çš„è¢«é™¤æ•°</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        decimal </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> decimal </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">/</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    System.out.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">println</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;binary = &quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> +</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> binary);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><div class="tip custom-block"><p class="custom-block-title">ğŸ’¡æç¤ºï¼šå…³äº<code>Countdownlatch</code></p><p><code>Countdownlatch</code>åä¸ºä¿¡å·æªï¼šä¸»è¦çš„ä½œç”¨æ˜¯åŒæ­¥åè°ƒåœ¨å¤šçº¿ç¨‹çš„ç­‰å¾…äºå”¤é†’é—®é¢˜</p><p>æˆ‘ä»¬å¦‚æœæ²¡æœ‰ CountDownLatch ï¼Œé‚£ä¹ˆç”±äºç¨‹åºæ˜¯å¼‚æ­¥çš„ï¼Œå½“å¼‚æ­¥ç¨‹åºæ²¡æœ‰æ‰§è¡Œå®Œæ—¶ï¼Œä¸»çº¿ç¨‹å°±å·²ç»æ‰§è¡Œå®Œäº†ï¼Œç„¶åæˆ‘ä»¬æœŸæœ›çš„æ˜¯åˆ†çº¿ç¨‹å…¨éƒ¨èµ°å®Œä¹‹åï¼Œä¸»çº¿ç¨‹å†èµ°ï¼Œæ‰€ä»¥æˆ‘ä»¬æ­¤æ—¶éœ€è¦ä½¿ç”¨åˆ°CountDownLatch</p><p>CountDownLatch ä¸­æœ‰ä¸¤ä¸ªæœ€é‡è¦çš„æ–¹æ³•</p><ul><li><code>countDown()</code></li><li><code>await()</code></li></ul><p><code>await()</code> æ˜¯é˜»å¡æ–¹æ³•ï¼Œæˆ‘ä»¬æ‹…å¿ƒåˆ†çº¿ç¨‹æ²¡æœ‰æ‰§è¡Œå®Œæ—¶ï¼Œmain çº¿ç¨‹å°±å…ˆæ‰§è¡Œï¼Œæ‰€ä»¥ä½¿ç”¨ <code>await()</code> å¯ä»¥è®© main çº¿ç¨‹é˜»å¡ï¼Œé‚£ä¹ˆä»€ä¹ˆæ—¶å€™ main çº¿ç¨‹ä¸å†é˜»å¡å‘¢ï¼Ÿå½“ CountDownLatch å†…éƒ¨ç»´æŠ¤çš„å˜é‡å˜ä¸º 0 æ—¶ï¼Œå°±ä¸å†é˜»å¡ï¼Œç›´æ¥æ”¾è¡Œï¼Œé‚£ä¹ˆä»€ä¹ˆæ—¶å€™ CountDownLatch ç»´æŠ¤çš„å˜é‡å˜ä¸º 0 å‘¢ï¼Œæˆ‘ä»¬åªéœ€è¦è°ƒç”¨ä¸€æ¬¡ <code>countDown()</code> ï¼Œå†…éƒ¨å˜é‡å°±å‡å°‘1ï¼Œæˆ‘ä»¬è®©åˆ†çº¿ç¨‹å’Œå˜é‡ç»‘å®šï¼Œ æ‰§è¡Œå®Œä¸€ä¸ªåˆ†çº¿ç¨‹å°±å‡å°‘ä¸€ä¸ªå˜é‡ï¼Œå½“åˆ†çº¿ç¨‹å…¨éƒ¨èµ°å®Œï¼ŒCountDownLatch ç»´æŠ¤çš„å˜é‡å°±æ˜¯ 0ï¼Œæ­¤æ—¶ <code>await()</code> å°±ä¸å†é˜»å¡ï¼Œç»Ÿè®¡å‡ºæ¥çš„æ—¶é—´ä¹Ÿå°±æ˜¯æ‰€æœ‰åˆ†çº¿ç¨‹æ‰§è¡Œå®Œåçš„æ—¶é—´ã€‚</p></div><br><div class="warning custom-block"><p class="custom-block-title">æ€»ç»“</p><p>å…¨å±€å”¯ä¸€IDç”Ÿæˆç­–ç•¥ï¼š</p><ul><li>UUID</li><li>Redisè‡ªå¢</li><li>Snowflakeç®—æ³•</li><li>æ•°æ®åº“è‡ªå¢:Redisè‡ªå¢çš„æ•°æ®åº“ç‰ˆ</li></ul><p>Redisè‡ªå¢IDç­–ç•¥</p><ul><li>æ¯å¤©ä¸€ä¸ªKeyï¼Œæ–¹ä¾¿ç»Ÿè®¡è®¢å•é‡</li><li>IDæ„é€ æ˜¯ æ—¶é—´æˆ³ + è®¡æ•°å™¨</li></ul></div><br><h3 id="å®ç°ä¼˜æƒ åˆ¸ç§’æ€" tabindex="-1">å®ç°ä¼˜æƒ åˆ¸ç§’æ€ <a class="header-anchor" href="#å®ç°ä¼˜æƒ åˆ¸ç§’æ€" aria-label="Permalink to &quot;å®ç°ä¼˜æƒ åˆ¸ç§’æ€&quot;">â€‹</a></h3><h4 id="æ·»åŠ ä¼˜æƒ å·" tabindex="-1">æ·»åŠ ä¼˜æƒ å· <a class="header-anchor" href="#æ·»åŠ ä¼˜æƒ å·" aria-label="Permalink to &quot;æ·»åŠ ä¼˜æƒ å·&quot;">â€‹</a></h4><p>æ¯ä¸ªåº—é“ºéƒ½å¯ä»¥å‘å¸ƒä¼˜æƒ åˆ¸ï¼Œåˆ†ä¸ºå¹³ä»·åˆ¸å’Œç‰¹ä»·åˆ¸ã€‚å¹³ä»·åˆ¸å¯ä»¥ä»»æ„è´­ä¹°ï¼Œè€Œç‰¹ä»·åˆ¸éœ€è¦ç§’æ€æŠ¢è´­</p><p><img src="https://mugrain.oss-cn-hangzhou.aliyuncs.com/cswiki/1653365145124.png" alt="1653365145124" loading="lazy"></p><p>è¡¨å…³ç³»å¦‚ä¸‹</p><ul><li><code>tb_voucher</code>ï¼šä¼˜æƒ åˆ¸çš„åŸºæœ¬ä¿¡æ¯ï¼Œä¼˜æƒ é‡‘é¢ã€ä½¿ç”¨è§„åˆ™ç­‰</li><li><code>tb_seckill_voucher</code>ï¼šä¼˜æƒ åˆ¸çš„åº“å­˜ã€å¼€å§‹æŠ¢è´­æ—¶é—´ï¼Œç»“æŸæŠ¢è´­æ—¶é—´ã€‚ç‰¹ä»·ä¼˜æƒ åˆ¸æ‰éœ€è¦å¡«å†™è¿™äº›ä¿¡æ¯</li></ul><br><div class="tip custom-block"><p class="custom-block-title">æç¤º</p><p>å¹³ä»·åˆ¸ç”±äºä¼˜æƒ åŠ›åº¦å¹¶ä¸æ˜¯å¾ˆå¤§ï¼Œæ‰€ä»¥æ˜¯å¯ä»¥ä»»æ„é¢†å–ã€‚è€Œä»£é‡‘åˆ¸ç”±äºä¼˜æƒ åŠ›åº¦å¤§ï¼Œæ‰€ä»¥åƒç¬¬äºŒç§åˆ¸ï¼Œå°±å¾—é™åˆ¶æ•°é‡ï¼Œä»è¡¨ç»“æ„ä¸Šä¹Ÿèƒ½çœ‹å‡ºï¼Œç‰¹ä»·å·é™¤äº†å…·æœ‰ä¼˜æƒ å·çš„åŸºæœ¬ä¿¡æ¯ä»¥å¤–ï¼Œè¿˜å…·æœ‰åº“å­˜ï¼ŒæŠ¢è´­æ—¶é—´ï¼Œç»“æŸæ—¶é—´ç­‰ç­‰å­—æ®µã€‚</p></div><br><p>åœ¨ <code>VoucherController</code> ä¸­æä¾›äº†ä¸€ä¸ªæ¥å£ï¼Œå¯ä»¥æ·»åŠ ç§’æ€ä¼˜æƒ åˆ¸ï¼š</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">RestController</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">RequestMapping</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;/voucher&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> VoucherController</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Resource</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    private</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> IVoucherService voucherService;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    /**</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">     * æ–°å¢ç§’æ€åˆ¸</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">     * </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">@param</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> voucher</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> ä¼˜æƒ åˆ¸ä¿¡æ¯ï¼ŒåŒ…å«ç§’æ€ä¿¡æ¯</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">     * </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">@return</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> ä¼˜æƒ åˆ¸id</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">     */</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">PostMapping</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;seckill&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Result </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">addSeckillVoucher</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">RequestBody</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Voucher </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">voucher</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        voucherService.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">addSeckillVoucher</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(voucher);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Result.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ok</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(voucher.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">());</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    /**</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">     * æ–°å¢æ™®é€šåˆ¸</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">     * </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">@param</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> voucher</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> ä¼˜æƒ åˆ¸ä¿¡æ¯</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">     * </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">@return</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> ä¼˜æƒ åˆ¸id</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">     */</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">PostMapping</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Result </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">addVoucher</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">RequestBody</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Voucher </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">voucher</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        voucherService.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">save</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(voucher);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Result.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ok</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(voucher.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">());</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><br><p><strong>å®ç°ç±»</strong>ï¼š<code>VoucherServiceImpl</code></p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Override</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Transactional</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> addSeckillVoucher</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(Voucher voucher) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // ä¿å­˜ä¼˜æƒ åˆ¸</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    save</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(voucher);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // ä¿å­˜ç§’æ€ä¿¡æ¯</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    SeckillVoucher seckillVoucher </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> SeckillVoucher</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    seckillVoucher.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setVoucherId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(voucher.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">());</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    seckillVoucher.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setStock</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(voucher.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getStock</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">());</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    seckillVoucher.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setBeginTime</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(voucher.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getBeginTime</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">());</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    seckillVoucher.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setEndTime</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(voucher.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getEndTime</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">());</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    seckillVoucherService.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">save</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(seckillVoucher);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // ä¿å­˜ç§’æ€åº“å­˜åˆ°Redisä¸­</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    stringRedisTemplate.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">opsForValue</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">set</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(SECKILL_STOCK_KEY </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> voucher.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(), voucher.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getStock</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">toString</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">());</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><br><h4 id="å®ç°ç§’æ€ä¸‹å•" tabindex="-1">å®ç°ç§’æ€ä¸‹å• <a class="header-anchor" href="#å®ç°ç§’æ€ä¸‹å•" aria-label="Permalink to &quot;å®ç°ç§’æ€ä¸‹å•&quot;">â€‹</a></h4><p>ä¸‹å•æ ¸å¿ƒæ€è·¯ï¼šå½“æˆ‘ä»¬ç‚¹å‡»æŠ¢è´­æ—¶ï¼Œä¼šè§¦å‘å³ä¾§çš„è¯·æ±‚ï¼Œæˆ‘ä»¬åªéœ€è¦ç¼–å†™å¯¹åº”çš„controllerå³å¯ã€‚</p><p>ç”¨æˆ·å¯ä»¥åœ¨åº—é“ºé¡µé¢ä¸­æŠ¢è´­è¿™äº›ä¼˜æƒ åˆ¸ï¼š</p><p><img src="https://mugrain.oss-cn-hangzhou.aliyuncs.com/cswiki/image-20240314095302873.png" alt="image-20240314095302873" loading="lazy"></p><br><p><strong>ç§’æ€ä¸‹å•åº”è¯¥æ€è€ƒçš„å†…å®¹</strong></p><p>ä¸‹å•æ—¶éœ€è¦åˆ¤æ–­ä¸¤ç‚¹ï¼š</p><ul><li>ç§’æ€æ˜¯å¦å¼€å§‹æˆ–ç»“æŸï¼Œå¦‚æœå°šæœªå¼€å§‹æˆ–å·²ç»ç»“æŸåˆ™æ— æ³•ä¸‹å•</li><li>åº“å­˜æ˜¯å¦å……è¶³ï¼Œä¸è¶³åˆ™æ— æ³•ä¸‹å•</li></ul><p>ä¸‹å•æ ¸å¿ƒé€»è¾‘åˆ†æï¼šå½“ç”¨æˆ·å¼€å§‹è¿›è¡Œä¸‹å•ï¼Œæˆ‘ä»¬åº”å½“å»æŸ¥è¯¢ä¼˜æƒ å·ä¿¡æ¯ï¼ŒæŸ¥è¯¢åˆ°ä¼˜æƒ å·ä¿¡æ¯ï¼Œåˆ¤æ–­æ˜¯å¦æ»¡è¶³ç§’æ€æ¡ä»¶ã€‚æ¯”å¦‚æ—¶é—´æ˜¯å¦å……è¶³ï¼Œå¦‚æœæ—¶é—´å……è¶³ï¼Œåˆ™è¿›ä¸€æ­¥åˆ¤æ–­åº“å­˜æ˜¯å¦è¶³å¤Ÿï¼Œå¦‚æœä¸¤è€…éƒ½æ»¡è¶³ï¼Œåˆ™æ‰£å‡åº“å­˜ï¼Œåˆ›å»ºè®¢å•ï¼Œç„¶åè¿”å›è®¢å•idï¼Œå¦‚æœæœ‰ä¸€ä¸ªæ¡ä»¶ä¸æ»¡è¶³åˆ™ç›´æ¥ç»“æŸã€‚</p><p><img src="https://mugrain.oss-cn-hangzhou.aliyuncs.com/cswiki/image-20240314095344655.png" alt="image-20240314095344655" loading="lazy"></p><br><p><strong>å…·ä½“å®ç°ä»£ç </strong>ï¼š<code>VoucherOrderServiceImpl</code></p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">package</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.hmdp.service.impl;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.hmdp.dto.Result;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.hmdp.entity.SeckillVoucher;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.hmdp.entity.VoucherOrder;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.hmdp.mapper.VoucherOrderMapper;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.hmdp.service.ISeckillVoucherService;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.hmdp.service.IVoucherOrderService;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.hmdp.utils.RedisIdWorker;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.hmdp.utils.UserHolder;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> org.springframework.beans.factory.annotation.Autowired;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> org.springframework.stereotype.Service;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> java.time.LocalDateTime;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">/**</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> * &lt;p&gt;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> *  æœåŠ¡å®ç°ç±»</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> * &lt;/p&gt;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> *</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> * </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">@author</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> è™å“¥</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> * </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">@since</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> 2021-12-22</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> */</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Service</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> VoucherOrderServiceImpl</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> extends</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ServiceImpl</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">VoucherOrderMapper</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">VoucherOrder</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">implements</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> IVoucherOrderService</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Autowired</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    private</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ISeckillVoucherService seckillVoucherService;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Autowired</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    private</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> RedisIdWorker redisIdWorker;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Override</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Result </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">seckillVoucher</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(Long </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">voucherId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 1.æŸ¥è¯¢ä¼˜æƒ åˆ¸</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        SeckillVoucher voucher </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> seckillVoucherService.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getById</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(voucherId);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 2.åˆ¤æ–­ç§’æ€æ˜¯å¦å¼€å§‹</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (voucher.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getBeginTime</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">isAfter</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(LocalDateTime.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">now</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">())) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">            // å°šæœªå¼€å§‹</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Result.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">fail</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;ç§’æ€å°šæœªå¼€å§‹ï¼&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 3.åˆ¤æ–­ç§’æ€æ˜¯å¦å·²ç»ç»“æŸ</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (voucher.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getEndTime</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">isBefore</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(LocalDateTime.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">now</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">())) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">            // å°šæœªå¼€å§‹</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Result.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">fail</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;ç§’æ€å·²ç»ç»“æŸï¼&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 4.åˆ¤æ–­åº“å­˜æ˜¯å¦å……è¶³</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (voucher.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getStock</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">            // åº“å­˜ä¸è¶³</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Result.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">fail</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;åº“å­˜ä¸è¶³ï¼&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 5.æ‰£å‡åº“å­˜</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        boolean</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> success </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> seckillVoucherService.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">update</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setSql</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;stock = stock -1&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">eq</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;voucher_id&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, voucherId)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">update</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">success) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">            //æ‰£å‡åº“å­˜</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Result.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">fail</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;åº“å­˜ä¸è¶³ï¼&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        //6.åˆ›å»ºè®¢å•</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        VoucherOrder voucherOrder </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> VoucherOrder</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 6.1.è®¢å•id</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        long</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> orderId </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> redisIdWorker.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">nextId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;order&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        voucherOrder.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(orderId);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 6.2.ç”¨æˆ·id</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        Long userId </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> UserHolder.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getUser</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        voucherOrder.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setUserId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(userId);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 6.3.ä»£é‡‘åˆ¸id</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        voucherOrder.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setVoucherId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(voucherId);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        save</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(voucherOrder);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Result.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ok</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(orderId);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><br><h4 id="åº“å­˜è¶…å–é—®é¢˜" tabindex="-1">åº“å­˜è¶…å–é—®é¢˜ <a class="header-anchor" href="#åº“å­˜è¶…å–é—®é¢˜" aria-label="Permalink to &quot;åº“å­˜è¶…å–é—®é¢˜&quot;">â€‹</a></h4><p>æœ‰å…³è¶…å–é—®é¢˜åˆ†æï¼šåœ¨æˆ‘ä»¬åŸæœ‰ä»£ç ä¸­æ˜¯è¿™ä¹ˆå†™çš„</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 4.åˆ¤æ–­åº“å­˜æ˜¯å¦å……è¶³</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (voucher.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getStock</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // åº“å­˜ä¸è¶³</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Result.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">fail</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;åº“å­˜ä¸è¶³ï¼&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 5.æ‰£å‡åº“å­˜</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">boolean</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> success </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> seckillVoucherService.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">update</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setSql</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;stock = stock - 1&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">eq</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;voucher_id&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, voucherId)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  			.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">update</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">success) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    //æ‰£å‡åº“å­˜</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Result.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">fail</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;åº“å­˜ä¸è¶³ï¼&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>å‡è®¾çº¿ç¨‹1è¿‡æ¥æŸ¥è¯¢åº“å­˜ï¼Œåˆ¤æ–­å‡ºæ¥åº“å­˜å¤§äº1ï¼Œæ­£å‡†å¤‡å»æ‰£å‡åº“å­˜ï¼Œä½†æ˜¯è¿˜æ²¡æœ‰æ¥å¾—åŠå»æ‰£å‡ï¼Œæ­¤æ—¶çº¿ç¨‹2è¿‡æ¥ï¼Œçº¿ç¨‹2ä¹Ÿå»æŸ¥è¯¢åº“å­˜ï¼Œå‘ç°è¿™ä¸ªæ•°é‡ä¸€å®šä¹Ÿå¤§äº1ï¼Œé‚£ä¹ˆè¿™ä¸¤ä¸ªçº¿ç¨‹éƒ½ä¼šå»æ‰£å‡åº“å­˜ï¼Œæœ€ç»ˆå¤šä¸ªçº¿ç¨‹ç›¸å½“äºä¸€èµ·å»æ‰£å‡åº“å­˜ï¼Œæ­¤æ—¶å°±ä¼šå‡ºç°åº“å­˜çš„è¶…å–é—®é¢˜ã€‚</p><p><img src="https://mugrain.oss-cn-hangzhou.aliyuncs.com/cswiki/image-20240314095523839.png" alt="image-20240314095523839" loading="lazy"></p><p>è¶…å–é—®é¢˜æ˜¯å…¸å‹çš„å¤šçº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Œé’ˆå¯¹è¿™ä¸€é—®é¢˜çš„å¸¸è§è§£å†³æ–¹æ¡ˆå°±æ˜¯åŠ é”ã€‚</p><br><p>è€Œå¯¹äºåŠ é”ï¼Œæˆ‘ä»¬é€šå¸¸æœ‰ä¸¤ç§è§£å†³æ–¹æ¡ˆï¼š</p><p><img src="https://mugrain.oss-cn-hangzhou.aliyuncs.com/cswiki/image-20240314095540521.png" alt="image-20240314095540521" loading="lazy"></p><p><strong>æ‚²è§‚é”</strong>ï¼šå¯ä»¥å®ç°å¯¹äºæ•°æ®çš„ä¸²è¡ŒåŒ–æ‰§è¡Œï¼Œæ¯”å¦‚ synï¼Œå’Œ Lock éƒ½æ˜¯æ‚²è§‚é”çš„ä»£è¡¨ï¼ŒåŒæ—¶ï¼Œæ‚²è§‚é”ä¸­åˆå¯ä»¥å†ç»†åˆ†ä¸ºå…¬å¹³é”ï¼Œéå…¬å¹³é”ï¼Œå¯é‡å…¥é”ï¼Œç­‰ç­‰</p><p><strong>ä¹è§‚é”</strong>ï¼šä¼šæœ‰ä¸€ä¸ªç‰ˆæœ¬å·ï¼Œæ¯æ¬¡æ“ä½œæ•°æ®ä¼šå¯¹ç‰ˆæœ¬å·+1ï¼Œå†æäº¤å›æ•°æ®æ—¶ï¼Œä¼šå»æ ¡éªŒæ˜¯å¦æ¯”ä¹‹å‰çš„ç‰ˆæœ¬å¤§1 ï¼Œå¦‚æœå¤§1 ï¼Œåˆ™è¿›è¡Œæ“ä½œæˆåŠŸï¼Œè¿™å¥—æœºåˆ¶çš„æ ¸å¿ƒé€»è¾‘åœ¨äºï¼Œå¦‚æœåœ¨æ“ä½œè¿‡ç¨‹ä¸­ï¼Œç‰ˆæœ¬å·åªæ¯”åŸæ¥å¤§1 ï¼Œé‚£ä¹ˆå°±æ„å‘³ç€æ“ä½œè¿‡ç¨‹ä¸­æ²¡æœ‰äººå¯¹ä»–è¿›è¡Œè¿‡ä¿®æ”¹ï¼Œä»–çš„æ“ä½œå°±æ˜¯å®‰å…¨çš„ï¼Œå¦‚æœä¸å¤§1ï¼Œåˆ™æ•°æ®è¢«ä¿®æ”¹è¿‡ï¼Œå½“ç„¶ä¹è§‚é”è¿˜æœ‰ä¸€äº›å˜ç§çš„å¤„ç†æ–¹å¼æ¯”å¦‚ CASã€‚</p><ul><li>ä¹è§‚é”çš„å…¸å‹ä»£è¡¨ï¼šå°±æ˜¯ CASï¼Œåˆ©ç”¨ CAS è¿›è¡Œæ— é”åŒ–æœºåˆ¶åŠ é”ï¼Œvar5 æ˜¯æ“ä½œå‰è¯»å–çš„å†…å­˜å€¼ï¼Œwhile ä¸­çš„ var1+var2 æ˜¯é¢„ä¼°å€¼ï¼Œå¦‚æœé¢„ä¼°å€¼ == å†…å­˜å€¼ï¼Œåˆ™ä»£è¡¨ä¸­é—´æ²¡æœ‰è¢«äººä¿®æ”¹è¿‡ï¼Œæ­¤æ—¶å°±å°†æ–°å€¼å»æ›¿æ¢å†…å­˜å€¼ã€‚</li></ul><br><p>å…¶ä¸­ <code>do while</code> æ˜¯ä¸ºäº†åœ¨æ“ä½œå¤±è´¥æ—¶ï¼Œå†æ¬¡è¿›è¡Œè‡ªæ—‹æ“ä½œï¼Œå³æŠŠä¹‹å‰çš„é€»è¾‘å†æ“ä½œä¸€æ¬¡ã€‚</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> var5;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    var5 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getIntVolatile</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(var1, var2);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">} </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">while</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">compareAndSwapInt</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(var1, var2, var5, var5 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> var4));</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> var5;</span></span></code></pre></div><br><p><strong>è¯¾ç¨‹ä¸­çš„ä½¿ç”¨æ–¹å¼</strong>æ˜¯æ²¡æœ‰åƒ CAS ä¸€æ ·å¸¦è‡ªæ—‹çš„æ“ä½œï¼Œä¹Ÿæ²¡æœ‰å¯¹ version çš„ç‰ˆæœ¬å·+1 ï¼Œä»–çš„æ“ä½œé€»è¾‘æ˜¯åœ¨æ“ä½œæ—¶ï¼Œå¯¹ç‰ˆæœ¬å·è¿›è¡Œ+1 æ“ä½œï¼Œç„¶åè¦æ±‚version å¦‚æœæ˜¯1 çš„æƒ…å†µä¸‹ï¼Œæ‰èƒ½æ“ä½œï¼Œé‚£ä¹ˆç¬¬ä¸€ä¸ªçº¿ç¨‹åœ¨æ“ä½œåï¼Œæ•°æ®åº“ä¸­çš„ version å˜æˆäº†2ï¼Œä½†æ˜¯ä»–è‡ªå·±æ»¡è¶³ version=1 ï¼Œæ‰€ä»¥æ²¡æœ‰é—®é¢˜ï¼Œæ­¤æ—¶çº¿ç¨‹2æ‰§è¡Œï¼Œçº¿ç¨‹2 æœ€åä¹Ÿéœ€è¦åŠ ä¸Šæ¡ä»¶ version =1 ï¼Œä½†æ˜¯ç°åœ¨ç”±äºçº¿ç¨‹1å·²ç»æ“ä½œè¿‡äº†ï¼Œæ‰€ä»¥çº¿ç¨‹2ï¼Œæ“ä½œæ—¶å°±ä¸æ»¡è¶³ version=1 çš„æ¡ä»¶äº†ï¼Œæ‰€ä»¥çº¿ç¨‹2æ— æ³•æ‰§è¡ŒæˆåŠŸã€‚</p><br><p>ä¹è§‚é”çš„å…³é”®æ˜¯åˆ¤æ–­ä¹‹å‰æŸ¥è¯¢å¾—åˆ°çš„æ•°æ®æ˜¯å¦æœ‰è¢«ä¿®æ”¹è¿‡ï¼Œå¸¸è§çš„æ–¹å¼æœ‰ä¸¤ç§ï¼š</p><p><img src="https://mugrain.oss-cn-hangzhou.aliyuncs.com/cswiki/image-20240314095639161.png" alt="image-20240314095639161" loading="lazy"></p><p><img src="https://mugrain.oss-cn-hangzhou.aliyuncs.com/cswiki/image-20240314095726103.png" alt="image-20240314095726103" loading="lazy"></p><div class="warning custom-block"><p class="custom-block-title">æ€»ç»“ï¼šè¶…å–è¿™æ ·çš„çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Œè§£å†³æ–¹æ¡ˆæœ‰å“ªäº›ï¼Ÿ</p><ul><li>æ‚²è§‚é”ï¼šæ·»åŠ åŒæ­¥é”ï¼Œè®©çº¿ç¨‹ä¸²è¡Œæ‰§è¡Œã€‚ç®€å•ç²—æš´ç¼ºç‚¹ä½†æ€§èƒ½ä¸€èˆ¬</li><li>ä¹è§‚é”ï¼šä¸åŠ é”ï¼Œåœ¨æ›´æ–°æ—¶åˆ¤æ–­æ˜¯å¦æœ‰å…¶å®ƒçº¿ç¨‹åœ¨ä¿®æ”¹ã€‚æ€§èƒ½å¥½ä½†æˆåŠŸç‡ä½</li></ul></div><br><p><strong>ä¹è§‚é”è§£å†³è¶…å–é—®é¢˜</strong></p><p><strong>æ–¹æ¡ˆä¸€</strong>ï¼šVoucherOrderServiceImpl åœ¨æ‰£å‡åº“å­˜æ—¶ï¼Œæ”¹ä¸ºï¼š</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// æ‰£å‡åº“å­˜  set stock = stock -1 where id = ï¼Ÿ and stock = ?</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">boolean</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> success </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> seckillVoucherService.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">update</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setSql</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;stock = stock - 1&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">eq</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;voucher_id&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, voucherId)</span></span>
<span class="line highlighted"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">eq</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;stock&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, voucher.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getStock</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">())</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">update</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span></code></pre></div><div class="info custom-block"><p class="custom-block-title">ä»¥ä¸Šé€»è¾‘çš„æ ¸å¿ƒå«ä¹‰æ˜¯ï¼šåªè¦æˆ‘æ‰£å‡åº“å­˜æ—¶çš„åº“å­˜å’Œä¹‹å‰æˆ‘æŸ¥è¯¢åˆ°çš„åº“å­˜æ˜¯ä¸€æ ·çš„ï¼Œå°±æ„å‘³ç€æ²¡æœ‰äººåœ¨ä¸­é—´ä¿®æ”¹è¿‡åº“å­˜ï¼Œé‚£ä¹ˆæ­¤æ—¶å°±æ˜¯å®‰å…¨çš„ï¼Œä½†æ˜¯ä»¥ä¸Šè¿™ç§æ–¹å¼é€šè¿‡æµ‹è¯•å‘ç°ä¼šæœ‰å¾ˆå¤šå¤±è´¥çš„æƒ…å†µï¼Œå¤±è´¥çš„åŸå› åœ¨äºï¼šåœ¨ä½¿ç”¨ä¹è§‚é”è¿‡ç¨‹ä¸­å‡è®¾100ä¸ªçº¿ç¨‹åŒæ—¶éƒ½æ‹¿åˆ°äº†100çš„åº“å­˜ï¼Œç„¶åå¤§å®¶ä¸€èµ·å»è¿›è¡Œæ‰£å‡ï¼Œä½†æ˜¯100ä¸ªäººä¸­åªæœ‰1ä¸ªäººèƒ½æ‰£å‡æˆåŠŸï¼Œå…¶ä»–çš„äººåœ¨å¤„ç†æ—¶ï¼Œä»–ä»¬åœ¨æ‰£å‡æ—¶ï¼Œåº“å­˜å·²ç»è¢«ä¿®æ”¹è¿‡äº†ï¼Œæ‰€ä»¥æ­¤æ—¶å…¶ä»–çº¿ç¨‹éƒ½ä¼šå¤±è´¥</p></div><br><p><strong>æ–¹æ¡ˆäºŒ</strong>ï¼šä¹‹å‰çš„æ–¹å¼è¦ä¿®æ”¹å‰åéƒ½ä¿æŒä¸€è‡´ï¼Œä½†æ˜¯è¿™æ ·æˆ‘ä»¬åˆ†æè¿‡ï¼ŒæˆåŠŸçš„æ¦‚ç‡å¤ªä½ï¼Œæ‰€ä»¥æˆ‘ä»¬çš„ä¹è§‚é”éœ€è¦å˜ä¸€ä¸‹ï¼Œæ”¹æˆ stock å¤§äº0 å³å¯</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// æ‰£å‡åº“å­˜  set stock = stock - 1 where id = ï¼Ÿ and stock &gt; 0</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">boolean</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> success </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> seckillVoucherService.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">update</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setSql</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;stock = stock - 1&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">eq</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;voucher_id&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, voucherId)</span></span>
<span class="line highlighted"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">eq</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;stock&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">update</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span></code></pre></div><div class="warning custom-block"><p class="custom-block-title">ğŸ’¡æ‰©å±•</p><p>é’ˆå¯¹ CAS ä¸­çš„è‡ªæ—‹å‹åŠ›è¿‡å¤§ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ Longaddr è¿™ä¸ªç±»å»è§£å†³ã€‚Java8 æä¾›çš„ä¸€ä¸ªå¯¹AtomicLongæ”¹è¿›åçš„ä¸€ä¸ªç±»ï¼ŒLongAdderã€‚å¤§é‡çº¿ç¨‹å¹¶å‘æ›´æ–°ä¸€ä¸ªåŸå­æ€§çš„æ—¶å€™ï¼Œå¤©ç„¶çš„é—®é¢˜å°±æ˜¯è‡ªæ—‹ï¼Œä¼šå¯¼è‡´å¹¶å‘æ€§é—®é¢˜ï¼Œå½“ç„¶è¿™ä¹Ÿæ¯”æˆ‘ä»¬ç›´æ¥ä½¿ç”¨synæ¥çš„å¥½ã€‚æ‰€ä»¥åˆ©ç”¨è¿™ä¹ˆä¸€ä¸ªç±»ï¼ŒLongAdderæ¥è¿›è¡Œä¼˜åŒ–ã€‚å¦‚æœè·å–æŸä¸ªå€¼ï¼Œåˆ™ä¼šå¯¹ cell å’Œ base çš„å€¼è¿›è¡Œé€’å¢ï¼Œæœ€åè¿”å›ä¸€ä¸ªå®Œæ•´çš„å€¼</p><p><img src="https://mugrain.oss-cn-hangzhou.aliyuncs.com/cswiki/1653370271627.png" alt="1653370271627" loading="lazy"></p></div><br><h4 id="å®ç°ä¸€äººä¸€å•" tabindex="-1">å®ç°ä¸€äººä¸€å• <a class="header-anchor" href="#å®ç°ä¸€äººä¸€å•" aria-label="Permalink to &quot;å®ç°ä¸€äººä¸€å•&quot;">â€‹</a></h4><p>éœ€æ±‚ï¼šä¿®æ”¹ç§’æ€ä¸šåŠ¡ï¼Œè¦æ±‚åŒä¸€ä¸ªä¼˜æƒ åˆ¸ï¼Œä¸€ä¸ªç”¨æˆ·åªèƒ½ä¸‹ä¸€å•</p><p><strong>ç°åœ¨çš„é—®é¢˜åœ¨äºï¼š</strong></p><p>ä¼˜æƒ å·æ˜¯ä¸ºäº†å¼•æµï¼Œä½†æ˜¯ç›®å‰çš„æƒ…å†µæ˜¯ï¼Œä¸€ä¸ªäººå¯ä»¥æ— é™åˆ¶çš„æŠ¢è¿™ä¸ªä¼˜æƒ å·ï¼Œæ‰€ä»¥æˆ‘ä»¬åº”å½“å¢åŠ ä¸€å±‚é€»è¾‘ï¼Œè®©ä¸€ä¸ªç”¨æˆ·åªèƒ½ä¸‹ä¸€ä¸ªå•ï¼Œè€Œä¸æ˜¯è®©ä¸€ä¸ªç”¨æˆ·ä¸‹å¤šä¸ªå•</p><p>å…·ä½“æ“ä½œé€»è¾‘å¦‚ä¸‹ï¼šæ¯”å¦‚æ—¶é—´æ˜¯å¦å……è¶³ï¼Œå¦‚æœæ—¶é—´å……è¶³ï¼Œåˆ™è¿›ä¸€æ­¥åˆ¤æ–­åº“å­˜æ˜¯å¦è¶³å¤Ÿï¼Œç„¶åå†æ ¹æ®ä¼˜æƒ å·idå’Œç”¨æˆ·idæŸ¥è¯¢æ˜¯å¦å·²ç»ä¸‹è¿‡è¿™ä¸ªè®¢å•ï¼Œå¦‚æœä¸‹è¿‡è¿™ä¸ªè®¢å•ï¼Œåˆ™ä¸å†ä¸‹å•ï¼Œå¦åˆ™è¿›è¡Œä¸‹å•</p><p><img src="https://mugrain.oss-cn-hangzhou.aliyuncs.com/cswiki/image-20240314100610881.png" alt="image-20240314100610881" loading="lazy"></p><br><p><strong>å…·ä½“å®ç°</strong>ï¼š<code>VoucherOrderServiceImpl</code></p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Override</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Result </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">seckillVoucher</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(Long voucherId) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 1.æŸ¥è¯¢ä¼˜æƒ åˆ¸</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    SeckillVoucher voucher </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> seckillVoucherService.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getById</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(voucherId);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 2.åˆ¤æ–­ç§’æ€æ˜¯å¦å¼€å§‹</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (voucher.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getBeginTime</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">isAfter</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(LocalDateTime.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">now</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">())) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // å°šæœªå¼€å§‹</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Result.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">fail</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;ç§’æ€å°šæœªå¼€å§‹ï¼&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 3.åˆ¤æ–­ç§’æ€æ˜¯å¦å·²ç»ç»“æŸ</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (voucher.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getEndTime</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">isBefore</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(LocalDateTime.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">now</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">())) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // å°šæœªå¼€å§‹</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Result.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">fail</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;ç§’æ€å·²ç»ç»“æŸï¼&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 4.åˆ¤æ–­åº“å­˜æ˜¯å¦å……è¶³</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (voucher.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getStock</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // åº“å­˜ä¸è¶³</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Result.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">fail</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;åº“å­˜ä¸è¶³ï¼&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line highlighted"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // æ–°å¢ä¸€äººä¸€å•é€»è¾‘</span></span>
<span class="line highlighted"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    Long userId </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> UserHolder.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getUser</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line highlighted"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> count </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> query</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">eq</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;user_id&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, userId)</span></span>
<span class="line highlighted"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">eq</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;voucher_id&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, voucherId)</span></span>
<span class="line highlighted"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">count</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line highlighted"><wbr></span>
<span class="line highlighted"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (count </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line highlighted"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Result.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">fail</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;ç”¨æˆ·å·²ç»è´­ä¹°è¿‡ä¸€æ¬¡ï¼&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line highlighted"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 5.æ‰£å‡åº“å­˜  set stock = stock - 1 where id = ï¼Ÿ and stock &gt; 0</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    boolean</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> success </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> seckillVoucherService.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">update</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setSql</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;stock = stock - 1&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">eq</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;voucher_id&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, voucherId)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">eq</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;stock&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">update</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">success) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        //æ‰£å‡åº“å­˜</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Result.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">fail</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;åº“å­˜ä¸è¶³ï¼&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    //6.åˆ›å»ºè®¢å•</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    VoucherOrder voucherOrder </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> VoucherOrder</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 6.1.è®¢å•id</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    long</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> orderId </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> redisIdWorker.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">nextId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;order&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    voucherOrder.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(orderId);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 6.2.ç”¨æˆ·id</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    voucherOrder.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setUserId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(userId);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 6.3.ä»£é‡‘åˆ¸id</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    voucherOrder.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setVoucherId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(voucherId);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    save</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(voucherOrder);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Result.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ok</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(orderId);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><div class="danger custom-block"><p class="custom-block-title">ğŸš¨ å­˜åœ¨é—®é¢˜ï¼šç°åœ¨çš„é—®é¢˜è¿˜æ˜¯å’Œä¹‹å‰ä¸€æ ·ï¼Œå¹¶å‘è¿‡æ¥ï¼ŒæŸ¥è¯¢æ•°æ®åº“ï¼Œéƒ½ä¸å­˜åœ¨è®¢å•ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿˜æ˜¯éœ€è¦åŠ é”ï¼Œä½†æ˜¯ä¹è§‚é”æ¯”è¾ƒé€‚åˆæ›´æ–°æ•°æ®ï¼Œè€Œç°åœ¨æ˜¯æ’å…¥æ•°æ®ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä½¿ç”¨æ‚²è§‚é”æ“ä½œã€‚</p></div><br><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">package</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.hmdp.service.impl;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.hmdp.dto.Result;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.hmdp.entity.SeckillVoucher;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.hmdp.entity.VoucherOrder;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.hmdp.mapper.VoucherOrderMapper;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.hmdp.service.ISeckillVoucherService;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.hmdp.service.IVoucherOrderService;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.hmdp.utils.RedisIdWorker;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.hmdp.utils.UserHolder;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> org.springframework.beans.factory.annotation.Autowired;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> org.springframework.stereotype.Service;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> org.springframework.transaction.annotation.Transactional;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> java.time.LocalDateTime;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">/**</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> * &lt;p&gt;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> *  æœåŠ¡å®ç°ç±»</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> * &lt;/p&gt;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> *</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> * </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">@author</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> è™å“¥</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> * </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">@since</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> 2021-12-22</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> */</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Service</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> VoucherOrderServiceImpl</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> extends</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ServiceImpl</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">VoucherOrderMapper</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">VoucherOrder</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">implements</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> IVoucherOrderService</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Autowired</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    private</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ISeckillVoucherService seckillVoucherService;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Autowired</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    private</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> RedisIdWorker redisIdWorker;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Override</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Result </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">seckillVoucher</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(Long </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">voucherId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 1.æŸ¥è¯¢ä¼˜æƒ åˆ¸</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        SeckillVoucher voucher </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> seckillVoucherService.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getById</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(voucherId);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 2.åˆ¤æ–­ç§’æ€æ˜¯å¦å¼€å§‹</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (voucher.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getBeginTime</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">isAfter</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(LocalDateTime.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">now</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">())) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">            // å°šæœªå¼€å§‹</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Result.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">fail</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;ç§’æ€å°šæœªå¼€å§‹ï¼&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 3.åˆ¤æ–­ç§’æ€æ˜¯å¦å·²ç»ç»“æŸ</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (voucher.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getEndTime</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">isBefore</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(LocalDateTime.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">now</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">())) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">            // å°šæœªå¼€å§‹</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Result.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">fail</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;ç§’æ€å·²ç»ç»“æŸï¼&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 4.åˆ¤æ–­åº“å­˜æ˜¯å¦å……è¶³</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (voucher.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getStock</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">            // åº“å­˜ä¸è¶³</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Result.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">fail</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;åº“å­˜ä¸è¶³ï¼&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"></span>
<span class="line highlighted"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> createVoucherOrder</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(voucherId);</span></span>
<span class="line highlighted"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line highlighted"><wbr></span>
<span class="line highlighted"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Transactional</span></span>
<span class="line highlighted"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> synchronized</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Result </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">createVoucherOrder</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(Long </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">voucherId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line highlighted"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // æ–°å¢ä¸€äººä¸€å•é€»è¾‘</span></span>
<span class="line highlighted"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        Long userId </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> UserHolder.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getUser</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line highlighted"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> count </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> query</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">eq</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;user_id&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, userId)</span></span>
<span class="line highlighted"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">eq</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;voucher_id&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, voucherId)</span></span>
<span class="line highlighted"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">count</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line highlighted"><wbr></span>
<span class="line highlighted"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (count </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line highlighted"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Result.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">fail</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;ç”¨æˆ·å·²ç»è´­ä¹°è¿‡ä¸€æ¬¡ï¼&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line highlighted"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line highlighted"><wbr></span>
<span class="line highlighted"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 5.æ‰£å‡åº“å­˜  set stock = stock - 1 where id = ï¼Ÿ and stock &gt; 0</span></span>
<span class="line highlighted"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        boolean</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> success </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> seckillVoucherService.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">update</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line highlighted"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setSql</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;stock = stock - 1&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line highlighted"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">eq</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;voucher_id&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, voucherId)</span></span>
<span class="line highlighted"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">eq</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;stock&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line highlighted"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">update</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line highlighted"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">success) {</span></span>
<span class="line highlighted"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">            //æ‰£å‡åº“å­˜</span></span>
<span class="line highlighted"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Result.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">fail</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;åº“å­˜ä¸è¶³ï¼&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line highlighted"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line highlighted"><wbr></span>
<span class="line highlighted"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        //6.åˆ›å»ºè®¢å•</span></span>
<span class="line highlighted"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        VoucherOrder voucherOrder </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> VoucherOrder</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line highlighted"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 6.1.è®¢å•id</span></span>
<span class="line highlighted"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        long</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> orderId </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> redisIdWorker.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">nextId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;order&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line highlighted"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        voucherOrder.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(orderId);</span></span>
<span class="line highlighted"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 6.2.ç”¨æˆ·id</span></span>
<span class="line highlighted"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        voucherOrder.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setUserId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(userId);</span></span>
<span class="line highlighted"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 6.3.ä»£é‡‘åˆ¸id</span></span>
<span class="line highlighted"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        voucherOrder.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setVoucherId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(voucherId);</span></span>
<span class="line highlighted"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        save</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(voucherOrder);</span></span>
<span class="line highlighted"><wbr></span>
<span class="line highlighted"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Result.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ok</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(orderId);</span></span>
<span class="line highlighted"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line highlighted"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><div class="warning custom-block"><p class="custom-block-title">ğŸ’¡ æ³¨æ„ï¼šåœ¨è¿™é‡Œæåˆ°äº†éå¸¸å¤šçš„é—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦æ…¢æ…¢çš„æ¥æ€è€ƒï¼Œé¦–å…ˆæˆ‘ä»¬çš„åˆå§‹æ–¹æ¡ˆæ˜¯å°è£…äº†ä¸€ä¸ª <code>createVoucherOrder</code> æ–¹æ³•ï¼ŒåŒæ—¶ä¸ºäº†ç¡®ä¿ä»–çº¿ç¨‹å®‰å…¨ï¼Œåœ¨æ–¹æ³•ä¸Šæ·»åŠ äº†ä¸€æŠŠ<code>synchronized</code> é”ä½†æ˜¯è¿™æ ·æ·»åŠ é”ï¼Œé”çš„ç²’åº¦å¤ªç²—äº†ï¼Œåœ¨ä½¿ç”¨é”è¿‡ç¨‹ä¸­ï¼Œæ§åˆ¶é”ç²’åº¦æ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„äº‹æƒ…ï¼Œå› ä¸ºå¦‚æœé”çš„ç²’åº¦å¤ªå¤§ï¼Œä¼šå¯¼è‡´æ¯ä¸ªçº¿ç¨‹è¿›æ¥éƒ½ä¼šé”ä½ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å»æ§åˆ¶é”çš„ç²’åº¦ï¼Œä»¥ä¸‹è¿™æ®µä»£ç éœ€è¦ä¿®æ”¹ä¸ºï¼š<code>intern()</code> è¿™ä¸ªæ–¹æ³•æ˜¯ä»å¸¸é‡æ± ä¸­æ‹¿åˆ°æ•°æ®ï¼Œå¦‚æœæˆ‘ä»¬ç›´æ¥ä½¿ç”¨ <code>userId.toString()</code> ä»–æ‹¿åˆ°çš„å¯¹è±¡å®é™…ä¸Šæ˜¯ä¸åŒçš„å¯¹è±¡ï¼Œnewå‡ºæ¥çš„å¯¹è±¡ï¼Œæˆ‘ä»¬ä½¿ç”¨é”å¿…é¡»ä¿è¯é”å¿…é¡»æ˜¯åŒä¸€æŠŠï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä½¿ç”¨ <code>intern()</code> æ–¹æ³•ã€‚</p></div><br><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Transactional</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Result </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">createVoucherOrder</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(Long voucherId) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    Long userId </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> UserHolder.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getUser</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    synchronized</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (userId.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">toString</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">intern</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // æ–°å¢ä¸€äººä¸€å•é€»è¾‘</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> count </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> query</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">eq</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;user_id&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, userId)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">eq</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;voucher_id&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, voucherId)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">count</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (count </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Result.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">fail</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;ç”¨æˆ·å·²ç»è´­ä¹°è¿‡ä¸€æ¬¡ï¼&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 5.æ‰£å‡åº“å­˜  set stock = stock - 1 where id = ï¼Ÿ and stock &gt; 0</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        boolean</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> success </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> seckillVoucherService.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">update</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setSql</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;stock = stock - 1&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">eq</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;voucher_id&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, voucherId)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">eq</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;stock&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">update</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">success) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">            //æ‰£å‡åº“å­˜</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Result.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">fail</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;åº“å­˜ä¸è¶³ï¼&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        //6.åˆ›å»ºè®¢å•</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        VoucherOrder voucherOrder </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> VoucherOrder</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 6.1.è®¢å•id</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        long</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> orderId </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> redisIdWorker.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">nextId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;order&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        voucherOrder.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(orderId);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 6.2.ç”¨æˆ·id</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        voucherOrder.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setUserId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(userId);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 6.3.ä»£é‡‘åˆ¸id</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        voucherOrder.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setVoucherId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(voucherId);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        save</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(voucherOrder);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Result.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ok</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(orderId);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>ä½†æ˜¯ä»¥ä¸Šä»£ç è¿˜æ˜¯å­˜åœ¨é—®é¢˜ï¼Œé—®é¢˜çš„åŸå› åœ¨äºå½“å‰æ–¹æ³•è¢« Spring çš„äº‹åŠ¡æ§åˆ¶ï¼Œå¦‚æœä½ åœ¨æ–¹æ³•å†…éƒ¨åŠ é”ï¼Œå¯èƒ½ä¼šå¯¼è‡´å½“å‰æ–¹æ³•äº‹åŠ¡è¿˜æ²¡æœ‰æäº¤ï¼Œä½†æ˜¯é”å·²ç»é‡Šæ”¾ä¹Ÿä¼šå¯¼è‡´é—®é¢˜ï¼Œæ‰€ä»¥æˆ‘ä»¬é€‰æ‹©å°†å½“å‰æ–¹æ³•æ•´ä½“åŒ…è£¹èµ·æ¥ï¼Œç¡®ä¿äº‹åŠ¡ä¸ä¼šå‡ºç°é—®é¢˜ã€‚å¦‚ä¸‹ï¼šåœ¨ <code>seckillVoucher</code> æ–¹æ³•ä¸­ï¼Œæ·»åŠ ä»¥ä¸‹é€»è¾‘ï¼Œè¿™æ ·å°±èƒ½ä¿è¯äº‹åŠ¡çš„ç‰¹æ€§ï¼ŒåŒæ—¶ä¹Ÿæ§åˆ¶äº†é”çš„ç²’åº¦ã€‚</p><div class="language-Java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">Java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">package</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.hmdp.service.impl;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.hmdp.dto.Result;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.hmdp.entity.SeckillVoucher;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.hmdp.entity.VoucherOrder;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.hmdp.mapper.VoucherOrderMapper;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.hmdp.service.ISeckillVoucherService;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.hmdp.service.IVoucherOrderService;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.hmdp.utils.RedisIdWorker;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.hmdp.utils.UserHolder;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> org.springframework.beans.factory.annotation.Autowired;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> org.springframework.stereotype.Service;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> org.springframework.transaction.annotation.Transactional;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> java.time.LocalDateTime;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">/**</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> * &lt;p&gt;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> * æœåŠ¡å®ç°ç±»</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> * &lt;/p&gt;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> *</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> * </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">@author</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> è™å“¥</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> * </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">@since</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> 2021-12-22</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> */</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Service</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> VoucherOrderServiceImpl</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> extends</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ServiceImpl</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">VoucherOrderMapper</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">VoucherOrder</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">implements</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> IVoucherOrderService</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Autowired</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    private</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ISeckillVoucherService seckillVoucherService;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Autowired</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    private</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> RedisIdWorker redisIdWorker;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Override</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Result </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">seckillVoucher</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(Long </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">voucherId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 1.æŸ¥è¯¢ä¼˜æƒ åˆ¸</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        SeckillVoucher voucher </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> seckillVoucherService.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getById</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(voucherId);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 2.åˆ¤æ–­ç§’æ€æ˜¯å¦å¼€å§‹</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (voucher.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getBeginTime</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">isAfter</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(LocalDateTime.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">now</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">())) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">            // å°šæœªå¼€å§‹</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Result.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">fail</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;ç§’æ€å°šæœªå¼€å§‹ï¼&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 3.åˆ¤æ–­ç§’æ€æ˜¯å¦å·²ç»ç»“æŸ</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (voucher.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getEndTime</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">isBefore</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(LocalDateTime.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">now</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">())) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">            // å°šæœªå¼€å§‹</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Result.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">fail</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;ç§’æ€å·²ç»ç»“æŸï¼&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 4.åˆ¤æ–­åº“å­˜æ˜¯å¦å……è¶³</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (voucher.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getStock</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">            // åº“å­˜ä¸è¶³</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Result.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">fail</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;åº“å­˜ä¸è¶³ï¼&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"></span>
<span class="line highlighted"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        Long userId </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> UserHolder.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getUser</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line highlighted"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        synchronized</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (userId.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">toString</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">intern</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()) {</span></span>
<span class="line highlighted"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">createVoucherOrder</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(voucherId);</span></span>
<span class="line highlighted"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line highlighted"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line highlighted"><wbr></span>
<span class="line highlighted"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Transactional</span></span>
<span class="line highlighted"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Result </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">createVoucherOrder</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(Long </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">voucherId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line highlighted"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        Long userId </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> UserHolder.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getUser</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line highlighted"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // æ–°å¢ä¸€äººä¸€å•é€»è¾‘</span></span>
<span class="line highlighted"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> count </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> query</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">eq</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;user_id&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, userId)</span></span>
<span class="line highlighted"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">eq</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;voucher_id&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, voucherId)</span></span>
<span class="line highlighted"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">count</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line highlighted"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (count </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line highlighted"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Result.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">fail</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;ç”¨æˆ·å·²ç»è´­ä¹°è¿‡ä¸€æ¬¡ï¼&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line highlighted"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line highlighted"><wbr></span>
<span class="line highlighted"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 5.æ‰£å‡åº“å­˜  set stock = stock - 1 where id = ï¼Ÿ and stock &gt; 0</span></span>
<span class="line highlighted"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        boolean</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> success </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> seckillVoucherService.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">update</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line highlighted"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setSql</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;stock = stock - 1&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line highlighted"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">eq</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;voucher_id&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, voucherId)</span></span>
<span class="line highlighted"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">eq</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;stock&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line highlighted"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">update</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line highlighted"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">success) {</span></span>
<span class="line highlighted"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">            //æ‰£å‡åº“å­˜</span></span>
<span class="line highlighted"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Result.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">fail</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;åº“å­˜ä¸è¶³ï¼&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line highlighted"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line highlighted"><wbr></span>
<span class="line highlighted"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        //6.åˆ›å»ºè®¢å•</span></span>
<span class="line highlighted"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        VoucherOrder voucherOrder </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> VoucherOrder</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line highlighted"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 6.1.è®¢å•id</span></span>
<span class="line highlighted"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        long</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> orderId </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> redisIdWorker.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">nextId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;order&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line highlighted"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        voucherOrder.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(orderId);</span></span>
<span class="line highlighted"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 6.2.ç”¨æˆ·id</span></span>
<span class="line highlighted"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        voucherOrder.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setUserId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(userId);</span></span>
<span class="line highlighted"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 6.3.ä»£é‡‘åˆ¸id</span></span>
<span class="line highlighted"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        voucherOrder.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setVoucherId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(voucherId);</span></span>
<span class="line highlighted"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        save</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(voucherOrder);</span></span>
<span class="line highlighted"><wbr></span>
<span class="line highlighted"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Result.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ok</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(orderId);</span></span>
<span class="line highlighted"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        </span></span>
<span class="line highlighted"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>ä½†æ˜¯ä»¥ä¸Šåšæ³•ä¾ç„¶æœ‰é—®é¢˜ï¼Œå› ä¸ºä½ è°ƒç”¨çš„æ–¹æ³•ï¼Œå…¶å®æ˜¯ <code>this.</code> çš„æ–¹å¼è°ƒç”¨çš„ï¼Œäº‹åŠ¡æƒ³è¦ç”Ÿæ•ˆï¼Œè¿˜å¾—åˆ©ç”¨ä»£ç†æ¥ç”Ÿæ•ˆï¼Œæ‰€ä»¥è¿™ä¸ªåœ°æ–¹ï¼Œæˆ‘ä»¬éœ€è¦è·å¾—åŸå§‹çš„äº‹åŠ¡å¯¹è±¡ï¼Œ æ¥æ“ä½œäº‹åŠ¡ã€‚</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Long userId </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> UserHolder.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getUser</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">synchronized</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (userId.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">toString</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">intern</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    IVoucherOrderService proxy </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (IVoucherOrderService) AopContext.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">currentProxy</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> proxy.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">createVoucherOrder</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(voucherId);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><br><p>åŠ ä¸Šä¾èµ–</p><div class="language-xml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">xml</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">dependency</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">groupId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;org.aspectj&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">groupId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">artifactId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;aspectjweaver&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">artifactId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">dependency</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span></code></pre></div><br><p>å¯åŠ¨ç±»åŠ ä¸Šæ³¨é‡Š</p><div class="language-Java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">Java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">MapperScan</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;com.hmdp.mapper&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SpringBootApplication</span></span>
<span class="line highlighted"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">EnableAspectJAutoProxy</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">exposeProxy</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> HmDianPingApplication</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> main</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">String</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[] </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">args</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        SpringApplication.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">run</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(HmDianPingApplication.class, args);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><br><p><strong>é›†ç¾¤ç¯å¢ƒä¸‹çš„å¹¶å‘é—®é¢˜</strong></p><p>é€šè¿‡åŠ é”å¯ä»¥è§£å†³åœ¨å•æœºæƒ…å†µä¸‹çš„ä¸€äººä¸€å•å®‰å…¨é—®é¢˜ï¼Œä½†æ˜¯åœ¨é›†ç¾¤æ¨¡å¼ä¸‹å°±ä¸è¡Œäº†ã€‚</p><ul><li><p>æˆ‘ä»¬å°†æœåŠ¡å¯åŠ¨ä¸¤ä»½ï¼Œç«¯å£åˆ†åˆ«ä¸º8081å’Œ8082ï¼š</p><p><img src="https://mugrain.oss-cn-hangzhou.aliyuncs.com/cswiki/1653373887844.png" alt="1653373887844" loading="lazy"></p></li><li><p>ç„¶åä¿®æ”¹nginxçš„confç›®å½•ä¸‹çš„nginx.confæ–‡ä»¶ï¼Œé…ç½®åå‘ä»£ç†å’Œè´Ÿè½½å‡è¡¡ï¼š</p><div class="language-nginx vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">nginx</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">worker_processes </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">error_log </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> logs/error.log  info;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">events</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    worker_connections </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1024</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">http</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    include </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      mime.types;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    default_type </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> application/json;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    sendfile </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">       on</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    keepalive_timeout </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 65</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    server</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        listen </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      8080</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        server_name </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> localhost;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        location</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> / </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            root </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  html/hmdp;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            index </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> index.html index.htm;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        error_page </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  500</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 502</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 503</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 504</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  /50x.html;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        location</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> /50x.html </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            root </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  html;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        location</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> /imgs </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">             alias </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">/opt/homebrew/var/www/hmdp/imgs/;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">             autoindex </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">on;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        location</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> /api </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{  </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            default_type </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> application/json;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">            # internal;  </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            keepalive_timeout </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  30s</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;  </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            keepalive_requests </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1000</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;  </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">            # æ”¯æŒkeep-alive  </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            proxy_http_version </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">1.1;  </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            rewrite</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> /api(/.*) $1 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">break</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;  </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            proxy_pass_request_headers </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">on;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">            # more_clear_input_headers Accept-Encoding;  </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            proxy_next_upstream </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">error timeout;  </span></span>
<span class="line highlighted"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">            # proxy_pass http://127.0.0.1:8081;</span></span>
<span class="line highlighted"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            proxy_pass </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">http://backend;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line highlighted"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    upstream</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> backend </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line highlighted"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        server</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> 127.0.0.1:8081 </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">max_fails</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">5</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> fail_timeout=10s </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">weight</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line highlighted"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        server 127.0.0.1:8082 </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">max_fails</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">5</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> fail_timeout=10s </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">weight</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line highlighted"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }  </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div></li></ul><br><p><strong>æœ‰å…³é”å¤±æ•ˆåŸå› åˆ†æ</strong></p><p>ç”±äºç°åœ¨æˆ‘ä»¬éƒ¨ç½²äº†å¤šä¸ª Tomcatï¼Œæ¯ä¸ª Tomcat éƒ½æœ‰ä¸€ä¸ªå±äºè‡ªå·±çš„ Jvmï¼Œé‚£ä¹ˆå‡è®¾åœ¨æœåŠ¡å™¨Açš„ Tomcat å†…éƒ¨ï¼Œæœ‰ä¸¤ä¸ªçº¿ç¨‹ï¼Œè¿™ä¸¤ä¸ªçº¿ç¨‹ç”±äºä½¿ç”¨çš„æ˜¯åŒä¸€ä»½ä»£ç ï¼Œé‚£ä¹ˆä»–ä»¬çš„é”å¯¹è±¡æ˜¯åŒä¸€ä¸ªï¼Œæ˜¯å¯ä»¥å®ç°äº’æ–¥çš„ï¼Œä½†æ˜¯å¦‚æœç°åœ¨æ˜¯æœåŠ¡å™¨Bçš„ Tomcat å†…éƒ¨ï¼Œåˆæœ‰ä¸¤ä¸ªçº¿ç¨‹ï¼Œä½†æ˜¯ä»–ä»¬çš„é”å¯¹è±¡å†™çš„è™½ç„¶å’ŒæœåŠ¡å™¨Aä¸€æ ·ï¼Œä½†æ˜¯é”å¯¹è±¡å´ä¸æ˜¯åŒä¸€ä¸ªï¼Œæ‰€ä»¥çº¿ç¨‹3å’Œçº¿ç¨‹4å¯ä»¥å®ç°äº’æ–¥ï¼Œä½†æ˜¯å´æ— æ³•å’Œçº¿ç¨‹1å’Œçº¿ç¨‹2å®ç°äº’æ–¥ï¼Œè¿™å°±æ˜¯é›†ç¾¤ç¯å¢ƒä¸‹ï¼Œsyn é”å¤±æ•ˆçš„åŸå› ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å°±éœ€è¦ä½¿ç”¨åˆ†å¸ƒå¼é”æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p><p><img src="https://mugrain.oss-cn-hangzhou.aliyuncs.com/cswiki/image-20240314100809151.png" alt="image-20240314100809151" loading="lazy"></p><br><h3 id="åˆ†å¸ƒå¼é”" tabindex="-1">åˆ†å¸ƒå¼é” <a class="header-anchor" href="#åˆ†å¸ƒå¼é”" aria-label="Permalink to &quot;åˆ†å¸ƒå¼é”&quot;">â€‹</a></h3><h4 id="åŸºæœ¬åŸç†" tabindex="-1">åŸºæœ¬åŸç† <a class="header-anchor" href="#åŸºæœ¬åŸç†" aria-label="Permalink to &quot;åŸºæœ¬åŸç†&quot;">â€‹</a></h4><p>åˆ†å¸ƒå¼é”ï¼šæ»¡è¶³åˆ†å¸ƒå¼ç³»ç»Ÿæˆ–é›†ç¾¤æ¨¡å¼ä¸‹å¤šè¿›ç¨‹å¯è§å¹¶ä¸”äº’æ–¥çš„é”ã€‚</p><p>åˆ†å¸ƒå¼é”çš„æ ¸å¿ƒæ€æƒ³å°±æ˜¯è®©å¤§å®¶éƒ½ä½¿ç”¨åŒä¸€æŠŠé”ï¼Œåªè¦å¤§å®¶ä½¿ç”¨çš„æ˜¯åŒä¸€æŠŠé”ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±èƒ½é”ä½çº¿ç¨‹ï¼Œä¸è®©çº¿ç¨‹è¿›è¡Œï¼Œè®©ç¨‹åºä¸²è¡Œæ‰§è¡Œï¼Œè¿™å°±æ˜¯åˆ†å¸ƒå¼é”çš„æ ¸å¿ƒæ€è·¯</p><p><img src="https://mugrain.oss-cn-hangzhou.aliyuncs.com/cswiki/image-20240314100950454.png" alt="image-20240314100950454" loading="lazy"></p><br><p>é‚£ä¹ˆåˆ†å¸ƒå¼é”ä»–åº”è¯¥æ»¡è¶³ä¸€äº›ä»€ä¹ˆæ ·çš„æ¡ä»¶å‘¢ï¼Ÿ</p><ul><li>å¯è§æ€§ï¼šå¤šä¸ªçº¿ç¨‹éƒ½èƒ½çœ‹åˆ°ç›¸åŒçš„ç»“æœï¼Œæ³¨æ„ï¼šè¿™ä¸ªåœ°æ–¹è¯´çš„å¯è§æ€§å¹¶ä¸æ˜¯å¹¶å‘ç¼–ç¨‹ä¸­æŒ‡çš„å†…å­˜å¯è§æ€§ï¼Œåªæ˜¯è¯´å¤šä¸ªè¿›ç¨‹ä¹‹é—´éƒ½èƒ½æ„ŸçŸ¥åˆ°å˜åŒ–çš„æ„æ€</li><li>äº’æ–¥ï¼šäº’æ–¥æ˜¯åˆ†å¸ƒå¼é”çš„æœ€åŸºæœ¬çš„æ¡ä»¶ï¼Œä½¿å¾—ç¨‹åºä¸²è¡Œæ‰§è¡Œ</li><li>é«˜å¯ç”¨ï¼šç¨‹åºä¸æ˜“å´©æºƒï¼Œæ—¶æ—¶åˆ»åˆ»éƒ½ä¿è¯è¾ƒé«˜çš„å¯ç”¨æ€§</li><li>é«˜æ€§èƒ½ï¼šç”±äºåŠ é”æœ¬èº«å°±è®©æ€§èƒ½é™ä½ï¼Œæ‰€æœ‰å¯¹äºåˆ†å¸ƒå¼é”æœ¬èº«éœ€è¦ä»–å°±è¾ƒé«˜çš„åŠ é”æ€§èƒ½å’Œé‡Šæ”¾é”æ€§èƒ½</li><li>å®‰å…¨æ€§ï¼šå®‰å…¨ä¹Ÿæ˜¯ç¨‹åºä¸­å¿…ä¸å¯å°‘çš„ä¸€ç¯</li></ul><p><img src="https://mugrain.oss-cn-hangzhou.aliyuncs.com/cswiki/image-20240314101026763.png" alt="image-20240314101026763" loading="lazy"></p><br><p>å¸¸è§çš„åˆ†å¸ƒå¼é”æœ‰ä¸‰ç§</p><ul><li>MySQLï¼šMySQL æœ¬èº«å°±å¸¦æœ‰é”æœºåˆ¶ï¼Œä½†æ˜¯ç”±äº MySQL æ€§èƒ½æœ¬èº«ä¸€èˆ¬ï¼Œæ‰€ä»¥é‡‡ç”¨åˆ†å¸ƒå¼é”çš„æƒ…å†µä¸‹ï¼Œå…¶å®ä½¿ç”¨ MySQL ä½œä¸ºåˆ†å¸ƒå¼é”æ¯”è¾ƒå°‘è§</li><li>Redisï¼šRedis ä½œä¸ºåˆ†å¸ƒå¼é”æ˜¯éå¸¸å¸¸è§çš„ä¸€ç§ä½¿ç”¨æ–¹å¼ï¼Œç°åœ¨ä¼ä¸šçº§å¼€å‘ä¸­åŸºæœ¬éƒ½ä½¿ç”¨ Redis æˆ–è€… Zookeeper ä½œä¸ºåˆ†å¸ƒå¼é”ï¼Œåˆ©ç”¨ setnx è¿™ä¸ªæ–¹æ³•ï¼Œå¦‚æœæ’å…¥ key æˆåŠŸï¼Œåˆ™è¡¨ç¤ºè·å¾—åˆ°äº†é”ï¼Œå¦‚æœæœ‰äººæ’å…¥æˆåŠŸï¼Œå…¶ä»–äººæ’å…¥å¤±è´¥åˆ™è¡¨ç¤ºæ— æ³•è·å¾—åˆ°é”ï¼Œåˆ©ç”¨è¿™å¥—é€»è¾‘æ¥å®ç°åˆ†å¸ƒå¼é”</li><li>Zookeeperï¼šZookeeperä¹Ÿæ˜¯ä¼ä¸šçº§å¼€å‘ä¸­è¾ƒå¥½çš„ä¸€ä¸ªå®ç°åˆ†å¸ƒå¼é”çš„æ–¹æ¡ˆï¼Œç”±äºæœ¬å¥—è§†é¢‘å¹¶ä¸è®²è§£ Zookeeper çš„åŸç†å’Œåˆ†å¸ƒå¼é”çš„å®ç°ï¼Œæ‰€ä»¥ä¸è¿‡å¤šé˜è¿°</li></ul><p><img src="https://mugrain.oss-cn-hangzhou.aliyuncs.com/cswiki/image-20240314101043083.png" alt="image-20240314101043083" loading="lazy"></p><br><h4 id="æ ¸å¿ƒæ€è·¯" tabindex="-1">æ ¸å¿ƒæ€è·¯ <a class="header-anchor" href="#æ ¸å¿ƒæ€è·¯" aria-label="Permalink to &quot;æ ¸å¿ƒæ€è·¯&quot;">â€‹</a></h4><p>å®ç°åˆ†å¸ƒå¼é”æ—¶éœ€è¦å®ç°çš„ä¸¤ä¸ªåŸºæœ¬æ–¹æ³•ï¼š</p><ul><li>è·å–é”ï¼š <ul><li>äº’æ–¥ï¼šç¡®ä¿åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹è·å–é”</li><li>éé˜»å¡ï¼šå°è¯•ä¸€æ¬¡ï¼ŒæˆåŠŸè¿”å›trueï¼Œå¤±è´¥è¿”å›false <img src="https://mugrain.oss-cn-hangzhou.aliyuncs.com/cswiki/image-16935513619547.png" alt="image-16935513619547" loading="lazy"></li></ul></li><li>é‡Šæ”¾é”ï¼š <ul><li>æ‰‹åŠ¨é‡Šæ”¾</li><li>è¶…æ—¶é‡Šæ”¾ï¼šè·å–é”æ—¶æ·»åŠ ä¸€ä¸ªè¶…æ—¶æ—¶é—´ <img src="https://mugrain.oss-cn-hangzhou.aliyuncs.com/cswiki/image-16935513619548.png" alt="image-16935513619548" loading="lazy"></li></ul></li></ul><br><p><strong>å®ç°æ€è·¯</strong></p><img src="https://mugrain.oss-cn-hangzhou.aliyuncs.com/cswiki/image-20240314101250039.png" alt="image-20240314101250039" style="zoom:66%;"><div class="tip custom-block"><p class="custom-block-title">æ ¸å¿ƒæ€è·¯ï¼šæˆ‘ä»¬åˆ©ç”¨ Redis çš„setNx æ–¹æ³•ï¼Œå½“æœ‰å¤šä¸ªçº¿ç¨‹è¿›å…¥æ—¶ï¼Œæˆ‘ä»¬å°±åˆ©ç”¨è¯¥æ–¹æ³•ï¼Œç¬¬ä¸€ä¸ªçº¿ç¨‹è¿›å…¥æ—¶ï¼ŒRedis ä¸­å°±æœ‰è¿™ä¸ªkey äº†ï¼Œè¿”å›äº†1ï¼Œå¦‚æœç»“æœæ˜¯1ï¼Œåˆ™è¡¨ç¤ºä»–æŠ¢åˆ°äº†é”ï¼Œé‚£ä¹ˆä»–å»æ‰§è¡Œä¸šåŠ¡ï¼Œç„¶åå†åˆ é™¤é”ï¼Œé€€å‡ºé”é€»è¾‘ï¼Œæ²¡æœ‰æŠ¢åˆ°é”çš„å“¥ä»¬ï¼Œç­‰å¾…ä¸€å®šæ—¶é—´åé‡è¯•å³å¯ã€‚</p></div><br><h4 id="å®ç°åˆ†å¸ƒå¼é”ç‰ˆæœ¬" tabindex="-1">å®ç°åˆ†å¸ƒå¼é”ç‰ˆæœ¬ <a class="header-anchor" href="#å®ç°åˆ†å¸ƒå¼é”ç‰ˆæœ¬" aria-label="Permalink to &quot;å®ç°åˆ†å¸ƒå¼é”ç‰ˆæœ¬&quot;">â€‹</a></h4><ul><li>åŠ é”é€»è¾‘</li></ul><p><strong>é”çš„åŸºæœ¬æ¥å£</strong></p><div class="language-Java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">Java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">package</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.hmdp.utils;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> interface</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ILock</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    /**</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">     * å°è¯•è·å–åˆ†å¸ƒå¼é”</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">     * </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">@param</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> timeoutSec</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">     * </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">@return</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">     */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    boolean</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> tryLock</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">long</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> timeoutSec</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    /**</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">     * é‡Šæ”¾é”</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">     */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> unlock</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><br><p><strong>SimpleRedisLock</strong></p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">package</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.hmdp.utils;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> org.springframework.beans.factory.annotation.Autowired;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> org.springframework.data.redis.core.StringRedisTemplate;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> java.util.concurrent.TimeUnit;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> SimpleRedisLock</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> implements</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ILock</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    private</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> final</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> String KEY_PREFIX </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;lock:&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    private</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> final</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> String name;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Autowired</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    private</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> StringRedisTemplate stringRedisTemplate;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> SimpleRedisLock</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(String </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, StringRedisTemplate </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">stringRedisTemplate</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.name </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> name;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.stringRedisTemplate </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> stringRedisTemplate;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    //åˆ©ç”¨setnxæ–¹æ³•è¿›è¡ŒåŠ é”ï¼ŒåŒæ—¶å¢åŠ è¿‡æœŸæ—¶é—´ï¼Œé˜²æ­¢æ­»é”ï¼Œæ­¤æ–¹æ³•å¯ä»¥ä¿è¯åŠ é”å’Œå¢åŠ è¿‡æœŸæ—¶é—´å…·æœ‰åŸå­æ€§</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Override</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> boolean</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> tryLock</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">long</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> timeoutSc</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        //è·å–çº¿ç¨‹æ ‡è¯†</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        long</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> threadId </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Thread.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">currentThread</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        Boolean success </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> stringRedisTemplate.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">opsForValue</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setIfAbsent</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(KEY_PREFIX </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> name, threadId </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, timeoutSc, TimeUnit.SECONDS);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Boolean.TRUE.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">equals</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(success);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    //é‡Šæ”¾é”é€»è¾‘ï¼Œé˜²æ­¢åˆ é™¤åˆ«äººçš„é”</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Override</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> unlock</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        stringRedisTemplate.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">delete</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(KEY_PREFIX </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> name);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><br><ul><li>ä¿®æ”¹ä¸šåŠ¡ä»£ç </li></ul><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Override</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Result </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">seckillVoucher</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(Long voucherId) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 1.æŸ¥è¯¢ä¼˜æƒ åˆ¸</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    SeckillVoucher voucher </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> seckillVoucherService.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getById</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(voucherId);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 2.åˆ¤æ–­ç§’æ€æ˜¯å¦å¼€å§‹</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (voucher.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getBeginTime</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">isAfter</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(LocalDateTime.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">now</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">())) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // å°šæœªå¼€å§‹</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Result.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">fail</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;ç§’æ€å°šæœªå¼€å§‹ï¼&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 3.åˆ¤æ–­ç§’æ€æ˜¯å¦å·²ç»ç»“æŸ</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (voucher.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getEndTime</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">isBefore</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(LocalDateTime.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">now</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">())) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // å°šæœªå¼€å§‹</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Result.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">fail</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;ç§’æ€å·²ç»ç»“æŸï¼&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 4.åˆ¤æ–­åº“å­˜æ˜¯å¦å……è¶³</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (voucher.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getStock</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // åº“å­˜ä¸è¶³</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Result.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">fail</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;åº“å­˜ä¸è¶³ï¼&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    Long userId </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> UserHolder.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getUser</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"></span>
<span class="line highlighted"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // åˆ›å»ºé”å¯¹è±¡å¹¶è®¾ç½®è¶…æ—¶æ—¶é—´ï¼Œé˜²æ­¢æ­»é”</span></span>
<span class="line highlighted"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ILock lock </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> SimpleRedisLock</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;order:&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> +</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> userId, stringRedisTemplate);</span></span>
<span class="line highlighted"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    boolean</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> isLock </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> lock.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">tryLock</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1200</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line highlighted"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">isLock) {</span></span>
<span class="line highlighted"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Result.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">fail</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;ä¸å…è®¸é‡å¤ä¸‹å•&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line highlighted"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line highlighted"><wbr></span>
<span class="line highlighted"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    try</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line highlighted"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // å»æ‰ sync æ‚²è§‚é” </span></span>
<span class="line highlighted"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        IVoucherOrderService proxy </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (IVoucherOrderService) AopContext.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">currentProxy</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line highlighted"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> proxy.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">createVoucherOrder</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(voucherId);</span></span>
<span class="line highlighted"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">finally</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line highlighted"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // é‡Šæ”¾é”</span></span>
<span class="line highlighted"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        lock.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">unlock</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line highlighted"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><br><h4 id="åˆ†å¸ƒå¼é”è¯¯åˆ è¯´æ˜" tabindex="-1">åˆ†å¸ƒå¼é”è¯¯åˆ è¯´æ˜ <a class="header-anchor" href="#åˆ†å¸ƒå¼é”è¯¯åˆ è¯´æ˜" aria-label="Permalink to &quot;åˆ†å¸ƒå¼é”è¯¯åˆ è¯´æ˜&quot;">â€‹</a></h4><p><strong>é€»è¾‘è¯´æ˜</strong>ï¼šæŒæœ‰é”çš„çº¿ç¨‹åœ¨é”çš„å†…éƒ¨å‡ºç°äº†é˜»å¡ï¼Œå¯¼è‡´ä»–çš„é”è‡ªåŠ¨é‡Šæ”¾ï¼Œè¿™æ—¶å…¶ä»–çº¿ç¨‹ï¼Œçº¿ç¨‹2æ¥å°è¯•è·å¾—é”ï¼Œå°±æ‹¿åˆ°äº†è¿™æŠŠé”ï¼Œç„¶åçº¿ç¨‹2åœ¨æŒæœ‰é”æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œçº¿ç¨‹1ååº”è¿‡æ¥ï¼Œç»§ç»­æ‰§è¡Œï¼Œè€Œçº¿ç¨‹1æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œèµ°åˆ°äº†åˆ é™¤é”é€»è¾‘ï¼Œæ­¤æ—¶å°±ä¼šæŠŠæœ¬åº”è¯¥å±äºçº¿ç¨‹2çš„é”è¿›è¡Œåˆ é™¤ï¼Œè¿™å°±æ˜¯è¯¯åˆ åˆ«äººé”çš„æƒ…å†µè¯´æ˜</p><p><strong>è§£å†³æ–¹æ¡ˆ</strong>ï¼šè§£å†³æ–¹æ¡ˆå°±æ˜¯åœ¨æ¯ä¸ªçº¿ç¨‹é‡Šæ”¾é”çš„æ—¶å€™ï¼Œå»åˆ¤æ–­ä¸€ä¸‹å½“å‰è¿™æŠŠé”æ˜¯å¦å±äºè‡ªå·±ï¼Œå¦‚æœå±äºè‡ªå·±ï¼Œåˆ™ä¸è¿›è¡Œé”çš„åˆ é™¤ï¼Œå‡è®¾è¿˜æ˜¯ä¸Šè¾¹çš„æƒ…å†µï¼Œçº¿ç¨‹1å¡é¡¿ï¼Œé”è‡ªåŠ¨é‡Šæ”¾ï¼Œçº¿ç¨‹2è¿›å…¥åˆ°é”çš„å†…éƒ¨æ‰§è¡Œé€»è¾‘ï¼Œæ­¤æ—¶çº¿ç¨‹1ååº”è¿‡æ¥ï¼Œç„¶ååˆ é™¤é”ï¼Œä½†æ˜¯çº¿ç¨‹1ï¼Œä¸€çœ‹å½“å‰è¿™æŠŠé”ä¸æ˜¯å±äºè‡ªå·±ï¼Œäºæ˜¯ä¸è¿›è¡Œåˆ é™¤é”é€»è¾‘ï¼Œå½“çº¿ç¨‹2èµ°åˆ°åˆ é™¤é”é€»è¾‘æ—¶ï¼Œå¦‚æœæ²¡æœ‰å¡è¿‡è‡ªåŠ¨é‡Šæ”¾é”çš„æ—¶é—´ç‚¹ï¼Œåˆ™åˆ¤æ–­å½“å‰è¿™æŠŠé”æ˜¯å±äºè‡ªå·±çš„ï¼Œäºæ˜¯åˆ é™¤è¿™æŠŠé”ã€‚</p><p><img src="https://mugrain.oss-cn-hangzhou.aliyuncs.com/cswiki/image-20240314101643734.png" alt="image-20240314101643734" loading="lazy"></p><br><h4 id="è§£å†³åˆ†å¸ƒå¼é”è¯¯åˆ " tabindex="-1">è§£å†³åˆ†å¸ƒå¼é”è¯¯åˆ  <a class="header-anchor" href="#è§£å†³åˆ†å¸ƒå¼é”è¯¯åˆ " aria-label="Permalink to &quot;è§£å†³åˆ†å¸ƒå¼é”è¯¯åˆ &quot;">â€‹</a></h4><p>éœ€æ±‚ï¼šä¿®æ”¹ä¹‹å‰çš„åˆ†å¸ƒå¼é”å®ç°ï¼Œæ»¡è¶³ï¼šåœ¨è·å–é”æ—¶å­˜å…¥çº¿ç¨‹æ ‡ç¤ºï¼ˆå¯ä»¥ç”¨UUIDè¡¨ç¤ºï¼‰ã€‚åœ¨é‡Šæ”¾é”æ—¶å…ˆè·å–é”ä¸­çš„çº¿ç¨‹æ ‡ç¤ºï¼Œåˆ¤æ–­æ˜¯å¦ä¸å½“å‰çº¿ç¨‹æ ‡ç¤ºä¸€è‡´</p><ul><li>å¦‚æœä¸€è‡´åˆ™é‡Šæ”¾é”</li><li>å¦‚æœä¸ä¸€è‡´åˆ™ä¸é‡Šæ”¾é”</li></ul><p>æ ¸å¿ƒé€»è¾‘ï¼šåœ¨å­˜å…¥é”æ—¶ï¼Œæ”¾å…¥è‡ªå·±çº¿ç¨‹çš„æ ‡è¯†ï¼Œåœ¨åˆ é™¤é”æ—¶ï¼Œåˆ¤æ–­å½“å‰è¿™æŠŠé”çš„æ ‡è¯†æ˜¯ä¸æ˜¯è‡ªå·±å­˜å…¥çš„ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™è¿›è¡Œåˆ é™¤ï¼Œå¦‚æœä¸æ˜¯ï¼Œåˆ™ä¸è¿›è¡Œåˆ é™¤ã€‚</p><br><p><strong>æµç¨‹å›¾</strong></p><p><img src="https://mugrain.oss-cn-hangzhou.aliyuncs.com/cswiki/image-169355136195412.png" alt="image-169355136195412" loading="lazy"></p><br><div class="tip custom-block"><p class="custom-block-title">ğŸ“Œ éœ€æ±‚ï¼šä¿®æ”¹ä¹‹å‰çš„åˆ†å¸ƒå¼é”å®ç°ï¼Œæ»¡è¶³</p><ol><li>åœ¨è·å–çæ—¶å­˜å…¥çº¿ç¨‹æ ‡è¯†ï¼ˆå¯ä»¥ç”¨UUIDæ ‡è¯†ï¼‰</li><li>åœ¨é‡Šæ”¾é”æ—¶è·å–é”ä¸­çš„çº¿ç¨‹æ ‡è¯†ï¼Œåˆ¤æ–­æ˜¯å¦ä¸å½“å‰çº¿ç¨‹æ ‡è¯†ä¸€è‡´ <ul><li>å¦‚æœä¸€è‡´åˆ™é‡Šæ”¾é”</li><li>å¦‚æœä¸ä¸€è‡´åˆ™ä¸é‡Šæ”¾é”</li></ul></li></ol></div><br><p><strong>å…·ä½“ä»£ç </strong></p><div class="language-Java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">Java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">package</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.hmdp.utils;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> cn.hutool.core.lang.UUID;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> org.springframework.beans.factory.annotation.Autowired;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> org.springframework.data.redis.core.StringRedisTemplate;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> java.util.concurrent.TimeUnit;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> SimpleRedisLock</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> implements</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ILock</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    private</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> final</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> String KEY_PREFIX </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;lock:&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    private</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> final</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> String name;</span></span>
<span class="line"></span>
<span class="line highlighted"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    private</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> final</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> String ID_PREFIX </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> UUID.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">randomUUID</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">toString</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;-&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Autowired</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    private</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> StringRedisTemplate stringRedisTemplate;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> SimpleRedisLock</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(String </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, StringRedisTemplate </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">stringRedisTemplate</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.name </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> name;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.stringRedisTemplate </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> stringRedisTemplate;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    //åˆ©ç”¨setnxæ–¹æ³•è¿›è¡ŒåŠ é”ï¼ŒåŒæ—¶å¢åŠ è¿‡æœŸæ—¶é—´ï¼Œé˜²æ­¢æ­»é”ï¼Œæ­¤æ–¹æ³•å¯ä»¥ä¿è¯åŠ é”å’Œå¢åŠ è¿‡æœŸæ—¶é—´å…·æœ‰åŸå­æ€§</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Override</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> boolean</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> tryLock</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">long</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> timeoutSc</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        //è·å–çº¿ç¨‹æ ‡è¯†</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        long</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> threadId </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Thread.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">currentThread</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        Boolean success </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> stringRedisTemplate.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">opsForValue</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setIfAbsent</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(KEY_PREFIX </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> name, threadId </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, timeoutSc, TimeUnit.SECONDS);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Boolean.TRUE.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">equals</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(success);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    //é‡Šæ”¾é”é€»è¾‘ï¼Œé˜²æ­¢åˆ é™¤åˆ«äººçš„é”</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Override</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> unlock</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line highlighted"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        //è·å–çº¿ç¨‹æ ‡è¯†</span></span>
<span class="line highlighted"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        String threadId </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ID_PREFIX </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Thread.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">currentThread</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line highlighted"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        //è·å–é”ä¸­çš„æ ‡è¯†</span></span>
<span class="line highlighted"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        String id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> stringRedisTemplate.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">opsForValue</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(KEY_PREFIX </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> name);</span></span>
<span class="line highlighted"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        //å¦‚æœæ ‡è¯†ä¸€ç›´åˆ™é‡Šæ”¾é”</span></span>
<span class="line highlighted"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (threadId.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">equals</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(id)) {</span></span>
<span class="line highlighted"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            stringRedisTemplate.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">delete</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(KEY_PREFIX </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> name);</span></span>
<span class="line highlighted"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><br><p><strong>æœ‰å…³ä»£ç å®æ“è¯´æ˜ï¼š</strong></p><p>åœ¨æˆ‘ä»¬ä¿®æ”¹å®Œæ­¤å¤„ä»£ç åï¼Œæˆ‘ä»¬é‡å¯å·¥ç¨‹ï¼Œç„¶åå¯åŠ¨ä¸¤ä¸ªçº¿ç¨‹ï¼Œç¬¬ä¸€ä¸ªçº¿ç¨‹æŒæœ‰é”åï¼Œæ‰‹åŠ¨é‡Šæ”¾é”ï¼Œç¬¬äºŒä¸ªçº¿ç¨‹ æ­¤æ—¶è¿›å…¥åˆ°é”å†…éƒ¨ï¼Œå†æ”¾è¡Œç¬¬ä¸€ä¸ªçº¿ç¨‹ï¼Œæ­¤æ—¶ç¬¬ä¸€ä¸ªçº¿ç¨‹ç”±äºé”çš„valueå€¼å¹¶éæ˜¯è‡ªå·±ï¼Œæ‰€ä»¥ä¸èƒ½é‡Šæ”¾é”ï¼Œä¹Ÿå°±æ— æ³•åˆ é™¤åˆ«äººçš„é”ï¼Œæ­¤æ—¶ç¬¬äºŒä¸ªçº¿ç¨‹èƒ½å¤Ÿæ­£ç¡®é‡Šæ”¾é”ï¼Œé€šè¿‡è¿™ä¸ªæ¡ˆä¾‹åˆæ­¥è¯´æ˜æˆ‘ä»¬è§£å†³äº†é”è¯¯åˆ çš„é—®é¢˜ã€‚</p><br><h4 id="åˆ†å¸ƒå¼é”çš„åŸå­æ€§é—®é¢˜" tabindex="-1">åˆ†å¸ƒå¼é”çš„åŸå­æ€§é—®é¢˜ <a class="header-anchor" href="#åˆ†å¸ƒå¼é”çš„åŸå­æ€§é—®é¢˜" aria-label="Permalink to &quot;åˆ†å¸ƒå¼é”çš„åŸå­æ€§é—®é¢˜&quot;">â€‹</a></h4><p>æ›´ä¸ºæç«¯çš„è¯¯åˆ é€»è¾‘è¯´æ˜ï¼š</p><p>çº¿ç¨‹1ç°åœ¨æŒæœ‰é”ä¹‹åï¼Œåœ¨æ‰§è¡Œä¸šåŠ¡é€»è¾‘è¿‡ç¨‹ä¸­ï¼Œä»–æ­£å‡†å¤‡åˆ é™¤é”ï¼Œè€Œä¸”å·²ç»èµ°åˆ°äº†æ¡ä»¶åˆ¤æ–­çš„è¿‡ç¨‹ä¸­ï¼Œæ¯”å¦‚ä»–å·²ç»æ‹¿åˆ°äº†å½“å‰è¿™æŠŠé”ç¡®å®æ˜¯å±äºä»–è‡ªå·±çš„ï¼Œæ­£å‡†å¤‡åˆ é™¤é”ï¼Œä½†æ˜¯æ­¤æ—¶ä»–çš„é”åˆ°æœŸäº†ï¼Œé‚£ä¹ˆæ­¤æ—¶çº¿ç¨‹2è¿›æ¥ï¼Œä½†æ˜¯çº¿ç¨‹1ä»–ä¼šæ¥ç€å¾€åæ‰§è¡Œï¼Œå½“ä»–å¡é¡¿ç»“æŸåï¼Œä»–ç›´æ¥å°±ä¼šæ‰§è¡Œåˆ é™¤é”é‚£è¡Œä»£ç ï¼Œç›¸å½“äºæ¡ä»¶åˆ¤æ–­å¹¶æ²¡æœ‰èµ·åˆ°ä½œç”¨ï¼Œè¿™å°±æ˜¯åˆ é”æ—¶çš„åŸå­æ€§é—®é¢˜ï¼Œä¹‹æ‰€ä»¥æœ‰è¿™ä¸ªé—®é¢˜ï¼Œæ˜¯å› ä¸ºçº¿ç¨‹1çš„æ‹¿é”ï¼Œæ¯”é”ï¼Œåˆ é”ï¼Œå®é™…ä¸Šå¹¶ä¸æ˜¯åŸå­æ€§çš„ï¼Œæˆ‘ä»¬è¦é˜²æ­¢åˆšæ‰çš„æƒ…å†µå‘ç”Ÿï¼Œ</p><p><img src="https://mugrain.oss-cn-hangzhou.aliyuncs.com/cswiki/image-20240314101823161.png" alt="image-20240314101823161" loading="lazy"></p><br><h4 id="luaè§£å†³åŸå­æ€§é—®é¢˜" tabindex="-1">Luaè§£å†³åŸå­æ€§é—®é¢˜ <a class="header-anchor" href="#luaè§£å†³åŸå­æ€§é—®é¢˜" aria-label="Permalink to &quot;Luaè§£å†³åŸå­æ€§é—®é¢˜&quot;">â€‹</a></h4><p>Redisæä¾›äº†Luaè„šæœ¬åŠŸèƒ½ï¼Œåœ¨ä¸€ä¸ªè„šæœ¬ä¸­ç¼–å†™å¤šæ¡Rediså‘½ä»¤ï¼Œç¡®ä¿å¤šæ¡å‘½ä»¤æ‰§è¡Œæ—¶çš„åŸå­æ€§ã€‚Luaæ˜¯ä¸€ç§ç¼–ç¨‹è¯­è¨€ã€‚</p><p>å‚è€ƒç½‘ç«™ï¼š<a href="https://www.runoob.com/lua/lua-tutorial.html" target="_blank" rel="noreferrer">https://www.runoob.com/lua/lua-tutorial.html</a></p><p>è¿™é‡Œé‡ç‚¹ä»‹ç»Redisæä¾›çš„è°ƒç”¨å‡½æ•°ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ Lua å»æ“ä½œ Redisï¼Œåˆèƒ½ä¿è¯ä»–çš„åŸå­æ€§ï¼Œè¿™æ ·å°±å¯ä»¥å®ç°æ‹¿é”æ¯”é”åˆ é”æ˜¯ä¸€ä¸ªåŸå­æ€§åŠ¨ä½œäº†ï¼Œä½œä¸ºJavaç¨‹åºå‘˜è¿™ä¸€å—å¹¶ä¸ä½œä¸€ä¸ªç®€å•è¦æ±‚ï¼Œå¹¶ä¸éœ€è¦å¤§å®¶è¿‡äºç²¾é€šï¼Œåªéœ€è¦çŸ¥é“ä»–æœ‰ä»€ä¹ˆä½œç”¨å³å¯ã€‚</p><p>è¿™é‡Œé‡ç‚¹ä»‹ç»Redisæä¾›çš„è°ƒç”¨å‡½æ•°ï¼Œè¯­æ³•å¦‚ä¸‹ï¼š</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">redis.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">call</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;å‘½ä»¤åç§°&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;key&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;å…¶å®ƒå‚æ•°&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">...</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><p>ä¾‹å¦‚ï¼Œæˆ‘ä»¬è¦æ‰§è¡Œset name jackï¼Œåˆ™è„šæœ¬æ˜¯è¿™æ ·ï¼š</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- æ‰§è¡Œ set name jack</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">redis.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">call</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;set&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;name&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;jack&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><p>ä¾‹å¦‚ï¼Œæˆ‘ä»¬è¦å…ˆæ‰§è¡Œset name Roseï¼Œå†æ‰§è¡Œget nameï¼Œåˆ™è„šæœ¬å¦‚ä¸‹ï¼š</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- å…ˆæ‰§è¡Œ set name jack</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">redis.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">call</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;set&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;name&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;Rose&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- å†æ‰§è¡Œ get name</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">local</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> name </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> redis.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">call</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;get&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;name&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- è¿”å›</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> name</span></span></code></pre></div><p>å†™å¥½è„šæœ¬ä»¥åï¼Œéœ€è¦ç”¨Rediså‘½ä»¤æ¥è°ƒç”¨è„šæœ¬ï¼Œè°ƒç”¨è„šæœ¬çš„å¸¸è§å‘½ä»¤å¦‚ä¸‹ï¼š</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">127.0.0.1:6379&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> help @scripting</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  EVAL</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> script numkeys [key [key ...]] [arg [arg ...]]</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  summary:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Execute a Lua script server side</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  since:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2.6</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.0</span></span></code></pre></div><p>ä¾‹å¦‚ï¼Œæˆ‘ä»¬è¦æ‰§è¡Œ <code>redis.call(&#39;set&#39;, &#39;name&#39;, &#39;jack&#39;) </code>è¿™ä¸ªè„šæœ¬ï¼Œè¯­æ³•å¦‚ä¸‹ï¼š</p><p><img src="https://mugrain.oss-cn-hangzhou.aliyuncs.com/cswiki/1653392218531.png" alt="1653392218531" loading="lazy"></p><p>å¦‚æœè„šæœ¬ä¸­çš„keyã€valueä¸æƒ³å†™æ­»ï¼Œå¯ä»¥ä½œä¸ºå‚æ•°ä¼ é€’ã€‚keyç±»å‹å‚æ•°ä¼šæ”¾å…¥KEYSæ•°ç»„ï¼Œå…¶å®ƒå‚æ•°ä¼šæ”¾å…¥ARGVæ•°ç»„ï¼Œåœ¨è„šæœ¬ä¸­å¯ä»¥ä»KEYSå’ŒARGVæ•°ç»„è·å–è¿™äº›å‚æ•°ï¼š</p><p><img src="https://mugrain.oss-cn-hangzhou.aliyuncs.com/cswiki/1653392438917.png" alt="1653392438917" loading="lazy"></p><br><p>æ¥ä¸‹æ¥æˆ‘ä»¬æ¥å›é¡¾ä¸€ä¸‹æˆ‘ä»¬é‡Šæ”¾é”çš„é€»è¾‘ï¼š</p><p>é‡Šæ”¾é”çš„ä¸šåŠ¡æµç¨‹æ˜¯è¿™æ ·çš„</p><ol><li>è·å–é”ä¸­çš„çº¿ç¨‹æ ‡ç¤º</li><li>åˆ¤æ–­æ˜¯å¦ä¸æŒ‡å®šçš„æ ‡ç¤ºï¼ˆå½“å‰çº¿ç¨‹æ ‡ç¤ºï¼‰ä¸€è‡´</li><li>å¦‚æœä¸€è‡´åˆ™é‡Šæ”¾é”ï¼ˆåˆ é™¤ï¼‰</li><li>å¦‚æœä¸ä¸€è‡´åˆ™ä»€ä¹ˆéƒ½ä¸åš</li></ol><br><p>å¦‚æœç”¨Luaè„šæœ¬æ¥è¡¨ç¤ºåˆ™æ˜¯è¿™æ ·çš„ï¼šæœ€ç»ˆæˆ‘ä»¬æ“ä½œ Redis çš„æ‹¿é”æ¯”é”åˆ é”çš„ Lua è„šæœ¬å°±ä¼šå˜æˆè¿™æ ·</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- è¿™é‡Œçš„ KEYS[1] å°±æ˜¯é”çš„keyï¼Œè¿™é‡Œçš„ARGV[1] å°±æ˜¯å½“å‰çº¿ç¨‹æ ‡ç¤º</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- è·å–é”ä¸­çš„æ ‡ç¤ºï¼Œåˆ¤æ–­æ˜¯å¦ä¸å½“å‰çº¿ç¨‹æ ‡ç¤ºä¸€è‡´</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (redis.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">call</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;GET&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, KEYS[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ARGV[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">then</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  -- ä¸€è‡´ï¼Œåˆ™åˆ é™¤é”</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> redis.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">call</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;DEL&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, KEYS[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">])</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- ä¸ä¸€è‡´ï¼Œåˆ™ç›´æ¥è¿”å›</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span></span></code></pre></div><br><h4 id="è°ƒç”¨luaè„šæœ¬æ”¹é€ åˆ†å¸ƒå¼é”" tabindex="-1">è°ƒç”¨Luaè„šæœ¬æ”¹é€ åˆ†å¸ƒå¼é” <a class="header-anchor" href="#è°ƒç”¨luaè„šæœ¬æ”¹é€ åˆ†å¸ƒå¼é”" aria-label="Permalink to &quot;è°ƒç”¨Luaè„šæœ¬æ”¹é€ åˆ†å¸ƒå¼é”&quot;">â€‹</a></h4><p>luaè„šæœ¬æœ¬èº«å¹¶ä¸éœ€è¦å¤§å®¶èŠ±è´¹å¤ªå¤šæ—¶é—´å»ç ”ç©¶ï¼Œåªéœ€è¦çŸ¥é“å¦‚ä½•è°ƒç”¨ï¼Œå¤§è‡´æ˜¯ä»€ä¹ˆæ„æ€å³å¯ï¼Œæ‰€ä»¥åœ¨ç¬”è®°ä¸­å¹¶ä¸ä¼šè¯¦ç»†çš„å»è§£é‡Šè¿™äº›luaè¡¨è¾¾å¼çš„å«ä¹‰ã€‚</p><p>æˆ‘ä»¬çš„RedisTemplateä¸­ï¼Œå¯ä»¥åˆ©ç”¨executeæ–¹æ³•å»æ‰§è¡Œluaè„šæœ¬ï¼Œå‚æ•°å¯¹åº”å…³ç³»å°±å¦‚ä¸‹å›¾è‚¡</p><img src="https://mugrain.oss-cn-hangzhou.aliyuncs.com/cswiki/image-20240314102827298.png" alt="image-20240314102827298" style="zoom:50%;"><br><p><strong>Javaä»£ç </strong></p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">private</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> final</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> DefaultRedisScript&lt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Long</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; UNLOCK_SCRIPT;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    static</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        UNLOCK_SCRIPT </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> DefaultRedisScript&lt;&gt;();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        UNLOCK_SCRIPT.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setLocation</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ClassPathResource</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;unlock.lua&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">));</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        UNLOCK_SCRIPT.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setResultType</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(Long.class);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> unlock</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // è°ƒç”¨luaè„šæœ¬</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    stringRedisTemplate.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">execute</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            UNLOCK_SCRIPT,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            Collections.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">singletonList</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(KEY_PREFIX </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> name),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            ID_PREFIX </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Thread.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">currentThread</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">());</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>ç»è¿‡ä»¥ä¸Šä»£ç æ”¹é€ åï¼Œæˆ‘ä»¬å°±èƒ½å¤Ÿå®ç°æ‹¿é”å’Œé”åˆ é”çš„åŸå­æ€§åŠ¨ä½œäº†~</p><br><p><strong>Luaè„šæœ¬</strong>ï¼šunlock.lua</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- æ¯”è¾ƒçº¿ç¨‹æ ‡ç¤ºä¸é”ä¸­çš„æ ‡ç¤ºæ˜¯å¦ä¸€è‡´</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(redis.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">call</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;get&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, KEYS[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  ARGV[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">then</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    -- é‡Šæ”¾é” del key</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> redis.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">call</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;del&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, KEYS[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">])</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span></span></code></pre></div><div class="warning custom-block"><p class="custom-block-title">æ€»ç»“ï¼šåŸºäºRedisçš„åˆ†å¸ƒå¼é”å®ç°æ€è·¯</p><ul><li>åˆ©ç”¨ set nx ex è·å–é”ï¼Œå¹¶è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œä¿å­˜çº¿ç¨‹æ ‡ç¤ºé‡Šæ”¾é”æ—¶å…ˆåˆ¤æ–­çº¿ç¨‹æ ‡ç¤º</li><li>æ˜¯å¦ä¸è‡ªå·±ä¸€è‡´ï¼Œä¸€è‡´åˆ™åˆ é™¤é”</li></ul><p><strong>ç‰¹æ€§</strong></p><ul><li>åˆ©ç”¨set nx æ»¡è¶³äº’æ–¥æ€§</li><li>åˆ©ç”¨set ex ä¿è¯æ•…éšœæ—¶é”ä¾ç„¶èƒ½é‡Šæ”¾ï¼Œé¿å…æ­»é”ï¼Œæé«˜å®‰å…¨æ€§</li><li>åˆ©ç”¨ Redis é›†ç¾¤ä¿è¯é«˜å¯ç”¨å’Œé«˜å¹¶å‘ç‰¹æ€§</li></ul></div><p>ç¬”è€…æ€»ç»“ï¼šæˆ‘ä»¬ä¸€è·¯èµ°æ¥ï¼Œåˆ©ç”¨æ·»åŠ è¿‡æœŸæ—¶é—´ï¼Œé˜²æ­¢æ­»é”é—®é¢˜çš„å‘ç”Ÿï¼Œä½†æ˜¯æœ‰äº†è¿‡æœŸæ—¶é—´ä¹‹åï¼Œå¯èƒ½å‡ºç°è¯¯åˆ åˆ«äººé”çš„é—®é¢˜ï¼Œè¿™ä¸ªé—®é¢˜æˆ‘ä»¬å¼€å§‹æ˜¯åˆ©ç”¨åˆ ä¹‹å‰é€šè¿‡æ‹¿é”ï¼Œæ¯”é”ï¼Œåˆ é”è¿™ä¸ªé€»è¾‘æ¥è§£å†³çš„ï¼Œä¹Ÿå°±æ˜¯åˆ ä¹‹å‰åˆ¤æ–­ä¸€ä¸‹å½“å‰è¿™æŠŠé”æ˜¯å¦æ˜¯å±äºè‡ªå·±çš„ï¼Œä½†æ˜¯ç°åœ¨è¿˜æœ‰åŸå­æ€§é—®é¢˜ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬æ²¡æ³•ä¿è¯æ‹¿é”æ¯”é”åˆ é”æ˜¯ä¸€ä¸ªåŸå­æ€§çš„åŠ¨ä½œï¼Œæœ€åé€šè¿‡luaè¡¨è¾¾å¼æ¥è§£å†³è¿™ä¸ªé—®é¢˜</p><p>ä½†æ˜¯ç›®å‰è¿˜å‰©ä¸‹ä¸€ä¸ªé—®é¢˜é”ä¸ä½ï¼Œä»€ä¹ˆæ˜¯é”ä¸ä½å‘¢ï¼Œä½ æƒ³ä¸€æƒ³ï¼Œå¦‚æœå½“è¿‡æœŸæ—¶é—´åˆ°äº†ä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥ç»™ä»–ç»­æœŸä¸€ä¸‹ï¼Œæ¯”å¦‚ç»­ä¸ª30sï¼Œå°±å¥½åƒæ˜¯ç½‘å§ä¸Šç½‘ï¼Œ ç½‘è´¹åˆ°äº†ä¹‹åï¼Œç„¶åè¯´ï¼Œæ¥ï¼Œç½‘ç®¡ï¼Œå†ç»™æˆ‘æ¥10å—çš„ï¼Œæ˜¯ä¸æ˜¯åè¾¹çš„é—®é¢˜éƒ½ä¸ä¼šå‘ç”Ÿäº†ï¼Œé‚£ä¹ˆç»­æœŸé—®é¢˜æ€ä¹ˆè§£å†³å‘¢ï¼Œå¯ä»¥ä¾èµ–äºæˆ‘ä»¬æ¥ä¸‹æ¥è¦å­¦ä¹  Redission å•¦</p><br><p><strong>æµ‹è¯•é€»è¾‘ï¼š</strong></p><p>ç¬¬ä¸€ä¸ªçº¿ç¨‹è¿›æ¥ï¼Œå¾—åˆ°äº†é”ï¼Œæ‰‹åŠ¨åˆ é™¤é”ï¼Œæ¨¡æ‹Ÿé”è¶…æ—¶äº†ï¼Œå…¶ä»–çº¿ç¨‹ä¼šæ‰§è¡Œ Lua æ¥æŠ¢é”ï¼Œå½“ç¬¬ä¸€å¤©çº¿ç¨‹åˆ©ç”¨ Lua åˆ é™¤é”æ—¶ï¼ŒLua èƒ½ä¿è¯ä»–ä¸èƒ½åˆ é™¤ä»–çš„é”ï¼Œç¬¬äºŒä¸ªçº¿ç¨‹åˆ é™¤é”æ—¶ï¼Œåˆ©ç”¨ Lua åŒæ ·å¯ä»¥ä¿è¯ä¸ä¼šåˆ é™¤åˆ«äººçš„é”ï¼ŒåŒæ—¶è¿˜èƒ½ä¿è¯åŸå­æ€§ã€‚</p><br><h3 id="redission" tabindex="-1">Redission <a class="header-anchor" href="#redission" aria-label="Permalink to &quot;Redission&quot;">â€‹</a></h3><h4 id="åŠŸèƒ½ä»‹ç»" tabindex="-1">åŠŸèƒ½ä»‹ç» <a class="header-anchor" href="#åŠŸèƒ½ä»‹ç»" aria-label="Permalink to &quot;åŠŸèƒ½ä»‹ç»&quot;">â€‹</a></h4><blockquote><p>ğŸ’¡æ€è€ƒï¼šåŸºäº setnx å®ç°çš„åˆ†å¸ƒå¼é”å­˜åœ¨ä»€ä¹ˆé—®é¢˜ï¼Ÿ</p></blockquote><p><img src="https://mugrain.oss-cn-hangzhou.aliyuncs.com/cswiki/image-20240314103132756.png" alt="image-20240314103132756" loading="lazy"></p><ul><li><strong>é‡å…¥é—®é¢˜</strong>ï¼šé‡å…¥é—®é¢˜æ˜¯æŒ‡è·å¾—é”çš„çº¿ç¨‹å¯ä»¥å†æ¬¡è¿›å…¥åˆ°ç›¸åŒçš„é”çš„ä»£ç å—ä¸­ï¼Œå¯é‡å…¥é”çš„æ„ä¹‰åœ¨äºé˜²æ­¢æ­»é”ï¼Œæ¯”å¦‚ HashTable è¿™æ ·çš„ä»£ç ä¸­ï¼Œä»–çš„æ–¹æ³•éƒ½æ˜¯ä½¿ç”¨ synchronized ä¿®é¥°çš„ï¼Œå‡å¦‚ä»–åœ¨ä¸€ä¸ªæ–¹æ³•å†…ï¼Œè°ƒç”¨å¦ä¸€ä¸ªæ–¹æ³•ï¼Œé‚£ä¹ˆæ­¤æ—¶å¦‚æœæ˜¯ä¸å¯é‡å…¥çš„ï¼Œä¸å°±æ­»é”äº†å—ï¼Ÿæ‰€ä»¥å¯é‡å…¥é”ä»–çš„ä¸»è¦æ„ä¹‰æ˜¯é˜²æ­¢æ­»é”ï¼Œæˆ‘ä»¬çš„ synchronized å’Œ Lock é”éƒ½æ˜¯å¯é‡å…¥çš„ã€‚</li><li><strong>ä¸å¯é‡è¯•</strong>ï¼šæ˜¯æŒ‡ç›®å‰çš„åˆ†å¸ƒå¼åªèƒ½å°è¯•ä¸€æ¬¡ï¼Œæˆ‘ä»¬è®¤ä¸ºåˆç†çš„æƒ…å†µæ˜¯ï¼šå½“çº¿ç¨‹åœ¨è·å¾—é”å¤±è´¥åï¼Œä»–åº”è¯¥èƒ½å†æ¬¡å°è¯•è·å¾—é”ã€‚</li><li><strong>è¶…æ—¶é‡Šæ”¾</strong>ï¼šæˆ‘ä»¬åœ¨åŠ é”æ—¶å¢åŠ äº†è¿‡æœŸæ—¶é—´ï¼Œè¿™æ ·çš„æˆ‘ä»¬å¯ä»¥é˜²æ­¢æ­»é”ï¼Œä½†æ˜¯å¦‚æœå¡é¡¿çš„æ—¶é—´è¶…é•¿ï¼Œè™½ç„¶æˆ‘ä»¬é‡‡ç”¨äº†luaè¡¨è¾¾å¼é˜²æ­¢åˆ é”çš„æ—¶å€™ï¼Œè¯¯åˆ åˆ«äººçš„é”ï¼Œä½†æ˜¯æ¯•ç«Ÿæ²¡æœ‰é”ä½ï¼Œæœ‰å®‰å…¨éšæ‚£</li><li><strong>ä¸»ä»ä¸€è‡´æ€§</strong>ï¼š å¦‚æœRedisæä¾›äº†ä¸»ä»é›†ç¾¤ï¼Œå½“æˆ‘ä»¬å‘é›†ç¾¤å†™æ•°æ®æ—¶ï¼Œä¸»æœºéœ€è¦å¼‚æ­¥çš„å°†æ•°æ®åŒæ­¥ç»™ä»æœºï¼Œè€Œä¸‡ä¸€åœ¨åŒæ­¥è¿‡å»ä¹‹å‰ï¼Œä¸»æœºå®•æœºäº†ï¼Œå°±ä¼šå‡ºç°æ­»é”é—®é¢˜ã€‚</li></ul><br><blockquote><p>ğŸ’¡æ€è€ƒï¼šé‚£ä¹ˆä»€ä¹ˆæ˜¯Redissionå‘¢ï¼Ÿ</p></blockquote><p>Redissonæ˜¯ä¸€ä¸ªåœ¨ Redis çš„åŸºç¡€ä¸Šå®ç°çš„Javaé©»å†…å­˜æ•°æ®ç½‘æ ¼ï¼ˆIn-Memory Data Gridï¼‰ã€‚å®ƒä¸ä»…æä¾›äº†ä¸€ç³»åˆ—çš„åˆ†å¸ƒå¼çš„ Java å¸¸ç”¨å¯¹è±¡ï¼Œè¿˜æä¾›äº†è®¸å¤šåˆ†å¸ƒå¼æœåŠ¡ï¼Œå…¶ä¸­å°±åŒ…å«äº†å„ç§åˆ†å¸ƒå¼é”çš„å®ç°ã€‚</p><ul><li>å®˜ç½‘åœ°å€ï¼š <a href="https://redisson.org" target="_blank" rel="noreferrer">https://redisson.org</a></li><li>GitHubåœ°å€ï¼š <a href="https://github.com/redisson/redisson" target="_blank" rel="noreferrer">https://github.com/redisson/redisson</a></li></ul><p>Redissionæä¾›äº†åˆ†å¸ƒå¼é”çš„å¤šç§å¤šæ ·çš„åŠŸèƒ½</p><ul><li>æ–‡æ¡£ï¼š<a href="https://github.com/redisson/redisson/wiki/%E7%9B%AE%E5%BD%95" target="_blank" rel="noreferrer">Redisson Wiki (github.com)</a></li></ul><p><img src="https://mugrain.oss-cn-hangzhou.aliyuncs.com/cswiki/image-20240314103630949.png" alt="image-20240314103630949" loading="lazy"></p><h4 id="å¿«é€Ÿå…¥é—¨" tabindex="-1">å¿«é€Ÿå…¥é—¨ <a class="header-anchor" href="#å¿«é€Ÿå…¥é—¨" aria-label="Permalink to &quot;å¿«é€Ÿå…¥é—¨&quot;">â€‹</a></h4><p>å¼•å…¥ä¾èµ–ï¼š</p><div class="language-xml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">xml</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">dependency</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">	&lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">groupId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;org.redisson&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">groupId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">	&lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">artifactId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;redisson&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">artifactId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">	&lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">version</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;3.13.6&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">version</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">dependency</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span></code></pre></div><br><p>é…ç½®Redissonå®¢æˆ·ç«¯</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">package</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.hmdp.config;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> org.redisson.Redisson;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> org.redisson.api.RedissonClient;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> org.redisson.config.Config;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> org.springframework.context.annotation.Bean;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> org.springframework.context.annotation.Configuration;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Configuration</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> RedissonConfig</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Bean</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> RedissonClient </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">redissonClient</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(){</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // é…ç½®</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        Config config </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Config</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        config.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">useSingleServer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setAddress</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;redis://127.0.0.1:6379&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // åˆ›å»ºRedissonClientå¯¹è±¡</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Redisson.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">create</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(config);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><br><p>å¦‚ä½•ä½¿ç”¨ Redission çš„åˆ†å¸ƒå¼é”</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Autowired</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">private</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> RedissonClient redissonClient;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Test</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> testRedisson</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() throws Exception{</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    //è·å–é”(å¯é‡å…¥)ï¼ŒæŒ‡å®šé”çš„åç§°</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    RLock lock </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> redissonClient.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getLock</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;anyLock&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    //å°è¯•è·å–é”ï¼Œå‚æ•°åˆ†åˆ«æ˜¯ï¼šè·å–é”çš„æœ€å¤§ç­‰å¾…æ—¶é—´(æœŸé—´ä¼šé‡è¯•)ï¼Œé”è‡ªåŠ¨é‡Šæ”¾æ—¶é—´ï¼Œæ—¶é—´å•ä½</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    boolean</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> isLock </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> lock.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">tryLock</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">10</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,TimeUnit.SECONDS);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    //åˆ¤æ–­è·å–é”æˆåŠŸ</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(isLock){</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        try</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            System.out.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">println</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;æ‰§è¡Œä¸šåŠ¡&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">finally</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">            //é‡Šæ”¾é”</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            lock.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">unlock</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><br><p>åœ¨ <code>VoucherOrderServiceImpl</code> ä¸­æ³¨å…¥ <code>RedissonClient</code></p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark has-diff vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Resource</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">private</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> RedissonClient redissonClient;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Override</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Result </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">seckillVoucher</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(Long voucherId) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 1.æŸ¥è¯¢ä¼˜æƒ åˆ¸</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    SeckillVoucher voucher </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> seckillVoucherService.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getById</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(voucherId);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 2.åˆ¤æ–­ç§’æ€æ˜¯å¦å¼€å§‹</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (voucher.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getBeginTime</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">isAfter</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(LocalDateTime.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">now</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">())) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      // å°šæœªå¼€å§‹</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Result.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">fail</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;ç§’æ€å°šæœªå¼€å§‹ï¼&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 3.åˆ¤æ–­ç§’æ€æ˜¯å¦å·²ç»ç»“æŸ</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (voucher.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getEndTime</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">isBefore</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(LocalDateTime.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">now</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">())) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      // å°šæœªå¼€å§‹</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Result.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">fail</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;ç§’æ€å·²ç»ç»“æŸï¼&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 4.åˆ¤æ–­åº“å­˜æ˜¯å¦å……è¶³</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (voucher.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getStock</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      // åº“å­˜ä¸è¶³</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Result.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">fail</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;åº“å­˜ä¸è¶³ï¼&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    Long userId </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> UserHolder.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getUser</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    //åˆ›å»ºé”å¯¹è±¡ è¿™ä¸ªä»£ç ä¸ç”¨äº†ï¼Œå› ä¸ºæˆ‘ä»¬ç°åœ¨è¦ä½¿ç”¨åˆ†å¸ƒå¼é”</span></span>
<span class="line diff remove"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    SimpleRedisLock lock </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> SimpleRedisLock</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;order:&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> +</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> userId, stringRedisTemplate);</span></span>
<span class="line diff add"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    RLock lock </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> redissonClient.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getLock</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;lock:order:&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> +</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> userId);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    //è·å–é”å¯¹è±¡</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    boolean</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> isLock </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> lock.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">tryLock</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    //åŠ é”å¤±è´¥</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">isLock) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Result.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">fail</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;ä¸å…è®¸é‡å¤ä¸‹å•&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    try</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      //è·å–ä»£ç†å¯¹è±¡(äº‹åŠ¡)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      IVoucherOrderService proxy </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (IVoucherOrderService) AopContext.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">currentProxy</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> proxy.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">createVoucherOrder</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(voucherId);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">finally</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      //é‡Šæ”¾é”</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      lock.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">unlock</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><br><h4 id="å¯é‡å…¥é”åŸç†" tabindex="-1">å¯é‡å…¥é”åŸç† <a class="header-anchor" href="#å¯é‡å…¥é”åŸç†" aria-label="Permalink to &quot;å¯é‡å…¥é”åŸç†&quot;">â€‹</a></h4><p>åœ¨Locké”ä¸­ï¼Œä»–æ˜¯å€ŸåŠ©äºåº•å±‚çš„ä¸€ä¸ª voaltile çš„ä¸€ä¸ª state å˜é‡æ¥è®°å½•é‡å…¥çš„çŠ¶æ€çš„ï¼Œæ¯”å¦‚å½“å‰æ²¡æœ‰äººæŒæœ‰è¿™æŠŠé”ï¼Œé‚£ä¹ˆ state = 0ï¼Œå‡å¦‚æœ‰äººæŒæœ‰è¿™æŠŠé”ï¼Œé‚£ä¹ˆ state = 1ï¼Œå¦‚æœæŒæœ‰è¿™æŠŠé”çš„äººå†æ¬¡æŒæœ‰è¿™æŠŠé”ï¼Œé‚£ä¹ˆ state å°±ä¼š +1 ï¼Œå¦‚æœæ˜¯å¯¹äº synchronized è€Œè¨€ï¼Œä»–åœ¨ cè¯­è¨€ ä»£ç ä¸­ä¼šæœ‰ä¸€ä¸ª countï¼ŒåŸç†å’Œ state ç±»ä¼¼ï¼Œä¹Ÿæ˜¯é‡å…¥ä¸€æ¬¡å°±åŠ ä¸€ï¼Œé‡Šæ”¾ä¸€æ¬¡å°±-1 ï¼Œç›´åˆ°å‡å°‘æˆ0 æ—¶ï¼Œè¡¨ç¤ºå½“å‰è¿™æŠŠé”æ²¡æœ‰è¢«äººæŒæœ‰ã€‚</p><br><p>åœ¨ <strong>Redission</strong> ä¸­ï¼Œæˆ‘ä»¬çš„ä¹Ÿæ”¯æŒæ”¯æŒå¯é‡å…¥é”.</p><p><img src="https://mugrain.oss-cn-hangzhou.aliyuncs.com/cswiki/image-20240314104022755.png" alt="image-20240314104022755" loading="lazy"></p><p>åœ¨åˆ†å¸ƒå¼é”ä¸­ï¼Œä»–é‡‡ç”¨hashç»“æ„ç”¨æ¥å­˜å‚¨é”ï¼Œå…¶ä¸­å¤§keyè¡¨ç¤ºè¡¨ç¤ºè¿™æŠŠé”æ˜¯å¦å­˜åœ¨ï¼Œç”¨å°keyè¡¨ç¤ºå½“å‰è¿™æŠŠé”è¢«å“ªä¸ªçº¿ç¨‹æŒæœ‰ï¼Œæ‰€ä»¥æ¥ä¸‹æ¥æˆ‘ä»¬ä¸€èµ·åˆ†æä¸€ä¸‹å½“å‰çš„è¿™ä¸ª Lua è¡¨è¾¾å¼</p><br><p>è·å–é”çš„Luaè„šæœ¬</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">local</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> key </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> KEYS[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- é”çš„key</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">local</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> threadId </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ARGV[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- çº¿ç¨‹å”¯ä¸€æ ‡è¯†</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">local</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> releaseTime </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ARGV[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- é”çš„è‡ªåŠ¨é‡Šæ”¾æ—¶é—´</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- åˆ¤æ–­æ˜¯å¦å­˜åœ¨</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (redis.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">call</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;exists&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, key) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">then</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    -- ä¸å­˜åœ¨, è·å–é”</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    redis.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">call</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;hset&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, key, threadId, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;1&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    -- è®¾ç½®æœ‰æ•ˆæœŸ</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    redis.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">call</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;expire&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, key, releaseTime);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- è¿”å›ç»“æœ</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- é”å·²ç»å­˜åœ¨ï¼Œåˆ¤æ–­threadIdæ˜¯å¦æ˜¯è‡ªå·±</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (redis.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">call</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;hexists&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, key, threadId) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">then</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    -- ä¸å­˜åœ¨, è·å–é”ï¼Œé‡å…¥æ¬¡æ•°+1</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    redis.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">call</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;hincrby&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, key, threadId, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;1&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    -- è®¾ç½®æœ‰æ•ˆæœŸ</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    redis.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">call</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;expire&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, key, releaseTime);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- è¿”å›ç»“æœ</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- ä»£ç èµ°åˆ°è¿™é‡Œ,è¯´æ˜è·å–é”çš„ä¸æ˜¯è‡ªå·±ï¼Œè·å–é”å¤±è´¥</span></span></code></pre></div><br><p>é‡Šæ”¾é”çš„ Lua è„šæœ¬</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">local</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> key </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> KEYS[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- é”çš„key</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">local</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> threadId </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ARGV[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- çº¿ç¨‹å”¯ä¸€æ ‡è¯†</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">local</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> releaseTime </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ARGV[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- é”çš„è‡ªåŠ¨é‡Šæ”¾æ—¶é—´</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- åˆ¤æ–­å½“å‰é”æ˜¯å¦è¿˜æ˜¯è¢«è‡ªå·±æŒæœ‰</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (redis.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">call</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;HEXISTS&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, key, threadId) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">then</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> nil</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- å¦‚æœå·²ç»ä¸æ˜¯è‡ªå·±ï¼Œåˆ™ç›´æ¥è¿”å›</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- æ˜¯è‡ªå·±çš„é”ï¼Œåˆ™é‡å…¥æ¬¡æ•°-1</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">local</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> count </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> redis.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">call</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;HINCRBY&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, key, threadId, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- åˆ¤æ–­æ˜¯å¦é‡å…¥æ¬¡æ•°æ˜¯å¦å·²ç»ä¸º0 </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (count </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">then</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    -- å¤§äº0è¯´æ˜ä¸èƒ½é‡Šæ”¾é”ï¼Œé‡ç½®æœ‰æ•ˆæœŸç„¶åè¿”å›</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    redis.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">call</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;EXPIRE&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, key, releaseTime);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> nil</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">else</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    -- ç­‰äº0è¯´æ˜å¯ä»¥é‡Šæ”¾é”ï¼Œç›´æ¥åˆ é™¤</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    redis.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">call</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;DEL&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, key);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> nil</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ;</span></span></code></pre></div><p>è¿™ä¸ªåœ°æ–¹ä¸€å…±æœ‰3ä¸ªå‚æ•°</p><ul><li>KEYS[1] ï¼š é”åç§°</li><li>ARGV[1]ï¼š é”å¤±æ•ˆæ—¶é—´</li><li>ARGV[2]ï¼š id + &quot;:&quot; + threadId; é”çš„å°key</li></ul><p>exists: åˆ¤æ–­æ•°æ®æ˜¯å¦å­˜åœ¨ nameï¼šæ˜¯lockæ˜¯å¦å­˜åœ¨,å¦‚æœ ==0ï¼Œå°±è¡¨ç¤ºå½“å‰è¿™æŠŠé”ä¸å­˜åœ¨</p><p><code>redis.call(&#39;hset&#39;, KEYS[1], ARGV[2], 1)</code>ï¼›</p><p>æ­¤æ—¶ä»–å°±å¼€å§‹å¾€redisé‡Œè¾¹å»å†™æ•°æ® ï¼Œå†™æˆä¸€ä¸ªhashç»“æ„</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Lock{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> **</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;:&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">**</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> +</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> threadId </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  1</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>å¦‚æœå½“å‰è¿™æŠŠé”å­˜åœ¨ï¼Œåˆ™ç¬¬ä¸€ä¸ªæ¡ä»¶ä¸æ»¡è¶³ï¼Œå†åˆ¤æ–­</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">redis.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">call</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;hexists&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, KEYS[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">], ARGV[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span></span></code></pre></div><p>æ­¤æ—¶éœ€è¦é€šè¿‡å¤§key+å°keyåˆ¤æ–­å½“å‰è¿™æŠŠé”æ˜¯å¦æ˜¯å±äºè‡ªå·±çš„ï¼Œå¦‚æœæ˜¯è‡ªå·±çš„ï¼Œåˆ™è¿›è¡Œ</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">redis.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">call</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;hincrby&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, KEYS[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">], ARGV[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">], </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><p>å°†å½“å‰è¿™ä¸ªé”çš„valueè¿›è¡Œ+1 ï¼Œ<code>redis.call(&#39;pexpire&#39;, KEYS[1], ARGV[1])</code>ï¼› ç„¶åå†å¯¹å…¶è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œå¦‚æœä»¥ä¸Šä¸¤ä¸ªæ¡ä»¶éƒ½ä¸æ»¡è¶³ï¼Œåˆ™è¡¨ç¤ºå½“å‰è¿™æŠŠé”æŠ¢é”å¤±è´¥ï¼Œæœ€åè¿”å›pttlï¼Œå³ä¸ºå½“å‰è¿™æŠŠé”çš„å¤±æ•ˆæ—¶é—´</p><br><p>å¦‚æœå°ä¼™å¸®ä»¬çœ‹äº†å‰è¾¹çš„æºç ï¼Œ ä½ ä¼šå‘ç°ä»–ä¼šå»åˆ¤æ–­å½“å‰è¿™ä¸ªæ–¹æ³•çš„è¿”å›å€¼æ˜¯å¦ä¸ºnullï¼Œå¦‚æœæ˜¯nullï¼Œåˆ™å¯¹åº”åˆ™å‰ä¸¤ä¸ªifå¯¹åº”çš„æ¡ä»¶ï¼Œé€€å‡ºæŠ¢é”é€»è¾‘ï¼Œå¦‚æœè¿”å›çš„ä¸æ˜¯nullï¼Œå³èµ°äº†ç¬¬ä¸‰ä¸ªåˆ†æ”¯ï¼Œåœ¨æºç å¤„ä¼šè¿›è¡Œwhile(true)çš„è‡ªæ—‹æŠ¢é”ã€‚</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;if (redis.call(&#39;exists&#39;, KEYS[1]) == 0) then &quot; </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">	&quot;redis.call(&#39;hset&#39;, KEYS[1], ARGV[2], 1); &quot; </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">	&quot;redis.call(&#39;pexpire&#39;, KEYS[1], ARGV[1]); &quot; </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">	&quot;return nil; &quot; </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;end; &quot; </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;if (redis.call(&#39;hexists&#39;, KEYS[1], ARGV[2]) == 1) then &quot; </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">	&quot;redis.call(&#39;hincrby&#39;, KEYS[1], ARGV[2], 1); &quot; </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">	&quot;redis.call(&#39;pexpire&#39;, KEYS[1], ARGV[1]); &quot; </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">	&quot;return nil; &quot; </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;end; &quot; </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;return redis.call(&#39;pttl&#39;, KEYS[1]);&quot;</span></span></code></pre></div><br><h4 id="é”é‡è¯•å’Œwatchdogæœºåˆ¶" tabindex="-1">é”é‡è¯•å’ŒWatchDogæœºåˆ¶ <a class="header-anchor" href="#é”é‡è¯•å’Œwatchdogæœºåˆ¶" aria-label="Permalink to &quot;é”é‡è¯•å’ŒWatchDogæœºåˆ¶&quot;">â€‹</a></h4><p><strong>è¯´æ˜</strong>ï¼šç”±äºè¯¾ç¨‹ä¸­å·²ç»è¯´æ˜äº†æœ‰å…³tryLockçš„æºç è§£æä»¥åŠå…¶çœ‹é—¨ç‹—åŸç†ï¼Œæ‰€ä»¥ç¬”è€…åœ¨è¿™é‡Œç»™å¤§å®¶åˆ†ælock()æ–¹æ³•çš„æºç è§£æï¼Œå¸Œæœ›å¤§å®¶åœ¨å­¦ä¹ è¿‡ç¨‹ä¸­ï¼Œèƒ½å¤ŸæŒæ¡æ›´å¤šçš„çŸ¥è¯†ã€‚</p><p><img src="https://mugrain.oss-cn-hangzhou.aliyuncs.com/cswiki/image-20240314104730357.png" alt="image-20240314104730357" loading="lazy"></p><p>æŠ¢é”è¿‡ç¨‹ä¸­ï¼Œè·å¾—å½“å‰çº¿ç¨‹ï¼Œé€šè¿‡ tryAcquire è¿›è¡ŒæŠ¢é”ï¼Œè¯¥æŠ¢é”é€»è¾‘å’Œä¹‹å‰é€»è¾‘ç›¸åŒ</p><ul><li>å…ˆåˆ¤æ–­å½“å‰è¿™æŠŠé”æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨ï¼Œæ’å…¥ä¸€æŠŠé”ï¼Œè¿”å›null</li><li>åˆ¤æ–­å½“å‰è¿™æŠŠé”æ˜¯å¦æ˜¯å±äºå½“å‰çº¿ç¨‹ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™è¿”å›null</li></ul><br><p>æ‰€ä»¥å¦‚æœè¿”å›æ˜¯nullï¼Œåˆ™ä»£è¡¨ç€å½“å‰è¿™å“¥ä»¬å·²ç»æŠ¢é”å®Œæ¯•ï¼Œæˆ–è€…å¯é‡å…¥å®Œæ¯•ï¼Œä½†æ˜¯å¦‚æœä»¥ä¸Šä¸¤ä¸ªæ¡ä»¶éƒ½ä¸æ»¡è¶³ï¼Œåˆ™è¿›å…¥åˆ°ç¬¬ä¸‰ä¸ªæ¡ä»¶ï¼Œè¿”å›çš„æ˜¯é”çš„å¤±æ•ˆæ—¶é—´ï¼ŒåŒå­¦ä»¬å¯ä»¥è‡ªè¡Œå¾€ä¸‹ç¿»ä¸€ç‚¹ç‚¹ï¼Œä½ èƒ½å‘ç°æœ‰ä¸ª while(true) å†æ¬¡è¿›è¡Œ tryAcquire è¿›è¡ŒæŠ¢é”</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">long</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> threadId </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Thread.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">currentThread</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Long ttl </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> tryAcquire</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, leaseTime, unit, threadId);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// lock acquired</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (ttl </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>æ¥ä¸‹æ¥ä¼šæœ‰ä¸€ä¸ªæ¡ä»¶åˆ†æ”¯ï¼Œå› ä¸ºlockæ–¹æ³•æœ‰é‡è½½æ–¹æ³•ï¼Œä¸€ä¸ªæ˜¯å¸¦å‚æ•°ï¼Œä¸€ä¸ªæ˜¯ä¸å¸¦å‚æ•°ï¼Œå¦‚æœå¸¦å¸¦å‚æ•°ä¼ å…¥çš„å€¼æ˜¯-1ï¼Œå¦‚æœä¼ å…¥å‚æ•°ï¼Œåˆ™ leaseTime æ˜¯ä»–æœ¬èº«ï¼Œæ‰€ä»¥å¦‚æœä¼ å…¥äº†å‚æ•°ï¼Œæ­¤æ—¶ leaseTime != -1 åˆ™ä¼šè¿›å»æŠ¢é”ï¼ŒæŠ¢é”çš„é€»è¾‘å°±æ˜¯ä¹‹å‰è¯´çš„é‚£ä¸‰ä¸ªé€»è¾‘</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (leaseTime </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> -</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> tryLockInnerAsync</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(waitTime, leaseTime, unit, threadId, RedisCommands.EVAL_LONG);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>å¦‚æœæ˜¯æ²¡æœ‰ä¼ å…¥æ—¶é—´ï¼Œåˆ™æ­¤æ—¶ä¹Ÿä¼šè¿›è¡ŒæŠ¢é”ï¼Œ è€Œä¸”æŠ¢é”æ—¶é—´æ˜¯é»˜è®¤çœ‹é—¨ç‹—æ—¶é—´ <code>commandExecutor.getConnectionManager().getCfg().getLockWatchdogTimeout()</code>ï¼Œ</p><p><code>ttlRemainingFuture.onComplete((ttlRemaining, e)</code> è¿™å¥è¯ç›¸å½“äºå¯¹ä»¥ä¸ŠæŠ¢é”è¿›è¡Œäº†ç›‘å¬ï¼Œä¹Ÿå°±æ˜¯è¯´å½“ä¸Šè¾¹æŠ¢é”å®Œæ¯•åï¼Œæ­¤æ–¹æ³•ä¼šè¢«è°ƒç”¨ï¼Œå…·ä½“è°ƒç”¨çš„é€»è¾‘å°±æ˜¯å»åå°å¼€å¯ä¸€ä¸ªçº¿ç¨‹ï¼Œè¿›è¡Œç»­çº¦é€»è¾‘ï¼Œä¹Ÿå°±æ˜¯çœ‹é—¨ç‹—çº¿ç¨‹</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">RFuture&lt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Long</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; ttlRemainingFuture </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> tryLockInnerAsync</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(waitTime,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                                        commandExecutor.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getConnectionManager</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getCfg</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getLockWatchdogTimeout</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                                        TimeUnit.MILLISECONDS, threadId, RedisCommands.EVAL_LONG);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ttlRemainingFuture.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">onComplete</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">((ttlRemaining, e) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (e </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // lock acquired</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (ttlRemaining </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        scheduleExpirationRenewal</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(threadId);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ttlRemainingFuture;</span></span></code></pre></div><p>æ­¤é€»è¾‘å°±æ˜¯ç»­çº¦é€»è¾‘ï¼Œæ³¨æ„çœ‹ <code>commandExecutor.getConnectionManager().newTimeout()</code> æ­¤æ–¹æ³•</p><p><code>Method( new TimerTask() {},å‚æ•°2 ï¼Œå‚æ•°3 )</code></p><p>æŒ‡çš„æ˜¯ï¼šé€šè¿‡å‚æ•°2ï¼Œå‚æ•°3 å»æè¿°ä»€ä¹ˆæ—¶å€™å»åšå‚æ•°1çš„äº‹æƒ…ï¼Œç°åœ¨çš„æƒ…å†µæ˜¯ï¼š10sä¹‹åå»åšå‚æ•°ä¸€çš„äº‹æƒ…</p><br><p>å› ä¸ºé”çš„å¤±æ•ˆæ—¶é—´æ˜¯30sï¼Œå½“10sä¹‹åï¼Œæ­¤æ—¶è¿™ä¸ªtimeTask å°±è§¦å‘äº†ï¼Œä»–å°±å»è¿›è¡Œç»­çº¦ï¼ŒæŠŠå½“å‰è¿™æŠŠé”ç»­çº¦æˆ30sï¼Œå¦‚æœæ“ä½œæˆåŠŸï¼Œé‚£ä¹ˆæ­¤æ—¶å°±ä¼šé€’å½’è°ƒç”¨è‡ªå·±ï¼Œå†é‡æ–°è®¾ç½®ä¸€ä¸ªtimeTask()ï¼Œäºæ˜¯å†è¿‡10sååˆå†è®¾ç½®ä¸€ä¸ªtimerTaskï¼Œå®Œæˆä¸åœçš„ç»­çº¦ã€‚</p><br><p>é‚£ä¹ˆå¤§å®¶å¯ä»¥æƒ³ä¸€æƒ³ï¼Œå‡è®¾æˆ‘ä»¬çš„çº¿ç¨‹å‡ºç°äº†å®•æœºä»–è¿˜ä¼šç»­çº¦å—ï¼Ÿå½“ç„¶ä¸ä¼šï¼Œå› ä¸ºæ²¡æœ‰äººå†å»è°ƒç”¨ <code>renewExpiration</code> è¿™ä¸ªæ–¹æ³•ï¼Œæ‰€ä»¥ç­‰åˆ°æ—¶é—´ä¹‹åè‡ªç„¶å°±é‡Šæ”¾äº†ã€‚</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">private</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> renewExpiration</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ExpirationEntry ee </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> EXPIRATION_RENEWAL_MAP.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getEntryName</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">());</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (ee </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    Timeout task </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> commandExecutor.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getConnectionManager</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">newTimeout</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> TimerTask</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Override</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> run</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(Timeout </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">timeout</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">throws</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Exception {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            ExpirationEntry ent </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> EXPIRATION_RENEWAL_MAP.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getEntryName</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">());</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (ent </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">                return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            Long threadId </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ent.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getFirstThreadId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (threadId </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">                return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            RFuture&lt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Boolean</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; future </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> renewExpirationAsync</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(threadId);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            future.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">onComplete</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">((res, e) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">                if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (e </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                    log.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Can&#39;t update lock &quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> +</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> getName</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot; expiration&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, e);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">                    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">                if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (res) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                    // reschedule itself</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">                    renewExpiration</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            });</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }, internalLockLeaseTime </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">/</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 3</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, TimeUnit.MILLISECONDS);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ee.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setTimeout</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(task);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><div class="warning custom-block"><p class="custom-block-title">æ€»ç»“ï¼šRedissonåˆ†å¸ƒå¼é”åŸç†</p><ul><li>å¯é‡å…¥ï¼šåˆ©ç”¨hashç»“æ„è®°å½•çº¿ç¨‹idå’Œé‡å…¥æ¬¡æ•°</li><li>å¯é‡è¯•ï¼šåˆ©ç”¨ä¿¡å·é‡å’ŒPubSubåŠŸèƒ½å®ç°ç­‰å¾…ã€å”¤é†’ï¼Œè·å–é”å¤±è´¥çš„é‡è¯•æœºåˆ¶</li><li>è¶…æ—¶ç»­çº¦ï¼šåˆ©ç”¨ watchDogï¼Œæ¯éš”ä¸€æ®µæ—¶é—´ï¼ˆreleaseTime / 3ï¼‰ï¼Œé‡ç½®è¶…æ—¶æ—¶é—´</li></ul></div><br><h4 id="é”çš„mutilockåŸç†" tabindex="-1">é”çš„MutiLockåŸç† <a class="header-anchor" href="#é”çš„mutilockåŸç†" aria-label="Permalink to &quot;é”çš„MutiLockåŸç†&quot;">â€‹</a></h4><p>ä¸ºäº†æé«˜ Redis çš„å¯ç”¨æ€§ï¼Œæˆ‘ä»¬ä¼šæ­å»ºé›†ç¾¤æˆ–è€…ä¸»ä»ï¼Œç°åœ¨ä»¥ä¸»ä»ä¸ºä¾‹</p><p>æ­¤æ—¶æˆ‘ä»¬å»å†™å‘½ä»¤ï¼Œå†™åœ¨ä¸»æœºä¸Šï¼Œ ä¸»æœºä¼šå°†æ•°æ®åŒæ­¥ç»™ä»æœºï¼Œä½†æ˜¯å‡è®¾åœ¨ä¸»æœºè¿˜æ²¡æœ‰æ¥å¾—åŠæŠŠæ•°æ®å†™å…¥åˆ°ä»æœºå»çš„æ—¶å€™ï¼Œæ­¤æ—¶ä¸»æœºå®•æœºï¼Œå“¨å…µä¼šå‘ç°ä¸»æœºå®•æœºï¼Œå¹¶ä¸”é€‰ä¸¾ä¸€ä¸ªslaveå˜æˆmasterï¼Œè€Œæ­¤æ—¶æ–°çš„masterä¸­å®é™…ä¸Šå¹¶æ²¡æœ‰é”ä¿¡æ¯ï¼Œæ­¤æ—¶é”ä¿¡æ¯å°±å·²ç»ä¸¢æ‰äº†ã€‚</p><p><img src="https://mugrain.oss-cn-hangzhou.aliyuncs.com/cswiki/image-20240314104811029.png" alt="image-20240314104811029" loading="lazy"></p><p>ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒRedission æå‡ºæ¥äº† MutiLock é”ï¼Œä½¿ç”¨è¿™æŠŠé”å’±ä»¬å°±ä¸ä½¿ç”¨ä¸»ä»äº†ï¼Œæ¯ä¸ªèŠ‚ç‚¹çš„åœ°ä½éƒ½æ˜¯ä¸€æ ·çš„ï¼Œ è¿™æŠŠé”åŠ é”çš„é€»è¾‘éœ€è¦å†™å…¥åˆ°æ¯ä¸€ä¸ªä¸»ä¸›èŠ‚ç‚¹ä¸Šï¼Œåªæœ‰æ‰€æœ‰çš„æœåŠ¡å™¨éƒ½å†™å…¥æˆåŠŸï¼Œæ­¤æ—¶æ‰æ˜¯åŠ é”æˆåŠŸï¼Œå‡è®¾ç°åœ¨æŸä¸ªèŠ‚ç‚¹æŒ‚äº†ï¼Œé‚£ä¹ˆä»–å»è·å¾—é”çš„æ—¶å€™ï¼Œåªè¦æœ‰ä¸€ä¸ªèŠ‚ç‚¹æ‹¿ä¸åˆ°ï¼Œéƒ½ä¸èƒ½ç®—æ˜¯åŠ é”æˆåŠŸï¼Œå°±ä¿è¯äº†åŠ é”çš„å¯é æ€§ã€‚</p><blockquote><p>çº¢é”å’Œè”é”çš„åŒºåˆ«ï¼šçº¢é”éœ€è¦åœ¨ï¼ˆn / 2 + 1ï¼‰å®ä¾‹ä¸Šåˆ›å»ºé”æ‰ç®—åŠ é”æˆåŠŸï¼Œè”é”è¦åœ¨æ‰€æœ‰é”éƒ½ä¸Šé”æ‰ç®—æˆåŠŸ</p></blockquote><p><img src="https://mugrain.oss-cn-hangzhou.aliyuncs.com/cswiki/image-20240314104831560.png" alt="image-20240314104831560" loading="lazy"></p><br><p>é‚£ä¹ˆ MutiLock åŠ é”åŸç†æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿç¬”è€…ç”»äº†ä¸€å¹…å›¾æ¥è¯´æ˜</p><p>å½“æˆ‘ä»¬å»è®¾ç½®äº†å¤šä¸ªé”æ—¶ï¼ŒRedission ä¼šå°†å¤šä¸ªé”æ·»åŠ åˆ°ä¸€ä¸ªé›†åˆä¸­ï¼Œç„¶åç”¨whileå¾ªç¯å»ä¸åœå»å°è¯•æ‹¿é”ï¼Œä½†æ˜¯ä¼šæœ‰ä¸€ä¸ªæ€»å…±çš„åŠ é”æ—¶é—´ï¼Œè¿™ä¸ªæ—¶é—´æ˜¯ç”¨éœ€è¦ åŠ é”çš„ä¸ªæ•° * 1500ms ï¼Œå‡è®¾æœ‰3ä¸ªé”ï¼Œé‚£ä¹ˆæ—¶é—´å°±æ˜¯4500msï¼Œå‡è®¾åœ¨è¿™4500mså†…ï¼Œæ‰€æœ‰çš„é”éƒ½åŠ é”æˆåŠŸï¼Œ é‚£ä¹ˆæ­¤æ—¶æ‰ç®—æ˜¯åŠ é”æˆåŠŸï¼Œå¦‚æœåœ¨4500msæœ‰çº¿ç¨‹åŠ é”å¤±è´¥ï¼Œåˆ™ä¼šå†æ¬¡å»è¿›è¡Œé‡è¯•.</p><p><img src="https://mugrain.oss-cn-hangzhou.aliyuncs.com/cswiki/image-20240314104919132.png" alt="image-20240314104919132" loading="lazy"></p><br><div class="warning custom-block"><p class="custom-block-title">æ€»ç»“</p><ol><li><p>ä¸å¯é‡å…¥Redisåˆ†å¸ƒå¼é”ï¼š</p><ul><li><p>åŸç†ï¼šåˆ©ç”¨setnxçš„äº’æ–¥æ€§ï¼›åˆ©ç”¨exé¿å…æ­»é”ï¼›é‡Šæ”¾é”æ—¶åˆ¤æ–­çº¿ç¨‹æ ‡ç¤º</p></li><li><p>ç¼ºé™·ï¼šä¸å¯é‡å…¥ã€æ— æ³•é‡è¯•ã€é”è¶…æ—¶å¤±æ•ˆ</p></li></ul></li><li><p>å¯é‡å…¥çš„Redisåˆ†å¸ƒå¼é”ï¼š</p><ul><li><p>åŸç†ï¼šåˆ©ç”¨hashç»“æ„ï¼Œè®°å½•çº¿ç¨‹æ ‡ç¤ºå’Œé‡å…¥æ¬¡æ•°ï¼›åˆ©ç”¨watchDogå»¶ç»­é”æ—¶é—´ï¼›åˆ©ç”¨ä¿¡å·é‡æ§åˆ¶é”é‡è¯•ç­‰å¾…</p></li><li><p>ç¼ºé™·ï¼šrediså®•æœºå¼•èµ·é”å¤±æ•ˆé—®é¢˜</p></li></ul></li><li><p>Redissonçš„multiLockï¼š</p><ul><li><p>åŸç†ï¼šå¤šä¸ªç‹¬ç«‹çš„RedisèŠ‚ç‚¹ï¼Œå¿…é¡»åœ¨æ‰€æœ‰èŠ‚ç‚¹éƒ½è·å–é‡å…¥é”ï¼Œæ‰ç®—è·å–é”æˆåŠŸ</p></li><li><p>ç¼ºé™·ï¼šè¿ç»´æˆæœ¬é«˜ã€å®ç°å¤æ‚</p></li></ul></li></ol></div><br><h3 id="ç§’æ€ä¼˜åŒ–" tabindex="-1">ç§’æ€ä¼˜åŒ– <a class="header-anchor" href="#ç§’æ€ä¼˜åŒ–" aria-label="Permalink to &quot;ç§’æ€ä¼˜åŒ–&quot;">â€‹</a></h3><h4 id="å¼‚æ­¥ç§’æ€æ€è·¯" tabindex="-1">å¼‚æ­¥ç§’æ€æ€è·¯ <a class="header-anchor" href="#å¼‚æ­¥ç§’æ€æ€è·¯" aria-label="Permalink to &quot;å¼‚æ­¥ç§’æ€æ€è·¯&quot;">â€‹</a></h4><p>æˆ‘ä»¬æ¥å›é¡¾ä¸€ä¸‹ä¸‹å•æµç¨‹</p><p><img src="https://mugrain.oss-cn-hangzhou.aliyuncs.com/cswiki/image-20240314105212398.png" alt="image-20240314105212398" loading="lazy"></p><p>å½“ç”¨æˆ·å‘èµ·è¯·æ±‚ï¼Œæ­¤æ—¶ä¼šè¯·æ±‚ Nginxï¼ŒNginxä¼šè®¿é—®åˆ° Tomcatï¼Œè€Œ Tomcat ä¸­çš„ç¨‹åºï¼Œä¼šè¿›è¡Œä¸²è¡Œæ“ä½œï¼Œåˆ†æˆå¦‚ä¸‹å‡ ä¸ªæ­¥éª¤</p><ol><li>æŸ¥è¯¢ä¼˜æƒ å·</li><li>åˆ¤æ–­ç§’æ€åº“å­˜æ˜¯å¦è¶³å¤Ÿ</li><li>æŸ¥è¯¢è®¢å•</li><li>æ ¡éªŒæ˜¯å¦æ˜¯ä¸€äººä¸€å•</li><li>æ‰£å‡åº“å­˜</li><li>åˆ›å»ºè®¢å•</li></ol><p>åœ¨è¿™å…­æ­¥æ“ä½œä¸­ï¼Œåˆæœ‰å¾ˆå¤šæ“ä½œæ˜¯è¦å»æ“ä½œæ•°æ®åº“çš„ï¼Œè€Œä¸”è¿˜æ˜¯ä¸€ä¸ªçº¿ç¨‹ä¸²è¡Œæ‰§è¡Œï¼Œ è¿™æ ·å°±ä¼šå¯¼è‡´æˆ‘ä»¬çš„ç¨‹åºæ‰§è¡Œçš„å¾ˆæ…¢ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å¼‚æ­¥ç¨‹åºæ‰§è¡Œï¼Œé‚£ä¹ˆå¦‚ä½•åŠ é€Ÿå‘¢ï¼Ÿ</p><br><p>åœ¨è¿™é‡Œç¬”è€…æƒ³ç»™å¤§å®¶åˆ†äº«ä¸€ä¸‹è¯¾ç¨‹å†…æ²¡æœ‰çš„æ€è·¯ï¼Œçœ‹çœ‹æœ‰æ²¡æœ‰å°ä¼™ä¼´è¿™ä¹ˆæƒ³ï¼Œæ¯”å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥ä¸å¯ä»¥ä½¿ç”¨å¼‚æ­¥ç¼–æ’æ¥åšï¼Œæˆ–è€…è¯´æˆ‘å¼€å¯Nå¤šçº¿ç¨‹ï¼ŒNå¤šä¸ªçº¿ç¨‹ï¼Œä¸€ä¸ªçº¿ç¨‹æ‰§è¡ŒæŸ¥è¯¢ä¼˜æƒ å·ï¼Œä¸€ä¸ªæ‰§è¡Œåˆ¤æ–­æ‰£å‡åº“å­˜ï¼Œä¸€ä¸ªå»åˆ›å»ºè®¢å•ç­‰ç­‰ï¼Œç„¶åå†ç»Ÿä¸€åšè¿”å›ï¼Œè¿™ç§åšæ³•å’Œè¯¾ç¨‹ä¸­æœ‰å“ªç§å¥½å‘¢ï¼Ÿç­”æ¡ˆæ˜¯è¯¾ç¨‹ä¸­çš„å¥½ï¼Œå› ä¸ºå¦‚æœä½ é‡‡ç”¨æˆ‘åˆšè¯´çš„æ–¹å¼ï¼Œå¦‚æœè®¿é—®çš„äººå¾ˆå¤šï¼Œé‚£ä¹ˆçº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹å¯èƒ½ä¸€ä¸‹å­å°±è¢«æ¶ˆè€—å®Œäº†ï¼Œè€Œä¸”ä½ ä½¿ç”¨ä¸Šè¿°æ–¹æ¡ˆï¼Œæœ€å¤§çš„ç‰¹ç‚¹åœ¨äºï¼Œä½ è§‰å¾—æ—¶æ•ˆæ€§ä¼šéå¸¸é‡è¦ï¼Œä½†æ˜¯ä½ æƒ³æƒ³æ˜¯å—ï¼Ÿå¹¶ä¸æ˜¯ï¼Œæ¯”å¦‚æˆ‘åªè¦ç¡®å®šä»–èƒ½åšè¿™ä»¶äº‹ï¼Œç„¶åæˆ‘åè¾¹æ…¢æ…¢åšå°±å¯ä»¥äº†ï¼Œæˆ‘å¹¶ä¸éœ€è¦ä»–ä¸€å£æ°”åšå®Œè¿™ä»¶äº‹ï¼Œæ‰€ä»¥æˆ‘ä»¬åº”å½“é‡‡ç”¨çš„æ˜¯è¯¾ç¨‹ä¸­ï¼Œç±»ä¼¼æ¶ˆæ¯é˜Ÿåˆ—çš„æ–¹å¼æ¥å®Œæˆæˆ‘ä»¬çš„éœ€æ±‚ï¼Œè€Œä¸æ˜¯ä½¿ç”¨çº¿ç¨‹æ± æˆ–è€…æ˜¯å¼‚æ­¥ç¼–æ’çš„æ–¹å¼æ¥å®Œæˆè¿™ä¸ªéœ€æ±‚</p><br><p><strong>ä¼˜åŒ–æ–¹æ¡ˆ</strong></p><p><img src="https://mugrain.oss-cn-hangzhou.aliyuncs.com/cswiki/image-20240314105309915.png" alt="image-20240314105309915" loading="lazy"></p><p>ä¼˜åŒ–æ–¹æ¡ˆï¼šæˆ‘ä»¬å°†è€—æ—¶æ¯”è¾ƒçŸ­çš„é€»è¾‘åˆ¤æ–­æ”¾å…¥åˆ°redisä¸­ï¼Œæ¯”å¦‚æ˜¯å¦åº“å­˜è¶³å¤Ÿï¼Œæ¯”å¦‚æ˜¯å¦ä¸€äººä¸€å•ï¼Œè¿™æ ·çš„æ“ä½œï¼Œåªè¦è¿™ç§é€»è¾‘å¯ä»¥å®Œæˆï¼Œå°±æ„å‘³ç€æˆ‘ä»¬æ˜¯ä¸€å®šå¯ä»¥ä¸‹å•å®Œæˆçš„ï¼Œæˆ‘ä»¬åªéœ€è¦è¿›è¡Œå¿«é€Ÿçš„é€»è¾‘åˆ¤æ–­ï¼Œæ ¹æœ¬å°±ä¸ç”¨ç­‰ä¸‹å•é€»è¾‘èµ°å®Œï¼Œæˆ‘ä»¬ç›´æ¥ç»™ç”¨æˆ·è¿”å›æˆåŠŸï¼Œ å†åœ¨åå°å¼€ä¸€ä¸ªçº¿ç¨‹ï¼Œåå°çº¿ç¨‹æ…¢æ…¢çš„å»æ‰§è¡Œqueueé‡Œè¾¹çš„æ¶ˆæ¯ï¼Œè¿™æ ·ç¨‹åºä¸å°±è¶…çº§å¿«äº†å—ï¼Ÿè€Œä¸”ä¹Ÿä¸ç”¨æ‹…å¿ƒçº¿ç¨‹æ± æ¶ˆè€—æ®†å°½çš„é—®é¢˜ï¼Œå› ä¸ºè¿™é‡Œæˆ‘ä»¬çš„ç¨‹åºä¸­å¹¶æ²¡æœ‰æ‰‹åŠ¨ä½¿ç”¨ä»»ä½•çº¿ç¨‹æ± ï¼Œå½“ç„¶è¿™é‡Œè¾¹æœ‰ä¸¤ä¸ªéš¾ç‚¹</p><p>ç¬¬ä¸€ä¸ªéš¾ç‚¹æ˜¯æˆ‘ä»¬æ€ä¹ˆåœ¨redisä¸­å»å¿«é€Ÿæ ¡éªŒä¸€äººä¸€å•ï¼Œè¿˜æœ‰åº“å­˜åˆ¤æ–­</p><p>ç¬¬äºŒä¸ªéš¾ç‚¹æ˜¯ç”±äºæˆ‘ä»¬æ ¡éªŒå’Œtomctä¸‹å•æ˜¯ä¸¤ä¸ªçº¿ç¨‹ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¦‚ä½•çŸ¥é“åˆ°åº•å“ªä¸ªå•ä»–æœ€åæ˜¯å¦æˆåŠŸï¼Œæˆ–è€…æ˜¯ä¸‹å•å®Œæˆï¼Œä¸ºäº†å®Œæˆè¿™ä»¶äº‹æˆ‘ä»¬åœ¨redisæ“ä½œå®Œä¹‹åï¼Œæˆ‘ä»¬ä¼šå°†ä¸€äº›ä¿¡æ¯è¿”å›ç»™å‰ç«¯ï¼ŒåŒæ—¶ä¹Ÿä¼šæŠŠè¿™äº›ä¿¡æ¯ä¸¢åˆ°å¼‚æ­¥queueä¸­å»ï¼Œåç»­æ“ä½œä¸­ï¼Œå¯ä»¥é€šè¿‡è¿™ä¸ªidæ¥æŸ¥è¯¢æˆ‘ä»¬tomcatä¸­çš„ä¸‹å•é€»è¾‘æ˜¯å¦å®Œæˆäº†ã€‚</p><br><p><strong>ä¼˜åŒ–æµç¨‹</strong></p><p><img src="https://mugrain.oss-cn-hangzhou.aliyuncs.com/cswiki/image-20240314105449719.png" alt="image-20240314105449719" loading="lazy"></p><p>æˆ‘ä»¬ç°åœ¨æ¥çœ‹çœ‹æ•´ä½“æ€è·¯ï¼šå½“ç”¨æˆ·ä¸‹å•ä¹‹åï¼Œåˆ¤æ–­åº“å­˜æ˜¯å¦å……è¶³åªéœ€è¦å¯¼redisä¸­å»æ ¹æ®keyæ‰¾å¯¹åº”çš„valueæ˜¯å¦å¤§äº0å³å¯ï¼Œå¦‚æœä¸å……è¶³ï¼Œåˆ™ç›´æ¥ç»“æŸï¼Œå¦‚æœå……è¶³ï¼Œç»§ç»­åœ¨redisä¸­åˆ¤æ–­ç”¨æˆ·æ˜¯å¦å¯ä»¥ä¸‹å•ï¼Œå¦‚æœseté›†åˆä¸­æ²¡æœ‰è¿™æ¡æ•°æ®ï¼Œè¯´æ˜ä»–å¯ä»¥ä¸‹å•ï¼Œå¦‚æœseté›†åˆä¸­æ²¡æœ‰è¿™æ¡è®°å½•ï¼Œåˆ™å°†userIdå’Œä¼˜æƒ å·å­˜å…¥åˆ°redisä¸­ï¼Œå¹¶ä¸”è¿”å›0ï¼Œæ•´ä¸ªè¿‡ç¨‹éœ€è¦ä¿è¯æ˜¯åŸå­æ€§çš„ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨luaæ¥æ“ä½œ</p><p>å½“ä»¥ä¸Šåˆ¤æ–­é€»è¾‘èµ°å®Œä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥åˆ¤æ–­å½“å‰redisä¸­è¿”å›çš„ç»“æœæ˜¯å¦æ˜¯0 ï¼Œå¦‚æœæ˜¯0ï¼Œåˆ™è¡¨ç¤ºå¯ä»¥ä¸‹å•ï¼Œåˆ™å°†ä¹‹å‰è¯´çš„ä¿¡æ¯å­˜å…¥åˆ°åˆ°queueä¸­å»ï¼Œç„¶åè¿”å›ï¼Œç„¶åå†æ¥ä¸ªçº¿ç¨‹å¼‚æ­¥çš„ä¸‹å•ï¼Œå‰ç«¯å¯ä»¥é€šè¿‡è¿”å›çš„è®¢å•idæ¥åˆ¤æ–­æ˜¯å¦ä¸‹å•æˆåŠŸã€‚</p><br><h4 id="ç§’æ€èµ„æ ¼åˆ¤æ–­" tabindex="-1">ç§’æ€èµ„æ ¼åˆ¤æ–­ <a class="header-anchor" href="#ç§’æ€èµ„æ ¼åˆ¤æ–­" aria-label="Permalink to &quot;ç§’æ€èµ„æ ¼åˆ¤æ–­&quot;">â€‹</a></h4><div class="tip custom-block"><p class="custom-block-title">ğŸ“Œ éœ€æ±‚ï¼šæ”¹è¿›ç§’æ€ä¸šåŠ¡ï¼Œæé«˜å¹¶å‘æ€§èƒ½</p><ul><li>æ–°å¢ç§’æ€ä¼˜æƒ åˆ¸çš„åŒæ—¶ï¼Œå°†ä¼˜æƒ åˆ¸ä¿¡æ¯ä¿å­˜åˆ°Redisä¸­</li><li>åŸºäºLuaè„šæœ¬ï¼Œåˆ¤æ–­ç§’æ€åº“å­˜ã€ä¸€äººä¸€å•ï¼Œå†³å®šç”¨æˆ·æ˜¯å¦æŠ¢è´­æˆåŠŸ</li><li>å¦‚æœæŠ¢è´­æˆåŠŸï¼Œå°†ä¼˜æƒ åˆ¸idå’Œç”¨æˆ·idå°è£…åå­˜å…¥é˜»å¡é˜Ÿåˆ—</li><li>å¼€å¯çº¿ç¨‹ä»»åŠ¡ï¼Œä¸æ–­ä»é˜»å¡é˜Ÿåˆ—ä¸­è·å–ä¿¡æ¯ï¼Œå®ç°å¼‚æ­¥ä¸‹å•åŠŸèƒ½</li></ul></div><p><img src="https://mugrain.oss-cn-hangzhou.aliyuncs.com/cswiki/image-20240314105524017.png" alt="image-20240314105524017" loading="lazy"></p><br><p><strong>VoucherServiceImpl</strong></p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Override</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Transactional</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> addSeckillVoucher</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(Voucher voucher) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // ä¿å­˜ä¼˜æƒ åˆ¸</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    save</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(voucher);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // ä¿å­˜ç§’æ€ä¿¡æ¯</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    SeckillVoucher seckillVoucher </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> SeckillVoucher</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    seckillVoucher.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setVoucherId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(voucher.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">());</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    seckillVoucher.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setStock</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(voucher.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getStock</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">());</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    seckillVoucher.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setBeginTime</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(voucher.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getBeginTime</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">());</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    seckillVoucher.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setEndTime</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(voucher.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getEndTime</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">());</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    seckillVoucherService.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">save</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(seckillVoucher);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line highlighted"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // ä¿å­˜ç§’æ€åº“å­˜åˆ°Redisä¸­</span></span>
<span class="line highlighted"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    stringRedisTemplate.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">opsForValue</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">set</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(SECKILL_STOCK_KEY </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> voucher.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(), voucher.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getStock</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">toString</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">());</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>å®Œæ•´ Lua è¡¨è¾¾å¼ï¼šseckill.lua</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- å‚æ•°åˆ—è¡¨ ä¼˜æƒ åˆ¸ID ç”¨æˆ·ID è®¢å•ID</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">local</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> voucherId </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ARGV[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">local</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> userId </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ARGV[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- æ•°æ®KEY  åº“å­˜KEYï¼Œè®¢å•KEY</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">local</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> stockKey </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;seckill:stock:&#39; </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">..</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> voucherId</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">local</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> orderKey </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;seckill:order:&#39; </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">..</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> voucherId</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- åˆ¤æ–­åº“å­˜æ˜¯å¦å……è¶³ï¼Œåº“å­˜ä¸è¶³è¿”å›1</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">tonumber</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(redis.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">call</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;get&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,stockKey)) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">then</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- åˆ¤æ–­ç”¨æˆ·æ˜¯å¦ä¸‹å•ï¼Œç”¨æˆ·å­˜åœ¨è¿”å›2</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (redis.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">call</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;sismember&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, orderKey, userId) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">then</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- æ‰£åº“å­˜</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">redis.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">call</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;incrby&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,stockKey,</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- ä¸‹å•</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">redis.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">call</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;sadd&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,orderKey,userId)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span></span></code></pre></div><p>å½“ä»¥ä¸Š Lua è¡¨è¾¾å¼æ‰§è¡Œå®Œæ¯•åï¼Œå‰©ä¸‹çš„å°±æ˜¯æ ¹æ®æ­¥éª¤3,4æ¥æ‰§è¡Œæˆ‘ä»¬æ¥ä¸‹æ¥çš„ä»»åŠ¡äº†</p><br><p><strong>VoucherOrderServiceImpl</strong></p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Override</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Result </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">seckillVoucher</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(Long voucherId) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    //è·å–ç”¨æˆ·</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    Long userId </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> UserHolder.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getUser</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    long</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> orderId </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> redisIdWorker.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">nextId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;order&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 1.æ‰§è¡Œluaè„šæœ¬</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    Long result </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> stringRedisTemplate.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">execute</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            SECKILL_SCRIPT,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            Collections.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">emptyList</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            voucherId.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">toString</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(), userId.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">toString</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    );</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> r </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> result.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">intValue</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 2.åˆ¤æ–­ç»“æœæ˜¯å¦ä¸º0</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (r </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 2.1.ä¸ä¸º0 ï¼Œä»£è¡¨æ²¡æœ‰è´­ä¹°èµ„æ ¼</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Result.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">fail</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(r </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ?</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;åº“å­˜ä¸è¶³&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> :</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;ä¸èƒ½é‡å¤ä¸‹å•&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    //TODO ä¿å­˜é˜»å¡é˜Ÿåˆ—</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 3.è¿”å›è®¢å•id</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Result.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ok</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(orderId);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><br><h4 id="é˜»å¡é˜Ÿåˆ—å®ç°" tabindex="-1">é˜»å¡é˜Ÿåˆ—å®ç° <a class="header-anchor" href="#é˜»å¡é˜Ÿåˆ—å®ç°" aria-label="Permalink to &quot;é˜»å¡é˜Ÿåˆ—å®ç°&quot;">â€‹</a></h4><p>VoucherOrderServiceImpl</p><p>ä¿®æ”¹ä¸‹å•åŠ¨ä½œï¼Œç°åœ¨æˆ‘ä»¬å»ä¸‹å•æ—¶ï¼Œæ˜¯é€šè¿‡luaè¡¨è¾¾å¼å»åŸå­æ‰§è¡Œåˆ¤æ–­é€»è¾‘ï¼Œå¦‚æœåˆ¤æ–­æˆ‘å‡ºæ¥ä¸ä¸º0 ï¼Œåˆ™è¦ä¹ˆæ˜¯åº“å­˜ä¸è¶³ï¼Œè¦ä¹ˆæ˜¯é‡å¤ä¸‹å•ï¼Œè¿”å›é”™è¯¯ä¿¡æ¯ï¼Œå¦‚æœæ˜¯0ï¼Œåˆ™æŠŠä¸‹å•çš„é€»è¾‘ä¿å­˜åˆ°é˜Ÿåˆ—ä¸­å»ï¼Œç„¶åå¼‚æ­¥æ‰§è¡Œ</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">package</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.hmdp.service.impl;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.hmdp.dto.Result;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.hmdp.entity.SeckillVoucher;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.hmdp.entity.VoucherOrder;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.hmdp.mapper.VoucherOrderMapper;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.hmdp.service.ISeckillVoucherService;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.hmdp.service.IVoucherOrderService;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.hmdp.utils.RedisIdWorker;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.hmdp.utils.UserHolder;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> org.redisson.api.RLock;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> org.redisson.api.RedissonClient;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> org.springframework.aop.framework.AopContext;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> org.springframework.beans.factory.annotation.Autowired;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> org.springframework.core.io.ClassPathResource;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> org.springframework.data.redis.core.StringRedisTemplate;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> org.springframework.data.redis.core.script.DefaultRedisScript;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> org.springframework.stereotype.Service;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> org.springframework.transaction.annotation.Transactional;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> javax.annotation.PostConstruct;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> java.time.LocalDateTime;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> java.util.Collections;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> java.util.concurrent.ArrayBlockingQueue;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> java.util.concurrent.BlockingQueue;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> java.util.concurrent.ExecutorService;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> java.util.concurrent.Executors;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">/**</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> * &lt;p&gt;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> * æœåŠ¡å®ç°ç±»</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> * &lt;/p&gt;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> *</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> * </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">@author</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> è™å“¥</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> * </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">@since</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> 2021-12-22</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> */</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Service</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> VoucherOrderServiceImpl</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> extends</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ServiceImpl</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">VoucherOrderMapper</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">VoucherOrder</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">implements</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> IVoucherOrderService</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    private</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> final</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> DefaultRedisScript&lt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Long</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; SECKILL_SCRIPT;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Autowired</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    private</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> RedisIdWorker redisIdWorker;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Autowired</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    private</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> StringRedisTemplate stringRedisTemplate;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Autowired</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    private</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> RedissonClient redissonClient;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    static</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        SECKILL_SCRIPT </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> DefaultRedisScript&lt;&gt;();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        SECKILL_SCRIPT.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setLocation</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ClassPathResource</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;seckill.lua&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">));</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        SECKILL_SCRIPT.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setResultType</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(Long.class);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    private</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> IVoucherOrderService proxy;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Override</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Result </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">seckillVoucher</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(Long </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">voucherId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        //è·å–ç”¨æˆ·</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        Long userId </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> UserHolder.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getUser</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 1.æ‰§è¡Œluaè„šæœ¬</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        Long result </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> stringRedisTemplate.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">execute</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                SECKILL_SCRIPT,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                Collections.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">emptyList</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                voucherId.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">toString</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(), userId.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">toString</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        );</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> r </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> result.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">intValue</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 2.åˆ¤æ–­ç»“æœæ˜¯å¦ä¸º0</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (r </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">            // 2.1.ä¸ä¸º0 ï¼Œä»£è¡¨æ²¡æœ‰è´­ä¹°èµ„æ ¼</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Result.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">fail</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(r </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ?</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;åº“å­˜ä¸è¶³&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> :</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;ä¸èƒ½é‡å¤ä¸‹å•&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        //åˆ¤æ–­é€šè¿‡åˆ™åŠ å…¥é˜»å¡é˜Ÿåˆ—</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        VoucherOrder voucherOrder </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> VoucherOrder</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        long</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> orderId </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> redisIdWorker.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">nextId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;order&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        voucherOrder.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(orderId);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        voucherOrder.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setUserId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(userId);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        voucherOrder.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setVoucherId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(voucherId);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        orderTasks.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">add</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(voucherOrder);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        //è·å–ä»£ç†å¯¹è±¡</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        proxy </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (IVoucherOrderService) AopContext.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">currentProxy</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        //è¿”å›è®¢å•ID</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Result.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ok</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(orderId);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    //åˆ›å»ºé˜»å¡é˜Ÿåˆ—</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    private</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> BlockingQueue&lt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">VoucherOrder</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; orderTasks </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ArrayBlockingQueue&lt;&gt;(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1024</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1024</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    //å¼‚æ­¥å¤„ç†çº¿ç¨‹æ± </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    private</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> final</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ExecutorService SECKILL_ORDER_EXECUTOR </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Executors.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">newSingleThreadExecutor</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    //åœ¨ç±»åˆå§‹åŒ–ä¹‹åæ‰§è¡Œï¼Œå› ä¸ºå½“è¿™ä¸ªç±»åˆå§‹åŒ–å¥½äº†ä»¥åï¼Œéšæ—¶éƒ½æœ‰å¯èƒ½è¦æ‰§è¡Œ</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">PostConstruct</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    private</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> init</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        SECKILL_ORDER_EXECUTOR.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">submit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> VoucherOrderHandler</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">());</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    private</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> VoucherOrderHandler</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> implements</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Runnable</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Override</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> run</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            while</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">                try</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                    VoucherOrder voucherOrder </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> orderTasks.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">take</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">                    handleVoucherOrder</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(voucherOrder);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">catch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (InterruptedException </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">e</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                    log.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;å¤„ç†è®¢å•å¼‚å¸¸&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, e);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        private</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> handleVoucherOrder</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(VoucherOrder </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">voucherOrder</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            Long userId </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> voucherOrder.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getUserId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">            // åˆ›å»ºé”å¯¹è±¡</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            RLock redisLock </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> redissonClient.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getLock</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;lock:order:&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> +</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> userId);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">            // å°è¯•è·å–é”</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            boolean</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> isLock </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> redisLock.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">tryLock</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">            // åˆ¤æ–­</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">isLock) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                // è·å–é”å¤±è´¥ï¼Œç›´æ¥è¿”å›å¤±è´¥æˆ–è€…é‡è¯•</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                log.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;ä¸å…è®¸é‡å¤ä¸‹å•ï¼&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">                return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            try</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                // ç”±äºæ˜¯springçš„äº‹åŠ¡æ˜¯æ”¾åœ¨threadLocalä¸­ï¼Œæ­¤æ—¶çš„æ˜¯å¤šçº¿ç¨‹ï¼Œäº‹åŠ¡ä¼šå¤±æ•ˆï¼Œæ‰€ä»¥éœ€è¦ä»£ç†å¯¹è±¡</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                // ä½†æ˜¯ä»£ç†å¯¹è±¡åœ¨å­çº¿ç¨‹ä¸­æ˜¯æ— æ³•ç”Ÿæ•ˆçš„ï¼Œæ‰€ä»¥éœ€è¦é€šè¿‡å£°æ˜ç±»æˆå‘˜å˜é‡æˆ–ä¼ å…¥å‚æ•°</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                proxy.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">createVoucherOrder</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(voucherOrder);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">finally</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                // é‡Šæ”¾é”</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                redisLock.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">unlock</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Autowired</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    private</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ISeckillVoucherService seckillVoucherService;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Transactional</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> createVoucherOrder</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(VoucherOrder </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">voucherOrder</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        Long userId </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> voucherOrder.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getUserId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        Long voucherId </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> voucherOrder.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getVoucherId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // åˆ›å»ºé”å¯¹è±¡</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        RLock redisLock </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> redissonClient.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getLock</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;lock:order:&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> +</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> userId);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // å°è¯•è·å–é”</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        boolean</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> isLock </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> redisLock.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">tryLock</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // åˆ¤æ–­</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">isLock) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">            // è·å–é”å¤±è´¥ï¼Œç›´æ¥è¿”å›å¤±è´¥æˆ–è€…é‡è¯•</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            log.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;ä¸å…è®¸é‡å¤ä¸‹å•ï¼&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        try</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">            // 5.1.æŸ¥è¯¢è®¢å•</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> count </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> query</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">eq</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;user_id&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, userId).</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">eq</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;voucher_id&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, voucherId).</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">count</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">            // 5.2.åˆ¤æ–­æ˜¯å¦å­˜åœ¨</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (count </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                // ç”¨æˆ·å·²ç»è´­ä¹°è¿‡äº†</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                log.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;ä¸å…è®¸é‡å¤ä¸‹å•ï¼&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">                return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">            // 6.æ‰£å‡åº“å­˜</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            boolean</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> success </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> seckillVoucherService.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">update</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                    .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setSql</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;stock = stock - 1&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// set stock = stock - 1</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                    .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">eq</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;voucher_id&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, voucherId)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                    .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">gt</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;stock&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// where id = ? and stock &gt; 0</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                    .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">update</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">success) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                // æ‰£å‡å¤±è´¥</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                log.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;åº“å­˜ä¸è¶³ï¼&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">                return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">            // 7.åˆ›å»ºè®¢å•</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">            save</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(voucherOrder);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">finally</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">            // é‡Šæ”¾é”</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            redisLock.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">unlock</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><div class="warning custom-block"><p class="custom-block-title">æ€»ç»“</p><p>ç§’æ€ä¸šåŠ¡çš„ä¼˜åŒ–æ€è·¯æ˜¯ä»€ä¹ˆï¼Ÿ</p><ul><li>å…ˆåˆ©ç”¨Rediså®Œæˆåº“å­˜ä½™é‡ã€ä¸€äººä¸€å•åˆ¤æ–­ï¼Œå®ŒæˆæŠ¢å•ä¸šåŠ¡</li><li>å†å°†ä¸‹å•ä¸šåŠ¡æ”¾å…¥é˜»å¡é˜Ÿåˆ—ï¼Œåˆ©ç”¨ç‹¬ç«‹çº¿ç¨‹å¼‚æ­¥ä¸‹å•</li></ul><p>åŸºäºé˜»å¡é˜Ÿåˆ—çš„å¼‚æ­¥ç§’æ€å­˜åœ¨å“ªäº›é—®é¢˜ï¼Ÿ</p><ul><li>å†…å­˜é™åˆ¶é—®é¢˜</li><li>æ•°æ®å®‰å…¨é—®é¢˜</li></ul></div><br><h3 id="æ¶ˆæ¯é˜Ÿåˆ—" tabindex="-1">æ¶ˆæ¯é˜Ÿåˆ— <a class="header-anchor" href="#æ¶ˆæ¯é˜Ÿåˆ—" aria-label="Permalink to &quot;æ¶ˆæ¯é˜Ÿåˆ—&quot;">â€‹</a></h3><h4 id="è®¤è¯†æ¶ˆæ¯é˜Ÿåˆ—" tabindex="-1">è®¤è¯†æ¶ˆæ¯é˜Ÿåˆ— <a class="header-anchor" href="#è®¤è¯†æ¶ˆæ¯é˜Ÿåˆ—" aria-label="Permalink to &quot;è®¤è¯†æ¶ˆæ¯é˜Ÿåˆ—&quot;">â€‹</a></h4><p>ä»€ä¹ˆæ˜¯æ¶ˆæ¯é˜Ÿåˆ—ï¼šå­—é¢æ„æ€å°±æ˜¯å­˜æ”¾æ¶ˆæ¯çš„é˜Ÿåˆ—ã€‚æœ€ç®€å•çš„æ¶ˆæ¯é˜Ÿåˆ—æ¨¡å‹åŒ…æ‹¬3ä¸ªè§’è‰²ï¼š</p><ul><li>æ¶ˆæ¯é˜Ÿåˆ—ï¼šå­˜å‚¨å’Œç®¡ç†æ¶ˆæ¯ï¼Œä¹Ÿè¢«ç§°ä¸ºæ¶ˆæ¯ä»£ç†ï¼ˆMessage Brokerï¼‰</li><li>ç”Ÿäº§è€…ï¼šå‘é€æ¶ˆæ¯åˆ°æ¶ˆæ¯é˜Ÿåˆ—</li><li>æ¶ˆè´¹è€…ï¼šä»æ¶ˆæ¯é˜Ÿåˆ—è·å–æ¶ˆæ¯å¹¶å¤„ç†æ¶ˆæ¯</li></ul><p>Redisæä¾›äº†ä¸‰ç§ä¸åŒçš„æ–¹å¼æ¥å®ç°æ¶ˆæ¯é˜Ÿåˆ—ï¼š</p><ul><li>Listç»“æ„ï¼šåŸºäºListç»“æ„æ¨¡æ‹Ÿæ¶ˆæ¯é˜Ÿåˆ—</li><li>PubSubï¼šåŸºæœ¬çš„ç‚¹å¯¹ç‚¹æ¶ˆæ¯æ¨¡å‹</li><li>Streamï¼šæ¯”è¾ƒå®Œå–„çš„æ¶ˆæ¯é˜Ÿåˆ—æ¨¡å‹</li></ul><p><img src="https://mugrain.oss-cn-hangzhou.aliyuncs.com/cswiki/image-20240314105659200.png" alt="image-20240314105659200" loading="lazy"></p><br><p>ä½¿ç”¨é˜Ÿåˆ—çš„å¥½å¤„åœ¨äº <strong>è§£è€¦ï¼š</strong></p><p>æ‰€è°“è§£è€¦ï¼Œä¸¾ä¸€ä¸ªç”Ÿæ´»ä¸­çš„ä¾‹å­å°±æ˜¯ï¼šå¿«é€’å‘˜(ç”Ÿäº§è€…)æŠŠå¿«é€’æ”¾åˆ°å¿«é€’æŸœé‡Œè¾¹(Message Queue)å»ï¼Œæˆ‘ä»¬(æ¶ˆè´¹è€…)ä»å¿«é€’æŸœé‡Œè¾¹å»æ‹¿ä¸œè¥¿ï¼Œè¿™å°±æ˜¯ä¸€ä¸ªå¼‚æ­¥ï¼Œå¦‚æœè€¦åˆï¼Œé‚£ä¹ˆè¿™ä¸ªå¿«é€’å‘˜ç›¸å½“äºç›´æ¥æŠŠå¿«é€’äº¤ç»™ä½ ï¼Œè¿™äº‹å›ºç„¶å¥½ï¼Œä½†æ˜¯ä¸‡ä¸€ä½ ä¸åœ¨å®¶ï¼Œé‚£ä¹ˆå¿«é€’å‘˜å°±ä¼šä¸€ç›´ç­‰ä½ ï¼Œè¿™å°±æµªè´¹äº†å¿«é€’å‘˜çš„æ—¶é—´ï¼Œæ‰€ä»¥è¿™ç§æ€æƒ³åœ¨æˆ‘ä»¬æ—¥å¸¸å¼€å‘ä¸­ï¼Œæ˜¯éå¸¸æœ‰å¿…è¦çš„ã€‚</p><p>è¿™ç§åœºæ™¯åœ¨æˆ‘ä»¬ç§’æ€ä¸­å°±å˜æˆäº†ï¼šæˆ‘ä»¬ä¸‹å•ä¹‹åï¼Œåˆ©ç”¨rediså»è¿›è¡Œæ ¡éªŒä¸‹å•æ¡ä»¶ï¼Œå†é€šè¿‡é˜Ÿåˆ—æŠŠæ¶ˆæ¯å‘é€å‡ºå»ï¼Œç„¶åå†å¯åŠ¨ä¸€ä¸ªçº¿ç¨‹å»æ¶ˆè´¹è¿™ä¸ªæ¶ˆæ¯ï¼Œå®Œæˆè§£è€¦ï¼ŒåŒæ—¶ä¹ŸåŠ å¿«æˆ‘ä»¬çš„å“åº”é€Ÿåº¦ã€‚</p><p>è¿™é‡Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸€äº›ç°æˆçš„mqï¼Œæ¯”å¦‚kafkaï¼Œrabbitmqç­‰ç­‰ï¼Œä½†æ˜¯å‘¢ï¼Œå¦‚æœæ²¡æœ‰å®‰è£…mqï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨redisæä¾›çš„mqæ–¹æ¡ˆï¼Œé™ä½æˆ‘ä»¬çš„éƒ¨ç½²å’Œå­¦ä¹ æˆæœ¬ã€‚</p><br><h4 id="åŸºäºlistå®ç°æ¶ˆæ¯é˜Ÿåˆ—" tabindex="-1">åŸºäºListå®ç°æ¶ˆæ¯é˜Ÿåˆ— <a class="header-anchor" href="#åŸºäºlistå®ç°æ¶ˆæ¯é˜Ÿåˆ—" aria-label="Permalink to &quot;åŸºäºListå®ç°æ¶ˆæ¯é˜Ÿåˆ—&quot;">â€‹</a></h4><p>æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆMessage Queueï¼‰ï¼Œå­—é¢æ„æ€å°±æ˜¯å­˜æ”¾æ¶ˆæ¯çš„é˜Ÿåˆ—ã€‚è€ŒRedisçš„listæ•°æ®ç»“æ„æ˜¯ä¸€ä¸ªåŒå‘é“¾è¡¨ï¼Œå¾ˆå®¹æ˜“æ¨¡æ‹Ÿå‡ºé˜Ÿåˆ—æ•ˆæœã€‚</p><p>é˜Ÿåˆ—æ˜¯å…¥å£å’Œå‡ºå£ä¸åœ¨ä¸€è¾¹ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥åˆ©ç”¨ï¼šLPUSH ç»“åˆ RPOPã€æˆ–è€… RPUSH ç»“åˆ LPOPæ¥å®ç°ã€‚ä¸è¿‡è¦æ³¨æ„çš„æ˜¯ï¼Œå½“é˜Ÿåˆ—ä¸­æ²¡æœ‰æ¶ˆæ¯æ—¶RPOPæˆ–LPOPæ“ä½œä¼šè¿”å›nullï¼Œå¹¶ä¸åƒJVMçš„é˜»å¡é˜Ÿåˆ—é‚£æ ·ä¼šé˜»å¡å¹¶ç­‰å¾…æ¶ˆæ¯ã€‚å› æ­¤è¿™é‡Œåº”è¯¥ä½¿ç”¨BRPOPæˆ–è€…BLPOPæ¥å®ç°é˜»å¡æ•ˆæœã€‚</p><p><img src="https://mugrain.oss-cn-hangzhou.aliyuncs.com/cswiki/image-20240314105913851.png" alt="image-20240314105913851" loading="lazy"></p><p>åŸºäºListçš„æ¶ˆæ¯é˜Ÿåˆ—æœ‰å“ªäº›ä¼˜ç¼ºç‚¹ï¼Ÿ</p><p>ä¼˜ç‚¹ï¼š</p><ul><li>åˆ©ç”¨Rediså­˜å‚¨ï¼Œä¸å—é™äºJVMå†…å­˜ä¸Šé™</li><li>åŸºäºRedisçš„æŒä¹…åŒ–æœºåˆ¶ï¼Œæ•°æ®å®‰å…¨æ€§æœ‰ä¿è¯</li><li>å¯ä»¥æ»¡è¶³æ¶ˆæ¯æœ‰åºæ€§</li></ul><p>ç¼ºç‚¹ï¼š</p><ul><li>æ— æ³•é¿å…æ¶ˆæ¯ä¸¢å¤±</li><li>åªæ”¯æŒå•æ¶ˆè´¹è€…</li></ul><br><h4 id="åŸºäºpubsubçš„æ¶ˆæ¯é˜Ÿåˆ—" tabindex="-1">åŸºäºPubSubçš„æ¶ˆæ¯é˜Ÿåˆ— <a class="header-anchor" href="#åŸºäºpubsubçš„æ¶ˆæ¯é˜Ÿåˆ—" aria-label="Permalink to &quot;åŸºäºPubSubçš„æ¶ˆæ¯é˜Ÿåˆ—&quot;">â€‹</a></h4><p>PubSubï¼ˆå‘å¸ƒè®¢é˜…ï¼‰æ˜¯Redis2.0ç‰ˆæœ¬å¼•å…¥çš„æ¶ˆæ¯ä¼ é€’æ¨¡å‹ã€‚é¡¾åæ€ä¹‰ï¼Œæ¶ˆè´¹è€…å¯ä»¥è®¢é˜…ä¸€ä¸ªæˆ–å¤šä¸ªchannelï¼Œç”Ÿäº§è€…å‘å¯¹åº”channelå‘é€æ¶ˆæ¯åï¼Œæ‰€æœ‰è®¢é˜…è€…éƒ½èƒ½æ”¶åˆ°ç›¸å…³æ¶ˆæ¯ã€‚</p><ul><li>SUBSCRIBE channel [channel] ï¼šè®¢é˜…ä¸€ä¸ªæˆ–å¤šä¸ªé¢‘é“</li><li>PUBLISH channel msg ï¼šå‘ä¸€ä¸ªé¢‘é“å‘é€æ¶ˆæ¯</li><li>PSUBSCRIBE pattern[pattern] ï¼šè®¢é˜…ä¸patternæ ¼å¼åŒ¹é…çš„æ‰€æœ‰é¢‘é“</li></ul><p><img src="https://mugrain.oss-cn-hangzhou.aliyuncs.com/cswiki/image-20240314105815670.png" alt="image-20240314105815670" loading="lazy"></p><br><p>åŸºäºPubSubçš„æ¶ˆæ¯é˜Ÿåˆ—æœ‰å“ªäº›ä¼˜ç¼ºç‚¹ï¼Ÿ</p><p>ä¼˜ç‚¹ï¼š</p><ul><li>é‡‡ç”¨å‘å¸ƒè®¢é˜…æ¨¡å‹ï¼Œæ”¯æŒå¤šç”Ÿäº§ã€å¤šæ¶ˆè´¹</li></ul><p>ç¼ºç‚¹ï¼š</p><ul><li>ä¸æ”¯æŒæ•°æ®æŒä¹…åŒ–</li><li>æ— æ³•é¿å…æ¶ˆæ¯ä¸¢å¤±</li><li>æ¶ˆæ¯å †ç§¯æœ‰ä¸Šé™ï¼Œè¶…å‡ºæ—¶æ•°æ®ä¸¢å¤±</li></ul><br><h4 id="åŸºäºstreamçš„æ¶ˆæ¯é˜Ÿåˆ—" tabindex="-1">åŸºäºStreamçš„æ¶ˆæ¯é˜Ÿåˆ— <a class="header-anchor" href="#åŸºäºstreamçš„æ¶ˆæ¯é˜Ÿåˆ—" aria-label="Permalink to &quot;åŸºäºStreamçš„æ¶ˆæ¯é˜Ÿåˆ—&quot;">â€‹</a></h4><p>Stream æ˜¯ Redis 5.0 å¼•å…¥çš„ä¸€ç§æ–°æ•°æ®ç±»å‹ï¼Œå¯ä»¥å®ç°ä¸€ä¸ªåŠŸèƒ½éå¸¸å®Œå–„çš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚</p><p>å‘é€æ¶ˆæ¯çš„å‘½ä»¤ï¼š</p><p><img src="https://mugrain.oss-cn-hangzhou.aliyuncs.com/cswiki/image-169355136195417.png" alt="image-169355136195417" loading="lazy"></p><p>ä¾‹å¦‚ï¼š</p><p><img src="https://mugrain.oss-cn-hangzhou.aliyuncs.com/cswiki/image-169355136195418.png" alt="image-169355136195418" loading="lazy"></p><p>è¯»å–æ¶ˆæ¯çš„æ–¹å¼ä¹‹ä¸€ï¼šXREAD</p><p><img src="https://mugrain.oss-cn-hangzhou.aliyuncs.com/cswiki/image-169355136195419.png" alt="image-169355136195419" loading="lazy"></p><p>ä¾‹å¦‚ï¼Œä½¿ç”¨XREADè¯»å–ç¬¬ä¸€ä¸ªæ¶ˆæ¯ï¼š</p><p><img src="https://mugrain.oss-cn-hangzhou.aliyuncs.com/cswiki/image-169355136195420.png" alt="image-169355136195420" loading="lazy"></p><p>XREADé˜»å¡æ–¹å¼ï¼Œè¯»å–æœ€æ–°çš„æ¶ˆæ¯ï¼š</p><p><img src="https://mugrain.oss-cn-hangzhou.aliyuncs.com/cswiki/image-169355136195421.png" alt="image-169355136195421" loading="lazy"></p><p>åœ¨ä¸šåŠ¡å¼€å‘ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å¾ªç¯çš„è°ƒç”¨XREADé˜»å¡æ–¹å¼æ¥æŸ¥è¯¢æœ€æ–°æ¶ˆæ¯ï¼Œä»è€Œå®ç°æŒç»­ç›‘å¬é˜Ÿåˆ—çš„æ•ˆæœï¼Œä¼ªä»£ç å¦‚ä¸‹</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">while</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // å°è¯•è¯»å–é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯ï¼Œæœ€å¤šé˜»å¡ä¸¤ç§’</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    Object msg </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> redis.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">execute</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;XREAD COUNT 1 BLOCK 2000 STREAMS users $&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (msg </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        continue</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // å¤„ç†æ¶ˆæ¯</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    handleMessage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(msg);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>æ³¨æ„ï¼šå½“æˆ‘ä»¬æŒ‡å®šèµ·å§‹IDä¸º$æ—¶ï¼Œä»£è¡¨è¯»å–æœ€æ–°çš„æ¶ˆæ¯ï¼Œå¦‚æœæˆ‘ä»¬å¤„ç†ä¸€æ¡æ¶ˆæ¯çš„è¿‡ç¨‹ä¸­ï¼Œåˆæœ‰è¶…è¿‡1æ¡ä»¥ä¸Šçš„æ¶ˆæ¯åˆ°è¾¾é˜Ÿåˆ—ï¼Œåˆ™ä¸‹æ¬¡è·å–æ—¶ä¹Ÿåªèƒ½è·å–åˆ°æœ€æ–°çš„ä¸€æ¡ï¼Œä¼šå‡ºç°<strong>æ¼è¯»æ¶ˆæ¯</strong>çš„é—®é¢˜</p><br><div class="warning custom-block"><p class="custom-block-title">æ€»ç»“ï¼šSTREAM ç±»å‹æ¶ˆæ¯é˜Ÿåˆ—çš„ XREAD å‘½ä»¤ç‰¹ç‚¹</p><ul><li>æ¶ˆæ¯å¯å›æº¯</li><li>ä¸€ä¸ªæ¶ˆæ¯å¯ä»¥è¢«å¤šä¸ªæ¶ˆè´¹è€…è¯»å–</li><li>å¯ä»¥é˜»å¡è¯»å–</li><li>æœ‰æ¶ˆæ¯æ¼è¯»çš„é£é™©</li></ul></div><br><h4 id="åŸºäºstreamçš„æ¶ˆæ¯é˜Ÿåˆ—-æ¶ˆè´¹è€…ç»„" tabindex="-1">åŸºäºStreamçš„æ¶ˆæ¯é˜Ÿåˆ—-æ¶ˆè´¹è€…ç»„ <a class="header-anchor" href="#åŸºäºstreamçš„æ¶ˆæ¯é˜Ÿåˆ—-æ¶ˆè´¹è€…ç»„" aria-label="Permalink to &quot;åŸºäºStreamçš„æ¶ˆæ¯é˜Ÿåˆ—-æ¶ˆè´¹è€…ç»„&quot;">â€‹</a></h4><p>æ¶ˆè´¹è€…ç»„ï¼ˆConsumer Groupï¼‰ï¼šå°†å¤šä¸ªæ¶ˆè´¹è€…åˆ’åˆ†åˆ°ä¸€ä¸ªç»„ä¸­ï¼Œç›‘å¬åŒä¸€ä¸ªé˜Ÿåˆ—ã€‚å…·å¤‡ä¸‹åˆ—ç‰¹ç‚¹ï¼š</p><p><img src="https://mugrain.oss-cn-hangzhou.aliyuncs.com/cswiki/1653577801668.png" alt="1653577801668" loading="lazy"></p><p>åˆ›å»ºæ¶ˆè´¹è€…ç»„ï¼š</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">XGROUP</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> CREATE key groupName ID [MKSTREAM]</span></span></code></pre></div><ul><li>keyï¼šé˜Ÿåˆ—åç§°</li><li>groupNameï¼šæ¶ˆè´¹è€…ç»„åç§°</li><li>IDï¼šèµ·å§‹IDæ ‡ç¤ºï¼Œ$ä»£è¡¨é˜Ÿåˆ—ä¸­æœ€åä¸€ä¸ªæ¶ˆæ¯ï¼Œ0åˆ™ä»£è¡¨é˜Ÿåˆ—ä¸­ç¬¬ä¸€ä¸ªæ¶ˆæ¯</li><li>MKSTREAMï¼šé˜Ÿåˆ—ä¸å­˜åœ¨æ—¶è‡ªåŠ¨åˆ›å»ºé˜Ÿåˆ—</li></ul><br><p>å…¶å®ƒå¸¸è§å‘½ä»¤ï¼š</p><p><strong>åˆ é™¤æŒ‡å®šçš„æ¶ˆè´¹è€…ç»„</strong></p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">XGROUP</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> DESTORY key groupName</span></span></code></pre></div><p><strong>ç»™æŒ‡å®šçš„æ¶ˆè´¹è€…ç»„æ·»åŠ æ¶ˆè´¹è€…</strong></p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">XGROUP</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> CREATECONSUMER key groupname consumername</span></span></code></pre></div><p><strong>åˆ é™¤æ¶ˆè´¹è€…ç»„ä¸­çš„æŒ‡å®šæ¶ˆè´¹è€…</strong></p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">XGROUP</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> DELCONSUMER key groupname consumername</span></span></code></pre></div><br><p>ä»æ¶ˆè´¹è€…ç»„è¯»å–æ¶ˆæ¯ï¼š</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">XREADGROUP</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> GROUP group consumer [COUNT count] [BLOCK milliseconds] [NOACK] STREAMS key [key ...] ID [ID ...]</span></span></code></pre></div><ul><li>groupï¼šæ¶ˆè´¹ç»„åç§°</li><li>consumerï¼šæ¶ˆè´¹è€…åç§°ï¼Œå¦‚æœæ¶ˆè´¹è€…ä¸å­˜åœ¨ï¼Œä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªæ¶ˆè´¹è€…</li><li>countï¼šæœ¬æ¬¡æŸ¥è¯¢çš„æœ€å¤§æ•°é‡</li><li>BLOCK millisecondsï¼šå½“æ²¡æœ‰æ¶ˆæ¯æ—¶æœ€é•¿ç­‰å¾…æ—¶é—´</li><li>NOACKï¼šæ— éœ€æ‰‹åŠ¨ACKï¼Œè·å–åˆ°æ¶ˆæ¯åè‡ªåŠ¨ç¡®è®¤</li><li>STREAMS keyï¼šæŒ‡å®šé˜Ÿåˆ—åç§°</li><li>IDï¼šè·å–æ¶ˆæ¯çš„èµ·å§‹IDï¼š <ul><li>&quot;&gt;&quot;ï¼šä»ä¸‹ä¸€ä¸ªæœªæ¶ˆè´¹çš„æ¶ˆæ¯å¼€å§‹</li><li>å…¶å®ƒï¼šæ ¹æ®æŒ‡å®šidä»pending-listä¸­è·å–å·²æ¶ˆè´¹ä½†æœªç¡®è®¤çš„æ¶ˆæ¯ï¼Œä¾‹å¦‚0ï¼Œæ˜¯ä»pending-listä¸­çš„ç¬¬ä¸€ä¸ªæ¶ˆæ¯å¼€å§‹</li></ul></li></ul><br><p>æ¶ˆè´¹è€…ç›‘å¬æ¶ˆæ¯çš„åŸºæœ¬æ€è·¯ï¼š</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">while</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // å°è¯•ç›‘å¬é˜Ÿåˆ—ï¼Œä½¿ç”¨é˜»å¡æ¨¡å¼ï¼Œæœ€é•¿ç­‰å¾… 2000 æ¯«ç§’</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    Object msg </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> redis.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">call</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;XREADGROUP GROUP g1 c1 COUNT 1 BLOCK 2000 STREAMS s1 &gt;&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // æ²¡æœ‰æ¶ˆæ¯åˆ™ç»§ç»­ä¸‹ä¸€æ¬¡</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (msg </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        continue</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    try</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // å¤„ç†å®Œæ¶ˆæ¯ä¸€å®šè¦ACK</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        handleMessage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(msg);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">catch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (Exception </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">e</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        while</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            Object msg </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> redis.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">call</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;XREADGROUP GROUP g1 c1 COUNT 1 BLOCK 2000 STREAMS s1 0&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">           </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">            // æ²¡æœ‰å¼‚å¸¸æ¶ˆæ¯ï¼Œæ‰€ä»¥æ¶ˆæ¯éƒ½å·²ç»ç¡®è®¤ï¼Œç»“æŸå¾ªç¯</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (msg </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">                break</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            try</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                // æœ‰å¼‚å¸¸æ¶ˆæ¯ï¼Œå†æ¬¡å¤„ç†</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">                handleMessage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(msg);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">catch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (Exception </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">ex</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                // å†æ¬¡å‡ºç°å¼‚å¸¸ï¼Œè®°å½•æ—¥å¿—ï¼Œç»§ç»­å¾ªç¯</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">                continue</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><div class="warning custom-block"><p class="custom-block-title">æ€»ç»“ï¼šSTREAM ç±»å‹æ¶ˆæ¯é˜Ÿåˆ—çš„ XREADGROUP å‘½ä»¤ç‰¹ç‚¹</p><ul><li>æ¶ˆæ¯å¯å›æº¯</li><li>å¯ä»¥å¤šæ¶ˆè´¹è€…äº‰æŠ¢æ¶ˆæ¯ï¼ŒåŠ å¿«æ¶ˆè´¹é€Ÿåº¦</li><li>å¯ä»¥é˜»å¡è¯»å–</li><li>æ²¡æœ‰æ¶ˆæ¯æ¼è¯»çš„é£é™©</li><li>æœ‰æ¶ˆæ¯ç¡®è®¤æœºåˆ¶ï¼Œä¿è¯æ¶ˆæ¯è‡³å°‘è¢«æ¶ˆè´¹ä¸€æ¬¡</li></ul></div><br><p>æœ€åæˆ‘ä»¬æ¥ä¸ªå°å¯¹æ¯”</p><p><img src="https://mugrain.oss-cn-hangzhou.aliyuncs.com/cswiki/image-169355136195423.png" alt="image-169355136195423" loading="lazy"></p><br><h4 id="å®ç°å¼‚æ­¥ç§’æ€ä¸‹å•" tabindex="-1">å®ç°å¼‚æ­¥ç§’æ€ä¸‹å• <a class="header-anchor" href="#å®ç°å¼‚æ­¥ç§’æ€ä¸‹å•" aria-label="Permalink to &quot;å®ç°å¼‚æ­¥ç§’æ€ä¸‹å•&quot;">â€‹</a></h4><div class="tip custom-block"><p class="custom-block-title">åŸºäºRedisçš„Streamç»“æ„ä½œä¸ºæ¶ˆæ¯é˜Ÿåˆ—ï¼Œå®ç°å¼‚æ­¥ç§’æ€ä¸‹å•</p><ul><li>åˆ›å»ºä¸€ä¸ªStreamç±»å‹çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œåä¸ºstream.orders</li><li>ä¿®æ”¹ä¹‹å‰çš„ç§’æ€ä¸‹å•Luaè„šæœ¬ï¼Œåœ¨è®¤å®šæœ‰æŠ¢è´­èµ„æ ¼åï¼Œç›´æ¥å‘stream.ordersä¸­æ·»åŠ æ¶ˆæ¯ï¼Œå†…å®¹åŒ…å«voucherIdã€userIdã€orderId</li><li>é¡¹ç›®å¯åŠ¨æ—¶ï¼Œå¼€å¯ä¸€ä¸ªçº¿ç¨‹ä»»åŠ¡ï¼Œå°è¯•è·å–stream.ordersä¸­çš„æ¶ˆæ¯ï¼Œå®Œæˆä¸‹å•</li></ul></div><br><p>ä¿®æ”¹ Lua è¡¨è¾¾å¼</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- å‚æ•°åˆ—è¡¨ ä¼˜æƒ åˆ¸ID ç”¨æˆ·ID è®¢å•ID</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">local</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> voucherId </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ARGV[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">local</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> userId </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ARGV[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span>
<span class="line highlighted"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">local</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> orderId </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ARGV[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]   </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- æ•°æ®KEY  åº“å­˜KEYï¼Œè®¢å•KEY</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">local</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> stockKey </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;seckill:stock:&#39; </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">..</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> voucherId</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">local</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> orderKey </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;seckill:order:&#39; </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">..</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> voucherId</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- åˆ¤æ–­åº“å­˜æ˜¯å¦å……è¶³ï¼Œåº“å­˜ä¸è¶³è¿”å›1</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">tonumber</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(redis.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">call</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;get&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,stockKey)) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">then</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- åˆ¤æ–­ç”¨æˆ·æ˜¯å¦ä¸‹å•ï¼Œç”¨æˆ·å­˜åœ¨è¿”å›2</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (redis.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">call</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;sismember&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, orderKey, userId) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">then</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- æ‰£åº“å­˜</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">redis.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">call</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;incrby&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,stockKey,</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- ä¸‹å•</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">redis.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">call</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;sadd&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,orderKey,userId)</span></span>
<span class="line"></span>
<span class="line highlighted"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- å‘é€åˆ°æ¶ˆæ¯é˜Ÿåˆ—ä¸­  XADD stream.orders * k1 v1 k2 v2 ... </span></span>
<span class="line highlighted"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">redis.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">call</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;xadd&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;stream.orders&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;*&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;userId&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,userId,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;voucherId&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,voucherId,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;id&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,orderId)  </span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span></span></code></pre></div><br><p><strong>VoucherOrderServiceImpl</strong></p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">package</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.hmdp.service.impl;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> cn.hutool.core.bean.BeanUtil;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.hmdp.dto.Result;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.hmdp.entity.SeckillVoucher;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.hmdp.entity.VoucherOrder;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.hmdp.mapper.VoucherOrderMapper;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.hmdp.service.ISeckillVoucherService;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.hmdp.service.IVoucherOrderService;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.hmdp.utils.RedisIdWorker;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.hmdp.utils.UserHolder;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> org.redisson.api.RLock;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> org.redisson.api.RedissonClient;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> org.springframework.aop.framework.AopContext;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> org.springframework.beans.factory.annotation.Autowired;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> org.springframework.core.io.ClassPathResource;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> org.springframework.data.redis.connection.stream.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> org.springframework.data.redis.core.StringRedisTemplate;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> org.springframework.data.redis.core.script.DefaultRedisScript;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> org.springframework.stereotype.Service;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> org.springframework.transaction.annotation.Transactional;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> javax.annotation.PostConstruct;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> java.time.Duration;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> java.time.LocalDateTime;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> java.util.Collections;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> java.util.List;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> java.util.Map;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> java.util.concurrent.ArrayBlockingQueue;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> java.util.concurrent.BlockingQueue;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> java.util.concurrent.ExecutorService;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> java.util.concurrent.Executors;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">/**</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> * &lt;p&gt;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> * æœåŠ¡å®ç°ç±»</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> * &lt;/p&gt;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> *</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> * </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">@author</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> è™å“¥</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> * </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">@since</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> 2021-12-22</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> */</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Service</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> VoucherOrderServiceImpl</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> extends</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ServiceImpl</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">VoucherOrderMapper</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">VoucherOrder</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">implements</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> IVoucherOrderService</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    private</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> final</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> DefaultRedisScript&lt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Long</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; SECKILL_SCRIPT;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Autowired</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    private</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> RedisIdWorker redisIdWorker;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Autowired</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    private</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> StringRedisTemplate stringRedisTemplate;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Autowired</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    private</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> RedissonClient redissonClient;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    static</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        SECKILL_SCRIPT </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> DefaultRedisScript&lt;&gt;();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        SECKILL_SCRIPT.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setLocation</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ClassPathResource</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;seckill.lua&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">));</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        SECKILL_SCRIPT.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setResultType</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(Long.class);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    private</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> IVoucherOrderService proxy;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Override</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Result </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">seckillVoucher</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(Long </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">voucherId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        //è·å–ç”¨æˆ·</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        Long userId </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> UserHolder.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getUser</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 1.æ‰§è¡Œluaè„šæœ¬</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        Long result </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> stringRedisTemplate.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">execute</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                SECKILL_SCRIPT,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                Collections.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">emptyList</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                voucherId.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">toString</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(), userId.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">toString</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        );</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> r </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> result.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">intValue</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 2.åˆ¤æ–­ç»“æœæ˜¯å¦ä¸º0</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (r </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">            // 2.1.ä¸ä¸º0 ï¼Œä»£è¡¨æ²¡æœ‰è´­ä¹°èµ„æ ¼</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Result.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">fail</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(r </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ?</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;åº“å­˜ä¸è¶³&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> :</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;ä¸èƒ½é‡å¤ä¸‹å•&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        //åˆ¤æ–­é€šè¿‡åˆ™åŠ å…¥é˜»å¡é˜Ÿåˆ—</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        VoucherOrder voucherOrder </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> VoucherOrder</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        long</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> orderId </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> redisIdWorker.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">nextId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;order&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        voucherOrder.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(orderId);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        voucherOrder.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setUserId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(userId);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        voucherOrder.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setVoucherId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(voucherId);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        orderTasks.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">add</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(voucherOrder);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        //è·å–ä»£ç†å¯¹è±¡</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        proxy </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (IVoucherOrderService) AopContext.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">currentProxy</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        //è¿”å›è®¢å•ID</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Result.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ok</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(orderId);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    //åˆ›å»ºé˜»å¡é˜Ÿåˆ—</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    private</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> BlockingQueue&lt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">VoucherOrder</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; orderTasks </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ArrayBlockingQueue&lt;&gt;(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1024</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1024</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    //å¼‚æ­¥å¤„ç†çº¿ç¨‹æ± </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    private</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> final</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ExecutorService SECKILL_ORDER_EXECUTOR </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Executors.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">newSingleThreadExecutor</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    //åœ¨ç±»åˆå§‹åŒ–ä¹‹åæ‰§è¡Œï¼Œå› ä¸ºå½“è¿™ä¸ªç±»åˆå§‹åŒ–å¥½äº†ä»¥åï¼Œéšæ—¶éƒ½æœ‰å¯èƒ½è¦æ‰§è¡Œ</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">PostConstruct</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    private</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> init</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        SECKILL_ORDER_EXECUTOR.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">submit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> VoucherOrderHandler</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">());</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line highlighted"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    private</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> VoucherOrderHandler</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> implements</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Runnable</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line highlighted"><wbr></span>
<span class="line highlighted"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Override</span></span>
<span class="line highlighted"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> run</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line highlighted"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            while</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line highlighted"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">                try</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line highlighted"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                    // 1.è·å–æ¶ˆæ¯é˜Ÿåˆ—ä¸­çš„è®¢å•ä¿¡æ¯ XREADGROUP GROUP g1 c1 COUNT 1 BLOCK 2000 STREAMS s1 &gt;</span></span>
<span class="line highlighted"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                    List&lt;MapRecord&lt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">String</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Object</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Object</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;&gt; list </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> stringRedisTemplate.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">opsForStream</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">read</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line highlighted"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                            Consumer.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">from</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;g1&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;c1&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">),</span></span>
<span class="line highlighted"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                            StreamReadOptions.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">empty</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">count</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">block</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(Duration.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ofSeconds</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)),</span></span>
<span class="line highlighted"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                            StreamOffset.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">create</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;stream.orders&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, ReadOffset.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">lastConsumed</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">())</span></span>
<span class="line highlighted"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                    );</span></span>
<span class="line highlighted"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                    // 2.åˆ¤æ–­è®¢å•ä¿¡æ¯æ˜¯å¦ä¸ºç©º</span></span>
<span class="line highlighted"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">                    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (list </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> null</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ||</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> list.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">isEmpty</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()) {</span></span>
<span class="line highlighted"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                        // å¦‚æœä¸ºnullï¼Œè¯´æ˜æ²¡æœ‰æ¶ˆæ¯ï¼Œç»§ç»­ä¸‹ä¸€æ¬¡å¾ªç¯</span></span>
<span class="line highlighted"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">                        continue</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line highlighted"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                    }</span></span>
<span class="line highlighted"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                    // è§£ææ•°æ®</span></span>
<span class="line highlighted"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                    MapRecord&lt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">String</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Object</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Object</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; record </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> list.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line highlighted"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                    Map&lt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Object</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Object</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; value </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> record.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getValue</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line highlighted"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                    VoucherOrder voucherOrder </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> BeanUtil.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">fillBeanWithMap</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(value, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> VoucherOrder</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(), </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line highlighted"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                    // 3.åˆ›å»ºè®¢å•</span></span>
<span class="line highlighted"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">                    createVoucherOrder</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(voucherOrder);</span></span>
<span class="line highlighted"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                    // 4.ç¡®è®¤æ¶ˆæ¯ XACK</span></span>
<span class="line highlighted"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                    stringRedisTemplate.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">opsForStream</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">acknowledge</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;s1&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;g1&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, record.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">());</span></span>
<span class="line highlighted"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">catch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (Exception </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">e</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line highlighted"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                    log.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;å¤„ç†è®¢å•å¼‚å¸¸&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, e);</span></span>
<span class="line highlighted"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                    //å¤„ç†å¼‚å¸¸æ¶ˆæ¯</span></span>
<span class="line highlighted"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">                    handlePendingList</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line highlighted"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                }</span></span>
<span class="line highlighted"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            }</span></span>
<span class="line highlighted"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line highlighted"><wbr></span>
<span class="line highlighted"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        private</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> handlePendingList</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line highlighted"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            while</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line highlighted"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">                try</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line highlighted"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                    // 1.è·å–pending-listä¸­çš„è®¢å•ä¿¡æ¯ XREADGROUP GROUP g1 c1 COUNT 1 BLOCK 2000 STREAMS s1 0</span></span>
<span class="line highlighted"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                    List&lt;MapRecord&lt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">String</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Object</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Object</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;&gt; list </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> stringRedisTemplate.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">opsForStream</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">read</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line highlighted"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                            Consumer.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">from</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;g1&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;c1&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">),</span></span>
<span class="line highlighted"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                            StreamReadOptions.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">empty</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">count</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">),</span></span>
<span class="line highlighted"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                            StreamOffset.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">create</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;stream.orders&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, ReadOffset.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">from</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;0&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">))</span></span>
<span class="line highlighted"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                    );</span></span>
<span class="line highlighted"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                    // 2.åˆ¤æ–­è®¢å•ä¿¡æ¯æ˜¯å¦ä¸ºç©º</span></span>
<span class="line highlighted"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">                    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (list </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> null</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ||</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> list.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">isEmpty</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()) {</span></span>
<span class="line highlighted"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                        // å¦‚æœä¸ºnullï¼Œè¯´æ˜æ²¡æœ‰å¼‚å¸¸æ¶ˆæ¯ï¼Œç»“æŸå¾ªç¯</span></span>
<span class="line highlighted"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">                        break</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line highlighted"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                    }</span></span>
<span class="line highlighted"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                    // è§£ææ•°æ®</span></span>
<span class="line highlighted"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                    MapRecord&lt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">String</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Object</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Object</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; record </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> list.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line highlighted"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                    Map&lt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Object</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Object</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; value </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> record.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getValue</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line highlighted"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                    VoucherOrder voucherOrder </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> BeanUtil.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">fillBeanWithMap</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(value, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> VoucherOrder</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(), </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line highlighted"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                    // 3.åˆ›å»ºè®¢å•</span></span>
<span class="line highlighted"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">                    createVoucherOrder</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(voucherOrder);</span></span>
<span class="line highlighted"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                    // 4.ç¡®è®¤æ¶ˆæ¯ XACK</span></span>
<span class="line highlighted"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                    stringRedisTemplate.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">opsForStream</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">acknowledge</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;s1&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;g1&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, record.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">());</span></span>
<span class="line highlighted"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">catch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (Exception </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">e</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line highlighted"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                    log.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;å¤„ç†penddingè®¢å•å¼‚å¸¸&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, e);</span></span>
<span class="line highlighted"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">                    try</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line highlighted"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                        Thread.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sleep</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">20</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line highlighted"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                    }</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">catch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(Exception </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">ex</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">){</span></span>
<span class="line highlighted"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                        ex.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">printStackTrace</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line highlighted"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                    }</span></span>
<span class="line highlighted"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                }</span></span>
<span class="line highlighted"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            }</span></span>
<span class="line highlighted"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line highlighted"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Autowired</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    private</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ISeckillVoucherService seckillVoucherService;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Transactional</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> createVoucherOrder</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(VoucherOrder </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">voucherOrder</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        Long userId </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> voucherOrder.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getUserId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        Long voucherId </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> voucherOrder.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getVoucherId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // åˆ›å»ºé”å¯¹è±¡</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        RLock redisLock </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> redissonClient.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getLock</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;lock:order:&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> +</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> userId);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // å°è¯•è·å–é”</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        boolean</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> isLock </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> redisLock.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">tryLock</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // åˆ¤æ–­</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">isLock) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">            // è·å–é”å¤±è´¥ï¼Œç›´æ¥è¿”å›å¤±è´¥æˆ–è€…é‡è¯•</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            log.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;ä¸å…è®¸é‡å¤ä¸‹å•ï¼&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        try</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">            // 5.1.æŸ¥è¯¢è®¢å•</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> count </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> query</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">eq</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;user_id&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, userId).</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">eq</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;voucher_id&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, voucherId).</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">count</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">            // 5.2.åˆ¤æ–­æ˜¯å¦å­˜åœ¨</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (count </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                // ç”¨æˆ·å·²ç»è´­ä¹°è¿‡äº†</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                log.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;ä¸å…è®¸é‡å¤ä¸‹å•ï¼&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">                return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">            // 6.æ‰£å‡åº“å­˜</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            boolean</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> success </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> seckillVoucherService.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">update</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                    .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setSql</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;stock = stock - 1&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// set stock = stock - 1</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                    .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">eq</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;voucher_id&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, voucherId)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                    .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">gt</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;stock&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// where id = ? and stock &gt; 0</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                    .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">update</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">success) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                // æ‰£å‡å¤±è´¥</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                log.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;åº“å­˜ä¸è¶³ï¼&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">                return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">            // 7.åˆ›å»ºè®¢å•</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">            save</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(voucherOrder);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">finally</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">            // é‡Šæ”¾é”</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            redisLock.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">unlock</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div></div></div></main><footer class="VPDocFooter" data-v-7b451c74 data-v-ffe8a71c><!--[--><!--]--><div class="edit-info" data-v-ffe8a71c><!----><div class="last-updated" data-v-ffe8a71c><p class="VPLastUpdated" data-v-ffe8a71c data-v-fc47d7a3>æœ€åæ›´æ–°: <time datetime="2024-11-03T15:45:53.000Z" data-v-fc47d7a3></time></p></div></div><nav class="prev-next" data-v-ffe8a71c><div class="pager" data-v-ffe8a71c><a class="VPLink link pager-link prev" href="/cswiki/src/project/redis/04-Redis%E5%AE%9E%E6%88%98-%E5%95%86%E6%88%B7%E6%9F%A5%E8%AF%A2" data-v-ffe8a71c><!--[--><span class="desc" data-v-ffe8a71c>ä¸Šä¸€ç¯‡</span><span class="title" data-v-ffe8a71c>å•†æˆ·æŸ¥è¯¢</span><!--]--></a></div><div class="pager" data-v-ffe8a71c><a class="VPLink link pager-link next" href="/cswiki/src/project/redis/06-Redis%E5%AE%9E%E6%88%98-%E8%BE%BE%E4%BA%BA%E6%8E%A2%E5%BA%97" data-v-ffe8a71c><!--[--><span class="desc" data-v-ffe8a71c>ä¸‹ä¸€ç¯‡</span><span class="title" data-v-ffe8a71c>è¾¾äººæ¢åº—</span><!--]--></a></div></nav></footer><!--[--><!--]--></div></div></div><!--[--><!--]--></div></div><!----><!--[--><!--]--></div></div>
    <script>window.__VP_HASH_MAP__=JSON.parse("{\"src_base_alg_01-æ•°æ®ç»“æ„ä¸ç®—æ³•.md\":\"swVJqwCL\",\"index.md\":\"FF-RAKJk\",\"src_base_alg_index.md\":\"MyjqLDYd\",\"src_base_cloud_00æ“ä½œç¯‡-å®‰è£…docker.md\":\"ieGtpKRS\",\"src_base_cloud_00æ“ä½œç¯‡-å®‰è£…mq.md\":\"q6UQ4zdp\",\"src_base_cloud_00æ“ä½œç¯‡-å®‰è£…nacos.md\":\"psz_g1rz\",\"src_base_cloud_00æ“ä½œç¯‡-å®‰è£…redis.md\":\"yEapRJPQ\",\"src_base_cloud_00æ“ä½œç¯‡-å¤šçº§ç¼“å­˜æ¡ˆä¾‹.md\":\"8_JwsqcT\",\"src_base_cloud_02å®ç”¨ç¯‡-å®¹å™¨ç®¡ç†.md\":\"Gg4_8yMU\",\"src_base_cloud_00æ“ä½œç¯‡-å®‰è£…seata.md\":\"xITEHdL7\",\"src_base_cloud_00æ“ä½œç¯‡-å®‰è£…elk.md\":\"7LTyXvCf\",\"src_base_cloud_03å®ç”¨ç¯‡-å¼‚æ­¥é€šä¿¡.md\":\"M6EGZRsI\",\"src_base_cloud_04å®ç”¨ç¯‡-æ–‡æ¡£æ•°æ®åº“.md\":\"F9NZz0Xh\",\"src_base_cloud_01å®ç”¨ç¯‡-å¾®æœåŠ¡æ²»ç†.md\":\"wZNaW1Dr\",\"src_base_cloud_06å®ç”¨ç¯‡-åˆ†å¸ƒå¼ç¼“å­˜.md\":\"7hBkVwHm\",\"src_base_cloud_07é«˜çº§ç¯‡-å¾®æœåŠ¡ä¿æŠ¤.md\":\"vVZ1Sc_-\",\"src_base_cloud_09é«˜çº§ç¯‡-å¯é æ¶ˆæ¯æœåŠ¡.md\":\"ezluIOj5\",\"src_base_cloud_08é«˜çº§ç¯‡-åˆ†å¸ƒå¼äº‹åŠ¡.md\":\"YmY-tyOZ\",\"src_base_cloud_10é«˜çº§ç¯‡-å¤šçº§ç¼“å­˜æŠ€æœ¯.md\":\"zpvNe4F3\",\"src_base_cloud_index.md\":\"x6LZ6at3\",\"src_base_gof_01-è®¾è®¡æ¨¡å¼å…¥é—¨.md\":\"Twc37v3L\",\"src_base_gof_02-umlç±»å›¾.md\":\"sWH0206E\",\"src_base_gof_03-å…­å¤§åŸåˆ™.md\":\"7RTrJ7i-\",\"src_base_cloud_05å®ç”¨ç¯‡-åˆ†å¸ƒå¼æœç´¢.md\":\"Xj7Lh6TX\",\"src_base_gof_04-åˆ›å»ºè€…æ¨¡å¼.md\":\"b1frCBy4\",\"src_base_java_01-javaåŸºç¡€.md\":\"md-1gUI3\",\"src_base_java_02-javaé›†åˆ.md\":\"0n9EXxZ6\",\"src_base_index.md\":\"CjSWuIry\",\"src_base_java_index.md\":\"RuqkmUqQ\",\"src_base_juc_index.md\":\"jnQ_5-hj\",\"src_base_gof_05-ç»“æ„è€…æ¨¡å¼.md\":\"9g8L9w-C\",\"src_base_juc_juc-apply-fork.md\":\"chWd-M1K\",\"src_base_gof_index.md\":\"tdFYM8T2\",\"src_base_juc_juc-apply-plan.md\":\"t-mDvOux\",\"src_base_juc_juc-apply-limit.md\":\"NCDUtiTQ\",\"src_base_juc_juc-apply-exclusive.md\":\"bIP5b6BO\",\"src_base_juc_juc-apply-sync-async.md\":\"eFEJlU6M\",\"src_base_juc_juc-apply-cache.md\":\"JNrm_IxU\",\"src_base_juc_juc-model-balking.md\":\"ATWyXd7K\",\"src_base_juc_juc-model-flyweight.md\":\"MeMO8A-2\",\"src_base_gof_07-è®¾è®¡æ¨¡å¼å®è·µ.md\":\"3pM7Hysx\",\"src_base_juc_juc-practice-batch.md\":\"N5w5aatx\",\"src_base_juc_juc-model-product.md\":\"TfxLBddi\",\"src_base_juc_juc-model-order.md\":\"KuJwD1hw\",\"src_base_juc_juc-model-termination.md\":\"f73FDwtU\",\"src_base_juc_juc-model-work-queue.md\":\"XkDclUp4\",\"src_base_juc_juc-model-protect.md\":\"p4mrllis\",\"src_base_gof_06-è¡Œä¸ºè€…æ¨¡å¼.md\":\"NjgRVFuv\",\"src_base_juc_juc-share-final.md\":\"DRG4E_3x\",\"src_base_cloud_11é¢è¯•ç¯‡-å¾®æœåŠ¡é¢è¯•é¢˜.md\":\"L8Lvz9KE\",\"src_base_juc_juc-base.md\":\"BYjv3Cbn\",\"src_base_juc_juc-share-memory.md\":\"73qKJLeq\",\"src_base_juc_juc-share-nolock.md\":\"XNhUgHzY\",\"src_base_juc_juc-share-nosync.md\":\"IstEXNbk\",\"src_base_juc_juc-share-monitor.md\":\"ablHJRcV\",\"src_base_juc_juc-theory-linked-blocking-queue.md\":\"R4XZm-5Q\",\"src_base_juc_juc-theory-concurrent-map.md\":\"_SJqSKh9\",\"src_base_juc_juc-theory-reentrant-lock.md\":\"q33YKaIa\",\"src_base_juc_juc-theory-semaphore.md\":\"FiAMhhzE\",\"src_base_juc_juc-theory-reentrant-read-write-lock.md\":\"tbvcX5gF\",\"src_base_juc_juc-theory-volatile.md\":\"X0JD0EVi\",\"src_base_juc_juc-theory-synchronized.md\":\"ortKAKD1\",\"src_base_juc_juc-tool-collections.md\":\"AZ-r1bi3\",\"src_base_juc_juc-tool-locks.md\":\"QqirRWne\",\"src_base_juc_juc-tool-tools.md\":\"mlDt0KWi\",\"src_base_juc_juc-tools-atomic.md\":\"PtnZWSZA\",\"src_base_jvm_index.md\":\"pG-O5aN6\",\"src_base_jvm_jvm-base.md\":\"P2eALBsa\",\"src_base_jvm_jvm-base-bytecode.md\":\"Eduzz1IX\",\"src_base_jvm_jvm-base-gc.md\":\"yHGH2n2l\",\"src_base_jvm_jvm-senior-graal-vm.md\":\"DAXKHlHc\",\"src_base_jvm_jvm-base-runtime.md\":\"SJFPW7gj\",\"src_base_juc_juc-tools-pool.md\":\"nnVVsCkW\",\"src_base_jvm_jvm-senior-new-gc.md\":\"dpq5rMqs\",\"src_base_jvm_jvm-senior-java-agent.md\":\"DJX5UP0-\",\"src_base_jvm_jvm-tuning-gc.md\":\"4pZlx7pb\",\"src_base_linux_01-åˆå§‹linux.md\":\"StuIZGWa\",\"src_base_linux_index.md\":\"Ua07q16P\",\"src_base_mysql_01-mysqlåŸºç¡€.md\":\"pSdd5XcZ\",\"src_base_mysql_02-mysqlè¿›é˜¶-æ•°æ®åº“æ¶æ„.md\":\"YLupdM1c\",\"src_base_mysql_02-mysqlè¿›é˜¶-ç´¢å¼•.md\":\"REsen0SR\",\"src_base_mysql_02-mysqlè¿›é˜¶-äº‹åŠ¡.md\":\"l0NBH66L\",\"src_base_mysql_02-mysqlè¿›é˜¶-sqlä¼˜åŒ–.md\":\"20xgs4Kx\",\"src_base_mysql_02-mysqlè¿›é˜¶-innodbå¼•æ“.md\":\"30d9HhSj\",\"src_base_mysql_02-mysqlè¿›é˜¶-é”.md\":\"PMNnnXzf\",\"src_base_jvm_jvm-tuning-function.md\":\"PcqhGm4c\",\"src_base_jvm_jvm-summarize.md\":\"lXUmnuJu\",\"src_base_jvm_jvm-theory.md\":\"x8DndpNx\",\"src_base_jvm_jvm-tuning-memory.md\":\"YHGnaTrS\",\"src_base_mysql_03-mysqlè¿ç»´-æ€§èƒ½ä¼˜åŒ–.md\":\"pfkINVF5\",\"src_base_mysql_03-mysqlè¿ç»´-ç®¡ç†å·¥å…·.md\":\"xRHTtOaI\",\"src_base_mysql_03-mysqlè¿ç»´-åˆ†åº“åˆ†è¡¨.md\":\"ZPVC0_Nv\",\"src_base_mysql_03-mysqlè¿ç»´-æ—¥å¿—æ–‡ä»¶.md\":\"EVJyUbT0\",\"src_base_mysql_03-mysqlè¿ç»´-ä¸»ä»å¤åˆ¶.md\":\"0NeuLHW7\",\"src_base_mysql_04-mysqlå®è·µ-sqlè®°å½•.md\":\"zDd4TSxB\",\"src_base_mysql_03-mysqlè¿ç»´-è¯»å†™åˆ†ç¦».md\":\"1F8rT23t\",\"src_base_mysql_04-mysqlå®è·µ-sqlç»ƒä¹ .md\":\"nR54OvyS\",\"src_base_mysql_index.md\":\"gBKktBqs\",\"src_base_netty_index.md\":\"LXYE7ddD\",\"src_base_netty_netty-code.md\":\"Grh9C4dp\",\"src_base_netty_netty-base.md\":\"D6_0Bxi7\",\"src_base_mysql_02-mysqlè¿›é˜¶.md\":\"T5tdgmYR\",\"src_base_spring_spring-aop.md\":\"egWS7_n6\",\"src_base_spring_index.md\":\"EM8AQAEi\",\"src_base_spring_spring-mvc.md\":\"5rWSZLcQ\",\"src_base_spring_spring-other.md\":\"OtlMdl2o\",\"src_base_spring_spring-boot.md\":\"lwm3hvPj\",\"src_base_summarize_java-base.md\":\"N6OvBOHs\",\"src_base_summarize_index.md\":\"-8d_yV7e\",\"src_base_summarize_interview.md\":\"uYScr83e\",\"src_base_summarize_gof.md\":\"xAWvlZXo\",\"src_base_summarize_java-netty.md\":\"x2pFfzzl\",\"src_base_spring_spring-bean.md\":\"_YU0p9zf\",\"src_base_netty_netty-senior.md\":\"uOf6JuG2\",\"src_base_summarize_java-collection.md\":\"q8ZcRnF3\",\"src_base_summarize_message-queue.md\":\"Ell0PlTC\",\"src_base_summarize_spring-cloud.md\":\"O0nrcLKs\",\"src_base_summarize_project-practice.md\":\"30CvZcCs\",\"src_base_summarize_java-virtual.md\":\"PcMwlH72\",\"src_project_college_00-è™šæ‹Ÿæœºå¯¼å…¥.md\":\"BtH_ekVp\",\"src_project_college_00-è‡ªå®šä¹‰éƒ¨ç½².md\":\"0qnGyG9p\",\"src_project_college_00-å†…ç½‘ç©¿é€.md\":\"5epNi5lB\",\"src_base_summarize_mysql.md\":\"DMXSPE9L\",\"src_base_summarize_spring.md\":\"p2oG9Onm\",\"src_base_summarize_redis.md\":\"Xh125uN3\",\"src_base_netty_non-blocking-io.md\":\"DFxvqtOp\",\"src_project_college_01-åˆè¯†é¡¹ç›®.md\":\"N-RietTZ\",\"src_base_summarize_java-concurrent.md\":\"oA3USkyW\",\"src_project_college_02-æˆ‘çš„è¯¾è¡¨.md\":\"afiNyrhG\",\"src_project_college_04-å­¦ä¹ è®°å½•.md\":\"-_Tk7_j3\",\"src_project_college_03-å­¦ä¹ è®¡åˆ’.md\":\"4Z-MQRjM\",\"src_project_college_05-é—®ç­”ç³»ç»Ÿ.md\":\"6sGCsZA2\",\"src_project_college_06-ç‚¹èµç³»ç»Ÿ.md\":\"q1yTK1XB\",\"src_project_college_07-ç§¯åˆ†ç³»ç»Ÿ.md\":\"QODLJGwf\",\"src_project_college_08-æ’è¡Œæ¦œåŠŸèƒ½.md\":\"w4I0TgA_\",\"src_project_college_10-é¢†å–ä¼˜æƒ åˆ¸.md\":\"yV-JqecF\",\"src_project_college_13-é¡¹ç›®éƒ¨ç½².md\":\"xn_xcUER\",\"src_project_college_index.md\":\"L3og0vVF\",\"src_project_express_00-åŸºç¡€æœåŠ¡.md\":\"376SObFF\",\"src_project_express_00-å¸¸è§é—®é¢˜.md\":\"CUeyIsM4\",\"src_project_college_14-é¡¹ç›®å®æˆ˜.md\":\"4YLTJHkc\",\"src_project_college_09-ä¼˜æƒ åˆ¸ç®¡ç†.md\":\"U9eTVbeF\",\"src_project_express_00-åŸºç¡€å·¥å…·.md\":\"a8pWbL0u\",\"src_project_college_11-ä¼˜æƒ åˆ¸ä¼˜åŒ–.md\":\"HRTnYaCG\",\"src_project_express_01-åˆè¯†é¡¹ç›®.md\":\"GbRCqzxN\",\"src_project_college_12-ä¼˜æƒ åˆ¸ä½¿ç”¨.md\":\"Y4bejsfW\",\"src_project_express_03-è¿è´¹æœåŠ¡.md\":\"QyKspbxC\",\"src_project_express_02-æ”¯ä»˜æœåŠ¡.md\":\"rPszblZo\",\"src_project_express_04-è·¯çº¿æœåŠ¡.md\":\"TLkJQBID\",\"src_project_express_06-è¿è¾“ä»»åŠ¡.md\":\"LwysKUvo\",\"src_project_express_05-è°ƒåº¦æœåŠ¡.md\":\"nnBYTdYo\",\"src_project_express_07-ä½œä¸šèŒƒå›´.md\":\"OoM_JyMv\",\"src_project_express_08-æ´¾ä»¶è°ƒåº¦.md\":\"z8faVzxd\",\"src_project_express_09-ç‰©æµæœåŠ¡.md\":\"qs-XdeKm\",\"src_project_express_10-æŒç»­é›†æˆ.md\":\"qHyIEOH-\",\"src_project_financial_index.md\":\"_dipptdR\",\"src_project_health_index.md\":\"MOoLLfU7\",\"src_project_index.md\":\"-uzkkdVO\",\"src_project_express_12-é¡¹ç›®å®æˆ˜.md\":\"fA_7fIIF\",\"src_project_express_index.md\":\"GDw4KM25\",\"src_project_express_11-é¡¹ç›®è¿ç»´.md\":\"p0kc39qy\",\"src_project_redis_02-rediså®æˆ˜-é»‘é©¬ç‚¹è¯„.md\":\"8LxFzK1e\",\"src_project_redis_01-redisåŸºç¡€.md\":\"WBJYPgIp\",\"src_project_redis_03-rediså®æˆ˜-çŸ­ä¿¡ç™»å½•.md\":\"bEoJ6kN_\",\"src_project_redis_04-rediså®æˆ˜-å•†æˆ·æŸ¥è¯¢.md\":\"pZWuWyzt\",\"src_project_redis_06-rediså®æˆ˜-è¾¾äººæ¢åº—.md\":\"ofOd3WsL\",\"src_project_redis_08-rediså®æˆ˜-é™„è¿‘å•†æˆ·.md\":\"jvOX54uo\",\"src_project_redis_07-rediså®æˆ˜-å¥½å‹å…³æ³¨.md\":\"j-rgE_B_\",\"src_project_redis_10-rediså®æˆ˜-uvç»Ÿè®¡.md\":\"GavO2Vq4\",\"src_project_redis_09-rediså®æˆ˜-ç”¨æˆ·ç­¾åˆ°.md\":\"6BYgiJ-G\",\"src_project_redis_05-rediså®æˆ˜-ä¼˜æƒ åˆ¸ç§’æ€.md\":\"JZ34CXjc\",\"src_project_redis_11-rediså®è·µ.md\":\"fKvuEAZv\",\"src_project_redis_12-redisåŸç†-æ•°æ®ç»“æ„.md\":\"hN1W-Abs\",\"src_project_redis_index.md\":\"wSkhV2NJ\",\"src_project_rent_index.md\":\"Iybh37Ms\",\"src_project_redis_13-redisåŸç†-ç½‘ç»œæ¨¡å‹.md\":\"j5UYhDcX\",\"src_project_shop_index.md\":\"kVFuNBWp\",\"src_project_takeout_index.md\":\"kGycznV8\",\"src_project_social_index.md\":\"_llU1edg\",\"src_project_redis_14-redisåŸç†-å†…å­˜ç­–ç•¥.md\":\"brnCtCg0\",\"src_project_topnews_00-è™šæ‹Ÿæœºå¯¼å…¥.md\":\"BYKu4wH1\",\"src_project_topnews_00-è‡ªå®šä¹‰éƒ¨ç½².md\":\"t__659DY\",\"src_project_topnews_01-åˆè¯†é¡¹ç›®.md\":\"HwhS9NNx\",\"src_project_topnews_00-è‡ªå®šä¹‰æœåŠ¡.md\":\"cakq0AAd\",\"src_project_topnews_03-æ–‡ç« å‘å¸ƒ.md\":\"b7gsko2z\",\"src_project_topnews_02-æ–‡ç« æŸ¥çœ‹.md\":\"Lfi0FXnC\",\"src_project_topnews_06-æ–‡ç« ä¸Šæ¶.md\":\"_rXw-Qjr\",\"src_project_topnews_04-æ–‡ç« å®¡æ ¸.md\":\"9ehA9QUe\",\"src_project_topnews_08-å¹³å°ç®¡ç†.md\":\"kCaSxZN0\",\"src_project_topnews_09-ç”¨æˆ·è¡Œä¸º.md\":\"o98DyDMW\",\"src_project_topnews_10-å®šæ—¶è®¡ç®—.md\":\"Xev9SMdC\",\"src_project_topnews_07-æ–‡ç« æœç´¢.md\":\"M9jsEy7e\",\"src_project_topnews_12-å¤šçº§ç¼“å­˜.md\":\"OEkgLTv_\",\"src_study_book_01-å›¾ä¹¦å­¦ä¹ .md\":\"8q-i_wqh\",\"src_study_english_01-è‹±è¯­å­¦ä¹ .md\":\"26mQ_RqO\",\"src_study_index.md\":\"MSU53i-2\",\"src_project_topnews_index.md\":\"DjOImstG\",\"src_study_method_01-é«˜æ•ˆæœç´¢.md\":\"FtdLWAQk\",\"src_study_method_03-ç»“æ„æ€ç»´.md\":\"MIYiCZwc\",\"src_study_method_02-å…»æˆå¥½ä¹ æƒ¯.md\":\"kMBM7_Fu\",\"src_study_movie_01-ç”µå½±å½±ç‰‡.md\":\"YJ6rn4p5\",\"src_study_method_05-é¢è¯•æŠ€å·§.md\":\"Qer4h2XN\",\"src_study_method_04-æå‡ä¸“æ³¨åŠ›.md\":\"la1bup_b\",\"src_project_topnews_11-å®æ—¶è®¡ç®—.md\":\"JpQNVF9K\",\"src_project_topnews_13-æŒç»­é›†æˆ.md\":\"McstQZye\",\"src_project_topnews_14-é¡¹ç›®å®æˆ˜.md\":\"n0RxpO08\",\"src_project_topnews_05-å»¶è¿Ÿå‘å¸ƒ.md\":\"sVaq0_ZS\"}");window.__VP_SITE_DATA__=JSON.parse("{\"lang\":\"zh-CN\",\"dir\":\"ltr\",\"title\":\"çŸ¥è¯†å°å†Œå­\",\"description\":\"æ­å»ºä¸ªäººçš„çŸ¥è¯†ä½“ç³»,ä¸€ä¸ªå¥½çš„çŸ¥è¯†ä½“ç³»å’Œå­¦ä¹ æ–¹æ³•ä¼šè®©è‡ªå·±äº‹åŠåŠŸå€\",\"base\":\"/cswiki/\",\"head\":[],\"router\":{\"prefetchLinks\":true},\"appearance\":true,\"themeConfig\":{\"nav\":[{\"text\":\"ğŸ“Œ æŠ€æœ¯åšå®¢\",\"link\":\"/\"},{\"text\":\"ğŸ“ åŸºç¡€çŸ¥è¯†\",\"items\":[{\"items\":[{\"text\":\"â˜•ï¸ JavaåŸºç¡€\",\"link\":\"/src/base/java/index\"},{\"text\":\"ğŸ–¥ JVMå…¥é—¨\",\"link\":\"/src/base/jvm/index\"},{\"text\":\"ğŸ”¥ å¹¶å‘ç¼–ç¨‹\",\"link\":\"/src/base/juc/index\"},{\"text\":\"ğŸŒ ç½‘ç»œç¼–ç¨‹\",\"link\":\"/src/base/netty/index\"}]},{\"items\":[{\"text\":\"ğŸ§© æ•°æ®ç»“æ„\",\"link\":\"/src/base/alg/index\"},{\"text\":\"ğŸ“ è®¾è®¡æ¨¡å¼\",\"link\":\"/src/base/gof/index\"}]},{\"items\":[{\"text\":\"ğŸ“Š æ•°æ®åº“\",\"link\":\"/src/base/mysql/index\"},{\"text\":\"ğŸ‘¨â€ğŸ’» æœåŠ¡å™¨\",\"link\":\"/src/base/linux/index\"},{\"text\":\"ğŸŒ± Spring\",\"link\":\"/src/base/spring/index\"},{\"text\":\"â˜ï¸ å¾®æœåŠ¡\",\"link\":\"/src/base/cloud/index\"}]}]},{\"text\":\"ğŸ› ï¸ é¡¹ç›®å®æˆ˜\",\"items\":[{\"items\":[{\"text\":\"ğŸ”–ï¸ é»‘é©¬ç‚¹è¯„\",\"link\":\"/src/project/redis/index\"},{\"text\":\"ğŸ“° é»‘é©¬å¤´æ¡\",\"link\":\"/src/project/topnews/index\"}]},{\"items\":[{\"text\":\"ğŸ“š å¤©æœºå­¦å ‚\",\"link\":\"/src/project/college/index\"},{\"text\":\"ğŸšš ç¥é¢†ç‰©æµ\",\"link\":\"/src/project/express/index\"},{\"text\":\"ğŸ›’ è°·ç²’å•†åŸ\",\"link\":\"/src/project/shop/index\"}]},{\"items\":[{\"text\":\"ğŸœ è°·ç²’å¤–å–\",\"link\":\"/src/project/takeout/index\"},{\"text\":\"ğŸ„ è°·ç²’å¥åº·\",\"link\":\"/src/project/health/index\"},{\"text\":\"ğŸ§‘â€ğŸ¤â€ğŸ§‘ è°·ç²’äº¤å‹\",\"link\":\"/src/project/social/index\"},{\"text\":\"ğŸ  è°·ç²’ç§Ÿæˆ¿\",\"link\":\"/src/project/rent/index\"},{\"text\":\"ğŸ“ˆ è°·ç²’é‡‘è\",\"link\":\"/src/project/financial/index\"}]}],\"activeMatch\":\"/src/project\"},{\"text\":\"ğŸ’¼ é¢è¯•å®å…¸\",\"link\":\"/src/base/summarize/index\",\"activeMatch\":\"/src/base/summarize\"}],\"sidebar\":{\"/src/study\":[{\"text\":\"å­¦ä¹ æ–¹æ³•\",\"link\":\"\",\"items\":[{\"text\":\"é«˜æ•ˆæœç´¢\",\"link\":\"/src/study/method/01-é«˜æ•ˆæœç´¢\"},{\"text\":\"å…»æˆå¥½ä¹ æƒ¯\",\"link\":\"/src/study/method/02-å…»æˆå¥½ä¹ æƒ¯\"},{\"text\":\"ç»“æ„æ€ç»´\",\"link\":\"/src/study/method/03-ç»“æ„æ€ç»´\"},{\"text\":\"æå‡ä¸“æ³¨åŠ›\",\"link\":\"/src/study/method/04-æå‡ä¸“æ³¨åŠ›\"}]}],\"/src/base/java\":[{\"text\":\"JavaåŸºç¡€\",\"base\":\"/src/base/java/\",\"link\":\"01-JavaåŸºç¡€\"},{\"text\":\"Javaé›†åˆ\",\"base\":\"/src/base/java/\",\"link\":\"02-Javaé›†åˆ\"}],\"/src/base/jvm\":[{\"text\":\"JVM\",\"base\":\"/src/base/jvm/\",\"collapsed\":false,\"items\":[{\"text\":\"è™šæ‹ŸæœºåŸºç¡€\",\"items\":[{\"text\":\"JVMå…¥é—¨\",\"link\":\"jvm-base\"},{\"text\":\"å­—èŠ‚ç ä¸ç±»çš„åŠ è½½\",\"link\":\"jvm-base-bytecode\"},{\"text\":\"è¿è¡Œæ—¶æ•°æ®åŒº\",\"link\":\"jvm-base-runtime\"},{\"text\":\"åƒåœ¾å›æ”¶\",\"link\":\"jvm-base-gc\"}]},{\"text\":\"è™šæ‹Ÿæœºå®æˆ˜\",\"items\":[{\"text\":\"å†…å­˜è°ƒä¼˜\",\"link\":\"jvm-tuning-memory\"},{\"text\":\"GCè°ƒä¼˜\",\"link\":\"jvm-tuning-gc\"},{\"text\":\"æ€§èƒ½è°ƒä¼˜\",\"link\":\"jvm-tuning-function\"}]},{\"text\":\"è™šæ‹Ÿæœºé«˜çº§\",\"items\":[{\"text\":\"GraalVM\",\"link\":\"jvm-senior-graal-vm\"},{\"text\":\"æ–°ä¸€ä»£GC\",\"link\":\"jvm-senior-new-gc\"},{\"text\":\"Javaå·¥å…·\",\"link\":\"jvm-senior-java-agent\"}]},{\"text\":\"è™šæ‹ŸæœºåŸç†\",\"link\":\"jvm-theory\",\"items\":[]},{\"text\":\"è™šæ‹Ÿæœºæ€»ç»“\",\"link\":\"jvm-summarize\"}]}],\"/src/base/juc\":[{\"text\":\"å¹¶å‘ç¼–ç¨‹\",\"base\":\"/src/base/juc/\",\"collapsed\":false,\"items\":[{\"text\":\"å¹¶å‘ç¼–ç¨‹åŸºç¡€\",\"link\":\"juc-base\"},{\"text\":\"å¹¶å‘ç¼–ç¨‹ç†è®º\",\"base\":\"/src/base/juc/juc-share-\",\"items\":[{\"text\":\"å…±äº«æ¨¡å‹ä¹‹ç®¡ç¨‹\",\"link\":\"monitor\"},{\"text\":\"å…±äº«æ¨¡å‹ä¹‹å†…å­˜\",\"link\":\"memory\"},{\"text\":\"å…±äº«æ¨¡å‹ä¹‹æ— é”\",\"link\":\"nolock\"},{\"text\":\"å…±äº«æ¨¡å‹ä¹‹ä¸å¯å˜\",\"link\":\"final\"},{\"text\":\"å…±äº«æ¨¡å‹ä¹‹æ— åŒæ­¥æ–¹æ¡ˆ\",\"link\":\"nosync\"}]},{\"text\":\"å¹¶å‘ç¼–ç¨‹å·¥å…·\",\"base\":\"/src/base/juc/juc-tool-\",\"items\":[{\"text\":\"çº¿ç¨‹æ± \",\"link\":\"pool\"},{\"text\":\"Locks\",\"link\":\"locks\"},{\"text\":\"Tools\",\"link\":\"tools\"},{\"text\":\"Atomic\",\"link\":\"atomic\"},{\"text\":\"Collections\",\"link\":\"collections\"}]},{\"text\":\"å¹¶å‘ç¼–ç¨‹åº”ç”¨\",\"base\":\"/src/base/juc/juc-apply-\",\"items\":[{\"text\":\"åŒæ­¥å’Œå¼‚æ­¥\",\"link\":\"sync-async\"},{\"text\":\"é™åˆ¶\",\"link\":\"limit\"},{\"text\":\"äº’æ–¥\",\"link\":\"exclusive\"},{\"text\":\"ç¼“å­˜\",\"link\":\"cache\"},{\"text\":\"åˆ†æ²»\",\"link\":\"fork\"},{\"text\":\"ç»Ÿç­¹\",\"link\":\"plan\"}]},{\"text\":\"å¹¶å‘ç¼–ç¨‹æ¨¡å¼\",\"base\":\"/src/base/juc/juc-model\",\"items\":[{\"text\":\"åŒæ­¥æ¨¡å¼ä¹‹ä¿æŠ¤è€…æš‚åœ\",\"link\":\"protect\"},{\"text\":\"åŒæ­¥æ¨¡å¼ä¹‹é¡ºåºæ§åˆ¶\",\"link\":\"order\"},{\"text\":\"åŒæ­¥æ¨¡å¼ä¹‹Balking\",\"link\":\"balking\"},{\"text\":\"å¼‚æ­¥æ¨¡å¼ä¹‹ç”Ÿäº§è€…æ¶ˆè´¹è€…\",\"link\":\"product\"},{\"text\":\"å¼‚æ­¥æ¨¡å¼ä¹‹å·¥ä½œçº¿ç¨‹\",\"link\":\"work-queue\"},{\"text\":\"ç»ˆæ­¢æ¨¡å¼ä¹‹ä¸¤é˜¶æ®µç»ˆæ­¢\",\"link\":\"termination\"},{\"text\":\"å…±äº«æ¨¡å¼ä¹‹äº«å…ƒ\",\"link\":\"flyweight\"}]},{\"text\":\"* å¹¶å‘ç¼–ç¨‹åŸç†\",\"base\":\"/src/base/juc/juc-theory-\",\"items\":[{\"text\":\"synchronizedåŸç†\",\"link\":\"synchronized\"},{\"text\":\"volatileåŸç†\",\"link\":\"volatile\"},{\"text\":\"ReentrantLockåŸç†\",\"link\":\"reentrant-lock\"},{\"text\":\"è¯»å†™é”åŸç†\",\"link\":\"reentrant-read-write-lock\"},{\"text\":\"SemaphoreåŸç†\",\"link\":\"semaphore\"},{\"text\":\"ConcurrentMapåŸç†\",\"link\":\"concurrent-map\"},{\"text\":\"LinkedBlockingQueueåŸç†\",\"link\":\"linked-blocking-queue\"}]},{\"text\":\"å¹¶å‘ç¼–ç¨‹åœºæ™¯\",\"base\":\"/src/base/juc/juc-practice\",\"items\":[{\"text\":\"æ‰¹é‡æ•°æ®å¯¼å…¥\",\"link\":\"batch\"}]}]}],\"/src/base/netty\":[{\"text\":\"ç½‘ç»œç¼–ç¨‹\",\"collapsed\":false,\"base\":\"/src/base/netty/\",\"items\":[{\"text\":\"Java NIO\",\"link\":\"non-blocking-io\"},{\"text\":\"Netty\",\"items\":[{\"text\":\"Netty åŸºç¡€\",\"link\":\"netty-base\"},{\"text\":\"Netty é«˜çº§\",\"link\":\"netty-senior\"},{\"text\":\"*Netty æºç \",\"link\":\"netty-code\"}]},{\"text\":\"Nginx\"}]}],\"/src/base/mysql\":[{\"text\":\"æ•°æ®åº“\",\"base\":\"/src/base/mysql/\",\"items\":[{\"text\":\"MySQLåŸºç¡€\",\"link\":\"01-MySQLåŸºç¡€\"},{\"text\":\"MySQLè¿›é˜¶\",\"base\":\"/src/base/mysql/02-\",\"link\":\"MySQLè¿›é˜¶\",\"items\":[{\"text\":\"æ•°æ®åº“æ¶æ„\",\"link\":\"MySQLè¿›é˜¶-æ•°æ®åº“æ¶æ„\"},{\"text\":\"ç´¢å¼•\",\"link\":\"MySQLè¿›é˜¶-ç´¢å¼•\"},{\"text\":\"SQLä¼˜åŒ–\",\"link\":\"MySQLè¿›é˜¶-SQLä¼˜åŒ–\"},{\"text\":\"é”\",\"link\":\"MySQLè¿›é˜¶-é”\"},{\"text\":\"InnoDBå¼•æ“\",\"link\":\"MySQLè¿›é˜¶-InnoDBå¼•æ“\"}]},{\"text\":\"MySQLè¿ç»´\",\"base\":\"/src/base/mysql/03-MySQLè¿ç»´-\",\"items\":[{\"text\":\"ç®¡ç†å·¥å…·\",\"link\":\"ç®¡ç†å·¥å…·\"},{\"text\":\"æ—¥å¿—æ–‡ä»¶\",\"link\":\"æ—¥å¿—æ–‡ä»¶\"},{\"text\":\"ä¸»ä»å¤åˆ¶\",\"link\":\"ä¸»ä»å¤åˆ¶\"},{\"text\":\"åˆ†åº“åˆ†è¡¨\",\"link\":\"åˆ†åº“åˆ†è¡¨\"},{\"text\":\"è¯»å†™åˆ†ç¦»\",\"link\":\"è¯»å†™åˆ†ç¦»\"}]},{\"text\":\"MySQLå®è·µ\",\"base\":\"/src/base/mysql/04-MySQLå®è·µ-\",\"items\":[{\"text\":\"SQLè®°å½•\",\"link\":\"SQLè®°å½•\"},{\"text\":\"SQLç»ƒä¹ \",\"link\":\"SQLç»ƒä¹ \"}]}]}],\"/src/base/gof\":[{\"text\":\"è®¾è®¡æ¨¡å¼\",\"collapsed\":false,\"base\":\"/src/base/gof/\",\"items\":[{\"text\":\"è®¾è®¡æ¨¡å¼å…¥é—¨\",\"link\":\"01-è®¾è®¡æ¨¡å¼å…¥é—¨\"},{\"text\":\"UMLç±»å›¾\",\"link\":\"02-UMLç±»å›¾\"},{\"text\":\"å…­å¤§åŸåˆ™\",\"link\":\"03-å…­å¤§åŸåˆ™\"},{\"text\":\"åˆ›å»ºè€…æ¨¡å¼\",\"link\":\"04-åˆ›å»ºè€…æ¨¡å¼\"},{\"text\":\"ç»“æ„è€…æ¨¡å¼\",\"link\":\"05-ç»“æ„è€…æ¨¡å¼\"},{\"text\":\"è¡Œä¸ºè€…æ¨¡å¼\",\"link\":\"06-è¡Œä¸ºè€…æ¨¡å¼\"},{\"text\":\"è®¾è®¡æ¨¡å¼å®è·µ\",\"link\":\"07-è®¾è®¡æ¨¡å¼å®è·µ\"}]}],\"/src/base/spring\":[{\"text\":\"SpringåŸç†ç¯‡\",\"collapsed\":false,\"base\":\"/src/base/spring/\",\"items\":[{\"text\":\"Spring-Bean\",\"link\":\"01-Spring-Bean\"},{\"text\":\"Spring-AOP\",\"link\":\"02-Spring-AOP\"},{\"text\":\"Spring-Boot\",\"link\":\"03-Spring-Boot\"},{\"text\":\"Spring-MVC\",\"link\":\"04-Spring-MVC\"},{\"text\":\"Spring-Other\",\"link\":\"05-Spring-Other\"}]},{\"text\":\"Springé›†æˆç¯‡\",\"collapsed\":false}],\"/src/base/cloud\":[{\"text\":\"Cloud å®ç”¨ç¯‡\",\"base\":\"/src/base/cloud/\",\"collapsed\":false,\"items\":[{\"text\":\"å¾®æœåŠ¡æ²»ç†\",\"link\":\"01å®ç”¨ç¯‡-å¾®æœåŠ¡æ²»ç†\"},{\"text\":\"å®¹å™¨ç®¡ç†\",\"link\":\"02å®ç”¨ç¯‡-å®¹å™¨ç®¡ç†\"},{\"text\":\"å¼‚æ­¥é€šä¿¡\",\"link\":\"03å®ç”¨ç¯‡-å¼‚æ­¥é€šä¿¡\"},{\"text\":\"æ–‡æ¡£æ•°æ®åº“\",\"link\":\"04å®ç”¨ç¯‡-æ–‡æ¡£æ•°æ®åº“\"},{\"text\":\"åˆ†å¸ƒå¼ç¼“å­˜\",\"link\":\"06å®ç”¨ç¯‡-åˆ†å¸ƒå¼ç¼“å­˜\"}]},{\"text\":\"Cloud é«˜çº§ç¯‡\",\"base\":\"/src/base/cloud/\",\"collapsed\":false,\"items\":[{\"text\":\"åˆ†å¸ƒå¼æœç´¢\",\"link\":\"05å®ç”¨ç¯‡-åˆ†å¸ƒå¼æœç´¢\"},{\"text\":\"åˆ†å¸ƒå¼äº‹åŠ¡\",\"link\":\"08é«˜çº§ç¯‡-åˆ†å¸ƒå¼äº‹åŠ¡\"},{\"text\":\"å¾®æœåŠ¡ä¿æŠ¤\",\"link\":\"07é«˜çº§ç¯‡-å¾®æœåŠ¡ä¿æŠ¤\"},{\"text\":\"å¯é æ¶ˆæ¯æœåŠ¡\",\"link\":\"09é«˜çº§ç¯‡-å¯é æ¶ˆæ¯æœåŠ¡\"},{\"text\":\"å¤šçº§ç¼“å­˜æŠ€æœ¯\",\"link\":\"10é«˜çº§ç¯‡-å¤šçº§ç¼“å­˜æŠ€æœ¯\"},{\"text\":\"å¾®æœåŠ¡é¢è¯•é¢˜\",\"link\":\"11é¢è¯•ç¯‡-å¾®æœåŠ¡é¢è¯•é¢˜\"}]},{\"text\":\"Cloud æ“ä½œç¯‡\",\"base\":\"/src/base/cloudÂ¡/00æ“ä½œç¯‡-\",\"collapsed\":false,\"items\":[{\"text\":\"å®‰è£…Nacos\",\"link\":\"å®‰è£…Nacos\"},{\"text\":\"å®‰è£…Seata\",\"link\":\"å®‰è£…Seata\"},{\"text\":\"å®‰è£…Docker\",\"link\":\"å®‰è£…Docker\"},{\"text\":\"å®‰è£…Redis\",\"link\":\"å®‰è£…Redis\"},{\"text\":\"å®‰è£…MQ\",\"link\":\"å®‰è£…MQ\"},{\"text\":\"å®‰è£…ELK\",\"link\":\"å®‰è£…ELK\"},{\"text\":\"å¤šçº§ç¼“å­˜æ¡ˆä¾‹\",\"link\":\"å¤šçº§ç¼“å­˜æ¡ˆä¾‹\"}]}],\"/src/project/redis\":[{\"text\":\"é»‘é©¬ç‚¹è¯„\",\"collapsed\":false,\"base\":\"/src/project/redis/\",\"items\":[{\"text\":\"RedisåŸºç¡€\",\"link\":\"01-RedisåŸºç¡€\"},{\"text\":\"Rediså®æˆ˜\",\"base\":\"/src/project/redis/\",\"items\":[{\"text\":\"é»‘é©¬ç‚¹è¯„\",\"link\":\"02-Rediså®æˆ˜-é»‘é©¬ç‚¹è¯„\"},{\"text\":\"çŸ­ä¿¡ç™»å½•\",\"link\":\"03-Rediså®æˆ˜-çŸ­ä¿¡ç™»å½•\"},{\"text\":\"å•†æˆ·æŸ¥è¯¢\",\"link\":\"04-Rediså®æˆ˜-å•†æˆ·æŸ¥è¯¢\"},{\"text\":\"* ä¼˜æƒ åˆ¸ç§’æ€\",\"link\":\"05-Rediså®æˆ˜-ä¼˜æƒ åˆ¸ç§’æ€\"},{\"text\":\"è¾¾äººæ¢åº—\",\"link\":\"06-Rediså®æˆ˜-è¾¾äººæ¢åº—\"},{\"text\":\"å¥½å‹å…³æ³¨\",\"link\":\"07-Rediså®æˆ˜-å¥½å‹å…³æ³¨\"},{\"text\":\"é™„è¿‘å•†æˆ·\",\"link\":\"08-Rediså®æˆ˜-é™„è¿‘å•†æˆ·\"},{\"text\":\"ç”¨æˆ·ç­¾åˆ°\",\"link\":\"09-Rediså®æˆ˜-ç”¨æˆ·ç­¾åˆ°\"},{\"text\":\"UVç»Ÿè®¡\",\"link\":\"10-Rediså®æˆ˜-UVç»Ÿè®¡\"}]},{\"text\":\"* Rediså®è·µ\",\"link\":\"11-Rediså®è·µ\"},{\"text\":\"* RedisåŸç†\",\"base\":\"/src/project/redis/\",\"items\":[{\"text\":\"æ•°æ®ç»“æ„\",\"link\":\"12-RedisåŸç†-æ•°æ®ç»“æ„\"},{\"text\":\"ç½‘ç»œæ¨¡å‹\",\"link\":\"13-RedisåŸç†-ç½‘ç»œæ¨¡å‹\"},{\"text\":\"å†…å­˜ç­–ç•¥\",\"link\":\"14-RedisåŸç†-å†…å­˜ç­–ç•¥\"}]}]}],\"/src/project/topnews\":[{\"text\":\"é»‘é©¬ç‚¹è¯„\",\"collapsed\":false,\"base\":\"/src/project/topnews/\",\"items\":[{\"text\":\"Day01-åˆè¯†é¡¹ç›®\",\"link\":\"01-åˆè¯†é¡¹ç›®\",\"items\":[{\"text\":\"è™šæ‹Ÿæœºå¯¼å…¥\",\"link\":\"00-è™šæ‹Ÿæœºå¯¼å…¥\"},{\"text\":\"è‡ªå®šä¹‰éƒ¨ç½²\",\"link\":\"00-è‡ªå®šä¹‰éƒ¨ç½²\"},{\"text\":\"è‡ªå®šä¹‰æœåŠ¡\",\"link\":\"00-è‡ªå®šä¹‰æœåŠ¡\"}]},{\"text\":\"Day02-æ–‡ç« æŸ¥çœ‹\",\"link\":\"02-æ–‡ç« æŸ¥çœ‹\"},{\"text\":\"Day03-æ–‡ç« å‘å¸ƒ\",\"link\":\"03-æ–‡ç« å‘å¸ƒ\"},{\"text\":\"Day04-æ–‡ç« å®¡æ ¸\",\"link\":\"04-æ–‡ç« å®¡æ ¸\"},{\"text\":\"Day05-å»¶è¿Ÿå‘å¸ƒ\",\"link\":\"05-å»¶è¿Ÿå‘å¸ƒ\"},{\"text\":\"Day06-æ–‡ç« ä¸Šæ¶\",\"link\":\"06-æ–‡ç« ä¸Šæ¶\"},{\"text\":\"Day07-æ–‡ç« æœç´¢\",\"link\":\"07-æ–‡ç« æœç´¢\"},{\"text\":\"Day08-å¹³å°ç®¡ç†\",\"link\":\"08-å¹³å°ç®¡ç†\"},{\"text\":\"Day09-ç”¨æˆ·è¡Œä¸º\",\"link\":\"09-ç”¨æˆ·è¡Œä¸º\"},{\"text\":\"Day10-å®šæ—¶è®¡ç®—\",\"link\":\"10-å®šæ—¶è®¡ç®—\"},{\"text\":\"Day11-å®æ—¶è®¡ç®—\",\"link\":\"11-å®æ—¶è®¡ç®—\"},{\"text\":\"Day12-å¤šçº§ç¼“å­˜\",\"link\":\"12-å¤šçº§ç¼“å­˜\"},{\"text\":\"Day13-æŒç»­é›†æˆ\",\"link\":\"13-æŒç»­é›†æˆ\"},{\"text\":\"Day14-é¡¹ç›®å®æˆ˜\",\"link\":\"14-é¡¹ç›®å®æˆ˜\"}]}],\"/src/project/college\":[{\"text\":\"å¤©æœºå­¦å ‚\",\"collapsed\":false,\"base\":\"/src/project/college/\",\"items\":[{\"text\":\"01-åˆè¯†é¡¹ç›®\",\"link\":\"01-åˆè¯†é¡¹ç›®\",\"items\":[{\"text\":\"è™šæ‹Ÿæœºå¯¼å…¥\",\"link\":\"00-è™šæ‹Ÿæœºå¯¼å…¥\"},{\"text\":\"è‡ªå®šä¹‰éƒ¨ç½²\",\"link\":\"00-è‡ªå®šä¹‰éƒ¨ç½²\"},{\"text\":\"å†…ç½‘ç©¿é€\",\"link\":\"00-å†…ç½‘ç©¿é€\"}]},{\"text\":\"02-æˆ‘çš„è¯¾è¡¨\",\"link\":\"02-æˆ‘çš„è¯¾è¡¨\"},{\"text\":\"03-å­¦ä¹ è®¡åˆ’\",\"link\":\"03-å­¦ä¹ è®¡åˆ’\"},{\"text\":\"04-å­¦ä¹ è®°å½•\",\"link\":\"04-å­¦ä¹ è®°å½•\"},{\"text\":\"05-é—®ç­”ç³»ç»Ÿ\",\"link\":\"05-é—®ç­”ç³»ç»Ÿ\"},{\"text\":\"06-ç‚¹èµç³»ç»Ÿ\",\"link\":\"06-ç‚¹èµç³»ç»Ÿ\"},{\"text\":\"07-ç§¯åˆ†ç³»ç»Ÿ\",\"link\":\"07-ç§¯åˆ†ç³»ç»Ÿ\"},{\"text\":\"08-æ’è¡Œæ¦œåŠŸèƒ½\",\"link\":\"08-æ’è¡Œæ¦œåŠŸèƒ½\"},{\"text\":\"09-ä¼˜æƒ åˆ¸ç®¡ç†\",\"link\":\"09-ä¼˜æƒ åˆ¸ç®¡ç†\"},{\"text\":\"10-é¢†å–ä¼˜æƒ åˆ¸\",\"link\":\"10-é¢†å–ä¼˜æƒ åˆ¸\"},{\"text\":\"11-ä¼˜æƒ åˆ¸ä¼˜åŒ–\",\"link\":\"11-ä¼˜æƒ åˆ¸ä¼˜åŒ–\"},{\"text\":\"12-ä¼˜æƒ åˆ¸ä½¿ç”¨\",\"link\":\"12-ä¼˜æƒ åˆ¸ä½¿ç”¨\"},{\"text\":\"13-é¡¹ç›®éƒ¨ç½²\",\"link\":\"13-é¡¹ç›®éƒ¨ç½²\"},{\"text\":\"14-é¡¹ç›®å®æˆ˜\",\"link\":\"13-é¡¹ç›®å®æˆ˜\"}]}],\"/src/project/express\":[{\"text\":\"ç¥é¢†ç‰©æµ\",\"collapsed\":false,\"base\":\"/src/project/express/\",\"items\":[{\"text\":\"01-åˆè¯†é¡¹ç›®\",\"link\":\"01-åˆè¯†é¡¹ç›®\",\"items\":[{\"text\":\"åŸºç¡€æœåŠ¡\",\"link\":\"00-åŸºç¡€æœåŠ¡\"},{\"text\":\"åŸºç¡€å·¥å…·\",\"link\":\"00-åŸºç¡€å·¥å…·\"},{\"text\":\"å¸¸è§é—®é¢˜\",\"link\":\"00-å¸¸è§é—®é¢˜\"}]},{\"text\":\"02-æ”¯ä»˜æœåŠ¡\",\"link\":\"02-æ”¯ä»˜æœåŠ¡\"},{\"text\":\"03-è¿è´¹æœåŠ¡\",\"link\":\"03-è¿è´¹æœåŠ¡\"},{\"text\":\"04-è·¯çº¿æœåŠ¡\",\"link\":\"04-è·¯çº¿æœåŠ¡\"},{\"text\":\"05-è°ƒåº¦æœåŠ¡\",\"link\":\"05-è°ƒåº¦æœåŠ¡\"},{\"text\":\"06-è¿è¾“ä»»åŠ¡\",\"link\":\"06-è¿è¾“ä»»åŠ¡\"},{\"text\":\"07-ä½œä¸šèŒƒå›´\",\"link\":\"07-ä½œä¸šèŒƒå›´\"},{\"text\":\"08-æ´¾ä»¶è°ƒåº¦\",\"link\":\"08-æ´¾ä»¶è°ƒåº¦\"},{\"text\":\"09-ç‰©æµæœåŠ¡\",\"link\":\"09-ç‰©æµæœåŠ¡\"},{\"text\":\"10-æŒç»­é›†æˆ\",\"link\":\"10-æŒç»­é›†æˆ\"},{\"text\":\"11-é¡¹ç›®è¿ç»´\",\"link\":\"11-é¡¹ç›®è¿ç»´\"},{\"text\":\"12-é¡¹ç›®å®æˆ˜\",\"link\":\"12-é¡¹ç›®å®æˆ˜\"}]}],\"/src/base/summarize\":[{\"text\":\"åŸºç¡€çŸ¥è¯†\",\"collapsed\":false,\"base\":\"/src/base/summarize/\",\"items\":[{\"text\":\"JavaåŸºç¡€\",\"link\":\"java-base\"},{\"text\":\"Javaé›†åˆ\",\"link\":\"java-collection\"},{\"text\":\"Javaè™šæ‹Ÿæœº\",\"link\":\"java-virtual\"},{\"text\":\"å¹¶å‘ç¼–ç¨‹ç¯‡\",\"link\":\"java-concurrent\"},{\"text\":\"ç½‘ç»œç¼–ç¨‹ç¯‡\",\"link\":\"java-netty\"}]},{\"text\":\"æœåŠ¡æ¡†æ¶\",\"collapsed\":false,\"base\":\"/src/base/summarize/\",\"items\":[{\"text\":\"æ•°æ®åº“ç¯‡\",\"link\":\"mysql\"},{\"text\":\"ç¼“å­˜ç¯‡\",\"link\":\"redis\"},{\"text\":\"æ¡†æ¶ç¯‡\",\"link\":\"spring\"},{\"text\":\"å¾®æœåŠ¡ç¯‡\",\"link\":\"spring-cloud\"},{\"text\":\"ä¸­é—´ä»¶ç¯‡\",\"link\":\"message-queue\"}]},{\"text\":\"åœºæ™¯æŠ€æœ¯\",\"collapsed\":false,\"base\":\"/src/base/summarize/\",\"items\":[{\"text\":\"è®¾è®¡æ¨¡å¼ç¯‡\",\"link\":\"gof\"},{\"text\":\"åœºæ™¯æŠ€æœ¯ç¯‡\",\"link\":\"project-practice\"},{\"text\":\"é¢è¯•å‡†å¤‡ç¯‡\",\"link\":\"interview\"},{\"text\":\"çŸ¥è¯†ç‚¹æ±‡æ€»\",\"link\":\"index\"}]}]},\"logo\":\"/logo.svg\",\"outline\":{\"level\":\"deep\",\"label\":\"ç« èŠ‚å¯¼èˆª\"},\"darkModeSwitchLabel\":\"åˆ‡æ¢æ—¥å…‰/æš—é»‘æ¨¡å¼\",\"sidebarMenuLabel\":\"æ–‡ç« \",\"returnToTopLabel\":\"è¿”å›é¡¶éƒ¨\",\"lastUpdatedText\":\"æœ€åæ›´æ–°\",\"docFooter\":{\"prev\":\"ä¸Šä¸€ç¯‡\",\"next\":\"ä¸‹ä¸€ç¯‡\"},\"search\":{\"provider\":\"local\",\"options\":{\"locales\":{\"root\":{\"translations\":{\"button\":{\"buttonText\":\"æœç´¢æ–‡æ¡£\",\"buttonAriaLabel\":\"æœç´¢æ–‡æ¡£\"},\"modal\":{\"noResultsText\":\"æ— æ³•æ‰¾åˆ°ç›¸å…³ç»“æœ\",\"resetButtonTitle\":\"æ¸…é™¤æŸ¥è¯¢æ¡ä»¶\",\"footer\":{\"selectText\":\"é€‰æ‹©\",\"navigateText\":\"åˆ‡æ¢\"}}}}}}},\"socialLinks\":[{\"icon\":\"github\",\"link\":\"https://github.com/Charles7c/charles7c.github.io\"},{\"icon\":{\"svg\":\"<svg role=\\\"img\\\" viewBox=\\\"0 0 24 24\\\" xmlns=\\\"http://www.w3.org/2000/svg\\\"><title>ç äº‘</title><path d=\\\"M11.984 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.016 0zm6.09 5.333c.328 0 .593.266.592.593v1.482a.594.594 0 0 1-.593.592H9.777c-.982 0-1.778.796-1.778 1.778v5.63c0 .327.266.592.593.592h5.63c.982 0 1.778-.796 1.778-1.778v-.296a.593.593 0 0 0-.592-.593h-4.15a.592.592 0 0 1-.592-.592v-1.482a.593.593 0 0 1 .593-.592h6.815c.327 0 .593.265.593.592v3.408a4 4 0 0 1-4 4H5.926a.593.593 0 0 1-.593-.593V9.778a4.444 4.444 0 0 1 4.445-4.444h8.296Z\\\"/></svg>\"},\"link\":\"https://gitee.com/Charles7c/charles7c\"}],\"commentConfig\":{\"type\":\"gitalk\",\"showComment\":false},\"footerConfig\":{\"showFooter\":true,\"message\":\"Released under the MIT License.\",\"copyright\":\"Copyright Â© 2019-2024 Cookie Mousse\"}},\"locales\":{},\"scrollOffset\":134,\"cleanUrls\":true}");</script>
    
  </body>
</html>
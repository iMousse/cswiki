<!DOCTYPE html>
<html lang="zh-CN" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Day08-排行榜功能 | 知识小册子</title>
    <meta name="description" content="搭建个人的知识体系,一个好的知识体系和学习方法会让自己事半功倍">
    <meta name="generator" content="VitePress v1.0.0-rc.40">
    <link rel="preload stylesheet" href="/cswiki/assets/style.1gwXlvdp.css" as="style">
    
    <script type="module" src="/cswiki/assets/app.lS9cXfP_.js"></script>
    <link rel="preload" href="/cswiki/assets/inter-roman-latin.bvIUbFQP.woff2" as="font" type="font/woff2" crossorigin="">
    <link rel="modulepreload" href="/cswiki/assets/chunks/framework.syB9hai_.js">
    <link rel="modulepreload" href="/cswiki/assets/chunks/theme.Rh-lQPhy.js">
    <link rel="modulepreload" href="/cswiki/assets/chunks/c4Diagram-0115bee6.0zsHrUPC.js">
    <link rel="modulepreload" href="/cswiki/assets/chunks/flowDiagram-786cd8ff.4GkAIpg-.js">
    <link rel="modulepreload" href="/cswiki/assets/chunks/flowDiagram-v2-65161881.dpln7Znc.js">
    <link rel="modulepreload" href="/cswiki/assets/chunks/erDiagram-de1b0455.DxhbFKEO.js">
    <link rel="modulepreload" href="/cswiki/assets/chunks/gitGraphDiagram-5269e1d6.JaTrB07g.js">
    <link rel="modulepreload" href="/cswiki/assets/chunks/ganttDiagram-f2041c70.CAJegbtT.js">
    <link rel="modulepreload" href="/cswiki/assets/chunks/infoDiagram-3fa6ea12.N7WJjsFP.js">
    <link rel="modulepreload" href="/cswiki/assets/chunks/pieDiagram-6d9582b9.954YhiXA.js">
    <link rel="modulepreload" href="/cswiki/assets/chunks/quadrantDiagram-a1c81500.FEY5DGvb.js">
    <link rel="modulepreload" href="/cswiki/assets/chunks/requirementDiagram-3256a2fe.jp8l78zJ.js">
    <link rel="modulepreload" href="/cswiki/assets/chunks/sequenceDiagram-25152a15.H9uRe0p9.js">
    <link rel="modulepreload" href="/cswiki/assets/chunks/classDiagram-819d3ad4.a8_iB2mW.js">
    <link rel="modulepreload" href="/cswiki/assets/chunks/classDiagram-v2-c4607319.W52cTZR1.js">
    <link rel="modulepreload" href="/cswiki/assets/chunks/stateDiagram-693ac5fb.Jiyec7Dc.js">
    <link rel="modulepreload" href="/cswiki/assets/chunks/stateDiagram-v2-8f2bb0da.KIwn3lZw.js">
    <link rel="modulepreload" href="/cswiki/assets/chunks/journeyDiagram-9f355b40.3me2vnHO.js">
    <link rel="modulepreload" href="/cswiki/assets/chunks/flowchart-elk-definition-3f2388fe.AVjb3_3y.js">
    <link rel="modulepreload" href="/cswiki/assets/chunks/timeline-definition-0c903a0d.ebgn6DYo.js">
    <link rel="modulepreload" href="/cswiki/assets/chunks/mindmap-definition-35a1e92c.mVFOIMcY.js">
    <link rel="modulepreload" href="/cswiki/assets/chunks/sankeyDiagram-ebb0d63f.0HT7vg2A.js">
    <link rel="modulepreload" href="/cswiki/assets/chunks/virtual_mermaid-config.AhCe4kHV.js">
    <link rel="modulepreload" href="/cswiki/assets/src_project_college_08-排行榜功能.md.w4I0TgA_.lean.js">
    <link rel="icon" href="/favicon.ico">
    <meta name="author" content="mousse">
    <meta name="keywords" content="慕斯的知识小册子">
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">
    <meta name="theme-color" content="#3c8772">
    <meta property="og:type" content="website">
    <meta property="og:locale" content="zh_CN">
    <meta property="og:title" content="知识小册子">
    <meta property="og:description" content="搭建个人的知识体系,一个好的知识体系和学习方法会让自己事半功倍">
    <meta property="og:site_name" content="知识小册子">
    <meta property="og:image" content="/logo.svg">
    <script id="check-dark-mode">(()=>{const e=localStorage.getItem("vitepress-theme-appearance")||"auto",a=window.matchMedia("(prefers-color-scheme: dark)").matches;(!e||e==="auto"?a:e==="dark")&&document.documentElement.classList.add("dark")})();</script>
    <script id="check-mac-os">document.documentElement.classList.toggle("mac",/Mac|iPhone|iPod|iPad/i.test(navigator.platform));</script>
  </head>
  <body>
    <div id="app"><div class="Layout" data-v-83d41759><!--[--><!--]--><!--[--><span tabindex="-1" data-v-40879362></span><a href="#VPContent" class="VPSkipLink visually-hidden" data-v-40879362> Skip to content </a><!--]--><!----><header class="VPNav" data-v-83d41759 data-v-0b69728b><div class="VPNavBar has-sidebar" data-v-0b69728b data-v-0ec8604f><div class="wrapper" data-v-0ec8604f><div class="container" data-v-0ec8604f><div class="title" data-v-0ec8604f><div class="VPNavBarTitle has-sidebar" data-v-0ec8604f data-v-e5f52478><a class="title" href="/cswiki/" data-v-e5f52478><!--[--><!--]--><!--[--><img class="VPImage logo" src="/cswiki/logo.svg" alt data-v-22195471><!--]--><!--[-->知识小册子<!--]--><!--[--><!--]--></a></div></div><div class="content" data-v-0ec8604f><div class="content-body" data-v-0ec8604f><!--[--><!--]--><div class="VPNavBarSearch search" data-v-0ec8604f><!--[--><!----><div id="local-search"><button type="button" class="DocSearch DocSearch-Button" aria-label="搜索文档"><span class="DocSearch-Button-Container"><svg class="DocSearch-Search-Icon" width="20" height="20" viewBox="0 0 20 20" aria-label="search icon"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">搜索文档</span></span><span class="DocSearch-Button-Keys"><kbd class="DocSearch-Button-Key"></kbd><kbd class="DocSearch-Button-Key">K</kbd></span></button></div><!--]--></div><nav aria-labelledby="main-nav-aria-label" class="VPNavBarMenu menu" data-v-0ec8604f data-v-6ba9474d><span id="main-nav-aria-label" class="visually-hidden" data-v-6ba9474d>Main Navigation</span><!--[--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/cswiki/" tabindex="0" data-v-6ba9474d data-v-5c7cab49><!--[--><span data-v-5c7cab49>📌 技术博客</span><!--]--></a><!--]--><!--[--><div class="VPFlyout VPNavBarMenuGroup" data-v-6ba9474d data-v-8e60bb69><button type="button" class="button" aria-haspopup="true" aria-expanded="false" data-v-8e60bb69><span class="text" data-v-8e60bb69><!----><span data-v-8e60bb69>📝 基础知识</span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="text-icon" data-v-8e60bb69><path d="M12,16c-0.3,0-0.5-0.1-0.7-0.3l-6-6c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l5.3,5.3l5.3-5.3c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-6,6C12.5,15.9,12.3,16,12,16z"></path></svg></span></button><div class="menu" data-v-8e60bb69><div class="VPMenu" data-v-8e60bb69 data-v-32b6ed9e><div class="items" data-v-32b6ed9e><!--[--><!--[--><div class="VPMenuGroup" data-v-32b6ed9e data-v-8b276347><!----><!--[--><!--[--><div class="VPMenuLink" data-v-8b276347 data-v-d8ac4ebe><a class="VPLink link" href="/cswiki/src/base/java/index" data-v-d8ac4ebe><!--[-->☕️ Java基础<!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-8b276347 data-v-d8ac4ebe><a class="VPLink link" href="/cswiki/src/base/jvm/index" data-v-d8ac4ebe><!--[-->🖥 JVM入门<!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-8b276347 data-v-d8ac4ebe><a class="VPLink link" href="/cswiki/src/base/juc/index" data-v-d8ac4ebe><!--[-->🔥 并发编程<!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-8b276347 data-v-d8ac4ebe><a class="VPLink link" href="/cswiki/src/base/netty/index" data-v-d8ac4ebe><!--[-->🌐 网络编程<!--]--></a></div><!--]--><!--]--></div><!--]--><!--[--><div class="VPMenuGroup" data-v-32b6ed9e data-v-8b276347><!----><!--[--><!--[--><div class="VPMenuLink" data-v-8b276347 data-v-d8ac4ebe><a class="VPLink link" href="/cswiki/src/base/alg/index" data-v-d8ac4ebe><!--[-->🧩 数据结构<!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-8b276347 data-v-d8ac4ebe><a class="VPLink link" href="/cswiki/src/base/gof/index" data-v-d8ac4ebe><!--[-->📝 设计模式<!--]--></a></div><!--]--><!--]--></div><!--]--><!--[--><div class="VPMenuGroup" data-v-32b6ed9e data-v-8b276347><!----><!--[--><!--[--><div class="VPMenuLink" data-v-8b276347 data-v-d8ac4ebe><a class="VPLink link" href="/cswiki/src/base/mysql/index" data-v-d8ac4ebe><!--[-->📊 数据库<!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-8b276347 data-v-d8ac4ebe><a class="VPLink link" href="/cswiki/src/base/linux/index" data-v-d8ac4ebe><!--[-->👨‍💻 服务器<!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-8b276347 data-v-d8ac4ebe><a class="VPLink link" href="/cswiki/src/base/spring/index" data-v-d8ac4ebe><!--[-->🌱 Spring<!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-8b276347 data-v-d8ac4ebe><a class="VPLink link" href="/cswiki/src/base/cloud/index" data-v-d8ac4ebe><!--[-->☁️ 微服务<!--]--></a></div><!--]--><!--]--></div><!--]--><!--]--></div><!--[--><!--]--></div></div></div><!--]--><!--[--><div class="VPFlyout VPNavBarMenuGroup active" data-v-6ba9474d data-v-8e60bb69><button type="button" class="button" aria-haspopup="true" aria-expanded="false" data-v-8e60bb69><span class="text" data-v-8e60bb69><!----><span data-v-8e60bb69>🛠️ 项目实战</span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="text-icon" data-v-8e60bb69><path d="M12,16c-0.3,0-0.5-0.1-0.7-0.3l-6-6c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l5.3,5.3l5.3-5.3c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-6,6C12.5,15.9,12.3,16,12,16z"></path></svg></span></button><div class="menu" data-v-8e60bb69><div class="VPMenu" data-v-8e60bb69 data-v-32b6ed9e><div class="items" data-v-32b6ed9e><!--[--><!--[--><div class="VPMenuGroup" data-v-32b6ed9e data-v-8b276347><!----><!--[--><!--[--><div class="VPMenuLink" data-v-8b276347 data-v-d8ac4ebe><a class="VPLink link" href="/cswiki/src/project/redis/index" data-v-d8ac4ebe><!--[-->🔖️ 黑马点评<!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-8b276347 data-v-d8ac4ebe><a class="VPLink link" href="/cswiki/src/project/topnews/index" data-v-d8ac4ebe><!--[-->📰 黑马头条<!--]--></a></div><!--]--><!--]--></div><!--]--><!--[--><div class="VPMenuGroup" data-v-32b6ed9e data-v-8b276347><!----><!--[--><!--[--><div class="VPMenuLink" data-v-8b276347 data-v-d8ac4ebe><a class="VPLink link" href="/cswiki/src/project/college/index" data-v-d8ac4ebe><!--[-->📚 天机学堂<!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-8b276347 data-v-d8ac4ebe><a class="VPLink link" href="/cswiki/src/project/express/index" data-v-d8ac4ebe><!--[-->🚚 神领物流<!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-8b276347 data-v-d8ac4ebe><a class="VPLink link" href="/cswiki/src/project/shop/index" data-v-d8ac4ebe><!--[-->🛒 谷粒商城<!--]--></a></div><!--]--><!--]--></div><!--]--><!--[--><div class="VPMenuGroup" data-v-32b6ed9e data-v-8b276347><!----><!--[--><!--[--><div class="VPMenuLink" data-v-8b276347 data-v-d8ac4ebe><a class="VPLink link" href="/cswiki/src/project/takeout/index" data-v-d8ac4ebe><!--[-->🍜 谷粒外卖<!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-8b276347 data-v-d8ac4ebe><a class="VPLink link" href="/cswiki/src/project/health/index" data-v-d8ac4ebe><!--[-->🏄 谷粒健康<!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-8b276347 data-v-d8ac4ebe><a class="VPLink link" href="/cswiki/src/project/social/index" data-v-d8ac4ebe><!--[-->🧑‍🤝‍🧑 谷粒交友<!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-8b276347 data-v-d8ac4ebe><a class="VPLink link" href="/cswiki/src/project/rent/index" data-v-d8ac4ebe><!--[-->🏠 谷粒租房<!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-8b276347 data-v-d8ac4ebe><a class="VPLink link" href="/cswiki/src/project/financial/index" data-v-d8ac4ebe><!--[-->📈 谷粒金融<!--]--></a></div><!--]--><!--]--></div><!--]--><!--]--></div><!--[--><!--]--></div></div></div><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/cswiki/src/base/summarize/index" tabindex="0" data-v-6ba9474d data-v-5c7cab49><!--[--><span data-v-5c7cab49>💼 面试宝典</span><!--]--></a><!--]--><!--]--></nav><!----><div class="VPNavBarAppearance appearance" data-v-0ec8604f data-v-f8a5715e><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title="Switch to dark theme" aria-checked="false" data-v-f8a5715e data-v-a55d2cd3 data-v-43317611><span class="check" data-v-43317611><span class="icon" data-v-43317611><!--[--><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="sun" data-v-a55d2cd3><path d="M12,18c-3.3,0-6-2.7-6-6s2.7-6,6-6s6,2.7,6,6S15.3,18,12,18zM12,8c-2.2,0-4,1.8-4,4c0,2.2,1.8,4,4,4c2.2,0,4-1.8,4-4C16,9.8,14.2,8,12,8z"></path><path d="M12,4c-0.6,0-1-0.4-1-1V1c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,3.6,12.6,4,12,4z"></path><path d="M12,24c-0.6,0-1-0.4-1-1v-2c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,23.6,12.6,24,12,24z"></path><path d="M5.6,6.6c-0.3,0-0.5-0.1-0.7-0.3L3.5,4.9c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C6.2,6.5,5.9,6.6,5.6,6.6z"></path><path d="M19.8,20.8c-0.3,0-0.5-0.1-0.7-0.3l-1.4-1.4c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C20.3,20.7,20,20.8,19.8,20.8z"></path><path d="M3,13H1c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S3.6,13,3,13z"></path><path d="M23,13h-2c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S23.6,13,23,13z"></path><path d="M4.2,20.8c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C4.7,20.7,4.5,20.8,4.2,20.8z"></path><path d="M18.4,6.6c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C18.9,6.5,18.6,6.6,18.4,6.6z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="moon" data-v-a55d2cd3><path d="M12.1,22c-0.3,0-0.6,0-0.9,0c-5.5-0.5-9.5-5.4-9-10.9c0.4-4.8,4.2-8.6,9-9c0.4,0,0.8,0.2,1,0.5c0.2,0.3,0.2,0.8-0.1,1.1c-2,2.7-1.4,6.4,1.3,8.4c2.1,1.6,5,1.6,7.1,0c0.3-0.2,0.7-0.3,1.1-0.1c0.3,0.2,0.5,0.6,0.5,1c-0.2,2.7-1.5,5.1-3.6,6.8C16.6,21.2,14.4,22,12.1,22zM9.3,4.4c-2.9,1-5,3.6-5.2,6.8c-0.4,4.4,2.8,8.3,7.2,8.7c2.1,0.2,4.2-0.4,5.8-1.8c1.1-0.9,1.9-2.1,2.4-3.4c-2.5,0.9-5.3,0.5-7.5-1.1C9.2,11.4,8.1,7.7,9.3,4.4z"></path></svg><!--]--></span></span></button></div><div class="VPSocialLinks VPNavBarSocialLinks social-links" data-v-0ec8604f data-v-9b69f4c1 data-v-0ed08415><!--[--><a class="VPSocialLink no-icon" href="https://github.com/Charles7c/charles7c.github.io" aria-label="github" target="_blank" rel="noopener" data-v-0ed08415 data-v-c77ec717><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>GitHub</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a><a class="VPSocialLink no-icon" href="https://gitee.com/Charles7c/charles7c" aria-label target="_blank" rel="noopener" data-v-0ed08415 data-v-c77ec717><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>码云</title><path d="M11.984 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.016 0zm6.09 5.333c.328 0 .593.266.592.593v1.482a.594.594 0 0 1-.593.592H9.777c-.982 0-1.778.796-1.778 1.778v5.63c0 .327.266.592.593.592h5.63c.982 0 1.778-.796 1.778-1.778v-.296a.593.593 0 0 0-.592-.593h-4.15a.592.592 0 0 1-.592-.592v-1.482a.593.593 0 0 1 .593-.592h6.815c.327 0 .593.265.593.592v3.408a4 4 0 0 1-4 4H5.926a.593.593 0 0 1-.593-.593V9.778a4.444 4.444 0 0 1 4.445-4.444h8.296Z"/></svg></a><!--]--></div><div class="VPFlyout VPNavBarExtra extra" data-v-0ec8604f data-v-b9614353 data-v-8e60bb69><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-8e60bb69><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="icon" data-v-8e60bb69><circle cx="12" cy="12" r="2"></circle><circle cx="19" cy="12" r="2"></circle><circle cx="5" cy="12" r="2"></circle></svg></button><div class="menu" data-v-8e60bb69><div class="VPMenu" data-v-8e60bb69 data-v-32b6ed9e><!----><!--[--><!--[--><!----><div class="group" data-v-b9614353><div class="item appearance" data-v-b9614353><p class="label" data-v-b9614353>切换日光/暗黑模式</p><div class="appearance-action" data-v-b9614353><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title="Switch to dark theme" aria-checked="false" data-v-b9614353 data-v-a55d2cd3 data-v-43317611><span class="check" data-v-43317611><span class="icon" data-v-43317611><!--[--><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="sun" data-v-a55d2cd3><path d="M12,18c-3.3,0-6-2.7-6-6s2.7-6,6-6s6,2.7,6,6S15.3,18,12,18zM12,8c-2.2,0-4,1.8-4,4c0,2.2,1.8,4,4,4c2.2,0,4-1.8,4-4C16,9.8,14.2,8,12,8z"></path><path d="M12,4c-0.6,0-1-0.4-1-1V1c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,3.6,12.6,4,12,4z"></path><path d="M12,24c-0.6,0-1-0.4-1-1v-2c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,23.6,12.6,24,12,24z"></path><path d="M5.6,6.6c-0.3,0-0.5-0.1-0.7-0.3L3.5,4.9c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C6.2,6.5,5.9,6.6,5.6,6.6z"></path><path d="M19.8,20.8c-0.3,0-0.5-0.1-0.7-0.3l-1.4-1.4c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C20.3,20.7,20,20.8,19.8,20.8z"></path><path d="M3,13H1c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S3.6,13,3,13z"></path><path d="M23,13h-2c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S23.6,13,23,13z"></path><path d="M4.2,20.8c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C4.7,20.7,4.5,20.8,4.2,20.8z"></path><path d="M18.4,6.6c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C18.9,6.5,18.6,6.6,18.4,6.6z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="moon" data-v-a55d2cd3><path d="M12.1,22c-0.3,0-0.6,0-0.9,0c-5.5-0.5-9.5-5.4-9-10.9c0.4-4.8,4.2-8.6,9-9c0.4,0,0.8,0.2,1,0.5c0.2,0.3,0.2,0.8-0.1,1.1c-2,2.7-1.4,6.4,1.3,8.4c2.1,1.6,5,1.6,7.1,0c0.3-0.2,0.7-0.3,1.1-0.1c0.3,0.2,0.5,0.6,0.5,1c-0.2,2.7-1.5,5.1-3.6,6.8C16.6,21.2,14.4,22,12.1,22zM9.3,4.4c-2.9,1-5,3.6-5.2,6.8c-0.4,4.4,2.8,8.3,7.2,8.7c2.1,0.2,4.2-0.4,5.8-1.8c1.1-0.9,1.9-2.1,2.4-3.4c-2.5,0.9-5.3,0.5-7.5-1.1C9.2,11.4,8.1,7.7,9.3,4.4z"></path></svg><!--]--></span></span></button></div></div></div><div class="group" data-v-b9614353><div class="item social-links" data-v-b9614353><div class="VPSocialLinks social-links-list" data-v-b9614353 data-v-0ed08415><!--[--><a class="VPSocialLink no-icon" href="https://github.com/Charles7c/charles7c.github.io" aria-label="github" target="_blank" rel="noopener" data-v-0ed08415 data-v-c77ec717><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>GitHub</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a><a class="VPSocialLink no-icon" href="https://gitee.com/Charles7c/charles7c" aria-label target="_blank" rel="noopener" data-v-0ed08415 data-v-c77ec717><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>码云</title><path d="M11.984 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.016 0zm6.09 5.333c.328 0 .593.266.592.593v1.482a.594.594 0 0 1-.593.592H9.777c-.982 0-1.778.796-1.778 1.778v5.63c0 .327.266.592.593.592h5.63c.982 0 1.778-.796 1.778-1.778v-.296a.593.593 0 0 0-.592-.593h-4.15a.592.592 0 0 1-.592-.592v-1.482a.593.593 0 0 1 .593-.592h6.815c.327 0 .593.265.593.592v3.408a4 4 0 0 1-4 4H5.926a.593.593 0 0 1-.593-.593V9.778a4.444 4.444 0 0 1 4.445-4.444h8.296Z"/></svg></a><!--]--></div></div></div><!--]--><!--]--></div></div></div><!--[--><!--]--><button type="button" class="VPNavBarHamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="VPNavScreen" data-v-0ec8604f data-v-a6fa7f77><span class="container" data-v-a6fa7f77><span class="top" data-v-a6fa7f77></span><span class="middle" data-v-a6fa7f77></span><span class="bottom" data-v-a6fa7f77></span></span></button></div></div></div></div><div class="divider" data-v-0ec8604f><div class="divider-line" data-v-0ec8604f></div></div></div><!----></header><div class="VPLocalNav has-sidebar empty" data-v-83d41759 data-v-f4225638><div class="container" data-v-f4225638><button class="menu" aria-expanded="false" aria-controls="VPSidebarNav" data-v-f4225638><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="menu-icon" data-v-f4225638><path d="M17,11H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h14c0.6,0,1,0.4,1,1S17.6,11,17,11z"></path><path d="M21,7H3C2.4,7,2,6.6,2,6s0.4-1,1-1h18c0.6,0,1,0.4,1,1S21.6,7,21,7z"></path><path d="M21,15H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h18c0.6,0,1,0.4,1,1S21.6,15,21,15z"></path><path d="M17,19H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h14c0.6,0,1,0.4,1,1S17.6,19,17,19z"></path></svg><span class="menu-text" data-v-f4225638>文章</span></button><div class="VPLocalNavOutlineDropdown" style="--vp-vh:0px;" data-v-f4225638 data-v-560fa4a6><button data-v-560fa4a6>返回顶部</button><!----></div></div></div><aside class="VPSidebar" data-v-83d41759 data-v-93fad516><div class="curtain" data-v-93fad516></div><nav class="nav" id="VPSidebarNav" aria-labelledby="sidebar-aria-label" tabindex="-1" data-v-93fad516><span class="visually-hidden" id="sidebar-aria-label" data-v-93fad516> Sidebar Navigation </span><!--[--><!--]--><!--[--><div class="group" data-v-93fad516><section class="VPSidebarItem level-0 collapsible has-active" data-v-93fad516 data-v-d1e013f8><div class="item" role="button" tabindex="0" data-v-d1e013f8><div class="indicator" data-v-d1e013f8></div><h2 class="text" data-v-d1e013f8>天机学堂</h2><div class="caret" role="button" aria-label="toggle section" tabindex="0" data-v-d1e013f8><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="caret-icon" data-v-d1e013f8><path d="M9,19c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l5.3-5.3L8.3,6.7c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l6,6c0.4,0.4,0.4,1,0,1.4l-6,6C9.5,18.9,9.3,19,9,19z"></path></svg></div></div><div class="items" data-v-d1e013f8><!--[--><section class="VPSidebarItem level-1 is-link" data-v-d1e013f8 data-v-d1e013f8><div class="item" tabindex="0" data-v-d1e013f8><div class="indicator" data-v-d1e013f8></div><a class="VPLink link link" href="/cswiki/src/project/college/01-%E5%88%9D%E8%AF%86%E9%A1%B9%E7%9B%AE" data-v-d1e013f8><!--[--><h3 class="text" data-v-d1e013f8>01-初识项目</h3><!--]--></a><!----></div><div class="items" data-v-d1e013f8><!--[--><div class="VPSidebarItem level-2 is-link" data-v-d1e013f8 data-v-d1e013f8><div class="item" data-v-d1e013f8><div class="indicator" data-v-d1e013f8></div><a class="VPLink link link" href="/cswiki/src/project/college/00-%E8%99%9A%E6%8B%9F%E6%9C%BA%E5%AF%BC%E5%85%A5" data-v-d1e013f8><!--[--><p class="text" data-v-d1e013f8>虚拟机导入</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-2 is-link" data-v-d1e013f8 data-v-d1e013f8><div class="item" data-v-d1e013f8><div class="indicator" data-v-d1e013f8></div><a class="VPLink link link" href="/cswiki/src/project/college/00-%E8%87%AA%E5%AE%9A%E4%B9%89%E9%83%A8%E7%BD%B2" data-v-d1e013f8><!--[--><p class="text" data-v-d1e013f8>自定义部署</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-2 is-link" data-v-d1e013f8 data-v-d1e013f8><div class="item" data-v-d1e013f8><div class="indicator" data-v-d1e013f8></div><a class="VPLink link link" href="/cswiki/src/project/college/00-%E5%86%85%E7%BD%91%E7%A9%BF%E9%80%8F" data-v-d1e013f8><!--[--><p class="text" data-v-d1e013f8>内网穿透</p><!--]--></a><!----></div><!----></div><!--]--></div></section><div class="VPSidebarItem level-1 is-link" data-v-d1e013f8 data-v-d1e013f8><div class="item" data-v-d1e013f8><div class="indicator" data-v-d1e013f8></div><a class="VPLink link link" href="/cswiki/src/project/college/02-%E6%88%91%E7%9A%84%E8%AF%BE%E8%A1%A8" data-v-d1e013f8><!--[--><p class="text" data-v-d1e013f8>02-我的课表</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-d1e013f8 data-v-d1e013f8><div class="item" data-v-d1e013f8><div class="indicator" data-v-d1e013f8></div><a class="VPLink link link" href="/cswiki/src/project/college/03-%E5%AD%A6%E4%B9%A0%E8%AE%A1%E5%88%92" data-v-d1e013f8><!--[--><p class="text" data-v-d1e013f8>03-学习计划</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-d1e013f8 data-v-d1e013f8><div class="item" data-v-d1e013f8><div class="indicator" data-v-d1e013f8></div><a class="VPLink link link" href="/cswiki/src/project/college/04-%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95" data-v-d1e013f8><!--[--><p class="text" data-v-d1e013f8>04-学习记录</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-d1e013f8 data-v-d1e013f8><div class="item" data-v-d1e013f8><div class="indicator" data-v-d1e013f8></div><a class="VPLink link link" href="/cswiki/src/project/college/05-%E9%97%AE%E7%AD%94%E7%B3%BB%E7%BB%9F" data-v-d1e013f8><!--[--><p class="text" data-v-d1e013f8>05-问答系统</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-d1e013f8 data-v-d1e013f8><div class="item" data-v-d1e013f8><div class="indicator" data-v-d1e013f8></div><a class="VPLink link link" href="/cswiki/src/project/college/06-%E7%82%B9%E8%B5%9E%E7%B3%BB%E7%BB%9F" data-v-d1e013f8><!--[--><p class="text" data-v-d1e013f8>06-点赞系统</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-d1e013f8 data-v-d1e013f8><div class="item" data-v-d1e013f8><div class="indicator" data-v-d1e013f8></div><a class="VPLink link link" href="/cswiki/src/project/college/07-%E7%A7%AF%E5%88%86%E7%B3%BB%E7%BB%9F" data-v-d1e013f8><!--[--><p class="text" data-v-d1e013f8>07-积分系统</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-d1e013f8 data-v-d1e013f8><div class="item" data-v-d1e013f8><div class="indicator" data-v-d1e013f8></div><a class="VPLink link link" href="/cswiki/src/project/college/08-%E6%8E%92%E8%A1%8C%E6%A6%9C%E5%8A%9F%E8%83%BD" data-v-d1e013f8><!--[--><p class="text" data-v-d1e013f8>08-排行榜功能</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-d1e013f8 data-v-d1e013f8><div class="item" data-v-d1e013f8><div class="indicator" data-v-d1e013f8></div><a class="VPLink link link" href="/cswiki/src/project/college/09-%E4%BC%98%E6%83%A0%E5%88%B8%E7%AE%A1%E7%90%86" data-v-d1e013f8><!--[--><p class="text" data-v-d1e013f8>09-优惠券管理</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-d1e013f8 data-v-d1e013f8><div class="item" data-v-d1e013f8><div class="indicator" data-v-d1e013f8></div><a class="VPLink link link" href="/cswiki/src/project/college/10-%E9%A2%86%E5%8F%96%E4%BC%98%E6%83%A0%E5%88%B8" data-v-d1e013f8><!--[--><p class="text" data-v-d1e013f8>10-领取优惠券</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-d1e013f8 data-v-d1e013f8><div class="item" data-v-d1e013f8><div class="indicator" data-v-d1e013f8></div><a class="VPLink link link" href="/cswiki/src/project/college/11-%E4%BC%98%E6%83%A0%E5%88%B8%E4%BC%98%E5%8C%96" data-v-d1e013f8><!--[--><p class="text" data-v-d1e013f8>11-优惠券优化</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-d1e013f8 data-v-d1e013f8><div class="item" data-v-d1e013f8><div class="indicator" data-v-d1e013f8></div><a class="VPLink link link" href="/cswiki/src/project/college/12-%E4%BC%98%E6%83%A0%E5%88%B8%E4%BD%BF%E7%94%A8" data-v-d1e013f8><!--[--><p class="text" data-v-d1e013f8>12-优惠券使用</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-d1e013f8 data-v-d1e013f8><div class="item" data-v-d1e013f8><div class="indicator" data-v-d1e013f8></div><a class="VPLink link link" href="/cswiki/src/project/college/13-%E9%A1%B9%E7%9B%AE%E9%83%A8%E7%BD%B2" data-v-d1e013f8><!--[--><p class="text" data-v-d1e013f8>13-项目部署</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-d1e013f8 data-v-d1e013f8><div class="item" data-v-d1e013f8><div class="indicator" data-v-d1e013f8></div><a class="VPLink link link" href="/cswiki/src/project/college/13-%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98" data-v-d1e013f8><!--[--><p class="text" data-v-d1e013f8>14-项目实战</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><!--]--><!--[--><!--]--></nav></aside><div class="VPContent has-sidebar" id="VPContent" data-v-83d41759 data-v-7f2b530e><div class="VPDoc has-sidebar has-aside" data-v-7f2b530e data-v-7b451c74><!--[--><!--]--><div class="container" data-v-7b451c74><div class="aside" data-v-7b451c74><div class="aside-curtain" data-v-7b451c74></div><div class="aside-container" data-v-7b451c74><div class="aside-content" data-v-7b451c74><div class="VPDocAside" data-v-7b451c74 data-v-ae5a1c99><!--[--><!--]--><!--[--><!--]--><div class="VPDocAsideOutline" role="navigation" data-v-ae5a1c99 data-v-34b44e06><div class="content" data-v-34b44e06><div class="outline-marker" data-v-34b44e06></div><div class="outline-title" role="heading" aria-level="2" data-v-34b44e06>章节导航</div><nav aria-labelledby="doc-outline-aria-label" data-v-34b44e06><span class="visually-hidden" id="doc-outline-aria-label" data-v-34b44e06> Table of Contents for current page </span><ul class="VPDocOutlineItem root" data-v-34b44e06 data-v-ff6ff475><!--[--><!--]--></ul></nav></div></div><!--[--><!--]--><div class="spacer" data-v-ae5a1c99></div><!--[--><!--]--><!----><!--[--><!--]--><!--[--><!--]--></div></div></div></div><div class="content" data-v-7b451c74><div class="content-container" data-v-7b451c74><!--[--><!--]--><main class="main" data-v-7b451c74><div style="position:relative;" class="vp-doc _cswiki_src_project_college_08-%E6%8E%92%E8%A1%8C%E6%A6%9C%E5%8A%9F%E8%83%BD" data-v-7b451c74><div><h1 id="day08-排行榜功能" tabindex="-1">Day08-排行榜功能 <a class="header-anchor" href="#day08-排行榜功能" aria-label="Permalink to &quot;Day08-排行榜功能&quot;">​</a></h1><!----><p>在昨天的学习中，我们实现了积分功能，并且也将用户的积分明细保存到了数据库。但是并没有形成排行榜。</p><p>那么排行榜该如何实现呢？</p><p>是不是简单的SQL查询就可以形成榜单呢？</p><p>今天我们就一起来分析一下。</p><h2 id="实时排行榜" tabindex="-1">实时排行榜 <a class="header-anchor" href="#实时排行榜" aria-label="Permalink to &quot;实时排行榜&quot;">​</a></h2><p>榜单分为两类：</p><ul><li>实时榜单：也就是本赛季的榜单</li><li>历史榜单：也就是历史赛季的榜单</li></ul><p>本节我们先分析一下实现实时榜单功能。</p><p>💡思考：</p><h3 id="思路分析" tabindex="-1">思路分析 <a class="header-anchor" href="#思路分析" aria-label="Permalink to &quot;思路分析&quot;">​</a></h3><p>目前，我们有一个积分记录明细表，结构如下：</p><p><img src="/cswiki/assets/20230725154301601.0lvXwtcy.jpg" alt="img" loading="lazy"></p><p>一个用户可能产生很多条积分记录，数据结构大概像这样：</p><table><thead><tr><th style="text-align:center;"><strong>id</strong></th><th style="text-align:center;"><strong>userId</strong></th><th style="text-align:center;"><strong>type</strong></th><th style="text-align:center;"><strong>points</strong></th><th style="text-align:center;"><strong>c_time</strong></th></tr></thead><tbody><tr><td style="text-align:center;">1</td><td style="text-align:center;">9527</td><td style="text-align:center;">1</td><td style="text-align:center;">10</td><td style="text-align:center;"></td></tr><tr><td style="text-align:center;">2</td><td style="text-align:center;">9528</td><td style="text-align:center;">4</td><td style="text-align:center;">3</td><td style="text-align:center;"></td></tr><tr><td style="text-align:center;">3</td><td style="text-align:center;">9529</td><td style="text-align:center;">2</td><td style="text-align:center;">1</td><td style="text-align:center;"></td></tr><tr><td style="text-align:center;">4</td><td style="text-align:center;">9528</td><td style="text-align:center;">2</td><td style="text-align:center;">7</td><td style="text-align:center;"></td></tr><tr><td style="text-align:center;">5</td><td style="text-align:center;">9529</td><td style="text-align:center;">4</td><td style="text-align:center;">3</td><td style="text-align:center;"></td></tr><tr><td style="text-align:center;">6</td><td style="text-align:center;">9528</td><td style="text-align:center;">2</td><td style="text-align:center;">1</td><td style="text-align:center;"></td></tr><tr><td style="text-align:center;">7</td><td style="text-align:center;">9527</td><td style="text-align:center;">1</td><td style="text-align:center;">10</td><td style="text-align:center;"></td></tr><tr><td style="text-align:center;">8</td><td style="text-align:center;">9529</td><td style="text-align:center;">4</td><td style="text-align:center;">3</td><td style="text-align:center;"></td></tr><tr><td style="text-align:center;">9</td><td style="text-align:center;">9527</td><td style="text-align:center;">3</td><td style="text-align:center;">5</td><td style="text-align:center;"></td></tr></tbody></table><p>要想形成排行榜，我们在查询数据库时，需要先对用户分组，再对积分求和，最终按照积分和排序，Sql语句是这样：</p><div class="language-SQL vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">SQL</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SELECT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> user_id, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">SUM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(points) </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> points_record </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">GROUP BY</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> user_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ORDER BY</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> SUM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(points)</span></span></code></pre></div><p>要知道，每个用户都可能会有数十甚至上百条积分记录，当用户规模达到百万规模，可能产生的积分记录就是数以<strong>亿</strong>计。</p><p>要在每次查询排行榜时，在内存中对这么多数据做分组、求和、排序，对内存和CPU的占用会非常恐怖，不太靠谱。</p><p>那该怎么办呢？</p><br><p>在这里给大家介绍两种不同的实现思路：</p><ul><li>方案一：基于MySQL的离线排序</li><li>方案二：基于Redis的SortedSet</li></ul><br><p>首先说方案一：简单来说，就是将数据库中的数据查询出来，在内存中自己利用算法实现排序，而后将排序得到的榜单保存到数据库中。但由于这个排序比较复杂，我们无法实时更新排行榜，而是每隔几分钟计算一次排行榜。这种方案实现起来比较复杂，而且实时性较差。不过优点是不会一直占用系统资源。</p><br><p>再说方案二：Redis的SortedSet底层采用了跳表的数据结构，因此可以非常高效的实现排序功能，百万用户排序轻松搞定。而且每当用户积分发生变更时，我们可以实时更新Redis中的用户积分，而SortedSet也会实时更新排名。实现起来简单、高效，实时性也非常好。缺点就是需要一直占用Redis的内存，当用户量达到数千万万时，性能有一定的下降。</p><p>当系统用户量规模达到数千万，乃至数亿时，我们可以采用分治的思想，将用户数据按照积分范围划分为多个桶，例如：</p><p>0 ~ 100分、101 ~ 200分、201 ~ 300分、301 ~ 500分、501 ~ 800分、801 ~ 1200分、1201 ~ 1500分、1501 ~ 2000分</p><p>在Redis内为每个桶创建一个SortedSet类型的key，这样就可以将数据分散，减少单个KEY的数据规模了。而要计算排名时，只需要按照范围查询出用户积分所在的桶，再累加分值比他高的桶的用户数量即可。依然非常简单、高效。</p><br><p>综上，我们推荐基于Redis的SortedSet来实现排行榜功能。</p><p>SortedSet的常用命令，可以参考官网：<a href="https://redis.io/commands/?group=sorted-set" target="_blank" rel="noreferrer">https://redis.io/commands/?group=sorted-set</a></p><br><h3 id="生成实时榜单" tabindex="-1">生成实时榜单 <a class="header-anchor" href="#生成实时榜单" aria-label="Permalink to &quot;生成实时榜单&quot;">​</a></h3><p>既然要使用Redis的SortedSet来实现排行榜，就需要在<strong>用户每次积分变更时，累加积分到Redis的SortedSet中</strong>。因此，我们要对之前的新增积分功能做简单改造，如图中绿色部分：</p><p><img src="/cswiki/assets/image-20240214023218815.AeNdROzB.png" alt="image-20240214023218815" loading="lazy"></p><p>在Redis中，使用SortedSet结构，<strong>以赛季的日期为key，以用户id为member，以积分和为score. 每当用户新增积分，就累加到score中</strong>，SortedSet排名就会实时更新。这样一个实时的当前赛季榜单就出现了。</p><br><h4 id="定义redis的key前缀" tabindex="-1">定义Redis的KEY前缀 <a class="header-anchor" href="#定义redis的key前缀" aria-label="Permalink to &quot;定义Redis的KEY前缀&quot;">​</a></h4><p>在<code>tj-learning</code>的<code>RedisConstants</code>中定义一个新的KEY前缀：</p><p><img src="/cswiki/assets/20230725154303923.cdpfztR_.jpg" alt="img" loading="lazy"></p><p>注意，KEY的后缀是时间戳，我们最好定义一个<code>DateTimeFormatter</code>，方便后期使用。因此，我们需要修改<code>tj-commom</code>中的<code>DateUtils</code>，添加一个<code>DateTimeFormatter</code>的常量：</p><p><img src="/cswiki/assets/20230725154302494.kBPc6PFf.jpg" alt="img" loading="lazy"></p><br><h4 id="更新积分到redis" tabindex="-1">更新积分到Redis <a class="header-anchor" href="#更新积分到redis" aria-label="Permalink to &quot;更新积分到Redis&quot;">​</a></h4><p>接下来，我们改造tj-learning中的<code>com.tianji.learning.service.impl.PointsRecordServiceImpl</code>，首先注入<code>StringRedisTemplate</code>：</p><p><img src="/cswiki/assets/20230725154301670.zTDLL0m3.jpg" alt="img" loading="lazy"></p><br><p>然后，改造其中的<code>addPointsRecord</code>方法，添加积分到Redis中：</p><div class="language-Java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">Java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Override</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> addPointsRecord</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(Long userId, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> points, PointsRecordType type) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    LocalDateTime now </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> LocalDateTime.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">now</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> maxPoints </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> type.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getMaxPoints</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 1.判断当前方式有没有积分上限</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> realPoints </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> points;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(maxPoints </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 2.有，则需要判断是否超过上限</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        LocalDateTime begin </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> DateUtils.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getDayStartTime</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(now);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        LocalDateTime end </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> DateUtils.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getDayEndTime</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(now);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 2.1.查询今日已得积分</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> currentPoints </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> queryUserPointsByTypeAndDate</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(userId, type, begin, end);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 2.2.判断是否超过上限</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(currentPoints </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> maxPoints) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">            // 2.3.超过，直接结束</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 2.4.没超过，保存积分记录</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(currentPoints </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> points </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> maxPoints){</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            realPoints </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> maxPoints </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> currentPoints;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 3.没有，直接保存积分记录</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    PointsRecord p </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> PointsRecord</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    p.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setPoints</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(realPoints);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    p.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setUserId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(userId);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    p.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setType</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(type);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    save</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(p);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 4.更新总积分到Redis</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    String key </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> RedisConstants.POINTS_BOARD_KEY_PREFIX </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> now.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">format</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(DateUtils.POINTS_BOARD_SUFFIX_FORMATTER);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    redisTemplate.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">opsForZSet</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">incrementScore</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(key, userId.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">toString</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(), realPoints);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><br><h3 id="查询积分榜" tabindex="-1">查询积分榜 <a class="header-anchor" href="#查询积分榜" aria-label="Permalink to &quot;查询积分榜&quot;">​</a></h3><p>在个人中心，学生可以查看指定赛季积分排行榜（只显示前100 ），还可以查看自己总积分和排名。而且排行榜分为本赛季榜单和历史赛季榜单。</p><p>我们可以在一个接口中同时实现这两类榜单的查询。</p><br><h4 id="分析和设计接口" tabindex="-1">分析和设计接口 <a class="header-anchor" href="#分析和设计接口" aria-label="Permalink to &quot;分析和设计接口&quot;">​</a></h4><p>首先，我们来看一下页面原型（这里我给出的是原型对应的设计稿，也就是最终前端设计的页面效果）：</p><p><img src="/cswiki/assets/20230725154302362.LVMGzid6.jpg" alt="img" loading="lazy"></p><p>首先我们分析一下请求参数：</p><ul><li>榜单数据非常多，不可能一次性查询出来，因此这里一定是分页查询（滚动分页），需要分页参数。</li><li>由于要查询历史榜单需要知道赛季，因此参数中需要指定赛季id。当赛季id为空，我们认定是查询当前赛季。这样就可以把两个接口合二为一。</li></ul><p>然后是返回值，无论是历史榜单还是当前榜单，结构都一样。分为两部分：</p><ul><li>当前用户的积分和排名。当前用户不一定上榜，因此需要单独查询</li><li>榜单数据。就是N个用户的积分、排名形成的集合。</li></ul><br><p>综上，接口信息如下：</p><p><img src="/cswiki/assets/image-20240214023326783.HgD40nZA.png" alt="image-20240214023326783" loading="lazy"><br></p><h4 id="实体类" tabindex="-1">实体类 <a class="header-anchor" href="#实体类" aria-label="Permalink to &quot;实体类&quot;">​</a></h4><p>查询积分排行榜接口中包括3个实体：</p><ul><li>查询条件QUERY实体</li><li>分页返回结果VO实体</li><li>分页中每一条数据的VO实体</li></ul><p>这些在课前资料中都提供好了。</p><p>首先是QUERY实体：</p><p><img src="/cswiki/assets/20230725154301894.rU-1igMs.jpg" alt="img" loading="lazy"></p><p>然后是分页VO实体、分页条目VO实体：</p><p><img src="/cswiki/assets/20230725154301753.wrTmAA_Q.jpg" alt="img" loading="lazy"></p><br><h4 id="实现接口" tabindex="-1">实现接口 <a class="header-anchor" href="#实现接口" aria-label="Permalink to &quot;实现接口&quot;">​</a></h4><p>首先，在<code>tj-learning</code>的<code>com.tianji.learning.controller.PointsBoardController</code>中定义接口：</p><div class="language-Java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">Java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">package</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.tianji.learning.controller;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.tianji.common.utils.BeanUtils;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.tianji.common.utils.CollUtils;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.tianji.learning.domain.po.PointsBoardSeason;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.tianji.learning.domain.query.PointsBoardQuery;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.tianji.learning.domain.vo.PointsBoardVO;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.tianji.learning.service.IPointsBoardService;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> io.swagger.annotations.Api;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> io.swagger.annotations.ApiOperation;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> lombok.RequiredArgsConstructor;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> org.springframework.web.bind.annotation.GetMapping;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> org.springframework.web.bind.annotation.RequestMapping;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> org.springframework.web.bind.annotation.RestController;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> java.time.LocalDateTime;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> java.util.List;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">/**</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> * &lt;p&gt;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> * 学霸天梯榜 控制器</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> * &lt;/p&gt;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> */</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">RestController</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">RequiredArgsConstructor</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">RequestMapping</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;/boards&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Api</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">tags</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;积分相关接口&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> PointsBoardController</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    private</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> final</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> IPointsBoardService pointsBoardService;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">GetMapping</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ApiOperation</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;分页查询指定赛季的积分排行榜&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> PointsBoardVO </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">queryPointsBoardBySeason</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(PointsBoardQuery </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">query</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">){</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> pointsBoardService.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">queryPointsBoardBySeason</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(query);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><br><p>然后，在<code>com.tianji.learning.service.IPointsBoardService</code>中定义service方法：</p><div class="language-Java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">Java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">package</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.tianji.learning.service;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.baomidou.mybatisplus.extension.service.IService;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.tianji.learning.domain.po.PointsBoard;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.tianji.learning.domain.query.PointsBoardQuery;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.tianji.learning.domain.vo.PointsBoardVO;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> java.util.List;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">/**</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> * &lt;p&gt;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> * 学霸天梯榜 服务类</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> * &lt;/p&gt;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> interface</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> IPointsBoardService</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> extends</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> IService</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">PointsBoard</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    PointsBoardVO </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">queryPointsBoardBySeason</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(PointsBoardQuery </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">query</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><br><p>然后，在<code>com.tianji.learning.service.impl.PointsBoardServiceImpl</code>中实现方法：</p><div class="language-Java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">Java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">package</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.tianji.learning.service.impl;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.baomidou.mybatisplus.extension.plugins.pagination.Page;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.tianji.api.client.user.UserClient;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.tianji.api.dto.user.UserDTO;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.tianji.common.utils.CollUtils;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.tianji.common.utils.DateUtils;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.tianji.common.utils.UserContext;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.tianji.learning.constants.RedisConstants;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.tianji.learning.domain.po.PointsBoard;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.tianji.learning.domain.query.PointsBoardQuery;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.tianji.learning.domain.vo.PointsBoardItemVO;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.tianji.learning.domain.vo.PointsBoardVO;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.tianji.learning.mapper.PointsBoardMapper;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.tianji.learning.service.IPointsBoardService;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.tianji.learning.utils.TableInfoContext;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> lombok.RequiredArgsConstructor;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> org.springframework.data.redis.core.BoundZSetOperations;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> org.springframework.data.redis.core.StringRedisTemplate;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> org.springframework.data.redis.core.ZSetOperations;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> org.springframework.stereotype.Service;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> java.time.LocalDateTime;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> java.util.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> java.util.stream.Collectors;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> static</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.tianji.learning.constants.LearningConstants.POINTS_BOARD_TABLE_PREFIX;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">/**</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> * &lt;p&gt;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> * 学霸天梯榜 服务实现类</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> * &lt;/p&gt;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> *</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> * </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">@author</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> 虎哥</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> */</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Service</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">RequiredArgsConstructor</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> PointsBoardServiceImpl</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> extends</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ServiceImpl</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">PointsBoardMapper</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">PointsBoard</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">implements</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> IPointsBoardService</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    private</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> final</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> StringRedisTemplate redisTemplate;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    private</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> final</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> UserClient userClient;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Override</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> PointsBoardVO </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">queryPointsBoardBySeason</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(PointsBoardQuery </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">query</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 1.判断是否是查询当前赛季</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        Long season </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> query.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getSeason</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        boolean</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> isCurrent </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> season </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> null</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ||</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> season </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 2.获取Redis的Key</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        LocalDateTime now </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> LocalDateTime.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">now</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        String key </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> RedisConstants.POINTS_BOARD_KEY_PREFIX </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> now.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">format</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(DateUtils.POINTS_BOARD_SUFFIX_FORMATTER);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 2.查询我的积分和排名</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        PointsBoard myBoard </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> isCurrent </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">                queryMyCurrentBoard</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(key) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 查询当前榜单（Redis）</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">                queryMyHistoryBoard</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(season); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 查询历史榜单（MySQL）</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 3.查询榜单列表</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        List&lt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">PointsBoard</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; list </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> isCurrent </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">                queryCurrentBoardList</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(key, query.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getPageNo</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(), query.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getPageSize</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">                queryHistoryBoardList</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(query);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 4.封装VO</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        PointsBoardVO vo </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> PointsBoardVO</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 4.1.处理我的信息</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (myBoard </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            vo.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setPoints</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(myBoard.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getPoints</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">());</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            vo.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setRank</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(myBoard.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getRank</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">());</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (CollUtils.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">isEmpty</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(list)) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> vo;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 4.2.查询用户信息</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        Set&lt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Long</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; uIds </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> list.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">stream</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">map</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(PointsBoard</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">getUserId).</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">collect</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(Collectors.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">toSet</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">());</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        List&lt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">UserDTO</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; users </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> userClient.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">queryUserByIds</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(uIds);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        Map&lt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Long</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">String</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; userMap </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> HashMap&lt;&gt;(uIds.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">size</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">());</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(CollUtils.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">isNotEmpty</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(users)) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            userMap </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> users.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">stream</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">collect</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(Collectors.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">toMap</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(UserDTO</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">getId, UserDTO</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">getName));</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 4.3.转换VO</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        List&lt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">PointsBoardItemVO</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; items </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ArrayList&lt;&gt;(list.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">size</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">());</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (PointsBoard p </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> list) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            PointsBoardItemVO v </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> PointsBoardItemVO</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            v.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setPoints</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(p.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getPoints</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">());</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            v.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setRank</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(p.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getRank</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">());</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            v.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setName</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(userMap.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(p.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getUserId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()));</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            items.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">add</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(v);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        vo.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setBoardList</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(items);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> vo;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    private</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> List&lt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">PointsBoard</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">queryHistoryBoardList</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(PointsBoardQuery </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">query</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // TODO</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> List&lt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">PointsBoard</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">queryCurrentBoardList</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(String </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">key</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, Integer </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">pageNo</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, Integer </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">pageSize</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 1.计算分页</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> from </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (pageNo </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> pageSize;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 2.查询</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        Set&lt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ZSetOperations</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">TypedTuple</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">String</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;&gt; tuples </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> redisTemplate.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">opsForZSet</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">reverseRangeWithScores</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(key, from, from </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> pageSize </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (CollUtils.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">isEmpty</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(tuples)) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> CollUtils.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">emptyList</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 3.封装</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> rank </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> from </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        List&lt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">PointsBoard</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; list </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ArrayList&lt;&gt;(tuples.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">size</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">());</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (ZSetOperations.TypedTuple&lt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">String</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; tuple </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tuples) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            String userId </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tuple.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getValue</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            Double points </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tuple.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getScore</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (userId </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> null</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ||</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> points </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">                continue</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            PointsBoard p </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> PointsBoard</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            p.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setUserId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(Long.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">valueOf</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(userId));</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            p.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setPoints</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(points.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">intValue</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">());</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            p.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setRank</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(rank</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">++</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            list.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">add</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(p);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> list;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    private</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> PointsBoard </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">queryMyHistoryBoard</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(Long </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">season</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // TODO</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    private</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> PointsBoard </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">queryMyCurrentBoard</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(String </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">key</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 1.绑定key</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        BoundZSetOperations&lt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">String</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">String</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; ops </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> redisTemplate.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">boundZSetOps</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(key);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 2.获取当前用户信息</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        String userId </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> UserContext.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getUser</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">toString</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 3.查询积分</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        Double points </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ops.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">score</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(userId);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 4.查询排名</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        Long rank </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ops.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">reverseRank</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(userId);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 5.封装返回</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        PointsBoard p </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> PointsBoard</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        p.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setPoints</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(points </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> null</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ?</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> :</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> points.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">intValue</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">());</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        p.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setRank</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(rank </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> null</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ?</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> :</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> rank.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">intValue</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> p;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h2 id="历史排行榜" tabindex="-1">历史排行榜 <a class="header-anchor" href="#历史排行榜" aria-label="Permalink to &quot;历史排行榜&quot;">​</a></h2><p>在天机学堂项目中，积分排行榜是分赛季的，每一个月是一个赛季。因此每到每个月的月初，就会进入一个新的赛季。所有用户的积分应该清零，重新累积。</p><p>但是，我们能把Redis中的榜单数据直接清空吗？显然不行！Redis中的榜单数据是上个月的数据，属于历史榜单了，直接清空就丢失了一个赛季的数据。</p><p>因此，我们必须将Redis中的历史数据持久化到数据库中，然后再清零。如图：</p><p><img src="/cswiki/assets/image-20240214023844466.-27NCE5_.png" alt="image-20240214023844466" loading="lazy"></p><p>不过，这里就有一个问题需要解决：</p><p>假如有数百万用户，这就意味着每个赛季榜单都有数百万数据。随着时间推移，历史赛季越来越多，如果全部保存到一张表中，数据量会非常恐怖！</p><p>该怎么办呢？</p><br><h3 id="海量数据存储策略" tabindex="-1">海量数据存储策略 <a class="header-anchor" href="#海量数据存储策略" aria-label="Permalink to &quot;海量数据存储策略&quot;">​</a></h3><p>对于数据库的海量数据存储，方案有很多，常见的有：</p><p><img src="/cswiki/assets/20230725154302135.XB-I-eNG.jpg" alt="img" loading="lazy"></p><br><h4 id="分区" tabindex="-1">分区 <a class="header-anchor" href="#分区" aria-label="Permalink to &quot;分区&quot;">​</a></h4><p>表分区（Partition）是一种数据存储方案，可以解决单表数据较多的问题。MySQL5.1开始支持表分区功能。</p><br><p>数据库的表最终肯定是保存在磁盘中，对于InoDB引擎，一张表的数据在磁盘上对应一个ibd文件。如图，我们的积分榜单表对应的文件：</p><p><img src="/cswiki/assets/20230725154302438.d2Iq0NcV.jpg" alt="img" loading="lazy"></p><br><p>如果表数据过多，就会导致文件体积非常大。文件就会跨越多个磁盘分区，数据检索时的速度就会非常慢。</p><br><p>为了解决这个问题，MySQL在5.1版本引入表分区功能。简单来说，就是按照某种规则，把表数据对应的ibd文件拆分成多个文件来存储。从物理上来看，一张表的数据被拆到多个表文件存储了；从逻辑上来看，他们对外表现是一张表。</p><p>例如，我们的历史榜单数据，可以按照赛季切分：</p><p><img src="/cswiki/assets/20230725154302350.H4vMq40b.jpg" alt="img" loading="lazy"></p><p>此时，赛季榜单表的磁盘文件就被分成了两个文件。但逻辑上还是一张表。增删改查的方式不会有什么变化，只不过底层MySQL底层的处理上会有变更。例如检索时可以只检索某个文件，而不是全部。</p><br><p>这样做有几个好处：</p><ul><li>可以存储更多的数据，突破单表上限。甚至可以存储到不同磁盘，突破磁盘上限</li><li>查询时可以根据规则只检索某一个文件，提高查询效率</li><li>数据统计时，可以多文件并行统计，最后汇总结果，提高统计效率</li><li>对于一些历史数据，如果不需要时，可以直接删除分区文件，提高删除效率</li></ul><br><p>表分区的本质是对数据的<strong>水平拆分</strong>，而拆分的方式也有多种，常见的有：</p><ul><li>Range分区：按照指定字段的取值范围分区</li><li>List分区：按照指定字段的枚举值分区，必须提前指定好所有的分区值，如果数据找不到分区会报错</li><li>Hash分区：基于字段做hash运算后分区，一般做hash运算的字段都是数值类型</li><li>Key分区：根据指定字段的值做运算的结果分区，与hash分区类似，但不限定字段类型</li></ul><br><p>对于赛季榜单来说，最合适的分区方式是基于赛季值分区，我们希望同一个赛季放到一个分区。这就只能使用List分区，而List分区却需要枚举出所有可能的分区值。但是赛季分区id是无限的，无法全部枚举，所以就非常尴尬。</p><br><p>MySQL的表分区详细信息可参考下面的文档：</p><p><a href="https://www.cnblogs.com/wenxuehai/p/15901779.html" target="_blank" rel="noreferrer">https://www.cnblogs.com/wenxuehai/p/15901779.html</a></p><br><h4 id="分表" tabindex="-1">分表 <a class="header-anchor" href="#分表" aria-label="Permalink to &quot;分表&quot;">​</a></h4><p><strong>分表</strong>是一种表设计方案，由开发者在创建表时按照自己的业务需求拆分表。也就是说这是开发者自己对表的处理，与数据库无关。</p><br><p>而且，一旦做了分表，无论是逻辑上，还是物理上，就从一张表变成了多张表！增删改查的方式就发生了变化，必须自己考虑要去哪张表做数据处理。</p><p>分区则在逻辑上是同一张表，增删改查与以前没有区别。这就是分区和分表最大的一种区别。</p><br><p><strong>水平分表</strong></p><p>例如，对于赛季榜单，我们可以按照赛季拆分为多张表，<strong>每一个赛季一张新的表</strong>。如图：</p><p><img src="/cswiki/assets/20230725154302639.5vlH4mlG.jpg" alt="img" loading="lazy"></p><p>这种方式就是水平分表，<strong>表结构不变</strong>，仅仅是每张表<strong>数据不同</strong>。查询赛季1，就找第一张表。查询赛季2，就找第二张表。</p><p>由于分表是开发者的行为，因此拆分方式更加灵活。除了水平分表，也可以做<strong>垂直分表</strong>。</p><br><p><strong>垂直分表</strong></p><p>什么是垂直分表呢？</p><p>如果一张表的字段非常多，比如达到30个以上，这样的表我们称为<strong>宽表</strong>。宽表由于字段太多，单行数据体积就会非常大，虽然数据不多，但可能表体积也会非常大！从而影响查询效率。</p><p>例如一个用户信息表，除了用户基本信息，还包含很多其它功能信息：</p><p><img src="/cswiki/assets/20230725154302631.xy4QcbF-.jpg" alt="img" loading="lazy"></p><p>这个时候，我们就可以把其中的一些不常用字段拆分出去。一张表中包含登录常用字段，另一张表包含其它字段：</p><p><img src="/cswiki/assets/20230725154302982.5Dq2emJd.jpg" alt="img" loading="lazy"></p><p>这个时候一张表就变成了两张表。而且两张表的<strong>结构不同</strong>，<strong>数据也不同</strong>。这种按照字段拆分表的方式，称为<strong>垂直拆分</strong>。</p><br><p><strong>优缺点</strong></p><p>分表方案与分区方案相比有一些优点：</p><ul><li>拆分方式更加灵活</li><li>而且可以解决单表字段过多的问题</li></ul><p>但是也有一些确定：</p><ul><li>增删改查时，需要自己判断访问哪张表</li><li>垂直拆分还会导致事务问题及数据关联问题：原本一张表的操作，变为多张表操作。</li></ul><br><p>不过，在开发中我们很多情况下业务需求复杂，更看重分表的灵活性。因此，我们大多数情况下都会选择分表方案。</p><br><h4 id="分库和集群" tabindex="-1">分库和集群 <a class="header-anchor" href="#分库和集群" aria-label="Permalink to &quot;分库和集群&quot;">​</a></h4><p>无论是分区，还是分表，我们刚才的分析都是建立在单个数据库的基础上。但是单个数据库也存在一些问题：</p><ul><li>单点故障问题：数据库发生故障，整个系统就会瘫痪</li><li>单库的性能瓶颈问题：单库受服务器限制，其网络带宽、CPU、连接数都有瓶颈</li><li>单库的存储瓶颈问题：单库的磁盘空间有上限，如果磁盘过大，数据检索的速度又会变慢</li></ul><br><p>综上，在大型系统中，我们除了要做分表、还需要对数据做分库，建立综合集群。</p><br><p>首先，在微服务项目中，我们会按照项目模块，每个微服务使用独立的数据库，因此每个库的表是不同的，这种分库模式成为<strong>垂直分库</strong>。</p><p>而为了保证单节点的高可用性，我们会给数据库建立主从集群，主节点向从节点同步数据。两者结构一样，可以看做是<strong>水平扩展</strong>。</p><br><p>这个时候就会出现垂直分库、水平扩展的综合集群，如图：</p><p><img src="/cswiki/assets/20230725154303860.rnW5hOq1.jpg" alt="img" loading="lazy"></p><br><p>这种模式的优缺点：</p><p>优点：</p><ul><li>解决了海量数据存储问题，突破了单机存储瓶颈</li><li>提高了并发能力，突破了单机性能瓶颈</li><li>避免了单点故障</li></ul><p>缺点：</p><ul><li>成本非常高</li><li>数据聚合统计比较麻烦</li><li>主从同步的一致性问题</li><li>分布式事务问题</li></ul><br><h3 id="历史榜单的存储策略" tabindex="-1">历史榜单的存储策略 <a class="header-anchor" href="#历史榜单的存储策略" aria-label="Permalink to &quot;历史榜单的存储策略&quot;">​</a></h3><p>天机学堂项目是一个教育类项目，用户规模并不会很高，一般在十多万到百万级别。因此最终的数据规模也并不会非常庞大。</p><p>综合之前的分析，结合天机学堂的项目情况，我们可以对榜单数据做分表，但是暂时不需要做分库和集群。</p><br><p>由于我们要解决的是数据过多问题，因此分表的方式选择<strong>水平分表</strong>。具体来说，就是按照赛季拆分，每一个赛季是一个独立的表，如图：</p><p><img src="/cswiki/assets/20230725154303021.GQMa79P0.jpg" alt="img" loading="lazy"></p><p>不过这里我们可以做一些简化：</p><ul><li>我们可以将id采用自增id，那么id就是排名，排名字段就不需要了。</li><li>不同赛季用不同表，那么赛季字段就不需要了。</li></ul><p>综上，最终表结构可以是这样：</p><p><img src="/cswiki/assets/20230725154302911.-p5essp8.jpg" alt="img" loading="lazy"></p><p>不过这就存在一个问题，每个赛季要有不同的表，这些表什么时候创建呢？</p><br><p>显然，应该在每个赛季刚开始的时候（月初）来创建新的赛季榜单表。每个月的月初执行一个创建表的任务，我们可以利用定时任务来实现。</p><p>由于表的名称中包含赛季id，因此在定时任务中我们还要先查询赛季信息，获取赛季id，拼接得到表名，最后创建表。</p><br><p>大概流程如图：</p><p><img src="/cswiki/assets/20230725154303194.8lk14MEx.jpg" alt="img" loading="lazy"></p><br><p>表结构如下：</p><div class="language-SQL vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">SQL</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> CREATE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> TABLE</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> IF</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> NOT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> EXISTS</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> `points_board_X`</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    `id`</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      BIGINT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> NOT NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> AUTO_INCREMENT COMMENT </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;榜单id&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    `user_id`</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> BIGINT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> NOT NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> COMMENT </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;学生id&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    `points`</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  INT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    NOT NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> COMMENT </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;积分值&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    PRIMARY KEY</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">`id`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">USING</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> BTREE,</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    INDEX</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> `idx_user_id`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">`user_id`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">USING</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> BTREE</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> )</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    COMMENT </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;学霸天梯榜&#39;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    COLLATE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;utf8mb4_0900_ai_ci&#39;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ENGINE </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> InnoDB</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ROW_FORMAT </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> DYNAMIC</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ;</span></span></code></pre></div><br><p>表名称的前缀是<code>points_board_</code>，我们应该将其定义为常量。在<code>tj-learning</code>模块中定义：</p><p><img src="/cswiki/assets/20230725154304334.KlEIMYRI.jpg" alt="img" loading="lazy"></p><br><p>同时，表中的字段少了2个（rank、season），因此我们需要修改对应的实体类：</p><p><img src="/cswiki/assets/20230725154304413.HsNrSWMS.jpg" alt="img" loading="lazy"></p><br><h3 id="定时任务生成榜单表" tabindex="-1">定时任务生成榜单表 <a class="header-anchor" href="#定时任务生成榜单表" aria-label="Permalink to &quot;定时任务生成榜单表&quot;">​</a></h3><p>接下来，我们通过SpringTask定义一个定时任务，在每月初动态生成赛季榜单表。</p><br><h4 id="定时任务" tabindex="-1">定时任务 <a class="header-anchor" href="#定时任务" aria-label="Permalink to &quot;定时任务&quot;">​</a></h4><p>首先，在<code>tj-learning</code>模块下定义一个任务处理类：</p><p><img src="/cswiki/assets/20230725154303561.cvqvAjsH.jpg" alt="img" loading="lazy"></p><p>代码如下：</p><div class="language-Java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">Java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">package</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.tianji.learning.handler;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.tianji.common.utils.CollUtils;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.tianji.common.utils.DateUtils;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.tianji.learning.service.IPointsBoardSeasonService;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.tianji.learning.service.IPointsBoardService;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> lombok.RequiredArgsConstructor;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> org.springframework.stereotype.Component;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> java.time.LocalDateTime;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> java.util.List;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> static</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.tianji.learning.constants.LearningConstants.POINTS_BOARD_TABLE_PREFIX;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Component</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">RequiredArgsConstructor</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> PointsBoardPersistentHandler</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    private</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> final</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> IPointsBoardSeasonService seasonService;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    private</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> final</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> IPointsBoardService pointsBoardService;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Scheduled</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">cron</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;0 0 3 1 * ?&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 每月1号，凌晨3点执行</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> createPointsBoardTableOfLastSeason</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(){</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 1.获取上月时间</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        LocalDateTime time </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> LocalDateTime.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">now</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">minusMonths</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 2.查询赛季id</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        Integer season </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> seasonService.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">querySeasonByTime</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(time);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (season </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">            // 赛季不存在</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 3.创建表</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        pointsBoardService.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">createPointsBoardTableBySeason</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(season);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>这里调用了两个service的方法，一个是查询赛季，一个是创建表。</p><br><h4 id="查询赛季id" tabindex="-1">查询赛季id <a class="header-anchor" href="#查询赛季id" aria-label="Permalink to &quot;查询赛季id&quot;">​</a></h4><p>首先，我们在<code>tj-learning</code>模块的<code>com.tianji.learning.service.IPointsBoardSeasonService</code>中定义查询赛季的方法：</p><div class="language-Java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">Java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">package</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.tianji.learning.service;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.baomidou.mybatisplus.extension.service.IService;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.tianji.learning.domain.po.PointsBoardSeason;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> java.time.LocalDateTime;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">/**</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> * &lt;p&gt;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> *  服务类</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> * &lt;/p&gt;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> interface</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> IPointsBoardSeasonService</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> extends</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> IService</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">PointsBoardSeason</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; {</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    Integer </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">querySeasonByTime</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(LocalDateTime </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">time</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><br><p>然后在<code>com.tianji.learning.service.impl.PointsBoardSeasonServiceImpl</code>中实现该方法：</p><div class="language-Java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">Java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">package</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.tianji.learning.service.impl;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.tianji.learning.domain.po.PointsBoardSeason;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.tianji.learning.mapper.PointsBoardSeasonMapper;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.tianji.learning.service.IPointsBoardSeasonService;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> org.springframework.stereotype.Service;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> java.time.LocalDateTime;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> java.util.Optional;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">/**</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> * &lt;p&gt;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> *  服务实现类</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> * &lt;/p&gt;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> */</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Service</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> PointsBoardSeasonServiceImpl</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> extends</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ServiceImpl</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">PointsBoardSeasonMapper</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">PointsBoardSeason</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">implements</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> IPointsBoardSeasonService</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Override</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Integer </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">querySeasonByTime</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(LocalDateTime </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">time</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        Optional&lt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">PointsBoardSeason</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; optional </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> lambdaQuery</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">le</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(PointsBoardSeason</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">getBeginTime, time)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ge</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(PointsBoardSeason</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">getEndTime, time)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">oneOpt</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> optional.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">map</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(PointsBoardSeason</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">getId).</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">orElse</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><br><h4 id="创建表" tabindex="-1">创建表 <a class="header-anchor" href="#创建表" aria-label="Permalink to &quot;创建表&quot;">​</a></h4><p>在<code>tj-learning</code>模块的<code>com.tianji.learning.service.IPointsBoardService</code>中定义创建表的方法：</p><div class="language-Java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">Java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">package</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.tianji.learning.service;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.baomidou.mybatisplus.extension.service.IService;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.tianji.learning.domain.po.PointsBoard;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.tianji.learning.domain.query.PointsBoardQuery;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.tianji.learning.domain.vo.PointsBoardVO;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> java.util.List;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">/**</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> * &lt;p&gt;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> * 学霸天梯榜 服务类</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> * &lt;/p&gt;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> interface</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> IPointsBoardService</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> extends</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> IService</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">PointsBoard</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    PointsBoardVO </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">queryPointsBoardBySeason</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(PointsBoardQuery </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">query</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> createPointsBoardTableBySeason</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(Integer </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">season</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><br><p>然后在<code>com.tianji.learning.service.impl.PointsBoardServiceImpl</code>中实现该方法：</p><div class="language-Java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">Java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Override</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> createPointsBoardTableBySeason</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(Integer season) {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    getBaseMapper</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">createPointsBoardTable</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(POINTS_BOARD_TABLE_PREFIX </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> season);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><br><p>这里的建表语句肯定是自定义SQL，需要现在在<code>com.tianji.learning.mapper.PointsBoardMapper</code>中定义出方法：</p><div class="language-Java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">Java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">package</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.tianji.learning.mapper;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.baomidou.mybatisplus.core.mapper.BaseMapper;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.tianji.learning.domain.po.PointsBoard;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> org.apache.ibatis.annotations.Param;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">/**</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> * &lt;p&gt;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> * 学霸天梯榜 Mapper 接口</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> * &lt;/p&gt;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> interface</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> PointsBoardMapper</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> extends</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> BaseMapper</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">PointsBoard</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; {</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> createPointsBoardTable</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Param</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;tableName&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) String </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">tableName</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><br><p>然后在<code>tj-learning</code>模块的<code>src/resources/mapper/PointsBoardMapper.xml</code>中编写SQL：</p><div class="language-XML vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">XML</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;?</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">xml</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> version</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;1.0&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> encoding</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;UTF-8&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">?&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;!</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">DOCTYPE</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> mapper</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot; &quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">mapper</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> namespace</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;com.tianji.learning.mapper.PointsBoardMapper&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">insert</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;createPointsBoardTable&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> parameterType</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;java.lang.String&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        CREATE TABLE `${tableName}`</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        (</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            `id`      BIGINT NOT NULL AUTO_INCREMENT COMMENT &#39;榜单id&#39;,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            `user_id` BIGINT NOT NULL COMMENT &#39;学生id&#39;,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            `points`  INT    NOT NULL COMMENT &#39;积分值&#39;,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            PRIMARY KEY (`id`) USING BTREE,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            INDEX `idx_user_id` (`user_id`) USING BTREE</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        )</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            COMMENT =&#39;学霸天梯榜&#39;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            COLLATE = &#39;utf8mb4_0900_ai_ci&#39;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            ENGINE = InnoDB</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            ROW_FORMAT = DYNAMIC</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    &lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">insert</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">mapper</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span></code></pre></div><br><h3 id="分布式任务调度" tabindex="-1">分布式任务调度 <a class="header-anchor" href="#分布式任务调度" aria-label="Permalink to &quot;分布式任务调度&quot;">​</a></h3><p>目前，我们的定时任务都是基于SpringTask来实现的。但是SpringTask存在一些问题：</p><ul><li>当微服务多实例部署时，定时任务会被执行多次。而事实上我们只需要这个任务被执行一次即可。</li><li>我们除了要定时创建表，还要定时持久化Redis数据到数据库，我们希望这多个定时任务能够按照顺序依次执行，SpringTask无法控制任务顺序</li></ul><br><p>不仅仅是SpringTask，其它单机使用的定时任务工具，都无法实现像这种任务执行者的调度、任务执行顺序的编排、任务监控等功能。这些功能必须要用到分布式任务调度组件。</p><br><h4 id="分布式任务调度原理" tabindex="-1">分布式任务调度原理 <a class="header-anchor" href="#分布式任务调度原理" aria-label="Permalink to &quot;分布式任务调度原理&quot;">​</a></h4><p>那么分布式任务调度是如何实现任务调度和编排的呢？</p><p>我们先来看看普通定时任务的实现原理，一般定时任务中会有两个组件：</p><ul><li>任务：要执行的代码</li><li>任务触发器：基于定义好的规则触发任务</li></ul><br><p>因此在多实例部署的时候，每个启动的服务实例都会有自己的<strong>任务触发器</strong>，这样就会导致各个实例各自运行，无法统一控制：</p><p><img src="/cswiki/assets/20230725154304079.xcj89xim.jpg" alt="img" loading="lazy"></p><p>那如果我们想要统一控制各个服务实例的任务执行和调度该怎么办？</p><br><p>大家应该能想到：就是要把任务触发器提取到各个服务实例之外，去做统一的触发、统一的调度。</p><p>事实上，大多数的分布式任务调度组件都是这样做的：</p><p><img src="/cswiki/assets/20230725141106785.vwt6Hv6K.jpg" alt="img" loading="lazy"></p><br><p>这样一来，具体哪个任务该执行，什么时候执行，交给哪个应用实例来执行，全部都有统一的任务调度服务来统一控制。并且执行过程中的任务结果还可以通过回调接口返回，让我们方便的查看任务执行状态、执行日志。这样的服务就是<strong>分布式调度服务</strong>了。</p><br><h4 id="分布式任务调度技术对比" tabindex="-1">分布式任务调度技术对比 <a class="header-anchor" href="#分布式任务调度技术对比" aria-label="Permalink to &quot;分布式任务调度技术对比&quot;">​</a></h4><p>能够实现分布式任务调度的技术有很多，常见的有：</p><table><thead><tr><th style="text-align:center;"></th><th style="text-align:center;"><strong>Quartz</strong></th><th style="text-align:center;"><strong>XXL-Job</strong></th><th style="text-align:center;"><strong>SchedulerX</strong></th><th style="text-align:center;"><strong>PowerJob</strong></th></tr></thead><tbody><tr><td style="text-align:center;"><strong>定时类型</strong></td><td style="text-align:center;">CRON</td><td style="text-align:center;">频率、间隔、CRON</td><td style="text-align:center;">频率、间隔、CRON、OpenAPI</td><td style="text-align:center;">频率、间隔、CRON、OpenAPI</td></tr><tr><td style="text-align:center;"><strong>任务类型</strong></td><td style="text-align:center;">Java</td><td style="text-align:center;">多语言脚本</td><td style="text-align:center;">多语言脚本</td><td style="text-align:center;">多语言脚本</td></tr><tr><td style="text-align:center;"><strong>任务调度方式</strong></td><td style="text-align:center;">随机</td><td style="text-align:center;">单机、分片</td><td style="text-align:center;">单机、广播、Map、MapReduce</td><td style="text-align:center;">单机、广播、分片、Map、MapReduce</td></tr><tr><td style="text-align:center;"><strong>管理控制台</strong></td><td style="text-align:center;">无</td><td style="text-align:center;">支持</td><td style="text-align:center;">支持</td><td style="text-align:center;">支持</td></tr><tr><td style="text-align:center;"><strong>日志白屏</strong></td><td style="text-align:center;">无</td><td style="text-align:center;">支持</td><td style="text-align:center;">支持</td><td style="text-align:center;">支持</td></tr><tr><td style="text-align:center;"><strong>报警监控</strong></td><td style="text-align:center;">无</td><td style="text-align:center;">支持</td><td style="text-align:center;">支持</td><td style="text-align:center;">支持</td></tr><tr><td style="text-align:center;"><strong>工作流</strong></td><td style="text-align:center;">无</td><td style="text-align:center;">有限</td><td style="text-align:center;">支持</td><td style="text-align:center;">支持</td></tr></tbody></table><p>其中：</p><ul><li>Quartz由于功能相对比较落后，现在已经很少被使用了。</li><li>SchedulerX是阿里巴巴的云产品，收费。</li><li>PowerJob是阿里员工自己开源的一个组件，功能非常强大，不过目前市值占比还不高，还需要等待市场检验。</li><li>XXL-JOB：开源免费，功能虽然不如PowerJob，不过目前市场占比最高，稳定性有保证。</li></ul><br><p>我们课堂中会选择XXL-JOB这个组件，如果你们企业具备探索精神，而且需要一些分布式运算功能，推荐使用PowerJob。</p><br><h4 id="xxl-job介绍" tabindex="-1">XXL-JOB介绍 <a class="header-anchor" href="#xxl-job介绍" aria-label="Permalink to &quot;XXL-JOB介绍&quot;">​</a></h4><p>官网地址：<a href="https://www.xuxueli.com/xxl-job/" target="_blank" rel="noreferrer">https://www.xuxueli.com/xxl-job/</a></p><p>XXL-JOB的运行原理和架构如图：</p><p><img src="/cswiki/assets/20230725154304200.w_IinTqg.jpg" alt="img" loading="lazy"></p><p>XXL-JOB分为两部分：</p><ul><li><strong>执行器</strong>：我们的服务引入一个XXL-JOB的依赖，就可以通过配置创建一个执行器。负责与XXL-JOB调度中心交互，执行本地任务。</li><li><strong>调度中心</strong>：一个独立服务，负责管理执行器、管理任务、任务执行的调度、任务结果和日志收集。</li></ul><br><h4 id="xxl-job定时创建榜单表" tabindex="-1">XXL-JOB定时创建榜单表 <a class="header-anchor" href="#xxl-job定时创建榜单表" aria-label="Permalink to &quot;XXL-JOB定时创建榜单表&quot;">​</a></h4><p>接下来，我们就来一个XXL-JOB的快速入门，顺便改造一下之前用SpringTask实现的定时创建榜单表的功能。</p><!----><p><strong>部署调度中心</strong></p><p>调度中心在我们提供的虚拟机开发环境中已经部署完成了。访问：<a href="http://xxljob.tianji.com/" target="_blank" rel="noreferrer">http://xxljob.tianji.com</a>即可查看调度中心控制台页面。默认的账号密码是：admin/123456</p><p><img src="/cswiki/assets/20230725154304337.MT5xfUNy.jpg" alt="img" loading="lazy"></p><p>如果要自己部署，分为两步：</p><ul><li>运行初始化SQL，创建数据库表</li><li>利用Docker命令，创建并运行容器</li></ul><p>课前资料已经给出了脚本：</p><br><p>Docker启动命令</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">docker</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> run </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">-e </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">PARAMS=&quot;--spring.datasource.url=jdbc:mysql://192.168.150.101:3306/xxl_job?Unicode=true&amp;characterEncoding=UTF-8 </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">--spring.datasource.username=root </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">--spring.datasource.password=123&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">--restart=always </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">-p </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">28080</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">:8080 </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">-v </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">xxl-job-admin-applogs:/data/applogs </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">--name </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">xxl-job-admin </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">-d </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">xuxueli/xxl-job-admin:2.3.0</span></span></code></pre></div><p><img src="/cswiki/assets/20230725141106785.vwt6Hv6K.jpg" alt="img" loading="lazy"></p><p>最终XXL-JOB的表结构如下：</p><p><img src="/cswiki/assets/20230725154304734.ZrNMBUFO.jpg" alt="img" loading="lazy"></p><p>说明：</p><ul><li>xxl_job_lock：任务调度锁表；</li><li>xxl_job_group：执行器信息表，维护任务执行器信息；</li><li>xxl_job_info：调度扩展信息表： 用于保存XXL-JOB调度任务的扩展信息，如任务分组、任务名、机器地址、执行器、执行入参和报警邮件等等；</li><li>xxl_job_log：调度日志表： 用于保存XXL-JOB任务调度的历史信息，如调度结果、执行结果、调度入参、调度机器和执行器等等；</li><li>xxl_job_log_report：调度日志报表：用户存储XXL-JOB任务调度日志的报表，调度中心报表功能页面会用到；</li><li>xxl_job_logglue：任务GLUE日志：用于保存GLUE更新历史，用于支持GLUE的版本回溯功能；</li><li>xxl_job_registry：执行器注册表，维护在线的执行器和调度中心机器地址信息；</li><li>xxl_job_user：系统用户表；</li></ul><!----><p><strong>微服务集成执行器</strong></p><p>首先需要在tj-learning服务引入依赖：</p><div class="language-XML vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">XML</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">&lt;!--xxl-job--&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">dependency</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">groupId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;com.xuxueli&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">groupId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">artifactId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;xxl-job-core&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">artifactId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">dependency</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span></code></pre></div><p>然后还需要配置执行器，下面是一个配置执行器的示例：</p><div class="language-Java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">Java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Bean</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> XxlJobSpringExecutor </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">xxlJobExecutor</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    logger.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">info</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; xxl-job config init.&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    XxlJobSpringExecutor xxlJobSpringExecutor </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> XxlJobSpringExecutor</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    xxlJobSpringExecutor.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setAdminAddresses</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(adminAddresses);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    xxlJobSpringExecutor.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setAppname</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(appname);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    xxlJobSpringExecutor.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setIp</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(ip);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    xxlJobSpringExecutor.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setPort</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(port);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    xxlJobSpringExecutor.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setAccessToken</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(accessToken);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    xxlJobSpringExecutor.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setLogPath</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(logPath);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    xxlJobSpringExecutor.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setLogRetentionDays</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(logRetentionDays);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> xxlJobSpringExecutor;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>参数说明：</p><ul><li>adminAddress：调度中心地址，天机学堂中就是填虚拟机地址</li><li>appname：微服务名称</li><li>ip和port：当前执行器的ip和端口，无需配置，自动获取</li><li>accessToken：访问令牌，在调度中心中配置令牌，所有执行器访问时都必须携带该令牌，否则无法访问。咱们项目的令牌已经配好，就是<code>tianji</code>。如果要修改，可以到虚拟机的<code>/usr/local/src/xxl-job/application.properties</code>文件中，修改<code>xxl.job.accessToken</code>属性，然后重启XXL-JOB即可。</li><li>logPath：任务运行日志的保存目录</li><li>logRetentionDays：日志最长保留时长</li></ul><br><p>但是呢，大家完全不需要自己配置调度器了，因为在天机学堂的tj-common模块已经实现了XXL-JOB的自动装配：</p><p><img src="/cswiki/assets/20230725154304969._nDY4A2c.jpg" alt="img" loading="lazy"></p><p>配置中的关键属性都已经在Nacos中共享了：</p><p><img src="/cswiki/assets/20230725154304691.inyGz4HY.jpg" alt="img" loading="lazy"></p><br><p>所以，我们项目的微服务模块只要引入<code>了tj-common</code>，并且引入了XXL-JOB的依赖，就可以直接使用了。</p><div class="language-yml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yml</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">server</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  port</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">8090</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  #端口</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  tomcat</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    uri-encoding</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">UTF-8</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   #服务编码</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">spring</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  profiles</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    active</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">dev</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  application</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">learning-service</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  cloud</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    nacos</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      config</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">        file-extension</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">yaml</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">        shared-configs</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 共享配置</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">          - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">data-id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">shared-spring.yaml</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> # 共享spring配置</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">            refresh</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">false</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">          - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">data-id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">shared-redis.yaml</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> # 共享redis配置</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">            refresh</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">false</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">          - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">data-id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">shared-mybatis.yaml</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> # 共享mybatis配置</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">            refresh</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">false</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">          - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">data-id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">shared-logs.yaml</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> # 共享日志配置</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">            refresh</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">false</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">          - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">data-id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">shared-feign.yaml</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> # 共享feign配置</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">            refresh</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">false</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">          - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">data-id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">shared-mq.yaml</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> # 共享mq配置</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">            refresh</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">false</span></span>
<span class="line highlighted"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">          - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">data-id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">shared-xxljob.yaml</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> # 共享mq配置</span></span>
<span class="line highlighted"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">            refresh</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">false</span></span></code></pre></div><br><p><strong>定义任务</strong></p><p>接下来，把之前的SpringTask任务改成XXL-JOB的任务。</p><p>我们修改tj-learning模块下的<code>com.tianji.learning.handler.PointsBoardPersistentHandler</code>，将原本的<code>@Scheduled</code>注解替换为<code>@XXLJob</code>注解：</p><p><img src="/cswiki/assets/20230725154305607.lPq5CitD.jpg" alt="img" loading="lazy"></p><p>其中，<code>@XxlJob</code>注解中定义的就是当前<strong>任务的名称</strong>。</p><br><p>注册执行器</p><p>接下来，重启<code>tj-learning</code>服务，登录XXL-JOB控制台，注册执行器。</p><p><img src="/cswiki/assets/20230725154305471.6y8_I2ul.jpg" alt="img" loading="lazy"></p><p>在弹出的窗口中填写信息：</p><p><img src="/cswiki/assets/20230725154305685.6ZuxF1aL.jpg" alt="img" loading="lazy"></p><p>等待一段时间，会发现<code>learning-service</code>已经成功注册了：</p><p><img src="/cswiki/assets/20230725154305473.OMK1K_Pn.jpg" alt="img" loading="lazy"></p><br><p><strong>配置任务调度</strong></p><p>现在，执行器已经成功注册，任务也已经注册到调度中心。接下来，我们就可以来做任务调度了，也就是：</p><ul><li>分配任务什么时候执行</li><li>如果有多个执行器，应该由哪个执行器执行（路由策略）</li></ul><br><p>我们进入任务管理菜单，选中学习中心执行器，然后新增任务：</p><p><img src="/cswiki/assets/20230725154305606.JbAsnJMN.jpg" alt="img" loading="lazy"></p><br><p>在弹出表单中，填写任务调度信息：</p><p><img src="/cswiki/assets/20230725154305260.ACyJzjKu.jpg" alt="img" loading="lazy"></p><p>其中比较关键的几个配置：</p><ul><li><p>调度配置：也就是什么时候执行，一般选择cron表达式</p></li><li><p>任务配置：采用BEAN模式，指定JobHandler，这里指定的就是在项目中<code>@XxlJob</code>注解中的任务名称</p></li><li><p>路由策略：就是指如果有多个任务执行器，该由谁执行？这里支持的策略非常多：</p><p><img src="/cswiki/assets/20230725154305765.p5i6NRDM.jpg" alt="img" loading="lazy"></p></li></ul><br><p>路由策略说明：</p><ul><li>FIRST（第一个）：固定选择第一个执行器；</li><li>LAST（最后一个）：固定选择最后一个执行器；</li><li>ROUND（轮询）：在线的执行器按照轮询策略选择一个执行</li><li>RANDOM（随机）：随机选择在线的执行器；</li><li>CONSISTENT_HASH（一致性HASH）：每个任务按照Hash算法固定选择某一台执行器，且所有任务均匀散列在不同执行器上。</li><li>LEAST_FREQUENTLY_USED（最不经常使用）：使用频率最低的执行器优先被选举；</li><li>LEAST_RECENTLY_USED（最近最久未使用）：最久未使用的执行器优先被选举；</li><li>FAILOVER（故障转移）：按照顺序依次进行心跳检测，第一个心跳检测成功的执行器选定为目标执行器并发起调度；</li><li>BUSYOVER（忙碌转移）：按照顺序依次进行空闲检测，第一个空闲检测成功的执行器选定为目标执行器并发起调度；</li><li>SHARDING_BROADCAST(分片广播)：广播触发对应集群中所有执行器执行一次任务，同时系统自动传递分片参数；可根据分片参数开发分片任务</li></ul><!----><p><strong>执行一次</strong></p><p>当任务配置完成后，就会按照设置的调度策略，定期去执行了。不过，我们想要测试的话也可以手动执行一次任务。</p><p>在任务管理界面，点击要执行的任务后面的<code>操作</code>按钮，点击<code>执行一次</code>：</p><p><img src="/cswiki/assets/20230725154306809.UjlrmBWM.jpg" alt="img" loading="lazy"></p><p>然后在弹出的窗口中，直接点保存即可执行：</p><p><img src="/cswiki/assets/20230725154305821.3qos_K78.jpg" alt="img" loading="lazy"></p><p>注意，如果是分片广播模式， 这里还可以填写一些任务参数。</p><p>然后在调度日志中，可以看到执行成功的日志信息：</p><p><img src="/cswiki/assets/20230725154308184.qv3DX1QG.jpg" alt="img" loading="lazy"></p><br><h3 id="榜单持久化" tabindex="-1">榜单持久化 <a class="header-anchor" href="#榜单持久化" aria-label="Permalink to &quot;榜单持久化&quot;">​</a></h3><p>榜单持久化的基本流程是这样的：</p><ul><li>创建表</li><li>持久化Redis数据到数据库</li><li>清理Redis数据</li></ul><br><p>现在，创建表的动作已经完成，接下来就轮到Redis数据的持久化了。持久化的步骤如下：</p><ul><li>读取Redis数据</li><li>判断数据是否存在 <ul><li>不存在，直接结束</li><li>存在，则继续</li></ul></li><li>保存数据到数据库</li></ul><br><p>不过，Redis的数据结构如图：</p><p><img src="/cswiki/assets/20230725154305885.UDn511hg.jpg" alt="img" loading="lazy"></p><p>其KEY中包含一个上赛季对应的日期，因此要读取Redis数据，我们必须先得到上赛季的日期。</p><p>另外，我们采用了水平分表的策略，每一个赛季都是一个独立表。那么在写数据到数据库时，必须先知道表名称。</p><br><p>综上，最终持久化的业务流程如图：</p><p><img src="/cswiki/assets/image-20240214024255526.BkFP6dL3.png" alt="image-20240214024255526" loading="lazy"></p><br><h4 id="动态表名" tabindex="-1">动态表名 <a class="header-anchor" href="#动态表名" aria-label="Permalink to &quot;动态表名&quot;">​</a></h4><p>持久化的流程中存在一个问题，我们的数据库持久化采用的是MybatisPlus来实现的。而MybatisPlus读取表名的方式是通过实体类上的<code>@Table</code>注解，而注解往往是写死的：</p><p><img src="/cswiki/assets/20230725154306147.8W6jo60k.jpg" alt="img" loading="lazy"></p><p>那我们该如何让MybatisPlus在执行的时候改变数据写入的表名称呢？</p><br><p><strong>动态表名插件</strong></p><p>MybatisPlus中提供了一个动态表名的插件：</p><p><a href="https://baomidou.com/pages/2a45ff/#dynamictablenameinnerinterceptor" target="_blank" rel="noreferrer">https://baomidou.com/pages/2a45ff/#dynamictablenameinnerinterceptor</a></p><p>插件的部分源码如下：</p><p><img src="/cswiki/assets/20230725154308818.G0ic3zRT.jpg" alt="img" loading="lazy"></p><p>可见表名称动态获取就是依赖于tableNameHandlerMapping中的具体的TableNameHandler，这个Map如图：</p><p><img src="/cswiki/assets/20230725154306390.s5hrsq3g.jpg" alt="img" loading="lazy"></p><p>这个Map的key是旧的表名称，value是TableNameHandler，就是表的名称处理器，用于根据旧名称获取新名称。</p><br><p>TableNameHandler的源码如下：</p><div class="language-Java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">Java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> interface</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> TableNameHandler</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    /**</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">     * 生成动态表名</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">     *</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">     * </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">@param</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> sql</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">       当前执行 SQL</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">     * </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">@param</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> tableName</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> 表名</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">     * </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">@return</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> String</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">     */</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    String </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">dynamicTableName</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(String </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">sql</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, String </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">tableName</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>OK，因此我们要做的事情就很简单了，定义<code>DynamicTableNameInnterInterceptor</code>，向其中添加一个<code>TableNameHandler</code>，将<code>points_board</code>这个表名，替换为<code>points_board_赛季id</code>的名称。</p><br><p>不过，新的问题来了，这个插件中的TableNameHandler该如何获取赛季对应的表名称呢？</p><p>计算表名的方式是获取获取上赛季时间，查询数据库中上赛季信息，得到上赛季id。然后拼接得到表名。</p><br><p>当我们批量的写数据到数据库时，<strong>如果每次插入都计算一次表名，那性能也太差了</strong>。因此，我们肯定是希望一次计算，在TableNameHandler中可以随时获取。</p><p>那么该如何实现呢？</p><br><p><strong>传递表名</strong></p><p>我们先回顾一下整体业务流程：</p><p><img src="/cswiki/assets/image-20240214024407842.zRsYbiTF.png" alt="image-20240214024407842" loading="lazy"></p><p>流程中，我们会先计算表名，然后去执行持久化，而动态表名插件就会生效，去替换表名。</p><p>因此，一旦我们计算完表名，以某种方式传递给插件中的TableNameHandler，那么就无需重复计算表名了。</p><p>不过，问题来了：要知道动态表名称插件，以及TableNameHandler，都是由MybatisPlus内部调用的。我们无法传递参数。</p><p>那么该如何传递表名称呢？</p><br><p>虽然无法传参，但是从计算表名，到动态表名插件执行，调用TableNameHandler，都是在一个线程内完成的。要在一个线程内实现数据共享，该用什么呢？</p><p>大家应该很容易想到，就是ThreadLocal.</p><p>我们可以在定时任务中计算完动态表名后，将表名存入ThreadLocal，然后在插件中从ThreadLocal中读取即可：</p><p><img src="/cswiki/assets/image-20240214024424868.MVeSk6Tu.png" alt="image-20240214024424868" loading="lazy"></p><br><p>我们在<code>tj-learning</code>的<code>com.tianji.learning.utils</code>包下定义一个传递表名称的工具：</p><p><img src="/cswiki/assets/20230725154308109.60K16a_7.jpg" alt="img" loading="lazy"></p><p>具体代码如下：</p><div class="language-Java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">Java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">package</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.tianji.learning.utils;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> TableInfoContext</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    private</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> final</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ThreadLocal&lt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">String</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; TL </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ThreadLocal&lt;&gt;();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> setInfo</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(String </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">info</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        TL.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">set</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(info);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> static</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> String </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getInfo</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> TL.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> remove</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        TL.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">remove</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><br><p>然后在<code>tj-learning</code>模块下定义一个配置类，用于定义<code>DynamicTableNameInnterInterceptor</code>插件：</p><p><img src="/cswiki/assets/20230725154306323.iDdw6pBt.jpg" alt="img" loading="lazy"></p><p>具体代码如下：</p><div class="language-Java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">Java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">package</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.tianji.learning.config;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.baomidou.mybatisplus.extension.plugins.handler.TableNameHandler;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.baomidou.mybatisplus.extension.plugins.inner.DynamicTableNameInnerInterceptor;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.tianji.learning.utils.TableInfoContext;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> org.springframework.context.annotation.Bean;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> org.springframework.context.annotation.Configuration;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> java.util.HashMap;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> java.util.Map;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Configuration</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> MybatisConfiguration</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Bean</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> DynamicTableNameInnerInterceptor </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">dynamicTableNameInnerInterceptor</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 准备一个Map，用于存储TableNameHandler</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        Map&lt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">String</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">TableNameHandler</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; map </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> HashMap&lt;&gt;(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 存入一个TableNameHandler，用来替换points_board表名称</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 替换方式，就是从TableInfoContext中读取保存好的动态表名</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        map.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">put</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;points_board&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, (sql, tableName) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> TableInfoContext.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getInfo</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">());</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> DynamicTableNameInnerInterceptor</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(map);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><br><p>插件虽然定义好了，但是该如何继承到MybatisPlus中呢？</p><p>在天机学堂项目中的tj-common模块中，已经实现了MybatisPlus的自动装配，并且定义了很多的MP插件。如果我们在自己的项目中重新定义MP配置，就会导致tj-common中的插件失效。</p><br><p>所以，我们应该修改<code>tj-common</code>中的MP配置，将<code>DynamicTableNameInnerInterceptor</code>配置进去。找到<code>tj-common</code>模块下的<code>MybatisConfig</code>配置：</p><p><img src="/cswiki/assets/20230725154307757.ppZFEMw9.jpg" alt="img" loading="lazy"></p><p>修改其中的拦截器配置：</p><p><img src="/cswiki/assets/20230725154308002.abai4cSu.jpg" alt="img" loading="lazy"></p><p><strong>注意</strong>：</p><ul><li>由于<code>DynamicTableNameInnerInterceptor</code>并不是每一个微服务都用了，所以这里加入了@Autowired(required= false)，避免未定义该拦截器的微服务报错。</li><li>MybatisPlus的插件定义顺序非常重要，必须按照一定的顺序来定义。参考：<a href="https://baomidou.com/pages/2976a3/#innerinterceptor" target="_blank" rel="noreferrer">https://baomidou.com/pages/2976a3/#innerinterceptor</a></li></ul><br><h4 id="定时持久化任务" tabindex="-1">定时持久化任务 <a class="header-anchor" href="#定时持久化任务" aria-label="Permalink to &quot;定时持久化任务&quot;">​</a></h4><p>动态表名已经准备就绪，接下来我们就可以去定义定时任务，实现榜单持久化了。</p><p>在<code>tj-learning</code>模块的<code>com.tianji.learning.handler.PointsBoardPersistentHandler</code>中添加一个定时任务：</p><div class="language-Java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">Java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">XxlJob</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;savePointsBoard2DB&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> savePointsBoard2DB</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(){</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 1.获取上月时间</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    LocalDateTime time </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> LocalDateTime.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">now</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">minusMonths</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 2.计算动态表名</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 2.1.查询赛季信息</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    Integer season </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> seasonService.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">querySeasonByTime</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(time);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 2.2.将表名存入ThreadLocal</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    TableInfoContext.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setInfo</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(POINTS_BOARD_TABLE_PREFIX </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> season);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 3.查询榜单数据</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 3.1.拼接KEY</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    String key </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> RedisConstants.POINTS_BOARD_KEY_PREFIX </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> time.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">format</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(DateUtils.POINTS_BOARD_SUFFIX_FORMATTER);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 3.2.查询数据</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> pageNo </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> pageSize </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1000</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    while</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        List&lt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">PointsBoard</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; boardList </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> pointsBoardService.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">queryCurrentBoardList</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(key, pageNo, pageSize);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (CollUtils.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">isEmpty</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(boardList)) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            break</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 4.持久化到数据库</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 4.1.把排名信息写入id</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        boardList.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">forEach</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(b </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            b.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(b.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getRank</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">longValue</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">());</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            b.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setRank</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        });</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 4.2.持久化</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        pointsBoardService.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">saveBatch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(boardList);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 5.翻页</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        pageNo</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">++</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 任务结束，移除动态表名</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    TableInfoContext.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">remove</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><br><p>需要注意的，由于榜单数据非常多，不可能一次性查完，因此这里采用的是分页查询的方式。而分页查询调用的是<code>com.tianji.learning.service.IPointsBoardService</code>中的<code>queryCurrentBoardList</code>方法。这个方法在service实现类中本来就有，只不过没有抽取到service接口。</p><p>因此这里要在<code>com.tianji.learning.service.IPointsBoardService</code>中抽取这个接口：</p><div class="language-Java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">Java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">package</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.tianji.learning.service;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.baomidou.mybatisplus.extension.service.IService;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.tianji.learning.domain.po.PointsBoard;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.tianji.learning.domain.query.PointsBoardQuery;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.tianji.learning.domain.vo.PointsBoardVO;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> java.util.List;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">/**</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> * &lt;p&gt;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> * 学霸天梯榜 服务类</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> * &lt;/p&gt;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> interface</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> IPointsBoardService</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> extends</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> IService</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">PointsBoard</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    PointsBoardVO </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">queryPointsBoardBySeason</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(PointsBoardQuery </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">query</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> createPointsBoardTableBySeason</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(Integer </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">season</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    List&lt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">PointsBoard</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">queryCurrentBoardList</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(String </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">key</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, Integer </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">pageNo</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, Integer </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">pageSize</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><br><p>把<code>com.tianji.learning.service.impl.PointsBoardServiceImpl</code>中的方法改为public：</p><p><img src="/cswiki/assets/20230725154307410.7OftYvuC.jpg" alt="img" loading="lazy"></p><br><h4 id="xxl-job任务分片" tabindex="-1">XXL-JOB任务分片 <a class="header-anchor" href="#xxl-job任务分片" aria-label="Permalink to &quot;XXL-JOB任务分片&quot;">​</a></h4><p>刚才定义的定时持久化任务，通过while死循环，不停的查询数据，直到把所有数据都持久化为止。这样如果数据量达到数百万，交给一个任务执行器来处理会耗费非常多时间。</p><p>因此，将来肯定会将学习服务多实例部署，这样就会有多个执行器并行执行。**但是，**如果交给多个任务执行器，大家执行相同代码，都从第1页逐页处理数据，又会出现重复处理的情况。</p><p>怎么办？</p><p>这就要用到任务分片的方案了。</p><br><p>怎样才能确保任务不重复呢？我们可以参考扑克牌发牌的原理：</p><ul><li>逐一给每个人发牌</li><li>发完一圈后，再回头给第一个人发</li><li>重复上述动作，直到牌发完为止</li></ul><p><img src="/cswiki/assets/20230725154310238.FNApWVGl.jpg" alt="img" loading="lazy"></p><p>与此类似，比如我们启动了3个服务实例，就有3个执行器。我们可以把执行器当做打牌的人，然后把每一页数据作为一张牌：</p><ul><li>把每页数据逐一分发给每个执行器，</li><li>发完一圈后，再回到第一个执行器。</li><li>直到所有页数据都发放完毕。</li></ul><p>那么数据分发的过程如图：</p><p><img src="/cswiki/assets/20230725154311054.q-CGK1Z8.jpg" alt="img" loading="lazy"></p><p>最终，每个执行器处理的数据页情况：</p><ul><li>执行器1：处理第1、4、7、10、13、...页数据</li><li>执行器2：处理第2、5、8、11、14、...页数据</li><li>执行器3：处理第3、6、9、12、15、...页数据</li></ul><br><p>要想知道每一个执行器执行哪些页数据，只要弄清楚两个关键参数即可：</p><ul><li>起始页码：pageNo</li><li>下一页的跨度：step</li></ul><br><p>而这两个参数是有规律的：</p><ul><li>起始页码：执行器编号是多少，起始页码就是多少</li><li>页跨度：执行器有几个，跨度就是多少。也就是说你要跳过别人读取过的页码</li></ul><br><p>因此，现在的关键就是获取两个数据：</p><ul><li>执行器编号</li><li>执行器数量</li></ul><p>这两个参数XXL-JOB作为任务调度中心，肯定是知道的，而且也提供了API帮助我们获取：</p><p><img src="/cswiki/assets/20230725154308382.NaaNiVUY.jpg" alt="img" loading="lazy"></p><br><p>这里的分片序号其实就是执行器序号，不过是从0开始，那我们只要对序号+1，就可以作为起始页码了。</p><br><p>因此，最终我们改造代码，实现数据分片如图：</p><div class="language-Java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">Java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">XxlJob</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;savePointsBoard2DB&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> savePointsBoard2DB</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(){</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 1.获取上月时间</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    LocalDateTime time </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> LocalDateTime.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">now</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">minusMonths</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 2.计算动态表名</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 2.1.查询赛季信息</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    Integer season </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> seasonService.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">querySeasonByTime</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(time);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 2.2.存入ThreadLocal</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    TableInfoContext.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setInfo</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(POINTS_BOARD_TABLE_PREFIX </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> season);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 3.查询榜单数据</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 3.1.拼接KEY</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    String key </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> RedisConstants.POINTS_BOARD_KEY_PREFIX </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> time.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">format</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(DateUtils.POINTS_BOARD_SUFFIX_FORMATTER);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 3.2.查询数据</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> index </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> XxlJobHelper.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getShardIndex</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> total </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> XxlJobHelper.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getShardTotal</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> pageNo </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> index </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 起始页，就是分片序号+1</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> pageSize </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 10</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    while</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        List&lt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">PointsBoard</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; boardList </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> pointsBoardService.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">queryCurrentBoardList</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(key, pageNo, pageSize);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (CollUtils.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">isEmpty</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(boardList)) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            break</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 4.持久化到数据库</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 4.1.把排名信息写入id</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        boardList.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">forEach</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(b </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            b.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(b.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getRank</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">longValue</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">());</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            b.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setRank</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        });</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 4.2.持久化</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        pointsBoardService.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">saveBatch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(boardList);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 5.翻页，跳过N个页，N就是分片数量</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        pageNo</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">total;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    TableInfoContext.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">remove</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><br><h4 id="清理redis缓存任务" tabindex="-1">清理Redis缓存任务 <a class="header-anchor" href="#清理redis缓存任务" aria-label="Permalink to &quot;清理Redis缓存任务&quot;">​</a></h4><p>当任务持久化以后，我们还要清理Redis中的上赛季的榜单数据，避免过多的内存占用。</p><p>在<code>tj-learning</code>模块的<code>com.tianji.learning.handler.PointsBoardPersistentHandler</code>中添加一个定时任务：</p><div class="language-Java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">Java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">package</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.tianji.learning.handler;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.tianji.common.utils.CollUtils;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.tianji.common.utils.DateUtils;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.tianji.learning.constants.RedisConstants;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.tianji.learning.domain.po.PointsBoard;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.tianji.learning.service.IPointsBoardSeasonService;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.tianji.learning.service.IPointsBoardService;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.tianji.learning.utils.TableInfoContext;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.xxl.job.core.context.XxlJobHelper;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.xxl.job.core.handler.annotation.XxlJob;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> lombok.RequiredArgsConstructor;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> org.springframework.data.redis.core.StringRedisTemplate;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> org.springframework.stereotype.Component;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> java.time.LocalDateTime;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> java.util.List;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> static</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.tianji.learning.constants.LearningConstants.POINTS_BOARD_TABLE_PREFIX;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Component</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">RequiredArgsConstructor</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> PointsBoardPersistentHandler</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    private</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> final</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> IPointsBoardSeasonService seasonService;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    private</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> final</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> IPointsBoardService pointsBoardService;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    private</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> final</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> StringRedisTemplate redisTemplate;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // ... 略</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">XxlJob</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;clearPointsBoardFromRedis&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> clearPointsBoardFromRedis</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(){</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 1.获取上月时间</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        LocalDateTime time </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> LocalDateTime.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">now</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">minusMonths</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 2.计算key</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        String key </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> RedisConstants.POINTS_BOARD_KEY_PREFIX </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> time.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">format</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(DateUtils.POINTS_BOARD_SUFFIX_FORMATTER);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 3.删除</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        redisTemplate.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">unlink</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(key);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><br><h4 id="任务链" tabindex="-1">任务链 <a class="header-anchor" href="#任务链" aria-label="Permalink to &quot;任务链&quot;">​</a></h4><p>现在，所有任务都已经定义完毕。接下来就给配置任务调度了。</p><p>我们最终期望的任务执行顺序是这样的：</p><p><img src="/cswiki/assets/image-20240214024455682.CyCJnVTs.png" alt="image-20240214024455682" loading="lazy"></p><p>但问题来了，我们该如何控制三个任务的执行顺序呢？</p><p>这就要借助于XXL-JOB中的子任务功能了。</p><br><p>首先，我们把持久化榜单数据、清理Redis中历史榜单的任务也在XXL-JOB中定义出来。</p><p>首先是持久化榜单：</p><p><img src="/cswiki/assets/20230725154309412.rTR4oHSd.jpg" alt="img" loading="lazy"></p><br><p>然后是清理Redis的任务：</p><p><img src="/cswiki/assets/20230725154308512.G4nK79y9.jpg" alt="img" loading="lazy"></p><br><p>接下来，回到任务管理页面，会看到3个任务都添加成功，并且每个任务都有自己的ID：</p><p><img src="/cswiki/assets/20230725154309279.EGbXNArg.jpg" alt="img" loading="lazy"></p><p>要想让任务A、B依次执行，其实就是配置任务B作为任务A的子任务。因此，我们按照下面方式配置：</p><ul><li>创建历史榜单表（10）的子任务是持久化榜单数据任务（12）</li><li>持久化榜单数据任务（12）的子任务是清理Redis中的历史榜单（13）</li></ul><br><p>也就是说：10的子任务是12, 12的子任务是13</p><br><p>首先，点击创建历史绑定表后面的操作，然后编辑：</p><p><img src="/cswiki/assets/20230725154309486.XyXch3bP.jpg" alt="img" loading="lazy"></p><br><p>然后在子任务中，填写持久化榜单数据任务的id，本例中是12：</p><p><img src="/cswiki/assets/20230725154308821.BJRua4oM.jpg" alt="img" loading="lazy"></p><p>保存。</p><br><p>然后点击持久化榜单数据任务后面的操作，编辑：</p><p><img src="/cswiki/assets/20230725154309174.PsdSEBrB.jpg" alt="img" loading="lazy"></p><br><p>然后在子任务一栏，填写清理Redis中的历史榜单的任务id，本例中是13：</p><p><img src="/cswiki/assets/20230725154309693.3plbNkDP.jpg" alt="img" loading="lazy"></p><p>好了，任务链形成了。</p><br><p>接下来，执行一次创建榜单表任务，就会发现后续的两个任务也依次执行了。</p><h2 id="练习" tabindex="-1">练习 <a class="header-anchor" href="#练习" aria-label="Permalink to &quot;练习&quot;">​</a></h2><h3 id="查询积分榜-1" tabindex="-1">查询积分榜 <a class="header-anchor" href="#查询积分榜-1" aria-label="Permalink to &quot;查询积分榜&quot;">​</a></h3><p>完善查询学霸积分榜功能，课堂中只实现了对当前赛季榜单的查询，大家需要完善对历史榜单数据的查询。</p><p>注意：历史榜单数据在不同的表中。</p><br><h3 id="清理积分明细" tabindex="-1">清理积分明细 <a class="header-anchor" href="#清理积分明细" aria-label="Permalink to &quot;清理积分明细&quot;">​</a></h3><p>积分明细数据比积分榜单数据量更大，全部放到一张表中不太合适。建议按照赛季的日期对积分明细数据做水平拆分：</p><ul><li>当前赛季的数据依然保存在points_record表不变</li><li>每个历史赛季的积分明细需要从points_record表迁移到一张独立的表中</li><li>表名称规则points_record_xx，这里的xx就是赛季id</li></ul><p>通过一个定时任务在每月初完成数据迁移。</p><br><h2 id="总结" tabindex="-1">总结 <a class="header-anchor" href="#总结" aria-label="Permalink to &quot;总结&quot;">​</a></h2><div class="warning custom-block"><p class="custom-block-title">💡思考：你在项目中负责积分排行榜功能，说说看你们排行榜怎么设计实现的？</p><p>答：我们的排行榜功能分为两部分：一个是当前赛季排行榜，一个是历史排行榜。</p><p>因为我们的产品设计是每个月为一个赛季，月初清零积分记录，这样学员就有持续的动力去学习。这就有了赛季的概念，因此也就有了当前赛季榜单和历史榜单的区分，其实现思路也不一样。</p><p>首先说当前赛季榜单，我们采用了Redis的SortedSet来实现。member是用户id，score就是当月积分总值。每当用户产生积分行为的时候，获取积分时，就会更新score值。这样Redis就会自动形成榜单了。非常方便且高效。</p><p>然后再说历史榜单，历史榜单肯定是保存到数据库了。不过由于数据过多，所以需要对数据做水平拆分，我们目前的思路是按照赛季来拆分，也就是每一个赛季的榜单单独一张表。这样做有几个好处：</p><ul><li>拆分数据时比较自然，无需做额外处理</li><li>查询数据时往往都是按照赛季来查询，这样一次只需要查一张表，不存在跨表查询问题</li></ul><p>因此我们就不需要用到分库分表的插件了，直接在业务层利用MybatisPlus就可以实现动态表名，动态插入了。简单高效。</p><p>我们会利用一个定时任务在每月初生成上赛季的榜单表，然后再用一个定时任务读取Redis中的上赛季榜单数据，持久化到数据库中。最后再有一个定时任务清理Redis中的历史数据。</p><p>这里要说明一下，这里三个任务是有关联的，之所以让任务分开定义，是为了避免任务耦合。这样在部分任务失败时，可以单独重试，无需所有任务从头重试。</p><p>当然，最终我们肯定要确保这三个任务的执行顺序，一定是依次执行的。</p><br><p>💡<strong>思考：你们使用Redis的SortedSet来保存榜单数据，如果用户量非常多怎么办？</strong></p><p>首先Redis的SortedSet底层利用了跳表机制，性能还是非常不错的。即便有百万级别的用户量，利用SortedSet也没什么问题，性能上也能得到保证。在我们的项目用户量下，完全足够。</p><p>当系统用户量规模达到数千万，乃至数亿时，我们可以采用分治的思想，将用户数据按照积分范围划分为多个桶。</p><p>然后为每个桶创建一个SortedSet类型的key，这样就可以将数据分散，减少单个KEY的数据规模了。</p><p>而要计算排名时，只需要按照范围查询出用户积分所在的桶，再累加分值范围比他高的桶的用户数量即可。依然非常简单、高效。</p><br><p>💡<strong>思考：你们使用历史榜单采用的定时任务框架是哪个？处理数百万的榜单数据时任务是如何分片的？你们是如何确保多个任务依次执行的呢？</strong></p><p>答：我们采用的是XXL-JOB框架。</p><p>XXL-JOB自带任务分片广播机制，每一个任务执行器都能通过API得到自己的分片编号、总分片数量。在做榜单数据批处理时，我们是按照分页查询的方式：</p><ul><li>每个执行器的读取的起始页都是自己的分片编号+1，例如第一个执行器，其起始页就是1，第二个执行器，其起始页就是2，以此类推</li><li>然后不是逐页查询，而是有一个页的跨度，跨度值就是分片总数量。例如分了3片，那么跨度就是3</li></ul><p>此时，第一个分片处理的数据就是第1、4、7、10、13等几页数据，第二个分片处理的就是第2、5、8、11、14等页的数据，第三个分片处理的就是第3、6、9、12、15等页的数据。</p><p>这样就能确保所有数据都会被处理，而且每一个执行器都执行的是不同的数据了。</p><p>最后，要确保多个任务的执行顺序，可以利用XXL-JOB中的子任务功能。比如有任务A、B、C，要按照字母顺序依次执行，我们就可以将C设置为B的子任务，再将B设置为A的子任务。然后给A设置一个触发器。</p><p>这样，当A触发时，就会依次执行这三个任务了。</p></div></div></div></main><footer class="VPDocFooter" data-v-7b451c74 data-v-ffe8a71c><!--[--><!--]--><div class="edit-info" data-v-ffe8a71c><!----><div class="last-updated" data-v-ffe8a71c><p class="VPLastUpdated" data-v-ffe8a71c data-v-fc47d7a3>最后更新: <time datetime="2024-11-03T15:45:53.000Z" data-v-fc47d7a3></time></p></div></div><nav class="prev-next" data-v-ffe8a71c><div class="pager" data-v-ffe8a71c><a class="VPLink link pager-link prev" href="/cswiki/src/project/college/07-%E7%A7%AF%E5%88%86%E7%B3%BB%E7%BB%9F" data-v-ffe8a71c><!--[--><span class="desc" data-v-ffe8a71c>上一篇</span><span class="title" data-v-ffe8a71c>07-积分系统</span><!--]--></a></div><div class="pager" data-v-ffe8a71c><a class="VPLink link pager-link next" href="/cswiki/src/project/college/09-%E4%BC%98%E6%83%A0%E5%88%B8%E7%AE%A1%E7%90%86" data-v-ffe8a71c><!--[--><span class="desc" data-v-ffe8a71c>下一篇</span><span class="title" data-v-ffe8a71c>09-优惠券管理</span><!--]--></a></div></nav></footer><!--[--><!--]--></div></div></div><!--[--><!--]--></div></div><!----><!--[--><!--]--></div></div>
    <script>window.__VP_HASH_MAP__=JSON.parse("{\"src_base_alg_index.md\":\"MyjqLDYd\",\"index.md\":\"f0C03zif\",\"src_base_alg_01-数据结构与算法.md\":\"swVJqwCL\",\"src_base_cloud_00操作篇-安装docker.md\":\"ieGtpKRS\",\"src_base_cloud_00操作篇-多级缓存案例.md\":\"8_JwsqcT\",\"src_base_cloud_00操作篇-安装redis.md\":\"yEapRJPQ\",\"src_base_cloud_00操作篇-安装mq.md\":\"q6UQ4zdp\",\"src_base_cloud_00操作篇-安装seata.md\":\"xITEHdL7\",\"src_base_cloud_00操作篇-安装nacos.md\":\"psz_g1rz\",\"src_base_cloud_00操作篇-安装elk.md\":\"7LTyXvCf\",\"src_base_cloud_02实用篇-容器管理.md\":\"Gg4_8yMU\",\"src_base_cloud_03实用篇-异步通信.md\":\"M6EGZRsI\",\"src_base_cloud_04实用篇-文档数据库.md\":\"F9NZz0Xh\",\"src_base_cloud_01实用篇-微服务治理.md\":\"wZNaW1Dr\",\"src_base_cloud_06实用篇-分布式缓存.md\":\"7hBkVwHm\",\"src_base_cloud_07高级篇-微服务保护.md\":\"vVZ1Sc_-\",\"src_base_cloud_09高级篇-可靠消息服务.md\":\"ezluIOj5\",\"src_base_cloud_08高级篇-分布式事务.md\":\"YmY-tyOZ\",\"src_base_cloud_index.md\":\"x6LZ6at3\",\"src_base_gof_01-设计模式入门.md\":\"Twc37v3L\",\"src_base_gof_02-uml类图.md\":\"sWH0206E\",\"src_base_cloud_10高级篇-多级缓存技术.md\":\"zpvNe4F3\",\"src_base_gof_03-六大原则.md\":\"7RTrJ7i-\",\"src_base_gof_04-创建者模式.md\":\"b1frCBy4\",\"src_base_cloud_05实用篇-分布式搜索.md\":\"fsUJ3AG4\",\"src_base_gof_05-结构者模式.md\":\"9g8L9w-C\",\"src_base_java_02-java集合.md\":\"0n9EXxZ6\",\"src_base_java_index.md\":\"RuqkmUqQ\",\"src_base_juc_index.md\":\"dt7_IZgk\",\"src_base_index.md\":\"CjSWuIry\",\"src_base_juc_juc-apply-cache.md\":\"JNrm_IxU\",\"src_base_java_01-java基础.md\":\"md-1gUI3\",\"src_base_juc_juc-apply-limit.md\":\"NCDUtiTQ\",\"src_base_juc_juc-apply-fork.md\":\"chWd-M1K\",\"src_base_juc_juc-apply-plan.md\":\"t-mDvOux\",\"src_base_gof_index.md\":\"tdFYM8T2\",\"src_base_juc_juc-apply-sync-async.md\":\"eFEJlU6M\",\"src_base_juc_juc-apply-exclusive.md\":\"bIP5b6BO\",\"src_base_gof_07-设计模式实践.md\":\"3pM7Hysx\",\"src_base_juc_juc-model-flyweight.md\":\"MeMO8A-2\",\"src_base_juc_juc-model-balking.md\":\"1aXIKIUL\",\"src_base_juc_juc-model-product.md\":\"CsrXn2t3\",\"src_base_juc_juc-model-work-queue.md\":\"XkDclUp4\",\"src_base_juc_juc-model-order.md\":\"D9BCkQ7i\",\"src_base_juc_juc-practice-batch.md\":\"N5w5aatx\",\"src_base_juc_juc-model-termination.md\":\"f73FDwtU\",\"src_base_gof_06-行为者模式.md\":\"NjgRVFuv\",\"src_base_juc_juc-model-protect.md\":\"r0e1ZW1u\",\"src_base_juc_juc-share-memory.md\":\"X3RobD1u\",\"src_base_juc_juc-share-final.md\":\"DRG4E_3x\",\"src_base_cloud_11面试篇-微服务源码解析.md\":\"u0iO5ZvR\",\"src_base_juc_juc-base.md\":\"ePNnMePW\",\"src_base_juc_juc-share-nosync.md\":\"IstEXNbk\",\"src_base_juc_juc-share-nolock.md\":\"XNhUgHzY\",\"src_base_juc_juc-theory-linked-blocking-queue.md\":\"R4XZm-5Q\",\"src_base_juc_juc-theory-reentrant-read-write-lock.md\":\"tbvcX5gF\",\"src_base_juc_juc-theory-semaphore.md\":\"FiAMhhzE\",\"src_base_juc_juc-theory-concurrent-map.md\":\"_SJqSKh9\",\"src_base_juc_juc-theory-volatile.md\":\"X0JD0EVi\",\"src_base_juc_juc-theory-reentrant-lock.md\":\"q33YKaIa\",\"src_base_juc_juc-tool-collections.md\":\"AZ-r1bi3\",\"src_base_juc_juc-theory-synchronized.md\":\"ortKAKD1\",\"src_base_juc_juc-tool-tools.md\":\"mlDt0KWi\",\"src_base_juc_juc-tool-locks.md\":\"QqirRWne\",\"src_base_jvm_index.md\":\"pG-O5aN6\",\"src_base_juc_juc-tools-atomic.md\":\"PtnZWSZA\",\"src_base_jvm_jvm-base-bytecode.md\":\"Eduzz1IX\",\"src_base_jvm_jvm-base-gc.md\":\"yHGH2n2l\",\"src_base_jvm_jvm-base.md\":\"P2eALBsa\",\"src_base_juc_juc-tools-pool.md\":\"D5xLxDoo\",\"src_base_juc_juc-share-monitor.md\":\"-SNaMsZp\",\"src_base_jvm_jvm-base-runtime.md\":\"SJFPW7gj\",\"src_base_jvm_jvm-senior-graal-vm.md\":\"DAXKHlHc\",\"src_base_jvm_jvm-senior-new-gc.md\":\"dpq5rMqs\",\"src_base_jvm_jvm-senior-java-agent.md\":\"DJX5UP0-\",\"src_base_jvm_jvm-summarize.md\":\"lXUmnuJu\",\"src_base_jvm_jvm-tuning-function.md\":\"PcqhGm4c\",\"src_base_jvm_jvm-theory.md\":\"x8DndpNx\",\"src_base_jvm_jvm-tuning-gc.md\":\"4pZlx7pb\",\"src_base_linux_01-初始linux.md\":\"StuIZGWa\",\"src_base_linux_index.md\":\"Ua07q16P\",\"src_base_mysql_02-mysql进阶-sql优化.md\":\"20xgs4Kx\",\"src_base_mysql_01-mysql基础.md\":\"pSdd5XcZ\",\"src_base_mysql_02-mysql进阶-事务.md\":\"l0NBH66L\",\"src_base_mysql_02-mysql进阶-索引.md\":\"REsen0SR\",\"src_base_mysql_02-mysql进阶-数据库架构.md\":\"YLupdM1c\",\"src_base_mysql_02-mysql进阶-innodb引擎.md\":\"30d9HhSj\",\"src_base_mysql_02-mysql进阶-锁.md\":\"PMNnnXzf\",\"src_base_jvm_jvm-tuning-memory.md\":\"YHGnaTrS\",\"src_base_mysql_03-mysql运维-主从复制.md\":\"0NeuLHW7\",\"src_base_mysql_03-mysql运维-管理工具.md\":\"xRHTtOaI\",\"src_base_mysql_03-mysql运维-性能优化.md\":\"pfkINVF5\",\"src_base_mysql_03-mysql运维-日志文件.md\":\"EVJyUbT0\",\"src_base_mysql_03-mysql运维-读写分离.md\":\"1F8rT23t\",\"src_base_mysql_03-mysql运维-分库分表.md\":\"ZPVC0_Nv\",\"src_base_mysql_04-mysql实践-sql练习.md\":\"nR54OvyS\",\"src_base_mysql_04-mysql实践-sql记录.md\":\"zDd4TSxB\",\"src_base_mysql_index.md\":\"gBKktBqs\",\"src_base_netty_index.md\":\"LXYE7ddD\",\"src_base_mysql_02-mysql进阶.md\":\"T5tdgmYR\",\"src_base_netty_netty-base.md\":\"D6_0Bxi7\",\"src_base_netty_netty-code.md\":\"Grh9C4dp\",\"src_base_netty_netty-senior.md\":\"uOf6JuG2\",\"src_base_spring_index.md\":\"EM8AQAEi\",\"src_base_spring_spring-aop.md\":\"egWS7_n6\",\"src_base_spring_spring-mvc.md\":\"5rWSZLcQ\",\"src_base_spring_spring-boot.md\":\"lwm3hvPj\",\"src_base_spring_spring-other.md\":\"OtlMdl2o\",\"src_base_summarize_interview.md\":\"uYScr83e\",\"src_base_summarize_java-base.md\":\"N6OvBOHs\",\"src_base_summarize_index.md\":\"AjFR8_3v\",\"src_base_spring_spring-bean.md\":\"_YU0p9zf\",\"src_base_summarize_java-netty.md\":\"x2pFfzzl\",\"src_base_summarize_gof.md\":\"v33aRpiZ\",\"src_base_summarize_java-collection.md\":\"TPwn8ugY\",\"src_base_summarize_message-queue.md\":\"Ell0PlTC\",\"src_base_summarize_java-virtual.md\":\"9-Rsd_sV\",\"src_base_netty_non-blocking-io.md\":\"DFxvqtOp\",\"src_base_summarize_mysql.md\":\"DMXSPE9L\",\"src_base_summarize_project-practice.md\":\"30CvZcCs\",\"src_base_summarize_redis.md\":\"l3vs9dOV\",\"src_base_summarize_spring-cloud.md\":\"O0nrcLKs\",\"src_project_college_00-内网穿透.md\":\"5epNi5lB\",\"src_project_college_00-自定义部署.md\":\"0qnGyG9p\",\"src_project_college_00-虚拟机导入.md\":\"BtH_ekVp\",\"src_base_summarize_spring.md\":\"Q-3bB8xB\",\"src_base_summarize_java-concurrent.md\":\"iHTG1YAE\",\"src_project_college_01-初识项目.md\":\"N-RietTZ\",\"src_project_college_02-我的课表.md\":\"afiNyrhG\",\"src_project_college_04-学习记录.md\":\"-_Tk7_j3\",\"src_project_college_03-学习计划.md\":\"4Z-MQRjM\",\"src_project_college_05-问答系统.md\":\"6sGCsZA2\",\"src_project_college_06-点赞系统.md\":\"q1yTK1XB\",\"src_project_college_08-排行榜功能.md\":\"w4I0TgA_\",\"src_project_college_07-积分系统.md\":\"QODLJGwf\",\"src_project_college_13-项目部署.md\":\"xn_xcUER\",\"src_project_college_09-优惠券管理.md\":\"U9eTVbeF\",\"src_project_college_index.md\":\"L3og0vVF\",\"src_project_express_00-常见问题.md\":\"CUeyIsM4\",\"src_project_college_10-领取优惠券.md\":\"yV-JqecF\",\"src_project_college_14-项目实战.md\":\"4YLTJHkc\",\"src_project_express_00-基础服务.md\":\"376SObFF\",\"src_project_college_11-优惠券优化.md\":\"HRTnYaCG\",\"src_project_express_00-基础工具.md\":\"a8pWbL0u\",\"src_project_express_01-初识项目.md\":\"GbRCqzxN\",\"src_project_college_12-优惠券使用.md\":\"Y4bejsfW\",\"src_project_express_03-运费服务.md\":\"QyKspbxC\",\"src_project_express_06-运输任务.md\":\"LwysKUvo\",\"src_project_financial_index.md\":\"_dipptdR\",\"src_project_express_index.md\":\"GDw4KM25\",\"src_project_index.md\":\"-uzkkdVO\",\"src_project_health_index.md\":\"MOoLLfU7\",\"src_project_express_11-项目运维.md\":\"p0kc39qy\",\"src_project_redis_02-redis实战-黑马点评.md\":\"8LxFzK1e\",\"src_project_express_05-调度服务.md\":\"nnBYTdYo\",\"src_project_express_07-作业范围.md\":\"OoM_JyMv\",\"src_project_redis_03-redis实战-短信登录.md\":\"bEoJ6kN_\",\"src_project_takeout_index.md\":\"kGycznV8\",\"src_project_express_12-项目实战.md\":\"fA_7fIIF\",\"src_project_redis_01-redis基础.md\":\"WBJYPgIp\",\"src_project_redis_10-redis实战-uv统计.md\":\"GavO2Vq4\",\"src_project_express_02-支付服务.md\":\"rPszblZo\",\"src_project_redis_13-redis原理-网络模型.md\":\"j5UYhDcX\",\"src_project_redis_09-redis实战-用户签到.md\":\"6BYgiJ-G\",\"src_project_redis_14-redis原理-内存策略.md\":\"brnCtCg0\",\"src_project_shop_index.md\":\"kVFuNBWp\",\"src_project_redis_06-redis实战-达人探店.md\":\"ofOd3WsL\",\"src_project_express_10-持续集成.md\":\"qHyIEOH-\",\"src_project_redis_12-redis原理-数据结构.md\":\"hN1W-Abs\",\"src_project_redis_index.md\":\"wSkhV2NJ\",\"src_project_express_04-路线服务.md\":\"TLkJQBID\",\"src_project_rent_index.md\":\"Iybh37Ms\",\"src_project_social_index.md\":\"_llU1edg\",\"src_project_redis_08-redis实战-附近商户.md\":\"jvOX54uo\",\"src_project_express_08-派件调度.md\":\"z8faVzxd\",\"src_project_topnews_00-虚拟机导入.md\":\"BYKu4wH1\",\"src_project_redis_07-redis实战-好友关注.md\":\"j-rgE_B_\",\"src_project_redis_04-redis实战-商户查询.md\":\"pZWuWyzt\",\"src_project_topnews_00-自定义部署.md\":\"t__659DY\",\"src_project_redis_11-redis实践.md\":\"fKvuEAZv\",\"src_project_express_09-物流服务.md\":\"qs-XdeKm\",\"src_project_redis_05-redis实战-优惠券秒杀.md\":\"JZ34CXjc\",\"src_project_topnews_01-初识项目.md\":\"HwhS9NNx\",\"src_project_topnews_03-文章发布.md\":\"b7gsko2z\",\"src_project_topnews_00-自定义服务.md\":\"cakq0AAd\",\"src_project_topnews_02-文章查看.md\":\"Lfi0FXnC\",\"src_project_topnews_04-文章审核.md\":\"9ehA9QUe\",\"src_project_topnews_06-文章上架.md\":\"_rXw-Qjr\",\"src_project_topnews_08-平台管理.md\":\"kCaSxZN0\",\"src_project_topnews_09-用户行为.md\":\"o98DyDMW\",\"src_project_topnews_07-文章搜索.md\":\"M9jsEy7e\",\"src_project_topnews_10-定时计算.md\":\"Xev9SMdC\",\"src_project_topnews_05-延迟发布.md\":\"sVaq0_ZS\",\"src_project_topnews_12-多级缓存.md\":\"OEkgLTv_\",\"src_project_topnews_11-实时计算.md\":\"JpQNVF9K\",\"src_study_english_01-英语学习.md\":\"26mQ_RqO\",\"src_study_book_01-图书学习.md\":\"8q-i_wqh\",\"src_project_topnews_index.md\":\"DjOImstG\",\"src_study_index.md\":\"sLvseDBN\",\"src_study_method_01-高效搜索.md\":\"FtdLWAQk\",\"src_study_method_04-提升专注力.md\":\"la1bup_b\",\"src_study_method_03-结构思维.md\":\"MIYiCZwc\",\"src_study_method_05-面试技巧.md\":\"Qer4h2XN\",\"src_study_movie_01-电影影片.md\":\"YJ6rn4p5\",\"src_project_topnews_13-持续集成.md\":\"McstQZye\",\"src_study_method_02-养成好习惯.md\":\"kMBM7_Fu\",\"src_project_topnews_14-项目实战.md\":\"n0RxpO08\"}");window.__VP_SITE_DATA__=JSON.parse("{\"lang\":\"zh-CN\",\"dir\":\"ltr\",\"title\":\"知识小册子\",\"description\":\"搭建个人的知识体系,一个好的知识体系和学习方法会让自己事半功倍\",\"base\":\"/cswiki/\",\"head\":[],\"router\":{\"prefetchLinks\":true},\"appearance\":true,\"themeConfig\":{\"nav\":[{\"text\":\"📌 技术博客\",\"link\":\"/\"},{\"text\":\"📝 基础知识\",\"items\":[{\"items\":[{\"text\":\"☕️ Java基础\",\"link\":\"/src/base/java/index\"},{\"text\":\"🖥 JVM入门\",\"link\":\"/src/base/jvm/index\"},{\"text\":\"🔥 并发编程\",\"link\":\"/src/base/juc/index\"},{\"text\":\"🌐 网络编程\",\"link\":\"/src/base/netty/index\"}]},{\"items\":[{\"text\":\"🧩 数据结构\",\"link\":\"/src/base/alg/index\"},{\"text\":\"📝 设计模式\",\"link\":\"/src/base/gof/index\"}]},{\"items\":[{\"text\":\"📊 数据库\",\"link\":\"/src/base/mysql/index\"},{\"text\":\"👨‍💻 服务器\",\"link\":\"/src/base/linux/index\"},{\"text\":\"🌱 Spring\",\"link\":\"/src/base/spring/index\"},{\"text\":\"☁️ 微服务\",\"link\":\"/src/base/cloud/index\"}]}]},{\"text\":\"🛠️ 项目实战\",\"items\":[{\"items\":[{\"text\":\"🔖️ 黑马点评\",\"link\":\"/src/project/redis/index\"},{\"text\":\"📰 黑马头条\",\"link\":\"/src/project/topnews/index\"}]},{\"items\":[{\"text\":\"📚 天机学堂\",\"link\":\"/src/project/college/index\"},{\"text\":\"🚚 神领物流\",\"link\":\"/src/project/express/index\"},{\"text\":\"🛒 谷粒商城\",\"link\":\"/src/project/shop/index\"}]},{\"items\":[{\"text\":\"🍜 谷粒外卖\",\"link\":\"/src/project/takeout/index\"},{\"text\":\"🏄 谷粒健康\",\"link\":\"/src/project/health/index\"},{\"text\":\"🧑‍🤝‍🧑 谷粒交友\",\"link\":\"/src/project/social/index\"},{\"text\":\"🏠 谷粒租房\",\"link\":\"/src/project/rent/index\"},{\"text\":\"📈 谷粒金融\",\"link\":\"/src/project/financial/index\"}]}],\"activeMatch\":\"/src/project\"},{\"text\":\"💼 面试宝典\",\"link\":\"/src/base/summarize/index\",\"activeMatch\":\"/src/base/summarize\"}],\"sidebar\":{\"/src/study\":[{\"text\":\"学习方法\",\"link\":\"\",\"items\":[{\"text\":\"高效搜索\",\"link\":\"/src/study/method/01-高效搜索\"},{\"text\":\"养成好习惯\",\"link\":\"/src/study/method/02-养成好习惯\"},{\"text\":\"结构思维\",\"link\":\"/src/study/method/03-结构思维\"},{\"text\":\"提升专注力\",\"link\":\"/src/study/method/04-提升专注力\"}]}],\"/src/base/java\":[{\"text\":\"Java基础\",\"base\":\"/src/base/java/\",\"link\":\"01-Java基础\"},{\"text\":\"Java集合\",\"base\":\"/src/base/java/\",\"link\":\"02-Java集合\"}],\"/src/base/jvm\":[{\"text\":\"JVM\",\"base\":\"/src/base/jvm/\",\"collapsed\":false,\"items\":[{\"text\":\"虚拟机基础\",\"items\":[{\"text\":\"JVM入门\",\"link\":\"jvm-base\"},{\"text\":\"字节码与类的加载\",\"link\":\"jvm-base-bytecode\"},{\"text\":\"运行时数据区\",\"link\":\"jvm-base-runtime\"},{\"text\":\"垃圾回收\",\"link\":\"jvm-base-gc\"}]},{\"text\":\"虚拟机实战\",\"items\":[{\"text\":\"内存调优\",\"link\":\"jvm-tuning-memory\"},{\"text\":\"GC调优\",\"link\":\"jvm-tuning-gc\"},{\"text\":\"性能调优\",\"link\":\"jvm-tuning-function\"}]},{\"text\":\"虚拟机高级\",\"items\":[{\"text\":\"GraalVM\",\"link\":\"jvm-senior-graal-vm\"},{\"text\":\"新一代GC\",\"link\":\"jvm-senior-new-gc\"},{\"text\":\"Java工具\",\"link\":\"jvm-senior-java-agent\"}]},{\"text\":\"虚拟机原理\",\"link\":\"jvm-theory\",\"items\":[]},{\"text\":\"虚拟机总结\",\"link\":\"jvm-summarize\"}]}],\"/src/base/juc\":[{\"text\":\"并发编程\",\"base\":\"/src/base/juc/\",\"collapsed\":false,\"items\":[{\"text\":\"并发编程基础\",\"link\":\"juc-base\"},{\"text\":\"并发编程理论\",\"base\":\"/src/base/juc/juc-share-\",\"items\":[{\"text\":\"共享模型之管程\",\"link\":\"monitor\"},{\"text\":\"共享模型之内存\",\"link\":\"memory\"},{\"text\":\"共享模型之无锁\",\"link\":\"nolock\"},{\"text\":\"共享模型之不可变\",\"link\":\"final\"},{\"text\":\"共享模型之无同步方案\",\"link\":\"nosync\"}]},{\"text\":\"并发编程工具\",\"base\":\"/src/base/juc/juc-tool-\",\"items\":[{\"text\":\"线程池\",\"link\":\"pool\"},{\"text\":\"Locks\",\"link\":\"locks\"},{\"text\":\"Tools\",\"link\":\"tools\"},{\"text\":\"Atomic\",\"link\":\"atomic\"},{\"text\":\"Collections\",\"link\":\"collections\"}]},{\"text\":\"并发编程应用\",\"base\":\"/src/base/juc/juc-apply-\",\"items\":[{\"text\":\"同步和异步\",\"link\":\"sync-async\"},{\"text\":\"限制\",\"link\":\"limit\"},{\"text\":\"互斥\",\"link\":\"exclusive\"},{\"text\":\"缓存\",\"link\":\"cache\"},{\"text\":\"分治\",\"link\":\"fork\"},{\"text\":\"统筹\",\"link\":\"plan\"}]},{\"text\":\"并发编程模式\",\"base\":\"/src/base/juc/juc-model\",\"items\":[{\"text\":\"同步模式之保护者暂停\",\"link\":\"protect\"},{\"text\":\"同步模式之顺序控制\",\"link\":\"order\"},{\"text\":\"同步模式之Balking\",\"link\":\"balking\"},{\"text\":\"异步模式之生产者消费者\",\"link\":\"product\"},{\"text\":\"异步模式之工作线程\",\"link\":\"work-queue\"},{\"text\":\"终止模式之两阶段终止\",\"link\":\"termination\"},{\"text\":\"共享模式之享元\",\"link\":\"flyweight\"}]},{\"text\":\"* 并发编程原理\",\"base\":\"/src/base/juc/juc-theory-\",\"items\":[{\"text\":\"synchronized原理\",\"link\":\"synchronized\"},{\"text\":\"volatile原理\",\"link\":\"volatile\"},{\"text\":\"ReentrantLock原理\",\"link\":\"reentrant-lock\"},{\"text\":\"读写锁原理\",\"link\":\"reentrant-read-write-lock\"},{\"text\":\"Semaphore原理\",\"link\":\"semaphore\"},{\"text\":\"ConcurrentMap原理\",\"link\":\"concurrent-map\"},{\"text\":\"LinkedBlockingQueue原理\",\"link\":\"linked-blocking-queue\"}]},{\"text\":\"并发编程场景\",\"base\":\"/src/base/juc/juc-practice\",\"items\":[{\"text\":\"批量数据导入\",\"link\":\"batch\"}]}]}],\"/src/base/netty\":[{\"text\":\"网络编程\",\"collapsed\":false,\"base\":\"/src/base/netty/\",\"items\":[{\"text\":\"Java NIO\",\"link\":\"non-blocking-io\"},{\"text\":\"Netty\",\"items\":[{\"text\":\"Netty 基础\",\"link\":\"netty-base\"},{\"text\":\"Netty 高级\",\"link\":\"netty-senior\"},{\"text\":\"*Netty 源码\",\"link\":\"netty-code\"}]},{\"text\":\"Nginx\"}]}],\"/src/base/mysql\":[{\"text\":\"数据库\",\"base\":\"/src/base/mysql/\",\"items\":[{\"text\":\"MySQL基础\",\"link\":\"01-MySQL基础\"},{\"text\":\"MySQL进阶\",\"base\":\"/src/base/mysql/02-\",\"link\":\"MySQL进阶\",\"items\":[{\"text\":\"数据库架构\",\"link\":\"MySQL进阶-数据库架构\"},{\"text\":\"索引\",\"link\":\"MySQL进阶-索引\"},{\"text\":\"SQL优化\",\"link\":\"MySQL进阶-SQL优化\"},{\"text\":\"锁\",\"link\":\"MySQL进阶-锁\"},{\"text\":\"InnoDB引擎\",\"link\":\"MySQL进阶-InnoDB引擎\"}]},{\"text\":\"MySQL运维\",\"base\":\"/src/base/mysql/03-MySQL运维-\",\"items\":[{\"text\":\"管理工具\",\"link\":\"管理工具\"},{\"text\":\"日志文件\",\"link\":\"日志文件\"},{\"text\":\"主从复制\",\"link\":\"主从复制\"},{\"text\":\"分库分表\",\"link\":\"分库分表\"},{\"text\":\"读写分离\",\"link\":\"读写分离\"}]},{\"text\":\"MySQL实践\",\"base\":\"/src/base/mysql/04-MySQL实践-\",\"items\":[{\"text\":\"SQL记录\",\"link\":\"SQL记录\"},{\"text\":\"SQL练习\",\"link\":\"SQL练习\"}]}]}],\"/src/base/gof\":[{\"text\":\"设计模式\",\"collapsed\":false,\"base\":\"/src/base/gof/\",\"items\":[{\"text\":\"设计模式入门\",\"link\":\"01-设计模式入门\"},{\"text\":\"UML类图\",\"link\":\"02-UML类图\"},{\"text\":\"六大原则\",\"link\":\"03-六大原则\"},{\"text\":\"创建者模式\",\"link\":\"04-创建者模式\"},{\"text\":\"结构者模式\",\"link\":\"05-结构者模式\"},{\"text\":\"行为者模式\",\"link\":\"06-行为者模式\"},{\"text\":\"设计模式实践\",\"link\":\"07-设计模式实践\"}]}],\"/src/base/spring\":[{\"text\":\"Spring原理篇\",\"collapsed\":false,\"base\":\"/src/base/spring/\",\"items\":[{\"text\":\"Spring-Bean\",\"link\":\"01-Spring-Bean\"},{\"text\":\"Spring-AOP\",\"link\":\"02-Spring-AOP\"},{\"text\":\"Spring-Boot\",\"link\":\"03-Spring-Boot\"},{\"text\":\"Spring-MVC\",\"link\":\"04-Spring-MVC\"},{\"text\":\"Spring-Other\",\"link\":\"05-Spring-Other\"}]},{\"text\":\"Spring集成篇\",\"collapsed\":false}],\"/src/base/cloud\":[{\"text\":\"Cloud 实用篇\",\"base\":\"/src/base/cloud/\",\"collapsed\":false,\"items\":[{\"text\":\"微服务治理\",\"link\":\"01实用篇-微服务治理\"},{\"text\":\"容器管理\",\"link\":\"02实用篇-容器管理\"},{\"text\":\"异步通信\",\"link\":\"03实用篇-异步通信\"},{\"text\":\"文档数据库\",\"link\":\"04实用篇-文档数据库\"},{\"text\":\"分布式缓存\",\"link\":\"06实用篇-分布式缓存\"}]},{\"text\":\"Cloud 高级篇\",\"base\":\"/src/base/cloud/\",\"collapsed\":false,\"items\":[{\"text\":\"分布式搜索\",\"link\":\"05实用篇-分布式搜索\"},{\"text\":\"分布式事务\",\"link\":\"08高级篇-分布式事务\"},{\"text\":\"微服务保护\",\"link\":\"07高级篇-微服务保护\"},{\"text\":\"可靠消息服务\",\"link\":\"09高级篇-可靠消息服务\"},{\"text\":\"多级缓存技术\",\"link\":\"10高级篇-多级缓存技术\"},{\"text\":\"微服务面试题\",\"link\":\"11面试篇-微服务源码解析\"}]},{\"text\":\"Cloud 操作篇\",\"base\":\"/src/base/cloud¡/00操作篇-\",\"collapsed\":false,\"items\":[{\"text\":\"安装Nacos\",\"link\":\"安装Nacos\"},{\"text\":\"安装Seata\",\"link\":\"安装Seata\"},{\"text\":\"安装Docker\",\"link\":\"安装Docker\"},{\"text\":\"安装Redis\",\"link\":\"安装Redis\"},{\"text\":\"安装MQ\",\"link\":\"安装MQ\"},{\"text\":\"安装ELK\",\"link\":\"安装ELK\"},{\"text\":\"多级缓存案例\",\"link\":\"多级缓存案例\"}]}],\"/src/project/redis\":[{\"text\":\"黑马点评\",\"collapsed\":false,\"base\":\"/src/project/redis/\",\"items\":[{\"text\":\"Redis基础\",\"link\":\"01-Redis基础\"},{\"text\":\"Redis实战\",\"base\":\"/src/project/redis/\",\"items\":[{\"text\":\"黑马点评\",\"link\":\"02-Redis实战-黑马点评\"},{\"text\":\"短信登录\",\"link\":\"03-Redis实战-短信登录\"},{\"text\":\"商户查询\",\"link\":\"04-Redis实战-商户查询\"},{\"text\":\"* 优惠券秒杀\",\"link\":\"05-Redis实战-优惠券秒杀\"},{\"text\":\"达人探店\",\"link\":\"06-Redis实战-达人探店\"},{\"text\":\"好友关注\",\"link\":\"07-Redis实战-好友关注\"},{\"text\":\"附近商户\",\"link\":\"08-Redis实战-附近商户\"},{\"text\":\"用户签到\",\"link\":\"09-Redis实战-用户签到\"},{\"text\":\"UV统计\",\"link\":\"10-Redis实战-UV统计\"}]},{\"text\":\"* Redis实践\",\"link\":\"11-Redis实践\"},{\"text\":\"* Redis原理\",\"base\":\"/src/project/redis/\",\"items\":[{\"text\":\"数据结构\",\"link\":\"12-Redis原理-数据结构\"},{\"text\":\"网络模型\",\"link\":\"13-Redis原理-网络模型\"},{\"text\":\"内存策略\",\"link\":\"14-Redis原理-内存策略\"}]}]}],\"/src/project/topnews\":[{\"text\":\"黑马点评\",\"collapsed\":false,\"base\":\"/src/project/topnews/\",\"items\":[{\"text\":\"Day01-初识项目\",\"link\":\"01-初识项目\",\"items\":[{\"text\":\"虚拟机导入\",\"link\":\"00-虚拟机导入\"},{\"text\":\"自定义部署\",\"link\":\"00-自定义部署\"},{\"text\":\"自定义服务\",\"link\":\"00-自定义服务\"}]},{\"text\":\"Day02-文章查看\",\"link\":\"02-文章查看\"},{\"text\":\"Day03-文章发布\",\"link\":\"03-文章发布\"},{\"text\":\"Day04-文章审核\",\"link\":\"04-文章审核\"},{\"text\":\"Day05-延迟发布\",\"link\":\"05-延迟发布\"},{\"text\":\"Day06-文章上架\",\"link\":\"06-文章上架\"},{\"text\":\"Day07-文章搜索\",\"link\":\"07-文章搜索\"},{\"text\":\"Day08-平台管理\",\"link\":\"08-平台管理\"},{\"text\":\"Day09-用户行为\",\"link\":\"09-用户行为\"},{\"text\":\"Day10-定时计算\",\"link\":\"10-定时计算\"},{\"text\":\"Day11-实时计算\",\"link\":\"11-实时计算\"},{\"text\":\"Day12-多级缓存\",\"link\":\"12-多级缓存\"},{\"text\":\"Day13-持续集成\",\"link\":\"13-持续集成\"},{\"text\":\"Day14-项目实战\",\"link\":\"14-项目实战\"}]}],\"/src/project/college\":[{\"text\":\"天机学堂\",\"collapsed\":false,\"base\":\"/src/project/college/\",\"items\":[{\"text\":\"01-初识项目\",\"link\":\"01-初识项目\",\"items\":[{\"text\":\"虚拟机导入\",\"link\":\"00-虚拟机导入\"},{\"text\":\"自定义部署\",\"link\":\"00-自定义部署\"},{\"text\":\"内网穿透\",\"link\":\"00-内网穿透\"}]},{\"text\":\"02-我的课表\",\"link\":\"02-我的课表\"},{\"text\":\"03-学习计划\",\"link\":\"03-学习计划\"},{\"text\":\"04-学习记录\",\"link\":\"04-学习记录\"},{\"text\":\"05-问答系统\",\"link\":\"05-问答系统\"},{\"text\":\"06-点赞系统\",\"link\":\"06-点赞系统\"},{\"text\":\"07-积分系统\",\"link\":\"07-积分系统\"},{\"text\":\"08-排行榜功能\",\"link\":\"08-排行榜功能\"},{\"text\":\"09-优惠券管理\",\"link\":\"09-优惠券管理\"},{\"text\":\"10-领取优惠券\",\"link\":\"10-领取优惠券\"},{\"text\":\"11-优惠券优化\",\"link\":\"11-优惠券优化\"},{\"text\":\"12-优惠券使用\",\"link\":\"12-优惠券使用\"},{\"text\":\"13-项目部署\",\"link\":\"13-项目部署\"},{\"text\":\"14-项目实战\",\"link\":\"13-项目实战\"}]}],\"/src/project/express\":[{\"text\":\"神领物流\",\"collapsed\":false,\"base\":\"/src/project/express/\",\"items\":[{\"text\":\"01-初识项目\",\"link\":\"01-初识项目\",\"items\":[{\"text\":\"基础服务\",\"link\":\"00-基础服务\"},{\"text\":\"基础工具\",\"link\":\"00-基础工具\"},{\"text\":\"常见问题\",\"link\":\"00-常见问题\"}]},{\"text\":\"02-支付服务\",\"link\":\"02-支付服务\"},{\"text\":\"03-运费服务\",\"link\":\"03-运费服务\"},{\"text\":\"04-路线服务\",\"link\":\"04-路线服务\"},{\"text\":\"05-调度服务\",\"link\":\"05-调度服务\"},{\"text\":\"06-运输任务\",\"link\":\"06-运输任务\"},{\"text\":\"07-作业范围\",\"link\":\"07-作业范围\"},{\"text\":\"08-派件调度\",\"link\":\"08-派件调度\"},{\"text\":\"09-物流服务\",\"link\":\"09-物流服务\"},{\"text\":\"10-持续集成\",\"link\":\"10-持续集成\"},{\"text\":\"11-项目运维\",\"link\":\"11-项目运维\"},{\"text\":\"12-项目实战\",\"link\":\"12-项目实战\"}]}],\"/src/base/summarize\":[{\"text\":\"基础知识\",\"collapsed\":false,\"base\":\"/src/base/summarize/\",\"items\":[{\"text\":\"Java基础\",\"link\":\"java-base\"},{\"text\":\"Java集合\",\"link\":\"java-collection\"},{\"text\":\"Java虚拟机\",\"link\":\"java-virtual\"},{\"text\":\"并发编程篇\",\"link\":\"java-concurrent\"},{\"text\":\"网络编程篇\",\"link\":\"java-netty\"}]},{\"text\":\"服务框架\",\"collapsed\":false,\"base\":\"/src/base/summarize/\",\"items\":[{\"text\":\"数据库篇\",\"link\":\"mysql\"},{\"text\":\"缓存篇\",\"link\":\"redis\"},{\"text\":\"框架篇\",\"link\":\"spring\"},{\"text\":\"微服务篇\",\"link\":\"spring-cloud\"},{\"text\":\"中间件篇\",\"link\":\"message-queue\"}]},{\"text\":\"场景技术\",\"collapsed\":false,\"base\":\"/src/base/summarize/\",\"items\":[{\"text\":\"设计模式篇\",\"link\":\"gof\"},{\"text\":\"场景技术篇\",\"link\":\"project-practice\"},{\"text\":\"知识点汇总\",\"link\":\"index\"},{\"text\":\"面试准备篇\",\"link\":\"interview\"}]}]},\"logo\":\"/logo.svg\",\"outline\":{\"level\":\"deep\",\"label\":\"章节导航\"},\"darkModeSwitchLabel\":\"切换日光/暗黑模式\",\"sidebarMenuLabel\":\"文章\",\"returnToTopLabel\":\"返回顶部\",\"lastUpdatedText\":\"最后更新\",\"docFooter\":{\"prev\":\"上一篇\",\"next\":\"下一篇\"},\"search\":{\"provider\":\"local\",\"options\":{\"locales\":{\"root\":{\"translations\":{\"button\":{\"buttonText\":\"搜索文档\",\"buttonAriaLabel\":\"搜索文档\"},\"modal\":{\"noResultsText\":\"无法找到相关结果\",\"resetButtonTitle\":\"清除查询条件\",\"footer\":{\"selectText\":\"选择\",\"navigateText\":\"切换\"}}}}}}},\"socialLinks\":[{\"icon\":\"github\",\"link\":\"https://github.com/Charles7c/charles7c.github.io\"},{\"icon\":{\"svg\":\"<svg role=\\\"img\\\" viewBox=\\\"0 0 24 24\\\" xmlns=\\\"http://www.w3.org/2000/svg\\\"><title>码云</title><path d=\\\"M11.984 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.016 0zm6.09 5.333c.328 0 .593.266.592.593v1.482a.594.594 0 0 1-.593.592H9.777c-.982 0-1.778.796-1.778 1.778v5.63c0 .327.266.592.593.592h5.63c.982 0 1.778-.796 1.778-1.778v-.296a.593.593 0 0 0-.592-.593h-4.15a.592.592 0 0 1-.592-.592v-1.482a.593.593 0 0 1 .593-.592h6.815c.327 0 .593.265.593.592v3.408a4 4 0 0 1-4 4H5.926a.593.593 0 0 1-.593-.593V9.778a4.444 4.444 0 0 1 4.445-4.444h8.296Z\\\"/></svg>\"},\"link\":\"https://gitee.com/Charles7c/charles7c\"}],\"commentConfig\":{\"type\":\"gitalk\",\"showComment\":false},\"footerConfig\":{\"showFooter\":true,\"message\":\"Released under the MIT License.\",\"copyright\":\"Copyright © 2019-2024 Cookie Mousse\"}},\"locales\":{},\"scrollOffset\":134,\"cleanUrls\":true}");</script>
    
  </body>
</html>
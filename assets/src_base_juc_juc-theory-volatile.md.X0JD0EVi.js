import{_ as e,E,c as r,b as n,w as s,a4 as l,V as k,m as p,o as i,J as h,a as t}from"./chunks/framework.syB9hai_.js";const d="/cswiki/assets/image-20230924003.hCeXgTq2.png",g="/cswiki/assets/image-20230924006.n3ZS4yxE.png",y="/cswiki/assets/image-20230924005.khz54bEX.png",F="/cswiki/assets/image-20230924007.wMkmITAS.png",c="/cswiki/assets/image-20230924009.jmIZl9rp.png",o="/cswiki/assets/image-20230924008.nEijDIvN.png",x=JSON.parse('{"title":"","description":"","frontmatter":{},"headers":[],"relativePath":"src/base/juc/juc-theory-volatile.md","filePath":"src/base/juc/juc-theory-volatile.md","lastUpdated":1730648753000}'),A={name:"src/base/juc/juc-theory-volatile.md"},C=k('<p><a href="./">è¿”å›é¦–é¡µ</a></p><nav class="table-of-contents"><ul><li><a href="#åŸç†ä¹‹æŒ‡ä»¤çº§å¹¶è¡Œ">* åŸç†ä¹‹æŒ‡ä»¤çº§å¹¶è¡Œ</a><ul><li><a href="#åè¯è§£é‡Š">åè¯è§£é‡Š</a></li><li><a href="#æŒ‡ä»¤é‡æ’åºä¼˜åŒ–">æŒ‡ä»¤é‡æ’åºä¼˜åŒ–</a></li><li><a href="#æ”¯æŒæµæ°´çº¿çš„å¤„ç†å™¨">æ”¯æŒæµæ°´çº¿çš„å¤„ç†å™¨</a></li><li><a href="#superscalar-å¤„ç†å™¨">SuperScalar å¤„ç†å™¨</a></li></ul></li><li><a href="#åŸç†ä¹‹-volatile">* åŸç†ä¹‹ volatile</a><ul><li><a href="#æŒ‡ä»¤é‡æ’">æŒ‡ä»¤é‡æ’</a></li><li><a href="#è§£å†³æ–¹æ³•">è§£å†³æ–¹æ³•</a></li><li><a href="#å¦‚ä½•ä¿è¯å¯è§æ€§">å¦‚ä½•ä¿è¯å¯è§æ€§</a></li><li><a href="#å¦‚ä½•ä¿è¯æœ‰åºæ€§">å¦‚ä½•ä¿è¯æœ‰åºæ€§</a></li><li><a href="#double-checked-locking-é—®é¢˜">double-checked locking é—®é¢˜</a></li><li><a href="#double-checked-locking-è§£å†³">double-checked locking è§£å†³</a></li><li><a href="#happens-before">happens-before</a></li></ul></li></ul></nav><h2 id="åŸç†ä¹‹æŒ‡ä»¤çº§å¹¶è¡Œ" tabindex="-1">* åŸç†ä¹‹æŒ‡ä»¤çº§å¹¶è¡Œ <a class="header-anchor" href="#åŸç†ä¹‹æŒ‡ä»¤çº§å¹¶è¡Œ" aria-label="Permalink to &quot;* åŸç†ä¹‹æŒ‡ä»¤çº§å¹¶è¡Œ&quot;">â€‹</a></h2><h3 id="åè¯è§£é‡Š" tabindex="-1">åè¯è§£é‡Š <a class="header-anchor" href="#åè¯è§£é‡Š" aria-label="Permalink to &quot;åè¯è§£é‡Š&quot;">â€‹</a></h3><p><strong>Clock Cycle Time</strong></p><p>ä¸»é¢‘çš„æ¦‚å¿µå¤§å®¶æ¥è§¦çš„æ¯”è¾ƒå¤šï¼Œè€Œ CPU çš„ Clock Cycle Timeï¼ˆæ—¶é’Ÿå‘¨æœŸæ—¶é—´ï¼‰ï¼Œç­‰äºä¸»é¢‘çš„å€’æ•°ï¼Œæ„æ€æ˜¯ CPU èƒ½ å¤Ÿè¯†åˆ«çš„æœ€å°æ—¶é—´å•ä½ï¼Œæ¯”å¦‚è¯´ 4G ä¸»é¢‘çš„ CPU çš„ Clock Cycle Time å°±æ˜¯ 0.25 nsï¼Œä½œä¸ºå¯¹æ¯”ï¼Œæˆ‘ä»¬å¢™ä¸ŠæŒ‚é’Ÿçš„ Cycle Time æ˜¯ 1s</p><p>ä¾‹å¦‚ï¼Œè¿è¡Œä¸€æ¡åŠ æ³•æŒ‡ä»¤ä¸€èˆ¬éœ€è¦ä¸€ä¸ªæ—¶é’Ÿå‘¨æœŸæ—¶é—´</p><p><strong>CPI</strong></p><p>æœ‰çš„æŒ‡ä»¤éœ€è¦æ›´å¤šçš„æ—¶é’Ÿå‘¨æœŸæ—¶é—´ï¼Œæ‰€ä»¥å¼•å‡ºäº† CPI ï¼ˆCycles Per Instructionï¼‰æŒ‡ä»¤å¹³å‡æ—¶é’Ÿå‘¨æœŸæ•°</p><p><strong>IPC</strong></p><p>IPCï¼ˆInstruction Per Clock Cycleï¼‰ å³ CPI çš„å€’æ•°ï¼Œè¡¨ç¤ºæ¯ä¸ªæ—¶é’Ÿå‘¨æœŸèƒ½å¤Ÿè¿è¡Œçš„æŒ‡ä»¤æ•°</p><p><strong>CPU æ‰§è¡Œæ—¶é—´</strong></p><p>ç¨‹åºçš„ CPU æ‰§è¡Œæ—¶é—´ï¼Œå³æˆ‘ä»¬å‰é¢æåˆ°çš„ user + system æ—¶é—´ï¼Œå¯ä»¥ç”¨ä¸‹é¢çš„å…¬å¼æ¥è¡¨ç¤º</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ç¨‹åº CPU æ‰§è¡Œæ—¶é—´ </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> æŒ‡ä»¤æ•° </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> CPI </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Clock Cycle Time</span></span></code></pre></div><p><strong>é±¼ç½å¤´çš„æ•…äº‹</strong></p><p>åŠ å·¥ä¸€æ¡é±¼éœ€è¦ 50 åˆ†é’Ÿï¼Œåªèƒ½ä¸€æ¡é±¼ã€ä¸€æ¡é±¼é¡ºåºåŠ å·¥...</p><p><img src="'+d+'" alt="image-20230924003" loading="lazy"></p><p>å¯ä»¥å°†æ¯ä¸ªé±¼ç½å¤´çš„åŠ å·¥æµç¨‹ç»†åˆ†ä¸º 5 ä¸ªæ­¥éª¤ï¼š</p><ul><li>å»é³æ¸…æ´— 10åˆ†é’Ÿ</li><li>è’¸ç…®æ²¥æ°´ 10åˆ†é’Ÿ</li><li>åŠ æ³¨æ±¤æ–™ 10åˆ†é’Ÿ</li><li>æ€èŒå‡ºé”… 10åˆ†é’Ÿ</li><li>çœŸç©ºå°ç½ 10åˆ†é’Ÿ</li></ul><p><img src="'+g+'" alt="image-20230924006" loading="lazy"></p><p>å³ä½¿åªæœ‰ä¸€ä¸ªå·¥äººï¼Œæœ€ç†æƒ³çš„æƒ…å†µæ˜¯ï¼šä»–èƒ½å¤Ÿåœ¨ 10 åˆ†é’Ÿå†…åŒæ—¶åšå¥½è¿™ 5 ä»¶äº‹ï¼Œå› ä¸ºå¯¹ç¬¬ä¸€æ¡é±¼çš„çœŸç©ºè£…ç½ï¼Œä¸ä¼šå½±å“å¯¹ç¬¬äºŒæ¡é±¼çš„æ€èŒå‡ºé”…...</p><br><h3 id="æŒ‡ä»¤é‡æ’åºä¼˜åŒ–" tabindex="-1">æŒ‡ä»¤é‡æ’åºä¼˜åŒ– <a class="header-anchor" href="#æŒ‡ä»¤é‡æ’åºä¼˜åŒ–" aria-label="Permalink to &quot;æŒ‡ä»¤é‡æ’åºä¼˜åŒ–&quot;">â€‹</a></h3><p>äº‹å®ä¸Šï¼Œç°ä»£å¤„ç†å™¨ä¼šè®¾è®¡ä¸ºä¸€ä¸ªæ—¶é’Ÿå‘¨æœŸå®Œæˆä¸€æ¡æ‰§è¡Œæ—¶é—´æœ€é•¿çš„ CPU æŒ‡ä»¤ã€‚ä¸ºä»€ä¹ˆè¿™ä¹ˆåšå‘¢ï¼Ÿå¯ä»¥æƒ³åˆ°æŒ‡ä»¤ è¿˜å¯ä»¥å†åˆ’åˆ†æˆä¸€ä¸ªä¸ªæ›´å°çš„é˜¶æ®µï¼Œä¾‹å¦‚ï¼Œæ¯æ¡æŒ‡ä»¤éƒ½å¯ä»¥åˆ†ä¸ºï¼š <code>å–æŒ‡ä»¤ - æŒ‡ä»¤è¯‘ç  - æ‰§è¡ŒæŒ‡ä»¤ - å†…å­˜è®¿é—® - æ•°æ®å†™å›</code> è¿™ 5 ä¸ªé˜¶æ®µã€‚</p><p><img src="'+y+`" alt="image-20230924005" loading="lazy"></p><blockquote><p><strong>æœ¯è¯­å‚è€ƒ</strong>ï¼š</p><ul><li>instruction fetch (IF)</li><li>instruction decode (ID)</li><li>execute (EX)</li><li>memory access (MEM)</li><li>register write back (WB)</li></ul></blockquote><p>åœ¨ä¸æ”¹å˜ç¨‹åºç»“æœçš„å‰æä¸‹ï¼Œè¿™äº›æŒ‡ä»¤çš„å„ä¸ªé˜¶æ®µå¯ä»¥é€šè¿‡<strong>é‡æ’åº</strong>å’Œ<strong>ç»„åˆ</strong>æ¥å®ç°æŒ‡ä»¤çº§å¹¶è¡Œï¼Œè¿™ä¸€æŠ€æœ¯åœ¨ 80&#39;s ä¸­å¶åˆ° 90&#39;s ä¸­å¶å æ®äº†è®¡ç®—æ¶æ„çš„é‡è¦åœ°ä½ã€‚</p><blockquote><p><strong>æç¤º</strong>ï¼šåˆ†é˜¶æ®µï¼Œåˆ†å·¥æ˜¯æå‡æ•ˆç‡çš„å…³é”®ï¼</p></blockquote><p>æŒ‡ä»¤é‡æ’çš„å‰ææ˜¯ï¼Œé‡æ’æŒ‡ä»¤ä¸èƒ½å½±å“ç»“æœï¼Œä¾‹å¦‚</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// å¯ä»¥é‡æ’çš„ä¾‹å­</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> a </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 10</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// æŒ‡ä»¤1</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> b </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 20</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// æŒ‡ä»¤2</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">System.out.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">println</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">( a </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> b );</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ä¸èƒ½é‡æ’çš„ä¾‹å­</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> a </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 10</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// æŒ‡ä»¤1</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> b </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> a </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 5</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// æŒ‡ä»¤2</span></span></code></pre></div><blockquote><p><strong>å‚è€ƒ</strong>ï¼š</p><p><a href="https://en.wikipedia.org/wiki/Scoreboarding" target="_blank" rel="noreferrer">Scoreboarding</a> and the <a href="https://en.wikipedia.org/wiki/Tomasulo_algorithm" target="_blank" rel="noreferrer">Tomasulo algorithm</a> (which is similar to scoreboarding but makes use of <a href="https://en.wikipedia.org/wiki/Register_renaming" target="_blank" rel="noreferrer">register renaming</a> )are two of the most common techniques for implementing out-of-order execution and instruction-level parallelism.</p></blockquote><br><h3 id="æ”¯æŒæµæ°´çº¿çš„å¤„ç†å™¨" tabindex="-1">æ”¯æŒæµæ°´çº¿çš„å¤„ç†å™¨ <a class="header-anchor" href="#æ”¯æŒæµæ°´çº¿çš„å¤„ç†å™¨" aria-label="Permalink to &quot;æ”¯æŒæµæ°´çº¿çš„å¤„ç†å™¨&quot;">â€‹</a></h3><p>ç°ä»£ CPU æ”¯æŒ<strong>å¤šçº§æŒ‡ä»¤æµæ°´çº¿</strong>ï¼Œä¾‹å¦‚æ”¯æŒåŒæ—¶æ‰§è¡Œ <code>å–æŒ‡ä»¤ - æŒ‡ä»¤è¯‘ç  - æ‰§è¡ŒæŒ‡ä»¤ - å†…å­˜è®¿é—® - æ•°æ®å†™å›</code> çš„å¤„ç†å™¨ï¼Œå°±å¯ä»¥ç§°ä¹‹ä¸º<strong>äº”çº§æŒ‡ä»¤æµæ°´çº¿</strong>ã€‚è¿™æ—¶ CPU å¯ä»¥åœ¨ä¸€ä¸ªæ—¶é’Ÿå‘¨æœŸå†…ï¼ŒåŒæ—¶è¿è¡Œäº”æ¡æŒ‡ä»¤çš„ä¸åŒé˜¶æ®µï¼ˆç›¸å½“äºä¸€ æ¡æ‰§è¡Œæ—¶é—´æœ€é•¿çš„å¤æ‚æŒ‡ä»¤ï¼‰ï¼ŒIPC = 1ï¼Œæœ¬è´¨ä¸Šï¼Œæµæ°´çº¿æŠ€æœ¯å¹¶ä¸èƒ½ç¼©çŸ­å•æ¡æŒ‡ä»¤çš„æ‰§è¡Œæ—¶é—´ï¼Œä½†å®ƒå˜ç›¸åœ°æé«˜äº†æŒ‡ä»¤åœ°ååç‡ã€‚</p><blockquote><p><strong>æç¤º</strong>ï¼š</p><p>å¥”è…¾å››ï¼ˆPentium 4ï¼‰æ”¯æŒé«˜è¾¾ 35 çº§æµæ°´çº¿ï¼Œä½†ç”±äºåŠŸè€—å¤ªé«˜è¢«åºŸå¼ƒ</p></blockquote><p><img src="`+F+'" alt="image-20230924007" loading="lazy"></p><br><h3 id="superscalar-å¤„ç†å™¨" tabindex="-1">SuperScalar å¤„ç†å™¨ <a class="header-anchor" href="#superscalar-å¤„ç†å™¨" aria-label="Permalink to &quot;SuperScalar å¤„ç†å™¨&quot;">â€‹</a></h3><p>å¤§å¤šæ•°å¤„ç†å™¨åŒ…å«å¤šä¸ªæ‰§è¡Œå•å…ƒï¼Œå¹¶ä¸æ˜¯æ‰€æœ‰è®¡ç®—åŠŸèƒ½éƒ½é›†ä¸­åœ¨ä¸€èµ·ï¼Œå¯ä»¥å†ç»†åˆ†ä¸ºæ•´æ•°è¿ç®—å•å…ƒã€æµ®ç‚¹æ•°è¿ç®—å•å…ƒç­‰ï¼Œè¿™æ ·å¯ä»¥æŠŠå¤šæ¡æŒ‡ä»¤ä¹Ÿå¯ä»¥åšåˆ°å¹¶è¡Œè·å–ã€è¯‘ç ç­‰ï¼ŒCPU å¯ä»¥åœ¨ä¸€ä¸ªæ—¶é’Ÿå‘¨æœŸå†…ï¼Œæ‰§è¡Œå¤šäºä¸€æ¡æŒ‡ä»¤ï¼ŒIPC &gt; 1ã€‚</p><p><img src="'+c+'" alt="image-20230924009" loading="lazy"></p><p><img src="'+o+`" alt="image-20230924008" loading="lazy"></p><br><h2 id="åŸç†ä¹‹-volatile" tabindex="-1">* åŸç†ä¹‹ volatile <a class="header-anchor" href="#åŸç†ä¹‹-volatile" aria-label="Permalink to &quot;* åŸç†ä¹‹ volatile&quot;">â€‹</a></h2><h3 id="æŒ‡ä»¤é‡æ’" tabindex="-1">æŒ‡ä»¤é‡æ’ <a class="header-anchor" href="#æŒ‡ä»¤é‡æ’" aria-label="Permalink to &quot;æŒ‡ä»¤é‡æ’&quot;">â€‹</a></h3><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> num </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">boolean</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ready </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// çº¿ç¨‹1 æ‰§è¡Œæ­¤æ–¹æ³•</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> actor1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(I_Result r) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(ready) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        r.r1 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> num </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> num;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">else</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        r.r1 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// çº¿ç¨‹2 æ‰§è¡Œæ­¤æ–¹æ³•</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> actor2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(I_Result r) { </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    num </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ready </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>I_Result æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œæœ‰ä¸€ä¸ªå±æ€§ r1 ç”¨æ¥ä¿å­˜ç»“æœï¼Œé—®ï¼Œå¯èƒ½çš„ç»“æœæœ‰å‡ ç§ï¼Ÿ</p><p>æœ‰åŒå­¦è¿™ä¹ˆåˆ†æ</p><p>æƒ…å†µ1ï¼šçº¿ç¨‹1 å…ˆæ‰§è¡Œï¼Œè¿™æ—¶ ready = falseï¼Œæ‰€ä»¥è¿›å…¥ else åˆ†æ”¯ç»“æœä¸º 1</p><p>æƒ…å†µ2ï¼šçº¿ç¨‹2 å…ˆæ‰§è¡Œ num = 2ï¼Œä½†æ²¡æ¥å¾—åŠæ‰§è¡Œ ready = trueï¼Œçº¿ç¨‹1 æ‰§è¡Œï¼Œè¿˜æ˜¯è¿›å…¥ else åˆ†æ”¯ï¼Œç»“æœä¸º1</p><p>æƒ…å†µ3ï¼šçº¿ç¨‹2 æ‰§è¡Œåˆ° ready = trueï¼Œçº¿ç¨‹1 æ‰§è¡Œï¼Œè¿™å›è¿›å…¥ if åˆ†æ”¯ï¼Œç»“æœä¸º 4ï¼ˆå› ä¸º num å·²ç»æ‰§è¡Œè¿‡äº†ï¼‰</p><br><p>ä½†æˆ‘å‘Šè¯‰ä½ ï¼Œç»“æœè¿˜æœ‰å¯èƒ½æ˜¯ 0 ğŸ˜ğŸ˜ğŸ˜ï¼Œä¿¡ä¸ä¿¡å§ï¼</p><p>è¿™ç§æƒ…å†µä¸‹æ˜¯ï¼šçº¿ç¨‹2 æ‰§è¡Œ ready = trueï¼Œåˆ‡æ¢åˆ°çº¿ç¨‹1ï¼Œè¿›å…¥ if åˆ†æ”¯ï¼Œç›¸åŠ ä¸º 0ï¼Œå†åˆ‡å›çº¿ç¨‹2 æ‰§è¡Œ num = 2</p><p>ç›¸ä¿¡å¾ˆå¤šäººå·²ç»æ™•äº† ğŸ˜µğŸ˜µğŸ˜µ</p><br><p>è¿™ç§ç°è±¡å«åšæŒ‡ä»¤é‡æ’ï¼Œæ˜¯ JIT ç¼–è¯‘å™¨åœ¨è¿è¡Œæ—¶çš„ä¸€äº›ä¼˜åŒ–ï¼Œè¿™ä¸ªç°è±¡éœ€è¦é€šè¿‡å¤§é‡æµ‹è¯•æ‰èƒ½å¤ç°ï¼š</p><p>å€ŸåŠ© java å¹¶å‘å‹æµ‹å·¥å…· jcstress <a href="https://wiki.openjdk.java.net/display/CodeTools/jcstress" target="_blank" rel="noreferrer">https://wiki.openjdk.java.net/display/CodeTools/jcstress</a></p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">mvn</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> archetype:generate -DinteractiveMode=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">false</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> -DarchetypeGroupId=org.openjdk.jcstress -</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">DarchetypeArtifactId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">jcstress-java-test-archetype -DarchetypeVersion=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0.5</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> -DgroupId=cn.itcast -</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">DartifactId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">ordering -Dversion=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1.0</span></span></code></pre></div><p>åˆ›å»º maven é¡¹ç›®ï¼Œæä¾›å¦‚ä¸‹æµ‹è¯•ç±»</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">JCStressTest</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Outcome</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">id</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;1&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;4&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">expect</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Expect.ACCEPTABLE, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">desc</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;ok&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Outcome</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">id</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;0&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">expect</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Expect.ACCEPTABLE_INTERESTING, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">desc</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;!!!!&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">State</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ConcurrencyTest</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> num </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    boolean</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ready </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Actor</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> actor1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(I_Result </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">r</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(ready) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            r.r1 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> num </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> num;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">else</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            r.r1 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    } </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Actor</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> actor2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(I_Result </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">r</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        num </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        ready </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>æ‰§è¡Œ</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">mvn</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> clean install </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">java</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -jar</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> target/jcstress.jar</span></span></code></pre></div><p>ä¼šè¾“å‡ºæˆ‘ä»¬æ„Ÿå…´è¶£çš„ç»“æœï¼Œæ‘˜å½•å…¶ä¸­ä¸€æ¬¡ç»“æœï¼š</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">***</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> INTERESTING tests </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Some</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> interesting behaviors observed. This is for the plain curiosity. </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> 2</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> matching test results. </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> 	[OK] </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">test</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.ConcurrencyTest </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> 	(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">JVM</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> args: [-XX:-TieredCompilation]</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    Observed</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> state 	Occurrences 	Expectation Interpretation </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    0</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 				1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">,729 			ACCEPTABLE_INTERESTING !!!! </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> 	1</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 				42</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">,617,915 		ACCEPTABLE ok </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> 	4</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 				5</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">,146,627 		ACCEPTABLE ok </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> 	[OK] </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">test</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.ConcurrencyTest </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> 	(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">JVM</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> args: []</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> 	Observed</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> state 	Occurrences 	Expectation Interpretation </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> 	0</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 				1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">,652 			ACCEPTABLE_INTERESTING !!!! </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> 	1</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 				46</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">,460,657 		ACCEPTABLE ok </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> 	4</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 				4</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">,571,072 		ACCEPTABLE ok</span></span></code></pre></div><p>å¯ä»¥çœ‹åˆ°ï¼Œå‡ºç°ç»“æœä¸º 0 çš„æƒ…å†µæœ‰ 638 æ¬¡ï¼Œè™½ç„¶æ¬¡æ•°ç›¸å¯¹å¾ˆå°‘ï¼Œä½†æ¯•ç«Ÿæ˜¯å‡ºç°äº†ã€‚</p><br><h3 id="è§£å†³æ–¹æ³•" tabindex="-1">è§£å†³æ–¹æ³• <a class="header-anchor" href="#è§£å†³æ–¹æ³•" aria-label="Permalink to &quot;è§£å†³æ–¹æ³•&quot;">â€‹</a></h3><p>volatile ä¿®é¥°çš„å˜é‡ï¼Œå¯ä»¥ç¦ç”¨æŒ‡ä»¤é‡æ’</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">JCStressTest</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Outcome</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">id</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;1&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;4&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">expect</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Expect.ACCEPTABLE, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">desc</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;ok&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Outcome</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">id</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;0&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">expect</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Expect.ACCEPTABLE_INTERESTING, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">desc</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;!!!!&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">State</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ConcurrencyTest</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> num </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    volatile</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> boolean</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ready </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Actor</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> actor1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(I_Result </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">r</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(ready) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            r.r1 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> num </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> num;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">else</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            r.r1 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Actor</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> actor2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(I_Result </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">r</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        num </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        ready </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>ç»“æœä¸ºï¼š</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">***</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> INTERESTING tests </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Some</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> interesting behaviors observed. This is for the plain curiosity. </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> 0</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> matching test results.</span></span></code></pre></div><br><p>volatile çš„åº•å±‚å®ç°åŸç†æ˜¯å†…å­˜å±éšœï¼ŒMemory Barrierï¼ˆMemory Fenceï¼‰</p><ul><li>å¯¹ volatile å˜é‡çš„å†™æŒ‡ä»¤åä¼šåŠ å…¥å†™å±éšœ</li><li>å¯¹ volatile å˜é‡çš„è¯»æŒ‡ä»¤å‰ä¼šåŠ å…¥è¯»å±éšœ</li></ul><br><h3 id="å¦‚ä½•ä¿è¯å¯è§æ€§" tabindex="-1">å¦‚ä½•ä¿è¯å¯è§æ€§ <a class="header-anchor" href="#å¦‚ä½•ä¿è¯å¯è§æ€§" aria-label="Permalink to &quot;å¦‚ä½•ä¿è¯å¯è§æ€§&quot;">â€‹</a></h3><ul><li><p>å†™å±éšœï¼ˆsfenceï¼‰ä¿è¯åœ¨è¯¥å±éšœä¹‹å‰çš„ï¼Œå¯¹å…±äº«å˜é‡çš„æ”¹åŠ¨ï¼Œéƒ½åŒæ­¥åˆ°ä¸»å­˜å½“ä¸­</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> actor2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(I_Result r) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    num </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ready </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ready æ˜¯ volatile èµ‹å€¼å¸¦å†™å±éšœ</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // å†™å±éšœ</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div></li><li><p>è€Œè¯»å±éšœï¼ˆlfenceï¼‰ä¿è¯åœ¨è¯¥å±éšœä¹‹åï¼Œå¯¹å…±äº«å˜é‡çš„è¯»å–ï¼ŒåŠ è½½çš„æ˜¯ä¸»å­˜ä¸­æœ€æ–°æ•°æ®</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> actor1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(I_Result r) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // è¯»å±éšœ</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // ready æ˜¯ volatile è¯»å–å€¼å¸¦è¯»å±éšœ</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(ready) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        r.r1 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> num </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> num;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">else</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        r.r1 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div></li></ul><p>æµæ°´çº¿</p>`,78),u=k(`<h3 id="å¦‚ä½•ä¿è¯æœ‰åºæ€§" tabindex="-1">å¦‚ä½•ä¿è¯æœ‰åºæ€§ <a class="header-anchor" href="#å¦‚ä½•ä¿è¯æœ‰åºæ€§" aria-label="Permalink to &quot;å¦‚ä½•ä¿è¯æœ‰åºæ€§&quot;">â€‹</a></h3><ul><li><p>å†™å±éšœä¼šç¡®ä¿æŒ‡ä»¤é‡æ’åºæ—¶ï¼Œä¸ä¼šå°†å†™å±éšœä¹‹å‰çš„ä»£ç æ’åœ¨å†™å±éšœä¹‹å</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> actor2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(I_Result r) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    num </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ready </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ready æ˜¯ volatile èµ‹å€¼å¸¦å†™å±éšœ</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // å†™å±éšœ</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div></li><li><p>è¯»å±éšœä¼šç¡®ä¿æŒ‡ä»¤é‡æ’åºæ—¶ï¼Œä¸ä¼šå°†è¯»å±éšœä¹‹åçš„ä»£ç æ’åœ¨è¯»å±éšœä¹‹å‰</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> actor1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(I_Result r) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // è¯»å±éšœ</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // ready æ˜¯ volatile è¯»å–å€¼å¸¦è¯»å±éšœ</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(ready) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        r.r1 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> num </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> num;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">else</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        r.r1 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div></li></ul><p>æµç¨‹å›¾</p>`,3),B=p("br",null,null,-1),D=p("p",null,"è¿˜æ˜¯é‚£å¥è¯ï¼Œä¸èƒ½è§£å†³æŒ‡ä»¤äº¤é”™ï¼š",-1),v=p("ul",null,[p("li",null,"å†™å±éšœä»…ä»…æ˜¯ä¿è¯ä¹‹åçš„è¯»èƒ½å¤Ÿè¯»åˆ°æœ€æ–°çš„ç»“æœï¼Œä½†ä¸èƒ½ä¿è¯è¯»è·‘åˆ°å®ƒå‰é¢å»"),p("li",null,"è€Œæœ‰åºæ€§çš„ä¿è¯ä¹Ÿåªæ˜¯ä¿è¯äº†æœ¬çº¿ç¨‹å†…ç›¸å…³ä»£ç ä¸è¢«é‡æ’åº")],-1),b=k(`<div class="warning custom-block"><p class="custom-block-title">ğŸ’¡æ€è€ƒï¼šè°ˆè°ˆä½ å¯¹volatileçš„ç†è§£</p><p>volatileæ˜¯ä¸€ä¸ªå…³é”®å­—ï¼Œå¯ä»¥ä¿®é¥°ç±»çš„æˆå‘˜å˜é‡ã€ç±»çš„é™æ€æˆå‘˜å˜é‡ï¼Œä¸»è¦æœ‰ä¸¤ä¸ªåŠŸèƒ½ã€‚</p><ul><li>ä¿è¯äº†çº¿ç¨‹é—´çš„å¯è§æ€§ï¼šç”¨ volatile ä¿®é¥°å…±äº«å˜é‡ï¼Œèƒ½å¤Ÿé˜²æ­¢ç¼–è¯‘å™¨ç­‰ä¼˜åŒ–å‘ç”Ÿï¼Œè®©ä¸€ä¸ªçº¿ç¨‹å¯¹å…±äº«å˜é‡çš„ä¿®æ”¹å¯¹å¦ä¸€ä¸ªçº¿ç¨‹å¯è§ã€‚</li><li>ç¦æ­¢è¿›è¡ŒæŒ‡ä»¤é‡æ’åºï¼Œç”¨ volatile ä¿®é¥°å˜é‡ä¼šåœ¨è¯»ã€å†™å…±äº«å˜é‡æ—¶åŠ å…¥è¯»å†™å±éšœï¼Œé˜»æ­¢å…¶ä»–è¯»å†™æ“ä½œè¶Šè¿‡å±éšœï¼Œä»è€Œè¾¾åˆ°é˜»æ­¢é‡æ’åºçš„æ•ˆæœã€‚</li></ul></div><br><h3 id="double-checked-locking-é—®é¢˜" tabindex="-1">double-checked locking é—®é¢˜ <a class="header-anchor" href="#double-checked-locking-é—®é¢˜" aria-label="Permalink to &quot;double-checked locking é—®é¢˜&quot;">â€‹</a></h3><p>ä»¥è‘—åçš„ double-checked locking å•ä¾‹æ¨¡å¼ä¸ºä¾‹</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> final</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Singleton</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    private</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Singleton</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    private</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> static</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Singleton INSTANCE </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> static</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Singleton </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getInstance</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (INSTANCE </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) { </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// t2</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">            // é¦–æ¬¡è®¿é—®ä¼šåŒæ­¥ï¼Œè€Œä¹‹åçš„ä½¿ç”¨æ²¡æœ‰ synchronized</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            synchronized</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (Singleton.class) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">                if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (INSTANCE </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) { </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// t1</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                    INSTANCE </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Singleton</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> INSTANCE;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>ä»¥ä¸Šçš„å®ç°ç‰¹ç‚¹æ˜¯ï¼š</p><ul><li>æ‡’æƒ°å®ä¾‹åŒ–</li><li>é¦–æ¬¡ä½¿ç”¨ getInstance() æ‰ä½¿ç”¨ synchronized åŠ é”ï¼Œåç»­ä½¿ç”¨æ—¶æ— éœ€åŠ é”</li><li>æœ‰éšå«çš„ï¼Œä½†å¾ˆå…³é”®çš„ä¸€ç‚¹ï¼šç¬¬ä¸€ä¸ª if ä½¿ç”¨äº† INSTANCE å˜é‡ï¼Œæ˜¯åœ¨åŒæ­¥å—ä¹‹å¤–</li></ul><p>ä½†åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œä¸Šé¢çš„ä»£ç æ˜¯æœ‰é—®é¢˜çš„ï¼ŒgetInstance æ–¹æ³•å¯¹åº”çš„å­—èŠ‚ç ä¸ºï¼š</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">public</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> static org.itcast.test.Singleton getInstance</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    descriptor:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ()Lorg/itcast/test/Singleton;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    flags:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ACC_PUBLIC, ACC_STATIC</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    Code:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      stack</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">, locals=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">, args_size=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">         0:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> getstatic     #2                  // Field INSTANCE:Lorg/itcast/test/Singleton</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">         3:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ifnonnull     </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">37</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">         6:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ldc           #3                  // class org/itcast/test/Singleton</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">         8:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> dup</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">         9:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> astore_0</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        10:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> monitorenter</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        11:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> getstatic     #2                  // Field INSTANCE:Lorg/itcast/test/Singleton</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        14:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ifnonnull     </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">27</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        17:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> new           #3                  // class org/itcast/test/Singleton</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        20:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> dup</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        21:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> invokespecial #4                  // Method &quot;&lt;init&gt;&quot;:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">V</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        24:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> putstatic     #2                  // Field INSTANCE:Lorg/itcast/test/Singleton</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        27:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> aload_0</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        28:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> monitorexit</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        29:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> goto          </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">37</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        32:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> astore_1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        33:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> aload_0</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        34:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> monitorexit</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        35:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> aload_1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        36:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> athrow</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        37:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> getstatic     #2                  // Field INSTANCE:Lorg/itcast/test/Singleton</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        40:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> areturn</span></span></code></pre></div><p>å…¶ä¸­</p><ul><li>17 è¡¨ç¤ºåˆ›å»ºå¯¹è±¡ï¼Œå°†å¯¹è±¡å¼•ç”¨å…¥æ ˆ // new Singleton</li><li>20 è¡¨ç¤ºå¤åˆ¶ä¸€ä»½å¯¹è±¡å¼•ç”¨ // å¼•ç”¨åœ°å€</li><li>21 è¡¨ç¤ºåˆ©ç”¨ä¸€ä¸ªå¯¹è±¡å¼•ç”¨ï¼Œè°ƒç”¨æ„é€ æ–¹æ³•</li><li>24 è¡¨ç¤ºåˆ©ç”¨ä¸€ä¸ªå¯¹è±¡å¼•ç”¨ï¼Œèµ‹å€¼ç»™ static INSTANCE</li></ul><p>ä¹Ÿè®¸ jvm ä¼šä¼˜åŒ–ä¸ºï¼šå…ˆæ‰§è¡Œ 24ï¼Œå†æ‰§è¡Œ 21ã€‚å¦‚æœä¸¤ä¸ªçº¿ç¨‹ t1ï¼Œt2 æŒ‰å¦‚ä¸‹æ—¶é—´åºåˆ—æ‰§è¡Œï¼š</p>`,12),m=k(`<p>å…³é”®åœ¨äº 0: getstatic è¿™è¡Œä»£ç åœ¨ monitor æ§åˆ¶ä¹‹å¤–ï¼Œå®ƒå°±åƒä¹‹å‰ä¸¾ä¾‹ä¸­ä¸å®ˆè§„åˆ™çš„äººï¼Œå¯ä»¥è¶Šè¿‡ monitor è¯»å– INSTANCE å˜é‡çš„å€¼ã€‚è¿™æ—¶ t1 è¿˜æœªå®Œå…¨å°†æ„é€ æ–¹æ³•æ‰§è¡Œå®Œæ¯•ï¼Œå¦‚æœåœ¨æ„é€ æ–¹æ³•ä¸­è¦æ‰§è¡Œå¾ˆå¤šåˆå§‹åŒ–æ“ä½œï¼Œé‚£ä¹ˆ t2 æ‹¿åˆ°çš„æ˜¯å°†æ˜¯ä¸€ä¸ªæœªåˆå§‹åŒ–å®Œæ¯•çš„å•ä¾‹ ã€‚å¯¹ INSTANCE ä½¿ç”¨ volatile ä¿®é¥°å³å¯ï¼Œå¯ä»¥ç¦ç”¨æŒ‡ä»¤é‡æ’ï¼Œä½†è¦æ³¨æ„åœ¨ JDK 5 ä»¥ä¸Šçš„ç‰ˆæœ¬çš„ volatile æ‰ä¼šçœŸæ­£æœ‰æ•ˆ</p><br><h3 id="double-checked-locking-è§£å†³" tabindex="-1">double-checked locking è§£å†³ <a class="header-anchor" href="#double-checked-locking-è§£å†³" aria-label="Permalink to &quot;double-checked locking è§£å†³&quot;">â€‹</a></h3><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> final</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Singleton</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    private</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Singleton</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() { }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    private</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> volatile</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Singleton INSTANCE </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> static</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Singleton </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getInstance</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // å®ä¾‹æ²¡åˆ›å»ºï¼Œæ‰ä¼šè¿›å…¥å†…éƒ¨çš„ synchronizedä»£ç å—</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (INSTANCE </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) { </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            synchronized</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (Singleton.class) { </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// t2</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                // ä¹Ÿè®¸æœ‰å…¶å®ƒçº¿ç¨‹å·²ç»åˆ›å»ºå®ä¾‹ï¼Œæ‰€ä»¥å†åˆ¤æ–­ä¸€æ¬¡</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">                if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (INSTANCE </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) { </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// t1</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                    INSTANCE </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Singleton</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> INSTANCE;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>å­—èŠ‚ç ä¸Šçœ‹ä¸å‡ºæ¥ volatile æŒ‡ä»¤çš„æ•ˆæœ</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> static</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> org.itcast.test.Singleton </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getInstance</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    descriptor</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ()Lorg</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">/</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">itcast</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">/</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">test</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">/</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Singleton;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    flags</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ACC_PUBLIC, ACC_STATIC</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    Code</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      stack</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, locals</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, args_size</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">         // åŠ å…¥å¯¹ INSTANCE å˜é‡çš„è¯»å±éšœ</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">         0</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> getstatic     #</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                  // Field INSTANCE:Lorg/itcast/test/Singleton;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">         3</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ifnonnull     </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">37</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">         6</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ldc           #</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                  // class org/itcast/test/Singleton</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">         8</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> dup</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">         9</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> astore_0</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        //  ä¿è¯åŸå­æ€§ã€å¯è§æ€§</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        10</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> monitorenter</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        11</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> getstatic     #</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                  // Field INSTANCE:Lorg/itcast/test/Singleton;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        14</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ifnonnull     </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">27</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        17</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">           #3                  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// class org/itcast/test/Singleton</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        20</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> dup</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        21</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> invokespecial #</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">4</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                  // Method &quot;&lt;init&gt;&quot;:()V</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        //  åŠ å…¥å¯¹ INSTANCE å˜é‡çš„å†™å±éšœ</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        24</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> putstatic     #</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                  // Field INSTANCE:Lorg/itcast/test/Singleton;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        27</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> aload_0</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        //  ä¿è¯åŸå­æ€§ã€å¯è§æ€§</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        28</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> monitorexit</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        29</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> goto</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">          37</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        32</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> astore_1</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        33</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> aload_0</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        34</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> monitorexit</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        35</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> aload_1</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        36</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> athrow</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        37</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> getstatic     #</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                  // Field INSTANCE:Lorg/itcast/test/Singleton;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        40</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> areturn</span></span></code></pre></div><p>å¦‚ä¸Šé¢çš„æ³¨é‡Šå†…å®¹æ‰€ç¤ºï¼Œè¯»å†™ volatile å˜é‡æ—¶ä¼šåŠ å…¥å†…å­˜å±éšœï¼ˆMemory Barrierï¼ˆMemory Fenceï¼‰ï¼‰ï¼Œä¿è¯ä¸‹é¢ä¸¤ç‚¹ï¼š</p><ul><li>å¯è§æ€§ <ul><li>å†™å±éšœï¼ˆsfenceï¼‰ä¿è¯åœ¨è¯¥å±éšœä¹‹å‰çš„ t1 å¯¹å…±äº«å˜é‡çš„æ”¹åŠ¨ï¼Œéƒ½åŒæ­¥åˆ°ä¸»å­˜å½“ä¸­</li><li>è€Œè¯»å±éšœï¼ˆlfenceï¼‰ä¿è¯åœ¨è¯¥å±éšœä¹‹å t2 å¯¹å…±äº«å˜é‡çš„è¯»å–ï¼ŒåŠ è½½çš„æ˜¯ä¸»å­˜ä¸­æœ€æ–°æ•°æ®</li></ul></li><li>æœ‰åºæ€§ <ul><li>å†™å±éšœä¼šç¡®ä¿æŒ‡ä»¤é‡æ’åºæ—¶ï¼Œä¸ä¼šå°†å†™å±éšœä¹‹å‰çš„ä»£ç æ’åœ¨å†™å±éšœä¹‹å</li><li>è¯»å±éšœä¼šç¡®ä¿æŒ‡ä»¤é‡æ’åºæ—¶ï¼Œä¸ä¼šå°†è¯»å±éšœä¹‹åçš„ä»£ç æ’åœ¨è¯»å±éšœä¹‹å‰</li></ul></li><li>æ›´åº•å±‚æ˜¯è¯»å†™å˜é‡æ—¶ä½¿ç”¨ lock æŒ‡ä»¤æ¥å¤šæ ¸ CPU ä¹‹é—´çš„å¯è§æ€§ä¸æœ‰åºæ€§</li></ul><p>æµç¨‹å›¾</p>`,9),_=k(`<br><h3 id="happens-before" tabindex="-1">happens-before <a class="header-anchor" href="#happens-before" aria-label="Permalink to &quot;happens-before&quot;">â€‹</a></h3><p>happens-beforeï¼ˆå…ˆå‘åŸåˆ™ï¼‰ è§„å®šäº†å¯¹å…±äº«å˜é‡çš„å†™æ“ä½œå¯¹å…¶å®ƒçº¿ç¨‹çš„è¯»æ“ä½œå¯è§ï¼Œå®ƒæ˜¯å¯è§æ€§ä¸æœ‰åºæ€§çš„ä¸€å¥—è§„åˆ™æ€»ç»“ï¼ŒæŠ›å¼€ä»¥ä¸‹ happens-before è§„åˆ™ï¼ŒJMM å¹¶ä¸èƒ½ä¿è¯ä¸€ä¸ªçº¿ç¨‹å¯¹å…±äº«å˜é‡çš„å†™ï¼Œå¯¹äºå…¶å®ƒçº¿ç¨‹å¯¹è¯¥å…±äº«å˜é‡çš„è¯»å¯è§</p><ul><li><p>çº¿ç¨‹è§£é” m ä¹‹å‰å¯¹å˜é‡çš„å†™ï¼Œå¯¹äºæ¥ä¸‹æ¥å¯¹ m åŠ é”çš„å…¶å®ƒçº¿ç¨‹å¯¹è¯¥å˜é‡çš„è¯»å¯è§(synchronizedå…³é”®å­—çš„å¯è§æ€§ã€ç›‘è§†å™¨è§„åˆ™)</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> x;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">static</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Object m </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Object</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Thread</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(()</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    synchronized</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(m) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        x </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 10</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">},</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;t1&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">start</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Thread</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(()</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    synchronized</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(m) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        System.out.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">println</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(x);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">},</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;t2&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">start</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span></code></pre></div></li><li><p>çº¿ç¨‹å¯¹ volatile å˜é‡çš„å†™ï¼Œå¯¹æ¥ä¸‹æ¥å…¶å®ƒçº¿ç¨‹å¯¹è¯¥å˜é‡çš„è¯»å¯è§(volatileå…³é”®å­—çš„å¯è§æ€§ã€volatileè§„åˆ™)</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">volatile</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> x;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Thread</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(()</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    x </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 10</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">},</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;t1&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">start</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Thread</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(()</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    System.out.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">println</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(x);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">},</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;t2&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">start</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span></code></pre></div></li><li><p>çº¿ç¨‹ start å‰å¯¹å˜é‡çš„å†™ï¼Œå¯¹è¯¥çº¿ç¨‹å¼€å§‹åå¯¹è¯¥å˜é‡çš„è¯»å¯è§(ç¨‹åºé¡ºåºè§„åˆ™+çº¿ç¨‹å¯åŠ¨è§„åˆ™)</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> x;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">x </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 10</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Thread</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(()</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    System.out.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">println</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(x);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">},</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;t2&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">start</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span></code></pre></div></li><li><p>çº¿ç¨‹ç»“æŸå‰å¯¹å˜é‡çš„å†™ï¼Œå¯¹å…¶å®ƒçº¿ç¨‹å¾—çŸ¥å®ƒç»“æŸåçš„è¯»å¯è§ï¼ˆæ¯”å¦‚å…¶å®ƒçº¿ç¨‹è°ƒç”¨ t1.isAlive() æˆ– t1.join()ç­‰å¾…å®ƒç»“æŸï¼‰(çº¿ç¨‹ç»ˆæ­¢è§„åˆ™)</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> x;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Thread t1 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Thread</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(()</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    x </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 10</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">},</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;t1&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">t1.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">start</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">t1.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">join</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">System.out.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">println</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(x);</span></span></code></pre></div></li><li><p>çº¿ç¨‹ t1 æ‰“æ–­ t2ï¼ˆinterruptï¼‰å‰å¯¹å˜é‡çš„å†™ï¼Œå¯¹äºå…¶ä»–çº¿ç¨‹å¾—çŸ¥ t2 è¢«æ‰“æ–­åå¯¹å˜é‡çš„è¯»å¯è§ï¼ˆé€šè¿‡ t2.interrupted æˆ– t2.isInterruptedï¼‰ï¼ˆçº¿ç¨‹ä¸­æ–­æœºåˆ¶ï¼‰</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> x;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> main</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">String</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[] args) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    Thread t2 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Thread</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(()</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        while</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(Thread.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">currentThread</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">isInterrupted</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                System.out.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">println</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(x);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">                break</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    },</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;t2&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    t2.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">start</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Thread</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(()</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        sleep</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        x </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 10</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        t2.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">interrupt</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    },</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;t1&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">start</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    while</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">t2.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">isInterrupted</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        Thread.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">yield</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    System.out.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">println</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(x);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div></li><li><p>å¯¹å˜é‡é»˜è®¤å€¼ï¼ˆ0ï¼Œfalseï¼Œnullï¼‰çš„å†™ï¼Œå¯¹å…¶å®ƒçº¿ç¨‹å¯¹è¯¥å˜é‡çš„è¯»å¯è§</p></li><li><p>å…·æœ‰ä¼ é€’æ€§ï¼Œå¦‚æœ <code>x -&gt; y</code> å¹¶ä¸” <code>y -&gt; z</code> é‚£ä¹ˆæœ‰ <code>x -&gt; z</code> ï¼Œé…åˆ volatile çš„é˜²æŒ‡ä»¤é‡æ’ï¼Œæœ‰ä¸‹é¢çš„ä¾‹å­</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">volatile</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> x;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> y;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Thread</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(()</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{ </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    y </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 10</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    x </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 20</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">},</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;t1&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">start</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Thread</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(()</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // x=20 å¯¹ t2 å¯è§, åŒæ—¶ y=10 ä¹Ÿå¯¹ t2 å¯è§</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    System.out.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">println</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(x); </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">},</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;t2&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">start</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span></code></pre></div><div class="tip custom-block"><p class="custom-block-title">ğŸ’¡æ€»ç»“</p><p>åœ¨JMMä¸­æœ‰ä¸€ä¸ªå¾ˆé‡è¦çš„æ¦‚å¿µå¯¹äºæˆ‘ä»¬äº†è§£JMMæœ‰å¾ˆå¤§çš„å¸®åŠ©ï¼Œé‚£å°±æ˜¯ <code>happens-before</code> è§„åˆ™ã€‚<code>happens-before</code> è§„åˆ™éå¸¸é‡è¦ï¼Œå®ƒæ˜¯åˆ¤æ–­æ•°æ®æ˜¯å¦å­˜åœ¨ç«äº‰ã€çº¿ç¨‹æ˜¯å¦å®‰å…¨çš„ä¸»è¦ä¾æ®ã€‚JSR-133Sä½¿ç”¨ <code>happens-before</code> æ¦‚å¿µé˜è¿°äº†ä¸¤ä¸ªæ“ä½œä¹‹é—´çš„å†…å­˜å¯è§æ€§ã€‚åœ¨JMMä¸­ï¼Œå¦‚æœä¸€ä¸ªæ“ä½œçš„ç»“æœéœ€è¦å¯¹å¦ä¸€ä¸ªæ“ä½œå¯è§ï¼Œé‚£ä¹ˆè¿™ä¸¤ä¸ªæ“ä½œåˆ™å­˜åœ¨happens-beforeå…³ç³»ã€‚</p><p>é‚£ä»€ä¹ˆæ˜¯ <code>happens-before</code> å‘¢ï¼Ÿåœ¨JSR-133ä¸­ï¼Œ<code>happens-before</code> å…³ç³»å®šä¹‰å¦‚ä¸‹ï¼š</p><ol><li>å¦‚æœä¸€ä¸ªæ“ä½œ <code>happens-before</code> å¦ä¸€ä¸ªæ“ä½œï¼Œé‚£ä¹ˆæ„å‘³ç€ç¬¬ä¸€ä¸ªæ“ä½œçš„ç»“æœå¯¹ç¬¬äºŒä¸ªæ“ä½œå¯è§ï¼Œè€Œä¸”ç¬¬ä¸€ä¸ªæ“ä½œçš„æ‰§è¡Œé¡ºåºå°†æ’åœ¨ç¬¬äºŒä¸ªæ“ä½œçš„å‰é¢ã€‚</li><li>ä¸¤ä¸ªæ“ä½œä¹‹é—´å­˜åœ¨ <code>happens-before</code>å…³ç³»ï¼Œå¹¶ä¸æ„å‘³ç€Javaå¹³å°çš„å…·ä½“å®ç°å¿…é¡»æŒ‰ç…§<code>happens-before</code>å…³ç³»æŒ‡å®šçš„é¡ºåºæ¥æ‰§è¡Œã€‚å¦‚æœé‡æ’åºä¹‹åçš„ç»“æœï¼Œä¸æŒ‰ç…§ <code>happens-before</code> å…³ç³»æ¥æ‰§è¡Œçš„ç»“æœä¸€è‡´ï¼Œé‚£ä¹ˆè¿™ç§é‡æ’åºå¹¶ä¸éæ³•ï¼ˆä¹Ÿå°±æ˜¯è¯´ï¼ŒJMMå…è®¸è¿™ç§é‡æ’åºï¼‰</li></ol><p>happens-beforeè§„åˆ™å¦‚ä¸‹ï¼š</p><ol><li>ç¨‹åºé¡ºåºè§„åˆ™ï¼šä¸€ä¸ªçº¿ç¨‹ä¸­çš„æ¯ä¸€ä¸ªæ“ä½œï¼Œhappens-beforeäºè¯¥çº¿ç¨‹ä¸­çš„ä»»æ„åç»­æ“ä½œã€‚</li><li>ç›‘è§†å™¨è§„åˆ™ï¼šå¯¹ä¸€ä¸ªé”çš„è§£é”ï¼Œhappens-beforeäºéšåå¯¹è¿™ä¸ªé”çš„åŠ é”ã€‚</li><li>volatileè§„åˆ™ï¼šå¯¹ä¸€ä¸ªvolatileå˜é‡çš„å†™ï¼Œhappens-beforeäºä»»æ„åç»­å¯¹ä¸€ä¸ªvolatileå˜é‡çš„è¯»ã€‚</li><li>ä¼ é€’æ€§ï¼šè‹¥æœA happens-before Bï¼ŒB happens-before Cï¼Œé‚£ä¹ˆA happens-before Cã€‚</li><li>çº¿ç¨‹å¯åŠ¨è§„åˆ™ï¼šThreadå¯¹è±¡çš„start()æ–¹æ³•ï¼Œhappens-beforeäºè¿™ä¸ªçº¿ç¨‹çš„ä»»æ„åç»­æ“ä½œã€‚</li><li>çº¿ç¨‹ç»ˆæ­¢è§„åˆ™ï¼šçº¿ç¨‹ä¸­çš„ä»»æ„æ“ä½œï¼Œhappens-beforeäºè¯¥çº¿ç¨‹çš„ç»ˆæ­¢ç›‘æµ‹ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡Thread.join()æ–¹æ³•ç»“æŸã€Thread.isAlive()çš„è¿”å›å€¼ç­‰æ‰‹æ®µæ£€æµ‹åˆ°çº¿ç¨‹å·²ç»ç»ˆæ­¢æ‰§è¡Œã€‚</li><li>çº¿ç¨‹ä¸­æ–­æ“ä½œï¼šå¯¹çº¿ç¨‹interrupt()æ–¹æ³•çš„è°ƒç”¨ï¼Œhappens-beforeäºè¢«ä¸­æ–­çº¿ç¨‹çš„ä»£ç æ£€æµ‹åˆ°ä¸­æ–­äº‹ä»¶çš„å‘ç”Ÿï¼Œå¯ä»¥é€šè¿‡Thread.interrupted()æ–¹æ³•æ£€æµ‹åˆ°çº¿ç¨‹æ˜¯å¦æœ‰ä¸­æ–­å‘ç”Ÿã€‚</li><li>å¯¹è±¡ç»ˆç»“è§„åˆ™ï¼šä¸€ä¸ªå¯¹è±¡çš„åˆå§‹åŒ–å®Œæˆï¼Œhappens-beforeäºè¿™ä¸ªå¯¹è±¡çš„finalize()æ–¹æ³•çš„å¼€å§‹ã€‚</li></ol><p>å‚è€ƒé“¾æ¥ï¼š<a href="https://zhuanlan.zhihu.com/p/77157725" target="_blank" rel="noreferrer">happens-beforeè§„åˆ™è§£æ - çŸ¥ä¹ (zhihu.com)</a></p></div></li></ul><br>`,5);function f(T,S,I,N,q,j){const a=E("Mermaid");return i(),r("div",null,[C,(i(),n(l,null,{default:s(()=>[h(a,{id:"mermaid-283",class:"mermaid",graph:"sequenceDiagram%0A%09participant%20t1%20as%20t1%20%E7%BA%BF%E7%A8%8B%0A%09participant%20n%20%20as%20num%20%3D%200%0A%09participant%20v%20%20as%20volatile%20ready%20%3D%20false%0A%09participant%20t2%20as%20t2%20%E7%BA%BF%E7%A8%8B%0A%09t1%20--%3E%3E%20t1%3A%20num%20%3D%202%0A%09t1%20-%3E%3E%20v%3A%20read%20%3D%20true%0A%09Note%20Over%20t1%2Cv%3A%20%E5%86%99%E5%B1%8F%E9%9A%9C%0A%09Note%20Over%20n%2Ct2%3A%20%E8%AF%BB%E5%B1%8F%E9%9A%9C%0A%09t2%20-%3E%3Ev%3A%20%E8%AF%BB%E5%8F%96%20read%20%3D%20true%0A%09t2%20-%3E%3En%3A%20%E8%AF%BB%E5%8F%96%20num%20%3D%202%0A"})]),fallback:s(()=>[t(" Loading... ")]),_:1})),u,(i(),n(l,null,{default:s(()=>[h(a,{id:"mermaid-304",class:"mermaid",graph:"sequenceDiagram%0A%09participant%20t1%20as%20t1%20%E7%BA%BF%E7%A8%8B%0A%09participant%20n%20%20as%20num%20%3D%200%0A%09participant%20v%20%20as%20volatile%20ready%20%3D%20false%0A%09participant%20t2%20as%20t2%20%E7%BA%BF%E7%A8%8B%0A%09t1%20--%3E%3E%20t1%3A%20num%20%3D%202%0A%09t1%20-%3E%3E%20v%3A%20read%20%3D%20true%0A%09Note%20Over%20t1%2Cv%3A%20%E5%86%99%E5%B1%8F%E9%9A%9C%0A%09Note%20Over%20n%2Ct2%3A%20%E8%AF%BB%E5%B1%8F%E9%9A%9C%0A%09t2%20-%3E%3Ev%3A%20%E8%AF%BB%E5%8F%96%20read%20%3D%20true%0A%09t2%20-%3E%3En%3A%20%E8%AF%BB%E5%8F%96%20num%20%3D%202%0A"})]),fallback:s(()=>[t(" Loading... ")]),_:1})),B,D,v,(i(),n(l,null,{default:s(()=>[h(a,{id:"mermaid-321",class:"mermaid",graph:"sequenceDiagram%0A%09participant%20t1%20as%20t1%20%E7%BA%BF%E7%A8%8B%0A%09participant%20v%20%20as%20volatile%20i%20%3D%200%0A%09participant%20t2%20as%20t2%20%E7%BA%BF%E7%A8%8B%0A%09t2%20--%3E%20v%3A%20%20%E8%AF%BB%E5%8F%96%20i%20%3D%200%0A%09t1%20--%3E%20v%3A%20%20%E8%AF%BB%E5%8F%96%20i%20%3D%200%0A%09t1%20--%3E%20t1%3A%20i%20%2B%201%0A%20%20t1%20--%3E%20v%3A%20%20%E5%86%99%E5%85%A5%20i%20%3D%201%0A%20%20t2%20--%3E%20t2%3A%20i%20-%201%0A%20%20t2%20--%3E%20v%3A%20%20%E5%86%99%E5%85%A5%20i%20%3D%20-1%0A"})]),fallback:s(()=>[t(" Loading... ")]),_:1})),b,(i(),n(l,null,{default:s(()=>[h(a,{id:"mermaid-399",class:"mermaid",graph:"sequenceDiagram%0A%09participant%20t1%20as%20t1%20%E7%BA%BF%E7%A8%8B%0A%09participant%20l%20%20as%20INSTANCE%0A%09participant%20t2%20as%20t2%20%E7%BA%BF%E7%A8%8B%0A%09t1%20-%3E%3E%20t1%3A%2017%3Anew%0A%09t1%20-%3E%3E%20t1%3A%2020%3Adup%0A%09t1%20-%3E%3E%20l%3A%20%2024%3Aputstatic(%E7%BB%99%20INSTANCE%20%E8%B5%8B%E5%80%BC)%0A%09t2%20-%3E%3E%20l%3A%20%200%3Agetstatic(%E8%8E%B7%E5%8F%96%20INSTANCE%20%E5%BC%95%E7%94%A8)%0A%09t2%20-%3E%3E%20t2%3A%203%3Aifnonnull%2037(%E5%88%A4%E8%AF%BB%E4%B8%8D%E4%B8%BA%E7%A9%BA%EF%BC%8C%E8%B7%B3%E8%BD%AC37%E8%A1%8C)%0A%09t2%20-%3E%3E%20l%3A%20%2037%3Agetstatic(%E8%8E%B7%E5%8F%96%20INSTANCE%20%E5%BC%95%E7%94%A8)%0A%09t2%20-%3E%3E%20t2%3A%2040%3Aareturn(%E8%BF%94%E5%9B%9E)%0A%09t2%20-%3E%3E%20t2%3A%20%E4%BD%BF%E7%94%A8%E5%AF%B9%E8%B1%A1%0A%09t1%20-%3E%3E%20t1%3A%2021%3Ainvokespecial(%E8%B0%83%E7%94%A8%E6%9E%84%E9%80%A0%E6%96%B9%E6%B3%95)%0A"})]),fallback:s(()=>[t(" Loading... ")]),_:1})),m,(i(),n(l,null,{default:s(()=>[h(a,{id:"mermaid-459",class:"mermaid",graph:"sequenceDiagram%0A%09participant%20t1%20as%20t1%20%E7%BA%BF%E7%A8%8B%0A%09participant%20l%20%20as%20INSTANCE%0A%09participant%20t2%20as%20t2%20%E7%BA%BF%E7%A8%8B%0A%09t1%20-%3E%3E%20t1%3A%2017%3Anew%0A%09t1%20-%3E%3E%20t1%3A%2020%3Adup%0A%09t1%20-%3E%3E%20t1%3A%2021%3Ainvokespecial(%E8%B0%83%E7%94%A8%E6%9E%84%E9%80%A0%E6%96%B9%E6%B3%95)%09%0A%09t2%20-X%20l%3A%20%200%3Agetstatic(%E8%8E%B7%E5%8F%96%20INSTANCE%20%E5%BC%95%E7%94%A8%EF%BC%8C%E5%B8%A6%E8%AF%BB%E5%B1%8F%E9%9A%9C)%0A%09t1%20-X%20l%3A%20%2024%3Aputstatic(%E7%BB%99%20INSTANCE%20%E8%B5%8B%E5%80%BC%EF%BC%8C%E5%B8%A6%E5%86%99%E5%B1%8F%E9%9A%9C)%0A%09t2%20-%3E%3E%20t2%3A%203%3Aifnonnull%2037(%E5%88%A4%E8%AF%BB%E4%B8%8D%E4%B8%BA%E7%A9%BA%EF%BC%8C%E8%B7%B3%E8%BD%AC37%E8%A1%8C)%0A%09t2%20-X%20l%3A%20%2037%3Agetstatic(%E8%8E%B7%E5%8F%96%20INSTANCE%20%E5%BC%95%E7%94%A8)%0A%09t2%20-%3E%3E%20t2%3A%2040%3Aareturn(%E8%BF%94%E5%9B%9E)%0A%09t2%20-%3E%3E%20t2%3A%20%E4%BD%BF%E7%94%A8%E5%AF%B9%E8%B1%A1%0A"})]),fallback:s(()=>[t(" Loading... ")]),_:1})),_])}const w=e(A,[["render",f]]);export{x as __pageData,w as default};

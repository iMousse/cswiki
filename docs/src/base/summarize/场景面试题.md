## ä¿¡åˆ›åºåˆ—åŒ–æ”¹é€ 

åŸºäº DeepSeek æé—®å¾—åˆ°çš„æ–¹æ¡ˆ

é—®é¢˜ä¸€ï¼š



### æŠ€æœ¯é€‰å‹

åœ¨å°† Oracle è¿ç§»åˆ° MySQL çš„è¿‡ç¨‹ä¸­ï¼Œåºåˆ—åŒ–ï¼ˆSequenceï¼‰åŠŸèƒ½çš„æ”¹é€ æ˜¯å…³é”®æŒ‘æˆ˜ä¹‹ä¸€ã€‚ä»¥ä¸‹æ˜¯äº”ç§ä¸»æµæ”¹é€ æ–¹æ¡ˆï¼Œæ¯ç§æ–¹æ¡ˆéƒ½åŒ…å«è¯¦ç»†å®ç°å’Œé€‚ç”¨åœºæ™¯åˆ†æï¼š

------

#### æ–¹æ¡ˆ 1ï¼šå•è¡¨è‡ªå¢

**é€‚ç”¨åœºæ™¯**ï¼šå•è¡¨ä¸»é”®è‡ªå¢éœ€æ±‚

```sql
-- å»ºè¡¨æ—¶å®šä¹‰è‡ªå¢ä¸»é”®
CREATE TABLE orders (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,  -- è‡ªå¢åˆ—
  order_no VARCHAR(20) NOT NULL
);

-- æ’å…¥æ•°æ®ï¼ˆæ— éœ€æŒ‡å®šIDï¼‰
INSERT INTO orders (order_no) VALUES ('ORD20230714001');
SELECT LAST_INSERT_ID();  -- è·å–åˆšæ’å…¥çš„ID
```

**ä¼˜ç‚¹**ï¼š

- åŸç”Ÿæ”¯æŒï¼Œé›¶å¼€å‘æˆæœ¬
- é«˜æ€§èƒ½ï¼ˆInnoDBä¼˜åŒ–ï¼‰
- ä¿è¯å•è¡¨å†…è¿ç»­é€’å¢

**ç¼ºç‚¹**ï¼š

- æ— æ³•è·¨è¡¨å…±äº«åºåˆ—
- åˆ†å¸ƒå¼ç¯å¢ƒä¸‹éœ€ç‰¹æ®Šå¤„ç†ï¼ˆæ­¥é•¿è®¾ç½®ï¼‰
- æ‰¹é‡æ’å…¥æ—¶æ— æ³•è·å–æ‰€æœ‰ID

------

#### æ–¹æ¡ˆ 2ï¼šåºåˆ—æ¨¡æ‹Ÿè¡¨ï¼ˆé€šç”¨æ–¹æ¡ˆï¼‰

**é€‚ç”¨åœºæ™¯**ï¼šéœ€è¦è·¨è¡¨å…±äº«åºåˆ—

```sql
-- åˆ›å»ºåºåˆ—ç®¡ç†è¡¨
CREATE TABLE sequences (
  name VARCHAR(50) PRIMARY KEY,
  value BIGINT NOT NULL DEFAULT 1000,
  step INT NOT NULL DEFAULT 1
);

-- æ’å…¥è®¢å•åºåˆ—
INSERT INTO sequences(name) VALUES ('order_seq');
```

**Java è·å–ä¸‹ä¸€ä¸ªåºåˆ—å€¼**ï¼š

```sql
public Long nextVal(String seqName) {
    jdbcTemplate.update(
        "UPDATE sequences SET value = LAST_INSERT_ID(value + step) WHERE name = ?", 
        seqName
    );
    return jdbcTemplate.queryForObject(
        "SELECT LAST_INSERT_ID()", Long.class
    );
}
```

**ä¼˜ç‚¹**ï¼š

- å®Œç¾æ¨¡æ‹ŸOracleåºåˆ—è¡Œä¸º
- æ”¯æŒè·¨ä¸šåŠ¡å…±äº«
- å¯è‡ªå®šä¹‰æ­¥é•¿

**ç¼ºç‚¹**ï¼š

- é«˜å¹¶å‘ä¸‹æœ‰é”ç«äº‰
- éœ€é¢å¤–ç»´æŠ¤åºåˆ—è¡¨

------

#### æ–¹æ¡ˆ 3ï¼šåˆ†å¸ƒå¼IDç”Ÿæˆå™¨ï¼ˆé«˜å¹¶å‘æ–¹æ¡ˆï¼‰

**é€‚ç”¨åœºæ™¯**ï¼šåˆ†å¸ƒå¼ç³»ç»Ÿã€é«˜å¹¶å‘åœºæ™¯

##### 3.1 Snowflake ç®—æ³•å®ç°

```java
public class SnowflakeIdGenerator {
    private final long datacenterId;
    private final long workerId;
    private long sequence = 0L;
    
    public synchronized long nextId() {
        long timestamp = System.currentTimeMillis();
        // 41ä½æ—¶é—´æˆ³ | 5ä½æ•°æ®ä¸­å¿ƒ | 5ä½æœºå™¨ID | 12ä½åºåˆ—å·
        return ((timestamp - 1288834974657L) << 22) 
               | (datacenterId << 17) 
               | (workerId << 12) 
               | (sequence++ & 4095);
    }
}
```

##### 3.2 ç¾å›¢Leafæ–¹æ¡ˆï¼ˆDB+ç¼“å­˜ï¼‰

```mermaid
graph LR
    A[åº”ç”¨] -->|è·å–ID| B[Leaf Server]
    B -->|ç¼“å­˜ä¸è¶³| C[MySQLæ‰¹é‡è·å–]
    C --> D[æ›´æ–°max_id]
    D --> B		
```

**ä¼˜ç‚¹**ï¼š

- å®Œå…¨åˆ†å¸ƒå¼ï¼Œæ— å•ç‚¹ç“¶é¢ˆ
- é«˜æ€§èƒ½ï¼ˆ10ä¸‡+/ç§’ï¼‰
- æ—¶é—´æœ‰åº

**ç¼ºç‚¹**ï¼š

- å®ç°å¤æ‚åº¦é«˜
- Snowflakeä¾èµ–æ—¶é’ŸåŒæ­¥

------

#### æ–¹æ¡ˆ 4ï¼šRedis åŸå­è®¡æ•°å™¨ï¼ˆé«˜æ€§èƒ½æ–¹æ¡ˆï¼‰

**é€‚ç”¨åœºæ™¯**ï¼šéœ€è¦æé«˜ååé‡çš„IDç”Ÿæˆ

```java
public class RedisSequence {
    private final RedisTemplate<String, Long> redisTemplate;
    
    public Long nextVal(String bizType) {
        String key = "seq:" + bizType;
        return redisTemplate.opsForValue().increment(key, 1);
    }
    
    // æ‰¹é‡è·å–
    public List<Long> nextBatch(String bizType, int size) {
        String key = "seq:" + bizType;
        Long end = redisTemplate.opsForValue().increment(key, size);
        return LongStream.rangeClosed(end - size + 1, end)
                         .boxed().collect(Collectors.toList());
    }
}
```

**æŒä¹…åŒ–ä¿éšœ**ï¼š

```bash
# Redisé…ç½®
appendonly yes
appendfsync everysec
```

**ä¼˜ç‚¹**ï¼š

- è¶…é«˜æ€§èƒ½ï¼ˆ10ä¸‡+ QPSï¼‰
- æ”¯æŒæ‰¹é‡è·å–
- åŸå­æ“ä½œä¿è¯å”¯ä¸€æ€§

**ç¼ºç‚¹**ï¼š

- å¼•å…¥æ–°ç»„ä»¶ä¾èµ–
- å®•æœºå¯èƒ½å¯¼è‡´åºåˆ—æ–­å±‚

------

#### æ–¹æ¡ˆ 5ï¼šæ•°æ®åº“å‡½æ•°æ¨¡æ‹Ÿï¼ˆå…¼å®¹æ–¹æ¡ˆï¼‰

**é€‚ç”¨åœºæ™¯**ï¼šéœ€è¦æœ€å¤§ç¨‹åº¦å…¼å®¹Oracleè¯­æ³•

```SQL
-- åˆ›å»ºåºåˆ—å‡½æ•°
DELIMITER $$
CREATE FUNCTION nextval(seq_name VARCHAR(50)) 
RETURNS BIGINT
BEGIN
    UPDATE sequences 
    SET value = @next_val := value + step 
    WHERE name = seq_name;
    RETURN @next_val;
END$$
DELIMITER ;

-- ä½¿ç”¨æ–¹å¼ï¼ˆç±»ä¼¼Oracleï¼‰
INSERT INTO orders (id, order_no)
VALUES (nextval('order_seq'), 'ORD20230714001');
```

**ä¼˜ç‚¹**ï¼š

- è¯­æ³•çº§å…¼å®¹
- æ— éœ€ä¿®æ”¹åº”ç”¨ä»£ç 
- ä¿æŒäº‹åŠ¡ä¸€è‡´æ€§

**ç¼ºç‚¹**ï¼š

- å‡½æ•°è°ƒç”¨æœ‰æ€§èƒ½å¼€é”€
- é«˜å¹¶å‘ä¸‹ä»æœ‰é”ç«äº‰

------

### æ–¹æ¡ˆå¯¹æ¯”å†³ç­–è¡¨

| **ç»´åº¦**   | è‡ªå¢ä¸»é”® | åºåˆ—è¡¨   | åˆ†å¸ƒå¼ID | Redis  | å‡½æ•°æ¨¡æ‹Ÿ |
| :--------- | :------- | :------- | :------- | :----- | :------- |
| æ€§èƒ½       | â˜…â˜…â˜…â˜…â˜†    | â˜…â˜…â˜†â˜†â˜†    | â˜…â˜…â˜…â˜…â˜…    | â˜…â˜…â˜…â˜…â˜…  | â˜…â˜…â˜†â˜†â˜†    |
| åˆ†å¸ƒå¼æ”¯æŒ | âœ˜        | âœ˜        | âœ”        | âœ”      | âœ˜        |
| è·¨è¡¨å…±äº«   | âœ˜        | âœ”        | âœ”        | âœ”      | âœ”        |
| è¿ç»­æ€§ä¿è¯ | âœ”        | âœ”        | âœ˜        | âœ˜      | âœ”        |
| è¿ç§»æˆæœ¬   | ä½       | ä¸­       | é«˜       | ä¸­     | ä½       |
| é€‚ç”¨QPS    | < 1k     | < 500    | > 10ä¸‡   | > 10ä¸‡ | < 300    |
| å…¸å‹åœºæ™¯   | å•è¡¨ä¸»é”® | ä¸­å°ç³»ç»Ÿ | å¾®æœåŠ¡   | é«˜å¹¶å‘ | å…¼å®¹è¿ç§» |



### æ··åˆå®æ–½æ–¹æ¡ˆï¼ˆæ¨èï¼‰

```mermaid
graph TD
    A[ä¸šåŠ¡åœºæ™¯] --> B{IDéœ€æ±‚ç±»å‹}
    B -->|ä¸»é”®| C[AUTO_INCREMENT]
    B -->|ä¸šåŠ¡æµæ°´å·| D[RedisåŸå­è®¡æ•°å™¨]
    B -->|å…¨å±€å”¯ä¸€ID| E[Snowflake]
    B -->|éœ€è¦è¿ç»­ID| F[åºåˆ—è¡¨+å‡½æ•°å°è£…]
    
    C --> G[è®¢å•è¡¨/ç”¨æˆ·è¡¨]
    D --> H[è®¢å•å·/äº¤æ˜“å·]
    E --> I[åˆ†å¸ƒå¼äº‹åŠ¡ID]
    F --> J[è´¢åŠ¡æµæ°´å·]
```

**å®æ–½å»ºè®®**ï¼š

1. **ä¸»é”®å­—æ®µ**ï¼šä¼˜å…ˆä½¿ç”¨ `AUTO_INCREMENT`
2. **ä¸šåŠ¡æµæ°´å·**ï¼š
   - é«˜å¹¶å‘ï¼šRedis åŸå­è®¡æ•°å™¨
   - ä½å¹¶å‘ï¼šåºåˆ—è¡¨ + å‡½æ•°å°è£…
3. **åˆ†å¸ƒå¼ID**ï¼šSnowflake/Leaf æ–¹æ¡ˆ
4. **è´¢åŠ¡ç³»ç»Ÿ**ï¼šä¸¥æ ¼è¿ç»­åœºæ™¯ä½¿ç”¨åºåˆ—è¡¨ + æ‚²è§‚é”



**è¿ç§»æ³¨æ„äº‹é¡¹**

```sql
-- ä»Oracleå¯¼å…¥åºåˆ—å½“å‰å€¼
INSERT INTO sequences(name, value)
SELECT 'order_seq', last_number 
FROM oracle_sequences 
WHERE sequence_name = 'ORDER_SEQ';
```



## æ–¹æ¡ˆé€‰æ‹©

**Redis æ‰¹é‡é¢„ç”Ÿæˆ**ï¼šå°† Oracle çš„åºåˆ—ï¼ˆSequenceï¼‰è¿ç§»åˆ° MySQL æ—¶ï¼Œæ”¹ç”¨ Redis æ‰¹é‡ç¼“å­˜åºåˆ—å·ï¼ˆé¢„ç”Ÿæˆä¸€æ‰¹ ID å­˜å…¥ Redisï¼Œåº”ç”¨ä½¿ç”¨æ—¶ç›´æ¥ä»ä¸­åˆ†é…ï¼‰æ˜¯ä¸€ç§å¸¸è§ä¼˜åŒ–ç­–ç•¥ï¼Œä½†å…¶åˆ©å¼Šéœ€è¦ç»“åˆåœºæ™¯æƒè¡¡ï¼š



### æ–¹æ¡ˆä¼˜åŠ£

**ä¼˜åŠ¿**

1. **æ€§èƒ½å¤§å¹…æå‡**
   - Redis åŸºäºå†…å­˜æ“ä½œï¼Œåˆ†é… ID çš„é€Ÿåº¦è¿œé«˜äº MySQL çš„è‡ªå¢å­—æ®µæˆ–æ¨¡æ‹Ÿåºåˆ—ï¼ˆå¦‚ `AUTO_INCREMENT` æˆ– `LAST_INSERT_ID()`ï¼‰ã€‚
   - **é€‚ç”¨åœºæ™¯**ï¼šé«˜å¹¶å‘ä¸šåŠ¡ï¼ˆå¦‚è®¢å•å·ç”Ÿæˆã€ç§’æ€ç³»ç»Ÿï¼‰ï¼Œå¯é¿å…æ•°æ®åº“æˆä¸ºç“¶é¢ˆã€‚
2. **è§£å†³ MySQL è‡ªå¢ ID çš„å±€é™æ€§**
   - MySQL çš„ `AUTO_INCREMENT` åœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸‹éš¾ä»¥ä¿è¯å…¨å±€å”¯ä¸€ï¼ˆéœ€åˆ†åº“åˆ†è¡¨ï¼‰ï¼Œè€Œ Redis å¯é€šè¿‡åŸå­æ“ä½œï¼ˆ`INCRBY`ï¼‰ç”Ÿæˆå…¨å±€å”¯ä¸€æ‰¹æ¬¡å·ï¼Œç»“åˆé¢„åˆ†é…æœºåˆ¶å®ç°é«˜æ•ˆåˆ†å‘ã€‚
3. **é™ä½æ•°æ®åº“å‹åŠ›**
   - æ‰¹é‡åˆå§‹åŒ–åï¼ŒçŸ­æ—¶é—´å†…çš„ ID åˆ†é…æ— éœ€è®¿é—® MySQLï¼Œå‡å°‘ç£ç›˜ I/O å’Œè¿æ¥æ•°æ¶ˆè€—ã€‚
4. **çµæ´»æ§åˆ¶ ID è§„åˆ™**
   - å¯è‡ªå®šä¹‰ ID æ ¼å¼ï¼ˆå¦‚æ—¶é—´æˆ³+åºåˆ—å·ï¼‰ï¼Œè€Œä¸ä»…é™äºæ•°å­—ï¼ŒRedis çš„çµæ´»æ€§ä¼˜äºæ•°æ®åº“åŸç”Ÿåºåˆ—ã€‚



**åŠ£åŠ¿**

1. **æ•°æ®ä¸€è‡´æ€§ä¸å¯é æ€§é£é™©**
   - **Redis æ•°æ®ä¸¢å¤±**ï¼šè‹¥æœªé…ç½®æŒä¹…åŒ–ï¼ˆAOF/RDBï¼‰ï¼Œå®•æœºå¯èƒ½å¯¼è‡´æœªä½¿ç”¨çš„åºåˆ—å·ä¸¢å¤±ï¼Œé€ æˆ ID æ–­å±‚ï¼ˆä¸šåŠ¡æ˜¯å¦å®¹å¿ï¼Ÿï¼‰ã€‚
   - **åŒå†™ä¸€è‡´æ€§é—®é¢˜**ï¼šRedis åˆ†é…çš„ ID æœ€ç»ˆéœ€å†™å…¥ MySQLï¼Œéœ€ç¡®ä¿ Redis ä¸ MySQL ä¹‹é—´çš„çŠ¶æ€åŒæ­¥ï¼ˆå¦‚ï¼šRedis åˆ†é… ID åä¸šåŠ¡å¤±è´¥ï¼ŒMySQL æœªæ’å…¥ï¼Œå¯¼è‡´ ID æµªè´¹ï¼‰ã€‚
2. **å¤æ‚åº¦å¢åŠ **
   - **ç³»ç»Ÿå¤æ‚æ€§**ï¼šéœ€é¢å¤–ç»´æŠ¤ Redis é›†ç¾¤å’Œé«˜å¯ç”¨æœºåˆ¶ï¼ˆå“¨å…µ/é›†ç¾¤æ¨¡å¼ï¼‰ï¼Œå¢åŠ è¿ç»´æˆæœ¬ã€‚
   - **åˆå§‹åŒ–é€»è¾‘**ï¼šéœ€å®ç°æ‰¹æ¬¡å·é¢„ç”ŸæˆæœåŠ¡ï¼ˆå¦‚ä» MySQL è·å–èµ·å§‹å€¼ï¼Œè®¡ç®—æ‰¹æ¬¡èŒƒå›´ï¼‰ï¼Œé€»è¾‘æ¯”ç›´æ¥ä½¿ç”¨æ•°æ®åº“åºåˆ—æ›´å¤æ‚ã€‚
3. **æ‰¹é‡åˆ†é…ç­–ç•¥çš„æŒ‘æˆ˜**
   - **æ‰¹æ¬¡å¤§å°éš¾æƒè¡¡**ï¼š
     - æ‰¹æ¬¡è¿‡å¤§ â†’ Redis å†…å­˜å ç”¨é«˜ï¼Œä¸”æœåŠ¡é‡å¯æ—¶æµªè´¹æ›´å¤š IDã€‚
     - æ‰¹æ¬¡è¿‡å° â†’ é¢‘ç¹è®¿é—® MySQL åˆå§‹åŒ–æ–°æ‰¹æ¬¡ï¼Œä¸§å¤±æ€§èƒ½ä¼˜åŠ¿ã€‚
   - **åŠ¨æ€è°ƒæ•´**ï¼šéœ€æ ¹æ®ä¸šåŠ¡æµé‡åŠ¨æ€è°ƒæ•´æ‰¹æ¬¡å¤§å°ï¼ˆå¦‚ä½å³°æœŸå‡å°‘é¢„ç”Ÿæˆé‡ï¼‰ã€‚
4. **åˆ†å¸ƒå¼ç¯å¢ƒä¸‹çš„å¹¶å‘é—®é¢˜**
   - å¤šå®ä¾‹åº”ç”¨åŒæ—¶ä» Redis å–å·æ—¶ï¼Œéœ€ç”¨ `LPOP`ï¼ˆåˆ—è¡¨ï¼‰ æˆ– `INCR`ï¼ˆåŸå­è®¡æ•°ï¼‰ç¡®ä¿çº¿ç¨‹å®‰å…¨ï¼Œé¿å…é‡å¤åˆ†é…ã€‚
   - è·¨æœåŠ¡éƒ¨ç½²æ—¶ï¼Œéœ€ä¿è¯ Redis é›†ç¾¤çš„å…¨å±€å¯ç”¨æ€§ã€‚



### å…³é”®å†³ç­–å»ºè®®

**é€‚åˆä½¿ç”¨ Redis æ–¹æ¡ˆçš„æƒ…å†µï¼š**

- ä¸šåŠ¡å¯¹ **ID è¿ç»­æ€§æ— ä¸¥æ ¼è¦æ±‚**ï¼ˆå…è®¸å°‘é‡æ–­å±‚ï¼‰ã€‚
- å¹¶å‘é‡é«˜ï¼ˆå¦‚ QPS > 1kï¼‰ï¼Œæ•°æ®åº“å‹åŠ›æˆä¸ºç“¶é¢ˆã€‚
- å·²å­˜åœ¨ Redis åŸºç¡€è®¾æ–½ï¼Œå›¢é˜Ÿå…·å¤‡è¿ç»´èƒ½åŠ›ã€‚

**åº”è°¨æ…æˆ–é¿å…çš„æƒ…å†µï¼š**

- é‡‘è/äº¤æ˜“ç³»ç»Ÿè¦æ±‚ **ä¸¥æ ¼è¿ç»­çš„ ID**ï¼ˆå¦‚å¯¹è´¦ä¾èµ–è¿ç»­æµæ°´å·ï¼‰ã€‚
- ç³»ç»Ÿå®¹å¿åº¦ä½ï¼Œæ— æ³•æ¥å— ID ä¸¢å¤±æˆ–é‡å¤ï¼ˆéœ€å¼•å…¥æ›´å¤æ‚çš„åˆ†å¸ƒå¼äº‹åŠ¡æ–¹æ¡ˆï¼‰ã€‚
- èµ„æºæœ‰é™ï¼Œæ— æ³•ä¿è¯ Redis é«˜å¯ç”¨ã€‚



### ä¼˜åŒ–å®è·µæ–¹æ¡ˆ

```mermaid
graph TD
  A[åº”ç”¨å¯åŠ¨] --> B[ä» MySQL åŠ è½½å½“å‰æœ€å¤§ ID]
  B --> C[é¢„åˆ†é…ä¸€ä¸ªæ‰¹æ¬¡ ID åˆ° Redis List]
  C --> D{åº”ç”¨éœ€è¦ ID}
  D -->|æ˜¯| E[ä» Redis LPOP è·å– ID]
  E --> F[ä½¿ç”¨ ID å†™å…¥ MySQL]
  D -->|Redis æ‰¹æ¬¡è€—å°½| G[è§¦å‘æ–°æ‰¹æ¬¡åˆå§‹åŒ–]
  G --> B
```



1. **åˆå§‹åŒ–æ‰¹æ¬¡**

   ```sql
   -- MySQL ä¸­ç®¡ç†æ‰¹æ¬¡èµ·å§‹å€¼
   REPLACE INTO id_generator(biz_type, max_id) VALUES ('order', 10000);
   ```

   ç¨‹åº

   ```java
   // åº”ç”¨åˆå§‹åŒ–ï¼šä» MySQL è·å– max_idï¼Œé¢„åˆ†é… 1000 ä¸ª ID åˆ° Redis
   Long startId = mysql.getMaxId("order");
   redis.lpush("order_ids", generateIds(startId, 1000)); // ç”Ÿæˆ [startId+1, startId+1000]
   mysql.updateMaxId("order", startId + 1000); // æ›´æ–° MySQL
   ```

2. **ID åˆ†é…ä¸å®¹ç¾**

   - ä½¿ç”¨ Redis çš„ `LPOP` åˆ†é… IDï¼ˆçº¿ç¨‹å®‰å…¨ï¼‰ã€‚
   - é€šè¿‡ **å¼‚æ­¥ä»»åŠ¡** ç›‘æ§ Redis å‰©ä½™ ID é‡ï¼Œä½äºé˜ˆå€¼æ—¶è‡ªåŠ¨è¡¥å……æ‰¹æ¬¡ã€‚
   - é…ç½® Redis **AOF æŒä¹…åŒ–** + **RDB å¤‡ä»½**ï¼Œå‡å°‘æ•°æ®ä¸¢å¤±é£é™©ã€‚

3. **å¼‚å¸¸å¤„ç†**

   - Redis å®•æœºæ—¶ï¼Œ**é™çº§åˆ° MySQL ä¸´æ—¶åˆ†é…**ï¼ˆæ€§èƒ½ä¸‹é™ä½†æœåŠ¡å¯ç”¨ï¼‰ã€‚
   - å®šæœŸæ‰«æ MySQL ä¸ Redis çš„ ID ä½¿ç”¨å·®è·ï¼Œä¿®å¤ä¸ä¸€è‡´ã€‚





## å…·ä½“å®ç°

ä¸‹é¢æ˜¯ä¸€ä¸ªåŸºäº Spring Boot + Redis + MySQL å®ç°çš„åˆ†å¸ƒå¼åºåˆ—æœåŠ¡å®Œæ•´ä»£ç ç¤ºä¾‹ï¼ŒåŒ…å«åˆå§‹åŒ–ã€åˆ†é…ã€æ‰¹æ¬¡è¡¥å……å’Œå®¹é”™æœºåˆ¶

### æ¶æ„è®¾è®¡

```mermaid
graph TD
    A[åº”ç”¨æœåŠ¡] -->|è·å–ID| B[Redis List]
    B -->|IDä¸è¶³| C[IDç”ŸæˆæœåŠ¡]
    C -->|è¯»å–å½“å‰MAX_ID| D[(MySQL)]
    C -->|å†™å…¥æ–°æ‰¹æ¬¡| B
    D -->|æ›´æ–°MAX_ID| C
```



### æ ¸å¿ƒä»£ç 

#### 1. MySQL è¡¨ç»“æ„

```sql
CREATE TABLE id_generator (
  id BIGINT NOT NULL AUTO_INCREMENT,
  biz_type VARCHAR(50) NOT NULL COMMENT 'ä¸šåŠ¡ç±»å‹',
  max_id BIGINT NOT NULL COMMENT 'å½“å‰æœ€å¤§ID',
  step INT NOT NULL COMMENT 'æ‰¹æ¬¡å¤§å°',
  update_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (id),
  UNIQUE KEY uniq_biz_type (biz_type)
) ENGINE=InnoDB;

-- åˆå§‹åŒ–ç¤ºä¾‹æ•°æ®
INSERT INTO id_generator(biz_type, max_id, step) 
VALUES ('order', 10000, 1000);
```

#### 2. Spring Boot åº”ç”¨é…ç½®

**pom.xml ä¾èµ–**

```xml
<dependencies>
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-data-redis</artifactId>
    </dependency>
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-jdbc</artifactId>
    </dependency>
    <dependency>
        <groupId>mysql</groupId>
        <artifactId>mysql-connector-java</artifactId>
    </dependency>
</dependencies>
```

**application.yml**

```yaml
spring:
  redis:
    host: localhost
    port: 6379
    timeout: 2000
  datasource:
    url: jdbc:mysql://localhost:3306/id_db?useSSL=false
    username: root
    password: root
    driver-class-name: com.mysql.cj.jdbc.Driver
```

#### 3. æ ¸å¿ƒæœåŠ¡å®ç°

```java
@Service
public class DistributedIdService {

    private static final Logger log = LoggerFactory.getLogger(DistributedIdService.class);
    private static final String ID_PREFIX = "id:%s";
    private static final int DEFAULT_STEP = 1000;
    private static final int LOW_WATER_MARK = 200; // ä½æ°´ä½é˜ˆå€¼

    @Autowired
    private StringRedisTemplate redisTemplate;
    
    @Autowired
    private JdbcTemplate jdbcTemplate;
    
    private final Map<String, Boolean> loadingMap = new ConcurrentHashMap<>();
    
    /**
     * è·å–ä¸‹ä¸€ä¸ªID
     */
    public long nextId(String bizType) {
        String key = String.format(ID_PREFIX, bizType);
        
        // å°è¯•ä»Redisè·å–ID
        Long id = redisTemplate.opsForList().leftPop(key);
        
        if (id != null) {
            // æ£€æŸ¥æ˜¯å¦éœ€è¦å¼‚æ­¥è¡¥å……æ‰¹æ¬¡
            checkAndRefill(bizType, key);
            return id;
        }
        
        // åŒæ­¥åŠ è½½æ–°æ‰¹æ¬¡
        return syncLoadBatch(bizType);
    }
    
    /**
     * æ£€æŸ¥å¹¶å¼‚æ­¥è¡¥å……æ‰¹æ¬¡
     */
    private void checkAndRefill(String bizType, String key) {
        Long remain = redisTemplate.opsForList().size(key);
        if (remain != null && remain <= LOW_WATER_MARK) {
            // å¼‚æ­¥åŠ è½½æ–°æ‰¹æ¬¡
            CompletableFuture.runAsync(() -> {
                // å¦‚æœ Key ä¸å­˜åœ¨åˆ™æ·»åŠ  Keyï¼Œå¹¶åŠ è½½æ•°æ®
                if (loadingMap.putIfAbsent(bizType, true) == null) {
                    try {
                        loadBatchToRedis(bizType);
                    } finally {
                        loadingMap.remove(bizType);
                    }
                }
            });
        }
    }
    
    /**
     * åŒæ­¥åŠ è½½æ‰¹æ¬¡ï¼ˆé˜»å¡å¼ï¼‰
     */
    private long syncLoadBatch(String bizType) {
      	// æ­¤å¤„çš„é”ä¸æ˜¯åˆ†å¸ƒå¼é”ï¼Œå¯èƒ½ä¼šå­˜åœ¨å¤šä¸ªæœåŠ¡å™¨åŒæ—¶åŠ è½½æ‰¹æ¬¡å·ã€‚
        synchronized (bizType.intern()) {
            // åŒé‡æ£€æŸ¥ï¼Œé¿å…é‡å¤åˆå§‹åŒ–ï¼Œæå‡æ€§èƒ½ã€‚
            Long id = redisTemplate.opsForList().leftPop(
                String.format(ID_PREFIX, bizType));
            if (id != null) return id;
            
            // åŠ è½½æ–°æ‰¹æ¬¡
            loadBatchToRedis(bizType);
            
            // å†æ¬¡å°è¯•è·å–
            id = redisTemplate.opsForList().leftPop(
                String.format(ID_PREFIX, bizType));
            if (id != null) return id;
            
            throw new RuntimeException("IDç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•");
        }
    }
    
    /**
     * æ ¸å¿ƒï¼šåŠ è½½æ‰¹æ¬¡åˆ°Redisï¼Œåˆ†å¸ƒå¼é”æ¥ä¿è¯æ•°æ®çš„ä¸€è‡´æ€§ã€‚
     */
    private void loadBatchToRedis(String bizType) {
        // 1. ä»æ•°æ®åº“è·å–å½“å‰æœ€å¤§IDå’Œæ­¥é•¿
        IdRange range = fetchNextRange(bizType);
        
        // 2. ç”ŸæˆIDåˆ—è¡¨
        List<Long> idList = LongStream.rangeClosed(
            range.startId, range.endId)
            .boxed()
            .collect(Collectors.toList());
        Collections.reverse(idList); // ä¿è¯LPOPé¡ºåºæ­£ç¡®
        
        // 3. æ‰¹é‡å†™å…¥Redis
        String key = String.format(ID_PREFIX, bizType);
        redisTemplate.opsForList().rightPushAll(key, 
            idList.stream().map(String::valueOf).toArray(String[]::new));
        
        log.info("Loaded {} IDs for {} [{} - {}]", 
            idList.size(), bizType, range.startId, range.endId);
    }
    
    /**
     * æ•°æ®åº“è·å–ä¸‹ä¸€ä¸ªIDèŒƒå›´ï¼ˆå¸¦åˆ†å¸ƒå¼é”ï¼‰
     */
    private IdRange fetchNextRange(String bizType) {
        return jdbcTemplate.execute((ConnectionCallback<IdRange>) conn -> {
            try {
                // å¼€å¯äº‹åŠ¡
                conn.setAutoCommit(false);
                
                // ä½¿ç”¨SELECT FOR UPDATEåŠ é”
                String sql = "SELECT max_id, step FROM id_generator "
                    + "WHERE biz_type = ? FOR UPDATE";
                PreparedStatement ps = conn.prepareStatement(sql);
                ps.setString(1, bizType);
                ResultSet rs = ps.executeQuery();
                
                if (!rs.next()) {
                    throw new RuntimeException("æœªæ‰¾åˆ°ä¸šåŠ¡ç±»å‹: " + bizType);
                }
                
                long currentMax = rs.getLong("max_id");
                int step = rs.getInt("step");
                if (step <= 0) step = DEFAULT_STEP;
                
                long newMax = currentMax + step;
                
                // æ›´æ–°æ•°æ®åº“
                String updateSql = "UPDATE id_generator SET max_id = ? "
                    + "WHERE biz_type = ?";
                try (PreparedStatement ups = conn.prepareStatement(updateSql)) {
                    ups.setLong(1, newMax);
                    ups.setString(2, bizType);
                    ups.executeUpdate();
                }
                
                conn.commit();
                
                return new IdRange(currentMax + 1, newMax);
            } catch (SQLException e) {
                conn.rollback();
                throw new RuntimeException("è·å–IDèŒƒå›´å¤±è´¥", e);
            }
        });
    }
    
    // IDèŒƒå›´å¯¹è±¡
    private static class IdRange {
        final long startId;
        final long endId;
        
        IdRange(long startId, long endId) {
            this.startId = startId;
            this.endId = endId;
        }
    }
}
```

#### 4. å®¹é”™å¢å¼ºå¤„ç†

```java
@Component
public class IdGeneratorHealthCheck {

    @Autowired
    private DistributedIdService idService;
    @Autowired
    private StringRedisTemplate redisTemplate;
    
    @Scheduled(fixedRate = 300_000) // æ¯5åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
    public void checkIdUsage() {
        checkBusinessType("order");
        // æ·»åŠ å…¶ä»–ä¸šåŠ¡ç±»å‹...
    }
    
    private void checkBusinessType(String bizType) {
        String key = String.format("id:%s", bizType);
        Long remain = redisTemplate.opsForList().size(key);
        
        // Redisä¸­æ— IDæ—¶ç›´æ¥åŠ è½½æ‰¹æ¬¡
        if (remain == null || remain == 0) {
            idService.loadBatchToRedis(bizType);
            return;
        }
        
        // æ£€æŸ¥MySQLä¸Redisçš„IDå·®è·
        Long maxIdInRedis = getMaxIdInRedis(key);
        Long dbMaxId = getDbMaxId(bizType);
        
        // å¦‚æœRedisä¸­çš„æœ€å¤§IDæ¥è¿‘æ•°æ®åº“è®°å½•å€¼ï¼Œæå‰åŠ è½½
        if (dbMaxId - maxIdInRedis < 500) { 
            idService.loadBatchToRedis(bizType);
        }
    }
    
    private Long getMaxIdInRedis(String key) {
        // è·å–Redisä¸­æœ€å¤§IDï¼ˆæœ€åä¸€ä¸ªå…ƒç´ ï¼‰
        String lastId = redisTemplate.opsForList().index(key, -1);
        return lastId != null ? Long.parseLong(lastId) : 0L;
    }
    
    private Long getDbMaxId(String bizType) {
        String sql = "SELECT max_id FROM id_generator WHERE biz_type = ?";
        return jdbcTemplate.queryForObject(sql, Long.class, bizType);
    }
}
```

#### 5. é™çº§ç­–ç•¥ï¼ˆSpring Cloud Hystrixï¼‰

```java
@Service
public class FallbackIdService {
    
    @Autowired
    private DistributedIdService distributedIdService;
    
    // æœ¬åœ°è‡ªå¢ä½œä¸ºé™çº§æ–¹æ¡ˆ
    private final AtomicLong fallbackCounter = new AtomicLong(100_000_000L);
    
    @HystrixCommand(fallbackMethod = "localNextId")
    public long getNextId(String bizType) {
        return distributedIdService.nextId(bizType);
    }
    
    // é™çº§æ–¹æ³•ï¼šä½¿ç”¨æœ¬åœ°è®¡æ•°å™¨+éšæœºæ•°
    private long localNextId(String bizType) {
        log.warn("Using local ID generator for {}", bizType);
        return System.currentTimeMillis() * 10000 + 
               fallbackCounter.incrementAndGet() % 10000;
    }
  
  
  
  
}
```

### ä½¿ç”¨ç¤ºä¾‹

```java
@RestController
@RequestMapping("/order")
public class OrderController {
    
    @Autowired
    private FallbackIdService idService;
    
    @PostMapping
    public Order createOrder(@RequestBody Order order) {
        // è·å–åˆ†å¸ƒå¼ID
        long orderId = idService.getNextId("order");
        order.setId(orderId);
        // ä¿å­˜åˆ°æ•°æ®åº“...
        return order;
    }
}
```





## ç¾å›¢ Leaf æ–¹æ¡ˆ

ç¾å›¢Leafæ˜¯ç¾å›¢ç‚¹è¯„å¼€æºçš„é«˜æ€§èƒ½åˆ†å¸ƒå¼IDç”Ÿæˆç³»ç»Ÿï¼Œæ—¨åœ¨è§£å†³åˆ†å¸ƒå¼ç¯å¢ƒä¸‹å…¨å±€å”¯ä¸€IDçš„ç”Ÿæˆé—®é¢˜ã€‚å…¶è®¾è®¡å…¼é¡¾é«˜å¯ç”¨ã€ä½å»¶è¿Ÿå’Œæ˜“æ‰©å±•æ€§ï¼Œæ”¯æŒä¸¤ç§æ ¸å¿ƒæ¨¡å¼ï¼š**å·æ®µæ¨¡å¼ï¼ˆSegmentï¼‰**å’Œ**é›ªèŠ±æ¨¡å¼ï¼ˆSnowflakeï¼‰**ã€‚ä»¥ä¸‹ä»æ ¸å¿ƒæ¶æ„ã€å·¥ä½œåŸç†ã€ä¼˜åŒ–ç­–ç•¥åˆ°å®è·µéƒ¨ç½²è¿›è¡Œè¯¦ç»†è§£æ

------

### âš™ï¸ ä¸€ã€æ ¸å¿ƒæ¶æ„ä¸æ¨¡å¼

#### 1. **å·æ®µæ¨¡å¼ï¼ˆSegment Modeï¼‰**

**æ ¸å¿ƒæ€æƒ³**ï¼šé€šè¿‡æ‰¹é‡é¢„åŠ è½½IDåŒºé—´ï¼ˆå·æ®µï¼‰åˆ°å†…å­˜ï¼Œå‡å°‘æ•°æ®åº“è®¿é—®é¢‘ç‡ã€‚

- **æ•°æ®åº“è®¾è®¡**ï¼š
  åˆ›å»ºè¡¨`leaf_alloc`ç®¡ç†å„ä¸šåŠ¡çš„å·æ®µåˆ†é…ï¼š

  ```sql
  CREATE TABLE `leaf_alloc` (
    `biz_tag` VARCHAR(128) PRIMARY KEY,  -- ä¸šåŠ¡æ ‡è¯†ï¼ˆå¦‚è®¢å•ã€ç”¨æˆ·ï¼‰
    `max_id` BIGINT NOT NULL,           -- å½“å‰æœ€å¤§ID
    `step` INT NOT NULL,                -- å·æ®µé•¿åº¦ï¼ˆæ¯æ¬¡ç”³è¯·çš„IDæ•°é‡ï¼‰
    `description` VARCHAR(256),
    `update_time` TIMESTAMP DEFAULT CURRENT_TIMESTAMP
  );
  ```
  
- **å·¥ä½œæµç¨‹**ï¼š

  1. **åŠ è½½å·æ®µ**ï¼šæœåŠ¡å¯åŠ¨æ—¶ï¼Œæ‰§è¡ŒåŸå­æ“ä½œæ›´æ–°å¹¶è·å–å·æ®µï¼š

     ```sql
      BEGIN;
     UPDATE leaf_alloc SET max_id = max_id + step WHERE biz_tag = 'order_tag';
     SELECT biz_tag, max_id, step FROM leaf_alloc WHERE biz_tag = 'order_tag';
     COMMIT;
     ```
     
  2. **åŒBufferæœºåˆ¶**ï¼š

     - å½“å‰å·æ®µæ¶ˆè€—è‡³10%æ—¶ï¼Œå¼‚æ­¥é¢„åŠ è½½ä¸‹ä¸€ä¸ªå·æ®µã€‚
   - åŒBufferäº¤æ›¿ä½¿ç”¨ï¼Œç¡®ä¿DBæ•…éšœæ—¶ä»æœ‰ä¸€ä¸ªBufferå¯åˆ†é…IDã€‚
  
  3. **åŠ¨æ€è°ƒæ•´Step**ï¼šæ ¹æ®å·æ®µæ¶ˆè€—å‘¨æœŸï¼ˆTï¼‰è‡ªåŠ¨è°ƒæ•´æ­¥é•¿ï¼š

     - T < 15min â†’ `step = step * 2`
   - T > 30min â†’ `step = step / 2`

#### 2. **é›ªèŠ±æ¨¡å¼ï¼ˆSnowflake Modeï¼‰**

**æ ¸å¿ƒæ€æƒ³**ï¼šåŸºäºTwitter Snowflakeç®—æ³•ï¼Œå®Œå…¨åˆ†å¸ƒå¼ç”Ÿæˆè¶‹åŠ¿é€’å¢çš„64ä½ID3912ã€‚

- **IDç»“æ„**ï¼š1ä½ï¼ˆç¬¦å·ä½ï¼‰  41ä½ï¼ˆæ—¶é—´æˆ³ï¼‰  5ä½ï¼ˆæœºæˆ¿IDï¼‰  5ä½ï¼ˆæœºå™¨IDï¼‰  12ä½ï¼ˆåºåˆ—å·ï¼‰
  - æ—¶é—´æˆ³ï¼šå½“å‰æ—¶é—´å‡å»å›ºå®šèµ·å§‹æ—¶é—´ï¼ˆå¦‚2020-01-01ï¼‰ã€‚
  - æœºå™¨IDï¼šé€šè¿‡ZooKeeperåˆ†é…æˆ–æ‰‹åŠ¨é…ç½®ï¼Œä¿è¯å…¨å±€å”¯ä¸€ã€‚
- **å…³é”®é—®é¢˜è§£å†³**ï¼š
  - **æ—¶é’Ÿå›æ‹¨**ï¼š
    - çŸ­æ—¶é—´å›æ‹¨ï¼ˆâ‰¤2ç§’ï¼‰ï¼šç­‰å¾…æ—¶é’ŸåŒæ­¥912ã€‚
    - é•¿æ—¶é—´å›æ‹¨ï¼šæŠ›å‡ºå¼‚å¸¸ï¼Œéœ€äººå·¥ä»‹å…¥ã€‚
  - **æœºå™¨IDç®¡ç†**ï¼š
    - é¦–æ¬¡å¯åŠ¨ä»ZooKeeperè·å–å¹¶ç¼“å­˜è‡³æœ¬åœ°æ–‡ä»¶ï¼Œå®ç°å¼±ä¾èµ–ã€‚

------

### âš¡ äºŒã€é«˜æ€§èƒ½ä¸é«˜å¯ç”¨ä¼˜åŒ–

#### 1. **å·æ®µæ¨¡å¼ä¼˜åŒ–**

- **åŒBufferå¼‚æ­¥åŠ è½½**ï¼š
  - é¿å…å·æ®µè€—å°½æ—¶æ‰åŒæ­¥é˜»å¡æ›´æ–°DBï¼Œå°†DBè®¿é—®è€—æ—¶ï¼ˆTP99ï¼‰ä»ç™¾æ¯«ç§’çº§é™è‡³æ¯«ç§’å†…ã€‚
- **åŠ¨æ€Stepè°ƒæ•´**ï¼š
  - æ ¹æ®QPSè‡ªåŠ¨ä¼¸ç¼©å·æ®µé•¿åº¦ï¼Œä½¿å·æ®µæ¶ˆè€—å‘¨æœŸç¨³å®šåœ¨15-30åˆ†é’Ÿã€‚
- **å®¹ç¾èƒ½åŠ›**ï¼š
  - æ¨èå·æ®µé•¿åº¦ = é«˜å³°æœŸQPS Ã— 600ï¼ˆæ”¯æ’‘10åˆ†é’Ÿï¼‰ï¼Œå³ä½¿DBå®•æœºæœåŠ¡ä»å¯æŒç»­è¿è¡Œã€‚

#### 2. **Snowflakeæ¨¡å¼ä¼˜åŒ–**

- **å¼±ä¾èµ–ZK**ï¼šé¦–æ¬¡è·å–workerIDåæœ¬åœ°ç¼“å­˜ï¼Œé¿å…ZKæ•…éšœå½±å“æœåŠ¡ã€‚
- **NTPå¼ºåˆ¶æ—¶é’ŸåŒæ­¥**ï¼šæ‰€æœ‰èŠ‚ç‚¹å¿…é¡»å¯ç”¨NTPæœåŠ¡ï¼Œç¦æ­¢æ‰‹åŠ¨ä¿®æ”¹æ—¶é—´ã€‚

#### 3. **MySQLé«˜å¯ç”¨**

- **åŠåŒæ­¥å¤åˆ¶ + MHA**ï¼šç¡®ä¿ä¸»ä»åˆ‡æ¢æ—¶æ•°æ®ä¸€è‡´æ€§ã€‚
- **å¤šæœºæˆ¿éƒ¨ç½²**ï¼šè·¨æœºæˆ¿åŒæ­¥æ•°æ®ï¼Œé˜²æ­¢å•æœºæˆ¿æ•…éšœã€‚

------

### ğŸš€ ä¸‰ã€éƒ¨ç½²ä¸ä½¿ç”¨

#### 1. **å¿«é€Ÿéƒ¨ç½²ï¼ˆä»¥Dockerä¸ºä¾‹ï¼‰**

```bash
git clone https://github.com/Meituan-Dianping/Leaf.git
cd leaf/leaf-docker
chmod +x build.sh && ./build.sh
docker-compose up -d
```

#### 2. **é…ç½®è¯´æ˜ï¼ˆleaf.propertiesï¼‰**

```properties
# å·æ®µæ¨¡å¼é…ç½®
leaf.segment.enable=true
leaf.jdbc.url=jdbc:mysql://localhost:3306/leaf_db
leaf.jdbc.username=root
leaf.jdbc.password=123456

# Snowflakeæ¨¡å¼é…ç½®
leaf.snowflake.enable=true
leaf.snowflake.zk.address=127.0.0.1:2181
```

#### 3. **APIè°ƒç”¨ç¤ºä¾‹**

- **å·æ®µæ¨¡å¼**ï¼š

  ```bash
  curl http://localhost:8080/api/segment/get/order_tag
  ```
  
- **Snowflakeæ¨¡å¼**ï¼š

  ```bash
  curl http://localhost:8080/api/snowflake/get/test
  ```

#### 4. **Spring Booté›†æˆ**

```xml
<dependency>
    <groupId>com.sankuai.inf.leaf</groupId>
    <artifactId>leaf-core</artifactId>
    <version>1.0.0-RELEASE</version>
</dependency>
```

------

### ğŸ“Š å››ã€é€‚ç”¨åœºæ™¯å¯¹æ¯”

| **ç»´åº¦**       | **å·æ®µæ¨¡å¼**                 | **Snowflakeæ¨¡å¼**                  |
| :------------- | :--------------------------- | :--------------------------------- |
| **æ€§èƒ½**       | 10ä¸‡+ QPSï¼ˆTP99â‰ˆ0.3msï¼‰      | 50ä¸‡+ QPSï¼ˆTP99â‰ˆ0.1msï¼‰            |
| **æ•°æ®åº“ä¾èµ–** | å¼ºä¾èµ–ï¼ˆéœ€MySQLé«˜å¯ç”¨ï¼‰      | æ— ä¾èµ–                             |
| **IDè¿ç»­æ€§**   | è¶‹åŠ¿é€’å¢                     | è¶‹åŠ¿é€’å¢                           |
| **é€‚ç”¨åœºæ™¯**   | è®¢å•IDã€ç”¨æˆ·IDï¼ˆå®¹å¿DBä¾èµ–ï¼‰ | æ—¥å¿—è¿½è¸ªã€å®æ—¶æ¶ˆæ¯ï¼ˆæè‡´æ€§èƒ½éœ€æ±‚ï¼‰ |
| **å®‰å…¨æ€§**     | IDå¯é¢„æµ‹ï¼ˆéœ€ä¸šåŠ¡å±‚åŠ å¯†ï¼‰     | æ—¶é—´æˆ³æš´éœ²ä¸šåŠ¡æ—¶é—´                 |

------

### ğŸ”§ äº”ã€ç”Ÿäº§ç¯å¢ƒæœ€ä½³å®è·µ

1. **å·æ®µé•¿åº¦è®¾ç½®**ï¼š
   - å…¬å¼ï¼š`step = max(1000, å³°å€¼QPS Ã— 600)` ã€‚
   - ä¾‹ï¼šQPS=1ä¸‡ â†’ step=60ä¸‡ï¼ˆæ”¯æ’‘10åˆ†é’Ÿï¼‰ã€‚
2. **ç›‘æ§ä¸å‘Šè­¦**ï¼š
   - é€šè¿‡Leafå†…ç½®Webç•Œé¢å®æ—¶æŸ¥çœ‹å·æ®µæ°´ä½ï¼ˆå¦‚`http://localhost:8080/cache`ï¼‰ã€‚
   - é›†æˆPrometheusç›‘æ§IDç”Ÿæˆé€Ÿç‡ã€å‰©ä½™å·æ®µå æ¯”ã€‚
3. **é«˜å¯ç”¨éƒ¨ç½²**ï¼š
   - è‡³å°‘éƒ¨ç½²3èŠ‚ç‚¹ï¼Œé€šè¿‡Nginxè´Ÿè½½å‡è¡¡ã€‚
   - å¤šæœºæˆ¿éƒ¨ç½²æ•°æ®åº“å®ä¾‹ï¼Œé˜²æ­¢ç½‘ç»œåˆ†åŒºæ•…éšœã€‚

------

### ğŸ’ æ€»ç»“

Leafé€šè¿‡ **å·æ®µæ¨¡å¼** å’Œ **Snowflakeæ¨¡å¼** çš„äº’è¡¥è®¾è®¡ï¼Œè¦†ç›–äº†ä»é«˜å¹¶å‘ä¸šåŠ¡åˆ°æ— çŠ¶æ€æœåŠ¡çš„å…¨åœºæ™¯éœ€æ±‚ï¼š

- **å·æ®µæ¨¡å¼**ä»¥æ•°æ®åº“ä¸ºåŸºçŸ³ï¼Œé€šè¿‡åŒBufferå’ŒåŠ¨æ€Stepä¼˜åŒ–ï¼Œå®ç°é«˜å¯ç”¨ä¸ä½å»¶è¿Ÿçš„å¹³è¡¡ï¼›
- **Snowflakeæ¨¡å¼**ä»¥å»ä¸­å¿ƒåŒ–æ¶æ„è¾¾æˆæè‡´æ€§èƒ½ï¼Œé€šè¿‡å¼±ä¾èµ–ZKå’Œæ—¶é’Ÿå›æ‹¨å¤„ç†ä¿éšœç¨³å®šæ€§3912ã€‚

> **å¼€æºåœ°å€**ï¼š[Meituan-Dianping/Leaf](https://github.com/Meituan-Dianping/Leaf)
> **æ‰©å±•å»ºè®®**ï¼šé‡‘èç±»ä¸šåŠ¡å¯ç»„åˆä½¿ç”¨ä¸¤ç§æ¨¡å¼â€”â€”Snowflakeç”Ÿæˆæ—¥å¿—è¿½è¸ªIDï¼Œå·æ®µæ¨¡å¼ç”Ÿæˆéœ€ä¸¥æ ¼è¿ç»­çš„è®¢å•IDã€‚



## å·æ®µæ¨¡å¼çš„çº¿ç¨‹å®‰å…¨é—®é¢˜

ç¾å›¢Leafçš„å·æ®µæ¨¡å¼é€šè¿‡â€œåŒBufferæœºåˆ¶ + åˆ†æ®µé” + åŸå­æ“ä½œâ€çš„ç»„åˆç­–ç•¥è§£å†³çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Œç¡®ä¿é«˜å¹¶å‘ä¸‹IDåˆ†å‘çš„æ­£ç¡®æ€§ã€‚å…·ä½“å®ç°å¦‚ä¸‹ï¼š

------

### âš™ï¸ **1. åŒBufferæœºåˆ¶ï¼ˆæ ¸å¿ƒéš”ç¦»ç­–ç•¥ï¼‰**

- **è®¾è®¡åŸç†**ï¼š
  - å†…å­˜ä¸­ç»´æŠ¤**ä¸¤ä¸ªå·æ®µç¼“å­˜åŒºï¼ˆSegment Bufferï¼‰**ï¼šå½“å‰ä½¿ç”¨çš„`Buffer`ï¼ˆSegment Aï¼‰å’Œé¢„å¤‡`Buffer`ï¼ˆSegment Bï¼‰ã€‚
  - å½“Segment Aæ¶ˆè€—è‡³ **10%**ï¼ˆå¦‚1000ä¸ªIDæ¶ˆè€—100ä¸ªï¼‰æ—¶ï¼Œ**å¼‚æ­¥è§¦å‘**Segment Bçš„å·æ®µåŠ è½½ï¼Œä¸ä¸»çº¿ç¨‹è§£è€¦247ã€‚
- **çº¿ç¨‹å®‰å…¨ä½œç”¨**ï¼š
  - **è¯»å†™åˆ†ç¦»**ï¼šä¸»çº¿ç¨‹ä»…ä»Segment Aåˆ†é…IDï¼Œå¼‚æ­¥çº¿ç¨‹ç‹¬ç«‹åŠ è½½Segment Bï¼Œé¿å…åŠ è½½è¿‡ç¨‹é˜»å¡IDåˆ†é…ã€‚
  - **æ— ç¼åˆ‡æ¢**ï¼šå½“Segment Aè€—å°½æ—¶ï¼Œç›´æ¥åˆ‡æ¢åˆ°å·²å‡†å¤‡å¥½çš„Segment Bï¼Œæ— éœ€ç­‰å¾…æ•°æ®åº“å“åº”ï¼ˆåˆ‡æ¢è¿‡ç¨‹é€šè¿‡é”æ§åˆ¶ï¼Œè§ä¸‹æ–‡ï¼‰ã€‚

------

### ğŸ”’ **2. åˆ†æ®µé”ï¼ˆåŒæ­¥æ§åˆ¶ï¼‰**

- **å…³é”®åœºæ™¯**ï¼š
  - **å·æ®µåˆ‡æ¢**ï¼šå½“Segment Aè€—å°½éœ€åˆ‡æ¢è‡³Segment Bæ—¶ï¼Œé€šè¿‡`synchronized`æˆ–`ReentrantLock`å¯¹åˆ‡æ¢é€»è¾‘åŠ é”ï¼Œç¡®ä¿åŒä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œåˆ‡æ¢37ã€‚
  - **å¼‚æ­¥åŠ è½½é˜²é‡**ï¼šå¼‚æ­¥çº¿ç¨‹åŠ è½½æ–°å·æ®µå‰ï¼Œé€šè¿‡`ConcurrentHashMap`è®°å½•åŠ è½½çŠ¶æ€ï¼ˆå¦‚`loadingMap.putIfAbsent(biz_tag, true)`ï¼‰ï¼Œé˜²æ­¢å¹¶å‘é‡å¤åŠ è½½7ã€‚
- **é”ç²’åº¦**ï¼šä»¥ä¸šåŠ¡æ ‡ç­¾`biz_tag`ä¸ºç»´åº¦åŠ é”ï¼Œä¸åŒä¸šåŠ¡äº’ä¸å½±å“ã€‚

------

### âš›ï¸ **3. åŸå­æ“ä½œï¼ˆIDåˆ†é…ï¼‰**

- **æœ¬åœ°IDåˆ†å‘**ï¼š
  - æ¯ä¸ªå·æ®µåœ¨å†…å­˜ä¸­ä½¿ç”¨`AtomicLong`ç”Ÿæˆè‡ªå¢IDï¼ˆå¦‚ä»`startId`åˆ°`endId`ï¼‰ã€‚
  - é€šè¿‡`incrementAndGet()`å®ç°çº¿ç¨‹å®‰å…¨çš„é€’å¢å€¼åˆ†é…ï¼Œé¿å…å¹¶å‘å†²çª67ã€‚

------

### ğŸ›¡ï¸ **4. æ•°æ®åº“æ›´æ–°éš”ç¦»ï¼ˆåˆ†å¸ƒå¼ä¸€è‡´æ€§ï¼‰**

- **ä¹è§‚é”ä¿è¯å”¯ä¸€æ€§**ï¼š

  - åŠ è½½æ–°å·æ®µæ—¶ï¼Œæ‰§è¡ŒåŸå­SQLæ“ä½œï¼š

    sql

    ```
    UPDATE leaf_alloc SET max_id = max_id + step 
    WHERE biz_tag = #{tag} AND max_id = #{old_max_id}
    ```

    é€šè¿‡`max_id = #{old_max_id}`æ¡ä»¶å®ç°ä¹è§‚é”ï¼Œè‹¥æ›´æ–°å¤±è´¥åˆ™é‡è¯•ï¼Œé¿å…å¤šèŠ‚ç‚¹æˆ–çº¿ç¨‹åˆ†é…é‡å å·æ®µ68ã€‚

- **äº‹åŠ¡éš”ç¦»**ï¼šæ›´æ–°ä¸æŸ¥è¯¢åœ¨åŒä¸€ä¸ªäº‹åŠ¡ä¸­å®Œæˆï¼ˆ`BEGIN; UPDATE... SELECT... COMMIT;`ï¼‰ï¼Œç¡®ä¿æ•°æ®ä¸€è‡´æ€§28ã€‚

------

### ğŸ§ª5. çº¿ç¨‹å®‰å…¨æµç¨‹ç¤ºä¾‹

```mermaid
sequenceDiagram
    participant Client as å®¢æˆ·ç«¯çº¿ç¨‹
    participant SegmentA as å†…å­˜Segment A
    participant SegmentB as å†…å­˜Segment B
    participant Loader as å¼‚æ­¥åŠ è½½çº¿ç¨‹
    participant DB as æ•°æ®åº“

    Note over Client,DB: æ­£å¸¸IDåˆ†é…é˜¶æ®µ
    Client->>SegmentA: è¯·æ±‚ID (incrementAndGet())
    SegmentA-->>Client: è¿”å›ID
    
    Note over Client,DB: è§¦å‘å¼‚æ­¥åŠ è½½æ¡ä»¶ (SegmentAå‰©ä½™â‰¤10%)
    alt SegmentAå‰©ä½™â‰¤10% AND SegmentBæœªåŠ è½½
        Client->>Loader: è§¦å‘å¼‚æ­¥åŠ è½½ä¿¡å·
        Loader->>DB: æ‰§è¡ŒåŸå­SQLæ›´æ–°<br/>UPDATE... WHERE max_id=?
        DB-->>Loader: è¿”å›æ–°å·æ®µèŒƒå›´
        Loader->>SegmentB: åŠ è½½æ–°å·æ®µ
    end
    
    Note over Client,DB: SegmentAè€—å°½ï¼Œåˆ‡æ¢Buffer
    alt SegmentAè€—å°½
        Client->>SegmentA: ç”³è¯·åˆ‡æ¢é”(synchronized)
        SegmentA->>SegmentB: æ£€æŸ¥SegmentBæ˜¯å¦å°±ç»ª
        SegmentB-->>SegmentA: å°±ç»ªçŠ¶æ€
        SegmentA->>SegmentA: åˆ‡æ¢å½“å‰Bufferä¸ºSegmentB
        SegmentA-->>Client: ä»SegmentBåˆ†é…ID
        SegmentA->>Loader: è§¦å‘åŠ è½½æ–°SegmentA
    end
    
    Note over Client,DB: å¼‚æ­¥åŠ è½½æ–°SegmentA
    Loader->>DB: æ‰§è¡ŒåŸå­SQLæ›´æ–°
    DB-->>Loader: è¿”å›æ–°å·æ®µèŒƒå›´
    Loader->>SegmentA: åŠ è½½æ–°å·æ®µ
```



#### å…³é”®æµç¨‹è¯´æ˜ï¼š

1. **æ­£å¸¸åˆ†é…é˜¶æ®µ**ï¼š

   - å®¢æˆ·ç«¯ç›´æ¥ä» Segment A è·å– IDï¼ˆä½¿ç”¨ `AtomicLong.incrementAndGet()`ï¼‰
   - æ— é”æ“ä½œï¼Œæ€§èƒ½æœ€ä¼˜è·¯å¾„

2. **å¼‚æ­¥åŠ è½½è§¦å‘**ï¼š

   - å½“ Segment A å‰©ä½™ ID â‰¤ 10% æ—¶è§¦å‘
   - å¼‚æ­¥çº¿ç¨‹ç‹¬ç«‹æ‰§è¡Œæ•°æ®åº“æ“ä½œï¼ˆä½¿ç”¨ä¹è§‚é”ï¼‰
   - ä¸»åˆ†é…çº¿ç¨‹ä¸å—å½±å“

3. **å®‰å…¨åˆ‡æ¢é˜¶æ®µ**ï¼š

   - å½“ Segment A è€—å°½æ—¶éœ€åˆ‡æ¢ Buffer
   - é€šè¿‡ `synchronized` åŠ é”ä¿è¯åˆ‡æ¢åŸå­æ€§
   - æ£€æŸ¥ Segment B æ˜¯å¦å·²åŠ è½½å°±ç»ª

4. **æ— ç¼åˆ‡æ¢**ï¼š

   - åˆ‡æ¢å®Œæˆåç«‹å³ä» Segment B åˆ†é… ID
   - åŒæ—¶è§¦å‘å¼‚æ­¥åŠ è½½æ–° Segment A

5. **å¼‚æ­¥åŠ è½½**ï¼š

   - ç‹¬ç«‹çº¿ç¨‹æ‰§è¡Œæ•°æ®åº“æ“ä½œ
   - ä½¿ç”¨ä¹è§‚é”ä¿è¯å·æ®µå…¨å±€å”¯ä¸€
   - åŠ è½½å®Œæˆå Segment A é‡æ–°å¯ç”¨

   

#### çº¿ç¨‹å®‰å…¨ä¿è¯ç‚¹ï¼š

1. **IDåˆ†é…åŸå­æ€§**ï¼š

   ```java
   // ä½¿ç”¨AtomicLongä¿è¯å•å·æ®µå†…IDåˆ†é…å®‰å…¨
   public long nextId() {
       long current = currentValue.incrementAndGet();
       if (current <= endId) {
           return current;
       }
       // åˆ‡æ¢é€»è¾‘...
   }
   ```

2. **Bufferåˆ‡æ¢é”**ï¼š

   ```java
   // åŸºäºbiz_tagçš„åˆ†æ®µé”
   private final Object switchLock = new Object();
   
   public long nextId() {
       // ...
       synchronized (switchLock) {
           // 1. åŒé‡æ£€æŸ¥
           // 2. åˆ‡æ¢Buffer
           // 3. è§¦å‘å¼‚æ­¥åŠ è½½
       }
   }
   ```

3. **å¼‚æ­¥åŠ è½½é˜²é‡**ï¼š

   ```java
   private final ConcurrentHashMap<String, Boolean> loadingMap = new ConcurrentHashMap<>();
   
   void asyncLoadSegment() {
       if (loadingMap.putIfAbsent(bizTag, true) == null) {
           try {
               // åŠ è½½å·æ®µ
           } finally {
               loadingMap.remove(bizTag);
           }
       }
   }
   ```

4. **æ•°æ®åº“ä¹è§‚é”**ï¼š

   ```java
   UPDATE leaf_alloc 
   SET max_id = max_id + step 
   WHERE biz_tag = 'order' AND max_id = #{oldMaxId}
   -- æ›´æ–°å½±å“è¡Œæ•°ä¸º0æ—¶é‡è¯•
   ```

è¿™ç§è®¾è®¡å®ç°äº†ï¼š

- æ— é”åˆ†é…ï¼ˆ99%æ—¶é—´ï¼‰
- å®‰å…¨åˆ‡æ¢ï¼ˆ1%æ—¶é—´åŠ é”ï¼‰
- é›¶é˜»å¡ç­‰å¾…
- åˆ†å¸ƒå¼ç¯å¢ƒä¸‹çš„å·æ®µå”¯ä¸€æ€§

------

### ğŸ’ **æ€»ç»“ï¼šæ–¹æ¡ˆä¼˜åŠ¿**

| **æœºåˆ¶**         | **è§£å†³çš„æ ¸å¿ƒé—®é¢˜**     | **æ€§èƒ½å½±å“**             |
| :--------------- | :--------------------- | :----------------------- |
| åŒBuffer         | å¼‚æ­¥åŠ è½½ä¸IDåˆ†é…è§£è€¦   | æ— é˜»å¡åˆ†é…ï¼ŒTP99â‰¤1ms2    |
| åˆ†æ®µé”           | åˆ‡æ¢Bufferæ—¶çš„ç«æ€æ¡ä»¶ | ä»…åˆ‡æ¢æ—¶çŸ­æš‚åŠ é”         |
| åŸå­æ“ä½œ(Atomic) | å†…å­˜IDåˆ†é…çš„å¹¶å‘å†²çª   | æ— é”å¿«è·¯å¾„ï¼Œæ”¯æŒ10ä¸‡+QPS |
| æ•°æ®åº“ä¹è§‚é”     | åˆ†å¸ƒå¼ç¯å¢ƒå·æ®µå”¯ä¸€æ€§   | æ•°æ®åº“å‹åŠ›é™è‡³1/step     |

> è¯¥æ–¹æ¡ˆåœ¨ç¾å›¢å†…éƒ¨æ”¯æ’‘é‡‘èã€å¤–å–ç­‰é«˜å¹¶å‘åœºæ™¯ï¼Œå•èŠ‚ç‚¹QPSå¯è¾¾5ä¸‡+ï¼Œä¸”æ•°æ®åº“å®•æœºæ—¶ä»èƒ½é€šè¿‡åŒBufferç»´æŒ10-20åˆ†é’ŸæœåŠ¡48ã€‚






åˆ†å¸ƒå¼äº‹åŠ¡
==========

[[toc]]



## åˆ†å¸ƒå¼äº‹åŠ¡é—®é¢˜

æœ¬åœ°äº‹åŠ¡ï¼Œä¹Ÿå°±æ˜¯ä¼ ç»Ÿçš„**å•æœºäº‹åŠ¡**ã€‚åœ¨ä¼ ç»Ÿæ•°æ®åº“äº‹åŠ¡ä¸­ï¼Œå¿…é¡»è¦æ»¡è¶³å››ä¸ªåŸåˆ™ï¼š

![image-20240225214035863](assets/image-20240225214035863.png)

<br/>

### åˆ†å¸ƒå¼äº‹åŠ¡

**åˆ†å¸ƒå¼äº‹åŠ¡**ï¼Œå°±æ˜¯æŒ‡ä¸æ˜¯åœ¨å•ä¸ªæœåŠ¡æˆ–å•ä¸ªæ•°æ®åº“æ¶æ„ä¸‹ï¼Œäº§ç”Ÿçš„äº‹åŠ¡ï¼Œä¾‹å¦‚ï¼š

- è·¨æ•°æ®æºçš„åˆ†å¸ƒå¼äº‹åŠ¡
- è·¨æœåŠ¡çš„åˆ†å¸ƒå¼äº‹åŠ¡
- ç»¼åˆæƒ…å†µ

<br/>

åœ¨æ•°æ®åº“æ°´å¹³æ‹†åˆ†ã€æœåŠ¡å‚ç›´æ‹†åˆ†ä¹‹åï¼Œä¸€ä¸ªä¸šåŠ¡æ“ä½œé€šå¸¸è¦è·¨å¤šä¸ªæ•°æ®åº“ã€æœåŠ¡æ‰èƒ½å®Œæˆã€‚ä¾‹å¦‚ç”µå•†è¡Œä¸šä¸­æ¯”è¾ƒå¸¸è§çš„ä¸‹å•ä»˜æ¬¾æ¡ˆä¾‹ï¼ŒåŒ…æ‹¬ä¸‹é¢å‡ ä¸ªè¡Œä¸ºï¼š

- åˆ›å»ºæ–°è®¢å•
- æ‰£å‡å•†å“åº“å­˜
- ä»ç”¨æˆ·è´¦æˆ·ä½™é¢æ‰£é™¤é‡‘é¢

<br/>

å®Œæˆä¸Šé¢çš„æ“ä½œéœ€è¦è®¿é—®ä¸‰ä¸ªä¸åŒçš„å¾®æœåŠ¡å’Œä¸‰ä¸ªä¸åŒçš„æ•°æ®åº“ã€‚

![image-20240225214148234](assets/image-20240225214148234.png)

<br/>

è®¢å•çš„åˆ›å»ºã€åº“å­˜çš„æ‰£å‡ã€è´¦æˆ·æ‰£æ¬¾åœ¨æ¯ä¸€ä¸ªæœåŠ¡å’Œæ•°æ®åº“å†…æ˜¯ä¸€ä¸ªæœ¬åœ°äº‹åŠ¡ï¼Œå¯ä»¥ä¿è¯ACIDåŸåˆ™ã€‚

ä½†æ˜¯å½“æˆ‘ä»¬æŠŠä¸‰ä»¶äº‹æƒ…çœ‹åšä¸€ä¸ª"ä¸šåŠ¡"ï¼Œè¦æ»¡è¶³ä¿è¯â€œä¸šåŠ¡â€çš„åŸå­æ€§ï¼Œè¦ä¹ˆæ‰€æœ‰æ“ä½œå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥ï¼Œä¸å…è®¸å‡ºç°éƒ¨åˆ†æˆåŠŸéƒ¨åˆ†å¤±è´¥çš„ç°è±¡ï¼Œè¿™å°±æ˜¯**åˆ†å¸ƒå¼ç³»ç»Ÿä¸‹çš„äº‹åŠ¡**äº†ã€‚

æ­¤æ—¶ACIDéš¾ä»¥æ»¡è¶³ï¼Œè¿™æ˜¯åˆ†å¸ƒå¼äº‹åŠ¡è¦è§£å†³çš„é—®é¢˜ã€‚

<br/>

### åˆ†å¸ƒå¼äº‹åŠ¡é—®é¢˜

æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªæ¡ˆä¾‹æ¥æ¼”ç¤ºåˆ†å¸ƒå¼äº‹åŠ¡çš„é—®é¢˜ï¼š

åˆ›å»ºæ•°æ®åº“ï¼Œåä¸º `seata_demo`

```SQL
create database seata_demo;
use seata_demo;
SET NAMES utf8mb4;
SET FOREIGN_KEY_CHECKS = 0;

-- ----------------------------
-- Table structure for account_tbl
-- ----------------------------
DROP TABLE IF EXISTS `account_tbl`;
CREATE TABLE `account_tbl`  (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `user_id` varchar(255) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL,
  `money` int(11) UNSIGNED NULL DEFAULT 0,
  PRIMARY KEY (`id`) USING BTREE
) ENGINE = InnoDB AUTO_INCREMENT = 2 CHARACTER SET = utf8 COLLATE = utf8_general_ci ROW_FORMAT = COMPACT;

-- ----------------------------
-- Records of account_tbl
-- ----------------------------
INSERT INTO `account_tbl` VALUES (1, 'user202103032042012', 1000);

-- ----------------------------
-- Table structure for order_tbl
-- ----------------------------
DROP TABLE IF EXISTS `order_tbl`;
CREATE TABLE `order_tbl`  (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `user_id` varchar(255) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL,
  `commodity_code` varchar(255) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL,
  `count` int(11) NULL DEFAULT 0,
  `money` int(11) NULL DEFAULT 0,
  PRIMARY KEY (`id`) USING BTREE
) ENGINE = InnoDB AUTO_INCREMENT = 1 CHARACTER SET = utf8 COLLATE = utf8_general_ci ROW_FORMAT = COMPACT;

-- ----------------------------
-- Records of order_tbl
-- ----------------------------

-- ----------------------------
-- Table structure for storage_tbl
-- ----------------------------
DROP TABLE IF EXISTS `storage_tbl`;
CREATE TABLE `storage_tbl`  (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `commodity_code` varchar(255) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL,
  `count` int(11) UNSIGNED NULL DEFAULT 0,
  PRIMARY KEY (`id`) USING BTREE,
  UNIQUE INDEX `commodity_code`(`commodity_code`) USING BTREE
) ENGINE = InnoDB AUTO_INCREMENT = 2 CHARACTER SET = utf8 COLLATE = utf8_general_ci ROW_FORMAT = COMPACT;

-- ----------------------------
-- Records of storage_tbl
-- ----------------------------
INSERT INTO `storage_tbl` VALUES (1, '100202003032041', 10);

SET FOREIGN_KEY_CHECKS = 1;
```

<br/>

**å¯¼å…¥ seat-demo åŸºç¡€å·¥ç¨‹**

å·¥ç¨‹æºç  ï¼šhttps://gitee.com/iMousse/cswiki-project/tree/master/cloud/seata-demo

å¾®æœåŠ¡ç»“æ„å¦‚ä¸‹ï¼š

```sh
# çˆ¶å·¥ç¨‹ï¼Œè´Ÿè´£ç®¡ç†é¡¹ç›®ä¾èµ–
seata-demo 
â”‚   # è´¦æˆ·æœåŠ¡ï¼Œè´Ÿè´£ç®¡ç†ç”¨æˆ·çš„èµ„é‡‘è´¦æˆ·ã€‚æä¾›æ‰£å‡ä½™é¢çš„æ¥å£
â”œâ”€â”€ account-service
â”‚   # åº“å­˜æœåŠ¡ï¼Œè´Ÿè´£ç®¡ç†å•†å“åº“å­˜ã€‚æä¾›æ‰£å‡åº“å­˜çš„æ¥å£
â”œâ”€â”€ order-service
â”‚   # è®¢å•æœåŠ¡ï¼Œè´Ÿè´£ç®¡ç†è®¢å•ã€‚åˆ›å»ºè®¢å•æ—¶ï¼Œéœ€è¦è°ƒç”¨account-serviceå’Œstorage-service
â””â”€â”€ storage-service
```

 <br/>

**æµ‹è¯•ä¸‹å•åŠŸèƒ½**

å¯åŠ¨æ‰€æœ‰å·¥ç¨‹ï¼Œå‘é€è¯·æ±‚

```sh
curl --location --request POST 'http://localhost:8082/order?userId=user202103032042012&commodityCode=100202003032041&count=20&money=200'
```

å¦‚å›¾

![image-20240225220219625](assets/image-20240225220219625.png)

æµ‹è¯•å‘ç°ï¼Œå½“åº“å­˜ä¸è¶³æ—¶ï¼Œå¦‚æœä½™é¢å·²ç»æ‰£å‡ï¼Œå¹¶ä¸ä¼šå›æ»šï¼Œå‡ºç°äº†åˆ†å¸ƒå¼äº‹åŠ¡é—®é¢˜ã€‚

![image-20240225221518724](assets/image-20240225221518724.png)

<br/>

### å­¦ä¹ ç›®æ ‡

![image-20240225221317520](assets/image-20240225221317520.png)



## ç†è®ºåŸºç¡€

è§£å†³åˆ†å¸ƒå¼äº‹åŠ¡é—®é¢˜ï¼Œéœ€è¦ä¸€äº›åˆ†å¸ƒå¼ç³»ç»Ÿçš„åŸºç¡€çŸ¥è¯†ä½œä¸ºç†è®ºæŒ‡å¯¼ã€‚

### CAPå®šç†

1998å¹´ï¼ŒåŠ å·å¤§å­¦çš„è®¡ç®—æœºç§‘å­¦å®¶ Eric Brewer æå‡ºï¼Œåˆ†å¸ƒå¼ç³»ç»Ÿæœ‰ä¸‰ä¸ªæŒ‡æ ‡ã€‚

- ä¸€è‡´æ€§ï¼šConsistency
- å¯ç”¨æ€§ï¼šAvailability
- åˆ†åŒºå®¹é”™æ€§ï¼šPartition tolerance 

å®ƒä»¬çš„ç¬¬ä¸€ä¸ªå­—æ¯åˆ†åˆ«æ˜¯ Cã€Aã€Pï¼Œè¿™ä¸‰ä¸ªæŒ‡æ ‡ä¸å¯èƒ½åŒæ—¶åšåˆ°ã€‚è¿™ä¸ªç»“è®ºå°±å«åš CAP å®šç†ã€‚

![image-20240225220327324](assets/image-20240225220327324.png)

<br/>

**ä¸€è‡´æ€§**

Consistencyï¼ˆä¸€è‡´æ€§ï¼‰ï¼šç”¨æˆ·è®¿é—®åˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„ä»»æ„èŠ‚ç‚¹ï¼Œå¾—åˆ°çš„æ•°æ®å¿…é¡»ä¸€è‡´ã€‚

æ¯”å¦‚ç°åœ¨åŒ…å«ä¸¤ä¸ªèŠ‚ç‚¹ï¼Œå…¶ä¸­çš„åˆå§‹æ•°æ®æ˜¯ä¸€è‡´çš„ï¼š

![image-20240225222040351](assets/image-20240225222040351.png)

å½“æˆ‘ä»¬ä¿®æ”¹å…¶ä¸­ä¸€ä¸ªèŠ‚ç‚¹çš„æ•°æ®æ—¶ï¼Œä¸¤è€…çš„æ•°æ®äº§ç”Ÿäº†å·®å¼‚ï¼š

![image-20240225222059759](assets/image-20240225222059759.png)

è¦æƒ³ä¿ä½ä¸€è‡´æ€§ï¼Œå°±å¿…é¡»å®ç° node01 åˆ° node02 çš„æ•°æ®åŒæ­¥ï¼š

![image-20240225222114637](assets/image-20240225222114637.png)

<br/>

**å¯ç”¨æ€§**

Availability ï¼ˆå¯ç”¨æ€§ï¼‰ï¼šç”¨æˆ·è®¿é—®é›†ç¾¤ä¸­çš„ä»»æ„å¥åº·èŠ‚ç‚¹ï¼Œå¿…é¡»èƒ½å¾—åˆ°å“åº”ï¼Œè€Œä¸æ˜¯è¶…æ—¶æˆ–æ‹’ç»ã€‚

å¦‚å›¾ï¼Œæœ‰ä¸‰ä¸ªèŠ‚ç‚¹çš„é›†ç¾¤ï¼Œè®¿é—®ä»»ä½•ä¸€ä¸ªéƒ½å¯ä»¥åŠæ—¶å¾—åˆ°å“åº”ï¼š

![image-20240225222158175](assets/image-20240225222158175.png)

å½“æœ‰éƒ¨åˆ†èŠ‚ç‚¹å› ä¸ºç½‘ç»œæ•…éšœæˆ–å…¶å®ƒåŸå› æ— æ³•è®¿é—®æ—¶ï¼Œä»£è¡¨èŠ‚ç‚¹ä¸å¯ç”¨ï¼š

![image-20240225222210410](assets/image-20240225222210410.png)



**åˆ†åŒºå®¹é”™**

**Partitionï¼ˆåˆ†åŒºï¼‰**ï¼šå› ä¸ºç½‘ç»œæ•…éšœæˆ–å…¶å®ƒåŸå› å¯¼è‡´åˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„éƒ¨åˆ†èŠ‚ç‚¹ä¸å…¶å®ƒèŠ‚ç‚¹å¤±å»è¿æ¥ï¼Œå½¢æˆç‹¬ç«‹åˆ†åŒºã€‚

![image-20240225222224289](assets/image-20240225222224289.png)

**Toleranceï¼ˆå®¹é”™ï¼‰**ï¼šåœ¨é›†ç¾¤å‡ºç°åˆ†åŒºæ—¶ï¼Œæ•´ä¸ªç³»ç»Ÿä¹Ÿè¦æŒç»­å¯¹å¤–æä¾›æœåŠ¡

<br/>

**çŸ›ç›¾**

åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œç³»ç»Ÿé—´çš„ç½‘ç»œä¸èƒ½100%ä¿è¯å¥åº·ï¼Œä¸€å®šä¼šæœ‰æ•…éšœçš„æ—¶å€™ï¼Œè€ŒæœåŠ¡æœ‰å¿…é¡»å¯¹å¤–ä¿è¯æœåŠ¡ã€‚å› æ­¤Partition Toleranceä¸å¯é¿å…ã€‚

å½“èŠ‚ç‚¹æ¥æ”¶åˆ°æ–°çš„æ•°æ®å˜æ›´æ—¶ï¼Œå°±ä¼šå‡ºç°é—®é¢˜äº†ï¼š

![image-20240225222244210](assets/image-20240225222244210.png)

å¦‚æœæ­¤æ—¶è¦ä¿è¯**ä¸€è‡´æ€§**ï¼Œå°±å¿…é¡»ç­‰å¾…ç½‘ç»œæ¢å¤ï¼Œå®Œæˆæ•°æ®åŒæ­¥åï¼Œæ•´ä¸ªé›†ç¾¤æ‰å¯¹å¤–æä¾›æœåŠ¡ï¼ŒæœåŠ¡å¤„äºé˜»å¡çŠ¶æ€ï¼Œä¸å¯ç”¨ã€‚

å¦‚æœæ­¤æ—¶è¦ä¿è¯**å¯ç”¨æ€§**ï¼Œå°±ä¸èƒ½ç­‰å¾…ç½‘ç»œæ¢å¤ï¼Œé‚£node01ã€node02ä¸node03ä¹‹é—´å°±ä¼šå‡ºç°æ•°æ®ä¸ä¸€è‡´ã€‚

ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨Pä¸€å®šä¼šå‡ºç°çš„æƒ…å†µä¸‹ï¼ŒAå’ŒCä¹‹é—´åªèƒ½å®ç°ä¸€ä¸ªã€‚

<br/>

:::warning ğŸ’¡æ€è€ƒï¼šç®€è¿°CAPå®šç†å†…å®¹

- åˆ†å¸ƒå¼ç³»ç»ŸèŠ‚ç‚¹é€šè¿‡ç½‘ç»œè¿æ¥ï¼Œä¸€å®šä¼šå‡ºç°åˆ†åŒºé—®é¢˜ï¼ˆPï¼‰
- å½“åˆ†åŒºå‡ºç°æ—¶ï¼Œç³»ç»Ÿçš„ä¸€è‡´æ€§ï¼ˆCï¼‰å’Œå¯ç”¨æ€§ï¼ˆAï¼‰å°±æ— æ³•åŒæ—¶æ»¡è¶³

**ğŸ’¡æ€è€ƒï¼šElasticSearché›†ç¾¤æ˜¯CPè¿˜æ˜¯AP**

- ESé›†ç¾¤å‡ºç°åŒºåˆ†æ—¶ï¼Œæ•…éšœèŠ‚ç‚¹ä¼šè¢«å‰”é™¤é›†ç¾¤ï¼Œæ•°æ®ç²‰ç‰‡ä¼šé‡æ–°åˆ†é…åˆ°å…¶å®ƒèŠ‚ç‚¹ï¼Œä¿è¯æ•°æ®ä¸€è‡´æ€§ã€‚å› æ­¤æ—¶ä½å¯ç”¨æ€§ï¼Œé«˜ä¸€è‡´æ€§ï¼Œå±äºCP

:::

<br/>

### BASEç†è®º

BASEç†è®ºæ˜¯å¯¹CAPçš„ä¸€ç§è§£å†³æ€è·¯ï¼ŒåŒ…å«ä¸‰ä¸ªæ€æƒ³ï¼š

- **Basically Available ï¼ˆåŸºæœ¬å¯ç”¨ï¼‰**ï¼šåˆ†å¸ƒå¼ç³»ç»Ÿåœ¨å‡ºç°æ•…éšœæ—¶ï¼Œå…è®¸æŸå¤±éƒ¨åˆ†å¯ç”¨æ€§ï¼Œå³ä¿è¯æ ¸å¿ƒå¯ç”¨ã€‚
- **Soft Stateï¼ˆè½¯çŠ¶æ€ï¼‰**ï¼šåœ¨ä¸€å®šæ—¶é—´å†…ï¼Œå…è®¸å‡ºç°ä¸­é—´çŠ¶æ€ï¼Œæ¯”å¦‚ä¸´æ—¶çš„ä¸ä¸€è‡´çŠ¶æ€ã€‚
- **Eventually Consistentï¼ˆæœ€ç»ˆä¸€è‡´æ€§**ï¼‰ï¼šè™½ç„¶æ— æ³•ä¿è¯å¼ºä¸€è‡´æ€§ï¼Œä½†æ˜¯åœ¨è½¯çŠ¶æ€ç»“æŸåï¼Œæœ€ç»ˆè¾¾åˆ°æ•°æ®ä¸€è‡´ã€‚

<br/>

> æ€è€ƒï¼šè§£å†³åˆ†å¸ƒå¼äº‹åŠ¡æœ‰ä»€ä¹ˆæ€è·¯ï¼Ÿ

åˆ†å¸ƒå¼äº‹åŠ¡æœ€å¤§çš„é—®é¢˜æ˜¯å„ä¸ªå­äº‹åŠ¡çš„ä¸€è‡´æ€§é—®é¢˜ï¼Œå› æ­¤å¯ä»¥å€Ÿé‰´CAPå®šç†å’ŒBASEç†è®ºï¼Œæœ‰ä¸¤ç§è§£å†³æ€è·¯ï¼š

- APæ¨¡å¼ï¼šå„å­äº‹åŠ¡åˆ†åˆ«æ‰§è¡Œå’Œæäº¤ï¼Œå…è®¸å‡ºç°ç»“æœä¸ä¸€è‡´ï¼Œç„¶åé‡‡ç”¨å¼¥è¡¥æªæ–½æ¢å¤æ•°æ®å³å¯ï¼Œå®ç°<mark>æœ€ç»ˆä¸€è‡´</mark>ã€‚

- CPæ¨¡å¼ï¼šå„ä¸ªå­äº‹åŠ¡æ‰§è¡Œåäº’ç›¸ç­‰å¾…ï¼ŒåŒæ—¶æäº¤ï¼ŒåŒæ—¶å›æ»šï¼Œè¾¾æˆ<mark>å¼ºä¸€è‡´</mark>ã€‚ä½†äº‹åŠ¡ç­‰å¾…è¿‡ç¨‹ä¸­ï¼Œå¤„äºå¼±å¯ç”¨çŠ¶æ€ã€‚

<br/>

ä½†ä¸ç®¡æ˜¯å“ªä¸€ç§æ¨¡å¼ï¼Œéƒ½éœ€è¦åœ¨å­ç³»ç»Ÿäº‹åŠ¡ä¹‹é—´äº’ç›¸é€šè®¯ï¼Œåè°ƒäº‹åŠ¡çŠ¶æ€ï¼Œä¹Ÿå°±æ˜¯éœ€è¦ä¸€ä¸ª**äº‹åŠ¡åè°ƒè€…(TC)**

![image-20240225222616925](assets/image-20240225222616925.png)

è¿™é‡Œçš„å­ç³»ç»Ÿäº‹åŠ¡ï¼Œç§°ä¸º**åˆ†æ”¯äº‹åŠ¡**ï¼›æœ‰å…³è”çš„å„ä¸ªåˆ†æ”¯äº‹åŠ¡åœ¨ä¸€èµ·ç§°ä¸º**å…¨å±€äº‹åŠ¡**ã€‚



:::warning ğŸ’¡æ€è€ƒï¼šç®€è¿°BASEç†è®ºä¸‰ä¸ªæ€æƒ³

- åŸºæœ¬å¯ç”¨
- è½¯çŠ¶æ€
- æœ€ç»ˆä¸€è‡´

<br/>

ğŸ’¡**æ€è€ƒï¼šè§£å†³åˆ†å¸ƒå¼äº‹åŠ¡çš„æ€æƒ³å’Œæ¨¡å‹**

- å…¨å±€äº‹åŠ¡ï¼šæ•´ä¸ªåˆ†å¸ƒå¼äº‹åŠ¡
- åˆ†æ”¯äº‹åŠ¡ï¼šæ¯ä¸ªå¾®æœåŠ¡çš„å­ç³»ç»Ÿçš„äº‹åŠ¡
- æœ€ç»ˆä¸€è‡´æ€æƒ³ï¼šå„åˆ†æ”¯äº‹åŠ¡åˆ†åˆ«æ‰§è¡Œå¹¶æäº¤ï¼Œå¦‚æœæœ‰ä¸ä¸€è‡´çš„æƒ…å†µï¼Œå†æƒ³åŠæ³•æ¢å¤æ•°æ®ã€‚
- å¼ºä¸€è‡´æ€æƒ³ï¼šå„åˆ†æ”¯äº‹åŠ¡æ‰§è¡Œå®Œä¸šåŠ¡ä¸è¦æäº¤ï¼Œç­‰å¾…å½¼æ­¤ç»“æœï¼Œè€Œåç»Ÿä¸€æäº¤æˆ–å›æ»šã€‚

:::



## åˆè¯†Seata

Seataæ˜¯ 2019 å¹´ 1 æœˆä»½èš‚èšé‡‘æœå’Œé˜¿é‡Œå·´å·´å…±åŒå¼€æºçš„åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆã€‚è‡´åŠ›äºæä¾›é«˜æ€§èƒ½å’Œç®€å•æ˜“ç”¨çš„åˆ†å¸ƒå¼äº‹åŠ¡æœåŠ¡ï¼Œä¸ºç”¨æˆ·æ‰“é€ ä¸€ç«™å¼çš„åˆ†å¸ƒå¼è§£å†³æ–¹æ¡ˆã€‚

å®˜ç½‘åœ°å€ï¼šhttp://seata.io/

å…¶ä¸­çš„æ–‡æ¡£ã€æ’­å®¢ä¸­æä¾›äº†å¤§é‡çš„ä½¿ç”¨è¯´æ˜ã€æºç åˆ†æã€‚

![image-20240225223249512](assets/image-20240225223249512.png)

<br/>

### Seataçš„æ¶æ„

Seataäº‹åŠ¡ç®¡ç†ä¸­æœ‰ä¸‰ä¸ªé‡è¦çš„è§’è‰²ï¼š

- **TC (Transaction Coordinator) -** **äº‹åŠ¡åè°ƒè€…ï¼š**ç»´æŠ¤å…¨å±€å’Œåˆ†æ”¯äº‹åŠ¡çš„çŠ¶æ€ï¼Œåè°ƒå…¨å±€äº‹åŠ¡æäº¤æˆ–å›æ»šã€‚

- **TM (Transaction Manager) -** **äº‹åŠ¡ç®¡ç†å™¨ï¼š**å®šä¹‰å…¨å±€äº‹åŠ¡çš„èŒƒå›´ã€å¼€å§‹å…¨å±€äº‹åŠ¡ã€æäº¤æˆ–å›æ»šå…¨å±€äº‹åŠ¡ã€‚

- **RM (Resource Manager) -** **èµ„æºç®¡ç†å™¨ï¼š**ç®¡ç†åˆ†æ”¯äº‹åŠ¡å¤„ç†çš„èµ„æºï¼Œä¸TCäº¤è°ˆä»¥æ³¨å†Œåˆ†æ”¯äº‹åŠ¡å’ŒæŠ¥å‘Šåˆ†æ”¯äº‹åŠ¡çš„çŠ¶æ€ï¼Œå¹¶é©±åŠ¨åˆ†æ”¯äº‹åŠ¡æäº¤æˆ–å›æ»šã€‚

<br/>

**æ•´ä½“çš„æ¶æ„å›¾**

![image-20240225223810561](assets/image-20240225223810561.png)

<br/>

SeataåŸºäºä¸Šè¿°æ¶æ„æä¾›äº†å››ç§ä¸åŒçš„åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆï¼š
- XAæ¨¡å¼ï¼šå¼ºä¸€è‡´æ€§åˆ†é˜¶æ®µäº‹åŠ¡æ¨¡å¼ï¼Œç‰ºç‰²äº†ä¸€å®šçš„å¯ç”¨æ€§ï¼Œæ— ä¸šåŠ¡ä¾µå…¥
- TCCæ¨¡å¼ï¼šæœ€ç»ˆä¸€è‡´çš„åˆ†é˜¶æ®µäº‹åŠ¡æ¨¡å¼ï¼Œæœ‰ä¸šåŠ¡ä¾µå…¥
- ATæ¨¡å¼ï¼šæœ€ç»ˆä¸€è‡´çš„åˆ†é˜¶æ®µäº‹åŠ¡æ¨¡å¼ï¼Œæ— ä¸šåŠ¡ä¾µå…¥ï¼Œä¹Ÿæ˜¯Seataçš„é»˜è®¤æ¨¡å¼
- SAGAæ¨¡å¼ï¼šé•¿äº‹åŠ¡æ¨¡å¼ï¼Œæœ‰ä¸šåŠ¡ä¾µå…¥

æ— è®ºå“ªç§æ–¹æ¡ˆï¼Œéƒ½ç¦»ä¸å¼€TCï¼Œä¹Ÿå°±æ˜¯äº‹åŠ¡çš„åè°ƒè€…ã€‚

<br/>

### éƒ¨ç½²TCæœåŠ¡

[å®‰è£…Seata](00æ“ä½œç¯‡-å®‰è£…Seata.md)

<br/>

### é›†æˆSeata

æˆ‘ä»¬ä»¥order-serviceä¸ºä¾‹æ¥æ¼”ç¤ºã€‚

å®‰è£… `Maven Helper` æ’ä»¶

![image-20240225233603886](assets/image-20240225233603886.png)

<br/>

**å¼•å…¥ä¾èµ–**

é¦–å…ˆï¼Œåœ¨order-serviceä¸­å¼•å…¥ä¾èµ–ï¼š

```xml
<!--seata-->
<dependency>
    <groupId>com.alibaba.cloud</groupId>
    <artifactId>spring-cloud-starter-alibaba-seata</artifactId>
    <exclusions>
        <!--ç‰ˆæœ¬è¾ƒä½ï¼Œ1.3.0ï¼Œå› æ­¤æ’é™¤--> 
        <exclusion>
            <artifactId>seata-spring-boot-starter</artifactId>
            <groupId>io.seata</groupId>
        </exclusion>
    </exclusions>
</dependency>
<dependency>
    <groupId>io.seata</groupId>
    <artifactId>seata-spring-boot-starter</artifactId>
    <!--seata starter é‡‡ç”¨1.4.2ç‰ˆæœ¬-->
    <version>${seata.version}</version>
</dependency>
```

<br/>

**é…ç½®TCåœ°å€**

åœ¨ order-service ä¸­çš„ application.yml ä¸­ï¼Œé…ç½®TCæœåŠ¡ä¿¡æ¯ï¼Œé€šè¿‡æ³¨å†Œä¸­å¿ƒ nacosï¼Œç»“åˆæœåŠ¡åç§°è·å–TCåœ°å€ï¼š

```yaml
seata:
  registry: # TCæœåŠ¡æ³¨å†Œä¸­å¿ƒçš„é…ç½®ï¼Œå¾®æœåŠ¡æ ¹æ®è¿™äº›ä¿¡æ¯å»æ³¨å†Œä¸­å¿ƒè·å–tcæœåŠ¡åœ°å€
    type: nacos # æ³¨å†Œä¸­å¿ƒç±»å‹ nacos
    nacos:
      server-addr: 127.0.0.1:8848 # nacosåœ°å€
      namespace: "" # namespaceï¼Œé»˜è®¤ä¸ºç©º
      group: DEFAULT_GROUP # åˆ†ç»„ï¼Œé»˜è®¤æ˜¯DEFAULT_GROUP
      application: seata-tc-server # seataæœåŠ¡åç§°
      username: nacos
      password: nacos
  tx-service-group: seata-demo # äº‹åŠ¡ç»„åç§°
  service:
    vgroup-mapping: # äº‹åŠ¡ç»„ä¸clusterçš„æ˜ å°„å…³ç³»
      seata-demo: SH
```

<br/>

å¾®æœåŠ¡å¦‚ä½•æ ¹æ®è¿™äº›é…ç½®å¯»æ‰¾TCçš„åœ°å€å‘¢ï¼Ÿ

æˆ‘ä»¬çŸ¥é“æ³¨å†Œåˆ°Nacosä¸­çš„å¾®æœåŠ¡ï¼Œç¡®å®šä¸€ä¸ªå…·ä½“å®ä¾‹éœ€è¦å››ä¸ªä¿¡æ¯ï¼š

- namespaceï¼šå‘½åç©ºé—´
- groupï¼šåˆ†ç»„
- applicationï¼šæœåŠ¡å
- clusterï¼šé›†ç¾¤å

<br/>

ä»¥ä¸Šå››ä¸ªä¿¡æ¯ï¼Œåœ¨åˆšæ‰çš„yamlæ–‡ä»¶ä¸­éƒ½èƒ½æ‰¾åˆ°ï¼š

![image-20210724173654258](assets/image-20210724173654258.png)

namespace ä¸ºç©ºï¼Œå°±æ˜¯é»˜è®¤çš„ public

ç»“åˆèµ·æ¥ï¼ŒTCæœåŠ¡çš„ä¿¡æ¯å°±æ˜¯ï¼š`public@DEFAULT_GROUP@seata-tc-server@SH`ï¼Œè¿™æ ·å°±èƒ½ç¡®å®šTCæœåŠ¡é›†ç¾¤äº†ã€‚ç„¶åå°±å¯ä»¥å»Nacosæ‹‰å–å¯¹åº”çš„å®ä¾‹ä¿¡æ¯äº†ã€‚

<br/>

**å…¶å®ƒæœåŠ¡**

å…¶å®ƒä¸¤ä¸ªå¾®æœåŠ¡ä¹Ÿéƒ½å‚è€ƒorder-serviceçš„æ­¥éª¤æ¥åšï¼Œå®Œå…¨ä¸€æ ·ã€‚



## åŠ¨æ‰‹å®è·µ

ä¸‹é¢æˆ‘ä»¬å°±ä¸€èµ·å­¦ä¹ ä¸‹Seataä¸­çš„å››ç§ä¸åŒçš„äº‹åŠ¡æ¨¡å¼ã€‚

<br/>

### XAæ¨¡å¼

XA è§„èŒƒ æ˜¯ X/Open ç»„ç»‡å®šä¹‰çš„åˆ†å¸ƒå¼äº‹åŠ¡å¤„ç†ï¼ˆDTPï¼ŒDistributed Transaction Processingï¼‰æ ‡å‡†ï¼ŒXA è§„èŒƒæè¿°äº†å…¨å±€çš„TMä¸å±€éƒ¨çš„RMä¹‹é—´çš„æ¥å£ï¼Œå‡ ä¹æ‰€æœ‰ä¸»æµçš„æ•°æ®åº“éƒ½å¯¹  XA è§„èŒƒæä¾›äº†æ”¯æŒã€‚

<br/>

#### ä¸¤é˜¶æ®µæäº¤

XAæ˜¯è§„èŒƒï¼Œç›®å‰ä¸»æµæ•°æ®åº“éƒ½å®ç°äº†è¿™ç§è§„èŒƒï¼Œå®ç°çš„åŸç†éƒ½æ˜¯åŸºäºä¸¤é˜¶æ®µæäº¤ã€‚

**æ­£å¸¸æƒ…å†µ**

![image-20240225235938600](assets/image-20240225235938600.png)

**å¼‚å¸¸æƒ…å†µ**

![image-20240225235958664](assets/image-20240225235958664.png)

<br/>

**ä¸€é˜¶æ®µ**

- äº‹åŠ¡åè°ƒè€…é€šçŸ¥æ¯ä¸ªäº‹ç‰©å‚ä¸è€…æ‰§è¡Œæœ¬åœ°äº‹åŠ¡
- æœ¬åœ°äº‹åŠ¡æ‰§è¡Œå®ŒæˆåæŠ¥å‘Šäº‹åŠ¡æ‰§è¡ŒçŠ¶æ€ç»™äº‹åŠ¡åè°ƒè€…ï¼Œæ­¤æ—¶äº‹åŠ¡ä¸æäº¤ï¼Œç»§ç»­æŒæœ‰æ•°æ®åº“é”

**äºŒé˜¶æ®µ**

- äº‹åŠ¡åè°ƒè€…åŸºäºä¸€é˜¶æ®µçš„æŠ¥å‘Šæ¥åˆ¤æ–­ä¸‹ä¸€æ­¥æ“ä½œ
  - å¦‚æœä¸€é˜¶æ®µéƒ½æˆåŠŸï¼Œåˆ™é€šçŸ¥æ‰€æœ‰äº‹åŠ¡å‚ä¸è€…ï¼Œæäº¤äº‹åŠ¡
  - å¦‚æœä¸€é˜¶æ®µä»»æ„ä¸€ä¸ªå‚ä¸è€…å¤±è´¥ï¼Œåˆ™é€šçŸ¥æ‰€æœ‰äº‹åŠ¡å‚ä¸è€…å›æ»šäº‹åŠ¡

<br/>

#### Seataçš„XAæ¨¡å‹

Seataå¯¹åŸå§‹çš„XAæ¨¡å¼åšäº†ç®€å•çš„å°è£…å’Œæ”¹é€ ï¼Œä»¥é€‚åº”è‡ªå·±çš„äº‹åŠ¡æ¨¡å‹ï¼ŒåŸºæœ¬æ¶æ„å¦‚å›¾ï¼š

![image-20240226000023629](assets/image-20240226000023629.png)

<br/>

RMä¸€é˜¶æ®µçš„å·¥ä½œï¼š

- æ³¨å†Œåˆ†æ”¯äº‹åŠ¡åˆ°TC
- æ‰§è¡Œåˆ†æ”¯ä¸šåŠ¡SQLä½†ä¸æäº¤
- æŠ¥å‘Šæ‰§è¡ŒçŠ¶æ€åˆ°TC


TCäºŒé˜¶æ®µçš„å·¥ä½œï¼š

- TCæ£€æµ‹å„åˆ†æ”¯äº‹åŠ¡æ‰§è¡ŒçŠ¶æ€
  - å¦‚æœéƒ½æˆåŠŸï¼Œé€šçŸ¥æ‰€æœ‰RMæäº¤äº‹åŠ¡
  - å¦‚æœæœ‰å¤±è´¥ï¼Œé€šçŸ¥æ‰€æœ‰RMå›æ»šäº‹åŠ¡


RMäºŒé˜¶æ®µçš„å·¥ä½œï¼š

- æ¥æ”¶TCæŒ‡ä»¤ï¼Œæäº¤æˆ–å›æ»šäº‹åŠ¡

<br/>

:::warning ğŸ’¡æ€è€ƒï¼šXAæ¨¡å¼çš„ä¼˜ç¼ºç‚¹

XAæ¨¡å¼çš„ä¼˜ç‚¹æ˜¯ä»€ä¹ˆï¼Ÿ

- äº‹åŠ¡çš„å¼ºä¸€è‡´æ€§ï¼Œæ»¡è¶³ACIDåŸåˆ™ã€‚
- å¸¸ç”¨æ•°æ®åº“éƒ½æ”¯æŒï¼Œå®ç°ç®€å•ï¼Œå¹¶ä¸”æ²¡æœ‰ä»£ç ä¾µå…¥

XAæ¨¡å¼çš„ç¼ºç‚¹æ˜¯ä»€ä¹ˆï¼Ÿ

- å› ä¸ºä¸€é˜¶æ®µéœ€è¦é”å®šæ•°æ®åº“èµ„æºï¼Œç­‰å¾…äºŒé˜¶æ®µç»“æŸæ‰é‡Šæ”¾ï¼Œæ€§èƒ½è¾ƒå·®
- ä¾èµ–å…³ç³»å‹æ•°æ®åº“å®ç°äº‹åŠ¡

:::

<br/>

#### XAå®ç°

Seataçš„starterå·²ç»å®Œæˆäº†XAæ¨¡å¼çš„è‡ªåŠ¨è£…é…ï¼Œå®ç°éå¸¸ç®€å•ï¼Œæ­¥éª¤å¦‚ä¸‹ï¼š

- ä¿®æ”¹ `application.yml` æ–‡ä»¶ï¼ˆæ¯ä¸ªå‚ä¸äº‹åŠ¡çš„å¾®æœåŠ¡ï¼‰ï¼Œå¼€å¯XAæ¨¡å¼ï¼š


```yaml
seata:
  data-source-proxy-mode: XA
```

<br/>

- ç»™å‘èµ·å…¨å±€äº‹åŠ¡çš„å…¥å£æ–¹æ³•æ·»åŠ  `@GlobalTransactional` æ³¨è§£:


æœ¬ä¾‹ä¸­æ˜¯ `OrderServiceImpl` ä¸­çš„ `create` æ–¹æ³•.

```java {16}
@Slf4j
@Service
public class OrderServiceImpl implements OrderService {

    private final AccountClient accountClient;
    private final StorageClient storageClient;
    private final OrderMapper orderMapper;

    public OrderServiceImpl(AccountClient accountClient, StorageClient storageClient, OrderMapper orderMapper) {
        this.accountClient = accountClient;
        this.storageClient = storageClient;
        this.orderMapper = orderMapper;
    }

    @Override
    @GlobalTransactional
    public Long create(Order order) {
        // åˆ›å»ºè®¢å•
        orderMapper.insert(order);
        try {
            // æ‰£ç”¨æˆ·ä½™é¢
            accountClient.deduct(order.getUserId(), order.getMoney());
            // æ‰£åº“å­˜
            storageClient.deduct(order.getCommodityCode(), order.getCount());

        } catch (FeignException e) {
            log.error("ä¸‹å•å¤±è´¥ï¼ŒåŸå› :{}", e.contentUTF8(), e);
            throw new RuntimeException(e.contentUTF8(), e);
        }
        return order.getId();
    }
}

```

<br/>

- é‡å¯æœåŠ¡å¹¶æµ‹è¯•

é‡å¯ä¸‰ä¸ªæœåŠ¡ï¼Œå†æ¬¡æµ‹è¯•ï¼Œå‘ç°æ— è®ºæ€æ ·ï¼Œä¸‰ä¸ªå¾®æœåŠ¡éƒ½èƒ½æˆåŠŸå›æ»šã€‚

<br/>

### ATæ¨¡å¼

ATæ¨¡å¼åŒæ ·æ˜¯åˆ†é˜¶æ®µæäº¤çš„äº‹åŠ¡æ¨¡å‹ï¼Œä¸è¿‡ç¼ºå¼¥è¡¥äº†XAæ¨¡å‹ä¸­èµ„æºé”å®šå‘¨æœŸè¿‡é•¿çš„ç¼ºé™·ã€‚

<br/>

#### Seataçš„ATæ¨¡å‹

åŸºæœ¬æµç¨‹å›¾ï¼š

![image-20240226001237827](assets/image-20240226001237827.png)

<br/>

é˜¶æ®µä¸€RMçš„å·¥ä½œï¼š

- æ³¨å†Œåˆ†æ”¯äº‹åŠ¡
- è®°å½• `undo-log`ï¼ˆæ•°æ®å¿«ç…§ï¼‰
- æ‰§è¡Œä¸šåŠ¡sqlå¹¶æäº¤
- æŠ¥å‘Šäº‹åŠ¡çŠ¶æ€

é˜¶æ®µäºŒæäº¤æ—¶RMçš„å·¥ä½œï¼š

- åˆ é™¤ `undo-log` å³å¯

é˜¶æ®µäºŒå›æ»šæ—¶RMçš„å·¥ä½œï¼š

- æ ¹æ® `undo-log` æ¢å¤æ•°æ®åˆ°æ›´æ–°å‰

<br/>

#### æµç¨‹æ¢³ç†

æˆ‘ä»¬ç”¨ä¸€ä¸ªçœŸå®çš„ä¸šåŠ¡æ¥æ¢³ç†ä¸‹ATæ¨¡å¼çš„åŸç†ã€‚

æ¯”å¦‚ï¼Œç°åœ¨åˆä¸€ä¸ªæ•°æ®åº“è¡¨ï¼Œè®°å½•ç”¨æˆ·ä½™é¢ï¼š`{"id": 1, "money": 100}`

å…¶ä¸­ä¸€ä¸ªåˆ†æ”¯ä¸šåŠ¡è¦æ‰§è¡Œçš„SQLä¸ºï¼š

```sql
update tb_account set money = money - 10 where id = 1
```

<br/>

ATæ¨¡å¼ä¸‹ï¼Œå½“å‰åˆ†æ”¯äº‹åŠ¡æ‰§è¡Œæµç¨‹å¦‚ä¸‹ï¼š

**ä¸€é˜¶æ®µ**

- TMå‘èµ·å¹¶æ³¨å†Œå…¨å±€äº‹åŠ¡åˆ°TC
- TMè°ƒç”¨åˆ†æ”¯äº‹åŠ¡
- åˆ†æ”¯äº‹åŠ¡å‡†å¤‡æ‰§è¡Œä¸šåŠ¡SQL
- RMæ‹¦æˆªä¸šåŠ¡SQLï¼Œæ ¹æ®whereæ¡ä»¶æŸ¥è¯¢åŸå§‹æ•°æ®ï¼Œå½¢æˆå¿«ç…§
- RMæ‰§è¡Œä¸šåŠ¡SQLï¼Œæäº¤æœ¬åœ°äº‹åŠ¡ï¼Œé‡Šæ”¾æ•°æ®åº“é”ã€‚æ­¤æ—¶ `money = 90`
  ```json
  {
      "id": 1, "money": 100
  }
  ```
- RMæŠ¥å‘Šæœ¬åœ°äº‹åŠ¡çŠ¶æ€ç»™TC

<br/>

**äºŒé˜¶æ®µ**

- TMé€šçŸ¥TCäº‹åŠ¡ç»“æŸ

- TCæ£€æŸ¥åˆ†æ”¯äº‹åŠ¡çŠ¶æ€
  - å¦‚æœéƒ½æˆåŠŸï¼Œåˆ™ç«‹å³åˆ é™¤å¿«ç…§
  - å¦‚æœæœ‰åˆ†æ”¯äº‹åŠ¡å¤±è´¥ï¼Œéœ€è¦å›æ»šã€‚è¯»å–å¿«ç…§æ•°æ®ï¼ˆ`{"id": 1, "money": 100}`ï¼‰ï¼Œå°†å¿«ç…§æ¢å¤åˆ°æ•°æ®åº“ã€‚æ­¤æ—¶æ•°æ®åº“å†æ¬¡æ¢å¤ä¸º100

<br/>

**æµç¨‹å›¾**

![image-20240226010220294](assets/image-20240226010220294.png)

<br/>

:::warning ğŸ’¡æ€è€ƒï¼šç®€è¿°ATæ¨¡å¼ä¸XAæ¨¡å¼æœ€å¤§çš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ

- XAæ¨¡å¼ä¸€é˜¶æ®µä¸æäº¤äº‹åŠ¡ï¼Œé”å®šèµ„æºï¼›ATæ¨¡å¼ä¸€é˜¶æ®µç›´æ¥æäº¤ï¼Œä¸é”å®šèµ„æºã€‚
- XAæ¨¡å¼ä¾èµ–æ•°æ®åº“æœºåˆ¶å®ç°å›æ»šï¼›ATæ¨¡å¼åˆ©ç”¨æ•°æ®å¿«ç…§å®ç°æ•°æ®å›æ»šã€‚
- XAæ¨¡å¼å¼ºä¸€è‡´ï¼›ATæ¨¡å¼æœ€ç»ˆä¸€è‡´

:::

<br/>

#### è„å†™é—®é¢˜

åœ¨å¤šçº¿ç¨‹å¹¶å‘è®¿é—®ATæ¨¡å¼çš„åˆ†å¸ƒå¼äº‹åŠ¡æ—¶ï¼Œæœ‰å¯èƒ½å‡ºç°è„å†™é—®é¢˜ï¼Œå¦‚å›¾ï¼š

![image-20240226010320507](assets/image-20240226010320507.png)

è§£å†³æ€è·¯å°±æ˜¯å¼•å…¥äº†å…¨å±€é”çš„æ¦‚å¿µã€‚åœ¨é‡Šæ”¾DBé”ä¹‹å‰ï¼Œå…ˆæ‹¿åˆ°å…¨å±€é”ã€‚é¿å…åŒä¸€æ—¶åˆ»æœ‰å¦å¤–ä¸€ä¸ªäº‹åŠ¡æ¥æ“ä½œå½“å‰æ•°æ®ã€‚

<br/>

**äº‹åŠ¡2**å› ä¸ºè·å–å…¨å±€é”ï¼Œéœ€è¦å»æ‰§è¡Œ `set money` è¯­å¥ï¼Œä½†æ˜¯**äº‹åŠ¡1**ä¹Ÿåœ¨ç­‰å¾…DBé”ã€‚å› ä¸º**äº‹åŠ¡1**çš„DBé”ç›¸å¯¹**äº‹åŠ¡2**çš„å…¨å±€é”ç­‰å¾…æ—¶é—´æ›´ä¹…ï¼Œ**äº‹åŠ¡2**åœ¨é‡è¯•30æ¬¡åè‡ªåŠ¨é‡Šæ”¾äº†ã€‚

![image-20240226010346849](assets/image-20240226010346849.png)

- DBé”ï¼šæ•°æ®åº“ä¸é‡Šæ”¾ï¼Œä»»ä½•äººéƒ½ä¸èƒ½å¯¹æ•°æ®åº“è¿›è¡Œæ“ä½œã€‚
- å…¨å±€é”ï¼šSeate åœ¨  TC è®°å½•å½“å‰æ“ä½œæŸè¡Œæ•°æ®çš„äº‹åŠ¡ã€‚

<br/>

æ³¨æ„ï¼šå¦‚æœä¸æ˜¯ Seate ç®¡ç†çš„äº‹åŠ¡åˆ™å¯ä»¥å¯¹è¿™æ¡æ•°æ®è¿›è¡Œæ“ä½œã€‚<mark>å¦‚æœæ²¡æœ‰è¢« Seate ç®¡ç†çš„äº‹åŠ¡æ“ä½œäº†å…¶ä»–æ•°æ®åˆ™ä¸ä¼šè¢«é”ã€‚</mark>æ¯”å¦‚ä¿®æ”¹å…¶ä»–å­—æ®µï¼Œä½†æ˜¯ä¹Ÿå¯ä»¥ä¿®æ”¹é‡‘é¢å­—æ®µï¼Œé€ æˆæ•°æ®çš„è„å†™ï¼Œä½†æ˜¯è¿™ä¸ªå‡ ç‡å¾ˆä½ï¼Œä¸»è¦æœ‰ä¸‰ä¸ªæ–¹é¢

- è½¬è´¦ä¸€èˆ¬éƒ½æ˜¯æˆåŠŸçš„ï¼Œå¾ˆå°‘æœ‰éœ€è¦å›æ»šçš„åœºæ™¯
- åˆ†å¸ƒå¼äº‹åŠ¡ï¼Œé“¾è·¯æ¯”è¾ƒé•¿ï¼Œè€—æ—¶æ¯”è¾ƒä¹…ï¼Œå¹¶å‘æ¯”è¾ƒä½
- åœ¨åšä¸šåŠ¡å°½é‡é¿å…å¤šä¸ªä¸šåŠ¡å»æ“ä½œåŒä¸€ä¸ªå­—æ®µï¼Œå¯ä»¥é€šè¿‡ä»£ç è§„èŒƒæ¥è¿›è¡Œé¿å…ã€‚

<br/>


ä½†æ˜¯ Seate ä¹Ÿæœ‰æ–¹æ¡ˆæ¥è¿›è¡Œé¿å…

![image-20240226010413874](assets/image-20240226010413874.png)

<br/>

:::warning ğŸ’¡æ€è€ƒï¼šATæ¨¡å¼ä¼˜ç¼ºç‚¹

ATæ¨¡å¼çš„ä¼˜ç‚¹ï¼š

- ä¸€é˜¶æ®µå®Œæˆç›´æ¥æäº¤äº‹åŠ¡ï¼Œé‡Šæ”¾æ•°æ®åº“èµ„æºï¼Œæ€§èƒ½æ¯”è¾ƒå¥½
- åˆ©ç”¨å…¨å±€é”å®ç°è¯»å†™éš”ç¦»
- æ²¡æœ‰ä»£ç ä¾µå…¥ï¼Œæ¡†æ¶è‡ªåŠ¨å®Œæˆå›æ»šå’Œæäº¤

ATæ¨¡å¼çš„ç¼ºç‚¹ï¼š

- ä¸¤é˜¶æ®µä¹‹é—´å±äºè½¯çŠ¶æ€ï¼Œå±äºæœ€ç»ˆä¸€è‡´
- æ¡†æ¶çš„å¿«ç…§åŠŸèƒ½ä¼šå½±å“æ€§èƒ½ï¼Œä½†æ¯”XAæ¨¡å¼è¦å¥½å¾ˆå¤š

:::

<br/>

#### ATå®ç°

ATæ¨¡å¼ä¸­çš„å¿«ç…§ç”Ÿæˆã€å›æ»šç­‰åŠ¨ä½œéƒ½æ˜¯ç”±æ¡†æ¶è‡ªåŠ¨å®Œæˆï¼Œæ²¡æœ‰ä»»ä½•ä»£ç ä¾µå…¥ï¼Œå› æ­¤å®ç°éå¸¸ç®€å•ã€‚

åªä¸è¿‡ï¼ŒATæ¨¡å¼éœ€è¦ä¸€ä¸ªè¡¨æ¥è®°å½•å…¨å±€é”ã€å¦ä¸€å¼ è¡¨æ¥è®°å½•æ•°æ®å¿«ç…§ `undo_log`ã€‚

<br/>

- å¯¼å…¥æ•°æ®åº“è¡¨ï¼Œè®°å½•å…¨å±€é”ï¼š[Seata-V1.4.2-Client-AT-DB-è„šæœ¬](https://github.com/apache/incubator-seata/tree/v1.4.2/script/client/at/db)

å…¶ä¸­ `lock_table` å¯¼å…¥åˆ°TCæœåŠ¡å…³è”çš„æ•°æ®åº“ï¼Œ`undo_log` è¡¨å¯¼å…¥åˆ°å¾®æœåŠ¡å…³è”çš„æ•°æ®åº“ï¼š

```java
SET NAMES utf8mb4;
SET FOREIGN_KEY_CHECKS = 0;

-- ----------------------------
-- Table structure for undo_log
-- ----------------------------
DROP TABLE IF EXISTS `undo_log`;
CREATE TABLE `undo_log`  (
  `branch_id` bigint(20) NOT NULL COMMENT 'branch transaction id',
  `xid` varchar(100) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL COMMENT 'global transaction id',
  `context` varchar(128) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL COMMENT 'undo_log context,such as serialization',
  `rollback_info` longblob NOT NULL COMMENT 'rollback info',
  `log_status` int(11) NOT NULL COMMENT '0:normal status,1:defense status',
  `log_created` datetime(6) NOT NULL COMMENT 'create datetime',
  `log_modified` datetime(6) NOT NULL COMMENT 'modify datetime',
  UNIQUE INDEX `ux_undo_log`(`xid`, `branch_id`) USING BTREE
) ENGINE = InnoDB CHARACTER SET = utf8 COLLATE = utf8_general_ci COMMENT = 'AT transaction mode undo table' ROW_FORMAT = Compact;

-- ----------------------------
-- Records of undo_log
-- ----------------------------

-- ----------------------------
-- Table structure for lock_table
-- ----------------------------
DROP TABLE IF EXISTS `lock_table`;
CREATE TABLE `lock_table`  (
  `row_key` varchar(128) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL,
  `xid` varchar(96) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL,
  `transaction_id` bigint(20) NULL DEFAULT NULL,
  `branch_id` bigint(20) NOT NULL,
  `resource_id` varchar(256) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL,
  `table_name` varchar(32) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL,
  `pk` varchar(36) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL,
  `gmt_create` datetime NULL DEFAULT NULL,
  `gmt_modified` datetime NULL DEFAULT NULL,
  PRIMARY KEY (`row_key`) USING BTREE,
  INDEX `idx_branch_id`(`branch_id`) USING BTREE
) ENGINE = InnoDB CHARACTER SET = utf8 COLLATE = utf8_general_ci ROW_FORMAT = Compact;


SET FOREIGN_KEY_CHECKS = 1;
```

<br/>

- ä¿®æ”¹ `application.yml` æ–‡ä»¶ï¼Œå°†äº‹åŠ¡æ¨¡å¼ä¿®æ”¹ä¸ºATæ¨¡å¼å³å¯ï¼š

```yaml
seata:
  data-source-proxy-mode: AT # é»˜è®¤å°±æ˜¯AT
```

<br/>

- é‡å¯æœåŠ¡å¹¶æµ‹è¯•


<br/>

### TCCæ¨¡å¼

TCCæ¨¡å¼ä¸ATæ¨¡å¼éå¸¸ç›¸ä¼¼ï¼Œæ¯é˜¶æ®µéƒ½æ˜¯ç‹¬ç«‹äº‹åŠ¡ï¼Œä¸åŒçš„æ˜¯TCCé€šè¿‡äººå·¥ç¼–ç æ¥å®ç°æ•°æ®æ¢å¤ã€‚éœ€è¦å®ç°ä¸‰ä¸ªæ–¹æ³•ï¼š

- Tryï¼šèµ„æºçš„æ£€æµ‹å’Œé¢„ç•™ï¼› 
- Confirmï¼šå®Œæˆèµ„æºæ“ä½œä¸šåŠ¡ï¼›è¦æ±‚ Try æˆåŠŸ Confirm ä¸€å®šè¦èƒ½æˆåŠŸã€‚
- Cancelï¼šé¢„ç•™èµ„æºé‡Šæ”¾ï¼Œå¯ä»¥ç†è§£ä¸ºtryçš„åå‘æ“ä½œã€‚

<br/>

#### æµç¨‹åˆ†æ

ä¸¾ä¾‹ï¼Œä¸€ä¸ªæ‰£å‡ç”¨æˆ·ä½™é¢çš„ä¸šåŠ¡ã€‚å‡è®¾è´¦æˆ·AåŸæ¥ä½™é¢æ˜¯100ï¼Œéœ€è¦ä½™é¢æ‰£å‡30å…ƒã€‚

- **é˜¶æ®µä¸€ï¼ˆ Try ï¼‰**ï¼šæ£€æŸ¥ä½™é¢æ˜¯å¦å……è¶³ï¼Œå¦‚æœå……è¶³åˆ™å†»ç»“é‡‘é¢å¢åŠ 30å…ƒï¼Œå¯ç”¨ä½™é¢æ‰£é™¤30

åˆè¯†ä½™é¢ï¼š

![image-20210724182424907](assets/image-20210724182424907.png)

ä½™é¢å……è¶³ï¼Œå¯ä»¥å†»ç»“ï¼š

![image-20210724182457951](assets/image-20210724182457951.png)

æ­¤æ—¶ï¼Œæ€»é‡‘é¢ = å†»ç»“é‡‘é¢ + å¯ç”¨é‡‘é¢ï¼Œæ•°é‡ä¾ç„¶æ˜¯100ä¸å˜ã€‚äº‹åŠ¡ç›´æ¥æäº¤æ— éœ€ç­‰å¾…å…¶å®ƒäº‹åŠ¡ã€‚

<br/>

- **é˜¶æ®µäºŒï¼ˆConfirm)**ï¼šå‡å¦‚è¦æäº¤ï¼ˆConfirmï¼‰ï¼Œåˆ™å†»ç»“é‡‘é¢æ‰£å‡30

ç¡®è®¤å¯ä»¥æäº¤ï¼Œä¸è¿‡ä¹‹å‰å¯ç”¨é‡‘é¢å·²ç»æ‰£å‡è¿‡äº†ï¼Œè¿™é‡Œåªè¦æ¸…é™¤å†»ç»“é‡‘é¢å°±å¥½äº†ï¼š

![image-20210724182706011](assets/image-20210724182706011.png)

æ­¤æ—¶ï¼Œæ€»é‡‘é¢ = å†»ç»“é‡‘é¢ + å¯ç”¨é‡‘é¢ = 0 + 70  = 70å…ƒ

<br/>

- **é˜¶æ®µäºŒ(Canncel)**ï¼šå¦‚æœè¦å›æ»šï¼ˆCancelï¼‰ï¼Œåˆ™å†»ç»“é‡‘é¢æ‰£å‡30ï¼Œå¯ç”¨ä½™é¢å¢åŠ 30

éœ€è¦å›æ»šï¼Œé‚£ä¹ˆå°±è¦é‡Šæ”¾å†»ç»“é‡‘é¢ï¼Œæ¢å¤å¯ç”¨é‡‘é¢ï¼š

![image-20210724182810734](assets/image-20210724182810734.png)

<br/>

#### Seataçš„TCCæ¨¡å‹

[TCC ç†è®ºåŠè®¾è®¡å®ç°æŒ‡å—ä»‹ç» (seata.io)](http://seata.io/zh-cn/blog/tcc-mode-design-principle.html)

Seataä¸­çš„TCCæ¨¡å‹ä¾ç„¶å»¶ç»­ä¹‹å‰çš„äº‹åŠ¡æ¶æ„ï¼Œå¦‚å›¾ï¼š

![image-20240226014550201](assets/image-20240226014550201.png)

<br/>

:::warning ğŸ’¡æ€è€ƒï¼šTCCæ¨¡å¼çš„ä¼˜ç¼ºç‚¹

**TCCæ¨¡å¼çš„æ¯ä¸ªé˜¶æ®µæ˜¯åšä»€ä¹ˆçš„ï¼Ÿ**

- Tryï¼šèµ„æºæ£€æŸ¥å’Œé¢„ç•™
- Confirmï¼šä¸šåŠ¡æ‰§è¡Œå’Œæäº¤
- Cancelï¼šé¢„ç•™èµ„æºçš„é‡Šæ”¾

<br/>

**TCCçš„ä¼˜ç‚¹æ˜¯ä»€ä¹ˆï¼Ÿ**

- ä¸€é˜¶æ®µå®Œæˆç›´æ¥æäº¤äº‹åŠ¡ï¼Œé‡Šæ”¾æ•°æ®åº“èµ„æºï¼Œæ€§èƒ½å¥½
- ç›¸æ¯”ATæ¨¡å‹ï¼Œæ— éœ€ç”Ÿæˆå¿«ç…§ï¼Œæ— éœ€ä½¿ç”¨å…¨å±€é”ï¼Œæ€§èƒ½æœ€å¼º
- ä¸ä¾èµ–æ•°æ®åº“äº‹åŠ¡ï¼Œè€Œæ˜¯ä¾èµ–è¡¥å¿æ“ä½œï¼Œå¯ä»¥ç”¨äºéäº‹åŠ¡å‹æ•°æ®åº“

<br/>

**TCCçš„ç¼ºç‚¹æ˜¯ä»€ä¹ˆï¼Ÿ**

- æœ‰ä»£ç ä¾µå…¥ï¼Œéœ€è¦äººä¸ºç¼–å†™ Tryã€Confirm å’Œ Cancel æ¥å£ï¼Œå¤ªéº»çƒ¦
- è½¯çŠ¶æ€ï¼Œäº‹åŠ¡æ˜¯æœ€ç»ˆä¸€è‡´
- éœ€è¦è€ƒè™‘ Confirm å’Œ Cancel çš„å¤±è´¥æƒ…å†µï¼Œåšå¥½å¹‚ç­‰å¤„ç†

:::

<br/>

#### TCCå®ç°

æ”¹é€  `account-service` æœåŠ¡ï¼Œåˆ©ç”¨TCCå®ç°åˆ†å¸ƒå¼äº‹åŠ¡

éœ€æ±‚å¦‚ä¸‹ï¼š

- ä¿®æ”¹account-serviceï¼Œç¼–å†™ Tryã€Confirmã€Cancel é€»è¾‘
- Try ä¸šåŠ¡ï¼šæ·»åŠ å†»ç»“é‡‘é¢ï¼Œæ‰£å‡å¯ç”¨é‡‘é¢
- Confirm ä¸šåŠ¡ï¼šåˆ é™¤å†»ç»“é‡‘é¢
- Cancel ä¸šåŠ¡ï¼šåˆ é™¤å†»ç»“é‡‘é¢ï¼Œæ¢å¤å¯ç”¨é‡‘é¢
- ä¿è¯ Confirmã€Cancel æ¥å£çš„<font color="red">å¹‚ç­‰æ€§</font>
- å…è®¸<font color="red">ç©ºå›æ»š</font>
- æ‹’ç»<font color="red">ä¸šåŠ¡æ‚¬æŒ‚</font>

<br/>

##### ç©ºå›æ»š

å½“æŸåˆ†æ”¯äº‹åŠ¡çš„ Try é˜¶æ®µ**é˜»å¡**æ—¶ï¼Œå¯èƒ½å¯¼è‡´å…¨å±€äº‹åŠ¡è¶…æ—¶è€Œè§¦å‘äºŒé˜¶æ®µçš„ Cancel æ“ä½œã€‚åœ¨æœªæ‰§è¡Œ Try æ“ä½œæ—¶å…ˆæ‰§è¡Œäº† Cancel æ“ä½œï¼Œè¿™æ—¶ Cancel ä¸èƒ½åšå›æ»šï¼Œå°±æ˜¯**ç©ºå›æ»š**ã€‚

![image-20240226015341149](assets/image-20240226015341149.png)

æ‰§è¡Œ Cancel æ“ä½œæ—¶ï¼Œåº”å½“åˆ¤æ–­ Try æ˜¯å¦å·²ç»æ‰§è¡Œï¼Œå¦‚æœå°šæœªæ‰§è¡Œï¼Œåˆ™åº”è¯¥ç©ºå›æ»šã€‚

<br/>

##### ä¸šåŠ¡æ‚¬æŒ‚

å¯¹äºå·²ç»ç©ºå›æ»šçš„ä¸šåŠ¡ï¼Œä¹‹å‰è¢«é˜»å¡çš„Tryæ“ä½œæ¢å¤ï¼Œç»§ç»­æ‰§è¡Œ Tryï¼Œå°±æ°¸è¿œä¸å¯èƒ½ Confirm æˆ– Cancel ï¼Œäº‹åŠ¡ä¸€ç›´å¤„äºä¸­é—´çŠ¶æ€ï¼Œè¿™å°±æ˜¯**ä¸šåŠ¡æ‚¬æŒ‚**ã€‚

æ‰§è¡Œ Try æ“ä½œæ—¶ï¼Œåº”å½“åˆ¤æ–­ Cancel æ˜¯å¦å·²ç»æ‰§è¡Œè¿‡äº†ï¼Œå¦‚æœå·²ç»æ‰§è¡Œï¼Œåº”å½“é˜»æ­¢ç©ºå›æ»šåçš„ Try æ“ä½œï¼Œé¿å…æ‚¬æŒ‚ã€‚

<br/>

è§£å†³ç©ºå›æ»šå’Œä¸šåŠ¡æ‚¬æŒ‚é—®é¢˜ï¼Œå¿…é¡»è¦è®°å½•å½“å‰äº‹åŠ¡çŠ¶æ€ï¼Œæ˜¯åœ¨ Tryã€è¿˜æ˜¯ Cancelï¼Ÿ

<br/>

##### ä¸šåŠ¡åˆ†æ

![image-20240226014656090](assets/image-20240226014656090.png)

<br/>

##### æ€è·¯åˆ†æ

è¿™é‡Œæˆ‘ä»¬å®šä¹‰ä¸€å¼ è¡¨ï¼š

```sql
SET NAMES utf8mb4;
SET FOREIGN_KEY_CHECKS = 0;

-- ----------------------------
-- Table structure for account_freeze_tbl
-- ----------------------------
DROP TABLE IF EXISTS `account_freeze_tbl`;
CREATE TABLE `account_freeze_tbl`  (
  `xid` varchar(128) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL,
  `user_id` varchar(255) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL,
  `freeze_money` int(11) UNSIGNED NULL DEFAULT 0,
  `state` int(1) NULL DEFAULT NULL COMMENT 'äº‹åŠ¡çŠ¶æ€ï¼Œ0:tryï¼Œ1:confirmï¼Œ2:cancel',
  PRIMARY KEY (`xid`) USING BTREE
) ENGINE = InnoDB CHARACTER SET = utf8 COLLATE = utf8_general_ci ROW_FORMAT = COMPACT;

-- ----------------------------
-- Records of account_freeze_tbl
-- ----------------------------

SET FOREIGN_KEY_CHECKS = 1;
```

å…¶ä¸­ï¼š

- `xid`ï¼šæ˜¯å…¨å±€äº‹åŠ¡id

- `freeze_money`ï¼šç”¨æ¥è®°å½•ç”¨æˆ·å†»ç»“é‡‘é¢ï¼ŒUNSIGNEDåˆ™ä¸éœ€è¦åˆ¤æ–­ä¸ºè´Ÿæ•°

- `state`ï¼šç”¨æ¥è®°å½•äº‹åŠ¡çŠ¶æ€

<br/>

:::warning ğŸ’¡æ€è€ƒï¼šé‚£æ­¤æ—¶ï¼Œæˆ‘ä»¬çš„ä¸šåŠ¡å¼€æ€ä¹ˆåšå‘¢ï¼Ÿ

- Try ä¸šåŠ¡
  - è®°å½•å†»ç»“é‡‘é¢å’Œäº‹åŠ¡çŠ¶æ€åˆ° account_freeze è¡¨
  - æ‰£å‡ account è¡¨å¯ç”¨é‡‘é¢
- Confirm ä¸šåŠ¡
  - æ ¹æ® xid åˆ é™¤ account_freezeè¡¨ çš„å†»ç»“è®°å½•
- Cancel ä¸šåŠ¡
  - ä¿®æ”¹ account_freeze è¡¨ï¼Œå†»ç»“é‡‘é¢ä¸º 0ï¼Œstate ä¸º2
  - ä¿®æ”¹ account è¡¨ï¼Œæ¢å¤å¯ç”¨é‡‘é¢
- å¦‚ä½•åˆ¤æ–­æ˜¯å¦ç©ºå›æ»šï¼Ÿ
  - cancel ä¸šåŠ¡ä¸­ï¼Œæ ¹æ® xid æŸ¥è¯¢ account_freezeï¼Œå¦‚æœä¸º null åˆ™è¯´æ˜ try è¿˜æ²¡åšï¼Œéœ€è¦ç©ºå›æ»š
- å¦‚ä½•é¿å…ä¸šåŠ¡æ‚¬æŒ‚ï¼Ÿ
  - try ä¸šåŠ¡ä¸­ï¼Œæ ¹æ® xid æŸ¥è¯¢ account_freeze ï¼Œå¦‚æœå·²ç»å­˜åœ¨åˆ™è¯æ˜ Cancelå·²ç»æ‰§è¡Œï¼Œæ‹’ç»æ‰§è¡Œtryä¸šåŠ¡

:::

<br/>

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ”¹é€  `account-service` ï¼Œåˆ©ç”¨TCCå®ç°ä½™é¢æ‰£å‡åŠŸèƒ½ã€‚

<br/>

##### å£°æ˜æ¥å£

TCCçš„Tryã€Confirmã€Cancelæ–¹æ³•éƒ½éœ€è¦åœ¨æ¥å£ä¸­åŸºäºæ³¨è§£æ¥å£°æ˜ï¼Œ

æˆ‘ä»¬åœ¨ `account-service` é¡¹ç›®ä¸­çš„`cn.itcast.account.service`åŒ…ä¸­æ–°å»ºä¸€ä¸ªæ¥å£ï¼Œå£°æ˜TCCä¸‰ä¸ªæ¥å£ï¼š

```java
@LocalTCC
public interface TCCService {
    
    /**
     * Tryé€»è¾‘ï¼Œ@TwoPhaseBusinessAction ä¸­çš„nameå±æ€§è¦ä¸å½“å‰æ–¹æ³•åä¸€è‡´ï¼Œç”¨äºæŒ‡å®šTryé€»è¾‘å¯¹åº”çš„æ–¹æ³•
     */
    @TwoPhaseBusinessAction(name = "deduct", commitMethod = "confirm", rollbackMethod = "cancel")
    void deduct(@BusinessActionContextParameter(paramName = "userId") String userId,
                @BusinessActionContextParameter(paramName = "money") int money);

    /**
     * äºŒé˜¶æ®µconfirmç¡®è®¤æ–¹æ³•ã€å¯ä»¥å¦å‘½åï¼Œä½†è¦ä¿è¯ä¸ commitMethod ä¸€è‡´
     *
     * @param context ä¸Šä¸‹æ–‡,å¯ä»¥ä¼ é€’tryæ–¹æ³•çš„å‚æ•°
     * @return boolean æ‰§è¡Œæ˜¯å¦æˆåŠŸ
     */
    boolean confirm(BusinessActionContext context);

    /**
     * äºŒé˜¶æ®µå›æ»šæ–¹æ³•ï¼Œè¦ä¿è¯ä¸ rollbackMethod ä¸€è‡´
     */
    boolean cancel(BusinessActionContext context);
}
```

<br/>

##### ç¼–å†™å®ç°ç±»

åœ¨ `account-service` æœåŠ¡ä¸­çš„ `cn.itcast.account.service.impl` åŒ…ä¸‹æ–°å»ºä¸€ä¸ªç±»ã€‚

å®ç°TCCçš„Tryã€Confirmã€Cancelæ–¹æ³•

```java
package cn.itcast.account.service.impl;

import cn.itcast.account.entity.AccountFreeze;
import cn.itcast.account.mapper.AccountFreezeMapper;
import cn.itcast.account.mapper.AccountMapper;
import cn.itcast.account.service.AccountTCCService;
import io.seata.core.context.RootContext;
import io.seata.rm.tcc.api.BusinessActionContext;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

@Service
@Slf4j
public class AccountTCCServiceImpl implements AccountTCCService {

    @Autowired
    private AccountMapper accountMapper;
    @Autowired
    private AccountFreezeMapper freezeMapper;

    @Override
    @Transactional
    public void deduct(String userId, int money) {
        // 0.è·å–äº‹åŠ¡id
        String xid = RootContext.getXID();

        // 1.æ‰£å‡å¯ç”¨ä½™é¢
        accountMapper.deduct(userId, money);
      
        // 2.è®°å½•å†»ç»“é‡‘é¢ï¼Œäº‹åŠ¡çŠ¶æ€
        AccountFreeze freeze = new AccountFreeze();
        freeze.setUserId(userId);
        freeze.setFreezeMoney(money);
        freeze.setState(AccountFreeze.State.TRY);
        freeze.setXid(xid);
        freezeMapper.insert(freeze);
    }

    @Override
    public boolean confirm(BusinessActionContext ctx) {
        // 1.è·å–äº‹åŠ¡id
        String xid = ctx.getXid();
      
        // 2.æ ¹æ®idåˆ é™¤å†»ç»“è®°å½•
        int count = freezeMapper.deleteById(xid);
        return count == 1;
    }

    @Override
    public boolean cancel(BusinessActionContext ctx) {
        // 0.æŸ¥è¯¢å†»ç»“è®°å½•
        String xid = ctx.getXid();
        AccountFreeze freeze = freezeMapper.selectById(xid);

        // 1.æ¢å¤å¯ç”¨ä½™é¢
        accountMapper.refund(freeze.getUserId(), freeze.getFreezeMoney());
      
        // 2.å°†å†»ç»“é‡‘é¢æ¸…é›¶ï¼ŒçŠ¶æ€æ”¹ä¸ºCANCEL
        freeze.setFreezeMoney(0);
        freeze.setState(AccountFreeze.State.CANCEL);
        int count = freezeMapper.updateById(freeze);
        return count == 1;
    }
}

```

<br/>

å®ç°TCCçš„å¹‚ç­‰ï¼Œå®ç°ç©ºå›æ»šï¼Œæ‹’ç»ä¸šåŠ¡æ‚¬æŒ‚

```java {29-33,62-72,74-78}
package cn.itcast.account.service.impl;

import cn.itcast.account.entity.AccountFreeze;
import cn.itcast.account.mapper.AccountFreezeMapper;
import cn.itcast.account.mapper.AccountMapper;
import cn.itcast.account.service.AccountTCCService;
import io.seata.core.context.RootContext;
import io.seata.rm.tcc.api.BusinessActionContext;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

@Service
@Slf4j
public class AccountTCCServiceImpl implements AccountTCCService {

    @Autowired
    private AccountMapper accountMapper;
    @Autowired
    private AccountFreezeMapper freezeMapper;

    @Override
    @Transactional
    public void deduct(String userId, int money) {
        // 0.è·å–äº‹åŠ¡id
        String xid = RootContext.getXID();

        // åˆ¤æ–­freezeä¸­æ˜¯å¦æœ‰å†»ç»“è®°å½•ï¼Œå¦‚æœæœ‰ä¸€å®šæ˜¯CANCELæ‰§è¡Œè¿‡ï¼Œè¦æ‹’ç»ä¸šåŠ¡
        AccountFreeze oldFreeze = freezeMapper.selectById(xid);
        if (oldFreeze != null) {
            return;
        }
      
        // 1.æ‰£å‡å¯ç”¨ä½™é¢
        accountMapper.deduct(userId, money);
      
        // 2.è®°å½•å†»ç»“é‡‘é¢ï¼Œäº‹åŠ¡çŠ¶æ€
        AccountFreeze freeze = new AccountFreeze();
        freeze.setUserId(userId);
        freeze.setFreezeMoney(money);
        freeze.setState(AccountFreeze.State.TRY);
        freeze.setXid(xid);
        freezeMapper.insert(freeze);
    }

    @Override
    public boolean confirm(BusinessActionContext ctx) {
        // 1.è·å–äº‹åŠ¡id
        String xid = ctx.getXid();
        // 2.æ ¹æ®idåˆ é™¤å†»ç»“è®°å½•
        int count = freezeMapper.deleteById(xid);
        return count == 1;
    }

    @Override
    public boolean cancel(BusinessActionContext ctx) {
        // 0.æŸ¥è¯¢å†»ç»“è®°å½•
        String xid = ctx.getXid();
        AccountFreeze freeze = freezeMapper.selectById(xid);

        // ç©ºå›æ»šçš„åˆ¤æ–­ï¼Œåˆ¤æ–­freezeæ˜¯å¦ä¸ºç©ºï¼Œä¸ºnullåˆ™è¯æ˜tryæ²¡æœ‰æ‰§è¡Œï¼Œéœ€è¦ç©ºå›æ»š
        if (freeze == null) {
            String userId = ctx.getActionContext("userId").toString();
            freeze = new AccountFreeze();
            freeze.setXid(xid);
            freeze.setUserId(userId);
            freeze.setFreezeMoney(0);
            freeze.setState(AccountFreeze.State.CANCEL);
            freezeMapper.insert(freeze);
            return true;
        }

        // å¹‚ç­‰åˆ¤æ–­
        if (freeze.getState().equals(AccountFreeze.State.CANCEL)) {
            //å·²ç»å¤„ç†è¿‡ä¸€æ¬¡CANCELï¼Œæ— éœ€é‡å¤å¤„ç†
            return true;
        }

        // 1.æ¢å¤å¯ç”¨ä½™é¢
        accountMapper.refund(freeze.getUserId(), freeze.getFreezeMoney());
       
        // 2.å°†å†»ç»“é‡‘é¢æ¸…é›¶ï¼ŒçŠ¶æ€æ”¹ä¸ºCANCEL
        freeze.setFreezeMoney(0);
        freeze.setState(AccountFreeze.State.CANCEL);
        int count = freezeMapper.updateById(freeze);
        return count == 1;
    }
}
```

<br/>

### SAGAæ¨¡å¼

Saga æ¨¡å¼æ˜¯ Seata å³å°†å¼€æºçš„é•¿äº‹åŠ¡è§£å†³æ–¹æ¡ˆï¼Œå°†ç”±èš‚èšé‡‘æœä¸»è¦è´¡çŒ®ã€‚

å…¶ç†è®ºåŸºç¡€æ˜¯Hector & Kenneth  åœ¨1987å¹´å‘è¡¨çš„è®ºæ–‡[Sagas](https://microservices.io/patterns/data/saga.html)ã€‚

Seataå®˜ç½‘å¯¹äºSagaçš„æŒ‡å—ï¼šhttps://seata.io/zh-cn/docs/user/saga.html

<br/>

#### åŸç†

åœ¨ Saga æ¨¡å¼ä¸‹ï¼Œåˆ†å¸ƒå¼äº‹åŠ¡å†…æœ‰å¤šä¸ªå‚ä¸è€…ï¼Œæ¯ä¸€ä¸ªå‚ä¸è€…éƒ½æ˜¯ä¸€ä¸ªå†²æ­£è¡¥å¿æœåŠ¡ï¼Œéœ€è¦ç”¨æˆ·æ ¹æ®ä¸šåŠ¡åœºæ™¯å®ç°å…¶æ­£å‘æ“ä½œå’Œé€†å‘å›æ»šæ“ä½œã€‚

åˆ†å¸ƒå¼äº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œä¾æ¬¡æ‰§è¡Œå„å‚ä¸è€…çš„æ­£å‘æ“ä½œï¼Œå¦‚æœæ‰€æœ‰æ­£å‘æ“ä½œå‡æ‰§è¡ŒæˆåŠŸï¼Œé‚£ä¹ˆåˆ†å¸ƒå¼äº‹åŠ¡æäº¤ã€‚å¦‚æœä»»ä½•ä¸€ä¸ªæ­£å‘æ“ä½œæ‰§è¡Œå¤±è´¥ï¼Œé‚£ä¹ˆåˆ†å¸ƒå¼äº‹åŠ¡ä¼šå»é€€å›å»æ‰§è¡Œå‰é¢å„å‚ä¸è€…çš„é€†å‘å›æ»šæ“ä½œï¼Œå›æ»šå·²æäº¤çš„å‚ä¸è€…ï¼Œä½¿åˆ†å¸ƒå¼äº‹åŠ¡å›åˆ°åˆå§‹çŠ¶æ€ã€‚

![image-20210724184846396](assets/image-20210724184846396.png)

Sagaä¹Ÿåˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼š

- ä¸€é˜¶æ®µï¼šç›´æ¥æäº¤æœ¬åœ°äº‹åŠ¡
- äºŒé˜¶æ®µï¼šæˆåŠŸåˆ™ä»€ä¹ˆéƒ½ä¸åšï¼›å¤±è´¥åˆ™é€šè¿‡ç¼–å†™è¡¥å¿ä¸šåŠ¡æ¥å›æ»š

<br/>

:::warning ğŸ’¡æ€è€ƒï¼šSAGAæ¨¡å¼çš„ä¼˜ç¼ºç‚¹

ä¼˜ç‚¹ï¼š

- äº‹åŠ¡å‚ä¸è€…å¯ä»¥åŸºäºäº‹ä»¶é©±åŠ¨å®ç°å¼‚æ­¥è°ƒç”¨ï¼Œååé«˜
- ä¸€é˜¶æ®µç›´æ¥æäº¤äº‹åŠ¡ï¼Œæ— é”ï¼Œæ€§èƒ½å¥½
- ä¸ç”¨ç¼–å†™TCCä¸­çš„ä¸‰ä¸ªé˜¶æ®µï¼Œå®ç°ç®€å•

ç¼ºç‚¹ï¼š

- è½¯çŠ¶æ€æŒç»­æ—¶é—´ä¸ç¡®å®šï¼Œæ—¶æ•ˆæ€§å·®
- æ²¡æœ‰é”ï¼Œæ²¡æœ‰äº‹åŠ¡éš”ç¦»ï¼Œä¼šæœ‰è„å†™

:::



### å››ç§æ¨¡å¼å¯¹æ¯”

æˆ‘ä»¬ä»ä»¥ä¸‹å‡ ä¸ªæ–¹é¢æ¥å¯¹æ¯”å››ç§å®ç°ï¼š

- ä¸€è‡´æ€§ï¼šèƒ½å¦ä¿è¯äº‹åŠ¡çš„ä¸€è‡´æ€§ï¼Ÿå¼ºä¸€è‡´è¿˜æ˜¯æœ€ç»ˆä¸€è‡´ï¼Ÿ
- éš”ç¦»æ€§ï¼šäº‹åŠ¡ä¹‹é—´çš„éš”ç¦»æ€§å¦‚ä½•ï¼Ÿ
- ä»£ç ä¾µå…¥ï¼šæ˜¯å¦éœ€è¦å¯¹ä¸šåŠ¡ä»£ç æ”¹é€ ï¼Ÿ
- æ€§èƒ½ï¼šæœ‰æ— æ€§èƒ½æŸè€—ï¼Ÿ
- åœºæ™¯ï¼šå¸¸è§çš„ä¸šåŠ¡åœºæ™¯

<br/>

**å¦‚å›¾**

![image-20240226231302526](assets/image-20240226231302526.png)



## é«˜å¯ç”¨

Seataçš„TCæœåŠ¡ä½œä¸ºåˆ†å¸ƒå¼äº‹åŠ¡æ ¸å¿ƒï¼Œä¸€å®šè¦ä¿è¯é›†ç¾¤çš„é«˜å¯ç”¨æ€§ã€‚

<br/>

### é«˜å¯ç”¨æ¶æ„æ¨¡å‹

æ­å»ºTCæœåŠ¡é›†ç¾¤éå¸¸ç®€å•ï¼Œå¯åŠ¨å¤šä¸ªTCæœåŠ¡ï¼Œæ³¨å†Œåˆ°nacoså³å¯ã€‚

ä½†é›†ç¾¤å¹¶ä¸èƒ½ç¡®ä¿100%å®‰å…¨ï¼Œä¸‡ä¸€é›†ç¾¤æ‰€åœ¨æœºæˆ¿æ•…éšœæ€ä¹ˆåŠï¼Ÿæ‰€ä»¥å¦‚æœè¦æ±‚è¾ƒé«˜ï¼Œä¸€èˆ¬éƒ½ä¼šåšå¼‚åœ°å¤šæœºæˆ¿å®¹ç¾ã€‚

æ¯”å¦‚ä¸€ä¸ªTCé›†ç¾¤åœ¨ä¸Šæµ·ï¼Œå¦ä¸€ä¸ªTCé›†ç¾¤åœ¨æ­å·ï¼š

![image-20240226231327165](assets/image-20240226231327165.png)

<br/>

å¾®æœåŠ¡åŸºäºäº‹åŠ¡ç»„`tx-service-group` ä¸TCé›†ç¾¤çš„æ˜ å°„å…³ç³»ï¼Œæ¥æŸ¥æ‰¾å½“å‰åº”è¯¥ä½¿ç”¨å“ªä¸ªTCé›†ç¾¤ã€‚å½“SHé›†ç¾¤æ•…éšœæ—¶ï¼Œåªéœ€è¦å°† `vgroup-mapping` ä¸­çš„æ˜ å°„å…³ç³»æ”¹æˆHZã€‚åˆ™æ‰€æœ‰å¾®æœåŠ¡å°±ä¼šåˆ‡æ¢åˆ°HZçš„TCé›†ç¾¤äº†ã€‚

<br/>

### å®ç°é«˜å¯ç”¨

#### æ¨¡æ‹Ÿå¼‚åœ°å®¹ç¾çš„TCé›†ç¾¤

è®¡åˆ’å¯åŠ¨ä¸¤å°seataçš„tcæœåŠ¡èŠ‚ç‚¹ï¼š

| èŠ‚ç‚¹åç§° | ipåœ°å€    | ç«¯å£å· | é›†ç¾¤åç§° |
| -------- | --------- | ------ | -------- |
| seata    | 127.0.0.1 | 8091   | SH       |
| seata2   | 127.0.0.1 | 8092   | HZ       |

ä¹‹å‰æˆ‘ä»¬å·²ç»å¯åŠ¨äº†ä¸€å°seataæœåŠ¡ï¼Œç«¯å£æ˜¯8091ï¼Œé›†ç¾¤åä¸ºSHã€‚

ç°åœ¨ï¼Œå°†seataç›®å½•å¤åˆ¶ä¸€ä»½ï¼Œèµ·åä¸ºseata2

<br/>

ä¿®æ”¹ `seata2/conf/registry.conf` å†…å®¹å¦‚ä¸‹ï¼š

```nginx
registry {
  # tcæœåŠ¡çš„æ³¨å†Œä¸­å¿ƒç±»ï¼Œè¿™é‡Œé€‰æ‹©nacosï¼Œä¹Ÿå¯ä»¥æ˜¯eurekaã€zookeeperç­‰
  type = "nacos"

  nacos {
    # seata tc æœåŠ¡æ³¨å†Œåˆ° nacosçš„æœåŠ¡åç§°ï¼Œå¯ä»¥è‡ªå®šä¹‰
    application = "seata-tc-server"
    serverAddr = "127.0.0.1:8848"
    group = "DEFAULT_GROUP"
    namespace = ""
    cluster = "HZ"
    username = "nacos"
    password = "nacos"
  }
}

config {
  # è¯»å–tcæœåŠ¡ç«¯çš„é…ç½®æ–‡ä»¶çš„æ–¹å¼ï¼Œè¿™é‡Œæ˜¯ä»nacosé…ç½®ä¸­å¿ƒè¯»å–ï¼Œè¿™æ ·å¦‚æœtcæ˜¯é›†ç¾¤ï¼Œå¯ä»¥å…±äº«é…ç½®
  type = "nacos"
  # é…ç½®nacosåœ°å€ç­‰ä¿¡æ¯
  nacos {
    serverAddr = "127.0.0.1:8848"
    namespace = ""
    group = "SEATA_GROUP"
    username = "nacos"
    password = "nacos"
    dataId = "seataServer.properties"
  }
}
```

<br/>

è¿›å…¥ `seata2/bin` ç›®å½•ï¼Œç„¶åè¿è¡Œå‘½ä»¤ï¼š

```powershell
seata-server.bat -p 8092
```

<br/>

æ‰“å¼€nacosæ§åˆ¶å°ï¼ŒæŸ¥çœ‹æœåŠ¡åˆ—è¡¨ï¼š

![image-20210624151150840](assets/image-20210624151150840.png)

ç‚¹è¿›è¯¦æƒ…æŸ¥çœ‹ï¼š

![image-20210624151221747](assets/image-20210624151221747.png)

<br/>

#### å°†äº‹åŠ¡ç»„æ˜ å°„é…ç½®åˆ°nacos

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦å°† `tx-service-group` ä¸ `cluster` çš„æ˜ å°„å…³ç³»éƒ½é…ç½®åˆ° `nacos` é…ç½®ä¸­å¿ƒã€‚

<br/>

æ–°å»ºä¸€ä¸ªé…ç½®

![image-20210624151507072](assets/image-20210624151507072.png)

<br/>

é…ç½®çš„å†…å®¹å¦‚ä¸‹

```properties
# äº‹åŠ¡ç»„æ˜ å°„å…³ç³»
service.vgroupMapping.seata-demo=SH

service.enableDegrade=false
service.disableGlobalTransaction=false
# ä¸TCæœåŠ¡çš„é€šä¿¡é…ç½®
transport.type=TCP
transport.server=NIO
transport.heartbeat=true
transport.enableClientBatchSendRequest=false
transport.threadFactory.bossThreadPrefix=NettyBoss
transport.threadFactory.workerThreadPrefix=NettyServerNIOWorker
transport.threadFactory.serverExecutorThreadPrefix=NettyServerBizHandler
transport.threadFactory.shareBossWorker=false
transport.threadFactory.clientSelectorThreadPrefix=NettyClientSelector
transport.threadFactory.clientSelectorThreadSize=1
transport.threadFactory.clientWorkerThreadPrefix=NettyClientWorkerThread
transport.threadFactory.bossThreadSize=1
transport.threadFactory.workerThreadSize=default
transport.shutdown.wait=3
# RMé…ç½®
client.rm.asyncCommitBufferLimit=10000
client.rm.lock.retryInterval=10
client.rm.lock.retryTimes=30
client.rm.lock.retryPolicyBranchRollbackOnConflict=true
client.rm.reportRetryCount=5
client.rm.tableMetaCheckEnable=false
client.rm.tableMetaCheckerInterval=60000
client.rm.sqlParserType=druid
client.rm.reportSuccessEnable=false
client.rm.sagaBranchRegisterEnable=false
# TMé…ç½®
client.tm.commitRetryCount=5
client.tm.rollbackRetryCount=5
client.tm.defaultGlobalTransactionTimeout=60000
client.tm.degradeCheck=false
client.tm.degradeCheckAllowTimes=10
client.tm.degradeCheckPeriod=2000

# undoæ—¥å¿—é…ç½®
client.undo.dataValidation=true
client.undo.logSerialization=jackson
client.undo.onlyCareUpdateColumns=true
client.undo.logTable=undo_log
client.undo.compress.enable=true
client.undo.compress.type=zip
client.undo.compress.threshold=64k
client.log.exceptionRate=100
```

<br/>

#### å¾®æœåŠ¡è¯»å–nacosé…ç½®

æ¥ä¸‹æ¥ï¼Œéœ€è¦ä¿®æ”¹æ¯ä¸€ä¸ªå¾®æœåŠ¡çš„application.ymlæ–‡ä»¶ï¼Œè®©å¾®æœåŠ¡è¯»å–nacosä¸­çš„client.propertiesæ–‡ä»¶ï¼š

```yaml
seata:
  config:
    type: nacos
    nacos:
      server-addr: 127.0.0.1:8848
      username: nacos
      password: nacos
      group: SEATA_GROUP
      data-id: client.properties
```

é‡å¯å¾®æœåŠ¡ï¼Œç°åœ¨å¾®æœåŠ¡åˆ°åº•æ˜¯è¿æ¥tcçš„SHé›†ç¾¤ï¼Œè¿˜æ˜¯tcçš„HZé›†ç¾¤ï¼Œéƒ½ç»Ÿä¸€ç”±nacosçš„client.propertiesæ¥å†³å®šäº†ã€‚






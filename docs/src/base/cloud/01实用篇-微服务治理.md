# å¾®æœåŠ¡æ²»ç†

[[toc]]



## è®¤è¯†å¾®æœåŠ¡

éšç€äº’è”ç½‘è¡Œä¸šçš„å‘å±•ï¼Œå¯¹æœåŠ¡çš„è¦æ±‚ä¹Ÿè¶Šæ¥è¶Šé«˜ï¼ŒæœåŠ¡æ¶æ„ä¹Ÿä»å•ä½“æ¶æ„é€æ¸æ¼”å˜ä¸ºç°åœ¨æµè¡Œçš„å¾®æœåŠ¡æ¶æ„ã€‚è¿™äº›æ¶æ„ä¹‹é—´æœ‰æ€æ ·çš„å·®åˆ«å‘¢ï¼Ÿ

<br/>

### å•ä½“æ¶æ„

**å•ä½“æ¶æ„**ï¼šå°†ä¸šåŠ¡çš„æ‰€æœ‰åŠŸèƒ½é›†ä¸­åœ¨ä¸€ä¸ªé¡¹ç›®ä¸­å¼€å‘ï¼Œæ‰“æˆä¸€ä¸ªåŒ…éƒ¨ç½²ã€‚

![image-20240227210041902](assets/image-20240227210041902.png)

:::warning ğŸ’¡å•ä½“æ¶æ„çš„ä¼˜ç¼ºç‚¹å¦‚ä¸‹

**ä¼˜ç‚¹**

- æ¶æ„ç®€å•
- éƒ¨ç½²æˆæœ¬ä½

**ç¼ºç‚¹**

- è€¦åˆåº¦é«˜ï¼ˆç»´æŠ¤å›°éš¾ã€å‡çº§å›°éš¾ï¼‰

:::

<br/>

### åˆ†å¸ƒå¼æ¶æ„

**åˆ†å¸ƒå¼æ¶æ„**ï¼šæ ¹æ®ä¸šåŠ¡åŠŸèƒ½å¯¹ç³»ç»Ÿåšæ‹†åˆ†ï¼Œæ¯ä¸ªä¸šåŠ¡åŠŸèƒ½æ¨¡å—ä½œä¸ºç‹¬ç«‹é¡¹ç›®å¼€å‘ï¼Œç§°ä¸ºä¸€ä¸ªæœåŠ¡ã€‚

![image-20240227210116355](assets/image-20240227210116355.png)

:::warning ğŸ’¡åˆ†å¸ƒå¼æ¶æ„çš„ä¼˜ç¼ºç‚¹

**ä¼˜ç‚¹**

- é™ä½æœåŠ¡è€¦åˆ
- æœ‰åˆ©äºæœåŠ¡å‡çº§å’Œæ‹“å±•

**ç¼ºç‚¹**

- æœåŠ¡è°ƒç”¨å…³ç³»é”™ç»¼å¤æ‚

:::

<br/>

åˆ†å¸ƒå¼æ¶æ„è™½ç„¶é™ä½äº†æœåŠ¡è€¦åˆï¼Œä½†æ˜¯æœåŠ¡æ‹†åˆ†æ—¶ä¹Ÿæœ‰å¾ˆå¤šé—®é¢˜éœ€è¦æ€è€ƒï¼š

- æœåŠ¡æ‹†åˆ†çš„ç²’åº¦å¦‚ä½•ç•Œå®šï¼Ÿ
- æœåŠ¡ä¹‹é—´å¦‚ä½•è°ƒç”¨ï¼Ÿ
- æœåŠ¡çš„è°ƒç”¨å…³ç³»å¦‚ä½•ç®¡ç†ï¼Ÿ

äººä»¬éœ€è¦åˆ¶å®šä¸€å¥—è¡Œä¹‹æœ‰æ•ˆçš„æ ‡å‡†æ¥çº¦æŸåˆ†å¸ƒå¼æ¶æ„ã€‚

<br/>

### å¾®æœåŠ¡æ¶æ„

å¾®æœåŠ¡çš„æ¶æ„ç‰¹å¾

- **å•ä¸€èŒè´£**ï¼šå¾®æœåŠ¡æ‹†åˆ†ç²’åº¦æ›´å°ï¼Œæ¯ä¸€ä¸ªæœåŠ¡éƒ½å¯¹åº”å”¯ä¸€çš„ä¸šåŠ¡èƒ½åŠ›ï¼Œåšåˆ°å•ä¸€èŒè´£
- **è‡ªæ²»**ï¼šå›¢é˜Ÿç‹¬ç«‹ã€æŠ€æœ¯ç‹¬ç«‹ã€æ•°æ®ç‹¬ç«‹ï¼Œç‹¬ç«‹éƒ¨ç½²å’Œäº¤ä»˜
- **é¢å‘æœåŠ¡**ï¼šæœåŠ¡æä¾›ç»Ÿä¸€æ ‡å‡†çš„æ¥å£ï¼Œä¸è¯­è¨€å’ŒæŠ€æœ¯æ— å…³
- **éš”ç¦»æ€§å¼º**ï¼šæœåŠ¡è°ƒç”¨åšå¥½éš”ç¦»ã€å®¹é”™ã€é™çº§ï¼Œé¿å…å‡ºç°çº§è”é—®é¢˜

![image-20240227210202994](assets/image-20240227210202994.png)

<br/>

å¾®æœåŠ¡çš„ä¸Šè¿°ç‰¹æ€§å…¶å®æ˜¯åœ¨ç»™åˆ†å¸ƒå¼æ¶æ„åˆ¶å®šä¸€ä¸ªæ ‡å‡†ï¼Œè¿›ä¸€æ­¥é™ä½æœåŠ¡ä¹‹é—´çš„è€¦åˆåº¦ï¼Œæä¾›æœåŠ¡çš„ç‹¬ç«‹æ€§å’Œçµæ´»æ€§ã€‚åšåˆ°é«˜å†…èšï¼Œä½è€¦åˆã€‚

å› æ­¤ï¼Œå¯ä»¥è®¤ä¸º**å¾®æœåŠ¡**æ˜¯ä¸€ç§ç»è¿‡è‰¯å¥½æ¶æ„è®¾è®¡çš„**åˆ†å¸ƒå¼æ¶æ„æ–¹æ¡ˆ** ã€‚

<br/>

ä½†æ–¹æ¡ˆè¯¥æ€ä¹ˆè½åœ°ï¼Ÿé€‰ç”¨ä»€ä¹ˆæ ·çš„æŠ€æœ¯æ ˆï¼Ÿå…¨çƒçš„äº’è”ç½‘å…¬å¸éƒ½åœ¨ç§¯æå°è¯•è‡ªå·±çš„å¾®æœåŠ¡è½åœ°æ–¹æ¡ˆã€‚

å…¶ä¸­åœ¨ Java é¢†åŸŸæœ€å¼•äººæ³¨ç›®çš„å°±æ˜¯ SpringCloud æä¾›çš„æ–¹æ¡ˆäº†ã€‚

<br/>

### SpringCloud

SpringCloudæ˜¯ç›®å‰å›½å†…ä½¿ç”¨æœ€å¹¿æ³›çš„å¾®æœåŠ¡æ¡†æ¶ã€‚

- å®˜ç½‘åœ°å€ï¼šhttps://spring.io/projects/spring-cloud

SpringCloud é›†æˆäº†å„ç§å¾®æœåŠ¡åŠŸèƒ½ç»„ä»¶ï¼Œå¹¶åŸºäº SpringBoot å®ç°äº†è¿™äº›ç»„ä»¶çš„è‡ªåŠ¨è£…é…ï¼Œä»è€Œæä¾›äº†è‰¯å¥½çš„å¼€ç®±å³ç”¨ä½“éªŒã€‚

<br/>

å…¶ä¸­å¸¸è§çš„ç»„ä»¶åŒ…æ‹¬ï¼š

![image-20240227210235796](assets/image-20240227210235796.png)

<br/>

å¦å¤–ï¼ŒSpringCloud åº•å±‚æ˜¯ä¾èµ–äº SpringBoot ï¼Œå¹¶ä¸”æœ‰ç‰ˆæœ¬çš„å…¼å®¹å…³ç³»ï¼Œå¦‚ä¸‹ï¼š

![image-20240227210422983](assets/image-20240227210422983.png)

æˆ‘ä»¬è¯¾å ‚å­¦ä¹ çš„ç‰ˆæœ¬æ˜¯ Hoxton.SR10ï¼Œå› æ­¤å¯¹åº”çš„ SpringBoot ç‰ˆæœ¬æ˜¯2.3.xç‰ˆæœ¬ã€‚

<br/>

:::warning ğŸ’¡æ€»ç»“

- å•ä½“æ¶æ„ï¼šç®€å•æ–¹ä¾¿ï¼Œé«˜åº¦è€¦åˆï¼Œæ‰©å±•æ€§å·®ï¼Œé€‚åˆå°å‹é¡¹ç›®ã€‚ä¾‹å¦‚ï¼šå­¦ç”Ÿç®¡ç†ç³»ç»Ÿ

- åˆ†å¸ƒå¼æ¶æ„ï¼šæ¾è€¦åˆï¼Œæ‰©å±•æ€§å¥½ï¼Œä½†æ¶æ„å¤æ‚ï¼Œéš¾åº¦å¤§ã€‚é€‚åˆå¤§å‹äº’è”ç½‘é¡¹ç›®ï¼Œä¾‹å¦‚ï¼šäº¬ä¸œã€æ·˜å®

- å¾®æœåŠ¡ï¼šä¸€ç§è‰¯å¥½çš„åˆ†å¸ƒå¼æ¶æ„æ–¹æ¡ˆ
  - ä¼˜ç‚¹ï¼šæ‹†åˆ†ç²’åº¦æ›´å°ã€æœåŠ¡æ›´ç‹¬ç«‹ã€è€¦åˆåº¦æ›´ä½
  
  - ç¼ºç‚¹ï¼šæ¶æ„éå¸¸å¤æ‚ï¼Œè¿ç»´ã€ç›‘æ§ã€éƒ¨ç½²éš¾åº¦æé«˜
  
- SpringCloud æ˜¯å¾®æœåŠ¡æ¶æ„çš„ä¸€ç«™å¼è§£å†³æ–¹æ¡ˆï¼Œé›†æˆäº†å„ç§ä¼˜ç§€å¾®æœåŠ¡åŠŸèƒ½ç»„ä»¶

:::

<br/>

## æœåŠ¡æ‹†åˆ†ä¸è°ƒç”¨

ä»»ä½•åˆ†å¸ƒå¼æ¶æ„éƒ½ç¦»ä¸å¼€æœåŠ¡çš„æ‹†åˆ†ï¼Œå¾®æœåŠ¡ä¹Ÿæ˜¯ä¸€æ ·ã€‚

<br/>

### æœåŠ¡æ‹†åˆ†åŸåˆ™

è¿™é‡Œæˆ‘æ€»ç»“äº†å¾®æœåŠ¡æ‹†åˆ†æ—¶çš„å‡ ä¸ªåŸåˆ™ï¼š

- ä¸åŒå¾®æœåŠ¡ï¼Œä¸è¦é‡å¤å¼€å‘ç›¸åŒä¸šåŠ¡
- å¾®æœåŠ¡æ•°æ®ç‹¬ç«‹ï¼Œä¸è¦è®¿é—®å…¶å®ƒå¾®æœåŠ¡çš„æ•°æ®åº“
- å¾®æœåŠ¡å¯ä»¥å°†è‡ªå·±çš„ä¸šåŠ¡æš´éœ²ä¸ºæ¥å£ï¼Œä¾›å…¶å®ƒå¾®æœåŠ¡è°ƒç”¨

![image-20240227210509888](assets/image-20240227210509888.png)

<br/>

### æœåŠ¡æ‹†åˆ†ç¤ºä¾‹

Giteeä»“åº“æä¾›äº†ä¸€ä¸ªDemoå·¥ç¨‹ï¼š[cloud-demo](https://gitee.com/iMousse/cswiki-project/tree/master/cloud/cloud-demo)

```sh
# çˆ¶å·¥ç¨‹ï¼Œç®¡ç†ä¾èµ–
cloud-demo
â”‚Â Â # è®¢å•å¾®æœåŠ¡ï¼Œè´Ÿè´£è®¢å•ç›¸å…³ä¸šåŠ¡
â”œâ”€â”€ order-service 
â”‚Â Â # ç”¨æˆ·å¾®æœåŠ¡ï¼Œè´Ÿè´£ç”¨æˆ·ç›¸å…³ä¸šåŠ¡
â””â”€â”€ user-service
```

<br/>

:::tip ğŸ”– æœåŠ¡æ‹†åˆ†è¦æ±‚

- è®¢å•å¾®æœåŠ¡å’Œç”¨æˆ·å¾®æœåŠ¡éƒ½å¿…é¡»æœ‰å„è‡ªçš„æ•°æ®åº“ï¼Œç›¸äº’ç‹¬ç«‹
- è®¢å•æœåŠ¡å’Œç”¨æˆ·æœåŠ¡éƒ½å¯¹å¤–æš´éœ²Restfulçš„æ¥å£
- è®¢å•æœåŠ¡å¦‚æœéœ€è¦æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ï¼Œåªèƒ½è°ƒç”¨ç”¨æˆ·æœåŠ¡çš„Restfulæ¥å£ï¼Œä¸èƒ½æŸ¥è¯¢ç”¨æˆ·æ•°æ®åº“

:::

<br/>

#### å¯¼å…¥SQL

é¦–å…ˆï¼Œå°†æä¾›çš„ `cloud-order.sql` å’Œ `cloud-user.sql` å¯¼å…¥åˆ° MySQL ä¸­ï¼š

```SQL
SET NAMES utf8mb4;
SET FOREIGN_KEY_CHECKS = 0;

CREATE DATABASE IF NOT EXISTS cloud_order;
USE cloud_order;

-- ----------------------------
-- Table structure for tb_order
-- ----------------------------
DROP TABLE IF EXISTS `tb_order`;
CREATE TABLE `tb_order`  (
  `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT 'è®¢å•id',
  `user_id` bigint(20) NOT NULL COMMENT 'ç”¨æˆ·id',
  `name` varchar(100) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL COMMENT 'å•†å“åç§°',
  `price` bigint(20) NOT NULL COMMENT 'å•†å“ä»·æ ¼',
  `num` int(10) NULL DEFAULT 0 COMMENT 'å•†å“æ•°é‡',
  PRIMARY KEY (`id`) USING BTREE,
  UNIQUE INDEX `username`(`name`) USING BTREE
) ENGINE = InnoDB AUTO_INCREMENT = 109 CHARACTER SET = utf8 COLLATE = utf8_general_ci ROW_FORMAT = Compact;

-- ----------------------------
-- Records of tb_order
-- ----------------------------
INSERT INTO `tb_order` VALUES (101, 1, 'Apple è‹¹æœ iPhone 12 ', 699900, 1);
INSERT INTO `tb_order` VALUES (102, 2, 'é›…è¿ª yadea æ–°å›½æ ‡ç”µåŠ¨è½¦', 209900, 1);
INSERT INTO `tb_order` VALUES (103, 3, 'éª†é©¼ï¼ˆCAMELï¼‰ä¼‘é—²è¿åŠ¨é‹å¥³', 43900, 1);
INSERT INTO `tb_order` VALUES (104, 4, 'å°ç±³10 åŒæ¨¡5G éªé¾™865', 359900, 1);
INSERT INTO `tb_order` VALUES (105, 5, 'OPPO Reno3 Pro åŒæ¨¡5G è§†é¢‘åŒé˜²æŠ–', 299900, 1);
INSERT INTO `tb_order` VALUES (106, 6, 'ç¾çš„ï¼ˆMidea) æ–°èƒ½æ•ˆ å†·é™æ˜ŸII ', 544900, 1);
INSERT INTO `tb_order` VALUES (107, 2, 'è¥¿æ˜Š/SIHOO äººä½“å·¥å­¦ç”µè„‘æ¤…å­', 79900, 1);
INSERT INTO `tb_order` VALUES (108, 3, 'æ¢µç­ï¼ˆFAMDBANNï¼‰ä¼‘é—²ç”·é‹', 31900, 1);

CREATE DATABASE IF NOT EXISTS cloud_user;
USE cloud_user;
-- ----------------------------
-- Table structure for tb_user
-- ----------------------------
DROP TABLE IF EXISTS `tb_user`;
CREATE TABLE `tb_user`  (
  `id` bigint(20) NOT NULL AUTO_INCREMENT,
  `username` varchar(100) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL COMMENT 'æ”¶ä»¶äºº',
  `address` varchar(255) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL COMMENT 'åœ°å€',
  PRIMARY KEY (`id`) USING BTREE,
  UNIQUE INDEX `username`(`username`) USING BTREE
) ENGINE = InnoDB AUTO_INCREMENT = 109 CHARACTER SET = utf8 COLLATE = utf8_general_ci ROW_FORMAT = Compact;

-- ----------------------------
-- Records of tb_user
-- ----------------------------
INSERT INTO `tb_user` VALUES (1, 'æŸ³å²©', 'æ¹–å—çœè¡¡é˜³å¸‚');
INSERT INTO `tb_user` VALUES (2, 'æ–‡äºŒç‹—', 'é™•è¥¿çœè¥¿å®‰å¸‚');
INSERT INTO `tb_user` VALUES (3, 'åæ²‰é±¼', 'æ¹–åŒ—çœåå °å¸‚');
INSERT INTO `tb_user` VALUES (4, 'å¼ å¿…æ²‰', 'å¤©æ´¥å¸‚');
INSERT INTO `tb_user` VALUES (5, 'éƒ‘çˆ½çˆ½', 'è¾½å®çœæ²ˆé˜³å¸‚å¤§ä¸œåŒº');
INSERT INTO `tb_user` VALUES (6, 'èŒƒå…µå…µ', 'å±±ä¸œçœé’å²›å¸‚');

SET FOREIGN_KEY_CHECKS = 1;
```

> ğŸ’¡ æ³¨æ„ï¼šcloud-order è¡¨ä¸­æŒæœ‰ cloud-user è¡¨ä¸­çš„ id å­—æ®µã€‚
>

<br/>

### å®ç°è¿œç¨‹è°ƒç”¨æ¡ˆä¾‹

åœ¨ order-service æœåŠ¡ä¸­ï¼Œæœ‰ä¸€ä¸ªæ ¹æ®idæŸ¥è¯¢è®¢å•çš„æ¥å£ï¼š

```java
@RestController
@RequestMapping("order")
public class OrderController {

   @Autowired
   private OrderService orderService;

    @GetMapping("{orderId}")
    public Order queryOrderByUserId(@PathVariable("orderId") Long orderId) {
        // æ ¹æ®idæŸ¥è¯¢è®¢å•å¹¶è¿”å›
        return orderService.queryOrderById(orderId);
    }
}
```

<br/>

æ ¹æ®idæŸ¥è¯¢è®¢å•ï¼Œè¿”å›å€¼æ˜¯Orderå¯¹è±¡ï¼Œ[localhost:8080/order/101](http://localhost:8080/order/101)

```json
{
    "id": 101,
    "price": 699900,
    "name": "Apple è‹¹æœ iPhone 12 ",
    "num": 1,
    "userId": 1,
    "user": null
}
```

<br/>

åœ¨ `user-service` ä¸­æœ‰ä¸€ä¸ªæ ¹æ®idæŸ¥è¯¢ç”¨æˆ·çš„æ¥å£ï¼š

```java
@Slf4j
@RestController
@RequestMapping("/user")
public class UserController {

  @Autowired
  private UserService userService;


  @GetMapping("/{id}")
  public User queryById(@PathVariable("id") Long id) {
  	return userService.queryById(id);
	}
}
```

<br/>

æŸ¥è¯¢çš„ç»“æœå¦‚å›¾ï¼š[localhost:8081/user/1](http://localhost:8081/user/1)

```json
{
    "id": 1,
    "username": "æŸ³å²©",
    "address": "æ¹–å—çœè¡¡é˜³å¸‚"
}
```

<br/>

#### æ¡ˆä¾‹éœ€æ±‚

ä¿®æ”¹ `order-service` ä¸­çš„æ ¹æ® ID æŸ¥è¯¢è®¢å•ä¸šåŠ¡ï¼Œè¦æ±‚åœ¨æŸ¥è¯¢è®¢å•çš„åŒæ—¶ï¼Œæ ¹æ®è®¢å•ä¸­åŒ…å«çš„ userId æŸ¥è¯¢å‡ºç”¨æˆ·ä¿¡æ¯ï¼Œä¸€èµ·è¿”å›ã€‚

![image-20240227212133635](assets/image-20240227212133635.png)

å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ order-service ä¸­å‘ user-service å‘èµ·ä¸€ä¸ª http çš„è¯·æ±‚ï¼Œè°ƒç”¨ï¼š[localhost:8080/order/101](http://localhost:8080/order/101)

<br/>

å¤§æ¦‚åœ¨ `order-service` æœåŠ¡ä¸­çš„æ­¥éª¤æ˜¯è¿™æ ·çš„ï¼š

- æ³¨å†Œä¸€ä¸ª RestTemplate çš„å®ä¾‹åˆ° Spring å®¹å™¨
- ä¿®æ”¹ OrderService ç±»ä¸­çš„ queryOrderByIdï¼Œå¹¶é€šè¿‡ URL æŸ¥æ‰¾ `user-service` ä¸­çš„ç”¨æˆ·
- å°†æŸ¥è¯¢çš„ User å¡«å……åˆ° Order å¯¹è±¡ï¼Œä¸€èµ·è¿”å›

<br/>

#### æ³¨å†ŒRestTemplate

é¦–å…ˆï¼Œæˆ‘ä»¬åœ¨ order-service æœåŠ¡ä¸­çš„ OrderApplication å¯åŠ¨ç±»ä¸­ï¼Œæ³¨å†Œ RestTemplate å®ä¾‹ï¼š

```java {17-20}
package cn.itcast.order;

import org.mybatis.spring.annotation.MapperScan;
import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.context.annotation.Bean;
import org.springframework.web.client.RestTemplate;

@MapperScan("cn.itcast.order.mapper")
@SpringBootApplication
public class OrderApplication {

    public static void main(String[] args) {
        SpringApplication.run(OrderApplication.class, args);
    }

    @Bean
    public RestTemplate restTemplate() {
        return new RestTemplate();
    }
}
```

<br/>

#### å®ç°è¿œç¨‹è°ƒç”¨

ä¿®æ”¹ order-service æœåŠ¡ä¸­çš„ OrderService ç±»ä¸­çš„ queryOrderById æ–¹æ³•ï¼š

```java {28-31}
package cn.itcast.order.web;

import cn.itcast.order.pojo.Order;
import cn.itcast.order.pojo.User;
import cn.itcast.order.service.OrderService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;
import org.springframework.web.client.RestTemplate;

@RestController
@RequestMapping("order")
public class OrderController {

   @Autowired
   private OrderService orderService;

    @Autowired
    private RestTemplate restTemplate;

    @GetMapping("{orderId}")
    public Order queryOrderByUserId(@PathVariable("orderId") Long orderId) {
        // æ ¹æ®idæŸ¥è¯¢è®¢å•å¹¶è¿”å›
        Order order = orderService.queryOrderById(orderId);

        //é€šè¿‡urlè°ƒç”¨useræœåŠ¡ï¼Œè·å–userç”¨æˆ·
        String url = "http://localhost:8081/user/" + order.getUserId();
        User user = restTemplate.getForObject(url, User.class);
        order.setUser(user);

        return order;
    }
}
```

<br/>

### æä¾›è€…ä¸æ¶ˆè´¹è€…

åœ¨æœåŠ¡è°ƒç”¨å…³ç³»ä¸­ï¼Œä¼šæœ‰ä¸¤ä¸ªä¸åŒçš„è§’è‰²ï¼š

**æœåŠ¡æä¾›è€…**ï¼šä¸€æ¬¡ä¸šåŠ¡ä¸­ï¼Œè¢«å…¶å®ƒå¾®æœåŠ¡è°ƒç”¨çš„æœåŠ¡ã€‚ï¼ˆæä¾›æ¥å£ç»™å…¶å®ƒå¾®æœåŠ¡ï¼‰

**æœåŠ¡æ¶ˆè´¹è€…**ï¼šä¸€æ¬¡ä¸šåŠ¡ä¸­ï¼Œè°ƒç”¨å…¶å®ƒå¾®æœåŠ¡çš„æœåŠ¡ã€‚ï¼ˆè°ƒç”¨å…¶å®ƒå¾®æœåŠ¡æä¾›çš„æ¥å£ï¼‰

![image-20240227212209046](assets/image-20240227212209046.png)

ä½†æ˜¯ï¼ŒæœåŠ¡æä¾›è€…ä¸æœåŠ¡æ¶ˆè´¹è€…çš„è§’è‰²å¹¶ä¸æ˜¯ç»å¯¹çš„ï¼Œè€Œæ˜¯ç›¸å¯¹äºä¸šåŠ¡è€Œè¨€ã€‚

<br/>

å¦‚æœæœåŠ¡Aè°ƒç”¨äº†æœåŠ¡Bï¼Œè€ŒæœåŠ¡Båˆè°ƒç”¨äº†æœåŠ¡Cï¼ŒæœåŠ¡Bçš„è§’è‰²æ˜¯ä»€ä¹ˆï¼Ÿ

- å¯¹äºAè°ƒç”¨Bçš„ä¸šåŠ¡è€Œè¨€ï¼šAæ˜¯æœåŠ¡æ¶ˆè´¹è€…ï¼ŒBæ˜¯æœåŠ¡æä¾›è€…
- å¯¹äºBè°ƒç”¨Cçš„ä¸šåŠ¡è€Œè¨€ï¼šBæ˜¯æœåŠ¡æ¶ˆè´¹è€…ï¼ŒCæ˜¯æœåŠ¡æä¾›è€…

å› æ­¤ï¼ŒæœåŠ¡Bæ—¢å¯ä»¥æ˜¯æœåŠ¡æä¾›è€…ï¼Œä¹Ÿå¯ä»¥æ˜¯æœåŠ¡æ¶ˆè´¹è€…ã€‚



## æ³¨å†Œä¸­å¿ƒ-Eureka

å‡å¦‚æˆ‘ä»¬çš„æœåŠ¡æä¾›è€…user-serviceéƒ¨ç½²äº†å¤šä¸ªå®ä¾‹ï¼Œå¦‚å›¾ï¼š

![image-20240227212245349](assets/image-20240227212245349.png)

:::warning ğŸ’¡æ€è€ƒ

- `order-service` åœ¨å‘èµ·è¿œç¨‹è°ƒç”¨çš„æ—¶å€™ï¼Œè¯¥å¦‚ä½•å¾—çŸ¥ `user-service` å®ä¾‹çš„ IP åœ°å€å’Œç«¯å£ï¼Ÿ
- æœ‰å¤šä¸ª `user-service` å®ä¾‹åœ°å€ï¼Œ`order-service` è°ƒç”¨æ—¶è¯¥å¦‚ä½•é€‰æ‹©ï¼Ÿ
- `order-service` å¦‚ä½•å¾—çŸ¥æŸä¸ª `user-service` å®ä¾‹æ˜¯å¦ä¾ç„¶å¥åº·ï¼Œæ˜¯ä¸æ˜¯å·²ç»å®•æœºï¼Ÿ

:::

<br/>

### Eurekaçš„ä½œç”¨

è¿™äº›é—®é¢˜éƒ½éœ€è¦åˆ©ç”¨ SpringCloud ä¸­çš„æ³¨å†Œä¸­å¿ƒæ¥è§£å†³ï¼Œå…¶ä¸­æœ€å¹¿ä¸ºäººçŸ¥çš„æ³¨å†Œä¸­å¿ƒå°±æ˜¯ Eurekaï¼Œå…¶ç»“æ„å¦‚ä¸‹ï¼š

![image-20240227212304991](assets/image-20240227212304991.png)

<br/>

é—®é¢˜1ï¼šorder-service å¦‚ä½•å¾—çŸ¥ user-service å®ä¾‹åœ°å€ï¼Ÿ

è·å–åœ°å€ä¿¡æ¯çš„æµç¨‹å¦‚ä¸‹ï¼š

- user-serviceæœåŠ¡å®ä¾‹å¯åŠ¨åï¼Œå°†è‡ªå·±çš„ä¿¡æ¯æ³¨å†Œåˆ° eureka-serverï¼ˆEurekaæœåŠ¡ç«¯ï¼‰ã€‚è¿™ä¸ªå«æœåŠ¡æ³¨å†Œ
- eureka-server ä¿å­˜æœåŠ¡åç§°åˆ°æœåŠ¡å®ä¾‹åœ°å€åˆ—è¡¨çš„æ˜ å°„å…³ç³»
- order-service æ ¹æ®æœåŠ¡åç§°ï¼Œæ‹‰å–å®ä¾‹åœ°å€åˆ—è¡¨ã€‚è¿™ä¸ªå«æœåŠ¡å‘ç°æˆ–æœåŠ¡æ‹‰å–

<br/>

é—®é¢˜2ï¼šorder-service å¦‚ä½•ä»å¤šä¸ª user-service å®ä¾‹ä¸­é€‰æ‹©å…·ä½“çš„å®ä¾‹ï¼Ÿ

- order-service ä»å®ä¾‹åˆ—è¡¨ä¸­åˆ©ç”¨è´Ÿè½½å‡è¡¡ç®—æ³•é€‰ä¸­ä¸€ä¸ªå®ä¾‹åœ°å€
- å‘è¯¥å®ä¾‹åœ°å€å‘èµ·è¿œç¨‹è°ƒç”¨

<br/>

é—®é¢˜3ï¼šorder-service å¦‚ä½•å¾—çŸ¥æŸä¸ª user-service å®ä¾‹æ˜¯å¦ä¾ç„¶å¥åº·ï¼Œæ˜¯ä¸æ˜¯å·²ç»å®•æœºï¼Ÿ

- user-service ä¼šæ¯éš”ä¸€æ®µæ—¶é—´ï¼ˆé»˜è®¤30ç§’ï¼‰å‘ eureka-server å‘èµ·è¯·æ±‚ï¼ŒæŠ¥å‘Šè‡ªå·±çŠ¶æ€ï¼Œç§°ä¸ºå¿ƒè·³
- å½“è¶…è¿‡ä¸€å®šæ—¶é—´æ²¡æœ‰å‘é€å¿ƒè·³æ—¶ï¼Œeureka-server ä¼šè®¤ä¸ºå¾®æœåŠ¡å®ä¾‹æ•…éšœï¼Œå°†è¯¥å®ä¾‹ä»æœåŠ¡åˆ—è¡¨ä¸­å‰”é™¤
- order-service æ‹‰å–æœåŠ¡æ—¶ï¼Œå°±èƒ½å°†æ•…éšœå®ä¾‹æ’é™¤äº†

> æ³¨æ„ï¼šä¸€ä¸ªå¾®æœåŠ¡ï¼Œæ—¢å¯ä»¥æ˜¯æœåŠ¡æä¾›è€…ï¼Œåˆå¯ä»¥æ˜¯æœåŠ¡æ¶ˆè´¹è€…ï¼Œå› æ­¤ eureka å°†æœåŠ¡æ³¨å†Œã€æœåŠ¡å‘ç°ç­‰åŠŸèƒ½ç»Ÿä¸€å°è£…åˆ°äº† eureka-client ç«¯

<br/>

å› æ­¤ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬åŠ¨æ‰‹å®è·µçš„æ­¥éª¤åŒ…æ‹¬ï¼š

![image-20240227212407613](assets/image-20240227212407613.png)

<br/>

### æ­å»ºæœåŠ¡

é¦–å…ˆå¤§å®¶æ³¨å†Œä¸­å¿ƒæœåŠ¡ç«¯ï¼šeureka-serverï¼Œè¿™å¿…é¡»æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„å¾®æœåŠ¡

<br/>

**åˆ›å»ºeureka-serveræœåŠ¡**

![image-20240402110702423](./assets/image-20240402110702423.png)

<br/>

**å¼•å…¥eurekaä¾èµ–**

å¼•å…¥SpringCloudä¸ºeurekaæä¾›çš„starterä¾èµ–ï¼š

```xml
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-netflix-eureka-server</artifactId>
</dependency>
```

<br/>

**ç¼–å†™å¯åŠ¨ç±»**

ç»™ `eureka-server` æœåŠ¡ç¼–å†™ä¸€ä¸ªå¯åŠ¨ç±»ï¼Œä¸€å®šè¦æ·»åŠ ä¸€ä¸ª @EnableEurekaServer æ³¨è§£ï¼Œå¼€å¯ eureka çš„æ³¨å†Œä¸­å¿ƒåŠŸèƒ½ï¼š

```java
package cn.itcast.eureka;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.cloud.netflix.eureka.server.EnableEurekaServer;

@SpringBootApplication
@EnableEurekaServer
public class EurekaApplication {
    public static void main(String[] args) {
        SpringApplication.run(EurekaApplication.class, args);
    }
}
```

<br/>

**ç¼–å†™é…ç½®æ–‡ä»¶**

ç¼–å†™ä¸€ä¸ªapplication.ymlæ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š

```yaml
server:
  port: 10086
spring:
  application:
    name: eureka-server
eureka:
  client:
    service-url: 
      defaultZone: http://127.0.0.1:10086/eureka
```

<br/>

**å¯åŠ¨æœåŠ¡**

å¯åŠ¨å¾®æœåŠ¡ï¼Œç„¶ååœ¨æµè§ˆå™¨è®¿é—®ï¼šhttp://127.0.0.1:10086

çœ‹åˆ°ä¸‹é¢ç»“æœåº”è¯¥æ˜¯æˆåŠŸäº†ï¼š

![image-20210713222157190](assets/image-20210713222157190.png)

<br/>

### æœåŠ¡æ³¨å†Œ

ä¸‹é¢ï¼Œæˆ‘ä»¬å°† `user-service` æ³¨å†Œåˆ° `eureka-server` ä¸­å»ã€‚

**å¼•å…¥ä¾èµ–**

åœ¨ `user-service` çš„ `pom.xml` æ–‡ä»¶ä¸­ï¼Œå¼•å…¥ä¸‹é¢çš„ `eureka-client` ä¾èµ–ï¼š

```xml
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-netflix-eureka-client</artifactId>
</dependency>
```

<br/>

**é…ç½®æ–‡ä»¶**

åœ¨ user-service ä¸­ï¼Œä¿®æ”¹ application.yml æ–‡ä»¶ï¼Œæ·»åŠ æœåŠ¡åç§°ã€eurekaåœ°å€ï¼š

```yamlÂ 
spring:
  application:
    name: userservice
eureka:
  client:
    service-url:
      defaultZone: http://127.0.0.1:10086/eureka
```

<br/>

**å¯åŠ¨å¤šä¸ªuser-serviceå®ä¾‹**

ä¸ºäº†æ¼”ç¤ºä¸€ä¸ªæœåŠ¡æœ‰å¤šä¸ªå®ä¾‹çš„åœºæ™¯ï¼Œæˆ‘ä»¬æ·»åŠ ä¸€ä¸ª SpringBoot çš„å¯åŠ¨é…ç½®ï¼Œå†å¯åŠ¨ä¸€ä¸ª `user-service`ã€‚

é¦–å…ˆï¼Œå¤åˆ¶åŸæ¥çš„ `user-service` å¯åŠ¨é…ç½®ï¼š

<img src="./assets/image-20240402111857783.png" alt="image-20240402111857783" style="zoom:50%;" />

<br/>

ç„¶åï¼Œåœ¨å¼¹å‡ºçš„çª—å£ä¸­ï¼Œå¡«å†™ä¿¡æ¯ï¼š

![image-20240402112003450](./assets/image-20240402112003450.png)

<br/>

ç°åœ¨ï¼ŒSpringBoot çª—å£ä¼šå‡ºç°ä¸¤ä¸ª `user-service` å¯åŠ¨é…ç½®ï¼šä¸è¿‡ï¼Œç¬¬ä¸€ä¸ªæ˜¯ 8081 ç«¯å£ï¼Œç¬¬äºŒä¸ªæ˜¯8082 ç«¯å£

![image-20210713223041491](assets/image-20210713223041491.png)

æŸ¥çœ‹eureka-serverç®¡ç†é¡µé¢ï¼š

![image-20210713223150650](assets/image-20210713223150650.png)

<br/>

### æœåŠ¡å‘ç°

ä¸‹é¢ï¼Œæˆ‘ä»¬å°† `order-service` çš„é€»è¾‘ä¿®æ”¹ï¼šå‘ `eureka-server` æ‹‰å– `user-service` çš„ä¿¡æ¯ï¼Œå®ç°æœåŠ¡å‘ç°ã€‚

<br/>

**å¼•å…¥ä¾èµ–**

ä¹‹å‰è¯´è¿‡ï¼ŒæœåŠ¡å‘ç°ã€æœåŠ¡æ³¨å†Œç»Ÿä¸€éƒ½å°è£…åœ¨ `eureka-client` ä¾èµ–ï¼Œå› æ­¤è¿™ä¸€æ­¥ä¸æœåŠ¡æ³¨å†Œæ—¶ä¸€è‡´ã€‚

åœ¨ `order-service` çš„ pom.xml æ–‡ä»¶ä¸­ï¼Œå¼•å…¥ä¸‹é¢çš„ `eureka-client` ä¾èµ–ï¼š

```xml
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-netflix-eureka-client</artifactId>
</dependency>
```

<br/>

**é…ç½®æ–‡ä»¶**

æœåŠ¡å‘ç°ä¹Ÿéœ€è¦çŸ¥é“ eureka åœ°å€ï¼Œå› æ­¤ç¬¬äºŒæ­¥ä¸æœåŠ¡æ³¨å†Œä¸€è‡´ï¼Œéƒ½æ˜¯é…ç½® eureka ä¿¡æ¯ï¼š

åœ¨ `order-service` ä¸­ï¼Œä¿®æ”¹ application.yml æ–‡ä»¶ï¼Œæ·»åŠ æœåŠ¡åç§°ã€eurekaåœ°å€ï¼š

```yaml
spring:
  application:
    name: orderservice
eureka:
  client:
    service-url:
      defaultZone: http://127.0.0.1:10086/eureka
```

<br/>

**æœåŠ¡æ‹‰å–å’Œè´Ÿè½½å‡è¡¡**

æœ€åï¼Œæˆ‘ä»¬è¦å» `eureka-server` ä¸­æ‹‰å– `user-service` æœåŠ¡çš„å®ä¾‹åˆ—è¡¨ï¼Œå¹¶ä¸”å®ç°è´Ÿè½½å‡è¡¡ã€‚ä¸è¿‡è¿™äº›åŠ¨ä½œä¸ç”¨æˆ‘ä»¬å»åšï¼Œåªéœ€è¦æ·»åŠ ä¸€äº›æ³¨è§£å³å¯ã€‚

åœ¨ `order-service` çš„ OrderApplication ä¸­ï¼Œç»™ RestTemplate è¿™ä¸ª Bean æ·»åŠ ä¸€ä¸ª @LoadBalanced æ³¨è§£ï¼š

```java {10}
@MapperScan("cn.itcast.order.mapper")
@SpringBootApplication
public class OrderApplication {

    public static void main(String[] args) {
        SpringApplication.run(OrderApplication.class, args);
    }

    @Bean
    @LoadBalanced
    public RestTemplate restTemplate(){
        return new RestTemplate();
    }
}
```

<br/>

ä¿®æ”¹ `order-service` æœåŠ¡ä¸­ä¿®æ”¹è®¿é—®çš„ URL è·¯å¾„ï¼Œç”¨æœåŠ¡åä»£æ›¿IPã€ç«¯å£ï¼š

```java
@RestController
@RequestMapping("order")
public class OrderController {

   @Autowired
   private OrderService orderService;

    @Autowired
    private RestTemplate restTemplate;

    @GetMapping("{orderId}")
    public Order queryOrderByUserId(@PathVariable("orderId") Long orderId) {
        // æ ¹æ®idæŸ¥è¯¢è®¢å•å¹¶è¿”å›
        Order order = orderService.queryOrderById(orderId);

        //é€šè¿‡urlè°ƒç”¨useræœåŠ¡ï¼Œè·å–userç”¨æˆ·
        String url = "http://localhost:8081/user/" + order.getUserId();// [!code --]
        String url = "http://userservice/user/" + order.getUserId();// [!code ++]
        User user = restTemplate.getForObject(url, User.class);
        order.setUser(user);

        return order;
    }
}
```

Spring ä¼šè‡ªåŠ¨å¸®åŠ©æˆ‘ä»¬ä» `eureka-server` ç«¯ï¼Œæ ¹æ® `userservice` è¿™ä¸ªæœåŠ¡åç§°ï¼Œè·å–å®ä¾‹åˆ—è¡¨ï¼Œè€Œåå®Œæˆè´Ÿè½½å‡è¡¡ã€‚



## è´Ÿè½½å‡è¡¡-Ribbon

ä¸Šä¸€èŠ‚ä¸­ï¼Œæˆ‘ä»¬æ·»åŠ äº† @LoadBalanced æ³¨è§£ï¼Œå³å¯å®ç°è´Ÿè½½å‡è¡¡åŠŸèƒ½ï¼Œè¿™æ˜¯ä»€ä¹ˆåŸç†å‘¢ï¼Ÿ

<br/>

### åŸç†

SpringCloud åº•å±‚å…¶å®æ˜¯åˆ©ç”¨äº†ä¸€ä¸ªåä¸º Ribbon çš„ç»„ä»¶ï¼Œæ¥å®ç°è´Ÿè½½å‡è¡¡åŠŸèƒ½çš„ã€‚

![image-20210713224517686](assets/image-20210713224517686.png)

é‚£ä¹ˆæˆ‘ä»¬å‘å‡ºçš„è¯·æ±‚æ˜æ˜æ˜¯`http://userservice/user/1`ï¼Œæ€ä¹ˆå˜æˆäº†`http://localhost:8081`çš„å‘¢ï¼Ÿ

<br/>

### æºç è·Ÿè¸ª

ä¸ºä»€ä¹ˆæˆ‘ä»¬åªè¾“å…¥äº† Service åç§°å°±å¯ä»¥è®¿é—®äº†å‘¢ï¼Ÿä¹‹å‰è¿˜è¦è·å– IP å’Œç«¯å£ã€‚

æ˜¾ç„¶æœ‰äººå¸®æˆ‘ä»¬æ ¹æ® Service åç§°ï¼Œè·å–åˆ°äº†æœåŠ¡å®ä¾‹çš„ IP å’Œç«¯å£ã€‚å®ƒå°±æ˜¯`LoadBalancerInterceptor`ï¼Œè¿™ä¸ªç±»ä¼šåœ¨å¯¹ RestTemplate çš„è¯·æ±‚è¿›è¡Œæ‹¦æˆªï¼Œç„¶åä» Eureka æ ¹æ®æœåŠ¡idè·å–æœåŠ¡åˆ—è¡¨ï¼Œéšååˆ©ç”¨è´Ÿè½½å‡è¡¡ç®—æ³•å¾—åˆ°çœŸå®çš„æœåŠ¡åœ°å€ä¿¡æ¯ï¼Œæ›¿æ¢æœåŠ¡IDã€‚

<br/>

æˆ‘ä»¬è¿›è¡Œæºç è·Ÿè¸ªï¼š

#### LoadBalancerIntercepor

![1525620483637](assets/1525620483637.png)

å¯ä»¥çœ‹åˆ°è¿™é‡Œçš„interceptæ–¹æ³•ï¼Œæ‹¦æˆªäº†ç”¨æˆ·çš„ HttpRequest è¯·æ±‚ï¼Œç„¶ååšäº†å‡ ä»¶äº‹ï¼š

- `request.getURI()`ï¼šè·å–è¯·æ±‚uriï¼Œæœ¬ä¾‹ä¸­å°±æ˜¯ http://user-service/user/8
- `originalUri.getHost()`ï¼šè·å–uriè·¯å¾„çš„ä¸»æœºåï¼Œå…¶å®å°±æ˜¯æœåŠ¡idï¼Œ`user-service`
- `this.loadBalancer.execute()`ï¼šå¤„ç†æœåŠ¡idï¼Œå’Œç”¨æˆ·è¯·æ±‚ã€‚

è¿™é‡Œçš„ `this.loadBalancer` æ˜¯ `LoadBalancerClient` ç±»å‹ï¼Œæˆ‘ä»¬ç»§ç»­è·Ÿå…¥ã€‚

<br/>

#### LoadBalancerClient

ç»§ç»­è·Ÿå…¥executeæ–¹æ³•ï¼š

![1525620787090](assets/1525620787090.png)

ä»£ç æ˜¯è¿™æ ·çš„ï¼š

- getLoadBalancer(serviceId)ï¼šæ ¹æ®æœåŠ¡ id è·å– ILoadBalancerï¼Œè€Œ ILoadBalancer ä¼šæ‹¿ç€æœåŠ¡ id å»eurekaä¸­è·å–æœåŠ¡åˆ—è¡¨å¹¶ä¿å­˜èµ·æ¥ã€‚
- getServer(loadBalancer)ï¼šåˆ©ç”¨å†…ç½®çš„è´Ÿè½½å‡è¡¡ç®—æ³•ï¼Œä»æœåŠ¡åˆ—è¡¨ä¸­é€‰æ‹©ä¸€ä¸ªã€‚æœ¬ä¾‹ä¸­ï¼Œå¯ä»¥çœ‹åˆ°è·å–äº† 8082 ç«¯å£çš„æœåŠ¡

<br/>

æ”¾è¡Œåï¼Œå†æ¬¡è®¿é—®å¹¶è·Ÿè¸ªï¼Œå‘ç°è·å–çš„æ˜¯8081ï¼š

![1525620835911](assets/1525620835911.png)

æœç„¶å®ç°äº†è´Ÿè½½å‡è¡¡ã€‚

<br/>

#### è´Ÿè½½å‡è¡¡ç­–ç•¥IRule

åœ¨åˆšæ‰çš„ä»£ç ä¸­ï¼Œå¯ä»¥çœ‹åˆ°è·å–æœåŠ¡ä½¿é€šè¿‡ä¸€ä¸ª`getServer`æ–¹æ³•æ¥åšè´Ÿè½½å‡è¡¡:

![1525620835911](assets/1525620835911.png)

<br/>

æˆ‘ä»¬ç»§ç»­è·Ÿå…¥ï¼š

![1544361421671](assets/1544361421671.png)

<br/>

ç»§ç»­è·Ÿè¸ªæºç chooseServeræ–¹æ³•ï¼Œå‘ç°è¿™ä¹ˆä¸€æ®µä»£ç ï¼š

![1525622652849](assets/1525622652849.png)

<br/>

æˆ‘ä»¬çœ‹çœ‹è¿™ä¸ªruleæ˜¯è°ï¼š

![1525622699666](assets/1525622699666.png)

<br/>

è¿™é‡Œçš„ruleé»˜è®¤å€¼æ˜¯ä¸€ä¸ª`RoundRobinRule`ï¼Œçœ‹ç±»çš„ä»‹ç»ï¼š

![1525622754316](assets/1525622754316.png)

è¿™ä¸å°±æ˜¯è½®è¯¢çš„æ„æ€å˜›ã€‚åˆ°è¿™é‡Œï¼Œæ•´ä¸ªè´Ÿè½½å‡è¡¡çš„æµç¨‹æˆ‘ä»¬å°±æ¸…æ¥šäº†ã€‚

<br/>

#### æ€»ç»“

SpringCloudRibbon çš„åº•å±‚é‡‡ç”¨äº†ä¸€ä¸ªæ‹¦æˆªå™¨ï¼Œæ‹¦æˆªäº† RestTemplate å‘å‡ºçš„è¯·æ±‚ï¼Œå¯¹åœ°å€åšäº†ä¿®æ”¹ã€‚ç”¨ä¸€å¹…å›¾æ¥æ€»ç»“ä¸€ä¸‹ï¼š

![image-20210713224724673](assets/image-20210713224724673.png)

<br/>

:::tip ğŸ”– åŸºæœ¬æµç¨‹å¦‚ä¸‹ï¼š

- æ‹¦æˆªæˆ‘ä»¬çš„ RestTemplate è¯·æ±‚ http://userservice/user/1
- RibbonLoadBalancerClient ä¼šä»è¯·æ±‚ URL ä¸­è·å–æœåŠ¡åç§°ï¼Œä¹Ÿå°±æ˜¯ `user-service`
- DynamicServerListLoadBalancer æ ¹æ® `user-service` åˆ° `eureka` æ‹‰å–æœåŠ¡åˆ—è¡¨
- eureka è¿”å›åˆ—è¡¨ï¼Œlocalhost:8081ã€localhost:8082
- IRule åˆ©ç”¨å†…ç½®è´Ÿè½½å‡è¡¡è§„åˆ™ï¼Œä»åˆ—è¡¨ä¸­é€‰æ‹©ä¸€ä¸ªï¼Œä¾‹å¦‚ localhost:8081
- RibbonLoadBalancerClient ä¿®æ”¹è¯·æ±‚åœ°å€ï¼Œç”¨ localhost:8081 æ›¿ä»£ userserviceï¼Œå‘èµ·çœŸå®è¯·æ±‚ [localhost:8081/user/1](http://localhost:8081/user/1) 

:::

<br/>

### è´Ÿè½½å‡è¡¡ç­–ç•¥

è´Ÿè½½å‡è¡¡çš„è§„åˆ™éƒ½å®šä¹‰åœ¨IRuleæ¥å£ä¸­ï¼Œè€ŒIRuleæœ‰å¾ˆå¤šä¸åŒçš„å®ç°ç±»ï¼š

![image-20240402113640004](./assets/image-20240402113640004.png)

ä¸åŒè§„åˆ™çš„å«ä¹‰å¦‚ä¸‹ï¼š

![image-20240402113714924](./assets/image-20240402113714924.png)

é»˜è®¤çš„å®ç°å°±æ˜¯ ZoneAvoidanceRuleï¼Œæ˜¯ä¸€ç§è½®è¯¢æ–¹æ¡ˆ

<br/>

**è‡ªå®šä¹‰è´Ÿè½½å‡è¡¡ç­–ç•¥**

é€šè¿‡å®šä¹‰IRuleå®ç°å¯ä»¥ä¿®æ”¹è´Ÿè½½å‡è¡¡è§„åˆ™ï¼Œæœ‰ä¸¤ç§æ–¹å¼ï¼š

1. ä»£ç æ–¹å¼ï¼š`order-service` ä¸­çš„ OrderApplication ç±»ä¸­ï¼Œå®šä¹‰ä¸€ä¸ªæ–°çš„ IRuleï¼š

```java
@Bean
public IRule randomRule(){
    return new RandomRule();
}
```

<br/>

2. é…ç½®æ–‡ä»¶æ–¹å¼ï¼šåœ¨ `order-service`çš„ application.yml æ–‡ä»¶ä¸­ï¼Œæ·»åŠ æ–°çš„é…ç½®ä¹Ÿå¯ä»¥ä¿®æ”¹è§„åˆ™ï¼š

```yaml
# ç»™æŸä¸ªå¾®æœåŠ¡é…ç½®è´Ÿè½½å‡è¡¡è§„åˆ™ï¼Œè¿™é‡Œæ˜¯userserviceæœåŠ¡
userservice: 
  ribbon:
  	# è´Ÿè½½å‡è¡¡è§„åˆ™ 
    NFLoadBalancerRuleClassName: com.netflix.loadbalancer.RandomRule 
```

> **æ³¨æ„**ï¼Œä¸€èˆ¬ç”¨é»˜è®¤çš„è´Ÿè½½å‡è¡¡è§„åˆ™ï¼Œä¸åšä¿®æ”¹ã€‚

<br/>

### é¥¥é¥¿åŠ è½½

Ribbon é»˜è®¤æ˜¯é‡‡ç”¨æ‡’åŠ è½½ï¼Œå³ç¬¬ä¸€æ¬¡è®¿é—®æ—¶æ‰ä¼šå»åˆ›å»º LoadBalanceClientï¼Œè¯·æ±‚æ—¶é—´ä¼šå¾ˆé•¿ã€‚

è€Œé¥¥é¥¿åŠ è½½åˆ™ä¼šåœ¨é¡¹ç›®å¯åŠ¨æ—¶åˆ›å»ºï¼Œé™ä½ç¬¬ä¸€æ¬¡è®¿é—®çš„è€—æ—¶ï¼Œé€šè¿‡ä¸‹é¢é…ç½®å¼€å¯é¥¥é¥¿åŠ è½½ï¼š

```yaml
ribbon:
  eager-load:
    enabled: true
    clients: userservice
```



## æ³¨å†Œä¸­å¿ƒ-Nacos

[Nacos](https://nacos.io/) æ˜¯é˜¿é‡Œå·´å·´çš„äº§å“ï¼Œç°åœ¨æ˜¯ [SpringCloud ](https://spring.io/projects/spring-cloud)ä¸­çš„ä¸€ä¸ªç»„ä»¶ã€‚ç›¸æ¯” [Eureka](https://github.com/Netflix/eureka) åŠŸèƒ½æ›´åŠ ä¸°å¯Œï¼Œåœ¨å›½å†…å—æ¬¢è¿ç¨‹åº¦è¾ƒé«˜ã€‚

![image-20210713230444308](assets/image-20210713230444308.png)

å®‰è£…æ–¹å¼å¯ä»¥å‚è€ƒ [å®‰è£…Nacos](00æ“ä½œç¯‡-å®‰è£…Nacos.md)

<br/>

### æœåŠ¡æ³¨å†Œåˆ°Nacos

Nacos æ˜¯ SpringCloudAlibaba çš„ç»„ä»¶ï¼Œè€Œ SpringCloudAlibaba ä¹Ÿéµå¾ª SpringCloud ä¸­å®šä¹‰çš„æœåŠ¡æ³¨å†Œã€æœåŠ¡å‘ç°è§„èŒƒã€‚å› æ­¤ä½¿ç”¨ Nacos å’Œä½¿ç”¨ Eureka å¯¹äºå¾®æœåŠ¡æ¥è¯´ï¼Œå¹¶æ²¡æœ‰å¤ªå¤§åŒºåˆ«ã€‚

ä¸»è¦å·®å¼‚åœ¨äºï¼š

- ä¾èµ–ä¸åŒ
- æœåŠ¡åœ°å€ä¸åŒ

<br/>

**å¼•å…¥ä¾èµ–**

åœ¨ cloud-demo çˆ¶å·¥ç¨‹çš„ pom.xml æ–‡ä»¶ä¸­çš„`<dependencyManagement>` ä¸­å¼•å…¥ SpringCloudAlibaba çš„ä¾èµ–ï¼š 

```xml
<dependency>
    <groupId>com.alibaba.cloud</groupId>
    <artifactId>spring-cloud-alibaba-dependencies</artifactId>
    <version>2.2.6.RELEASE</version>
    <type>pom</type>
    <scope>import</scope>
</dependency>
```

ç„¶ååœ¨ `user-service` å’Œ `order-service` ä¸­çš„ pom.xml æ–‡ä»¶ä¸­å¼•å…¥ `nacos-discovery` ä¾èµ–ï¼š

```xml
<dependency>
    <groupId>com.alibaba.cloud</groupId>
    <artifactId>spring-cloud-starter-alibaba-nacos-discovery</artifactId>
</dependency>
```

> **æ³¨æ„**ï¼šä¸è¦å¿˜äº†æ³¨é‡Šæ‰ eureka çš„ä¾èµ–ã€‚

<br/>

**é…ç½®nacosåœ°å€**

åœ¨ `user-service` å’Œ `order-service` çš„ application.yml ä¸­æ·»åŠ  Nacos åœ°å€ï¼š

```yaml
spring:
  cloud:
    nacos:
      server-addr: localhost:8848
```

> **æ³¨æ„**ï¼šä¸è¦å¿˜äº†æ³¨é‡Šæ‰ eureka çš„åœ°å€

<br/>

**é‡å¯**

é‡å¯å¾®æœåŠ¡åï¼Œç™»å½• Nacos ç®¡ç†é¡µé¢ï¼Œå¯ä»¥çœ‹åˆ°å¾®æœåŠ¡ä¿¡æ¯ï¼š

![image-20240402140823820](./assets/image-20240402140823820.png)



### æœåŠ¡åˆ†çº§å­˜å‚¨æ¨¡å‹

ä¸€ä¸ª**æœåŠ¡**å¯ä»¥æœ‰å¤šä¸ª**å®ä¾‹**ï¼Œä¾‹å¦‚æˆ‘ä»¬çš„ `user-service`ï¼Œå¯ä»¥æœ‰:

- 127.0.0.1:8081
- 127.0.0.1:8082
- 127.0.0.1:8083

<br/>

å‡å¦‚è¿™äº›å®ä¾‹åˆ†å¸ƒäºå…¨å›½å„åœ°çš„ä¸åŒæœºæˆ¿ï¼Œä¾‹å¦‚ï¼š

- 127.0.0.1:8081ï¼Œåœ¨ä¸Šæµ·æœºæˆ¿
- 127.0.0.1:8082ï¼Œåœ¨ä¸Šæµ·æœºæˆ¿
- 127.0.0.1:8083ï¼Œåœ¨æ­å·æœºæˆ¿

Nacoså°±å°†åŒä¸€æœºæˆ¿å†…çš„å®ä¾‹ åˆ’åˆ†ä¸ºä¸€ä¸ª**é›†ç¾¤**ã€‚

<br/>

ä¹Ÿå°±æ˜¯è¯´ï¼Œ`user-service` æ˜¯æœåŠ¡ï¼Œä¸€ä¸ªæœåŠ¡å¯ä»¥åŒ…å«å¤šä¸ªé›†ç¾¤ï¼Œå¦‚æ­å·ã€ä¸Šæµ·ï¼Œæ¯ä¸ªé›†ç¾¤ä¸‹å¯ä»¥æœ‰å¤šä¸ªå®ä¾‹ï¼Œå½¢æˆåˆ†çº§æ¨¡å‹ï¼Œå¦‚å›¾ï¼š

![image-20210713232522531](assets/image-20210713232522531.png)



<br/>

å¾®æœåŠ¡äº’ç›¸è®¿é—®æ—¶ï¼Œåº”è¯¥å°½å¯èƒ½è®¿é—®åŒé›†ç¾¤å®ä¾‹ï¼Œå› ä¸ºæœ¬åœ°è®¿é—®é€Ÿåº¦æ›´å¿«ã€‚å½“æœ¬é›†ç¾¤å†…ä¸å¯ç”¨æ—¶ï¼Œæ‰è®¿é—®å…¶å®ƒé›†ç¾¤ã€‚ä¾‹å¦‚ï¼š

![image-20210713232658928](assets/image-20210713232658928.png)

æ­å·æœºæˆ¿å†…çš„ `order-service` åº”è¯¥ä¼˜å…ˆè®¿é—®åŒæœºæˆ¿çš„ `user-service`ã€‚

<br/>

ä¿®æ”¹ `user-service` çš„ application.yml æ–‡ä»¶ï¼Œæ·»åŠ é›†ç¾¤é…ç½®ï¼š

```yaml
spring:
  cloud:
    nacos:
      server-addr: localhost:8848
      discovery:
        cluster-name: HZ # é›†ç¾¤åç§°
```

<br/>

é‡å¯ä¸¤ä¸ª `user-service` å®ä¾‹åï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ `Nacos` æ§åˆ¶å°çœ‹åˆ°ä¸‹é¢ç»“æœï¼š

![image-20240402141232715](./assets/image-20240402141232715.png)

<br/>

æˆ‘ä»¬å†æ¬¡å¤åˆ¶ä¸€ä¸ª `user-service` å¯åŠ¨é…ç½®ï¼Œæ·»åŠ å±æ€§ï¼š

```sh
-Dserver.port=8083 -Dspring.cloud.nacos.discovery.cluster-name=SH
```

å¯åŠ¨ UserApplication3 åå†æ¬¡æŸ¥çœ‹ Nacos æ§åˆ¶å°ï¼š

![image-20240402141305282](./assets/image-20240402141305282.png)

<br/>

**åŒé›†ç¾¤ä¼˜å…ˆçš„è´Ÿè½½å‡è¡¡**

é»˜è®¤çš„ `ZoneAvoidanceRule` å¹¶ä¸èƒ½å®ç°æ ¹æ®åŒé›†ç¾¤ä¼˜å…ˆæ¥å®ç°è´Ÿè½½å‡è¡¡ã€‚

å› æ­¤Nacosä¸­æä¾›äº†ä¸€ä¸ª `NacosRule` çš„å®ç°ï¼Œå¯ä»¥ä¼˜å…ˆä»åŒé›†ç¾¤ä¸­æŒ‘é€‰å®ä¾‹ã€‚

<br/>

ä¿®æ”¹ `order-service` çš„ application.yml æ–‡ä»¶ï¼Œæ·»åŠ é›†ç¾¤é…ç½®ï¼š

```sh
spring:
  cloud:
    nacos:
      server-addr: localhost:8848
      discovery:
      	# é›†ç¾¤åç§°
        cluster-name: HZ
```

<br/>

ä¿®æ”¹ `order-service` çš„ application.yml æ–‡ä»¶ï¼Œä¿®æ”¹è´Ÿè½½å‡è¡¡è§„åˆ™ï¼š

```yaml
userservice:
  ribbon:
    NFLoadBalancerRuleClassName: com.alibaba.cloud.nacos.ribbon.NacosRule # è´Ÿè½½å‡è¡¡è§„åˆ™ 
```

<br/>

### æƒé‡é…ç½®

å®é™…éƒ¨ç½²ä¸­ä¼šå‡ºç°è¿™æ ·çš„åœºæ™¯ï¼š

æœåŠ¡å™¨è®¾å¤‡æ€§èƒ½æœ‰å·®å¼‚ï¼Œéƒ¨åˆ†å®ä¾‹æ‰€åœ¨æœºå™¨æ€§èƒ½è¾ƒå¥½ï¼Œå¦ä¸€äº›è¾ƒå·®ï¼Œæˆ‘ä»¬å¸Œæœ›æ€§èƒ½å¥½çš„æœºå™¨æ‰¿æ‹…æ›´å¤šçš„ç”¨æˆ·è¯·æ±‚ã€‚ä½†é»˜è®¤æƒ…å†µä¸‹NacosRuleæ˜¯åŒé›†ç¾¤å†…éšæœºæŒ‘é€‰ï¼Œä¸ä¼šè€ƒè™‘æœºå™¨çš„æ€§èƒ½é—®é¢˜ã€‚å› æ­¤ï¼ŒNacos æä¾›äº†æƒé‡é…ç½®æ¥æ§åˆ¶è®¿é—®é¢‘ç‡ï¼Œæƒé‡è¶Šå¤§åˆ™è®¿é—®é¢‘ç‡è¶Šé«˜ã€‚åœ¨ Nacos æ§åˆ¶å°ï¼Œæ‰¾åˆ° `user-service` çš„å®ä¾‹åˆ—è¡¨ï¼Œç‚¹å‡»ç¼–è¾‘ï¼Œå³å¯ä¿®æ”¹æƒé‡ï¼š

![image-20240402145641666](./assets/image-20240402145641666.png)

åœ¨å¼¹å‡ºçš„ç¼–è¾‘çª—å£ï¼Œä¿®æ”¹æƒé‡ï¼š

<img src="./assets/image-20240402150340372.png" alt="image-20240402150340372" style="zoom:50%;" />

> **æ³¨æ„**ï¼šå¦‚æœæƒé‡ä¿®æ”¹ä¸º0ï¼Œåˆ™è¯¥å®ä¾‹æ°¸è¿œä¸ä¼šè¢«è®¿é—®

<br/>

### ç¯å¢ƒéš”ç¦»

Nacosæä¾›äº† namespace æ¥å®ç°ç¯å¢ƒéš”ç¦»åŠŸèƒ½ã€‚

- Nacos ä¸­å¯ä»¥æœ‰å¤šä¸ª namespace
- namespaceä¸‹å¯ä»¥æœ‰ groupã€service ç­‰
- ä¸åŒnamespaceä¹‹é—´ç›¸äº’éš”ç¦»ï¼Œä¾‹å¦‚ä¸åŒ namespace çš„æœåŠ¡äº’ç›¸ä¸å¯è§

![image-20210714000101516](assets/image-20210714000101516.png)



**åˆ›å»ºnamespace**

é»˜è®¤æƒ…å†µä¸‹ï¼Œæ‰€æœ‰serviceã€dataã€groupéƒ½åœ¨åŒä¸€ä¸ªnamespaceï¼Œåä¸ºpublicï¼š

![image-20240402145835711](./assets/image-20240402145835711.png)

æˆ‘ä»¬å¯ä»¥ç‚¹å‡»é¡µé¢æ–°å¢æŒ‰é’®ï¼Œæ·»åŠ ä¸€ä¸ªnamespaceï¼Œç„¶åå¡«å†™è¡¨å•ï¼š

![image-20240402150101762](./assets/image-20240402150101762.png)

å°±èƒ½åœ¨é¡µé¢çœ‹åˆ°ä¸€ä¸ªæ–°çš„ namespaceï¼š

![image-20240402150138998](./assets/image-20240402150138998.png)

<br/>

**ç»™å¾®æœåŠ¡é…ç½® namespace**

ç»™å¾®æœåŠ¡é…ç½®namespaceåªèƒ½é€šè¿‡ä¿®æ”¹é…ç½®æ¥å®ç°ã€‚

ä¾‹å¦‚ï¼Œä¿®æ”¹ `order-service` çš„application.ymlæ–‡ä»¶ï¼š

```yaml {7}
spring:
  cloud:
    nacos:
      server-addr: localhost:8848
      discovery:
        cluster-name: HZ
        namespace: 856c34c2-21a7-4b1a-9670-6b46a6c9dd0d # å‘½åç©ºé—´ï¼Œå¡«ID
```

<br/>

é‡å¯ `order-service` åï¼Œè®¿é—®æ§åˆ¶å°ï¼Œå¯ä»¥çœ‹åˆ°ä¸‹é¢çš„ç»“æœï¼š

**publicå‘½åç©ºé—´**

![image-20240402151422855](./assets/image-20240402151422855.png)

**devå‘½åç©ºé—´**

![image-20240402151435094](./assets/image-20240402151435094.png)

æ­¤æ—¶è®¿é—® [localhost:8080/order/101](http://localhost:8080/order/101)ï¼Œå› ä¸º namespace ä¸åŒï¼Œä¼šå¯¼è‡´æ‰¾ä¸åˆ° userserviceï¼Œæ§åˆ¶å°ä¼šæŠ¥é”™ï¼š

![image-20240402151806654](./assets/image-20240402151806654.png)

<br/>

### Nacosä¸Eurekaçš„åŒºåˆ«

Nacosçš„æœåŠ¡å®ä¾‹åˆ†ä¸ºä¸¤ç§lç±»å‹ï¼š

- ä¸´æ—¶å®ä¾‹ï¼šå¦‚æœå®ä¾‹å®•æœºè¶…è¿‡ä¸€å®šæ—¶é—´ï¼Œä¼šä»æœåŠ¡åˆ—è¡¨å‰”é™¤ï¼Œé»˜è®¤çš„ç±»å‹ã€‚
- éä¸´æ—¶å®ä¾‹ï¼šå¦‚æœå®ä¾‹å®•æœºï¼Œä¸ä¼šä»æœåŠ¡åˆ—è¡¨å‰”é™¤ï¼Œä¹Ÿå¯ä»¥å«æ°¸ä¹…å®ä¾‹ã€‚

<br/>

é…ç½®ä¸€ä¸ªæœåŠ¡å®ä¾‹ä¸ºæ°¸ä¹…å®ä¾‹ï¼š

```yaml
spring:
  cloud:
    nacos:
      discovery:
        ephemeral: false # è®¾ç½®ä¸ºéä¸´æ—¶å®ä¾‹
```

Nacos å’Œ Eureka æ•´ä½“ç»“æ„ç±»ä¼¼ï¼ŒæœåŠ¡æ³¨å†Œã€æœåŠ¡æ‹‰å–ã€å¿ƒè·³ç­‰å¾…ï¼Œä½†æ˜¯ä¹Ÿå­˜åœ¨ä¸€äº›å·®å¼‚ï¼š

![image-20210714001728017](assets/image-20210714001728017.png)

<br/>

- Nacos ä¸ Eureka çš„å…±åŒç‚¹
  - éƒ½æ”¯æŒæœåŠ¡æ³¨å†Œå’ŒæœåŠ¡æ‹‰å–
  - éƒ½æ”¯æŒæœåŠ¡æä¾›è€…å¿ƒè·³æ–¹å¼åšå¥åº·æ£€æµ‹
- Nacos ä¸ Eureka çš„åŒºåˆ«
  - Nacos æ”¯æŒæœåŠ¡ç«¯ä¸»åŠ¨æ£€æµ‹æä¾›è€…çŠ¶æ€ï¼šä¸´æ—¶å®ä¾‹é‡‡ç”¨å¿ƒè·³æ¨¡å¼ï¼Œéä¸´æ—¶å®ä¾‹é‡‡ç”¨ä¸»åŠ¨æ£€æµ‹æ¨¡å¼
  - ä¸´æ—¶å®ä¾‹å¿ƒè·³ä¸æ­£å¸¸ä¼šè¢«å‰”é™¤ï¼Œéä¸´æ—¶å®ä¾‹åˆ™ä¸ä¼šè¢«å‰”é™¤
  - Nacos æ”¯æŒæœåŠ¡åˆ—è¡¨å˜æ›´çš„æ¶ˆæ¯æ¨é€æ¨¡å¼ï¼ŒæœåŠ¡åˆ—è¡¨æ›´æ–°æ›´åŠæ—¶
  - Nacos é›†ç¾¤é»˜è®¤é‡‡ç”¨APæ–¹å¼ï¼Œå½“é›†ç¾¤ä¸­å­˜åœ¨éä¸´æ—¶å®ä¾‹æ—¶ï¼Œé‡‡ç”¨ CP æ¨¡å¼ï¼›Eureka é‡‡ç”¨ AP æ–¹å¼



## é…ç½®ç®¡ç†-Nacos

Nacos é™¤äº†å¯ä»¥åšæ³¨å†Œä¸­å¿ƒï¼ŒåŒæ ·å¯ä»¥åšé…ç½®ç®¡ç†æ¥ä½¿ç”¨ã€‚



### é…ç½®ç®¡ç†

å½“å¾®æœåŠ¡éƒ¨ç½²çš„å®ä¾‹è¶Šæ¥è¶Šå¤šï¼Œè¾¾åˆ°æ•°åã€æ•°ç™¾æ—¶ï¼Œé€ä¸ªä¿®æ”¹å¾®æœåŠ¡é…ç½®å°±ä¼šè®©äººæŠ“ç‹‚ï¼Œè€Œä¸”å¾ˆå®¹æ˜“å‡ºé”™ã€‚æˆ‘ä»¬éœ€è¦ä¸€ç§ç»Ÿä¸€é…ç½®ç®¡ç†æ–¹æ¡ˆï¼Œå¯ä»¥é›†ä¸­ç®¡ç†æ‰€æœ‰å®ä¾‹çš„é…ç½®ã€‚

![image-20210714164426792](assets/image-20210714164426792.png)



Nacos ä¸€æ–¹é¢å¯ä»¥å°†é…ç½®é›†ä¸­ç®¡ç†ï¼Œå¦ä¸€æ–¹å¯ä»¥åœ¨é…ç½®å˜æ›´æ—¶ï¼ŒåŠæ—¶é€šçŸ¥å¾®æœåŠ¡ï¼Œå®ç°é…ç½®çš„çƒ­æ›´æ–°ã€‚

<br/>

**åœ¨ Nacos ä¸­æ·»åŠ é…ç½®æ–‡ä»¶**

![image-20240402153108707](./assets/image-20240402153108707.png)

<br/>

ç„¶ååœ¨å¼¹å‡ºçš„è¡¨å•ä¸­ï¼Œå¡«å†™é…ç½®ä¿¡æ¯ï¼š

```yaml
pattern:
  dateformat: yyyy-MM-dd HH:mm:ss
```

![image-20240402153901004](./assets/image-20240402153901004.png)

> æ³¨æ„ï¼šé¡¹ç›®çš„æ ¸å¿ƒé…ç½®ï¼Œéœ€è¦çƒ­æ›´æ–°çš„é…ç½®æ‰æœ‰æ”¾åˆ° Nacos ç®¡ç†çš„å¿…è¦ã€‚åŸºæœ¬ä¸ä¼šå˜æ›´çš„ä¸€äº›é…ç½®è¿˜æ˜¯ä¿å­˜åœ¨å¾®æœåŠ¡æœ¬åœ°æ¯”è¾ƒå¥½ã€‚

<br/>

**ä»å¾®æœåŠ¡æ‹‰å–é…ç½®**

å¾®æœåŠ¡è¦æ‹‰å– Nacos ä¸­ç®¡ç†çš„é…ç½®ï¼Œå¹¶ä¸”ä¸æœ¬åœ°çš„ application.yml é…ç½®åˆå¹¶ï¼Œæ‰èƒ½å®Œæˆé¡¹ç›®å¯åŠ¨ã€‚ä½†å¦‚æœå°šæœªè¯»å– application.ymlï¼Œåˆå¦‚ä½•å¾—çŸ¥ Nacos åœ°å€å‘¢ï¼Ÿ

å› æ­¤ Spring å¼•å…¥äº†ä¸€ç§æ–°çš„é…ç½®æ–‡ä»¶ï¼šbootstrap.yaml æ–‡ä»¶ï¼Œä¼šåœ¨ application.yml ä¹‹å‰è¢«è¯»å–ï¼Œæµç¨‹å¦‚ä¸‹ï¼š

![img](assets/L0iFYNF.png)

<br/>

**å¼•å…¥nacos-configä¾èµ–**

é¦–å…ˆï¼Œåœ¨ `user-service` æœåŠ¡ä¸­ï¼Œå¼•å…¥ `nacos-config` çš„å®¢æˆ·ç«¯ä¾èµ–ï¼š

```xml
<!--nacosé…ç½®ç®¡ç†ä¾èµ–-->
<dependency>
    <groupId>com.alibaba.cloud</groupId>
    <artifactId>spring-cloud-starter-alibaba-nacos-config</artifactId>
</dependency>
```

<br/>

**æ·»åŠ  bootstrap.yaml**

ç„¶åï¼Œåœ¨ `user-service` ä¸­æ·»åŠ ä¸€ä¸ª bootstrap.yaml æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š

```yamlÂ 
spring:
  application:
    name: userservice
  profiles:
    active: dev #å¼€å‘ç¯å¢ƒï¼Œè¿™é‡Œæ˜¯dev
  cloud:
    nacos:
      server-addr: localhost:8848
      config:
        file-extension: yaml # æ–‡ä»¶åç¼€å
```

è¿™é‡Œä¼šæ ¹æ®spring.cloud.nacos.server-addrè·å–nacosåœ°å€ï¼Œå†æ ¹æ® 

`${spring.application.name}-${spring.profiles.active}.${spring.cloud.nacos.config.file-extension} `ä½œä¸ºæ–‡ä»¶idï¼Œæ¥è¯»å–é…ç½®ã€‚

æœ¬ä¾‹ä¸­ï¼Œå°±æ˜¯å»è¯»å– `userservice-dev.yaml`ï¼š

![image-20210714170845901](assets/image-20210714170845901.png)

<br/>

**è¯»å–Nacosé…ç½®**

åœ¨ `user-service` ä¸­çš„ UserController ä¸­æ·»åŠ ä¸šåŠ¡é€»è¾‘ï¼Œè¯»å– pattern.dateformat é…ç½®ï¼š

```java
package cn.itcast.user.web;

import cn.itcast.user.pojo.User;
import cn.itcast.user.service.UserService;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.web.bind.annotation.*;

import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;

@Slf4j
@RestController
@RequestMapping("/user")
public class UserController {

    @Value("${pattern.dateformat}")
    private String dateformat;
    
    @GetMapping("now")
    public String now(){
        return LocalDateTime.now().format(DateTimeFormatter.ofPattern(dateformat));
    }
}
```

åœ¨é¡µé¢è®¿é—®ï¼Œå¯ä»¥çœ‹åˆ°æ•ˆæœï¼šhttp://localhost:8081/user/now

<br/>

### é…ç½®çƒ­æ›´æ–°

æˆ‘ä»¬æœ€ç»ˆçš„ç›®çš„ï¼Œæ˜¯ä¿®æ”¹ Nacos ä¸­çš„é…ç½®åï¼Œå¾®æœåŠ¡ä¸­æ— éœ€é‡å¯å³å¯è®©é…ç½®ç”Ÿæ•ˆï¼Œä¹Ÿå°±æ˜¯**é…ç½®çƒ­æ›´æ–°**ã€‚

è¦å®ç°é…ç½®çƒ­æ›´æ–°ï¼Œå¯ä»¥ä½¿ç”¨ä¸¤ç§æ–¹å¼ï¼š

<br/>

**æ–¹å¼ä¸€**

åœ¨ @Value æ³¨å…¥çš„å˜é‡æ‰€åœ¨ç±»ä¸Šæ·»åŠ æ³¨è§£ @RefreshScopeï¼š

```java
@Slf4j
@RestController
@RefreshScope
@RequestMapping("/user")
public class UserController {

    @Value("${pattern.dateformat}")
    private String dateformat;
    
    @GetMapping("now")
    public String now(){
        return LocalDateTime.now().format(DateTimeFormatter.ofPattern(dateformat));
    }
}
```

<br/>

**æ–¹å¼äºŒ**

ä½¿ç”¨ @ConfigurationProperties æ³¨è§£ä»£æ›¿ @Value æ³¨è§£ã€‚

åœ¨ `user-service` æœåŠ¡ä¸­ï¼Œæ·»åŠ ä¸€ä¸ªç±»ï¼Œè¯»å– patterrn.dateformat å±æ€§ï¼š

```java
package cn.itcast.user.config;

import lombok.Data;
import org.springframework.boot.context.properties.ConfigurationProperties;
import org.springframework.stereotype.Component;

@Component
@Data
@ConfigurationProperties(prefix = "pattern")
public class PatternProperties {
    private String dateformat;
}
```

<br/>

åœ¨ UserController ä¸­ä½¿ç”¨è¿™ä¸ªç±»ä»£æ›¿ @Valueï¼š

```java
package cn.itcast.user.web;

import cn.itcast.user.config.PatternProperties;
import cn.itcast.user.pojo.User;
import cn.itcast.user.service.UserService;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;

@Slf4j
@RestController
@RequestMapping("/user")
public class UserController {

    @Autowired
    private PatternProperties patternProperties;

    @GetMapping("now")
    public String now(){
        return LocalDateTime.now()
                .format(DateTimeFormatter
                        .ofPattern(patternProperties.getDateformat()));
    }
}
```



### é…ç½®å…±äº«

å…¶å®å¾®æœåŠ¡å¯åŠ¨æ—¶ï¼Œä¼šå»nacosè¯»å–å¤šä¸ªé…ç½®æ–‡ä»¶ï¼Œä¾‹å¦‚ï¼š

- `[spring.application.name]-[spring.profiles.active].yaml`ï¼Œä¾‹å¦‚ï¼šuserservice-dev.yaml

- `[spring.application.name].yaml`ï¼Œä¾‹å¦‚ï¼šuserservice.yaml

è€Œ`[spring.application.name].yaml`ä¸åŒ…å«ç¯å¢ƒï¼Œå› æ­¤å¯ä»¥è¢«å¤šä¸ªç¯å¢ƒå…±äº«ã€‚

<br/>

ä¸‹é¢æˆ‘ä»¬é€šè¿‡æ¡ˆä¾‹æ¥æµ‹è¯•é…ç½®å…±äº«

<br/>

**æ·»åŠ ä¸€ä¸ªç¯å¢ƒå…±äº«é…ç½®**

æˆ‘ä»¬åœ¨nacosä¸­æ·»åŠ ä¸€ä¸ªuserservice.yamlæ–‡ä»¶ï¼š

```yaml
pattern:
  envSharedValue: å¤šç¯å¢ƒå…±äº«å±æ€§å€¼
```

![image-20240402162034393](./assets/image-20240402162034393.png)

<br/>

**åœ¨user-serviceä¸­è¯»å–å…±äº«é…ç½®**

åœ¨ user-service æœåŠ¡ä¸­ï¼Œä¿®æ”¹PatternPropertiesç±»ï¼Œè¯»å–æ–°æ·»åŠ çš„å±æ€§ï¼š

```java
package cn.itcast.user.config;

import lombok.Data;
import org.springframework.boot.context.properties.ConfigurationProperties;
import org.springframework.stereotype.Component;

@Component
@Data
@ConfigurationProperties(prefix = "pattern")
public class PatternProperties {
    private String dateformat;
    private String envSharedValue;
}
```

åœ¨user-serviceæœåŠ¡ä¸­ï¼Œä¿®æ”¹UserControllerï¼Œæ·»åŠ ä¸€ä¸ªæ–¹æ³•ï¼š

```Java
@Slf4j
@RestController
@RequestMapping("/user")
public class UserController {

    @Autowired
    private PatternProperties patternProperties;

    @GetMapping("prop")
    public PatternProperties prop(){
        return patternProperties;
    }

}
```



**è¿è¡Œä¸¤ä¸ªUserApplication**

ä¿®æ”¹ UserApplication2 è¿™ä¸ªå¯åŠ¨é¡¹ï¼Œä½¿ç”¨ä¸åŒçš„ profileï¼Œæ”¹å˜å…¶ profile å€¼ï¼š

![image-20240402162449438](./assets/image-20240402162449438.png)

è¿™æ ·ï¼ŒUserApplication(8081) ä½¿ç”¨çš„ profile æ˜¯ devï¼ŒUserApplication2(8082) ä½¿ç”¨çš„ profile æ˜¯ testã€‚

å¯åŠ¨ UserApplication å’Œ UserApplication2

<br/>

è®¿é—® http://localhost:8081/user/propï¼Œç»“æœï¼š

```json
{
    "dateformat": "yyyy-MM-dd HH:mm:ss",
    "envSharedValue": "å¤šç¯å¢ƒå…±äº«å±æ€§å€¼"
}
```

<br/>

è®¿é—® http://localhost:8082/user/propï¼Œç»“æœï¼š

```json
{
    "dateformat": null,
    "envSharedValue": "å¤šç¯å¢ƒå…±äº«å±æ€§å€¼"
}
```

å¯ä»¥çœ‹å‡ºæ¥ï¼Œä¸ç®¡æ˜¯ devï¼Œè¿˜æ˜¯ test ç¯å¢ƒï¼Œéƒ½è¯»å–åˆ°äº† envSharedValue è¿™ä¸ªå±æ€§çš„å€¼ã€‚

<br/>

**é…ç½®å…±äº«çš„ä¼˜å…ˆçº§**

å½“nacosã€æœåŠ¡æœ¬åœ°åŒæ—¶å‡ºç°ç›¸åŒå±æ€§æ—¶ï¼Œä¼˜å…ˆçº§æœ‰é«˜ä½ä¹‹åˆ†ï¼š

![image-20210714174623557](assets/image-20210714174623557.png)

<br/>

### æ­å»ºé›†ç¾¤

Nacos ç”Ÿäº§ç¯å¢ƒä¸‹ä¸€å®šè¦éƒ¨ç½²ä¸ºé›†ç¾¤çŠ¶æ€ï¼Œéƒ¨ç½²æ–¹å¼å‚è€ƒ: [æ­å»ºé›†ç¾¤](00æ“ä½œç¯‡-å®‰è£…Nacos.md#é›†ç¾¤æ­å»º)



## è¿œç¨‹è°ƒç”¨-Feign

å…ˆæ¥çœ‹æˆ‘ä»¬ä»¥å‰åˆ©ç”¨RestTemplateå‘èµ·è¿œç¨‹è°ƒç”¨çš„ä»£ç ï¼š

```Java
String url = "http://userservice/user/" + order.getUserId();
User user = restTemplate.getForObject(url, User.class);
```

å­˜åœ¨ä¸‹é¢çš„é—®é¢˜ï¼š

- ä»£ç å¯è¯»æ€§å·®ï¼Œç¼–ç¨‹ä½“éªŒä¸ç»Ÿä¸€
- å‚æ•°å¤æ‚URLéš¾ä»¥ç»´æŠ¤


<br/>

Feignæ˜¯ä¸€ä¸ªå£°æ˜å¼çš„httpå®¢æˆ·ç«¯ï¼Œå®˜æ–¹åœ°å€ï¼šhttps://github.com/OpenFeign/feign

å…¶ä½œç”¨å°±æ˜¯å¸®åŠ©æˆ‘ä»¬ä¼˜é›…çš„å®ç°httpè¯·æ±‚çš„å‘é€ï¼Œè§£å†³ä¸Šé¢æåˆ°çš„é—®é¢˜ã€‚

![image-20240402162926162](./assets/image-20240402162926162.png)

<br/>

### Feignæ›¿ä»£RestTemplate

Feginçš„ä½¿ç”¨æ­¥éª¤å¦‚ä¸‹ï¼š

<br/>

**å¼•å…¥ä¾èµ–**

æˆ‘ä»¬åœ¨ `order-service` æœåŠ¡çš„ pom.xml æ–‡ä»¶ä¸­å¼•å…¥ Feign çš„ä¾èµ–ï¼š

```xml
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-openfeign</artifactId>
</dependency>
```

<br/>

**æ·»åŠ æ³¨è§£**

åœ¨ `order-service` çš„å¯åŠ¨ç±»æ·»åŠ æ³¨è§£å¼€å¯Feignçš„åŠŸèƒ½ï¼š

```Java {1}
@EnableFeignClients
@MapperScan("cn.itcast.order.mapper")
@SpringBootApplication
public class OrderApplication {

    public static void main(String[] args) {
        SpringApplication.run(OrderApplication.class, args);
    }

}
```

<br/>

**ç¼–å†™Feignçš„å®¢æˆ·ç«¯**

åœ¨ `order-service` ä¸­æ–°å»ºä¸€ä¸ªæ¥å£ï¼Œå†…å®¹å¦‚ä¸‹ï¼š

```java
package cn.itcast.order.client;

import cn.itcast.order.pojo.User;
import org.springframework.cloud.openfeign.FeignClient;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;

@FeignClient("userservice")
public interface UserClient {
    @GetMapping("/user/{id}")
    User findById(@PathVariable("id") Long id);
}
```

è¿™ä¸ªå®¢æˆ·ç«¯ä¸»è¦æ˜¯åŸºäºSpringMVCçš„æ³¨è§£æ¥å£°æ˜è¿œç¨‹è°ƒç”¨çš„ä¿¡æ¯ï¼Œæ¯”å¦‚ï¼š

- æœåŠ¡åç§°ï¼šuserservice
- è¯·æ±‚æ–¹å¼ï¼šGET
- è¯·æ±‚è·¯å¾„ï¼š/user/{id}
- è¯·æ±‚å‚æ•°ï¼šLong id
- è¿”å›å€¼ç±»å‹ï¼šUser

è¿™æ ·ï¼ŒFeign å°±å¯ä»¥å¸®åŠ©æˆ‘ä»¬å‘é€ Http è¯·æ±‚ï¼Œæ— éœ€è‡ªå·±ä½¿ç”¨ RestTemplate æ¥å‘é€äº†ã€‚

<br/>

**æµ‹è¯•**

ä¿®æ”¹ `order-service` ä¸­çš„ OrderService ç±»ä¸­çš„ queryOrderById æ–¹æ³•ï¼Œä½¿ç”¨ Feign å®¢æˆ·ç«¯ä»£æ›¿RestTemplateï¼š

```Java {8,9,17}
@RestController
@RequestMapping("order")
public class OrderController {

   @Autowired
   private OrderService orderService;

    @Autowired
    private UserClient userClient;

    @GetMapping("{orderId}")
    public Order queryOrderByUserId(@PathVariable("orderId") Long orderId) {
        // æ ¹æ®idæŸ¥è¯¢è®¢å•å¹¶è¿”å›
        Order order = orderService.queryOrderById(orderId);

        //é€šè¿‡feignè°ƒç”¨useræœåŠ¡ï¼Œè·å–userç”¨æˆ·
        User user = userClient.findById(order.getUserId());
        order.setUser(user);

        return order;
    }
}
```

<br/>

### è‡ªå®šä¹‰é…ç½®

Feignå¯ä»¥æ”¯æŒå¾ˆå¤šçš„è‡ªå®šä¹‰é…ç½®ï¼Œå¦‚ä¸‹è¡¨æ‰€ç¤ºï¼š

![image-20240402163834634](./assets/image-20240402163834634.png)

ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œé»˜è®¤å€¼å°±èƒ½æ»¡è¶³æˆ‘ä»¬ä½¿ç”¨ï¼Œå¦‚æœè¦è‡ªå®šä¹‰æ—¶ï¼Œåªéœ€è¦åˆ›å»ºè‡ªå®šä¹‰çš„ @Bean è¦†ç›–é»˜è®¤ Beanå³å¯ã€‚

<br/>

#### é…ç½®æ–‡ä»¶æ–¹å¼

åŸºäºé…ç½®æ–‡ä»¶ä¿®æ”¹feignçš„æ—¥å¿—çº§åˆ«å¯ä»¥é’ˆå¯¹å•ä¸ªæœåŠ¡ï¼š

```yaml
feign:  
  client:
    config: 
      userservice: # é’ˆå¯¹æŸä¸ªå¾®æœåŠ¡çš„é…ç½®
        loggerLevel: FULL #  æ—¥å¿—çº§åˆ« 
```

ä¹Ÿå¯ä»¥é’ˆå¯¹æ‰€æœ‰æœåŠ¡ï¼š

```yaml
feign:  
  client:
    config: 
      default: # è¿™é‡Œç”¨defaultå°±æ˜¯å…¨å±€é…ç½®ï¼Œå¦‚æœæ˜¯å†™æœåŠ¡åç§°ï¼Œåˆ™æ˜¯é’ˆå¯¹æŸä¸ªå¾®æœåŠ¡çš„é…ç½®
        loggerLevel: FULL #  æ—¥å¿—çº§åˆ« 
```

è€Œæ—¥å¿—çš„çº§åˆ«åˆ†ä¸ºå››ç§ï¼š

- NONEï¼šä¸è®°å½•ä»»ä½•æ—¥å¿—ä¿¡æ¯ï¼Œè¿™æ˜¯é»˜è®¤å€¼ã€‚
- BASICï¼šä»…è®°å½•è¯·æ±‚çš„æ–¹æ³•ï¼ŒURLä»¥åŠå“åº”çŠ¶æ€ç å’Œæ‰§è¡Œæ—¶é—´
- HEADERSï¼šåœ¨BASICçš„åŸºç¡€ä¸Šï¼Œé¢å¤–è®°å½•äº†è¯·æ±‚å’Œå“åº”çš„å¤´ä¿¡æ¯
- FULLï¼šè®°å½•æ‰€æœ‰è¯·æ±‚å’Œå“åº”çš„æ˜ç»†ï¼ŒåŒ…æ‹¬å¤´ä¿¡æ¯ã€è¯·æ±‚ä½“ã€å…ƒæ•°æ®ã€‚

<br/>

#### Javaä»£ç æ–¹å¼

ä¹Ÿå¯ä»¥åŸºäºJavaä»£ç æ¥ä¿®æ”¹æ—¥å¿—çº§åˆ«ï¼Œå…ˆå£°æ˜ä¸€ä¸ªç±»ï¼Œç„¶åå£°æ˜ä¸€ä¸ªLogger.Levelçš„å¯¹è±¡ï¼š

```java
public class DefaultFeignConfiguration  {
    @Bean
    public Logger.Level feignLogLevel(){
        return Logger.Level.BASIC; // æ—¥å¿—çº§åˆ«ä¸ºBASIC
    }
}
```

å¦‚æœè¦**å…¨å±€ç”Ÿæ•ˆ**ï¼Œå°†å…¶æ”¾åˆ°å¯åŠ¨ç±»çš„@EnableFeignClientsè¿™ä¸ªæ³¨è§£ä¸­ï¼š

```java
@EnableFeignClients(defaultConfiguration = DefaultFeignConfiguration .class) 
```

å¦‚æœæ˜¯**å±€éƒ¨ç”Ÿæ•ˆ**ï¼Œåˆ™æŠŠå®ƒæ”¾åˆ°å¯¹åº”çš„@FeignClientè¿™ä¸ªæ³¨è§£ä¸­ï¼š

```java
@FeignClient(value = "userservice", configuration = DefaultFeignConfiguration .class) 
```

<br/>

### ä½¿ç”¨ä¼˜åŒ–

Feignåº•å±‚å‘èµ·httpè¯·æ±‚ï¼Œä¾èµ–äºå…¶å®ƒçš„æ¡†æ¶ã€‚å…¶åº•å±‚å®¢æˆ·ç«¯å®ç°åŒ…æ‹¬ï¼š

- URLConnectionï¼šé»˜è®¤å®ç°ï¼Œä¸æ”¯æŒè¿æ¥æ± 
- Apache HttpClient ï¼šæ”¯æŒè¿æ¥æ± 
- OKHttpï¼šæ”¯æŒè¿æ¥æ± 


<br/>

å› æ­¤æé«˜ Feign çš„æ€§èƒ½ä¸»è¦æ‰‹æ®µå°±æ˜¯ä½¿ç”¨**è¿æ¥æ± **ä»£æ›¿é»˜è®¤çš„ URLConnectionã€‚

è¿™é‡Œæˆ‘ä»¬ç”¨ Apache çš„ HttpClientæ¥æ¼”ç¤ºã€‚

<br/>

**å¼•å…¥ä¾èµ–**

åœ¨ `order-service` çš„ pom.xml æ–‡ä»¶ä¸­å¼•å…¥ Apache çš„ HttpClient ä¾èµ–ï¼š

```xml
<!--httpClientçš„ä¾èµ– -->
<dependency>
    <groupId>io.github.openfeign</groupId>
    <artifactId>feign-httpclient</artifactId>
</dependency>
```

<br/>

**é…ç½®è¿æ¥æ± **

åœ¨ `order-service` çš„ application.yml ä¸­æ·»åŠ é…ç½®ï¼š

```yaml
feign:
  client:
    config:
      default: # defaultå…¨å±€çš„é…ç½®
        loggerLevel: BASIC # æ—¥å¿—çº§åˆ«ï¼ŒBASICå°±æ˜¯åŸºæœ¬çš„è¯·æ±‚å’Œå“åº”ä¿¡æ¯
  httpclient:
    enabled: true # å¼€å¯feignå¯¹HttpClientçš„æ”¯æŒ
    max-connections: 200 # æœ€å¤§çš„è¿æ¥æ•°
    max-connections-per-route: 50 # æ¯ä¸ªè·¯å¾„çš„æœ€å¤§è¿æ¥æ•°
```

<br/>

æ¥ä¸‹æ¥ï¼Œåœ¨FeignClientFactoryBeanä¸­çš„loadBalanceæ–¹æ³•ä¸­æ‰“æ–­ç‚¹ï¼š

![image-20210714185925910](assets/image-20210714185925910.png)

<br/>

Debugæ–¹å¼å¯åŠ¨ `order-service` æœåŠ¡ï¼Œå¯ä»¥çœ‹åˆ°è¿™é‡Œçš„ Clientï¼Œåº•å±‚å°±æ˜¯Apache HttpClientï¼š

![image-20210714190041542](assets/image-20210714190041542.png)

Feignçš„ä¼˜åŒ–æ€»ç»“ï¼š

- æ—¥å¿—çº§åˆ«å°½é‡ç”¨ basic

- ä½¿ç”¨ HttpClient æˆ– OKHttp ä»£æ›¿ URLConnection
  - å¼•å…¥ feign-httpClient ä¾èµ–
  - é…ç½®æ–‡ä»¶å¼€å¯ httpClient åŠŸèƒ½ï¼Œè®¾ç½®è¿æ¥æ± å‚æ•°

<br/>

### æœ€ä½³å®è·µ

æ‰€è°“æœ€è¿‘å®è·µï¼Œå°±æ˜¯ä½¿ç”¨è¿‡ç¨‹ä¸­æ€»ç»“çš„ç»éªŒï¼Œæœ€å¥½çš„ä¸€ç§ä½¿ç”¨æ–¹å¼ã€‚

è‡ªä¹ è§‚å¯Ÿå¯ä»¥å‘ç°ï¼ŒFeignçš„å®¢æˆ·ç«¯ä¸æœåŠ¡æä¾›è€…çš„controllerä»£ç éå¸¸ç›¸ä¼¼ï¼š

<br/>

feignå®¢æˆ·ç«¯

```Java
@FeignClient("userservice")
public interface UserClient {
    @GetMapping("/user/{id}")
    User findById(@PathVariable("id") Long id);
}
```

<br/>

UserController

```Java
@Slf4j
@RestController
@RequestMapping("/user")
public class UserController {
    @Autowired
    private UserService userService;
    
    @GetMapping("/{id}")
    public User queryById(@PathVariable("id") Long id) {
        return userService.queryById(id);
    }
}

```

æœ‰æ²¡æœ‰ä¸€ç§åŠæ³•ç®€åŒ–è¿™ç§é‡å¤çš„ä»£ç ç¼–å†™å‘¢ï¼Ÿ

<br/>

#### ç»§æ‰¿æ–¹å¼

ä¸€æ ·çš„ä»£ç å¯ä»¥é€šè¿‡ç»§æ‰¿æ¥å…±äº«ï¼š

1ï¼‰å®šä¹‰ä¸€ä¸ª API æ¥å£ï¼Œåˆ©ç”¨å®šä¹‰æ–¹æ³•ï¼Œå¹¶åŸºäº SpringMVC æ³¨è§£åšå£°æ˜ã€‚

2ï¼‰Feign å®¢æˆ·ç«¯å’Œ Controller éƒ½é›†æˆæ”¹æ¥å£

![image-20210714190640857](assets/image-20210714190640857.png)



ä¼˜ç‚¹ï¼š

- ç®€å•
- å®ç°äº†ä»£ç å…±äº«

ç¼ºç‚¹ï¼š

- æœåŠ¡æä¾›æ–¹ã€æœåŠ¡æ¶ˆè´¹æ–¹ç´§è€¦åˆ

- å‚æ•°åˆ—è¡¨ä¸­çš„æ³¨è§£æ˜ å°„å¹¶ä¸ä¼šç»§æ‰¿ï¼Œå› æ­¤Controllerä¸­å¿…é¡»å†æ¬¡å£°æ˜æ–¹æ³•ã€å‚æ•°åˆ—è¡¨ã€æ³¨è§£

<br/>

#### æŠ½å–æ–¹å¼

å°† Feign Client æŠ½å–ä¸ºç‹¬ç«‹æ¨¡å—ï¼Œå¹¶ä¸”æŠŠæ¥å£æœ‰å…³çš„ POJOã€é»˜è®¤çš„ Feign é…ç½®éƒ½æ”¾åˆ°è¿™ä¸ªæ¨¡å—ä¸­ï¼Œæä¾›ç»™æ‰€æœ‰æ¶ˆè´¹è€…ä½¿ç”¨ã€‚

ä¾‹å¦‚ï¼Œå°† UserClientã€Userã€Feign çš„é»˜è®¤é…ç½®éƒ½æŠ½å–åˆ°ä¸€ä¸ª feign-api åŒ…ä¸­ï¼Œæ‰€æœ‰å¾®æœåŠ¡å¼•ç”¨è¯¥ä¾èµ–åŒ…ï¼Œå³å¯ç›´æ¥ä½¿ç”¨ã€‚

![image-20210714214041796](assets/image-20210714214041796.png)



#### å®ç°

**æŠ½å–**

é¦–å…ˆåˆ›å»ºä¸€ä¸ªmoduleï¼Œå‘½åä¸ºfeign-apiï¼š

![image-20240402172717306](./assets/image-20240402172717306.png)

åœ¨ feign-api ä¸­ç„¶åå¼•å…¥ feign çš„ starter ä¾èµ–

```xml
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-openfeign</artifactId>
</dependency>
```

ç„¶åï¼Œorder-serviceä¸­ç¼–å†™çš„UserClientã€Userã€DefaultFeignConfigurationéƒ½å¤åˆ¶åˆ°feign-apié¡¹ç›®ä¸­

![image-20210714205221970](assets/image-20210714205221970.png)



**åœ¨order-serviceä¸­ä½¿ç”¨feign-api**

é¦–å…ˆï¼Œåˆ é™¤ order-serviceä¸­çš„UserClientã€Userã€DefaultFeignConfigurationç­‰ç±»æˆ–æ¥å£ã€‚

åœ¨order-serviceçš„pomæ–‡ä»¶ä¸­ä¸­å¼•å…¥feign-apiçš„ä¾èµ–ï¼š

```xml
<dependency>
    <groupId>cn.itcast.demo</groupId>
    <artifactId>feign-api</artifactId>
    <version>1.0</version>
</dependency>
```

ä¿®æ”¹ `order-service` ä¸­çš„æ‰€æœ‰ä¸ä¸Šè¿°ä¸‰ä¸ªç»„ä»¶æœ‰å…³çš„å¯¼åŒ…éƒ¨åˆ†ï¼Œæ”¹æˆå¯¼å…¥ feign-api ä¸­çš„åŒ…

<br/>

**é‡å¯æµ‹è¯•**

é‡å¯åï¼Œå‘ç°æœåŠ¡æŠ¥é”™äº†ï¼š

```sh
Description:

Field userClient in cn.itcast.order.web.OrderController required a bean of type 'cn.itcast.feign.client.UserClient' that could not be found.

The injection point has the following annotations:
	- @org.springframework.beans.factory.annotation.Autowired(required=true)
```

è¿™æ˜¯å› ä¸º UserClient ç°åœ¨åœ¨ cn.itcast.feign.clients åŒ…ä¸‹ï¼Œ

è€Œ `order-service` çš„ @EnableFeignClients æ³¨è§£æ˜¯åœ¨ cn.itcast.order åŒ…ä¸‹ï¼Œä¸åœ¨åŒä¸€ä¸ªåŒ…ï¼Œæ— æ³•æ‰«æåˆ°UserClientã€‚

<br/>

**è§£å†³æ‰«æåŒ…é—®é¢˜**

æ–¹å¼ä¸€ï¼šæŒ‡å®šFeignåº”è¯¥æ‰«æçš„åŒ…

```java
@EnableFeignClients(basePackages = "cn.itcast.feign.clients")
@MapperScan("cn.itcast.order.mapper")
@SpringBootApplication
public class OrderApplication {

    public static void main(String[] args) {
        SpringApplication.run(OrderApplication.class, args);
    }

}
```

<br/>

æ–¹å¼äºŒï¼šæŒ‡å®šéœ€è¦åŠ è½½çš„Clientæ¥å£

```java
@EnableFeignClients(clients = {UserClient.class})
@MapperScan("cn.itcast.order.mapper")
@SpringBootApplication
public class OrderApplication {

    public static void main(String[] args) {
        SpringApplication.run(OrderApplication.class, args);
    }

}
```

<br/>

æµ‹è¯•ï¼š[localhost:8080/order/101](http://localhost:8080/order/101)

```json
{
    "id": 101,
    "price": 699900,
    "name": "Apple è‹¹æœ iPhone 12 ",
    "num": 1,
    "userId": 1,
    "user": {
        "id": 1,
        "username": "æŸ³å²©",
        "address": "æ¹–å—çœè¡¡é˜³å¸‚"
    }
}
```



## æœåŠ¡ç½‘å…³-Gateway

Spring Cloud Gateway æ˜¯ Spring Cloud çš„ä¸€ä¸ªå…¨æ–°é¡¹ç›®ï¼Œè¯¥é¡¹ç›®æ˜¯åŸºäº Spring 5.0ï¼ŒSpring Boot 2.0 å’Œ Project Reactor ç­‰å“åº”å¼ç¼–ç¨‹å’Œäº‹ä»¶æµæŠ€æœ¯å¼€å‘çš„ç½‘å…³ï¼Œå®ƒæ—¨åœ¨ä¸ºå¾®æœåŠ¡æ¶æ„æä¾›ä¸€ç§ç®€å•æœ‰æ•ˆçš„ç»Ÿä¸€çš„ API è·¯ç”±ç®¡ç†æ–¹å¼ã€‚

<br/>

> æ€è€ƒï¼šä¸ºä»€ä¹ˆéœ€è¦ç½‘å…³

Gatewayç½‘å…³æ˜¯æˆ‘ä»¬æœåŠ¡çš„å®ˆé—¨ç¥ï¼Œæ‰€æœ‰å¾®æœåŠ¡çš„ç»Ÿä¸€å…¥å£ã€‚ç½‘å…³çš„**æ ¸å¿ƒåŠŸèƒ½ç‰¹æ€§**ï¼š

- è¯·æ±‚è·¯ç”±
- æƒé™æ§åˆ¶
- é™æµ

<br/>

**æ¶æ„å›¾**

![image-20210714210131152](assets/image-20210714210131152.png)



**æƒé™æ§åˆ¶**ï¼šç½‘å…³ä½œä¸ºå¾®æœåŠ¡å…¥å£ï¼Œéœ€è¦æ ¡éªŒç”¨æˆ·æ˜¯æ˜¯å¦æœ‰è¯·æ±‚èµ„æ ¼ï¼Œå¦‚æœæ²¡æœ‰åˆ™è¿›è¡Œæ‹¦æˆªã€‚

**è·¯ç”±å’Œè´Ÿè½½å‡è¡¡**ï¼šä¸€åˆ‡è¯·æ±‚éƒ½å¿…é¡»å…ˆç»è¿‡ Gatewayï¼Œä½†ç½‘å…³ä¸å¤„ç†ä¸šåŠ¡ï¼Œè€Œæ˜¯æ ¹æ®æŸç§è§„åˆ™ï¼ŒæŠŠè¯·æ±‚è½¬å‘åˆ°æŸä¸ªå¾®æœåŠ¡ï¼Œè¿™ä¸ªè¿‡ç¨‹å«åšè·¯ç”±ã€‚å½“ç„¶è·¯ç”±çš„ç›®æ ‡æœåŠ¡æœ‰å¤šä¸ªæ—¶ï¼Œè¿˜éœ€è¦åšè´Ÿè½½å‡è¡¡ã€‚

**é™æµ**ï¼šå½“è¯·æ±‚æµé‡è¿‡é«˜æ—¶ï¼Œåœ¨ç½‘å…³ä¸­æŒ‰ç…§ä¸‹æµçš„å¾®æœåŠ¡èƒ½å¤Ÿæ¥å—çš„é€Ÿåº¦æ¥æ”¾è¡Œè¯·æ±‚ï¼Œé¿å…æœåŠ¡å‹åŠ›è¿‡å¤§ã€‚

<br/>

åœ¨ SpringCloud ä¸­ç½‘å…³çš„å®ç°åŒ…æ‹¬ä¸¤ç§ï¼š

- Gateway
- Zuul

Zuul æ˜¯åŸºäº Servlet çš„å®ç°ï¼Œå±äºé˜»å¡å¼ç¼–ç¨‹ã€‚è€Œ SpringCloud Gateway åˆ™æ˜¯åŸºäº Spring5 ä¸­æä¾›çš„ WebFluxï¼Œå±äºå“åº”å¼ç¼–ç¨‹çš„å®ç°ï¼Œå…·å¤‡æ›´å¥½çš„æ€§èƒ½ã€‚

<br/>

### å¿«é€Ÿå…¥é—¨

ä¸‹é¢ï¼Œæˆ‘ä»¬å°±æ¼”ç¤ºä¸‹ç½‘å…³çš„åŸºæœ¬è·¯ç”±åŠŸèƒ½ã€‚åŸºæœ¬æ­¥éª¤å¦‚ä¸‹ï¼š

1. åˆ›å»º GatewayæœåŠ¡ï¼Œå¼•å…¥ç½‘å…³ä¾èµ–
2. ç¼–å†™å¯åŠ¨ç±»
3. ç¼–å†™åŸºç¡€é…ç½®å’Œè·¯ç”±è§„åˆ™
4. å¯åŠ¨ç½‘å…³æœåŠ¡è¿›è¡Œæµ‹è¯•

<br/>

**åˆ›å»º Gateway æœåŠ¡ï¼Œå¼•å…¥ä¾èµ–**

![image-20240403100305109](./assets/image-20240403100305109.png)

**å¼•å…¥ä¾èµ–**

```xml
<!--ç½‘å…³-->
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-gateway</artifactId>
</dependency>
<!--nacosæœåŠ¡å‘ç°ä¾èµ–-->
<dependency>
    <groupId>com.alibaba.cloud</groupId>
    <artifactId>spring-cloud-starter-alibaba-nacos-discovery</artifactId>
</dependency>
```

<br/>

**ç¼–å†™å¯åŠ¨ç±»**

```java
package cn.itcast.gateway;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;

@SpringBootApplication
public class GatewayApplication {

	public static void main(String[] args) {
		SpringApplication.run(GatewayApplication.class, args);
	}
}
```

<br/>

**ç¼–å†™åŸºç¡€é…ç½®å’Œè·¯ç”±è§„åˆ™**

åˆ›å»º application.yml æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š

```yaml
server:
  port: 10010 # ç½‘å…³ç«¯å£
spring:
  application:
    name: gateway # æœåŠ¡åç§°
  cloud:
    nacos:
      server-addr: localhost:8848 # nacosåœ°å€
    gateway:
      routes: # ç½‘å…³è·¯ç”±é…ç½®
        - id: user-service # è·¯ç”±idï¼Œè‡ªå®šä¹‰ï¼Œåªè¦å”¯ä¸€å³å¯
          # uri: http://127.0.0.1:8081 # è·¯ç”±çš„ç›®æ ‡åœ°å€ httpå°±æ˜¯å›ºå®šåœ°å€
          uri: lb://userservice # è·¯ç”±çš„ç›®æ ‡åœ°å€ lbå°±æ˜¯è´Ÿè½½å‡è¡¡ï¼Œåé¢è·ŸæœåŠ¡åç§°
          predicates: # è·¯ç”±æ–­è¨€ï¼Œä¹Ÿå°±æ˜¯åˆ¤æ–­è¯·æ±‚æ˜¯å¦ç¬¦åˆè·¯ç”±è§„åˆ™çš„æ¡ä»¶
            - Path=/user/** # è¿™ä¸ªæ˜¯æŒ‰ç…§è·¯å¾„åŒ¹é…ï¼Œåªè¦ä»¥/user/å¼€å¤´å°±ç¬¦åˆè¦æ±‚
```

æˆ‘ä»¬å°†ç¬¦åˆ `Path`  è§„åˆ™çš„ä¸€åˆ‡è¯·æ±‚ï¼Œéƒ½ä»£ç†åˆ°  `uri `å‚æ•°æŒ‡å®šçš„åœ°å€ã€‚

æœ¬ä¾‹ä¸­ï¼Œæˆ‘ä»¬å°† `/user/**`å¼€å¤´çš„è¯·æ±‚ï¼Œä»£ç†åˆ°`lb://userservice`ï¼Œlbæ˜¯è´Ÿè½½å‡è¡¡ï¼Œæ ¹æ®æœåŠ¡åæ‹‰å–æœåŠ¡åˆ—è¡¨ï¼Œå®ç°è´Ÿè½½å‡è¡¡ã€‚

<br/>

**é‡å¯æµ‹è¯•**

é‡å¯ç½‘å…³ï¼Œè®¿é—® `http://localhost:10010/user/1`  æ—¶ï¼Œç¬¦åˆ`/user/**`è§„åˆ™ã€‚è¯·æ±‚è½¬å‘åˆ°uriï¼šhttp://userservice/user/1

```json
{
    "id": 1,
    "username": "æŸ³å²©",
    "address": "æ¹–å—çœè¡¡é˜³å¸‚"
}
```

<br/>

**ç½‘å…³è·¯ç”±çš„æµç¨‹å›¾**

æ•´ä¸ªè®¿é—®çš„æµç¨‹å¦‚ä¸‹ï¼š

![image-20210714211742956](assets/image-20210714211742956.png)

ç½‘å…³æ­å»ºæ­¥éª¤ï¼š

1. åˆ›å»ºé¡¹ç›®ï¼Œå¼•å…¥ Nacos æœåŠ¡å‘ç°å’Œ Gateway ä¾èµ–
2. é…ç½® application.ymlï¼ŒåŒ…æ‹¬æœåŠ¡åŸºæœ¬ä¿¡æ¯ã€Nacosåœ°å€ã€è·¯ç”±

è·¯ç”±é…ç½®åŒ…æ‹¬ï¼š

1. è·¯ç”±idï¼šè·¯ç”±çš„å”¯ä¸€æ ‡ç¤º
2. è·¯ç”±ç›®æ ‡ï¼ˆuriï¼‰ï¼šè·¯ç”±çš„ç›®æ ‡åœ°å€ï¼Œhttpä»£è¡¨å›ºå®šåœ°å€ï¼Œlbä»£è¡¨æ ¹æ®æœåŠ¡åè´Ÿè½½å‡è¡¡
3. è·¯ç”±æ–­è¨€ï¼ˆpredicatesï¼‰ï¼šåˆ¤æ–­è·¯ç”±çš„è§„åˆ™ï¼Œ
4. è·¯ç”±è¿‡æ»¤å™¨ï¼ˆfiltersï¼‰ï¼šå¯¹è¯·æ±‚æˆ–å“åº”åšå¤„ç†

æ¥ä¸‹æ¥ï¼Œå°±é‡ç‚¹æ¥å­¦ä¹ è·¯ç”±æ–­è¨€å’Œè·¯ç”±è¿‡æ»¤å™¨çš„è¯¦ç»†çŸ¥è¯†

<br/>

### æ–­è¨€å·¥å‚

æˆ‘ä»¬åœ¨é…ç½®æ–‡ä»¶ä¸­å†™çš„æ–­è¨€è§„åˆ™åªæ˜¯å­—ç¬¦ä¸²ï¼Œè¿™äº›å­—ç¬¦ä¸²ä¼šè¢«Predicate Factoryè¯»å–å¹¶å¤„ç†ï¼Œè½¬å˜ä¸ºè·¯ç”±åˆ¤æ–­çš„æ¡ä»¶

ä¾‹å¦‚Path=/user/**æ˜¯æŒ‰ç…§è·¯å¾„åŒ¹é…ï¼Œè¿™ä¸ªè§„åˆ™æ˜¯ç”±

`org.springframework.cloud.gateway.handler.predicate.PathRoutePredicateFactory`ç±»æ¥

å¤„ç†çš„ï¼Œåƒè¿™æ ·çš„æ–­è¨€å·¥å‚åœ¨ SpringCloudGateway è¿˜æœ‰åå‡ ä¸ª:

![image-20240402163907930](./assets/image-20240402163907930.png)

æˆ‘ä»¬åªéœ€è¦æŒæ¡Pathè¿™ç§è·¯ç”±å·¥ç¨‹å°±å¯ä»¥äº†ã€‚

<br/>

### è¿‡æ»¤å™¨å·¥å‚

GatewayFilteræ˜¯ç½‘å…³ä¸­æä¾›çš„ä¸€ç§è¿‡æ»¤å™¨ï¼Œå¯ä»¥å¯¹è¿›å…¥ç½‘å…³çš„è¯·æ±‚å’Œå¾®æœåŠ¡è¿”å›çš„å“åº”åšå¤„ç†ï¼š

![image-20210714212312871](assets/image-20210714212312871.png)

<br/>

#### è·¯ç”±è¿‡æ»¤å™¨çš„ç§ç±»

Springæä¾›äº†31ç§ä¸åŒçš„è·¯ç”±è¿‡æ»¤å™¨å·¥å‚ã€‚ä¾‹å¦‚ï¼š

| **åç§°**             | **è¯´æ˜**                     |
| -------------------- | ---------------------------- |
| AddRequestHeader     | ç»™å½“å‰è¯·æ±‚æ·»åŠ ä¸€ä¸ªè¯·æ±‚å¤´     |
| RemoveRequestHeader  | ç§»é™¤è¯·æ±‚ä¸­çš„ä¸€ä¸ªè¯·æ±‚å¤´       |
| AddResponseHeader    | ç»™å“åº”ç»“æœä¸­æ·»åŠ ä¸€ä¸ªå“åº”å¤´   |
| RemoveResponseHeader | ä»å“åº”ç»“æœä¸­ç§»é™¤æœ‰ä¸€ä¸ªå“åº”å¤´ |
| RequestRateLimiter   | é™åˆ¶è¯·æ±‚çš„æµé‡               |

<br/>

#### è¯·æ±‚å¤´è¿‡æ»¤å™¨

ä¸‹é¢æˆ‘ä»¬ä»¥AddRequestHeader ä¸ºä¾‹æ¥è®²è§£ã€‚

> **éœ€æ±‚**ï¼šç»™æ‰€æœ‰è¿›å…¥ userservice çš„è¯·æ±‚æ·»åŠ ä¸€ä¸ªè¯·æ±‚å¤´ï¼šTruth=itcast is freaking awesome!

åªéœ€è¦ä¿®æ”¹ Gateway æœåŠ¡çš„ application.yml æ–‡ä»¶ï¼Œæ·»åŠ è·¯ç”±è¿‡æ»¤å³å¯ï¼š

```yaml {10}
spring:
  cloud:
    gateway:
      routes:
      - id: user-service 
        uri: lb://userservice 
        predicates: 
        - Path=/user/** 
        filters: # è¿‡æ»¤å™¨
        - AddRequestHeader=Truth, Itcast is freaking awesome! # æ·»åŠ è¯·æ±‚å¤´
```

å½“å‰è¿‡æ»¤å™¨å†™åœ¨ userservice è·¯ç”±ä¸‹ï¼Œå› æ­¤ä»…ä»…å¯¹è®¿é—® userservice çš„è¯·æ±‚æœ‰æ•ˆã€‚

<br/>

#### é»˜è®¤è¿‡æ»¤å™¨

å¦‚æœè¦å¯¹æ‰€æœ‰çš„è·¯ç”±éƒ½ç”Ÿæ•ˆï¼Œåˆ™å¯ä»¥å°†è¿‡æ»¤å™¨å·¥å‚å†™åˆ° default ä¸‹ã€‚æ ¼å¼å¦‚ä¸‹ï¼š

```yaml
spring:
  cloud:
    gateway:
      routes:
      - id: user-service 
        uri: lb://userservice 
        predicates: 
        - Path=/user/**
      default-filters: # é»˜è®¤è¿‡æ»¤é¡¹
      - AddRequestHeader=Truth, Itcast is freaking awesome! 
```

<br/>

**æ€»ç»“**

- è¿‡æ»¤å™¨çš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ

  -  å¯¹è·¯ç”±çš„è¯·æ±‚æˆ–å“åº”åšåŠ å·¥å¤„ç†ï¼Œæ¯”å¦‚æ·»åŠ è¯·æ±‚å¤´

  -  é…ç½®åœ¨è·¯ç”±ä¸‹çš„è¿‡æ»¤å™¨åªå¯¹å½“å‰è·¯ç”±çš„è¯·æ±‚ç”Ÿæ•ˆ

- defaultFiltersçš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ

  - å¯¹æ‰€æœ‰è·¯ç”±éƒ½ç”Ÿæ•ˆçš„è¿‡æ»¤å™¨


<br/>

### å…¨å±€è¿‡æ»¤å™¨

ä¸Šä¸€èŠ‚å­¦ä¹ çš„è¿‡æ»¤å™¨ï¼Œç½‘å…³æä¾›äº†31ç§ï¼Œä½†æ¯ä¸€ç§è¿‡æ»¤å™¨çš„ä½œç”¨éƒ½æ˜¯å›ºå®šçš„ã€‚å¦‚æœæˆ‘ä»¬å¸Œæœ›æ‹¦æˆªè¯·æ±‚ï¼Œåšè‡ªå·±çš„ä¸šåŠ¡é€»è¾‘åˆ™æ²¡åŠæ³•å®ç°ã€‚

<br/>

**ä½œç”¨**

å…¨å±€è¿‡æ»¤å™¨çš„ä½œç”¨ä¹Ÿæ˜¯å¤„ç†ä¸€åˆ‡è¿›å…¥ç½‘å…³çš„è¯·æ±‚å’Œå¾®æœåŠ¡å“åº”ï¼Œä¸ GatewayFilter çš„ä½œç”¨ä¸€æ ·ã€‚åŒºåˆ«åœ¨äº GatewayFilter é€šè¿‡é…ç½®å®šä¹‰ï¼Œå¤„ç†é€»è¾‘æ˜¯å›ºå®šçš„ï¼›è€Œ GlobalFilter çš„é€»è¾‘éœ€è¦è‡ªå·±å†™ä»£ç å®ç°ã€‚

å®šä¹‰æ–¹å¼æ˜¯å®ç° GlobalFilter æ¥å£ã€‚

```java
public interface GlobalFilter {
    /**
     *  å¤„ç†å½“å‰è¯·æ±‚ï¼Œæœ‰å¿…è¦çš„è¯é€šè¿‡{@link GatewayFilterChain}å°†è¯·æ±‚äº¤ç»™ä¸‹ä¸€ä¸ªè¿‡æ»¤å™¨å¤„ç†
     *
     * @param exchange è¯·æ±‚ä¸Šä¸‹æ–‡ï¼Œé‡Œé¢å¯ä»¥è·å–Requestã€Responseç­‰ä¿¡æ¯
     * @param chain ç”¨æ¥æŠŠè¯·æ±‚å§”æ‰˜ç»™ä¸‹ä¸€ä¸ªè¿‡æ»¤å™¨ 
     * @return {@code Mono<Void>} è¿”å›æ ‡ç¤ºå½“å‰è¿‡æ»¤å™¨ä¸šåŠ¡ç»“æŸ
     */
    Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain);
}
```

åœ¨ Filter ä¸­ç¼–å†™è‡ªå®šä¹‰é€»è¾‘ï¼Œå¯ä»¥å®ç°ä¸‹åˆ—åŠŸèƒ½ï¼š

- ç™»å½•çŠ¶æ€åˆ¤æ–­
- æƒé™æ ¡éªŒ
- è¯·æ±‚é™æµç­‰

<br/>

**è‡ªå®šä¹‰å…¨å±€è¿‡æ»¤å™¨**

éœ€æ±‚ï¼šå®šä¹‰å…¨å±€è¿‡æ»¤å™¨ï¼Œæ‹¦æˆªè¯·æ±‚ï¼Œåˆ¤æ–­è¯·æ±‚çš„å‚æ•°æ˜¯å¦æ»¡è¶³ä¸‹é¢æ¡ä»¶ï¼š

- å‚æ•°ä¸­æ˜¯å¦æœ‰ authorizationï¼Œ

- authorization å‚æ•°å€¼æ˜¯å¦ä¸º admin

å¦‚æœåŒæ—¶æ»¡è¶³åˆ™æ”¾è¡Œï¼Œå¦åˆ™æ‹¦æˆª

<br/>

å®ç°ï¼šåœ¨ Gateway ä¸­å®šä¹‰ä¸€ä¸ªè¿‡æ»¤å™¨

```java
package cn.itcast.gateway.filters;

import org.springframework.cloud.gateway.filter.GatewayFilterChain;
import org.springframework.cloud.gateway.filter.GlobalFilter;
import org.springframework.core.annotation.Order;
import org.springframework.http.HttpStatus;
import org.springframework.stereotype.Component;
import org.springframework.web.server.ServerWebExchange;
import reactor.core.publisher.Mono;

@Order(-1)
@Component
public class AuthorizeFilter implements GlobalFilter {
    @Override
    public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
        // 1.è·å–è¯·æ±‚å‚æ•°
        MultiValueMap<String, String> params = exchange.getRequest().getQueryParams();
        // 2.è·å–authorizationå‚æ•°
        String auth = params.getFirst("authorization");
        // 3.æ ¡éªŒ
        if ("admin".equals(auth)) {
            // æ”¾è¡Œ
            return chain.filter(exchange);
        }
        // 4.æ‹¦æˆª
        // 4.1.ç¦æ­¢è®¿é—®ï¼Œè®¾ç½®çŠ¶æ€ç 
        exchange.getResponse().setStatusCode(HttpStatus.FORBIDDEN);
        // 4.2.ç»“æŸå¤„ç†
        return exchange.getResponse().setComplete();
    }
}
```

<br/>

**è¿‡æ»¤å™¨æ‰§è¡Œé¡ºåº**

è¯·æ±‚è¿›å…¥ç½‘å…³ä¼šç¢°åˆ°ä¸‰ç±»è¿‡æ»¤å™¨ï¼šå½“å‰è·¯ç”±çš„è¿‡æ»¤å™¨ã€DefaultFilterã€GlobalFilter

è¯·æ±‚è·¯ç”±åï¼Œä¼šå°†å½“å‰è·¯ç”±è¿‡æ»¤å™¨å’Œ DefaultFilterã€GlobalFilterï¼Œåˆå¹¶åˆ°ä¸€ä¸ªè¿‡æ»¤å™¨é“¾ï¼ˆé›†åˆï¼‰ä¸­ï¼Œæ’åºåä¾æ¬¡æ‰§è¡Œæ¯ä¸ªè¿‡æ»¤å™¨ï¼š

![image-20210714214228409](assets/image-20210714214228409.png)

<br/>

æ’åºçš„è§„åˆ™æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ

- æ¯ä¸€ä¸ªè¿‡æ»¤å™¨éƒ½å¿…é¡»æŒ‡å®šä¸€ä¸ª int ç±»å‹çš„ order å€¼ï¼Œ**orderå€¼è¶Šå°ï¼Œä¼˜å…ˆçº§è¶Šé«˜ï¼Œæ‰§è¡Œé¡ºåºè¶Šé å‰**ã€‚

- GlobalFilter é€šè¿‡å®ç° Ordered æ¥å£ï¼Œæˆ–è€…æ·»åŠ  @Order æ³¨è§£æ¥æŒ‡å®š order å€¼ï¼Œç”±æˆ‘ä»¬è‡ªå·±æŒ‡å®š

- è·¯ç”±è¿‡æ»¤å™¨å’Œd efaultFilter çš„ order ç”± Spring æŒ‡å®šï¼Œé»˜è®¤æ˜¯æŒ‰ç…§å£°æ˜é¡ºåºä»1é€’å¢ã€‚

- å½“è¿‡æ»¤å™¨çš„ order å€¼ä¸€æ ·æ—¶ï¼Œä¼šæŒ‰ç…§ defaultFilter > è·¯ç”±è¿‡æ»¤å™¨ > GlobalFilter çš„é¡ºåºæ‰§è¡Œã€‚

<br/>

è¯¦ç»†å†…å®¹ï¼Œå¯ä»¥æŸ¥çœ‹æºç ï¼š

`org.springframework.cloud.gateway.route.RouteDefinitionRouteLocator#getFilters()`æ–¹æ³•æ˜¯å…ˆåŠ è½½defaultFiltersï¼Œç„¶åå†åŠ è½½æŸä¸ªrouteçš„filtersï¼Œç„¶ååˆå¹¶ã€‚

`org.springframework.cloud.gateway.handler.FilteringWebHandler#handle()`æ–¹æ³•ä¼šåŠ è½½å…¨å±€è¿‡æ»¤å™¨ï¼Œä¸å‰é¢çš„è¿‡æ»¤å™¨åˆå¹¶åæ ¹æ®orderæ’åºï¼Œç»„ç»‡è¿‡æ»¤å™¨é“¾

<br/>

### è·¨åŸŸé—®é¢˜

> æ€è€ƒï¼šä»€ä¹ˆæ˜¯è·¨åŸŸé—®é¢˜

è·¨åŸŸï¼šåŸŸåä¸ä¸€è‡´å°±æ˜¯è·¨åŸŸï¼Œä¸»è¦åŒ…æ‹¬ï¼š

- åŸŸåä¸åŒï¼š www.taobao.com å’Œ www.taobao.org å’Œ www.jd.com å’Œ miaosha.jd.com

- åŸŸåç›¸åŒï¼Œç«¯å£ä¸åŒï¼šlocalhost:8080 å’Œ localhost8081

è·¨åŸŸé—®é¢˜ï¼šæµè§ˆå™¨ç¦æ­¢è¯·æ±‚çš„å‘èµ·è€…ä¸æœåŠ¡ç«¯å‘ç”Ÿè·¨åŸŸ Ajaxè¯·æ±‚ï¼Œè¯·æ±‚è¢«æµè§ˆå™¨æ‹¦æˆªçš„é—®é¢˜

<br/>

è§£å†³æ–¹æ¡ˆï¼šCORSï¼Œè¿™ä¸ªä»¥å‰åº”è¯¥å­¦ä¹ è¿‡ï¼Œè¿™é‡Œä¸å†èµ˜è¿°äº†ã€‚ä¸çŸ¥é“çš„å°ä¼™ä¼´å¯ä»¥æŸ¥çœ‹ https://www.ruanyifeng.com/blog/2016/04/cors.html

<br/>

#### æ¨¡æ‹Ÿè·¨åŸŸé—®é¢˜

åˆ›å»ºindex.htmlæ–‡ä»¶

```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
</head>
<body>
<pre>
spring:
  cloud:
    gateway:
      globalcors: # å…¨å±€çš„è·¨åŸŸå¤„ç†
        add-to-simple-url-handler-mapping: true # è§£å†³optionsè¯·æ±‚è¢«æ‹¦æˆªé—®é¢˜
        corsConfigurations:
          '[/**]':
            allowedOrigins: # å…è®¸å“ªäº›ç½‘ç«™çš„è·¨åŸŸè¯·æ±‚
              - "http://localhost:8090"
              - "http://www.leyou.com"
            allowedMethods: # å…è®¸çš„è·¨åŸŸajaxçš„è¯·æ±‚æ–¹å¼
              - "GET"
              - "POST"
              - "DELETE"
              - "PUT"
              - "OPTIONS"
            allowedHeaders: "*" # å…è®¸åœ¨è¯·æ±‚ä¸­æºå¸¦çš„å¤´ä¿¡æ¯
            allowCredentials: true # æ˜¯å¦å…è®¸æºå¸¦cookie
            maxAge: 360000 # è¿™æ¬¡è·¨åŸŸæ£€æµ‹çš„æœ‰æ•ˆæœŸ
</pre>
</body>
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<script>
  axios.get("http://localhost:10010/user/1?authorization=admin")
  .then(resp => console.log(resp.data))
  .catch(err => console.log(err))
</script>
</html>
```

æ”¾å…¥ tomcat æˆ–è€… nginx è¿™æ ·çš„ web æœåŠ¡å™¨ä¸­ï¼Œå¯åŠ¨å¹¶è®¿é—®ã€‚

å¯ä»¥åœ¨æµè§ˆå™¨æ§åˆ¶å°çœ‹åˆ°ä¸‹é¢çš„é”™è¯¯ï¼š

![image-20210714215832675](assets/image-20210714215832675.png)

ä» localhost:8090 è®¿é—® localhost:10010ï¼Œç«¯å£ä¸åŒï¼Œæ˜¾ç„¶æ˜¯è·¨åŸŸçš„è¯·æ±‚ã€‚

<br/>

#### è§£å†³è·¨åŸŸé—®é¢˜

åœ¨gatewayæœåŠ¡çš„application.ymlæ–‡ä»¶ä¸­ï¼Œæ·»åŠ ä¸‹é¢çš„é…ç½®ï¼š

```yaml
spring:
  cloud:
    gateway:
      # ã€‚ã€‚ã€‚
      globalcors: # å…¨å±€çš„è·¨åŸŸå¤„ç†
        add-to-simple-url-handler-mapping: true # è§£å†³optionsè¯·æ±‚è¢«æ‹¦æˆªé—®é¢˜
        corsConfigurations:
          '[/**]':
            allowedOrigins: # å…è®¸å“ªäº›ç½‘ç«™çš„è·¨åŸŸè¯·æ±‚ 
              - "http://localhost:8090"
            allowedMethods: # å…è®¸çš„è·¨åŸŸajaxçš„è¯·æ±‚æ–¹å¼
              - "GET"
              - "POST"
              - "DELETE"
              - "PUT"
              - "OPTIONS"
            allowedHeaders: "*" # å…è®¸åœ¨è¯·æ±‚ä¸­æºå¸¦çš„å¤´ä¿¡æ¯
            allowCredentials: true # æ˜¯å¦å…è®¸æºå¸¦cookie
            maxAge: 360000 # è¿™æ¬¡è·¨åŸŸæ£€æµ‹çš„æœ‰æ•ˆæœŸ
```
















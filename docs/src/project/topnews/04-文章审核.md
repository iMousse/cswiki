Day04-æ–‡ç« å®¡æ ¸
====================

[[toc]]

## å®¡æ ¸æµç¨‹

**æ•°æ®æµå‘**

![image-20240111193412234](assets/image-20240111193412234.png)

<br/>

**å®¡æ ¸æ–¹å¼**

- è‡ªåŠ¨å®¡æ ¸ï¼šæ–‡ç« å‘å¸ƒä¹‹åï¼Œç³»ç»Ÿè‡ªåŠ¨å®¡æ ¸ã€‚
  - æ–¹æ¡ˆä¸€ï¼šä¸»è¦æ˜¯é€šè¿‡ç¬¬ä¸‰æ–¹æ¥å£å¯¹æ–‡ç« æ–‡æœ¬å’Œå›¾ç‰‡è¿›è¡Œå®¡æ ¸ï¼ˆæˆåŠŸã€å¤±è´¥ã€äººå·¥å®¡æ ¸ï¼‰
  - æ–¹æ¡ˆäºŒï¼šé€šè¿‡DFAç®—æ³•å®ç°è‡ªç®¡ç†æ•æ„Ÿè¯ï¼Œé€šè¿‡Tess4jå®ç°å›¾ç‰‡æ–‡å­—è¯†åˆ«å¯¹å›¾ç‰‡è¿›è¡Œå®¡æ ¸
- äººå·¥å®¡æ ¸ï¼šæ–‡ç« ï¼Œç³»ç»Ÿä¸ç¡®å®šæ˜¯å¦è¿è§„
  - å¾…è‡ªåŠ¨å®¡æ ¸è¿”å›ä¸ç¡®å®šä¿¡æ¯æ—¶ï¼Œè½¬åˆ°äººå·¥å®¡æ ¸ï¼Œç”±å¹³å°ç®¡ç†å‘˜è¿›è¡Œå®¡æ ¸ã€‚

<br/>

**å®¡æ ¸æµç¨‹**

1. è‡ªåª’ä½“ç«¯å‘å¸ƒæ–‡ç« åï¼Œå¼€å§‹å®¡æ ¸æ–‡ç« 
2. å®¡æ ¸çš„ä¸»è¦æ˜¯å®¡æ ¸æ–‡ç« çš„å†…å®¹ï¼ˆæ–‡æœ¬å†…å®¹å’Œå›¾ç‰‡ï¼‰
3. å€ŸåŠ©ç¬¬ä¸‰æ–¹æä¾›çš„æ¥å£å®¡æ ¸æ–‡æœ¬
4. å€ŸåŠ©ç¬¬ä¸‰æ–¹æä¾›çš„æ¥å£å®¡æ ¸å›¾ç‰‡ï¼Œç”±äºå›¾ç‰‡å­˜å‚¨åˆ°minIOä¸­ï¼Œéœ€è¦å…ˆä¸‹è½½æ‰èƒ½å®¡æ ¸
5. å¦‚æœå®¡æ ¸å¤±è´¥ï¼Œåˆ™éœ€è¦ä¿®æ”¹è‡ªåª’ä½“æ–‡ç« çš„çŠ¶æ€ã€‚status: 2  å®¡æ ¸å¤±è´¥    status:3  è½¬åˆ°äººå·¥å®¡æ ¸
6. å¦‚æœå®¡æ ¸æˆåŠŸï¼Œåˆ™éœ€è¦åœ¨æ–‡ç« å¾®æœåŠ¡ä¸­åˆ›å»ºappç«¯éœ€è¦çš„æ–‡ç« 

![image-20240303140350652](assets/image-20240303140350652.png)

## å†…å®¹å®‰å…¨

å†…å®¹å®‰å…¨æ˜¯è¯†åˆ«æœåŠ¡ï¼Œæ”¯æŒå¯¹å›¾ç‰‡ã€è§†é¢‘ã€æ–‡æœ¬ã€è¯­éŸ³ç­‰å¯¹è±¡è¿›è¡Œå¤šæ ·åŒ–åœºæ™¯æ£€æµ‹ï¼Œæœ‰æ•ˆé™ä½å†…å®¹è¿è§„é£é™©ã€‚

ç›®å‰å¾ˆå¤šå¹³å°éƒ½æ”¯æŒå†…å®¹æ£€æµ‹ï¼Œå¦‚é˜¿é‡Œäº‘ã€è…¾è®¯äº‘ã€ç™¾åº¦AIã€ç½‘æ˜“äº‘ç­‰å›½å†…å¤§å‹äº’è”ç½‘å…¬å¸éƒ½å¯¹å¤–æä¾›äº†APIã€‚

æŒ‰ç…§æ€§èƒ½å’Œæ”¶è´¹æ¥çœ‹ï¼Œé»‘é©¬å¤´æ¡é¡¹ç›®ä½¿ç”¨çš„å°±æ˜¯é˜¿é‡Œäº‘çš„å†…å®¹å®‰å…¨æ¥å£ï¼Œä½¿ç”¨åˆ°äº†å›¾ç‰‡å’Œæ–‡æœ¬çš„å®¡æ ¸ã€‚

é˜¿é‡Œäº‘æ”¶è´¹æ ‡å‡†ï¼š[ä»·æ ¼è®¡ç®—å™¨ (aliyun.com)](https://www.aliyun.com/price/product/?spm=a2c4g.11186623.2.10.4146401eg5oeu8#/commodity/vm)

<br/>

### å‡†å¤‡å·¥ä½œ

æ‚¨åœ¨ä½¿ç”¨å†…å®¹æ£€æµ‹APIä¹‹å‰ï¼Œéœ€è¦å…ˆæ³¨å†Œé˜¿é‡Œäº‘è´¦å·ï¼Œæ·»åŠ Access Keyå¹¶ç­¾çº¦äº‘ç›¾å†…å®¹å®‰å…¨ã€‚

**æ“ä½œæ­¥éª¤**

1. å‰å¾€[é˜¿é‡Œäº‘å®˜ç½‘](https://www.aliyun.com/)æ³¨å†Œè´¦å·ã€‚å¦‚æœå·²æœ‰æ³¨å†Œè´¦å·ï¼Œè¯·è·³è¿‡æ­¤æ­¥éª¤ã€‚

   è¿›å…¥é˜¿é‡Œäº‘é¦–é¡µåï¼Œå¦‚æœæ²¡æœ‰é˜¿é‡Œäº‘çš„è´¦æˆ·éœ€è¦å…ˆè¿›è¡Œæ³¨å†Œï¼Œæ‰å¯ä»¥è¿›è¡Œç™»å½•ã€‚ç”±äºæ³¨å†Œè¾ƒä¸ºç®€å•ï¼Œè¯¾ç¨‹å’Œè®²ä¹‰ä¸åœ¨è¿›è¡Œä½“ç°ï¼ˆæ³¨å†Œå¯ä»¥ä½¿ç”¨å¤šç§æ–¹å¼ï¼Œå¦‚æ·˜å®è´¦å·ã€æ”¯ä»˜å®è´¦å·ã€å¾®åšè´¦å·ç­‰...ï¼‰ã€‚éœ€è¦å®åè®¤è¯å’Œæ´»ä½“è®¤è¯ã€‚

2. æ‰“å¼€[äº‘ç›¾å†…å®¹å®‰å…¨äº§å“è¯•ç”¨é¡µé¢](https://promotion.aliyun.com/ntms/act/lvwangdemo.html)ï¼Œå•å‡»**ç«‹å³å¼€é€š**ï¼Œæ­£å¼å¼€é€šæœåŠ¡ã€‚

   ![image-20240305150511674](assets/image-20240305150511674.png)

   å†…å®¹å®‰å…¨æ§åˆ¶å°

   ![image-20240305150559973](assets/image-20240305150559973.png)

3. åœ¨[AccessKeyç®¡ç†é¡µé¢](https://ram.console.aliyun.com/manage/ak)ç®¡ç†æ‚¨çš„AccessKeyIDå’ŒAccessKeySecretã€‚

   ![image-20240305151700036](assets/image-20240305151700036.png)

   ç®¡ç†è‡ªå·±çš„AccessKey,å¯ä»¥æ–°å»ºå’Œåˆ é™¤AccessKey

   ![image-20240305151740208](assets/image-20240305151740208.png)

   æŸ¥çœ‹è‡ªå·±çš„AccessKey

   AccessKeyé»˜è®¤æ˜¯éšè—çš„ï¼Œåªæœ‰ç¬¬ä¸€æ¬¡ç”³è¯·çš„æ—¶å€™å¯ä»¥ä¿å­˜AccessKeyï¼Œå¦¥å–„ä¿ç®¡ã€‚

   ![image-20240305151957990](assets/image-20240305151957990.png)

<br/>

### æ–‡æœ¬æ£€æµ‹

æ–‡æœ¬åƒåœ¾å†…å®¹æ£€æµ‹ï¼š[å¦‚ä½•è°ƒç”¨æ–‡æœ¬æ£€æµ‹æ¥å£è¿›è¡Œæ–‡æœ¬å†…å®¹å®¡æ ¸_å†…å®¹å®‰å…¨(Content Moderation)-é˜¿é‡Œäº‘å¸®åŠ©ä¸­å¿ƒ (aliyun.com)](https://help.aliyun.com/document_detail/70439.html?spm=a2c4g.11186623.6.659.35ac3db3l0wV5k)

![image-20240305152055402](assets/image-20240305152055402.png)

æ–‡æœ¬åƒåœ¾å†…å®¹Java SDK: [å¦‚ä½•ä½¿ç”¨JavaSDKæ–‡æœ¬ååƒåœ¾æ¥å£_å†…å®¹å®‰å…¨(Content Moderation)-é˜¿é‡Œäº‘å¸®åŠ©ä¸­å¿ƒ (aliyun.com)](https://help.aliyun.com/document_detail/53427.html?spm=a2c4g.11186623.6.717.466d7544QbU8Lr)

![image-20240305152209214](assets/image-20240305152209214.png)

<br/>

### å›¾ç‰‡æ£€æµ‹

å›¾ç‰‡åƒåœ¾å†…å®¹æ£€æµ‹ï¼š[è°ƒç”¨å›¾ç‰‡åŒæ­¥æ£€æµ‹æ¥å£/green/image/scanå®¡æ ¸å›¾ç‰‡å†…å®¹_å†…å®¹å®‰å…¨(Content Moderation)-é˜¿é‡Œäº‘å¸®åŠ©ä¸­å¿ƒ (aliyun.com)](https://help.aliyun.com/document_detail/70292.html?spm=a2c4g.11186623.6.616.5d7d1e7f9vDRz4)

![image-20240305152304146](assets/image-20240305152304146.png)

å›¾ç‰‡åƒåœ¾å†…å®¹Java SDK: [å¦‚ä½•ä½¿ç”¨JavaSDKæ¥å£æ£€æµ‹å›¾ç‰‡æ˜¯å¦åŒ…å«é£é™©å†…å®¹_å†…å®¹å®‰å…¨(Content Moderation)-é˜¿é‡Œäº‘å¸®åŠ©ä¸­å¿ƒ (aliyun.com)](https://help.aliyun.com/document_detail/53424.html?spm=a2c4g.11186623.6.715.c8f69b12ey35j4)

![image-20240305152341291](assets/image-20240305152341291.png)

<br/>

### é¡¹ç›®é›†æˆ

::: tip ğŸ’¡ é¡¹ç›®é›†æˆé˜¿é‡Œäº‘å†…å®¹å®‰å…¨æ¥å£æµç¨‹

- å¯¼å…¥å¯¹åº”çš„ä¾èµ–ä¿¡æ¯ï¼Œå‚è€ƒæ¥å£ SDK è¯´æ˜
- æ·»åŠ ä»¥åŠå¯¹åº”çš„å·¥å…·ç±»åˆ° common æ¨¡å—ä¸­å¹¶æ·»åŠ è‡ªåŠ¨é…ç½®
- åœ¨ bootstrap.yml ä¸­æ·»åŠ é˜¿é‡Œäº‘çš„ AK
- åœ¨è‡ªåª’ä½“å¾®æœåŠ¡ä¸­æµ‹è¯•ç±»ä¸­æ³¨å…¥å®¡æ ¸æ–‡æœ¬å’Œå›¾ç‰‡è¿›è¡Œæµ‹è¯•

:::

<br/>

æ‹·è´èµ„æ–™æ–‡ä»¶å¤¹ä¸­çš„ç±»åˆ° common æ¨¡å—ä¸‹é¢ï¼Œå¹¶æ·»åŠ åˆ°è‡ªåŠ¨é…ç½®

![image-20240305203502896](assets/image-20240305203502896.png)

åŒ…æ‹¬äº†GreenImageScanå’ŒGreenTextScanåŠå¯¹åº”çš„å·¥å…·ç±»

```properties
org.springframework.boot.autoconfigure.EnableAutoConfiguration=\
  com.heima.common.exception.ExceptionCatch,\
  com.heima.common.knife4j.Swagger2Configuration, \
  com.heima.common.swagger.SwaggerConfiguration, \
  com.heima.common.aliyun.GreenImageScan, \
  com.heima.common.aliyun.GreenTextScan
```

<br/>

é˜¿é‡Œäº‘ç”³è¯· AccessKeyId å’Œ Secretï¼ˆéœ€è‡ªå·±ç”³è¯·ï¼‰

åœ¨ nacos é…ç½®ä¸­å¿ƒæ·»åŠ ä»¥ä¸‹é…ç½®ï¼šshared-aliyun.yaml

```yaml
aliyun:
  accessKeyId: LTAI5tCWHCcfvqQzu8k2oKmX
  secret: auoKUFsghimbfVQHpy7gtRyBkoR4vc
  #aliyun.scenes=porn,terrorism,ad,qrcode,live,logo
  scenes: terrorism
```

åœ¨ wemedia æœåŠ¡çš„ bootstrap.yml ä¸­æ·»åŠ  shared é…ç½®

```yaml {15}
server:
  port: 51803
spring:
  profiles:
    active: dev
  application:
    name: leadnews-wemedia
  cloud:
    nacos:
      config:
        file-extension: yaml
        shared-configs:
          - data-id: shared-mybatis.yaml
          - data-id: shared-minio.yaml
          - data-id: shared-aliyun.yaml 
```

<br/>

åœ¨è‡ªåª’ä½“å¾®æœåŠ¡ä¸­æµ‹è¯•ç±»ä¸­æ³¨å…¥å®¡æ ¸æ–‡æœ¬å’Œå›¾ç‰‡çš„beanè¿›è¡Œæµ‹è¯•

```java
package com.heima.wemedia;

import com.heima.common.aliyun.GreenImageScan;
import com.heima.common.aliyun.GreenTextScan;
import com.heima.file.service.FileStorageService;
import org.junit.Test;
import org.junit.runner.RunWith;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.test.context.junit4.SpringRunner;

import java.util.Arrays;
import java.util.Map;

@SpringBootTest(classes = WeMediaApplication.class)
@RunWith(SpringRunner.class)
public class AliyunTest {

    @Autowired
    private GreenTextScan greenTextScan;

    @Autowired
    private GreenImageScan greenImageScan;

    @Autowired
    private FileStorageService fileStorageService;

    @Test
    public void testScanText() throws Exception {
        Map map = greenTextScan.greeTextScan("æˆ‘æ˜¯ä¸€ä¸ªå¥½äºº,å†°æ¯’");
        System.out.println(map);
    }

    @Test
    public void testScanImage() throws Exception {
        byte[] bytes = fileStorageService.downLoadFile("http://192.168.200.130:9000/leadnews/2021/04/26/ef3cbe458db249f7bd6fb4339e593e55.jpg");
        Map map = greenImageScan.imageScan(Arrays.asList(bytes));
        System.out.println(map);
    }
}
```



## ä¿å­˜æ–‡ç« 

ä¿å­˜æ–‡ç« æ˜¯å°†è‡ªåª’ä½“çš„æ–‡ç« ä¿å­˜åˆ°åˆ°Appç«¯ã€‚

æ•°æ®æµå‘æ˜¯å°† wm_news ä¿å­˜ä¸º ap_article

![image-20240111193513341](assets/image-20240111193513341.png)

<br/>

### æ•°æ®ç»“æ„

æ–‡ç« åŸºæœ¬ä¿¡æ¯è¡¨ï¼š**ap_article**  

![image-20240302214348071](assets/image-20240302214348071.png)

æ–‡ç« é…ç½®è¡¨ï¼š**ap_article_config**  

![image-20240302214402136](assets/image-20240302214402136.png)

æ–‡ç« å†…å®¹è¡¨ï¼š**ap_article_content** 

![image-20240302214417193](assets/image-20240302214417193.png)

ä¸‰å¼ è¡¨å…³ç³»åˆ†æ

![image-20240302214433076](assets/image-20240302214433076.png)

<br/>

### åˆ†å¸ƒå¼ID

éšç€ä¸šåŠ¡çš„å¢é•¿ï¼Œæ–‡ç« è¡¨å¯èƒ½è¦å ç”¨å¾ˆå¤§çš„ç‰©ç†å­˜å‚¨ç©ºé—´ï¼Œä¸ºäº†è§£å†³è¯¥é—®é¢˜ï¼ŒåæœŸä½¿ç”¨æ•°æ®åº“åˆ†ç‰‡æŠ€æœ¯ã€‚å°†ä¸€ä¸ªæ•°æ®åº“è¿›è¡Œæ‹†åˆ†ï¼Œé€šè¿‡æ•°æ®åº“ä¸­é—´ä»¶è¿æ¥ã€‚å¦‚æœæ•°æ®åº“ä¸­è¯¥è¡¨é€‰ç”¨IDè‡ªå¢ç­–ç•¥ï¼Œåˆ™å¯èƒ½äº§ç”Ÿé‡å¤çš„IDï¼Œæ­¤æ—¶åº”è¯¥ä½¿ç”¨åˆ†å¸ƒå¼IDç”Ÿæˆç­–ç•¥æ¥ç”ŸæˆIDã€‚

![image-20240303140627471](assets/image-20240303140627471.png)

<br/>

**æŠ€æœ¯é€‰å‹**

![image-20240111193531717](assets/image-20240111193531717.png)

<br/>

**é›ªèŠ±ç®—æ³•**

snowflakeæ˜¯Twitterå¼€æºçš„åˆ†å¸ƒå¼IDç”Ÿæˆç®—æ³•ï¼Œç»“æœæ˜¯ä¸€ä¸ªlongå‹çš„IDã€‚å…¶æ ¸å¿ƒæ€æƒ³æ˜¯ï¼šä½¿ç”¨41bitä½œä¸ºæ¯«ç§’æ•°ï¼Œ10bitä½œä¸ºæœºå™¨çš„IDï¼ˆ5ä¸ªbitæ˜¯æ•°æ®ä¸­å¿ƒï¼Œ5ä¸ªbitçš„æœºå™¨IDï¼‰ï¼Œ12bitä½œä¸ºæ¯«ç§’å†…çš„æµæ°´å·ï¼ˆæ„å‘³ç€æ¯ä¸ªèŠ‚ç‚¹åœ¨æ¯æ¯«ç§’å¯ä»¥äº§ç”Ÿ 4096 ä¸ª IDï¼‰ï¼Œæœ€åè¿˜æœ‰ä¸€ä¸ªç¬¦å·ä½ï¼Œæ°¸è¿œæ˜¯0

![image-20240303150040643](assets/image-20240303150040643.png)

æ–‡ç« ç«¯ç›¸å…³çš„è¡¨éƒ½ä½¿ç”¨é›ªèŠ±ç®—æ³•ç”ŸæˆIDï¼ŒåŒ…æ‹¬ ap_articleã€ ap_article_configã€ ap_article_content

<br/>



Mybatis-Pluså·²ç»é›†æˆäº†é›ªèŠ±ç®—æ³•ï¼Œå®Œæˆä»¥ä¸‹ä¸¤æ­¥å³å¯åœ¨é¡¹ç›®ä¸­é›†æˆé›ªèŠ±ç®—æ³•

ç¬¬ä¸€ï¼šåœ¨å®ä½“ç±»ä¸­çš„idä¸ŠåŠ å…¥å¦‚ä¸‹é…ç½®ï¼ŒæŒ‡å®šç±»å‹ä¸º ASSIGN_ID

```java
@TableId(value = "id",type = IdType.ASSIGN_ID)
private Long id;
```

ç¬¬äºŒï¼šåœ¨ application.yml æ–‡ä»¶ä¸­é…ç½®IDç­–ç•¥

```yaml
mybatis-plus:
  mapper-locations: classpath*:mapper/*.xml
  # è®¾ç½®åˆ«ååŒ…æ‰«æè·¯å¾„ï¼Œé€šè¿‡è¯¥å±æ€§å¯ä»¥ç»™åŒ…ä¸­çš„ç±»æ³¨å†Œåˆ«å
  type-aliases-package: com.heima.model.article.pojos
  global-config:
    id-type: assign_id # é»˜è®¤çš„idç­–ç•¥æ˜¯é›ªèŠ±ç®—æ³•id
```

<br/>

### æ€è·¯åˆ†æ

:::tip ğŸ’¡ åœ¨æ–‡ç« å®¡æ ¸æˆåŠŸä»¥åéœ€è¦åœ¨ç”¨æˆ·ç«¯çš„ article åº“ä¸­æ–°å¢æ–‡ç« æ•°æ®

- ä¿å­˜æ–‡ç« ä¿¡æ¯ ap_article
- ä¿å­˜æ–‡ç« é…ç½®ä¿¡æ¯ ap_article_config

- ä¿å­˜æ–‡ç« å†…å®¹ ap_article_content

:::

**æµç¨‹å›¾**

![image-20240303150120014](assets/image-20240303150120014.png)

<br/>

### æ¥å£è¯´æ˜

|          | **è¯´æ˜**             |
| -------- | -------------------- |
| æ¥å£è·¯å¾„ | /api/v1/article/save |
| è¯·æ±‚æ–¹å¼ | POST                 |
| å‚æ•°     | ArticleDto           |
| å“åº”ç»“æœ | ResponseResult       |

ArticleDto

```java
package com.heima.model.article.dtos;

import com.heima.model.article.pojos.ApArticle;
import lombok.Data;

@Data
public class ArticleDto  extends ApArticle {
    /**
     * æ–‡ç« å†…å®¹
     */
    private String content;
}
```

æˆåŠŸï¼š

```json
{
  "code": 200,
  "errorMessage" : "æ“ä½œæˆåŠŸ",
  "data":"1302864436297442242"
}
```

å¤±è´¥ï¼š

```json
{
  "code":501,
  "errorMessage":"å‚æ•°å¤±æ•ˆ",
}
```

```json
{
  "code":501,
  "errorMessage":"æ–‡ç« æ²¡æœ‰æ‰¾åˆ°",
}
```

<br/>

### åŠŸèƒ½å®ç°

:::tip ğŸ”– å®ç°æ­¥éª¤

- åœ¨ heima-leadnews-feign-api ä¸­å®šä¹‰æ¥å£
  - å¯¼å…¥ feign è¿œç¨‹è°ƒç”¨ä¾èµ–æ¥å£
  - å®šä¹‰æ–‡ç« ç«¯çš„è¿œç¨‹æ¥å£
- åœ¨ heima-leadnews-article å®ç° feign æ¥å£
- åœ¨ ApArticleService ä¸­æ–°å¢ä¿å­˜æ–¹æ³•è¿›è¡Œå®ç° 
- Postmanè¿›è¡Œæµ‹è¯•

:::

<br/>

â‘ ï¼šåœ¨heima-leadnews-feign-apiä¸­æ–°å¢æ¥å£

ç¬¬ä¸€ï¼šå¯¼å…¥feignçš„ä¾èµ–

```xml
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-openfeign</artifactId>
</dependency>
```

ç¬¬äºŒï¼šå®šä¹‰æ–‡ç« ç«¯çš„æ¥å£

```java
package com.heima.apis.article;

import com.heima.model.article.dtos.ArticleDto;
import com.heima.model.common.dtos.ResponseResult;
import org.springframework.cloud.openfeign.FeignClient;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;

import java.io.IOException;


@FeignClient(value = "leadnews-article")
public interface IArticleClient {

    @PostMapping("/api/v1/article/save")
    ResponseResult saveArticle(@RequestBody ArticleDto dto);
}
```

<br/>

â‘¡ï¼šåœ¨heima-leadnews-articleä¸­å®ç°è¯¥æ–¹æ³•

```java
package com.heima.article.client;

import com.heima.apis.article.IArticleClient;
import com.heima.article.service.IApArticleService;
import com.heima.model.article.dtos.ArticleDto;
import com.heima.model.common.dtos.ResponseResult;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RestController;

@RestController
public class ArticleClient implements IArticleClient {

    @Autowired
    private IApArticleService apArticleService;

    @Override
    @PostMapping("/api/v1/article/save")
    public ResponseResult saveArticle(@RequestBody ArticleDto dto) {
        return apArticleService.saveArticle(dto);
    }

}
```

åŒæ—¶ï¼Œä¿®æ”¹ApArticleConfigç±»ï¼Œæ·»åŠ å¦‚ä¸‹æ„é€ å‡½æ•°

```java {26-32,34}
package com.heima.model.article.pojos;

import com.baomidou.mybatisplus.annotation.IdType;
import com.baomidou.mybatisplus.annotation.TableField;
import com.baomidou.mybatisplus.annotation.TableId;
import com.baomidou.mybatisplus.annotation.TableName;
import lombok.Data;
import lombok.NoArgsConstructor;

import java.io.Serializable;

/**
 * <p>
 * APPå·²å‘å¸ƒæ–‡ç« é…ç½®è¡¨
 * </p>
 *
 * @author itheima
 */

@Data
@NoArgsConstructor
@TableName("ap_article_config")
public class ApArticleConfig implements Serializable {


    public ApArticleConfig(Long articleId){
        this.articleId = articleId;
        this.isComment = true;
        this.isForward = true;
        this.isDelete = false;
        this.isDown = false;
    }

    @TableId(value = "id",type = IdType.ID_WORKER)
    private Long id;

    /**
     * æ–‡ç« id
     */
    @TableField("article_id")
    private Long articleId;

    /**
     * æ˜¯å¦å¯è¯„è®º
     * true: å¯ä»¥è¯„è®º   1
     * false: ä¸å¯è¯„è®º  0
     */
    @TableField("is_comment")
    private Boolean isComment;

    /**
     * æ˜¯å¦è½¬å‘
     * true: å¯ä»¥è½¬å‘   1
     * false: ä¸å¯è½¬å‘  0
     */
    @TableField("is_forward")
    private Boolean isForward;

    /**
     * æ˜¯å¦ä¸‹æ¶
     * true: ä¸‹æ¶   1
     * false: æ²¡æœ‰ä¸‹æ¶  0
     */
    @TableField("is_down")
    private Boolean isDown;

    /**
     * æ˜¯å¦å·²åˆ é™¤
     * true: åˆ é™¤   1
     * false: æ²¡æœ‰åˆ é™¤  0
     */
    @TableField("is_delete")
    private Boolean isDelete;
}
```

<br/>

â‘£ï¼šåœ¨ApArticleServiceä¸­æ–°å¢æ–¹æ³•

```java
/**
* ä¿å­˜appç«¯ç›¸å…³æ–‡ç« 
* @param dto
* @return
*/
ResponseResult saveArticle(ArticleDto dto) ;
```

å®ç°ç±»ï¼š

```java
@Autowired
private ApArticleConfigMapper apArticleConfigMapper;

@Autowired
private ApArticleContentMapper apArticleContentMapper;

/**
 * ä¿å­˜appç«¯ç›¸å…³æ–‡ç« 
 *
 * @param dto
 * @return
 */
@Override
public ResponseResult saveArticle(ArticleDto dto) {
    //1.æ£€æŸ¥å‚æ•°
    if (dto == null) {
        return ResponseResult.errorResult(AppHttpCodeEnum.PARAM_INVALID);
    }

    ApArticle apArticle = new ApArticle();
    BeanUtils.copyProperties(dto, apArticle);

    //2.åˆ¤æ–­æ˜¯å¦å­˜åœ¨id
    if (dto.getId() == null) {
        //2.1 ä¸å­˜åœ¨id  ä¿å­˜  æ–‡ç«   æ–‡ç« é…ç½®  æ–‡ç« å†…å®¹

        //ä¿å­˜æ–‡ç« 
        save(apArticle);

        //ä¿å­˜é…ç½®
        ApArticleConfig apArticleConfig = new ApArticleConfig(apArticle.getId());
        apArticleConfigMapper.insert(apArticleConfig);

        //ä¿å­˜ æ–‡ç« å†…å®¹
        ApArticleContent apArticleContent = new ApArticleContent();
        apArticleContent.setArticleId(apArticle.getId());
        apArticleContent.setContent(dto.getContent());
        apArticleContentMapper.insert(apArticleContent);

    } else {
        //2.2 å­˜åœ¨id   ä¿®æ”¹  æ–‡ç«   æ–‡ç« å†…å®¹

        //ä¿®æ”¹  æ–‡ç« 
        updateById(apArticle);

        //ä¿®æ”¹æ–‡ç« å†…å®¹
        ApArticleContent apArticleContent = apArticleContentMapper.selectOne(Wrappers.<ApArticleContent>lambdaQuery().eq(ApArticleContent::getArticleId, dto.getId()));
        apArticleContent.setContent(dto.getContent());
        apArticleContentMapper.updateById(apArticleContent);
    }


    //3.ç»“æœè¿”å›  æ–‡ç« çš„id
    return ResponseResult.okResult(apArticle.getId());
}
```

<br/>

### åŠŸèƒ½æµ‹è¯•

ç¼–å†™junitå•å…ƒæµ‹è¯•ï¼Œæˆ–ä½¿ç”¨postmanè¿›è¡Œæµ‹è¯•

```json
{
  "id":1390209114747047938,
  "title":"é»‘é©¬å¤´æ¡é¡¹ç›®èƒŒæ™¯22222222222222",
  "authoId":1102,
  "layout":1,
  "labels":"é»‘é©¬å¤´æ¡",
  "publishTime":"2028-03-14T11:35:49.000Z",
  "images": "http://192.168.200.130:9000/leadnews/2021/04/26/5ddbdb5c68094ce393b08a47860da275.jpg",
  "content":"22222222222222222é»‘é©¬å¤´æ¡é¡¹ç›®èƒŒæ™¯,é»‘é©¬å¤´æ¡é¡¹ç›®èƒŒæ™¯,é»‘é©¬å¤´æ¡é¡¹ç›®èƒŒæ™¯,é»‘é©¬å¤´æ¡é¡¹ç›®èƒŒæ™¯ï¼Œé»‘é©¬å¤´æ¡é¡¹ç›®èƒŒæ™¯"
}
```

<br/>

### Feignæ¥å£

è¿œç¨‹æ¥å£è°ƒç”¨æ–¹å¼

![image-20240303150549660](assets/image-20240303150549660.png)

<br/>

:::tip æ­¥éª¤ï¼šFeignè¿œç¨‹æ¥å£è°ƒç”¨æ–¹å¼

- wemedia å¾®æœåŠ¡ä¾èµ– feign-api
- wemedia å¾®æœåŠ¡çš„å¼•å¯¼ç±»ä¸­å¼€å¯ feign è°ƒç”¨ï¼Œå¹¶æ‰«æåŒ…
- wemedia ä¸­çš„ bean ä¸­æ³¨å…¥ IArticleClient å³å¯å‘èµ·è¿œç¨‹è°ƒç”¨

:::

<br/>

åœ¨ `heima-leadnews-wemedia` æœåŠ¡ä¸­å·²ç»ä¾èµ–äº† `heima-leadnews-feign-apis` å·¥ç¨‹ï¼Œåªéœ€è¦åœ¨è‡ªåª’ä½“çš„å¼•å¯¼ç±»ä¸­å¼€å¯ Feign çš„è¿œç¨‹è°ƒç”¨å³å¯

æ³¨è§£ä¸ºï¼š`@EnableFeignClients(basePackages = "com.heima.apis")` éœ€è¦æŒ‡å‘apisè¿™ä¸ªåŒ…

```java {5}
@Slf4j
@SpringBootApplication
@EnableDiscoveryClient
@MapperScan("com.heima.wemedia.mapper")
@EnableFeignClients(basePackages = "com.heima.apis")
public class WeMediaApplication {
    public static void main(String[] args) {
        SpringApplication.run(WeMediaApplication.class, args);
    }

    @Bean
    public MybatisPlusInterceptor mybatisPlusInterceptor() {
        MybatisPlusInterceptor interceptor = new MybatisPlusInterceptor();
        interceptor.addInnerInterceptor(new PaginationInnerInterceptor(DbType.MYSQL));
        return interceptor;
    }
}

```

<br/>

### æœåŠ¡é™çº§å¤„ç†

![image-20240303150656141](assets/image-20240303150656141.png)

- æœåŠ¡é™çº§æ˜¯æœåŠ¡è‡ªæˆ‘ä¿æŠ¤çš„ä¸€ç§æ–¹å¼ï¼Œæˆ–è€…ä¿æŠ¤ä¸‹æ¸¸æœåŠ¡çš„ä¸€ç§æ–¹å¼ï¼Œç”¨äºç¡®ä¿æœåŠ¡ä¸ä¼šå—è¯·æ±‚çªå¢å½±å“å˜å¾—ä¸å¯ç”¨ï¼Œç¡®ä¿æœåŠ¡ä¸ä¼šå´©æºƒ

- æœåŠ¡é™çº§è™½ç„¶ä¼šå¯¼è‡´è¯·æ±‚å¤±è´¥ï¼Œä½†æ˜¯ä¸ä¼šå¯¼è‡´é˜»å¡ã€‚

<br/>

å®ç°æ­¥éª¤

â‘  åœ¨ `heima-leadnews-feign-api` ç¼–å†™é™çº§é€»è¾‘

```java
package com.heima.apis.article.fallback;

import com.heima.apis.article.IArticleClient;
import com.heima.model.article.dtos.ArticleDto;
import com.heima.model.common.dtos.ResponseResult;
import com.heima.model.common.enums.AppHttpCodeEnum;
import org.springframework.stereotype.Component;

/**
 * feignå¤±è´¥é…ç½®
 * @author itheima
 */
@Component
public class IArticleClientFallback implements IArticleClient {
    @Override
    public ResponseResult saveArticle(ArticleDto dto)  {
        return ResponseResult.errorResult(AppHttpCodeEnum.SERVER_ERROR,"è·å–æ•°æ®å¤±è´¥");
    }
}
```

åœ¨è‡ªåª’ä½“å¾®æœåŠ¡  `heima-leadnews-wemedia `ä¸­æ·»åŠ ç±»ï¼Œæ‰«æé™çº§ä»£ç ç±»çš„åŒ…

```java
package com.heima.wemedia.config;

import org.springframework.context.annotation.ComponentScan;
import org.springframework.context.annotation.Configuration;

@Configuration
@ComponentScan("com.heima.apis.article.fallback")
public class InitConfig {
}
```

<br/>

â‘¡ åœ¨ `heima-leadnews-fegin-api`  çš„è¿œç¨‹æ¥å£ä¸­æŒ‡å‘é™çº§ä»£ç 

```java {10}
package com.heima.apis.article;

import com.heima.apis.article.fallback.IArticleClientFallback;
import com.heima.model.article.dtos.ArticleDto;
import com.heima.model.common.dtos.ResponseResult;
import org.springframework.cloud.openfeign.FeignClient;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;

@FeignClient(value = "leadnews-article",fallback = IArticleClientFallback.class)
public interface IArticleClient {

    @PostMapping("/api/v1/article/save")
    public ResponseResult saveArticle(@RequestBody ArticleDto dto);
}
```

<br/>

â‘¢ å®¢æˆ·ç«¯å¼€å¯é™çº§ `heima-leadnews-wemedia`

åœ¨wemediaçš„nacosé…ç½®ä¸­å¿ƒé‡Œæ·»åŠ å¦‚ä¸‹å†…å®¹ï¼Œå¼€å¯æœåŠ¡é™çº§ï¼Œä¹Ÿå¯ä»¥æŒ‡å®šæœåŠ¡å“åº”çš„è¶…æ—¶çš„æ—¶é—´

```yaml
feign:
  # å¼€å¯feignå¯¹hystrixç†”æ–­é™çº§çš„æ”¯æŒ
  hystrix:
    enabled: true
  # ä¿®æ”¹è°ƒç”¨è¶…æ—¶æ—¶é—´
  client:
    config:
      default:
        connectTimeout: 2000
        readTimeout: 2000
```

<br/>

â‘£æµ‹è¯•ï¼šåœ¨ ApArticleServiceImpl ç±»ä¸­ saveArticle æ–¹æ³•æ·»åŠ ä»£ç 

```java
try {
    Thread.sleep(3000);
} catch (InterruptedException e) {
    e.printStackTrace();
}
```

åœ¨è‡ªåª’ä½“ç«¯è¿›è¡Œå®¡æ ¸æµ‹è¯•ï¼Œä¼šå‡ºç°æœåŠ¡é™çº§çš„ç°è±¡



## è‡ªåŠ¨å®¡æ ¸

è‡ªåŠ¨å®¡æ ¸æ˜¯è‡ªåª’ä½“æ–‡ç« åœ¨ç‚¹å‡»ä¿å­˜åå¯¹å†…å®¹å®‰å…¨è¿›è¡Œæ£€æµ‹

### æ•°æ®ç»“æ„

wm_news è‡ªåª’ä½“æ–‡ç« è¡¨

![image-20210505010728156](assets\image-20210505010728156.png)

Statusï¼š0 è‰ç¨¿  1 å¾…å®¡æ ¸  2 å®¡æ ¸å¤±è´¥  3 äººå·¥å®¡æ ¸  4 äººå·¥å®¡æ ¸é€šè¿‡  8 å®¡æ ¸é€šè¿‡ï¼ˆå¾…å‘å¸ƒï¼‰ 9 å·²å‘å¸ƒ

<br/>

### åŠŸèƒ½å®ç°

![image-20240303150503194](assets/image-20240303150503194.png)

åœ¨ heima-leadnews-wemedia ä¸­çš„ service æ–°å¢æ¥å£

```java
package com.heima.wemedia.service;

public interface WmNewsAutoScanService {

    /**
     * è‡ªåª’ä½“æ–‡ç« å®¡æ ¸
     * @param id  è‡ªåª’ä½“æ–‡ç« id
     */
    public void autoScanWmNews(Integer id);
}
```

å®ç°ç±»ï¼š

```java
package com.heima.wemedia.service.impl;

import com.alibaba.fastjson.JSONArray;
import com.heima.apis.article.IArticleClient;
import com.heima.common.aliyun.GreenImageScan;
import com.heima.common.aliyun.GreenTextScan;
import com.heima.file.service.FileStorageService;
import com.heima.model.article.dtos.ArticleDto;
import com.heima.model.common.dtos.ResponseResult;
import com.heima.model.wemedia.pojos.WmChannel;
import com.heima.model.wemedia.pojos.WmNews;
import com.heima.model.wemedia.pojos.WmUser;
import com.heima.wemedia.mapper.WmChannelMapper;
import com.heima.wemedia.mapper.WmNewsMapper;
import com.heima.wemedia.mapper.WmUserMapper;
import com.heima.wemedia.service.WmNewsAutoScanService;
import io.swagger.models.auth.In;
import lombok.extern.slf4j.Slf4j;
import org.apache.commons.lang3.StringUtils;
import org.springframework.beans.BeanUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.time.LocalDateTime;
import java.util.*;
import java.util.stream.Collectors;


@Service
@Slf4j
@Transactional
public class WmNewsAutoScanServiceImpl implements WmNewsAutoScanService {

    @Autowired
    private WmNewsMapper wmNewsMapper;

    /**
     * è‡ªåª’ä½“æ–‡ç« å®¡æ ¸
     *
     * @param id è‡ªåª’ä½“æ–‡ç« id
     */
    @Override
    public void autoScanWmNews(Integer id) {
        //1.æŸ¥è¯¢è‡ªåª’ä½“æ–‡ç« 
        WmNews wmNews = wmNewsMapper.selectById(id);
        if (wmNews == null) {
            throw new RuntimeException("WmNewsAutoScanServiceImpl-æ–‡ç« ä¸å­˜åœ¨");
        }

        if (wmNews.getStatus().equals(WmNews.Status.SUBMIT.getCode())) {
            //ä»å†…å®¹ä¸­æå–çº¯æ–‡æœ¬å†…å®¹å’Œå›¾ç‰‡
            Map<String, Object> textAndImages = handleTextAndImages(wmNews);

            //2.å®¡æ ¸æ–‡æœ¬å†…å®¹  é˜¿é‡Œäº‘æ¥å£
            boolean isTextScan = handleTextScan((String) textAndImages.get("content"), wmNews);
            if (!isTextScan) return;

            //3.å®¡æ ¸å›¾ç‰‡  é˜¿é‡Œäº‘æ¥å£
            boolean isImageScan = handleImageScan((List<String>) textAndImages.get("images"), wmNews);
            if (!isImageScan) return;

            //4.å®¡æ ¸æˆåŠŸï¼Œä¿å­˜appç«¯çš„ç›¸å…³çš„æ–‡ç« æ•°æ®
            ResponseResult responseResult = saveAppArticle(wmNews);
            if (!responseResult.getCode().equals(200)) {
                throw new RuntimeException("WmNewsAutoScanServiceImpl-æ–‡ç« å®¡æ ¸ï¼Œä¿å­˜appç«¯ç›¸å…³æ–‡ç« æ•°æ®å¤±è´¥");
            }
            //å›å¡«article_id
            wmNews.setArticleId((Long) responseResult.getData());
            updateWmNews(wmNews, 9, "å®¡æ ¸æˆåŠŸ");

        }
    }

    @Autowired
    private IArticleClient articleClient;

    @Autowired
    private WmChannelMapper wmChannelMapper;

    @Autowired
    private WmUserMapper wmUserMapper;

    /**
     * ä¿å­˜appç«¯ç›¸å…³çš„æ–‡ç« æ•°æ®
     *
     * @param wmNews
     */
    private ResponseResult saveAppArticle(WmNews wmNews) {

        ArticleDto dto = new ArticleDto();
        //å±æ€§çš„æ‹·è´
        BeanUtils.copyProperties(wmNews, dto);
        //æ–‡ç« çš„å¸ƒå±€
        dto.setLayout(wmNews.getType());
        //é¢‘é“
        WmChannel wmChannel = wmChannelMapper.selectById(wmNews.getChannelId());
        if (wmChannel != null) {
            dto.setChannelName(wmChannel.getName());
        }

        //ä½œè€…
        dto.setAuthorId(wmNews.getUserId());
        WmUser wmUser = wmUserMapper.selectById(wmNews.getUserId());
        if (wmUser != null) {
            dto.setAuthorName(wmUser.getName());
        }

        //è®¾ç½®æ–‡ç« id
        if (wmNews.getArticleId() != null) {
            dto.setId(wmNews.getArticleId());
        }
        dto.setCreatedTime(LocalDateTime.now());

        ResponseResult responseResult = articleClient.saveArticle(dto);
        return responseResult;

    }


    @Autowired
    private FileStorageService fileStorageService;

    @Autowired
    private GreenImageScan greenImageScan;

    /**
     * å®¡æ ¸å›¾ç‰‡
     *
     * @param images
     * @param wmNews
     * @return
     */
    private boolean handleImageScan(List<String> images, WmNews wmNews) {

        boolean flag = true;

        if (images == null || images.size() == 0) {
            return flag;
        }

        //ä¸‹è½½å›¾ç‰‡ minIO
        //å›¾ç‰‡å»é‡
        images = images.stream().distinct().collect(Collectors.toList());

        List<byte[]> imageList = new ArrayList<>();

        for (String image : images) {
            byte[] bytes = fileStorageService.downLoadFile(image);
            imageList.add(bytes);
        }


        //å®¡æ ¸å›¾ç‰‡
        try {
            Map map = greenImageScan.imageScan(imageList);
            if (map != null) {
                //å®¡æ ¸å¤±è´¥
                if (map.get("suggestion").equals("block")) {
                    flag = false;
                    updateWmNews(wmNews, 2, "å½“å‰æ–‡ç« ä¸­å­˜åœ¨è¿è§„å†…å®¹");
                }

                //ä¸ç¡®å®šä¿¡æ¯  éœ€è¦äººå·¥å®¡æ ¸
                if (map.get("suggestion").equals("review")) {
                    flag = false;
                    updateWmNews(wmNews, 3, "å½“å‰æ–‡ç« ä¸­å­˜åœ¨ä¸ç¡®å®šå†…å®¹");
                }
            }

        } catch (Exception e) {
            flag = false;
            e.printStackTrace();
        }
        return flag;
    }

    @Autowired
    private GreenTextScan greenTextScan;

    /**
     * å®¡æ ¸çº¯æ–‡æœ¬å†…å®¹
     *
     * @param content
     * @param wmNews
     * @return
     */
    private boolean handleTextScan(String content, WmNews wmNews) {

        boolean flag = true;

        if ((wmNews.getTitle() + "-" + content).length() == 0) {
            return flag;
        }

        try {
            Map map = greenTextScan.greeTextScan((wmNews.getTitle() + "-" + content));
            if (map != null) {
                //å®¡æ ¸å¤±è´¥
                if (map.get("suggestion").equals("block")) {
                    flag = false;
                    updateWmNews(wmNews, 2, "å½“å‰æ–‡ç« ä¸­å­˜åœ¨è¿è§„å†…å®¹");
                }

                //ä¸ç¡®å®šä¿¡æ¯  éœ€è¦äººå·¥å®¡æ ¸
                if (map.get("suggestion").equals("review")) {
                    flag = false;
                    updateWmNews(wmNews, 3, "å½“å‰æ–‡ç« ä¸­å­˜åœ¨ä¸ç¡®å®šå†…å®¹");
                }
            }
        } catch (Exception e) {
            flag = false;
            e.printStackTrace();
        }

        return flag;

    }

    /**
     * ä¿®æ”¹æ–‡ç« å†…å®¹
     *
     * @param wmNews
     * @param status
     * @param reason
     */
    private void updateWmNews(WmNews wmNews, Integer status, String reason) {
        wmNews.setStatus(status);
        wmNews.setReason(reason);
        wmNewsMapper.updateById(wmNews);
    }

    /**
     * 1.ä»è‡ªåª’ä½“æ–‡ç« çš„å†…å®¹ä¸­æå–æ–‡æœ¬å’Œå›¾ç‰‡
     * 2.æå–æ–‡ç« çš„å°é¢å›¾ç‰‡
     *
     * @param wmNews
     * @return
     */
    private Map<String, Object> handleTextAndImages(WmNews wmNews) {

        //å­˜å‚¨çº¯æ–‡æœ¬å†…å®¹
        StringBuilder stringBuilder = new StringBuilder();

        List<String> images = new ArrayList<>();

        //1.ä»è‡ªåª’ä½“æ–‡ç« çš„å†…å®¹ä¸­æå–æ–‡æœ¬å’Œå›¾ç‰‡
        if (StringUtils.isNotBlank(wmNews.getContent())) {
            List<Map> maps = JSONArray.parseArray(wmNews.getContent(), Map.class);
            for (Map map : maps) {
                if (map.get("type").equals("text")) {
                    stringBuilder.append(map.get("value"));
                }

                if (map.get("type").equals("image")) {
                    images.add((String) map.get("value"));
                }
            }
        }
        //2.æå–æ–‡ç« çš„å°é¢å›¾ç‰‡
        if (StringUtils.isNotBlank(wmNews.getImages())) {
            String[] split = wmNews.getImages().split(",");
            images.addAll(Arrays.asList(split));
        }

        Map<String, Object> resultMap = new HashMap<>();
        resultMap.put("content", stringBuilder.toString());
        resultMap.put("images", images);
        return resultMap;

    }
}
```

<br/>

### å•å…ƒæµ‹è¯•

```java
package com.heima.wemedia.service;

import com.heima.wemedia.WeMediaApplication;
import org.junit.Test;
import org.junit.runner.RunWith;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.test.context.junit4.SpringRunner;


@SpringBootTest(classes = WeMediaApplication.class)
@RunWith(SpringRunner.class)
public class WmNewsAutoScanServiceTest {

    @Autowired
    private WmNewsAutoScanService wmNewsAutoScanService;

    @Test
    public void autoScanWmNews() {
        wmNewsAutoScanService.autoScanWmNews(6238);
    }
}
```

<br/>

### å®¡æ ¸é›†æˆ

> æ€è€ƒï¼šåŒæ­¥è°ƒç”¨ä¸å¼‚æ­¥è°ƒç”¨çš„åŒºåˆ«

åŒæ­¥ï¼šå°±æ˜¯åœ¨å‘å‡ºä¸€ä¸ªè°ƒç”¨æ—¶ï¼Œåœ¨æ²¡æœ‰å¾—åˆ°ç»“æœä¹‹å‰ï¼Œ è¯¥è°ƒç”¨å°±ä¸è¿”å›ï¼ˆå®æ—¶å¤„ç†ï¼‰

å¼‚æ­¥ï¼šè°ƒç”¨åœ¨å‘å‡ºä¹‹åï¼Œè¿™ä¸ªè°ƒç”¨å°±ç›´æ¥è¿”å›äº†ï¼Œæ²¡æœ‰è¿”å›ç»“æœï¼ˆåˆ†æ—¶å¤„ç†ï¼‰

![image-20240111193657330](assets/image-20240111193657330.png)

<br/>

:::tip ğŸ’¡é›†æˆå¼‚æ­¥çº¿ç¨‹è°ƒç”¨å®ç°æ­¥éª¤

- åœ¨è‡ªåŠ¨å®¡æ ¸çš„æ–¹æ³•ä¸ŠåŠ  `@Async` æ³¨è§£ï¼Œæ ‡æ˜è¦å¼‚æ­¥è°ƒç”¨
- åœ¨æ–‡ç« å‘å¸ƒæˆåŠŸåè°ƒç”¨å®¡æ ¸åœ°æ–¹æ–¹æ³•
- åœ¨è‡ªåª’ä½“å¼•å¯¼ç±»ä¸­ä½¿ç”¨ `@EnableAsync` æ³¨è§£å¼€å¯å¼‚æ­¥è°ƒç”¨

:::

<br/>

åœ¨è‡ªåŠ¨å®¡æ ¸çš„æ–¹æ³•ä¸ŠåŠ ä¸Š@Asyncæ³¨è§£ï¼ˆæ ‡æ˜è¦å¼‚æ­¥è°ƒç”¨ï¼‰

```java {2}
@Override
@Async  //æ ‡æ˜å½“å‰æ–¹æ³•æ˜¯ä¸€ä¸ªå¼‚æ­¥æ–¹æ³•
public void autoScanWmNews(Integer id) {
	//ä»£ç ç•¥
}
```

<br/>

åœ¨æ–‡ç« å‘å¸ƒæˆåŠŸåè°ƒç”¨å®¡æ ¸çš„æ–¹æ³•

```java {16}
@Service
@Slf4j
@Transactional
public class WmNewsServiceImpl extends ServiceImpl<WmNewsMapper, WmNews> implements IWmNewsService {


    @Autowired
    private WmNewsAutoScanService wmNewsAutoScanService;
  
    @Override
    public ResponseResult submitNews(WmNewsDto dto) {

       //éƒ¨åˆ†ä»£ç çœç•¥

        //4.ä¸æ˜¯è‰ç¨¿ï¼Œä¿å­˜æ–‡ç« å°é¢å›¾ç‰‡ä¸ç´ æçš„å…³ç³»ï¼Œå¦‚æœå½“å‰å¸ƒå±€æ˜¯è‡ªåŠ¨ï¼Œéœ€è¦åŒ¹é…å°é¢å›¾ç‰‡
        saveRelativeInfoForCover(dto, wmNews, materials);

        //5.å®¡æ ¸æ–‡ç« 
        wmNewsAutoScanService.autoScanWmNews(wmNews.getId());

        return ResponseResult.okResult(AppHttpCodeEnum.SUCCESS);
    }
}
```

<br/>

åœ¨è‡ªåª’ä½“å¼•å¯¼ç±»ä¸­ä½¿ç”¨@EnableAsyncæ³¨è§£å¼€å¯å¼‚æ­¥è°ƒç”¨

```java {5}
@SpringBootApplication
@EnableDiscoveryClient
@MapperScan("com.heima.wemedia.mapper")
@EnableFeignClients(basePackages = "com.heima.apis")
@EnableAsync  //å¼€å¯å¼‚æ­¥è°ƒç”¨
public class WemediaApplication {

    public static void main(String[] args) {
        SpringApplication.run(WemediaApplication.class,args);
    }

    @Bean
    public MybatisPlusInterceptor mybatisPlusInterceptor() {
        MybatisPlusInterceptor interceptor = new MybatisPlusInterceptor();
        interceptor.addInnerInterceptor(new PaginationInnerInterceptor(DbType.MYSQL));
        return interceptor;
    }
}
```

<br/>

### ç»¼åˆæµ‹è¯•

#### æœåŠ¡å¯åŠ¨åˆ—è¡¨

- nacosæœåŠ¡ç«¯
- articleå¾®æœåŠ¡
- wemediaå¾®æœåŠ¡
- å¯åŠ¨wemediaç½‘å…³å¾®æœåŠ¡
- å¯åŠ¨å‰ç«¯ç³»ç»Ÿwemedia

<br/>

#### æµ‹è¯•æƒ…å†µåˆ—è¡¨

- è‡ªåª’ä½“å‰ç«¯å‘å¸ƒä¸€ç¯‡æ­£å¸¸çš„æ–‡ç« 
  - å®¡æ ¸æˆåŠŸåï¼Œappç«¯çš„articleç›¸å…³æ•°æ®æ˜¯å¦å¯ä»¥æ­£å¸¸ä¿å­˜ï¼Œè‡ªåª’ä½“æ–‡ç« çŠ¶æ€å’Œappç«¯æ–‡ç« idæ˜¯å¦å›æ˜¾

- è‡ªåª’ä½“å‰ç«¯å‘å¸ƒä¸€ç¯‡åŒ…å«æ•æ„Ÿè¯çš„æ–‡ç« 
  - æ­£å¸¸æ˜¯å®¡æ ¸å¤±è´¥ï¼Œ wm_newsè¡¨ä¸­çš„çŠ¶æ€æ˜¯å¦æ”¹å˜ï¼ŒæˆåŠŸå’Œå¤±è´¥åŸå› æ­£å¸¸ä¿å­˜

- è‡ªåª’ä½“å‰ç«¯å‘å¸ƒä¸€ç¯‡åŒ…å«æ•æ„Ÿå›¾ç‰‡çš„æ–‡ç« 
  - æ­£å¸¸æ˜¯å®¡æ ¸å¤±è´¥ï¼Œ wm_newsè¡¨ä¸­çš„çŠ¶æ€æ˜¯å¦æ”¹å˜ï¼ŒæˆåŠŸå’Œå¤±è´¥åŸå› æ­£å¸¸ä¿å­˜




## è‡ªç®¡ç†æ•æ„Ÿè¯

### éœ€æ±‚åˆ†æ

æ–‡ç« å®¡æ ¸åŠŸèƒ½å·²ç»äº¤ä»˜äº†ï¼Œæ–‡ç« ä¹Ÿèƒ½æ­£å¸¸å‘å¸ƒå®¡æ ¸ã€‚çªç„¶ï¼Œäº§å“ç»ç†è¿‡æ¥è¯´è¦å¼€ä¼šã€‚

<br/>

ä¼šè®®çš„å†…å®¹æ ¸å¿ƒæœ‰ä»¥ä¸‹å†…å®¹ï¼š

- æ–‡ç« å®¡æ ¸ä¸èƒ½è¿‡æ»¤ä¸€äº›æ•æ„Ÿè¯ï¼š

  ç§äººä¾¦æ¢ã€é’ˆå­”æ‘„è±¡ã€ä¿¡ç”¨å¡æç°ã€å¹¿å‘Šä»£ç†ã€ä»£å¼€å‘ç¥¨ã€åˆ»ç« åŠã€å‡ºå”®ç­”æ¡ˆã€å°é¢è´·æ¬¾â€¦

<br/>

éœ€è¦å®Œæˆçš„åŠŸèƒ½ï¼š

- éœ€è¦è‡ªå·±ç»´æŠ¤ä¸€å¥—æ•æ„Ÿè¯ï¼Œåœ¨æ–‡ç« å®¡æ ¸çš„æ—¶å€™ï¼Œéœ€è¦éªŒè¯æ–‡ç« æ˜¯å¦åŒ…å«è¿™äº›æ•æ„Ÿè¯

<br/>

**æ•æ„Ÿè¯è¿‡æ»¤æŠ€æœ¯é€‰å‹**

![image-20240111193733503](assets/image-20240111193733503.png)

<br/>

### DFAå®ç°åŸç†

DFAå…¨ç§°ä¸ºï¼šDeterministic Finite Automatonï¼Œå³ç¡®å®šæœ‰ç©·è‡ªåŠ¨æœºã€‚

å­˜å‚¨ï¼šä¸€æ¬¡æ€§çš„æŠŠæ‰€æœ‰çš„æ•æ„Ÿè¯å­˜å‚¨åˆ°äº†å¤šä¸ªmapä¸­ï¼Œå°±æ˜¯ä¸‹å›¾è¡¨ç¤ºè¿™ç§ç»“æ„

æ•æ„Ÿè¯ï¼šå†°æ¯’ã€å¤§éº»ã€å¤§åè›‹

![image-20240303150837429](assets/image-20240303150837429.png)

<br/>

**æ£€ç´¢çš„è¿‡ç¨‹**

![image-20240303150858320](assets/image-20240303150858320.png)

<br/>

### åŠŸèƒ½é›†æˆ

è‡ªç®¡ç†æ•æ„Ÿè¯é›†æˆåˆ°æ–‡ç« å®¡æ ¸ä¸­

åˆ›å»ºæ•æ„Ÿè¯è¡¨ï¼Œå¯¼å…¥èµ„æ–™ä¸­wm_sensitiveåˆ°leadnews_wemediaåº“ä¸­

![image-20210524160611338](assets\image-20210524160611338.png)

<br/>

åœ¨æ–‡ç« å®¡æ ¸çš„ä»£ç ä¸­æ·»åŠ è‡ªç®¡ç†æ•æ„Ÿè¯å®¡æ ¸

ç¬¬ä¸€ï¼šåœ¨ WmNewsAutoScanServiceImpl ä¸­çš„ autoScanWmNews æ–¹æ³•ä¸Šæ·»åŠ å¦‚ä¸‹ä»£ç 

```java {27-29,51-79}
@Service
@Slf4j
@Transactional
public class WmNewsAutoScanServiceImpl implements WmNewsAutoScanService {

    @Autowired
    private WmNewsMapper wmNewsMapper;

    /**
     * è‡ªåª’ä½“æ–‡ç« å®¡æ ¸
     *
     * @param id è‡ªåª’ä½“æ–‡ç« id
     */
    @Override
    @Async
    public void autoScanWmNews(Integer id) {
        //1.æŸ¥è¯¢è‡ªåª’ä½“æ–‡ç« 
        WmNews wmNews = wmNewsMapper.selectById(id);
        if (wmNews == null) {
            throw new RuntimeException("WmNewsAutoScanServiceImpl-æ–‡ç« ä¸å­˜åœ¨");
        }

        if (wmNews.getStatus().equals(WmNews.Status.SUBMIT.getCode())) {
            //ä»å†…å®¹ä¸­æå–çº¯æ–‡æœ¬å†…å®¹å’Œå›¾ç‰‡
            Map<String, Object> textAndImages = handleTextAndImages(wmNews);

            // è‡ªç®¡ç†çš„æ•æ„Ÿè¯è¿‡æ»¤
            boolean isSensitive = handleSensitiveScan((String) textAndImages.get("content"), wmNews);
            if(!isSensitive) return;
            
            //2.å®¡æ ¸æ–‡æœ¬å†…å®¹  é˜¿é‡Œäº‘æ¥å£
            boolean isTextScan = handleTextScan((String) textAndImages.get("content"), wmNews);
            if (!isTextScan) return;

            //3.å®¡æ ¸å›¾ç‰‡  é˜¿é‡Œäº‘æ¥å£
            boolean isImageScan = handleImageScan((List<String>) textAndImages.get("images"), wmNews);
            if (!isImageScan) return;

            //4.å®¡æ ¸æˆåŠŸï¼Œä¿å­˜appç«¯çš„ç›¸å…³çš„æ–‡ç« æ•°æ®
            ResponseResult responseResult = saveAppArticle(wmNews);
            if (!responseResult.getCode().equals(200)) {
                throw new RuntimeException("WmNewsAutoScanServiceImpl-æ–‡ç« å®¡æ ¸ï¼Œä¿å­˜appç«¯ç›¸å…³æ–‡ç« æ•°æ®å¤±è´¥");
            }
            //å›å¡«article_id
            wmNews.setArticleId((Long) responseResult.getData());
            updateWmNews(wmNews, 9, "å®¡æ ¸æˆåŠŸ");

        }
    }

    @Autowired
    private WmSensitiveMapper wmSensitiveMapper;

    /**
     * è‡ªç®¡ç†çš„æ•æ„Ÿè¯å®¡æ ¸
     * @param content
     * @param wmNews
     * @return
     */
    private boolean handleSensitiveScan(String content, WmNews wmNews) {

        boolean flag = true;

        //è·å–æ‰€æœ‰çš„æ•æ„Ÿè¯
        List<WmSensitive> wmSensitives = wmSensitiveMapper.selectList(Wrappers.<WmSensitive>lambdaQuery().select(WmSensitive::getSensitives));
        List<String> sensitiveList = wmSensitives.stream().map(WmSensitive::getSensitives).collect(Collectors.toList());

        //åˆå§‹åŒ–æ•æ„Ÿè¯åº“
        SensitiveWordUtil.initMap(sensitiveList);

        //æŸ¥çœ‹æ–‡ç« ä¸­æ˜¯å¦åŒ…å«æ•æ„Ÿè¯
        Map<String, Integer> map = SensitiveWordUtil.matchWords(content);
        if(map.size() >0){
            updateWmNews(wmNews,2,"å½“å‰æ–‡ç« ä¸­å­˜åœ¨è¿è§„å†…å®¹"+map);
            flag = false;
        }

        return flag;
    }
}
```



## å›¾ç‰‡è¯†åˆ«æ–‡å­—

### éœ€æ±‚åˆ†æ

äº§å“ç»ç†å¬é›†å¼€ä¼šï¼Œæ–‡ç« å®¡æ ¸åŠŸèƒ½å·²ç»äº¤ä»˜äº†ï¼Œæ–‡ç« ä¹Ÿèƒ½æ­£å¸¸å‘å¸ƒå®¡æ ¸ã€‚å¯¹äºä¸Šæ¬¡æå‡ºçš„è‡ªç®¡ç†æ•æ„Ÿè¯ä¹Ÿå¾ˆæ»¡æ„ï¼Œè¿™æ¬¡ä¼šè®®æ ¸å¿ƒçš„å†…å®¹å¦‚ä¸‹ï¼š

- æ–‡ç« ä¸­åŒ…å«çš„å›¾ç‰‡è¦è¯†åˆ«æ–‡å­—ï¼Œè¿‡æ»¤æ‰å›¾ç‰‡æ–‡å­—çš„æ•æ„Ÿè¯

![image-20240303150925192](assets/image-20240303150925192.png)



<br/>

### å›¾ç‰‡æ–‡å­—è¯†åˆ«

> æ€è€ƒï¼šä»€ä¹ˆæ˜¯OCR?
>

OCR ï¼ˆOptical Character Recognitionï¼Œå…‰å­¦å­—ç¬¦è¯†åˆ«ï¼‰æ˜¯æŒ‡ç”µå­è®¾å¤‡ï¼ˆä¾‹å¦‚æ‰«æä»ªæˆ–æ•°ç ç›¸æœºï¼‰æ£€æŸ¥çº¸ä¸Šæ‰“å°çš„å­—ç¬¦ï¼Œé€šè¿‡æ£€æµ‹æš—ã€äº®çš„æ¨¡å¼ç¡®å®šå…¶å½¢çŠ¶ï¼Œç„¶åç”¨å­—ç¬¦è¯†åˆ«æ–¹æ³•å°†å½¢çŠ¶ç¿»è¯‘æˆè®¡ç®—æœºæ–‡å­—çš„è¿‡ç¨‹ã€‚

![image-20240111193833766](assets/image-20240111193833766.png)

Tesseract-OCR ç‰¹ç‚¹ï¼š

- Tesseractæ”¯æŒUTF-8ç¼–ç æ ¼å¼ï¼Œå¹¶ä¸”å¯ä»¥â€œå¼€ç®±å³ç”¨â€åœ°è¯†åˆ«100å¤šç§è¯­è¨€ã€‚
- Tesseractæ”¯æŒå¤šç§è¾“å‡ºæ ¼å¼ï¼šçº¯æ–‡æœ¬ï¼ŒhOCRï¼ˆHTMLï¼‰ï¼ŒPDFç­‰
- å®˜æ–¹å»ºè®®ï¼Œä¸ºäº†è·å¾—æ›´å¥½çš„OCRç»“æœï¼Œæœ€å¥½æä¾›ç»™é«˜è´¨é‡çš„å›¾åƒã€‚
- Tesseractè¿›è¡Œè¯†åˆ«å…¶ä»–è¯­è¨€çš„è®­ç»ƒå…·ä½“çš„è®­ç»ƒæ–¹å¼
  - è¯·å‚è€ƒå®˜æ–¹æä¾›çš„æ–‡æ¡£ï¼šhttps://tesseract-ocr.github.io/tessdoc/


<br/>

### Tess4jæ¡ˆä¾‹

â‘ åˆ›å»ºé¡¹ç›®å¯¼å…¥tess4jå¯¹åº”çš„ä¾èµ–

[1. MacOSå®‰è£…ä½¿ç”¨Tesseract-OCRè¿›è¡Œå›¾æ–‡è¯†åˆ« - çŸ¥ä¹ (zhihu.com)](https://zhuanlan.zhihu.com/p/146044810)

```xml
<dependency>
    <groupId>net.sourceforge.tess4j</groupId>
    <artifactId>tess4j</artifactId>
    <version>4.3.0</version>
</dependency>
```

<br/>

â‘¡å¯¼å…¥ä¸­æ–‡å­—ä½“åº“ï¼Œ æŠŠèµ„æ–™ä¸­çš„tessdataæ–‡ä»¶å¤¹æ‹·è´åˆ°è‡ªå·±çš„å·¥ä½œç©ºé—´ä¸‹

```sh
chi_sim.traineddata
```

<br/>

â‘¢ç¼–å†™æµ‹è¯•ç±»è¿›è¡Œæµ‹è¯•

```java
package com.heima.tess4j;

import net.sourceforge.tess4j.ITesseract;
import net.sourceforge.tess4j.Tesseract;

import java.io.File;

public class Application {

    public static void main(String[] args) {
        try {
            //è·å–æœ¬åœ°å›¾ç‰‡
            File file = new File("D:\\26.png");
            //åˆ›å»ºTesseractå¯¹è±¡
            ITesseract tesseract = new Tesseract();
            //è®¾ç½®å­—ä½“åº“è·¯å¾„
            tesseract.setDatapath("D:\\workspace\\tessdata");
            //ä¸­æ–‡è¯†åˆ«
            tesseract.setLanguage("chi_sim");
            //æ‰§è¡Œocrè¯†åˆ«
            String result = tesseract.doOCR(file);
            //æ›¿æ¢å›è½¦å’Œtalé”®  ä½¿ç»“æœä¸ºä¸€è¡Œ
            result = result.replaceAll("\\r|\\n","-").replaceAll(" ","");
            System.out.println("è¯†åˆ«çš„ç»“æœä¸ºï¼š"+result);
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}
```

<br/>

### åŠŸèƒ½é›†æˆ

ç®¡ç†æ•æ„Ÿè¯å’Œå›¾ç‰‡æ–‡å­—è¯†åˆ«é›†æˆåˆ°æ–‡ç« å®¡æ ¸

<br/>

â‘ åœ¨ heima-leadnews-common ä¸­åˆ›å»ºå·¥å…·ç±»ï¼Œç®€å•å°è£…ä¸€ä¸‹ tess4j

éœ€è¦å…ˆå¯¼å…¥pom

```xml
<dependency>
    <groupId>net.sourceforge.tess4j</groupId>
    <artifactId>tess4j</artifactId>
    <version>4.1.1</version>
</dependency>
```

å·¥å…·ç±»

```java
package com.heima.common.tess4j;

import lombok.Getter;
import lombok.Setter;
import net.sourceforge.tess4j.ITesseract;
import net.sourceforge.tess4j.Tesseract;
import net.sourceforge.tess4j.TesseractException;
import org.springframework.boot.context.properties.ConfigurationProperties;
import org.springframework.stereotype.Component;

import java.awt.image.BufferedImage;

@Getter
@Setter
@Component
@ConfigurationProperties(prefix = "tess4j")
public class Tess4jClient {

    private String dataPath;
    private String language;

    public String doOCR(BufferedImage image) throws TesseractException {
        //åˆ›å»ºTesseractå¯¹è±¡
        ITesseract tesseract = new Tesseract();
        //è®¾ç½®å­—ä½“åº“è·¯å¾„
        tesseract.setDatapath(dataPath);
        //ä¸­æ–‡è¯†åˆ«
        tesseract.setLanguage(language);
        //æ‰§è¡Œocrè¯†åˆ«
        String result = tesseract.doOCR(image);
        //æ›¿æ¢å›è½¦å’Œtalé”®  ä½¿ç»“æœä¸ºä¸€è¡Œ
        result = result.replaceAll("\\r|\\n", "-").replaceAll(" ", "");
        return result;
    }

}
```

åœ¨spring.factoriesé…ç½®ä¸­æ·»åŠ è¯¥ç±»,å®Œæ•´å¦‚ä¸‹ï¼š

```properties
org.springframework.boot.autoconfigure.EnableAutoConfiguration=\
  com.heima.common.exception.ExceptionCatch,\
  com.heima.common.swagger.SwaggerConfiguration,\
  com.heima.common.swagger.Swagger2Configuration,\
  com.heima.common.aliyun.GreenTextScan,\
  com.heima.common.aliyun.GreenImageScan,\
  com.heima.common.tess4j.Tess4jClient
```

<br/>

â‘¡åœ¨ `heima-leadnews-wemedia` ä¸­çš„é…ç½®ä¸­æ·»åŠ ä¸¤ä¸ªå±æ€§

```yaml
tess4j:
  data-path: D:\workspace\tessdata
  language: chi_sim
```

<br/>

â‘¢åœ¨ WmNewsAutoScanServiceImpl ä¸­çš„ handleImageScan æ–¹æ³•ä¸Šæ·»åŠ å¦‚ä¸‹ä»£ç 

```java
try {
    for (String image : images) {
        byte[] bytes = fileStorageService.downLoadFile(image);

        //å›¾ç‰‡è¯†åˆ«æ–‡å­—å®¡æ ¸---begin-----

        //ä»byte[]è½¬æ¢ä¸ºbutteredImage
        ByteArrayInputStream in = new ByteArrayInputStream(bytes);
        BufferedImage imageFile = ImageIO.read(in);
        //è¯†åˆ«å›¾ç‰‡çš„æ–‡å­—
        String result = tess4jClient.doOCR(imageFile);

        //å®¡æ ¸æ˜¯å¦åŒ…å«è‡ªç®¡ç†çš„æ•æ„Ÿè¯
        boolean isSensitive = handleSensitiveScan(result, wmNews);
        if(!isSensitive){
            return isSensitive;
        }

        //å›¾ç‰‡è¯†åˆ«æ–‡å­—å®¡æ ¸---end-----


        imageList.add(bytes);

    } 
}catch (Exception e){
    e.printStackTrace();
}
```

æœ€åé™„ä¸Šæ–‡ç« å®¡æ ¸çš„å®Œæ•´ä»£ç å¦‚ä¸‹ï¼š

```java
package com.heima.wemedia.service.impl;

import com.alibaba.fastjson.JSONArray;
import com.baomidou.mybatisplus.core.toolkit.Wrappers;
import com.heima.apis.article.IArticleClient;
import com.heima.common.aliyun.GreenImageScan;
import com.heima.common.aliyun.GreenTextScan;
import com.heima.common.tess4j.Tess4jClient;
import com.heima.file.service.FileStorageService;
import com.heima.model.article.dtos.ArticleDto;
import com.heima.model.common.dtos.ResponseResult;
import com.heima.model.wemedia.pojos.WmChannel;
import com.heima.model.wemedia.pojos.WmNews;
import com.heima.model.wemedia.pojos.WmSensitive;
import com.heima.model.wemedia.pojos.WmUser;
import com.heima.utils.common.SensitiveWordUtil;
import com.heima.wemedia.mapper.WmChannelMapper;
import com.heima.wemedia.mapper.WmNewsMapper;
import com.heima.wemedia.mapper.WmSensitiveMapper;
import com.heima.wemedia.mapper.WmUserMapper;
import com.heima.wemedia.service.WmNewsAutoScanService;
import lombok.extern.slf4j.Slf4j;
import org.apache.commons.lang3.StringUtils;
import org.springframework.beans.BeanUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.scheduling.annotation.Async;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import javax.imageio.ImageIO;
import java.awt.image.BufferedImage;
import java.io.ByteArrayInputStream;
import java.util.*;
import java.util.stream.Collectors;


@Service
@Slf4j
@Transactional
public class WmNewsAutoScanServiceImpl implements WmNewsAutoScanService {

    @Autowired
    private WmNewsMapper wmNewsMapper;

    /**
     * è‡ªåª’ä½“æ–‡ç« å®¡æ ¸
     *
     * @param id è‡ªåª’ä½“æ–‡ç« id
     */
    @Override
    @Async  //æ ‡æ˜å½“å‰æ–¹æ³•æ˜¯ä¸€ä¸ªå¼‚æ­¥æ–¹æ³•
    public void autoScanWmNews(Integer id) {

//        int a = 1/0;

        //1.æŸ¥è¯¢è‡ªåª’ä½“æ–‡ç« 
        WmNews wmNews = wmNewsMapper.selectById(id);
        if (wmNews == null) {
            throw new RuntimeException("WmNewsAutoScanServiceImpl-æ–‡ç« ä¸å­˜åœ¨");
        }

        if (wmNews.getStatus().equals(WmNews.Status.SUBMIT.getCode())) {
            //ä»å†…å®¹ä¸­æå–çº¯æ–‡æœ¬å†…å®¹å’Œå›¾ç‰‡
            Map<String, Object> textAndImages = handleTextAndImages(wmNews);

            //è‡ªç®¡ç†çš„æ•æ„Ÿè¯è¿‡æ»¤
            boolean isSensitive = handleSensitiveScan((String) textAndImages.get("content"), wmNews);
            if(!isSensitive) return;

            //2.å®¡æ ¸æ–‡æœ¬å†…å®¹  é˜¿é‡Œäº‘æ¥å£
            boolean isTextScan = handleTextScan((String) textAndImages.get("content"), wmNews);
            if (!isTextScan) return;

            //3.å®¡æ ¸å›¾ç‰‡  é˜¿é‡Œäº‘æ¥å£
            boolean isImageScan = handleImageScan((List<String>) textAndImages.get("images"), wmNews);
            if (!isImageScan) return;

            //4.å®¡æ ¸æˆåŠŸï¼Œä¿å­˜appç«¯çš„ç›¸å…³çš„æ–‡ç« æ•°æ®
            ResponseResult responseResult = saveAppArticle(wmNews);
            if (!responseResult.getCode().equals(200)) {
                throw new RuntimeException("WmNewsAutoScanServiceImpl-æ–‡ç« å®¡æ ¸ï¼Œä¿å­˜appç«¯ç›¸å…³æ–‡ç« æ•°æ®å¤±è´¥");
            }
            //å›å¡«article_id
            wmNews.setArticleId((Long) responseResult.getData());
            updateWmNews(wmNews, (short) 9, "å®¡æ ¸æˆåŠŸ");

        }
    }

    @Autowired
    private WmSensitiveMapper wmSensitiveMapper;

    /**
     * è‡ªç®¡ç†çš„æ•æ„Ÿè¯å®¡æ ¸
     * @param content
     * @param wmNews
     * @return
     */
    private boolean handleSensitiveScan(String content, WmNews wmNews) {

        boolean flag = true;

        //è·å–æ‰€æœ‰çš„æ•æ„Ÿè¯
        List<WmSensitive> wmSensitives = wmSensitiveMapper.selectList(Wrappers.<WmSensitive>lambdaQuery().select(WmSensitive::getSensitives));
        List<String> sensitiveList = wmSensitives.stream().map(WmSensitive::getSensitives).collect(Collectors.toList());

        //åˆå§‹åŒ–æ•æ„Ÿè¯åº“
        SensitiveWordUtil.initMap(sensitiveList);

        //æŸ¥çœ‹æ–‡ç« ä¸­æ˜¯å¦åŒ…å«æ•æ„Ÿè¯
        Map<String, Integer> map = SensitiveWordUtil.matchWords(content);
        if(map.size() >0){
            updateWmNews(wmNews,(short) 2,"å½“å‰æ–‡ç« ä¸­å­˜åœ¨è¿è§„å†…å®¹"+map);
            flag = false;
        }

        return flag;
    }

    @Autowired
    private IArticleClient articleClient;

    @Autowired
    private WmChannelMapper wmChannelMapper;

    @Autowired
    private WmUserMapper wmUserMapper;

    /**
     * ä¿å­˜appç«¯ç›¸å…³çš„æ–‡ç« æ•°æ®
     *
     * @param wmNews
     */
    private ResponseResult saveAppArticle(WmNews wmNews) {

        ArticleDto dto = new ArticleDto();
        //å±æ€§çš„æ‹·è´
        BeanUtils.copyProperties(wmNews, dto);
        //æ–‡ç« çš„å¸ƒå±€
        dto.setLayout(wmNews.getType());
        //é¢‘é“
        WmChannel wmChannel = wmChannelMapper.selectById(wmNews.getChannelId());
        if (wmChannel != null) {
            dto.setChannelName(wmChannel.getName());
        }

        //ä½œè€…
        dto.setAuthorId(wmNews.getUserId().longValue());
        WmUser wmUser = wmUserMapper.selectById(wmNews.getUserId());
        if (wmUser != null) {
            dto.setAuthorName(wmUser.getName());
        }

        //è®¾ç½®æ–‡ç« id
        if (wmNews.getArticleId() != null) {
            dto.setId(wmNews.getArticleId());
        }
        dto.setCreatedTime(new Date());

        ResponseResult responseResult = articleClient.saveArticle(dto);
        return responseResult;

    }


    @Autowired
    private FileStorageService fileStorageService;

    @Autowired
    private GreenImageScan greenImageScan;

    @Autowired
    private Tess4jClient tess4jClient;

    /**
     * å®¡æ ¸å›¾ç‰‡
     *
     * @param images
     * @param wmNews
     * @return
     */
    private boolean handleImageScan(List<String> images, WmNews wmNews) {

        boolean flag = true;

        if (images == null || images.size() == 0) {
            return flag;
        }

        //ä¸‹è½½å›¾ç‰‡ minIO
        //å›¾ç‰‡å»é‡
        images = images.stream().distinct().collect(Collectors.toList());

        List<byte[]> imageList = new ArrayList<>();

        try {
            for (String image : images) {
                byte[] bytes = fileStorageService.downLoadFile(image);

                //å›¾ç‰‡è¯†åˆ«æ–‡å­—å®¡æ ¸---begin-----

                //ä»byte[]è½¬æ¢ä¸ºbutteredImage
                ByteArrayInputStream in = new ByteArrayInputStream(bytes);
                BufferedImage imageFile = ImageIO.read(in);
                //è¯†åˆ«å›¾ç‰‡çš„æ–‡å­—
                String result = tess4jClient.doOCR(imageFile);

                //å®¡æ ¸æ˜¯å¦åŒ…å«è‡ªç®¡ç†çš„æ•æ„Ÿè¯
                boolean isSensitive = handleSensitiveScan(result, wmNews);
                if(!isSensitive){
                    return isSensitive;
                }

                //å›¾ç‰‡è¯†åˆ«æ–‡å­—å®¡æ ¸---end-----


                imageList.add(bytes);

            }
        }catch (Exception e){
            e.printStackTrace();
        }


        //å®¡æ ¸å›¾ç‰‡
        try {
            Map map = greenImageScan.imageScan(imageList);
            if (map != null) {
                //å®¡æ ¸å¤±è´¥
                if (map.get("suggestion").equals("block")) {
                    flag = false;
                    updateWmNews(wmNews, (short) 2, "å½“å‰æ–‡ç« ä¸­å­˜åœ¨è¿è§„å†…å®¹");
                }

                //ä¸ç¡®å®šä¿¡æ¯  éœ€è¦äººå·¥å®¡æ ¸
                if (map.get("suggestion").equals("review")) {
                    flag = false;
                    updateWmNews(wmNews, (short) 3, "å½“å‰æ–‡ç« ä¸­å­˜åœ¨ä¸ç¡®å®šå†…å®¹");
                }
            }

        } catch (Exception e) {
            flag = false;
            e.printStackTrace();
        }
        return flag;
    }

    @Autowired
    private GreenTextScan greenTextScan;

    /**
     * å®¡æ ¸çº¯æ–‡æœ¬å†…å®¹
     *
     * @param content
     * @param wmNews
     * @return
     */
    private boolean handleTextScan(String content, WmNews wmNews) {

        boolean flag = true;

        if ((wmNews.getTitle() + "-" + content).length() == 0) {
            return flag;
        }
        try {
            Map map = greenTextScan.greeTextScan((wmNews.getTitle() + "-" + content));
            if (map != null) {
                //å®¡æ ¸å¤±è´¥
                if (map.get("suggestion").equals("block")) {
                    flag = false;
                    updateWmNews(wmNews, (short) 2, "å½“å‰æ–‡ç« ä¸­å­˜åœ¨è¿è§„å†…å®¹");
                }

                //ä¸ç¡®å®šä¿¡æ¯  éœ€è¦äººå·¥å®¡æ ¸
                if (map.get("suggestion").equals("review")) {
                    flag = false;
                    updateWmNews(wmNews, (short) 3, "å½“å‰æ–‡ç« ä¸­å­˜åœ¨ä¸ç¡®å®šå†…å®¹");
                }
            }
        } catch (Exception e) {
            flag = false;
            e.printStackTrace();
        }

        return flag;

    }

    /**
     * ä¿®æ”¹æ–‡ç« å†…å®¹
     *
     * @param wmNews
     * @param status
     * @param reason
     */
    private void updateWmNews(WmNews wmNews, short status, String reason) {
        wmNews.setStatus(status);
        wmNews.setReason(reason);
        wmNewsMapper.updateById(wmNews);
    }

    /**
     * 1ã€‚ä»è‡ªåª’ä½“æ–‡ç« çš„å†…å®¹ä¸­æå–æ–‡æœ¬å’Œå›¾ç‰‡
     * 2.æå–æ–‡ç« çš„å°é¢å›¾ç‰‡
     *
     * @param wmNews
     * @return
     */
    private Map<String, Object> handleTextAndImages(WmNews wmNews) {

        //å­˜å‚¨çº¯æ–‡æœ¬å†…å®¹
        StringBuilder stringBuilder = new StringBuilder();

        List<String> images = new ArrayList<>();

        //1ã€‚ä»è‡ªåª’ä½“æ–‡ç« çš„å†…å®¹ä¸­æå–æ–‡æœ¬å’Œå›¾ç‰‡
        if (StringUtils.isNotBlank(wmNews.getContent())) {
            List<Map> maps = JSONArray.parseArray(wmNews.getContent(), Map.class);
            for (Map map : maps) {
                if (map.get("type").equals("text")) {
                    stringBuilder.append(map.get("value"));
                }

                if (map.get("type").equals("image")) {
                    images.add((String) map.get("value"));
                }
            }
        }
        //2.æå–æ–‡ç« çš„å°é¢å›¾ç‰‡
        if (StringUtils.isNotBlank(wmNews.getImages())) {
            String[] split = wmNews.getImages().split(",");
            images.addAll(Arrays.asList(split));
        }

        Map<String, Object> resultMap = new HashMap<>();
        resultMap.put("content", stringBuilder.toString());
        resultMap.put("images", images);
        return resultMap;

    }
}
```



## æ–‡ç« è¯¦æƒ…

### æ€è·¯åˆ†æ

æ–‡ç« ç«¯åˆ›å»ºappç›¸å…³æ–‡ç« æ—¶ï¼Œç”Ÿæˆæ–‡ç« è¯¦æƒ…é™æ€é¡µä¸Šä¼ åˆ°MinIOä¸­

![image-20240303151009469](assets/image-20240303151009469.png)

<br/>

### å®ç°æ­¥éª¤

1.æ–°å»º `ArticleFreemarkerService` åˆ›å»ºé™æ€æ–‡ä»¶å¹¶ä¸Šä¼ åˆ° `Minio`ä¸­

```java
package com.heima.article.service;

import com.heima.model.article.pojos.ApArticle;

public interface ArticleFreemarkerService {

    /**
     * ç”Ÿæˆé™æ€æ–‡ä»¶ä¸Šä¼ åˆ°minIOä¸­
     * @param apArticle
     * @param content
     */
    public void buildArticleToMinIO(ApArticle apArticle,String content);
}
```

å®ç°

```java
package com.heima.article.service.impl;

import com.alibaba.fastjson.JSONArray;
import com.baomidou.mybatisplus.core.toolkit.Wrappers;
import com.heima.article.mapper.ApArticleContentMapper;
import com.heima.article.service.ArticleFreemarkerService;
import com.heima.article.service.IApArticleService;
import com.heima.file.service.FileStorageService;
import com.heima.model.article.pojos.ApArticle;
import freemarker.template.Configuration;
import freemarker.template.Template;
import lombok.extern.slf4j.Slf4j;
import org.apache.commons.lang3.StringUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.scheduling.annotation.Async;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.io.ByteArrayInputStream;
import java.io.InputStream;
import java.io.StringWriter;
import java.util.HashMap;
import java.util.Map;

@Service
@Slf4j
@Transactional
public class ArticleFreemarkerServiceImpl implements ArticleFreemarkerService {

    @Autowired
    private ApArticleContentMapper apArticleContentMapper;

    @Autowired
    private Configuration configuration;

    @Autowired
    private FileStorageService fileStorageService;

    @Autowired
    private IApArticleService apArticleService;

    /**
     * ç”Ÿæˆé™æ€æ–‡ä»¶ä¸Šä¼ åˆ°minIOä¸­
     * @param apArticle
     * @param content
     */
    @Async
    @Override
    public void buildArticleToMinIO(ApArticle apArticle, String content) {
        //å·²çŸ¥æ–‡ç« çš„id
        //4.1 è·å–æ–‡ç« å†…å®¹
        if(StringUtils.isNotBlank(content)){
            //4.2 æ–‡ç« å†…å®¹é€šè¿‡freemarkerç”Ÿæˆhtmlæ–‡ä»¶
            Template template = null;
            StringWriter out = new StringWriter();
            try {
                template = configuration.getTemplate("article.ftl");
                //æ•°æ®æ¨¡å‹
                Map<String,Object> contentDataModel = new HashMap<>();
                contentDataModel.put("content", JSONArray.parseArray(content));
                //åˆæˆ
                template.process(contentDataModel,out);
            } catch (Exception e) {
                e.printStackTrace();
            }

            //4.3 æŠŠhtmlæ–‡ä»¶ä¸Šä¼ åˆ°minioä¸­
            InputStream in = new ByteArrayInputStream(out.toString().getBytes());
            String path = fileStorageService.uploadHtmlFile("", apArticle.getId() + ".html", in);


            //4.4 ä¿®æ”¹ap_articleè¡¨ï¼Œä¿å­˜static_urlå­—æ®µ
            apArticleService.update(Wrappers.<ApArticle>lambdaUpdate().eq(ApArticle::getId,apArticle.getId())
                    .set(ApArticle::getStaticUrl,path));

        }
    }

}
```

<br/>

2.åœ¨ `ApArticleService` çš„ `saveArticle` å®ç°æ–¹æ³•ä¸­æ·»åŠ è°ƒç”¨ç”Ÿæˆæ–‡ä»¶çš„æ–¹æ³•

```java
/**
* ä¿å­˜appç«¯ç›¸å…³æ–‡ç« 
* @param dto
* @return
*/
@Override
public ResponseResult saveArticle(ArticleDto dto) {

    //1.æ£€æŸ¥å‚æ•°
    if(dto == null){
        return ResponseResult.errorResult(AppHttpCodeEnum.PARAM_INVALID);
    }

    ApArticle apArticle = new ApArticle();
    BeanUtils.copyProperties(dto,apArticle);

    //2.åˆ¤æ–­æ˜¯å¦å­˜åœ¨id
    if(dto.getId() == null){
        //2.1 ä¸å­˜åœ¨id  ä¿å­˜  æ–‡ç«   æ–‡ç« é…ç½®  æ–‡ç« å†…å®¹

        //ä¿å­˜æ–‡ç« 
        save(apArticle);

        //ä¿å­˜é…ç½®
        ApArticleConfig apArticleConfig = new ApArticleConfig(apArticle.getId());
        apArticleConfigMapper.insert(apArticleConfig);

        //ä¿å­˜ æ–‡ç« å†…å®¹
        ApArticleContent apArticleContent = new ApArticleContent();
        apArticleContent.setArticleId(apArticle.getId());
        apArticleContent.setContent(dto.getContent());
        apArticleContentMapper.insert(apArticleContent);

    }else {
        //2.2 å­˜åœ¨id   ä¿®æ”¹  æ–‡ç«   æ–‡ç« å†…å®¹

        //ä¿®æ”¹  æ–‡ç« 
        updateById(apArticle);

        //ä¿®æ”¹æ–‡ç« å†…å®¹
        ApArticleContent apArticleContent = apArticleContentMapper.selectOne(Wrappers.<ApArticleContent>lambdaQuery().eq(ApArticleContent::getArticleId, dto.getId()));
        apArticleContent.setContent(dto.getContent());
        apArticleContentMapper.updateById(apArticleContent);
    }

    //å¼‚æ­¥è°ƒç”¨ ç”Ÿæˆé™æ€æ–‡ä»¶ä¸Šä¼ åˆ°minioä¸­
    articleFreemarkerService.buildArticleToMinIO(apArticle,dto.getContent());


    //3.ç»“æœè¿”å›  æ–‡ç« çš„id
    return ResponseResult.okResult(apArticle.getId());
}
```

<br/>

3.æ–‡ç« å¾®æœåŠ¡å¼€å¯å¼‚æ­¥è°ƒç”¨

```java {4}
@SpringBootApplication
@EnableDiscoveryClient
@MapperScan("com.heima.article.mapper")
@EnableAsync
public class ArticleApplication {

    public static void main(String[] args) {
        SpringApplication.run(ArticleApplication.class, args);
    }

}
```



ä»Šæ—¥ä½œä¸š
----------

![image-20240303151031515](assets/image-20240303151031515.png)

ä»Šæ—¥ä½œä¸šï¼šä½¿ç”¨seataæ¥è§£å†³å®¡æ ¸è¿‡ç¨‹ä¸­çš„åˆ†å¸ƒå¼äº‹ç‰©çš„é—®é¢˜

<br/>

### å¾®æœåŠ¡é›†æˆSeata

é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦åœ¨ `heima-leadnews-wemedia` å¾®æœåŠ¡ä¸­å¼•å…¥ `seata` ä¾èµ–ï¼š

```xml
<dependency>
    <groupId>com.alibaba.cloud</groupId>
    <artifactId>spring-cloud-starter-alibaba-seata</artifactId>
    <exclusions>
        <!--ç‰ˆæœ¬è¾ƒä½ï¼Œ1.3.0ï¼Œå› æ­¤æ’é™¤-->
        <exclusion>
            <artifactId>seata-spring-boot-starter</artifactId>
            <groupId>io.seata</groupId>
        </exclusion>
    </exclusions>
</dependency>
<!--seata starter é‡‡ç”¨1.5.1ç‰ˆæœ¬-->
<dependency>
    <groupId>io.seata</groupId>
    <artifactId>seata-spring-boot-starter</artifactId>
    <version>${seata.version}</version>
</dependency>
```

<br/>

**ä¿®æ”¹é…ç½®æ–‡ä»¶**

éœ€è¦ä¿®æ”¹ `application.yml` æ–‡ä»¶ï¼Œæ·»åŠ ä¸€äº›é…ç½®ï¼š

```yaml
seata:
  registry: # TCæœåŠ¡æ³¨å†Œä¸­å¿ƒçš„é…ç½®ï¼Œå¾®æœåŠ¡æ ¹æ®è¿™äº›ä¿¡æ¯å»æ³¨å†Œä¸­å¿ƒè·å–tcæœåŠ¡åœ°å€
    # å‚è€ƒtcæœåŠ¡è‡ªå·±çš„registry.confä¸­çš„é…ç½®
    type: nacos
    nacos: # tc
      server-addr: 192.168.150.102:8848
      namespace: "dbf4a6ae-0292-4e73-ae38-0df835b183c1"
      group: SEATA_GROUP
      application: seata-server # tcæœåŠ¡åœ¨nacosä¸­çš„æœåŠ¡åç§°
      username: nacos
      password: nacos
  tx-service-group: leadnews-wemedia # äº‹åŠ¡ç»„ï¼Œæ ¹æ®è¿™ä¸ªè·å–tcæœåŠ¡çš„clusteråç§°
  service:
    vgroup-mapping: # äº‹åŠ¡ç»„ä¸TCæœåŠ¡clusterçš„æ˜ å°„å…³ç³»
      leadnews-wemedia: "default"
```

<br/>

å› ä¸º Seata é»˜è®¤æ˜¯ AT æ¨¡å¼ï¼Œæ‰€ä»¥å°±ä¸éœ€è¦ä¿®æ”¹é…ç½®ä¿¡æ¯äº†ï¼Œä½†æ˜¯éœ€è¦åœ¨ WmNewsServiceImpl çš„ submitNews æ–¹æ³•ä¸Šæ·»åŠ  @GlobalTransactional æ³¨è§£





### ç»¼åˆæµ‹è¯•





å­¦ä¹ æ€»ç»“
--------

æ•°æ®æµå‘



å®¡æ ¸æµç¨‹



ä»£ç æµç¨‹



- @Transactional æ˜¯å¦ç”Ÿæ•ˆ

  

Mybatis-pluså¦‚ä½•å®ç°çš„é›ªèŠ±ç®—æ³•

æ€è€ƒï¼šæ–‡ç« å‘å¸ƒæ—¶é—´æ˜¯ä¸€ä¸ªæœªæ¥æ—¶é—´ï¼Œè¯¥å¦‚ä½•æŒ‰ç…§ç²¾ç¡®æ—¶é—´å‘å¸ƒï¼Ÿ     

ä¾‹å¦‚ï¼šä»Šå¤©æ˜¯1æœˆ1æ—¥å†™äº†ä¸€ç¯‡æ–‡ç« ï¼Œè®¾å®šå‘å¸ƒæ—¶é—´æ˜¯1æœˆ5æ—¥ï¼Œé‚£è¿™ä¸ªæ–‡ç« ä»€ä¹ˆæ—¶å€™å®¡æ ¸

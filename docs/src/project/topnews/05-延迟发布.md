Day05-å»¶è¿Ÿå‘å¸ƒ
======================

[[toc]]

## æ–‡ç« å»¶è¿Ÿå‘å¸ƒ

é—®é¢˜ï¼šä¸ç®¡æ–‡ç« çš„å‘å¸ƒæ—¶é—´æ˜¯ä»€ä¹ˆæ—¶é—´æ®µéƒ½ä¼šç«‹é©¬è¿›è¡Œå®¡æ ¸ï¼Œç„¶åç”Ÿæˆ APP ç«¯ç›¸å…³çš„æ•°æ®

![image-20240111193916088](assets/image-20240111193916088.png)

**å®šæ—¶ä»»åŠ¡**

![image-20240303151149359](assets/image-20240303151149359.png)

**å»¶è¿Ÿä»»åŠ¡**

![image-20240111193946407](assets/image-20240111193946407.png)

**ä»Šæ—¥å†…å®¹**

![image-20240111193956005](assets/image-20240111193956005.png)



## å»¶è¿Ÿä»»åŠ¡æ¦‚è¿°

> æ€è€ƒï¼šä»€ä¹ˆæ˜¯å»¶è¿Ÿä»»åŠ¡

- å®šæ—¶ä»»åŠ¡ï¼šæœ‰å›ºå®šå‘¨æœŸçš„ï¼Œæœ‰æ˜ç¡®çš„è§¦å‘æ—¶é—´
- å»¶è¿Ÿé˜Ÿåˆ—ï¼šæ²¡æœ‰å›ºå®šçš„å¼€å§‹æ—¶é—´ï¼Œå®ƒå¸¸å¸¸æ˜¯ç”±ä¸€ä¸ªäº‹ä»¶è§¦å‘çš„ï¼Œè€Œåœ¨è¿™ä¸ªäº‹ä»¶è§¦å‘ä¹‹åçš„ä¸€æ®µæ—¶é—´å†…è§¦å‘å¦ä¸€ä¸ªäº‹ä»¶ï¼Œä»»åŠ¡å¯ä»¥ç«‹å³æ‰§è¡Œï¼Œä¹Ÿå¯ä»¥å»¶è¿Ÿ

![image-20240303151222655](assets/image-20240303151222655.png)

å»¶è¿Ÿé˜Ÿåˆ—åº”ç”¨åœºæ™¯ï¼š

- åœºæ™¯ä¸€ï¼šè®¢å•ä¸‹å•ä¹‹å30åˆ†é’Ÿåï¼Œå¦‚æœç”¨æˆ·æ²¡æœ‰ä»˜é’±ï¼Œåˆ™ç³»ç»Ÿè‡ªåŠ¨å–æ¶ˆè®¢å•ï¼›å¦‚æœæœŸé—´ä¸‹å•æˆåŠŸï¼Œä»»åŠ¡å–æ¶ˆ

- åœºæ™¯äºŒï¼šæ¥å£å¯¹æ¥å‡ºç°ç½‘ç»œé—®é¢˜ï¼Œ1åˆ†é’Ÿåé‡è¯•ï¼Œå¦‚æœå¤±è´¥ï¼Œ2åˆ†é’Ÿé‡è¯•ï¼Œç›´åˆ°å‡ºç°é˜ˆå€¼ç»ˆæ­¢


<br/>

### æŠ€æœ¯å¯¹æ¯”

#### DelayQueue

JDKè‡ªå¸¦DelayQueue æ˜¯ä¸€ä¸ªæ”¯æŒå»¶æ—¶è·å–å…ƒç´ çš„é˜»å¡é˜Ÿåˆ—ï¼Œ å†…éƒ¨é‡‡ç”¨ä¼˜å…ˆé˜Ÿåˆ— PriorityQueue å­˜å‚¨å…ƒç´ ï¼ŒåŒæ—¶å…ƒç´ å¿…é¡»å®ç° Delayed æ¥å£ï¼›åœ¨åˆ›å»ºå…ƒç´ æ—¶å¯ä»¥æŒ‡å®šå¤šä¹…æ‰å¯ä»¥ä»é˜Ÿåˆ—ä¸­è·å–å½“å‰å…ƒç´ ï¼Œåªæœ‰åœ¨å»¶è¿ŸæœŸæ»¡æ—¶æ‰èƒ½ä»é˜Ÿåˆ—ä¸­æå–å…ƒç´ 

![image-20240303151305939](assets/image-20240303151305939.png)

<br/>

DelayQueueå±äºæ’åºé˜Ÿåˆ—ï¼Œå®ƒçš„ç‰¹æ®Šä¹‹å¤„åœ¨äºé˜Ÿåˆ—çš„å…ƒç´ å¿…é¡»å®ç°Delayedæ¥å£ï¼Œè¯¥æ¥å£éœ€è¦å®ç°compareToå’ŒgetDelayæ–¹æ³•

- getDelay()ï¼šè·å–å…ƒç´ åœ¨é˜Ÿåˆ—ä¸­çš„å‰©ä½™æ—¶é—´ï¼Œåªæœ‰å½“å‰©ä½™æ—¶é—´ä¸º0æ—¶å…ƒç´ æ‰å¯ä»¥å‡ºé˜Ÿ
- compareTo()ï¼šç”¨äºæ’åºï¼Œç¡®å®šå…ƒç´ å‡ºé˜Ÿåˆ—çš„é¡ºåºã€‚

<br/>

**ä»£ç å®ç°ï¼š**

1ï¼šåœ¨æµ‹è¯•åŒ…jdkä¸‹åˆ›å»ºå»¶è¿Ÿä»»åŠ¡å…ƒç´ å¯¹è±¡DelayedTaskï¼Œå®ç°compareToå’ŒgetDelayæ–¹æ³•ï¼Œ

2ï¼šåœ¨mainæ–¹æ³•ä¸­åˆ›å»ºDelayQueueå¹¶å‘å»¶è¿Ÿé˜Ÿåˆ—ä¸­æ·»åŠ ä¸‰ä¸ªå»¶è¿Ÿä»»åŠ¡ï¼Œ

3ï¼šå¾ªç¯çš„ä»å»¶è¿Ÿé˜Ÿåˆ—ä¸­æ‹‰å–ä»»åŠ¡

```java
public class DelayedTask  implements Delayed{
    
    // ä»»åŠ¡çš„æ‰§è¡Œæ—¶é—´
    private int executeTime = 0;
    
    public DelayedTask(int delay){
        Calendar calendar = Calendar.getInstance();
        calendar.add(Calendar.SECOND,delay);
        this.executeTime = (int)(calendar.getTimeInMillis() /1000 );
    }

    /**
     * å…ƒç´ åœ¨é˜Ÿåˆ—ä¸­çš„å‰©ä½™æ—¶é—´
     * @param unit
     * @return
     */
    @Override
    public long getDelay(TimeUnit unit) {
        Calendar calendar = Calendar.getInstance();
        return executeTime - (calendar.getTimeInMillis()/1000);
    }

    /**
     * å…ƒç´ æ’åº
     * @param o
     * @return
     */
    @Override
    public int compareTo(Delayed o) {
        long val = this.getDelay(TimeUnit.NANOSECONDS) - o.getDelay(TimeUnit.NANOSECONDS);
        return val == 0 ? 0 : ( val < 0 ? -1: 1 );
    }


    public static void main(String[] args) {
        DelayQueue<DelayedTask> queue = new DelayQueue<DelayedTask>();
        
        queue.add(new DelayedTask(5));
        queue.add(new DelayedTask(10));
        queue.add(new DelayedTask(15));

        System.out.println(System.currentTimeMillis()/1000+" start consume ");
        while(queue.size() != 0){
            DelayedTask delayedTask = queue.poll();
            if(delayedTask !=null ){
                System.out.println(System.currentTimeMillis()/1000+" cosume task");
            }
            //æ¯éš”ä¸€ç§’æ¶ˆè´¹ä¸€æ¬¡
            try {
                Thread.sleep(1000);
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        }     
    }
}
```

::: warning DelayQueueå®ç°å®Œæˆä¹‹åæ€è€ƒä¸€ä¸ªé—®é¢˜ï¼š

ä½¿ç”¨çº¿ç¨‹æ± æˆ–è€…åŸç”ŸDelayQueueç¨‹åºæŒ‚æ‰ä¹‹åï¼Œä»»åŠ¡éƒ½æ˜¯æ”¾åœ¨å†…å­˜ï¼Œéœ€è¦è€ƒè™‘æœªå¤„ç†æ¶ˆæ¯çš„ä¸¢å¤±å¸¦æ¥çš„å½±å“ï¼Œå¦‚ä½•ä¿è¯æ•°æ®ä¸ä¸¢å¤±ï¼Œéœ€è¦æŒä¹…åŒ–ï¼ˆç£ç›˜ï¼‰

:::

<br/>

#### RabbitMQå®ç°

- TTLï¼šTime To Live (æ¶ˆæ¯å­˜æ´»æ—¶é—´)

- æ­»ä¿¡é˜Ÿåˆ—ï¼šDead Letter Exchange(æ­»ä¿¡äº¤æ¢æœº)ï¼Œå½“æ¶ˆæ¯æˆä¸ºDead messageåï¼Œå¯ä»¥é‡æ–°å‘é€å¦ä¸€ä¸ªäº¤æ¢æœºï¼ˆæ­»ä¿¡äº¤æ¢æœºï¼‰

![image-20240303151346506](assets/image-20240303151346506.png)

<br/>

#### Rediså®ç°

Zset æ•°æ®ç±»å‹çš„å»é‡æœ‰åºï¼ˆåˆ†æ•°æ’åºï¼‰ç‰¹ç‚¹è¿›è¡Œå»¶è¿Ÿã€‚ä¾‹å¦‚ï¼šæ—¶é—´æˆ³ä½œä¸ºscoreè¿›è¡Œæ’åº

![image-20240303151412625](assets/image-20240303151412625.png)

<br/>

todo RabbitMQå®ç°å»¶è¿Ÿé˜Ÿåˆ—å’ŒRediså®ç°å»¶è¿Ÿé˜Ÿåˆ—ä¼˜åŠ£



### Rediså®ç°

**å®ç°æ€è·¯**

![image-20240307183727445](assets/image-20240307183727445.png)

:::warning ğŸ’¡ æ€è€ƒ

**1.ä¸ºä»€ä¹ˆä»»åŠ¡éœ€è¦å­˜å‚¨åœ¨æ•°æ®åº“ä¸­ï¼Ÿ**

- å»¶è¿Ÿä»»åŠ¡æ˜¯ä¸€ä¸ªé€šç”¨çš„æœåŠ¡ï¼Œä»»ä½•éœ€è¦å»¶è¿Ÿå¾—ä»»åŠ¡éƒ½å¯ä»¥è°ƒç”¨è¯¥æœåŠ¡ï¼Œéœ€è¦è€ƒè™‘æ•°æ®æŒä¹…åŒ–çš„é—®é¢˜ï¼Œå­˜å‚¨æ•°æ®åº“ä¸­æ˜¯ä¸€ç§æ•°æ®å®‰å…¨çš„è€ƒè™‘ã€‚


<br/>

**2.ä¸ºä»€ä¹ˆredisä¸­ä½¿ç”¨ä¸¤ç§æ•°æ®ç±»å‹ï¼Œlistå’Œzsetï¼Ÿ**

- åŸå› ä¸€ï¼šlistå­˜å‚¨ç«‹å³æ‰§è¡Œçš„ä»»åŠ¡ï¼Œzsetå­˜å‚¨æœªæ¥çš„æ•°æ®

- åŸå› äºŒï¼šä»»åŠ¡é‡è¿‡å¤§ä»¥åï¼Œzsetçš„æ€§èƒ½ä¼šä¸‹é™


![image-20240111194037979](assets/image-20240111194037979.png)

<br/>

**3.åœ¨æ·»åŠ  Zset æ•°æ®çš„æ—¶å€™ï¼Œä¸ºä»€ä¹ˆä¸éœ€è¦é¢„åŠ è½½ï¼Ÿ**

- ä»»åŠ¡æ¨¡å—æ˜¯ä¸€ä¸ªé€šç”¨çš„æ¨¡å—ï¼Œé¡¹ç›®ä¸­ä»»ä½•éœ€è¦å»¶è¿Ÿé˜Ÿåˆ—çš„åœ°æ–¹ï¼Œéƒ½å¯ä»¥è°ƒç”¨è¿™ä¸ªæ¥å£ï¼Œè¦è€ƒè™‘åˆ°æ•°æ®é‡çš„é—®é¢˜ï¼Œå¦‚æœæ•°æ®é‡ç‰¹åˆ«å¤§ï¼Œä¸ºäº†é˜²æ­¢é˜»å¡ï¼Œåªéœ€è¦æŠŠæœªæ¥å‡ åˆ†é’Ÿè¦æ‰§è¡Œçš„æ•°æ®å­˜å…¥ç¼“å­˜å³å¯ã€‚

:::



## å»¶è¿ŸæœåŠ¡å®ç°

### ç¯å¢ƒæ­å»º

`leadnews-schedule` æ˜¯ä¸€ä¸ªé€šç”¨çš„æœåŠ¡ï¼Œå•ç‹¬åˆ›å»ºæ¨¡å—æ¥ç®¡ç†ä»»ä½•ç±»å‹çš„å»¶è¿Ÿä»»åŠ¡

![image-20240111194058571](assets/image-20240111194058571.png)

â‘   åˆ›å»º `heima-leadnews-schedule` æ¨¡å—

â‘¡  æ·»åŠ bootstrap.ymlï¼Œbootstrap-dev.ymlï¼Œbootstrap-local

```yaml
server:
  port: 51802
spring:
  profiles:
    active: de
  application:
    name: leadnews-article
  cloud:
    nacos:
      config:
        file-extension: yaml
        shared-configs:
          - data-id: shared-mybatis.yaml

hmtt:
  jdbc:
    database: leadnews_schedule

# è®¾ç½®Mapperæ¥å£æ‰€å¯¹åº”çš„XMLæ–‡ä»¶ä½ç½®ï¼Œå¦‚æœä½ åœ¨Mapperæ¥å£ä¸­æœ‰è‡ªå®šä¹‰æ–¹æ³•ï¼Œéœ€è¦è¿›è¡Œè¯¥é…ç½®
mybatis-plus:
  mapper-locations: classpath*:mapper/*.xml
  # è®¾ç½®åˆ«ååŒ…æ‰«æè·¯å¾„ï¼Œé€šè¿‡è¯¥å±æ€§å¯ä»¥ç»™åŒ…ä¸­çš„ç±»æ³¨å†Œåˆ«å
  type-aliases-package: com.heima.model.schedule.pojos
```

<br/>

### æ•°æ®ç»“æ„

ä»»åŠ¡è¡¨ï¼štaskinfo 

![image-20210513151812858](assets\image-20210513151812858.png)

ä»»åŠ¡æ—¥å¿—è¡¨ï¼štaskinfo_logs 

![image-20210513151835752](assets\image-20210513151835752.png)

æ³¨æ„ï¼šMySQLä¸­ï¼ŒBLOBæ˜¯ä¸€ä¸ªäºŒè¿›åˆ¶å¤§å‹å¯¹è±¡ï¼Œæ˜¯ä¸€ä¸ªå¯ä»¥å­˜å‚¨å¤§é‡æ•°æ®çš„å®¹å™¨ï¼›LongBlob æœ€å¤§å­˜å‚¨ 4G 

<br/>

**æ•°æ®åº“è‡ªèº«è§£å†³å¹¶å‘çš„ä¸¤ç§ç­–ç•¥**

![image-20240111194131300](assets/image-20240111194131300.png)

ä¹è§‚é”æ”¯æŒï¼š

```java
/**
* mybatis-plusä¹è§‚é”æ”¯æŒ
* @return
*/
@Bean
public MybatisPlusInterceptor optimisticLockerInterceptor(){
    MybatisPlusInterceptor interceptor = new MybatisPlusInterceptor();
    interceptor.addInnerInterceptor(new OptimisticLockerInnerInterceptor());
    return interceptor;
}
```

:::details å¯¼å…¥èµ„æ–™ä¸­ leadnews_schedule æ•°æ®åº“

```sql
CREATE DATABASE IF NOT EXISTS leadnews_schedule DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
USE leadnews_schedule;
SET NAMES utf8;
/*
Navicat MySQL Data Transfer

Source Server         : localhost
Source Server Version : 50721
Source Host           : localhost:3306
Source Database       : leadnews_schedule

Target Server Type    : MYSQL
Target Server Version : 50721
File Encoding         : 65001

Date: 2021-05-14 16:17:48
*/

SET FOREIGN_KEY_CHECKS=0;

-- ----------------------------
-- Table structure for taskinfo
-- ----------------------------
DROP TABLE IF EXISTS `taskinfo`;
CREATE TABLE `taskinfo` (
  `task_id` bigint(20) NOT NULL COMMENT 'ä»»åŠ¡id',
  `execute_time` datetime(3) NOT NULL COMMENT 'æ‰§è¡Œæ—¶é—´',
  `parameters` longblob COMMENT 'å‚æ•°',
  `priority` int(11) NOT NULL COMMENT 'ä¼˜å…ˆçº§',
  `task_type` int(11) NOT NULL COMMENT 'ä»»åŠ¡ç±»å‹',
  PRIMARY KEY (`task_id`),
  KEY `index_taskinfo_time` (`task_type`,`priority`,`execute_time`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

-- ----------------------------
-- Records of taskinfo
-- ----------------------------

-- ----------------------------
-- Table structure for taskinfo_logs
-- ----------------------------
DROP TABLE IF EXISTS `taskinfo_logs`;
CREATE TABLE `taskinfo_logs` (
  `task_id` bigint(20) NOT NULL COMMENT 'ä»»åŠ¡id',
  `execute_time` datetime(3) NOT NULL COMMENT 'æ‰§è¡Œæ—¶é—´',
  `parameters` longblob COMMENT 'å‚æ•°',
  `priority` int(11) NOT NULL COMMENT 'ä¼˜å…ˆçº§',
  `task_type` int(11) NOT NULL COMMENT 'ä»»åŠ¡ç±»å‹',
  `version` int(11) NOT NULL COMMENT 'ç‰ˆæœ¬å·,ç”¨ä¹è§‚é”',
  `status` int(11) DEFAULT '0' COMMENT 'çŠ¶æ€ 0=åˆå§‹åŒ–çŠ¶æ€ 1=EXECUTED 2=CANCELLED',
  PRIMARY KEY (`task_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

-- ----------------------------
-- Records of taskinfo_logs
-- ----------------------------

```

:::

<br/>

### é›†æˆRedis

â‘  åœ¨é¡¹ç›®å¯¼å…¥redisç›¸å…³ä¾èµ–ï¼Œå·²ç»å®Œæˆ

```xml
<dependencies>
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-data-redis</artifactId>
    </dependency>
    <!-- redisä¾èµ–commons-pool è¿™ä¸ªä¾èµ–ä¸€å®šè¦æ·»åŠ  -->
    <dependency>
        <groupId>org.apache.commons</groupId>
        <artifactId>commons-pool2</artifactId>
    </dependency>
</dependencies>
```

â‘¡  åˆ›å»ºå¼•å¯¼ç±»å¹¶åœ¨åœ¨ `heima-leadnews-schedule` ä¸­é›†æˆ redis ï¼Œæ·»åŠ ä»¥ä¸‹ nacos é…ç½®ï¼Œé“¾æ¥ä¸Šredis

```java
package com.heima.schedule;

import com.baomidou.mybatisplus.extension.plugins.MybatisPlusInterceptor;
import com.baomidou.mybatisplus.extension.plugins.inner.OptimisticLockerInnerInterceptor;
import org.mybatis.spring.annotation.MapperScan;
import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.context.annotation.Bean;

/**
 * @author mousse 958860184@qq.com
 */
@SpringBootApplication
@MapperScan("com.heima.schedule.mapper")
public class ScheduleApplication {

    public static void main(String[] args) {
        SpringApplication.run(ScheduleApplication.class, args);
    }


    /**
     * mybatis-plusä¹è§‚é”æ”¯æŒ
     *
     * @return
     */
    @Bean
    public MybatisPlusInterceptor optimisticLockerInterceptor() {
        MybatisPlusInterceptor interceptor = new MybatisPlusInterceptor();
        interceptor.addInnerInterceptor(new OptimisticLockerInnerInterceptor());
        return interceptor;
    }
}
```

è®¾ç½® shared-redis.yaml

```yaml
spring:
  redis:
    host: ${hmtt.redis.host:192.168.150.102}
    password: ${hmtt.redis.password:leadnews}
    lettuce:
      pool:
        max-active: ${hm.redis.pool.max-active:8}
        max-idle: ${hm.redis.pool.max-idle:8}
        min-idle: ${hm.redis.pool.min-idle:1}
        max-wait: ${hm.redis.pool.max-wait:300}
```

â‘¢ æ‹·è´èµ„æ–™æ–‡ä»¶å¤¹ä¸‹çš„ç±»ï¼šCacheService åˆ° `heima-leadnews-common` æ¨¡å—ä¸‹ï¼Œå¹¶åœ¨`spring.factories `æ·»åŠ è‡ªåŠ¨é…ç½®

```properties {8}
org.springframework.boot.autoconfigure.EnableAutoConfiguration=\
  com.heima.common.exception.ExceptionCatch,\
  com.heima.common.swagger.SwaggerConfiguration,\
  com.heima.common.swagger.Swagger2Configuration,\
  com.heima.common.aliyun.GreenTextScan,\
  com.heima.common.aliyun.GreenImageScan,\
  com.heima.common.tess4j.Tess4jClient,\
  com.heima.common.redis.CacheService
```

:::details CacheService

```java
package com.heima.common.redis;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.cache.annotation.CachingConfigurerSupport;
import org.springframework.dao.DataAccessException;
import org.springframework.data.redis.connection.DataType;
import org.springframework.data.redis.connection.RedisConnection;
import org.springframework.data.redis.connection.StringRedisConnection;
import org.springframework.data.redis.core.Cursor;
import org.springframework.data.redis.core.RedisCallback;
import org.springframework.data.redis.core.ScanOptions;
import org.springframework.data.redis.core.StringRedisTemplate;
import org.springframework.data.redis.core.ZSetOperations.TypedTuple;
import org.springframework.lang.Nullable;
import org.springframework.stereotype.Component;

import java.io.IOException;
import java.util.*;
import java.util.concurrent.TimeUnit;

@Component
public class CacheService extends CachingConfigurerSupport {
    @Autowired
    private StringRedisTemplate stringRedisTemplate;

    public StringRedisTemplate getstringRedisTemplate() {
        return this.stringRedisTemplate;
    }

    /** -------------------keyç›¸å…³æ“ä½œ--------------------- */

    /**
     * åˆ é™¤key
     *
     * @param key
     */
    public void delete(String key) {
        stringRedisTemplate.delete(key);
    }

    /**
     * æ‰¹é‡åˆ é™¤key
     *
     * @param keys
     */
    public void delete(Collection<String> keys) {
        stringRedisTemplate.delete(keys);
    }

    /**
     * åºåˆ—åŒ–key
     *
     * @param key
     * @return
     */
    public byte[] dump(String key) {
        return stringRedisTemplate.dump(key);
    }

    /**
     * æ˜¯å¦å­˜åœ¨key
     *
     * @param key
     * @return
     */
    public Boolean exists(String key) {
        return stringRedisTemplate.hasKey(key);
    }

    /**
     * è®¾ç½®è¿‡æœŸæ—¶é—´
     *
     * @param key
     * @param timeout
     * @param unit
     * @return
     */
    public Boolean expire(String key, long timeout, TimeUnit unit) {
        return stringRedisTemplate.expire(key, timeout, unit);
    }

    /**
     * è®¾ç½®è¿‡æœŸæ—¶é—´
     *
     * @param key
     * @param date
     * @return
     */
    public Boolean expireAt(String key, Date date) {
        return stringRedisTemplate.expireAt(key, date);
    }

    /**
     * æŸ¥æ‰¾åŒ¹é…çš„key
     *
     * @param pattern
     * @return
     */
    public Set<String> keys(String pattern) {
        return stringRedisTemplate.keys(pattern);
    }

    /**
     * å°†å½“å‰æ•°æ®åº“çš„ key ç§»åŠ¨åˆ°ç»™å®šçš„æ•°æ®åº“ db å½“ä¸­
     *
     * @param key
     * @param dbIndex
     * @return
     */
    public Boolean move(String key, int dbIndex) {
        return stringRedisTemplate.move(key, dbIndex);
    }

    /**
     * ç§»é™¤ key çš„è¿‡æœŸæ—¶é—´ï¼Œkey å°†æŒä¹…ä¿æŒ
     *
     * @param key
     * @return
     */
    public Boolean persist(String key) {
        return stringRedisTemplate.persist(key);
    }

    /**
     * è¿”å› key çš„å‰©ä½™çš„è¿‡æœŸæ—¶é—´
     *
     * @param key
     * @param unit
     * @return
     */
    public Long getExpire(String key, TimeUnit unit) {
        return stringRedisTemplate.getExpire(key, unit);
    }

    /**
     * è¿”å› key çš„å‰©ä½™çš„è¿‡æœŸæ—¶é—´
     *
     * @param key
     * @return
     */
    public Long getExpire(String key) {
        return stringRedisTemplate.getExpire(key);
    }

    /**
     * ä»å½“å‰æ•°æ®åº“ä¸­éšæœºè¿”å›ä¸€ä¸ª key
     *
     * @return
     */
    public String randomKey() {
        return stringRedisTemplate.randomKey();
    }

    /**
     * ä¿®æ”¹ key çš„åç§°
     *
     * @param oldKey
     * @param newKey
     */
    public void rename(String oldKey, String newKey) {
        stringRedisTemplate.rename(oldKey, newKey);
    }

    /**
     * ä»…å½“ newkey ä¸å­˜åœ¨æ—¶ï¼Œå°† oldKey æ”¹åä¸º newkey
     *
     * @param oldKey
     * @param newKey
     * @return
     */
    public Boolean renameIfAbsent(String oldKey, String newKey) {
        return stringRedisTemplate.renameIfAbsent(oldKey, newKey);
    }

    /**
     * è¿”å› key æ‰€å‚¨å­˜çš„å€¼çš„ç±»å‹
     *
     * @param key
     * @return
     */
    public DataType type(String key) {
        return stringRedisTemplate.type(key);
    }

    /** -------------------stringç›¸å…³æ“ä½œ--------------------- */

    /**
     * è®¾ç½®æŒ‡å®š key çš„å€¼
     * @param key
     * @param value
     */
    public void set(String key, String value) {
        stringRedisTemplate.opsForValue().set(key, value);
    }

    /**
     * è·å–æŒ‡å®š key çš„å€¼
     * @param key
     * @return
     */
    public String get(String key) {
        return stringRedisTemplate.opsForValue().get(key);
    }

    /**
     * è¿”å› key ä¸­å­—ç¬¦ä¸²å€¼çš„å­å­—ç¬¦
     * @param key
     * @param start
     * @param end
     * @return
     */
    public String getRange(String key, long start, long end) {
        return stringRedisTemplate.opsForValue().get(key, start, end);
    }

    /**
     * å°†ç»™å®š key çš„å€¼è®¾ä¸º value ï¼Œå¹¶è¿”å› key çš„æ—§å€¼(old value)
     *
     * @param key
     * @param value
     * @return
     */
    public String getAndSet(String key, String value) {
        return stringRedisTemplate.opsForValue().getAndSet(key, value);
    }

    /**
     * å¯¹ key æ‰€å‚¨å­˜çš„å­—ç¬¦ä¸²å€¼ï¼Œè·å–æŒ‡å®šåç§»é‡ä¸Šçš„ä½(bit)
     *
     * @param key
     * @param offset
     * @return
     */
    public Boolean getBit(String key, long offset) {
        return stringRedisTemplate.opsForValue().getBit(key, offset);
    }

    /**
     * æ‰¹é‡è·å–
     *
     * @param keys
     * @return
     */
    public List<String> multiGet(Collection<String> keys) {
        return stringRedisTemplate.opsForValue().multiGet(keys);
    }

    /**
     * è®¾ç½®ASCIIç , å­—ç¬¦ä¸²'a'çš„ASCIIç æ˜¯97, è½¬ä¸ºäºŒè¿›åˆ¶æ˜¯'01100001', æ­¤æ–¹æ³•æ˜¯å°†äºŒè¿›åˆ¶ç¬¬offsetä½å€¼å˜ä¸ºvalue
     *
     * @param key
     * @param
     * @param value
     *            å€¼,trueä¸º1, falseä¸º0
     * @return
     */
    public boolean setBit(String key, long offset, boolean value) {
        return stringRedisTemplate.opsForValue().setBit(key, offset, value);
    }

    /**
     * å°†å€¼ value å…³è”åˆ° key ï¼Œå¹¶å°† key çš„è¿‡æœŸæ—¶é—´è®¾ä¸º timeout
     *
     * @param key
     * @param value
     * @param timeout
     *            è¿‡æœŸæ—¶é—´
     * @param unit
     *            æ—¶é—´å•ä½, å¤©:TimeUnit.DAYS å°æ—¶:TimeUnit.HOURS åˆ†é’Ÿ:TimeUnit.MINUTES
     *            ç§’:TimeUnit.SECONDS æ¯«ç§’:TimeUnit.MILLISECONDS
     */
    public void setEx(String key, String value, long timeout, TimeUnit unit) {
        stringRedisTemplate.opsForValue().set(key, value, timeout, unit);
    }

    /**
     * åªæœ‰åœ¨ key ä¸å­˜åœ¨æ—¶è®¾ç½® key çš„å€¼
     *
     * @param key
     * @param value
     * @return ä¹‹å‰å·²ç»å­˜åœ¨è¿”å›false,ä¸å­˜åœ¨è¿”å›true
     */
    public boolean setIfAbsent(String key, String value) {
        return stringRedisTemplate.opsForValue().setIfAbsent(key, value);
    }

    /**
     * ç”¨ value å‚æ•°è¦†å†™ç»™å®š key æ‰€å‚¨å­˜çš„å­—ç¬¦ä¸²å€¼ï¼Œä»åç§»é‡ offset å¼€å§‹
     *
     * @param key
     * @param value
     * @param offset
     *            ä»æŒ‡å®šä½ç½®å¼€å§‹è¦†å†™
     */
    public void setRange(String key, String value, long offset) {
        stringRedisTemplate.opsForValue().set(key, value, offset);
    }

    /**
     * è·å–å­—ç¬¦ä¸²çš„é•¿åº¦
     *
     * @param key
     * @return
     */
    public Long size(String key) {
        return stringRedisTemplate.opsForValue().size(key);
    }

    /**
     * æ‰¹é‡æ·»åŠ 
     *
     * @param maps
     */
    public void multiSet(Map<String, String> maps) {
        stringRedisTemplate.opsForValue().multiSet(maps);
    }

    /**
     * åŒæ—¶è®¾ç½®ä¸€ä¸ªæˆ–å¤šä¸ª key-value å¯¹ï¼Œå½“ä¸”ä»…å½“æ‰€æœ‰ç»™å®š key éƒ½ä¸å­˜åœ¨
     *
     * @param maps
     * @return ä¹‹å‰å·²ç»å­˜åœ¨è¿”å›false,ä¸å­˜åœ¨è¿”å›true
     */
    public boolean multiSetIfAbsent(Map<String, String> maps) {
        return stringRedisTemplate.opsForValue().multiSetIfAbsent(maps);
    }

    /**
     * å¢åŠ (è‡ªå¢é•¿), è´Ÿæ•°åˆ™ä¸ºè‡ªå‡
     *
     * @param key
     * @param
     * @return
     */
    public Long incrBy(String key, long increment) {
        return stringRedisTemplate.opsForValue().increment(key, increment);
    }

    /**
     *
     * @param key
     * @param
     * @return
     */
    public Double incrByFloat(String key, double increment) {
        return stringRedisTemplate.opsForValue().increment(key, increment);
    }

    /**
     * è¿½åŠ åˆ°æœ«å°¾
     *
     * @param key
     * @param value
     * @return
     */
    public Integer append(String key, String value) {
        return stringRedisTemplate.opsForValue().append(key, value);
    }

    /** -------------------hashç›¸å…³æ“ä½œ------------------------- */

    /**
     * è·å–å­˜å‚¨åœ¨å“ˆå¸Œè¡¨ä¸­æŒ‡å®šå­—æ®µçš„å€¼
     *
     * @param key
     * @param field
     * @return
     */
    public Object hGet(String key, String field) {
        return stringRedisTemplate.opsForHash().get(key, field);
    }

    /**
     * è·å–æ‰€æœ‰ç»™å®šå­—æ®µçš„å€¼
     *
     * @param key
     * @return
     */
    public Map<Object, Object> hGetAll(String key) {
        return stringRedisTemplate.opsForHash().entries(key);
    }

    /**
     * è·å–æ‰€æœ‰ç»™å®šå­—æ®µçš„å€¼
     *
     * @param key
     * @param fields
     * @return
     */
    public List<Object> hMultiGet(String key, Collection<Object> fields) {
        return stringRedisTemplate.opsForHash().multiGet(key, fields);
    }

    public void hPut(String key, String hashKey, String value) {
        stringRedisTemplate.opsForHash().put(key, hashKey, value);
    }

    public void hPutAll(String key, Map<String, String> maps) {
        stringRedisTemplate.opsForHash().putAll(key, maps);
    }

    /**
     * ä»…å½“hashKeyä¸å­˜åœ¨æ—¶æ‰è®¾ç½®
     *
     * @param key
     * @param hashKey
     * @param value
     * @return
     */
    public Boolean hPutIfAbsent(String key, String hashKey, String value) {
        return stringRedisTemplate.opsForHash().putIfAbsent(key, hashKey, value);
    }

    /**
     * åˆ é™¤ä¸€ä¸ªæˆ–å¤šä¸ªå“ˆå¸Œè¡¨å­—æ®µ
     *
     * @param key
     * @param fields
     * @return
     */
    public Long hDelete(String key, Object... fields) {
        return stringRedisTemplate.opsForHash().delete(key, fields);
    }

    /**
     * æŸ¥çœ‹å“ˆå¸Œè¡¨ key ä¸­ï¼ŒæŒ‡å®šçš„å­—æ®µæ˜¯å¦å­˜åœ¨
     *
     * @param key
     * @param field
     * @return
     */
    public boolean hExists(String key, String field) {
        return stringRedisTemplate.opsForHash().hasKey(key, field);
    }

    /**
     * ä¸ºå“ˆå¸Œè¡¨ key ä¸­çš„æŒ‡å®šå­—æ®µçš„æ•´æ•°å€¼åŠ ä¸Šå¢é‡ increment
     *
     * @param key
     * @param field
     * @param increment
     * @return
     */
    public Long hIncrBy(String key, Object field, long increment) {
        return stringRedisTemplate.opsForHash().increment(key, field, increment);
    }

    /**
     * ä¸ºå“ˆå¸Œè¡¨ key ä¸­çš„æŒ‡å®šå­—æ®µçš„æ•´æ•°å€¼åŠ ä¸Šå¢é‡ increment
     *
     * @param key
     * @param field
     * @param delta
     * @return
     */
    public Double hIncrByFloat(String key, Object field, double delta) {
        return stringRedisTemplate.opsForHash().increment(key, field, delta);
    }

    /**
     * è·å–æ‰€æœ‰å“ˆå¸Œè¡¨ä¸­çš„å­—æ®µ
     *
     * @param key
     * @return
     */
    public Set<Object> hKeys(String key) {
        return stringRedisTemplate.opsForHash().keys(key);
    }

    /**
     * è·å–å“ˆå¸Œè¡¨ä¸­å­—æ®µçš„æ•°é‡
     *
     * @param key
     * @return
     */
    public Long hSize(String key) {
        return stringRedisTemplate.opsForHash().size(key);
    }

    /**
     * è·å–å“ˆå¸Œè¡¨ä¸­æ‰€æœ‰å€¼
     *
     * @param key
     * @return
     */
    public List<Object> hValues(String key) {
        return stringRedisTemplate.opsForHash().values(key);
    }

    /**
     * è¿­ä»£å“ˆå¸Œè¡¨ä¸­çš„é”®å€¼å¯¹
     *
     * @param key
     * @param options
     * @return
     */
    public Cursor<Map.Entry<Object, Object>> hScan(String key, ScanOptions options) {
        return stringRedisTemplate.opsForHash().scan(key, options);
    }

    /** ------------------------listç›¸å…³æ“ä½œ---------------------------- */

    /**
     * é€šè¿‡ç´¢å¼•è·å–åˆ—è¡¨ä¸­çš„å…ƒç´ 
     *
     * @param key
     * @param index
     * @return
     */
    public String lIndex(String key, long index) {
        return stringRedisTemplate.opsForList().index(key, index);
    }

    /**
     * è·å–åˆ—è¡¨æŒ‡å®šèŒƒå›´å†…çš„å…ƒç´ 
     *
     * @param key
     * @param start
     *            å¼€å§‹ä½ç½®, 0æ˜¯å¼€å§‹ä½ç½®
     * @param end
     *            ç»“æŸä½ç½®, -1è¿”å›æ‰€æœ‰
     * @return
     */
    public List<String> lRange(String key, long start, long end) {
        return stringRedisTemplate.opsForList().range(key, start, end);
    }

    /**
     * å­˜å‚¨åœ¨listå¤´éƒ¨
     *
     * @param key
     * @param value
     * @return
     */
    public Long lLeftPush(String key, String value) {
        return stringRedisTemplate.opsForList().leftPush(key, value);
    }

    /**
     *
     * @param key
     * @param value
     * @return
     */
    public Long lLeftPushAll(String key, String... value) {
        return stringRedisTemplate.opsForList().leftPushAll(key, value);
    }

    /**
     *
     * @param key
     * @param value
     * @return
     */
    public Long lLeftPushAll(String key, Collection<String> value) {
        return stringRedisTemplate.opsForList().leftPushAll(key, value);
    }

    /**
     * å½“listå­˜åœ¨çš„æ—¶å€™æ‰åŠ å…¥
     *
     * @param key
     * @param value
     * @return
     */
    public Long lLeftPushIfPresent(String key, String value) {
        return stringRedisTemplate.opsForList().leftPushIfPresent(key, value);
    }

    /**
     * å¦‚æœpivotå­˜åœ¨,å†pivotå‰é¢æ·»åŠ 
     *
     * @param key
     * @param pivot
     * @param value
     * @return
     */
    public Long lLeftPush(String key, String pivot, String value) {
        return stringRedisTemplate.opsForList().leftPush(key, pivot, value);
    }

    /**
     *
     * @param key
     * @param value
     * @return
     */
    public Long lRightPush(String key, String value) {
        return stringRedisTemplate.opsForList().rightPush(key, value);
    }

    /**
     *
     * @param key
     * @param value
     * @return
     */
    public Long lRightPushAll(String key, String... value) {
        return stringRedisTemplate.opsForList().rightPushAll(key, value);
    }

    /**
     *
     * @param key
     * @param value
     * @return
     */
    public Long lRightPushAll(String key, Collection<String> value) {
        return stringRedisTemplate.opsForList().rightPushAll(key, value);
    }

    /**
     * ä¸ºå·²å­˜åœ¨çš„åˆ—è¡¨æ·»åŠ å€¼
     *
     * @param key
     * @param value
     * @return
     */
    public Long lRightPushIfPresent(String key, String value) {
        return stringRedisTemplate.opsForList().rightPushIfPresent(key, value);
    }

    /**
     * åœ¨pivotå…ƒç´ çš„å³è¾¹æ·»åŠ å€¼
     *
     * @param key
     * @param pivot
     * @param value
     * @return
     */
    public Long lRightPush(String key, String pivot, String value) {
        return stringRedisTemplate.opsForList().rightPush(key, pivot, value);
    }

    /**
     * é€šè¿‡ç´¢å¼•è®¾ç½®åˆ—è¡¨å…ƒç´ çš„å€¼
     *
     * @param key
     * @param index
     *            ä½ç½®
     * @param value
     */
    public void lSet(String key, long index, String value) {
        stringRedisTemplate.opsForList().set(key, index, value);
    }

    /**
     * ç§»å‡ºå¹¶è·å–åˆ—è¡¨çš„ç¬¬ä¸€ä¸ªå…ƒç´ 
     *
     * @param key
     * @return åˆ é™¤çš„å…ƒç´ 
     */
    public String lLeftPop(String key) {
        return stringRedisTemplate.opsForList().leftPop(key);
    }

    /**
     * ç§»å‡ºå¹¶è·å–åˆ—è¡¨çš„ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œ å¦‚æœåˆ—è¡¨æ²¡æœ‰å…ƒç´ ä¼šé˜»å¡åˆ—è¡¨ç›´åˆ°ç­‰å¾…è¶…æ—¶æˆ–å‘ç°å¯å¼¹å‡ºå…ƒç´ ä¸ºæ­¢
     *
     * @param key
     * @param timeout
     *            ç­‰å¾…æ—¶é—´
     * @param unit
     *            æ—¶é—´å•ä½
     * @return
     */
    public String lBLeftPop(String key, long timeout, TimeUnit unit) {
        return stringRedisTemplate.opsForList().leftPop(key, timeout, unit);
    }

    /**
     * ç§»é™¤å¹¶è·å–åˆ—è¡¨æœ€åä¸€ä¸ªå…ƒç´ 
     *
     * @param key
     * @return åˆ é™¤çš„å…ƒç´ 
     */
    public String lRightPop(String key) {
        return stringRedisTemplate.opsForList().rightPop(key);
    }

    /**
     * ç§»å‡ºå¹¶è·å–åˆ—è¡¨çš„æœ€åä¸€ä¸ªå…ƒç´ ï¼Œ å¦‚æœåˆ—è¡¨æ²¡æœ‰å…ƒç´ ä¼šé˜»å¡åˆ—è¡¨ç›´åˆ°ç­‰å¾…è¶…æ—¶æˆ–å‘ç°å¯å¼¹å‡ºå…ƒç´ ä¸ºæ­¢
     *
     * @param key
     * @param timeout
     *            ç­‰å¾…æ—¶é—´
     * @param unit
     *            æ—¶é—´å•ä½
     * @return
     */
    public String lBRightPop(String key, long timeout, TimeUnit unit) {
        return stringRedisTemplate.opsForList().rightPop(key, timeout, unit);
    }

    /**
     * ç§»é™¤åˆ—è¡¨çš„æœ€åä¸€ä¸ªå…ƒç´ ï¼Œå¹¶å°†è¯¥å…ƒç´ æ·»åŠ åˆ°å¦ä¸€ä¸ªåˆ—è¡¨å¹¶è¿”å›
     *
     * @param sourceKey
     * @param destinationKey
     * @return
     */
    public String lRightPopAndLeftPush(String sourceKey, String destinationKey) {
        return stringRedisTemplate.opsForList().rightPopAndLeftPush(sourceKey,
                destinationKey);
    }

    /**
     * ä»åˆ—è¡¨ä¸­å¼¹å‡ºä¸€ä¸ªå€¼ï¼Œå°†å¼¹å‡ºçš„å…ƒç´ æ’å…¥åˆ°å¦å¤–ä¸€ä¸ªåˆ—è¡¨ä¸­å¹¶è¿”å›å®ƒï¼› å¦‚æœåˆ—è¡¨æ²¡æœ‰å…ƒç´ ä¼šé˜»å¡åˆ—è¡¨ç›´åˆ°ç­‰å¾…è¶…æ—¶æˆ–å‘ç°å¯å¼¹å‡ºå…ƒç´ ä¸ºæ­¢
     *
     * @param sourceKey
     * @param destinationKey
     * @param timeout
     * @param unit
     * @return
     */
    public String lBRightPopAndLeftPush(String sourceKey, String destinationKey,
                                        long timeout, TimeUnit unit) {
        return stringRedisTemplate.opsForList().rightPopAndLeftPush(sourceKey,
                destinationKey, timeout, unit);
    }
    
    /**
     * åˆ é™¤é›†åˆä¸­å€¼ç­‰äºvalueå¾—å…ƒç´ 
     *
     * @param key
     * @param index
     *            index=0, åˆ é™¤æ‰€æœ‰å€¼ç­‰äºvalueçš„å…ƒç´ ; index>0, ä»å¤´éƒ¨å¼€å§‹åˆ é™¤ç¬¬ä¸€ä¸ªå€¼ç­‰äºvalueçš„å…ƒç´ ;
     *            index<0, ä»å°¾éƒ¨å¼€å§‹åˆ é™¤ç¬¬ä¸€ä¸ªå€¼ç­‰äºvalueçš„å…ƒç´ ;
     * @param value
     * @return
     */
    public Long lRemove(String key, long index, String value) {
        return stringRedisTemplate.opsForList().remove(key, index, value);
    }

    /**
     * è£å‰ªlist
     *
     * @param key
     * @param start
     * @param end
     */
    public void lTrim(String key, long start, long end) {
        stringRedisTemplate.opsForList().trim(key, start, end);
    }

    /**
     * è·å–åˆ—è¡¨é•¿åº¦
     *
     * @param key
     * @return
     */
    public Long lLen(String key) {
        return stringRedisTemplate.opsForList().size(key);
    }


    /** --------------------setç›¸å…³æ“ä½œ-------------------------- */

    /**
     * setæ·»åŠ å…ƒç´ 
     *
     * @param key
     * @param values
     * @return
     */
    public Long sAdd(String key, String... values) {
        return stringRedisTemplate.opsForSet().add(key, values);
    }

    /**
     * setç§»é™¤å…ƒç´ 
     *
     * @param key
     * @param values
     * @return
     */
    public Long sRemove(String key, Object... values) {
        return stringRedisTemplate.opsForSet().remove(key, values);
    }

    /**
     * ç§»é™¤å¹¶è¿”å›é›†åˆçš„ä¸€ä¸ªéšæœºå…ƒç´ 
     *
     * @param key
     * @return
     */
    public String sPop(String key) {
        return stringRedisTemplate.opsForSet().pop(key);
    }

    /**
     * å°†å…ƒç´ valueä»ä¸€ä¸ªé›†åˆç§»åˆ°å¦ä¸€ä¸ªé›†åˆ
     *
     * @param key
     * @param value
     * @param destKey
     * @return
     */
    public Boolean sMove(String key, String value, String destKey) {
        return stringRedisTemplate.opsForSet().move(key, value, destKey);
    }

    /**
     * è·å–é›†åˆçš„å¤§å°
     *
     * @param key
     * @return
     */
    public Long sSize(String key) {
        return stringRedisTemplate.opsForSet().size(key);
    }

    /**
     * åˆ¤æ–­é›†åˆæ˜¯å¦åŒ…å«value
     *
     * @param key
     * @param value
     * @return
     */
    public Boolean sIsMember(String key, Object value) {
        return stringRedisTemplate.opsForSet().isMember(key, value);
    }

    /**
     * è·å–ä¸¤ä¸ªé›†åˆçš„äº¤é›†
     *
     * @param key
     * @param otherKey
     * @return
     */
    public Set<String> sIntersect(String key, String otherKey) {
        return stringRedisTemplate.opsForSet().intersect(key, otherKey);
    }

    /**
     * è·å–keyé›†åˆä¸å¤šä¸ªé›†åˆçš„äº¤é›†
     *
     * @param key
     * @param otherKeys
     * @return
     */
    public Set<String> sIntersect(String key, Collection<String> otherKeys) {
        return stringRedisTemplate.opsForSet().intersect(key, otherKeys);
    }

    /**
     * keyé›†åˆä¸otherKeyé›†åˆçš„äº¤é›†å­˜å‚¨åˆ°destKeyé›†åˆä¸­
     *
     * @param key
     * @param otherKey
     * @param destKey
     * @return
     */
    public Long sIntersectAndStore(String key, String otherKey, String destKey) {
        return stringRedisTemplate.opsForSet().intersectAndStore(key, otherKey,
                destKey);
    }

    /**
     * keyé›†åˆä¸å¤šä¸ªé›†åˆçš„äº¤é›†å­˜å‚¨åˆ°destKeyé›†åˆä¸­
     *
     * @param key
     * @param otherKeys
     * @param destKey
     * @return
     */
    public Long sIntersectAndStore(String key, Collection<String> otherKeys,
                                   String destKey) {
        return stringRedisTemplate.opsForSet().intersectAndStore(key, otherKeys,
                destKey);
    }

    /**
     * è·å–ä¸¤ä¸ªé›†åˆçš„å¹¶é›†
     *
     * @param key
     * @param otherKeys
     * @return
     */
    public Set<String> sUnion(String key, String otherKeys) {
        return stringRedisTemplate.opsForSet().union(key, otherKeys);
    }

    /**
     * è·å–keyé›†åˆä¸å¤šä¸ªé›†åˆçš„å¹¶é›†
     *
     * @param key
     * @param otherKeys
     * @return
     */
    public Set<String> sUnion(String key, Collection<String> otherKeys) {
        return stringRedisTemplate.opsForSet().union(key, otherKeys);
    }

    /**
     * keyé›†åˆä¸otherKeyé›†åˆçš„å¹¶é›†å­˜å‚¨åˆ°destKeyä¸­
     *
     * @param key
     * @param otherKey
     * @param destKey
     * @return
     */
    public Long sUnionAndStore(String key, String otherKey, String destKey) {
        return stringRedisTemplate.opsForSet().unionAndStore(key, otherKey, destKey);
    }

    /**
     * keyé›†åˆä¸å¤šä¸ªé›†åˆçš„å¹¶é›†å­˜å‚¨åˆ°destKeyä¸­
     *
     * @param key
     * @param otherKeys
     * @param destKey
     * @return
     */
    public Long sUnionAndStore(String key, Collection<String> otherKeys,
                               String destKey) {
        return stringRedisTemplate.opsForSet().unionAndStore(key, otherKeys, destKey);
    }

    /**
     * è·å–ä¸¤ä¸ªé›†åˆçš„å·®é›†
     *
     * @param key
     * @param otherKey
     * @return
     */
    public Set<String> sDifference(String key, String otherKey) {
        return stringRedisTemplate.opsForSet().difference(key, otherKey);
    }

    /**
     * è·å–keyé›†åˆä¸å¤šä¸ªé›†åˆçš„å·®é›†
     *
     * @param key
     * @param otherKeys
     * @return
     */
    public Set<String> sDifference(String key, Collection<String> otherKeys) {
        return stringRedisTemplate.opsForSet().difference(key, otherKeys);
    }

    /**
     * keyé›†åˆä¸otherKeyé›†åˆçš„å·®é›†å­˜å‚¨åˆ°destKeyä¸­
     *
     * @param key
     * @param otherKey
     * @param destKey
     * @return
     */
    public Long sDifference(String key, String otherKey, String destKey) {
        return stringRedisTemplate.opsForSet().differenceAndStore(key, otherKey,
                destKey);
    }

    /**
     * keyé›†åˆä¸å¤šä¸ªé›†åˆçš„å·®é›†å­˜å‚¨åˆ°destKeyä¸­
     *
     * @param key
     * @param otherKeys
     * @param destKey
     * @return
     */
    public Long sDifference(String key, Collection<String> otherKeys,
                            String destKey) {
        return stringRedisTemplate.opsForSet().differenceAndStore(key, otherKeys,
                destKey);
    }

    /**
     * è·å–é›†åˆæ‰€æœ‰å…ƒç´ 
     *
     * @param key
     * @param
     * @param
     * @return
     */
    public Set<String> setMembers(String key) {
        return stringRedisTemplate.opsForSet().members(key);
    }

    /**
     * éšæœºè·å–é›†åˆä¸­çš„ä¸€ä¸ªå…ƒç´ 
     *
     * @param key
     * @return
     */
    public String sRandomMember(String key) {
        return stringRedisTemplate.opsForSet().randomMember(key);
    }

    /**
     * éšæœºè·å–é›†åˆä¸­countä¸ªå…ƒç´ 
     *
     * @param key
     * @param count
     * @return
     */
    public List<String> sRandomMembers(String key, long count) {
        return stringRedisTemplate.opsForSet().randomMembers(key, count);
    }

    /**
     * éšæœºè·å–é›†åˆä¸­countä¸ªå…ƒç´ å¹¶ä¸”å»é™¤é‡å¤çš„
     *
     * @param key
     * @param count
     * @return
     */
    public Set<String> sDistinctRandomMembers(String key, long count) {
        return stringRedisTemplate.opsForSet().distinctRandomMembers(key, count);
    }

    /**
     *
     * @param key
     * @param options
     * @return
     */
    public Cursor<String> sScan(String key, ScanOptions options) {
        return stringRedisTemplate.opsForSet().scan(key, options);
    }

    /**------------------zSetç›¸å…³æ“ä½œ--------------------------------*/

    /**
     * æ·»åŠ å…ƒç´ ,æœ‰åºé›†åˆæ˜¯æŒ‰ç…§å…ƒç´ çš„scoreå€¼ç”±å°åˆ°å¤§æ’åˆ—
     *
     * @param key
     * @param value
     * @param score
     * @return
     */
    public Boolean zAdd(String key, String value, double score) {
        return stringRedisTemplate.opsForZSet().add(key, value, score);
    }

    /**
     *
     * @param key
     * @param values
     * @return
     */
    public Long zAdd(String key, Set<TypedTuple<String>> values) {
        return stringRedisTemplate.opsForZSet().add(key, values);
    }

    /**
     *
     * @param key
     * @param values
     * @return
     */
    public Long zRemove(String key, Object... values) {
        return stringRedisTemplate.opsForZSet().remove(key, values);
    }

    public Long zRemove(String key, Collection<String> values) {
        if(values!=null&&!values.isEmpty()){
            Object[] objs = values.toArray(new Object[values.size()]);
            return stringRedisTemplate.opsForZSet().remove(key, objs);
        }
       return 0L;
    }

    /**
     * å¢åŠ å…ƒç´ çš„scoreå€¼ï¼Œå¹¶è¿”å›å¢åŠ åçš„å€¼
     *
     * @param key
     * @param value
     * @param delta
     * @return
     */
    public Double zIncrementScore(String key, String value, double delta) {
        return stringRedisTemplate.opsForZSet().incrementScore(key, value, delta);
    }

    /**
     * è¿”å›å…ƒç´ åœ¨é›†åˆçš„æ’å,æœ‰åºé›†åˆæ˜¯æŒ‰ç…§å…ƒç´ çš„scoreå€¼ç”±å°åˆ°å¤§æ’åˆ—
     *
     * @param key
     * @param value
     * @return 0è¡¨ç¤ºç¬¬ä¸€ä½
     */
    public Long zRank(String key, Object value) {
        return stringRedisTemplate.opsForZSet().rank(key, value);
    }

    /**
     * è¿”å›å…ƒç´ åœ¨é›†åˆçš„æ’å,æŒ‰å…ƒç´ çš„scoreå€¼ç”±å¤§åˆ°å°æ’åˆ—
     *
     * @param key
     * @param value
     * @return
     */
    public Long zReverseRank(String key, Object value) {
        return stringRedisTemplate.opsForZSet().reverseRank(key, value);
    }

    /**
     * è·å–é›†åˆçš„å…ƒç´ , ä»å°åˆ°å¤§æ’åº
     *
     * @param key
     * @param start
     *            å¼€å§‹ä½ç½®
     * @param end
     *            ç»“æŸä½ç½®, -1æŸ¥è¯¢æ‰€æœ‰
     * @return
     */
    public Set<String> zRange(String key, long start, long end) {
        return stringRedisTemplate.opsForZSet().range(key, start, end);
    }
    
    /**
     * è·å–zseté›†åˆçš„æ‰€æœ‰å…ƒç´ , ä»å°åˆ°å¤§æ’åº
     *
     */
    public Set<String> zRangeAll(String key) {
        return zRange(key,0,-1);
    }

    /**
     * è·å–é›†åˆå…ƒç´ , å¹¶ä¸”æŠŠscoreå€¼ä¹Ÿè·å–
     *
     * @param key
     * @param start
     * @param end
     * @return
     */
    public Set<TypedTuple<String>> zRangeWithScores(String key, long start,
                                                    long end) {
        return stringRedisTemplate.opsForZSet().rangeWithScores(key, start, end);
    }

    /**
     * æ ¹æ®Scoreå€¼æŸ¥è¯¢é›†åˆå…ƒç´ 
     *
     * @param key
     * @param min
     *            æœ€å°å€¼
     * @param max
     *            æœ€å¤§å€¼
     * @return
     */
    public Set<String> zRangeByScore(String key, double min, double max) {
        return stringRedisTemplate.opsForZSet().rangeByScore(key, min, max);
    }


    /**
     * æ ¹æ®Scoreå€¼æŸ¥è¯¢é›†åˆå…ƒç´ , ä»å°åˆ°å¤§æ’åº
     *
     * @param key
     * @param min
     *            æœ€å°å€¼
     * @param max
     *            æœ€å¤§å€¼
     * @return
     */
    public Set<TypedTuple<String>> zRangeByScoreWithScores(String key,
                                                           double min, double max) {
        return stringRedisTemplate.opsForZSet().rangeByScoreWithScores(key, min, max);
    }

    /**
     *
     * @param key
     * @param min
     * @param max
     * @param start
     * @param end
     * @return
     */
    public Set<TypedTuple<String>> zRangeByScoreWithScores(String key,
                                                           double min, double max, long start, long end) {
        return stringRedisTemplate.opsForZSet().rangeByScoreWithScores(key, min, max,
                start, end);
    }

    /**
     * è·å–é›†åˆçš„å…ƒç´ , ä»å¤§åˆ°å°æ’åº
     *
     * @param key
     * @param start
     * @param end
     * @return
     */
    public Set<String> zReverseRange(String key, long start, long end) {
        return stringRedisTemplate.opsForZSet().reverseRange(key, start, end);

    }

    public Set<String> zReverseRangeByScore(String key, long min, long max) {
        return stringRedisTemplate.opsForZSet().reverseRangeByScore(key, min, max);

    }

    /**
     * è·å–é›†åˆçš„å…ƒç´ , ä»å¤§åˆ°å°æ’åº, å¹¶è¿”å›scoreå€¼
     *
     * @param key
     * @param start
     * @param end
     * @return
     */
    public Set<TypedTuple<String>> zReverseRangeWithScores(String key,
                                                           long start, long end) {
        return stringRedisTemplate.opsForZSet().reverseRangeWithScores(key, start,
                end);
    }

    /**
     * æ ¹æ®Scoreå€¼æŸ¥è¯¢é›†åˆå…ƒç´ , ä»å¤§åˆ°å°æ’åº
     *
     * @param key
     * @param min
     * @param max
     * @return
     */
    public Set<String> zReverseRangeByScore(String key, double min,
                                            double max) {
        return stringRedisTemplate.opsForZSet().reverseRangeByScore(key, min, max);
    }

    /**
     * æ ¹æ®Scoreå€¼æŸ¥è¯¢é›†åˆå…ƒç´ , ä»å¤§åˆ°å°æ’åº
     *
     * @param key
     * @param min
     * @param max
     * @return
     */
    public Set<TypedTuple<String>> zReverseRangeByScoreWithScores(
            String key, double min, double max) {
        return stringRedisTemplate.opsForZSet().reverseRangeByScoreWithScores(key,
                min, max);
    }

    /**
     *
     * @param key
     * @param min
     * @param max
     * @param start
     * @param end
     * @return
     */
    public Set<String> zReverseRangeByScore(String key, double min,
                                            double max, long start, long end) {
        return stringRedisTemplate.opsForZSet().reverseRangeByScore(key, min, max,
                start, end);
    }

    /**
     * æ ¹æ®scoreå€¼è·å–é›†åˆå…ƒç´ æ•°é‡
     *
     * @param key
     * @param min
     * @param max
     * @return
     */
    public Long zCount(String key, double min, double max) {
        return stringRedisTemplate.opsForZSet().count(key, min, max);
    }

    /**
     * è·å–é›†åˆå¤§å°
     *
     * @param key
     * @return
     */
    public Long zSize(String key) {
        return stringRedisTemplate.opsForZSet().size(key);
    }

    /**
     * è·å–é›†åˆå¤§å°
     *
     * @param key
     * @return
     */
    public Long zZCard(String key) {
        return stringRedisTemplate.opsForZSet().zCard(key);
    }

    /**
     * è·å–é›†åˆä¸­valueå…ƒç´ çš„scoreå€¼
     *
     * @param key
     * @param value
     * @return
     */
    public Double zScore(String key, Object value) {
        return stringRedisTemplate.opsForZSet().score(key, value);
    }

    /**
     * ç§»é™¤æŒ‡å®šç´¢å¼•ä½ç½®çš„æˆå‘˜
     *
     * @param key
     * @param start
     * @param end
     * @return
     */
    public Long zRemoveRange(String key, long start, long end) {
        return stringRedisTemplate.opsForZSet().removeRange(key, start, end);
    }

    /**
     * æ ¹æ®æŒ‡å®šçš„scoreå€¼çš„èŒƒå›´æ¥ç§»é™¤æˆå‘˜
     *
     * @param key
     * @param min
     * @param max
     * @return
     */
    public Long zRemoveRangeByScore(String key, double min, double max) {
        return stringRedisTemplate.opsForZSet().removeRangeByScore(key, min, max);
    }

    /**
     * è·å–keyå’ŒotherKeyçš„å¹¶é›†å¹¶å­˜å‚¨åœ¨destKeyä¸­
     *
     * @param key
     * @param otherKey
     * @param destKey
     * @return
     */
    public Long zUnionAndStore(String key, String otherKey, String destKey) {
        return stringRedisTemplate.opsForZSet().unionAndStore(key, otherKey, destKey);
    }

    /**
     *
     * @param key
     * @param otherKeys
     * @param destKey
     * @return
     */
    public Long zUnionAndStore(String key, Collection<String> otherKeys,
                               String destKey) {
        return stringRedisTemplate.opsForZSet()
                .unionAndStore(key, otherKeys, destKey);
    }

    /**
     * äº¤é›†
     *
     * @param key
     * @param otherKey
     * @param destKey
     * @return
     */
    public Long zIntersectAndStore(String key, String otherKey,
                                   String destKey) {
        return stringRedisTemplate.opsForZSet().intersectAndStore(key, otherKey,
                destKey);
    }

    /**
     * äº¤é›†
     *
     * @param key
     * @param otherKeys
     * @param destKey
     * @return
     */
    public Long zIntersectAndStore(String key, Collection<String> otherKeys,
                                   String destKey) {
        return stringRedisTemplate.opsForZSet().intersectAndStore(key, otherKeys,
                destKey);
    }

    /**
     *
     * @param key
     * @param options
     * @return
     */
    public Cursor<TypedTuple<String>> zScan(String key, ScanOptions options) {
        return stringRedisTemplate.opsForZSet().scan(key, options);
    }

    /**
     * æ‰«æä¸»é”®ï¼Œå»ºè®®ä½¿ç”¨
     * @param patten
     * @return
     */
    public Set<String> scan(String patten){
        Set<String> keys = stringRedisTemplate.execute((RedisCallback<Set<String>>) connection -> {
            Set<String> result = new HashSet<>();
            try (Cursor<byte[]> cursor = connection.scan(new ScanOptions.ScanOptionsBuilder()
                    .match(patten).count(10000).build())) {
                while (cursor.hasNext()) {
                    result.add(new String(cursor.next()));
                }
            } catch (IOException e) {
                e.printStackTrace();
            }
            return result;
        });
        return  keys;
    }
    
    /**
     * ç®¡é“æŠ€æœ¯ï¼Œæé«˜æ€§èƒ½
     * @param type
     * @param values
     * @return
     */
    public List<Object> lRightPushPipeline(String type,Collection<String> values){
        List<Object> results = stringRedisTemplate.executePipelined(new RedisCallback<Object>() {
                    public Object doInRedis(RedisConnection connection) throws DataAccessException {
                        StringRedisConnection stringRedisConn = (StringRedisConnection)connection;
                        //é›†åˆè½¬æ¢æ•°ç»„
                        String[] strings = values.toArray(new String[values.size()]);
                        //ç›´æ¥æ‰¹é‡å‘é€
                        stringRedisConn.rPush(type, strings);
                        return null;
                    }
                });
        return results;
    }

    public List<Object> refreshWithPipeline(String future_key,String topic_key,Collection<String> values){

        List<Object> objects = stringRedisTemplate.executePipelined(new RedisCallback<Object>() {
            @Nullable
            @Override
            public Object doInRedis(RedisConnection redisConnection) throws DataAccessException {
                StringRedisConnection stringRedisConnection = (StringRedisConnection)redisConnection;
                String[] strings = values.toArray(new String[values.size()]);
                stringRedisConnection.rPush(topic_key,strings);
                stringRedisConnection.zRem(future_key,strings);
                return null;
            }
        });
        return objects;
    }

}
```

:::

â‘£ æµ‹è¯•

```java
package com.heima.schedule.test;


import com.heima.common.redis.CacheService;
import com.heima.schedule.ScheduleApplication;
import org.junit.Test;
import org.junit.runner.RunWith;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.test.context.junit4.SpringRunner;

import java.util.Set;


@SpringBootTest(classes = ScheduleApplication.class)
@RunWith(SpringRunner.class)
public class RedisTest {

    @Autowired
    private CacheService cacheService;

    @Test
    public void testList(){

        //åœ¨listçš„å·¦è¾¹æ·»åŠ å…ƒç´ 
//        cacheService.lLeftPush("list_001","hello,redis");

        //åœ¨listçš„å³è¾¹è·å–å…ƒç´ ï¼Œå¹¶åˆ é™¤
        String list_001 = cacheService.lRightPop("list_001");
        System.out.println(list_001);
    }

    @Test
    public void testZset(){
        //æ·»åŠ æ•°æ®åˆ°zsetä¸­  åˆ†å€¼
        /*cacheService.zAdd("zset_key_001","hello zset 001",1000);
        cacheService.zAdd("zset_key_001","hello zset 002",8888);
        cacheService.zAdd("zset_key_001","hello zset 003",7777);
        cacheService.zAdd("zset_key_001","hello zset 004",999999);*/

        //æŒ‰ç…§åˆ†å€¼è·å–æ•°æ®
        Set<String> zset_key_001 = cacheService.zRangeByScore("zset_key_001", 0, 8888);
        System.out.println(zset_key_001);

    }
}
```

<br/>

### æœåŠ¡æ–¹æ³•

#### æ·»åŠ ä»»åŠ¡

:::tip ğŸ”– å®ç°æ­¥éª¤

- å¯¹ä»£ç è¿›è¡Œç”Ÿæˆï¼Œå¹¶å°†å®ä½“ç±»ç§»åŠ¨åˆ° model æ¨¡å—ä¸­
- ä¿®æ”¹ TaskServiceï¼Œæ·»åŠ ä»»åŠ¡åˆ° Redis
  - å¦‚æœä»»åŠ¡çš„æ‰§è¡Œæ—¶é—´å°äºç­‰äºå½“å‰æ—¶é—´åˆ™å­˜å…¥ List
  - å¦‚æœä»»åŠ¡çš„æ‰§è¡Œæ—¶é—´å¤§äºå½“å‰æ—¶é—´ï¼Œå°äºç­‰äºé¢„è®¾æ—¶é—´ï¼ˆæœªæ¥äº”åˆ†é’Ÿï¼‰åˆ™å­˜å…¥ Zset ä¸­


:::

<br/>

â‘  åˆ›å»ºTaskService

```java
package com.heima.schedule.service;

import com.heima.model.schedule.pojos.Taskinfo;
import com.baomidou.mybatisplus.extension.service.IService;

/**
 * <p>
 *  æœåŠ¡ç±»
 * </p>
 *
 * @author mousse
 * @since 2024-03-07
 */
public interface ITaskinfoService extends IService<Taskinfo> {

    /**
     * æ·»åŠ ä»»åŠ¡
     * @param task   ä»»åŠ¡å¯¹è±¡
     * @return       ä»»åŠ¡id
     */
    public long addTask(Taskinfo task) ;
}
```

å®ç°ï¼š

```java
package com.heima.schedule.service.impl;

import com.alibaba.fastjson.JSON;
import com.heima.common.constants.ScheduleConstants;
import com.heima.common.redis.CacheService;
import com.heima.model.schedule.pojos.Taskinfo;
import com.heima.model.schedule.pojos.TaskinfoLogs;
import com.heima.schedule.mapper.TaskinfoLogsMapper;
import com.heima.schedule.mapper.TaskinfoMapper;
import com.heima.schedule.service.ITaskinfoService;
import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.BeanUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.time.LocalDateTime;
import java.time.ZoneOffset;
import java.util.Calendar;
import java.util.Date;

/**
 * <p>
 * æœåŠ¡å®ç°ç±»
 * </p>
 *
 * @author mousse
 * @since 2024-03-07
 */
@Service
@Transactional
@Slf4j
public class TaskinfoServiceImpl extends ServiceImpl<TaskinfoMapper, Taskinfo> implements ITaskinfoService {


    @Override
    public long addTask(Taskinfo task) {
        //1.æ·»åŠ ä»»åŠ¡åˆ°æ•°æ®åº“ä¸­
        boolean success = addTaskToDB(task);

        if (success) {
            //2.æ·»åŠ ä»»åŠ¡åˆ°redis
            addTaskToCache(task);
        }


        return task.getTaskId();
    }

    @Autowired
    private CacheService cacheService;

    private void addTaskToCache(Taskinfo task) {
        String key = task.getTaskType() + "_" + task.getPriority();

        //è·å–5åˆ†é’Ÿä¹‹åçš„æ—¶é—´  æ¯«ç§’å€¼
        LocalDateTime now = LocalDateTime.now();
        LocalDateTime nextTime = now.plusMinutes(5);

        //2.1 å¦‚æœä»»åŠ¡çš„æ‰§è¡Œæ—¶é—´å°äºç­‰äºå½“å‰æ—¶é—´ï¼Œå­˜å…¥list
        if (task.getExecuteTime().compareTo(now) <= 0) {
            cacheService.lLeftPush(ScheduleConstants.TOPIC + key, JSON.toJSONString(task));
        } else if (task.getExecuteTime().compareTo(nextTime) <= 0) {
            //2.2 å¦‚æœä»»åŠ¡çš„æ‰§è¡Œæ—¶é—´å¤§äºå½“å‰æ—¶é—´ && å°äºç­‰äºé¢„è®¾æ—¶é—´ï¼ˆæœªæ¥5åˆ†é’Ÿï¼‰ å­˜å…¥zsetä¸­
            cacheService.zAdd(ScheduleConstants.FUTURE + key, JSON.toJSONString(task),
                    task.getExecuteTime().toEpochSecond(ZoneOffset.UTC));
        }

    }

    @Autowired
    private TaskinfoMapper taskinfoMapper;

    @Autowired
    private TaskinfoLogsMapper taskinfoLogsMapper;

    /**
     * æ·»åŠ ä»»åŠ¡åˆ°æ•°æ®åº“ä¸­
     *
     * @param task
     * @return
     */
    private boolean addTaskToDB(Taskinfo task) {

        boolean flag = false;

        try {
            //ä¿å­˜ä»»åŠ¡è¡¨
            Taskinfo taskinfo = new Taskinfo();
            BeanUtils.copyProperties(task, taskinfo);
            taskinfo.setExecuteTime(task.getExecuteTime());
            taskinfoMapper.insert(taskinfo);

            //è®¾ç½®taskID
            task.setTaskId(taskinfo.getTaskId());

            //ä¿å­˜ä»»åŠ¡æ—¥å¿—æ•°æ®
            TaskinfoLogs taskinfoLogs = new TaskinfoLogs();
            BeanUtils.copyProperties(taskinfo, taskinfoLogs);
            taskinfoLogs.setVersion(1);
            taskinfoLogs.setStatus(ScheduleConstants.SCHEDULED);
            taskinfoLogsMapper.insert(taskinfoLogs);

            flag = true;
        } catch (Exception e) {
            e.printStackTrace();
        }

        return flag;
    }
}
```

ScheduleConstants å¸¸é‡ç±»

```java
package com.heima.common.constants;

public class ScheduleConstants {

    //taskçŠ¶æ€
    public static final int SCHEDULED = 0;   //åˆå§‹åŒ–çŠ¶æ€

    public static final int EXECUTED = 1;    //å·²æ‰§è¡ŒçŠ¶æ€

    public static final int CANCELLED = 2;   //å·²å–æ¶ˆçŠ¶æ€

    public static String FUTURE = "future_";   //æœªæ¥æ•°æ®keyå‰ç¼€

    public static String TOPIC = "topic_";     //å½“å‰æ•°æ®keyå‰ç¼€
}
```

<br/>

â‘¡  **TaskinfoMapper**

```java
package com.heima.schedule.mapper;

import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.heima.model.schedule.pojos.Taskinfo;
import org.apache.ibatis.annotations.Mapper;
import org.apache.ibatis.annotations.Param;
import org.apache.ibatis.annotations.Select;

import java.util.Date;
import java.util.List;

/**
 * <p>
 *  Mapper æ¥å£
 * </p>
 *
 * @author itheima
 */
@Mapper
public interface TaskinfoMapper extends BaseMapper<Taskinfo> {

    public List<Taskinfo> queryFutureTime(@Param("taskType")int type, @Param("priority")int priority, @Param("future")Date future);
}

```

**TaskinfoMapper.xml**

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.heima.schedule.mapper.TaskinfoMapper">

    <select id="queryFutureTime" resultType="com.heima.model.schedule.pojos.Taskinfo">
        select *
        from taskinfo
        where task_type = #{taskType}
          and priority = #{priority}
          and execute_time <![CDATA[<]]> #{future,javaType=java.util.Date}
    </select>

</mapper>
```

â‘¢ æµ‹è¯•

<br/>

#### å–æ¶ˆä»»åŠ¡

åœºæ™¯ï¼šç¬¬ä¸‰æ¥å£ç½‘ç»œä¸é€šï¼Œä½¿ç”¨å»¶è¿Ÿä»»åŠ¡è¿›è¡Œé‡è¯•ï¼Œå½“è¾¾åˆ°é˜ˆå€¼ä»¥åï¼Œå–æ¶ˆä»»åŠ¡ã€‚

![image-20240111194218811](assets/image-20240111194218811.png)

åœ¨TaskServiceä¸­æ·»åŠ æ–¹æ³•

```java
/**
* å–æ¶ˆä»»åŠ¡
* @param taskId        ä»»åŠ¡id
* @return              å–æ¶ˆç»“æœ
*/
public boolean cancelTask(long taskId);
```

å®ç°

```java
/**
 * å–æ¶ˆä»»åŠ¡
 * @param taskId
 * @return
 */
@Override
public boolean cancelTask(long taskId) {

    boolean flag = false;

    //åˆ é™¤ä»»åŠ¡ï¼Œæ›´æ–°æ—¥å¿—
    Taskinfo task = updateDB(taskId,ScheduleConstants.EXECUTED);

    //åˆ é™¤redisçš„æ•°æ®
    if(task != null){
        removeTaskFromCache(task);
        flag = true;
    }

    return false;
}

/**
 * åˆ é™¤redisä¸­çš„ä»»åŠ¡æ•°æ®
 * @param task
 */
private void removeTaskFromCache(Taskinfo task) {

    String key = task.getTaskType()+"_"+task.getPriority();

    if(task.getExecuteTime().compareTo(LocalDateTime.now()) <= 0){
        cacheService.lRemove(ScheduleConstants.TOPIC+key,0,JSON.toJSONString(task));
    }else {
        cacheService.zRemove(ScheduleConstants.FUTURE+key, JSON.toJSONString(task));
    }
}

/**
 * åˆ é™¤ä»»åŠ¡ï¼Œæ›´æ–°ä»»åŠ¡æ—¥å¿—çŠ¶æ€
 * @param taskId
 * @param status
 * @return
 */
private Taskinfo updateDB(long taskId, int status) {
    Taskinfo task = null;
    try {
        //åˆ é™¤ä»»åŠ¡
        taskinfoMapper.deleteById(taskId);

        TaskinfoLogs taskinfoLogs = taskinfoLogsMapper.selectById(taskId);
        taskinfoLogs.setStatus(status);
        taskinfoLogsMapper.updateById(taskinfoLogs);

        task = new Taskinfo();
        BeanUtils.copyProperties(taskinfoLogs,task);
        task.setExecuteTime(taskinfoLogs.getExecuteTime());
    }catch (Exception e){
        log.error("task cancel exception taskid={}",taskId);
    }

    return task;

}
```

<br/>

#### æ¶ˆè´¹ä»»åŠ¡

å®ç°æ­¥éª¤

![image-20240111194234984](assets/image-20240111194234984.png)

åœ¨TaskServiceä¸­æ·»åŠ æ–¹æ³•

```java
/**
 * æŒ‰ç…§ç±»å‹å’Œä¼˜å…ˆçº§æ¥æ‹‰å–ä»»åŠ¡
 * @param type
 * @param priority
 * @return
 */
public Taskinfo poll(int type,int priority);
```

å®ç°

```java
/**
 * æŒ‰ç…§ç±»å‹å’Œä¼˜å…ˆçº§æ‹‰å–ä»»åŠ¡
 *
 * @return
 */
@Override
public Taskinfo poll(int type, int priority) {
    Taskinfo task = null;
    try {
        String key = type + "_" + priority;
        String task_json = cacheService.lRightPop(ScheduleConstants.TOPIC + key);
        if (StringUtils.isNotBlank(task_json)) {
            task = JSON.parseObject(task_json, Taskinfo.class);
            //æ›´æ–°æ•°æ®åº“ä¿¡æ¯
            updateDB(task.getTaskId(), ScheduleConstants.EXECUTED);
        }
    } catch (Exception e) {
        e.printStackTrace();
        log.error("poll task exception");
    }

    return task;
}
```

<br/>

#### å®šæ—¶åˆ·æ–°

> ğŸ’¡æ€è€ƒï¼šå®šæ—¶åˆ·æ–°æœ‰ä¸¤ä¸ªé—®é¢˜ã€‚å¦‚ä½•å¤§é‡è·å–æœªæ¥æ•°æ®é˜Ÿåˆ—çš„ Key å€¼ã€‚å¦‚ä½•å°†æœªæ¥æ•°æ®é˜Ÿåˆ—çš„æ•°æ®é«˜æ•ˆç‡çš„å®šæ—¶åˆ·æ–°åˆ°å½“å‰æ¶ˆè´¹é˜Ÿåˆ—ä¸­ã€‚

![image-20240307183800691](assets/image-20240307183800691.png)

<br/>

##### Keyå€¼åŒ¹é…

**æ–¹æ¡ˆ1ï¼škeys æ¨¡ç³ŠåŒ¹é…**

keysçš„æ¨¡ç³ŠåŒ¹é…åŠŸèƒ½å¾ˆæ–¹ä¾¿ä¹Ÿå¾ˆå¼ºå¤§ï¼Œä½†æ˜¯åœ¨ç”Ÿäº§ç¯å¢ƒéœ€è¦æ…ç”¨ï¼å¼€å‘ä¸­ä½¿ç”¨keysçš„æ¨¡ç³ŠåŒ¹é…å´å‘ç°redisçš„CPUä½¿ç”¨ç‡æé«˜ï¼Œæ‰€ä»¥å…¬å¸çš„redisç”Ÿäº§ç¯å¢ƒå°†keyså‘½ä»¤ç¦ç”¨äº†ï¼redisæ˜¯å•çº¿ç¨‹ï¼Œä¼šè¢«å µå¡

![image-20240303151712243](assets/image-20240303151712243.png)

**æ–¹æ¡ˆ2ï¼šscan** 

SCAN å‘½ä»¤æ˜¯ä¸€ä¸ªåŸºäºæ¸¸æ ‡çš„è¿­ä»£å™¨ï¼ŒSCANå‘½ä»¤æ¯æ¬¡è¢«è°ƒç”¨ä¹‹åï¼Œ éƒ½ä¼šå‘ç”¨æˆ·è¿”å›ä¸€ä¸ªæ–°çš„æ¸¸æ ‡ï¼Œ ç”¨æˆ·åœ¨ä¸‹æ¬¡è¿­ä»£æ—¶éœ€è¦ä½¿ç”¨è¿™ä¸ªæ–°æ¸¸æ ‡ä½œä¸ºSCANå‘½ä»¤çš„æ¸¸æ ‡å‚æ•°ï¼Œ ä»¥æ­¤æ¥å»¶ç»­ä¹‹å‰çš„è¿­ä»£è¿‡ç¨‹ã€‚

![image-20240303151726975](assets/image-20240303151726975.png)

ä»£ç æ¡ˆä¾‹ï¼š

```java
@Test
public void testKeys(){
    Set<String> keys = cacheService.keys("future_*");
    System.out.println(keys);

    Set<String> scan = cacheService.scan("future_*");
    System.out.println(scan);
}
```

<br/>

##### Reidsç®¡é“

æ™®é€šrediså®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨äº¤äº’æ¨¡å¼

![image-20240303151749153](assets/image-20240303151749153.png)

Pipelineè¯·æ±‚æ¨¡å‹

![image-20240303151805151](assets/image-20240303151805151.png)

<br/>

æµ‹è¯•æ¡ˆä¾‹å¯¹æ¯”ï¼š

```java
//è€—æ—¶6151
@Test
public  void testPiple1(){
    long start =System.currentTimeMillis();
    for (int i = 0; i <10000 ; i++) {
        Task task = new Task();
        task.setTaskType(1001);
        task.setPriority(1);
        task.setExecuteTime(new Date().getTime());
        cacheService.lLeftPush("1001_1", JSON.toJSONString(task));
    }
    System.out.println("è€—æ—¶"+(System.currentTimeMillis()- start));
}


@Test
public void testPiple2(){
    long start  = System.currentTimeMillis();
    //ä½¿ç”¨ç®¡é“æŠ€æœ¯
    List<Object> objectList = cacheService.getstringRedisTemplate().executePipelined(new RedisCallback<Object>() {
        @Nullable
        @Override
        public Object doInRedis(RedisConnection redisConnection) throws DataAccessException {
            for (int i = 0; i <10000 ; i++) {
                Task task = new Task();
                task.setTaskType(1001);
                task.setPriority(1);
                task.setExecuteTime(new Date().getTime());
                redisConnection.lPush("1001_1".getBytes(), JSON.toJSONString(task).getBytes());
            }
            return null;
        }
    });
    System.out.println("ä½¿ç”¨ç®¡é“æŠ€æœ¯æ‰§è¡Œ10000æ¬¡è‡ªå¢æ“ä½œå…±è€—æ—¶:"+(System.currentTimeMillis()-start)+"æ¯«ç§’");
}
```

<br/>

##### å®ç°æ­¥éª¤

![image-20240111194258276](assets/image-20240111194258276.png)

åœ¨ TaskServiceImpl ä¸­æ·»åŠ æ–¹æ³•

```java
@Scheduled(cron = "0 */1 * * * ?")
public void refresh() {
    
    log.debug( "æ‰§è¡Œå®šæ—¶ä»»åŠ¡çš„æ—¶é—´:{}",System.currentTimeMillis() / 1000);

    // è·å–æ‰€æœ‰æœªæ¥æ•°æ®é›†åˆçš„keyå€¼
    Set<String> futureKeys = cacheService.scan(ScheduleConstants.FUTURE + "*");// future_*
    for (String futureKey : futureKeys) { // future_250_250

        String topicKey = ScheduleConstants.TOPIC + futureKey.split(ScheduleConstants.FUTURE)[1];
        //è·å–è¯¥ç»„keyä¸‹å½“å‰éœ€è¦æ¶ˆè´¹çš„ä»»åŠ¡æ•°æ®
        Set<String> tasks = cacheService.zRangeByScore(futureKey, 0, System.currentTimeMillis());
        if (!tasks.isEmpty()) {
            //å°†è¿™äº›ä»»åŠ¡æ•°æ®æ·»åŠ åˆ°æ¶ˆè´¹è€…é˜Ÿåˆ—ä¸­
            cacheService.refreshWithPipeline(futureKey, topicKey, tasks);
            log.debug("æˆåŠŸçš„å°†:{}ä¸‹çš„å½“å‰éœ€è¦æ‰§è¡Œçš„ä»»åŠ¡æ•°æ®åˆ·æ–°åˆ°:{}ä¸‹", futureKey, topicKey);
        }
    }
}
```

åœ¨å¼•å¯¼ç±»ä¸­æ·»åŠ å¼€å¯ä»»åŠ¡è°ƒåº¦æ³¨è§£ï¼š`@EnableScheduling`



<br/>

#### åˆ†å¸ƒå¼é—®é¢˜

åˆ†å¸ƒå¼é”è§£å†³é›†ç¾¤ä¸‹çš„æ–¹æ³•æŠ¢å æ‰§è¡Œ

> é—®é¢˜æè¿°ï¼šå¯åŠ¨ä¸¤å° `heima-leadnews-schedule` æœåŠ¡ï¼Œæ¯å°æœåŠ¡éƒ½ä¼šå»æ‰§è¡Œrefreshå®šæ—¶ä»»åŠ¡æ–¹æ³•

![image-20240303151849043](assets/image-20240303151849043.png)

<br/>

##### åˆ†å¸ƒå¼é”

æ§åˆ¶åˆ†å¸ƒå¼ç³»ç»Ÿæœ‰åºçš„å»å¯¹å…±äº«èµ„æºè¿›è¡Œæ“ä½œï¼Œé€šè¿‡äº’æ–¥æ¥ä¿è¯æ•°æ®çš„ä¸€è‡´æ€§ã€‚

è§£å†³æ–¹æ¡ˆï¼š

![image-20240303151905196](assets/image-20240303151905196.png)

<br/>

##### Rediså®ç°åˆ†å¸ƒå¼é”

sexnx ï¼ˆSET if Not eXistsï¼‰ å‘½ä»¤åœ¨æŒ‡å®šçš„ key ä¸å­˜åœ¨æ—¶ï¼Œä¸º key è®¾ç½®æŒ‡å®šçš„å€¼ã€‚

![image-20240303152131502](assets/image-20240303152131502.png)

è¿™ç§åŠ é”çš„æ€è·¯æ˜¯ï¼Œå¦‚æœ key ä¸å­˜åœ¨åˆ™ä¸º key è®¾ç½® valueï¼Œå¦‚æœ key å·²å­˜åœ¨åˆ™ SETNX å‘½ä»¤ä¸åšä»»ä½•æ“ä½œ

- å®¢æˆ·ç«¯Aè¯·æ±‚æœåŠ¡å™¨è®¾ç½®keyçš„å€¼ï¼Œå¦‚æœè®¾ç½®æˆåŠŸå°±è¡¨ç¤ºåŠ é”æˆåŠŸ
- å®¢æˆ·ç«¯Bä¹Ÿå»è¯·æ±‚æœåŠ¡å™¨è®¾ç½®keyçš„å€¼ï¼Œå¦‚æœè¿”å›å¤±è´¥ï¼Œé‚£ä¹ˆå°±ä»£è¡¨åŠ é”å¤±è´¥
- å®¢æˆ·ç«¯Aæ‰§è¡Œä»£ç å®Œæˆï¼Œåˆ é™¤é”
- å®¢æˆ·ç«¯Båœ¨ç­‰å¾…ä¸€æ®µæ—¶é—´åå†å»è¯·æ±‚è®¾ç½®keyçš„å€¼ï¼Œè®¾ç½®æˆåŠŸ
- å®¢æˆ·ç«¯Bæ‰§è¡Œä»£ç å®Œæˆï¼Œåˆ é™¤é”

<br/>

**åœ¨å·¥å…·ç±»CacheServiceä¸­æ·»åŠ æ–¹æ³•**

```java
/**
 * åŠ é”
 *
 * @param name
 * @param expire
 * @return
 */
public String tryLock(String name, long expire) {
    name = name + "_lock";
    String token = UUID.randomUUID().toString();
    RedisConnectionFactory factory = stringRedisTemplate.getConnectionFactory();
    RedisConnection conn = factory.getConnection();
    try {

        //å‚è€ƒrediså‘½ä»¤ï¼š
        //set key value [EX seconds] [PX milliseconds] [NX|XX]
        Boolean result = conn.set(
                name.getBytes(),
                token.getBytes(),
                Expiration.from(expire, TimeUnit.MILLISECONDS),
                RedisStringCommands.SetOption.SET_IF_ABSENT //NX
        );
        if (result != null && result)
            return token;
    } finally {
        RedisConnectionUtils.releaseConnection(conn, factory,false);
    }
    return null;
}
```

ä¿®æ”¹æœªæ¥æ•°æ®å®šæ—¶åˆ·æ–°çš„æ–¹æ³•ï¼Œå¦‚ä¸‹ï¼š

```java
/**
 * å°†Redisä¸­çš„ZSETæ•°æ®å®šæ—¶åŒæ­¥åˆ°Listä¸­ï¼Œæ¯åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡
 */
@Scheduled(cron = "0 */1 * * * ?")
public void refresh() {
    // é”è‡ªåŠ¨é‡Šæ”¾
    String token = cacheService.tryLock("FUTURE_TASK_SYNC", 1000 * 30);

    if (StringUtils.isBlank(token)) {
        return;
    }

    log.debug( "æ‰§è¡Œå®šæ—¶ä»»åŠ¡çš„æ—¶é—´:{}",System.currentTimeMillis() / 1000);

    // è·å–æ‰€æœ‰æœªæ¥æ•°æ®é›†åˆçš„keyå€¼
    Set<String> futureKeys = cacheService.scan(ScheduleConstants.FUTURE + "*");// future_*
    for (String futureKey : futureKeys) { // future_250_250

        String topicKey = ScheduleConstants.TOPIC + futureKey.split(ScheduleConstants.FUTURE)[1];
        //è·å–è¯¥ç»„keyä¸‹å½“å‰éœ€è¦æ¶ˆè´¹çš„ä»»åŠ¡æ•°æ®
        Set<String> tasks = cacheService.zRangeByScore(futureKey, 0, System.currentTimeMillis());
        if (!tasks.isEmpty()) {
            //å°†è¿™äº›ä»»åŠ¡æ•°æ®æ·»åŠ åˆ°æ¶ˆè´¹è€…é˜Ÿåˆ—ä¸­
            cacheService.refreshWithPipeline(futureKey, topicKey, tasks);
            log.debug("æˆåŠŸçš„å°†:{}ä¸‹çš„å½“å‰éœ€è¦æ‰§è¡Œçš„ä»»åŠ¡æ•°æ®åˆ·æ–°åˆ°:{}ä¸‹", futureKey, topicKey);
        }
    }
}
```

<br/>



#### å®šæ—¶åŒæ­¥

æ•°æ®åº“çš„æ•°æ®å®šæ—¶åŒæ­¥åˆ°Redis

![image-20240307183902231](assets/image-20240307183902231.png)

```java
/**
 * å®šæ—¶å°†æ•°æ®åº“çš„æ•°æ®åŒæ­¥åˆ°ç¼“å­˜ä¸­ï¼Œæ¯äº”åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡
 */
@Scheduled(cron = "0 */5 * * * ?")
@PostConstruct
public void reloadData() {
    clearCache();

    log.info("æ•°æ®åº“æ•°æ®åŒæ­¥åˆ°ç¼“å­˜");
    Calendar calendar = Calendar.getInstance();
    calendar.add(Calendar.MINUTE, 5);

    //æŸ¥çœ‹å°äºæœªæ¥5åˆ†é’Ÿçš„æ‰€æœ‰ä»»åŠ¡
    List<Taskinfo> allTasks = taskinfoMapper.selectList(Wrappers.<Taskinfo>lambdaQuery()
            .lt(Taskinfo::getExecuteTime, calendar.getTime()));
    if (allTasks != null && allTasks.size() > 0) {
        for (Taskinfo taskinfo : allTasks) {
            Taskinfo task = new Taskinfo();
            BeanUtils.copyProperties(taskinfo, task);
            task.setExecuteTime(taskinfo.getExecuteTime());
            addTaskToCache(task);
        }
    }
}

private void clearCache() {
    // åˆ é™¤ç¼“å­˜ä¸­æœªæ¥æ•°æ®é›†åˆå’Œå½“å‰æ¶ˆè´¹è€…é˜Ÿåˆ—çš„æ‰€æœ‰key
    Set<String> futurekeys = cacheService.scan(ScheduleConstants.FUTURE + "*");// future_
    Set<String> topickeys = cacheService.scan(ScheduleConstants.TOPIC + "*");// topic_
    cacheService.delete(futurekeys);
    cacheService.delete(topickeys);
}
```

<br/>

::: details TaskinfoServiceImpl å®Œæ•´ç±»

```java
package com.heima.schedule.service.impl;

import com.alibaba.fastjson.JSON;
import com.baomidou.mybatisplus.core.toolkit.Wrappers;
import com.heima.common.constants.ScheduleConstants;
import com.heima.common.redis.CacheService;
import com.heima.model.schedule.pojos.Taskinfo;
import com.heima.model.schedule.pojos.TaskinfoLogs;
import com.heima.schedule.mapper.TaskinfoLogsMapper;
import com.heima.schedule.mapper.TaskinfoMapper;
import com.heima.schedule.service.ITaskinfoService;
import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import lombok.extern.slf4j.Slf4j;
import org.apache.commons.lang3.StringUtils;
import org.springframework.beans.BeanUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.scheduling.annotation.Scheduled;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import javax.annotation.PostConstruct;
import java.time.LocalDateTime;
import java.time.ZoneOffset;
import java.util.Calendar;
import java.util.Date;
import java.util.List;
import java.util.Set;

/**
 * <p>
 * æœåŠ¡å®ç°ç±»
 * </p>
 *
 * @author mousse
 * @since 2024-03-07
 */
@Service
@Transactional
@Slf4j
public class TaskinfoServiceImpl extends ServiceImpl<TaskinfoMapper, Taskinfo> implements ITaskinfoService {

    /**
     * å®šæ—¶å°†æ•°æ®åº“çš„æ•°æ®åŒæ­¥åˆ°ç¼“å­˜ä¸­ï¼Œæ¯äº”åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡
     */
    @Scheduled(cron = "0 */5 * * * ?")
    @PostConstruct
    public void reloadData() {
        clearCache();

        log.info("æ•°æ®åº“æ•°æ®åŒæ­¥åˆ°ç¼“å­˜");
        Calendar calendar = Calendar.getInstance();
        calendar.add(Calendar.MINUTE, 5);

        //æŸ¥çœ‹å°äºæœªæ¥5åˆ†é’Ÿçš„æ‰€æœ‰ä»»åŠ¡
        List<Taskinfo> allTasks = taskinfoMapper.selectList(Wrappers.<Taskinfo>lambdaQuery()
                .lt(Taskinfo::getExecuteTime, calendar.getTime()));
        if (allTasks != null && allTasks.size() > 0) {
            for (Taskinfo taskinfo : allTasks) {
                Taskinfo task = new Taskinfo();
                BeanUtils.copyProperties(taskinfo, task);
                task.setExecuteTime(taskinfo.getExecuteTime());
                addTaskToCache(task);
            }
        }
    }

    private void clearCache() {
        // åˆ é™¤ç¼“å­˜ä¸­æœªæ¥æ•°æ®é›†åˆå’Œå½“å‰æ¶ˆè´¹è€…é˜Ÿåˆ—çš„æ‰€æœ‰key
        Set<String> futurekeys = cacheService.scan(ScheduleConstants.FUTURE + "*");// future_
        Set<String> topickeys = cacheService.scan(ScheduleConstants.TOPIC + "*");// topic_
        cacheService.delete(futurekeys);
        cacheService.delete(topickeys);
    }

    /**
     * å°†Redisä¸­çš„ZSETæ•°æ®å®šæ—¶åŒæ­¥åˆ°Listä¸­
     */
    @Scheduled(cron = "0 */1 * * * ?")
    public void refresh() {
        String token = cacheService.tryLock("FUTURE_TASK_SYNC", 1000 * 30);

        if (StringUtils.isBlank(token)) {
            return;
        }

        log.debug("æ‰§è¡Œå®šæ—¶ä»»åŠ¡çš„æ—¶é—´:{}", System.currentTimeMillis() / 1000);

        // è·å–æ‰€æœ‰æœªæ¥æ•°æ®é›†åˆçš„keyå€¼
        Set<String> futureKeys = cacheService.scan(ScheduleConstants.FUTURE + "*");// future_*
        for (String futureKey : futureKeys) { // future_250_250

            String topicKey = ScheduleConstants.TOPIC + futureKey.split(ScheduleConstants.FUTURE)[1];
            //è·å–è¯¥ç»„keyä¸‹å½“å‰éœ€è¦æ¶ˆè´¹çš„ä»»åŠ¡æ•°æ®
            Set<String> tasks = cacheService.zRangeByScore(futureKey, 0, System.currentTimeMillis());
            if (!tasks.isEmpty()) {
                //å°†è¿™äº›ä»»åŠ¡æ•°æ®æ·»åŠ åˆ°æ¶ˆè´¹è€…é˜Ÿåˆ—ä¸­
                cacheService.refreshWithPipeline(futureKey, topicKey, tasks);
                log.debug("æˆåŠŸçš„å°†:{}ä¸‹çš„å½“å‰éœ€è¦æ‰§è¡Œçš„ä»»åŠ¡æ•°æ®åˆ·æ–°åˆ°:{}ä¸‹", futureKey, topicKey);
            }
        }
    }

    @Override
    public long addTask(Taskinfo task) {
        //1.æ·»åŠ ä»»åŠ¡åˆ°æ•°æ®åº“ä¸­
        boolean success = addTaskToDB(task);

        if (success) {
            //2.æ·»åŠ ä»»åŠ¡åˆ°redis
            addTaskToCache(task);
        }


        return task.getTaskId();
    }

    /**
     * å–æ¶ˆä»»åŠ¡
     *
     * @param taskId
     * @return
     */
    @Override
    public boolean cancelTask(long taskId) {

        boolean flag = false;

        //åˆ é™¤ä»»åŠ¡ï¼Œæ›´æ–°æ—¥å¿—
        Taskinfo task = updateDB(taskId, ScheduleConstants.EXECUTED);

        //åˆ é™¤redisçš„æ•°æ®
        if (task != null) {
            removeTaskFromCache(task);
            flag = true;
        }

        return false;
    }

    /**
     * æŒ‰ç…§ç±»å‹å’Œä¼˜å…ˆçº§æ‹‰å–ä»»åŠ¡
     *
     * @return
     */
    @Override
    public Taskinfo poll(int type, int priority) {
        Taskinfo task = null;
        try {
            String key = type + "_" + priority;
            String task_json = cacheService.lRightPop(ScheduleConstants.TOPIC + key);
            if (StringUtils.isNotBlank(task_json)) {
                task = JSON.parseObject(task_json, Taskinfo.class);
                //æ›´æ–°æ•°æ®åº“ä¿¡æ¯
                updateDB(task.getTaskId(), ScheduleConstants.EXECUTED);
            }
        } catch (Exception e) {
            e.printStackTrace();
            log.error("poll task exception");
        }

        return task;
    }

    /**
     * åˆ é™¤redisä¸­çš„ä»»åŠ¡æ•°æ®
     *
     * @param task
     */
    private void removeTaskFromCache(Taskinfo task) {

        String key = task.getTaskType() + "_" + task.getPriority();

        if (task.getExecuteTime().compareTo(LocalDateTime.now()) <= 0) {
            cacheService.lRemove(ScheduleConstants.TOPIC + key, 0, JSON.toJSONString(task));
        } else {
            cacheService.zRemove(ScheduleConstants.FUTURE + key, JSON.toJSONString(task));
        }
    }

    /**
     * åˆ é™¤ä»»åŠ¡ï¼Œæ›´æ–°ä»»åŠ¡æ—¥å¿—çŠ¶æ€
     *
     * @param taskId
     * @param status
     * @return
     */
    private Taskinfo updateDB(long taskId, int status) {
        Taskinfo task = null;
        try {
            //åˆ é™¤ä»»åŠ¡
            taskinfoMapper.deleteById(taskId);

            TaskinfoLogs taskinfoLogs = taskinfoLogsMapper.selectById(taskId);
            taskinfoLogs.setStatus(status);
            taskinfoLogsMapper.updateById(taskinfoLogs);

            task = new Taskinfo();
            BeanUtils.copyProperties(taskinfoLogs, task);
            task.setExecuteTime(taskinfoLogs.getExecuteTime());
        } catch (Exception e) {
            log.error("task cancel exception taskid={}", taskId);
        }

        return task;

    }

    @Autowired
    private CacheService cacheService;

    private void addTaskToCache(Taskinfo task) {
        String key = task.getTaskType() + "_" + task.getPriority();

        //è·å–5åˆ†é’Ÿä¹‹åçš„æ—¶é—´  æ¯«ç§’å€¼
        LocalDateTime now = LocalDateTime.now();
        LocalDateTime nextTime = now.plusMinutes(5);

        //2.1 å¦‚æœä»»åŠ¡çš„æ‰§è¡Œæ—¶é—´å°äºç­‰äºå½“å‰æ—¶é—´ï¼Œå­˜å…¥list
        if (task.getExecuteTime().compareTo(now) <= 0) {
            cacheService.lLeftPush(ScheduleConstants.TOPIC + key, JSON.toJSONString(task));
        } else if (task.getExecuteTime().compareTo(nextTime) <= 0) {
            //2.2 å¦‚æœä»»åŠ¡çš„æ‰§è¡Œæ—¶é—´å¤§äºå½“å‰æ—¶é—´ && å°äºç­‰äºé¢„è®¾æ—¶é—´ï¼ˆæœªæ¥5åˆ†é’Ÿï¼‰ å­˜å…¥zsetä¸­
            cacheService.zAdd(ScheduleConstants.FUTURE + key, JSON.toJSONString(task),
                    task.getExecuteTime().toEpochSecond(ZoneOffset.UTC));
        }

    }

    @Autowired
    private TaskinfoMapper taskinfoMapper;

    @Autowired
    private TaskinfoLogsMapper taskinfoLogsMapper;

    /**
     * æ·»åŠ ä»»åŠ¡åˆ°æ•°æ®åº“ä¸­
     *
     * @param task
     * @return
     */
    private boolean addTaskToDB(Taskinfo task) {

        boolean flag = false;

        try {
            //ä¿å­˜ä»»åŠ¡è¡¨
            Taskinfo taskinfo = new Taskinfo();
            BeanUtils.copyProperties(task, taskinfo);
            taskinfo.setExecuteTime(task.getExecuteTime());
            taskinfoMapper.insert(taskinfo);

            //è®¾ç½®taskID
            task.setTaskId(taskinfo.getTaskId());

            //ä¿å­˜ä»»åŠ¡æ—¥å¿—æ•°æ®
            TaskinfoLogs taskinfoLogs = new TaskinfoLogs();
            BeanUtils.copyProperties(taskinfo, taskinfoLogs);
            taskinfoLogs.setVersion(1);
            taskinfoLogs.setStatus(ScheduleConstants.SCHEDULED);
            taskinfoLogsMapper.insert(taskinfoLogs);

            flag = true;
        } catch (Exception e) {
            e.printStackTrace();
        }

        return flag;
    }


}

```

:::

<br/>

### æ–‡ç« å»¶è¿Ÿå‘å¸ƒ

::: tip ğŸ”–å®ç°æ­¥éª¤

- å°†å°è£…çš„å»¶è¿Ÿé˜Ÿåˆ—æœåŠ¡æä¾›å¯¹å¤–æ¥å£ï¼Œä¾›è‡ªåª’ä½“æœåŠ¡ä½¿ç”¨
- è‡ªåª’ä½“æœåŠ¡çš„å‘å¸ƒæ–‡ç« åŠŸèƒ½å°†å®¡æ ¸æ–‡ç« åŠŸèƒ½æ·»åŠ åˆ°å»¶è¿Ÿé˜Ÿåˆ—æ¥å£ä¸­
- è‡ªåª’ä½“æœåŠ¡æ·»åŠ å®šæ—¶ä»»åŠ¡å®šæ—¶æ‰§è¡Œæ¶ˆè´¹å®¡æ ¸æ–‡ç« çš„æ¥å£

:::

**å»¶è¿Ÿé˜Ÿåˆ—æœåŠ¡æä¾›å¯¹å¤–æ¥å£**

![image-20240111194323044](assets/image-20240111194323044.png)

```xml
<dependency>
        <groupId>org.springframework.cloud</groupId>
        <artifactId>spring-cloud-openfeign-core</artifactId>
        <version>2.2.7.RELEASE</version>
</dependency>
```

æä¾›è¿œç¨‹çš„feignæ¥å£ï¼Œåœ¨`heima-leadnews-feign-api` ç¼–å†™ç±»å¦‚ä¸‹ï¼š

```java
package com.heima.apis.schedule;

import com.heima.model.common.dtos.ResponseResult;
import com.heima.model.schedule.pojos.Taskinfo;
import org.springframework.cloud.openfeign.FeignClient;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;

@FeignClient("leadnews-schedule")
public interface IScheduleClient {

    /**
     * æ·»åŠ ä»»åŠ¡
     * @param task   ä»»åŠ¡å¯¹è±¡
     * @return       ä»»åŠ¡id
     */
    @PostMapping("/api/v1/task/add")
    public ResponseResult  addTask(@RequestBody Taskinfo task);

    /**
     * å–æ¶ˆä»»åŠ¡
     * @param taskId        ä»»åŠ¡id
     * @return              å–æ¶ˆç»“æœ
     */
    @GetMapping("/api/v1/task/cancel/{taskId}")
    public ResponseResult cancelTask(@PathVariable("taskId") long taskId);

    /**
     * æŒ‰ç…§ç±»å‹å’Œä¼˜å…ˆçº§æ¥æ‹‰å–ä»»åŠ¡
     * @param type
     * @param priority
     * @return
     */
    @GetMapping("/api/v1/task/poll/{type}/{priority}")
    public ResponseResult poll(@PathVariable("type") int type,@PathVariable("priority")  int priority);
}
```

åœ¨ `heima-leadnews-schedule` å¾®æœåŠ¡ä¸‹æä¾›å¯¹åº”çš„å®ç°

```java
package com.heima.schedule.client;

import com.heima.apis.schedule.IScheduleClient;
import com.heima.model.common.dtos.ResponseResult;
import com.heima.model.schedule.pojos.Taskinfo;
import com.heima.schedule.service.ITaskinfoService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;


@RestController
public class ScheduleClient implements IScheduleClient {

    @Autowired
    private ITaskinfoService taskService;

    /**
     * æ·»åŠ ä»»åŠ¡
     *
     * @param task ä»»åŠ¡å¯¹è±¡
     * @return ä»»åŠ¡id
     */
    @PostMapping("/api/v1/task/add")
    @Override
    public ResponseResult addTask(@RequestBody Taskinfo task) {
        return ResponseResult.okResult(taskService.addTask(task));
    }

    /**
     * å–æ¶ˆä»»åŠ¡
     *
     * @param taskId ä»»åŠ¡id
     * @return å–æ¶ˆç»“æœ
     */
    @GetMapping("/api/v1/task/cancel/{taskId}")
    @Override
    public ResponseResult cancelTask(@PathVariable("taskId") long taskId) {
        return ResponseResult.okResult(taskService.cancelTask(taskId));
    }

    /**
     * æŒ‰ç…§ç±»å‹å’Œä¼˜å…ˆçº§æ¥æ‹‰å–ä»»åŠ¡
     *
     * @param type
     * @param priority
     * @return
     */
    @GetMapping("/api/v1/task/poll/{type}/{priority}")
    @Override
    public ResponseResult poll(@PathVariable("type") int type, @PathVariable("priority") int priority) {
        return ResponseResult.okResult(taskService.poll(type, priority));
    }
}
```

<br/>

**å‘å¸ƒæ–‡ç« é›†æˆæ·»åŠ å»¶è¿Ÿé˜Ÿåˆ—æ¥å£**

![image-20240111194345225](assets/image-20240111194345225.png)

åœ¨åˆ›å»ºWmNewsTaskService

```java
package com.heima.wemedia.service;

import java.util.Date;


public interface WmNewsTaskService {

    /**
     * æ·»åŠ ä»»åŠ¡åˆ°å»¶è¿Ÿé˜Ÿåˆ—ä¸­
     * @param id  æ–‡ç« çš„id
     * @param publishTime  å‘å¸ƒçš„æ—¶é—´  å¯ä»¥åšä¸ºä»»åŠ¡çš„æ‰§è¡Œæ—¶é—´
     */
    public void addNewsToTask(Integer id, Date publishTime);

}
```

å®ç°ï¼š

```java
package com.heima.wemedia.service.impl;

import com.heima.apis.schedule.IScheduleClient;
import com.heima.common.enums.TaskTypeEnum;
import com.heima.model.schedule.pojos.Taskinfo;
import com.heima.model.wemedia.pojos.WmNews;
import com.heima.utils.common.ProtostuffUtil;
import com.heima.wemedia.service.WmNewsTaskService;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.scheduling.annotation.Async;
import org.springframework.stereotype.Service;

import java.time.LocalDateTime;
import java.util.Date;


@Service
@Slf4j
public class WmNewsTaskServiceImpl  implements WmNewsTaskService {


    @Autowired
    private IScheduleClient scheduleClient;

    /**
     * æ·»åŠ ä»»åŠ¡åˆ°å»¶è¿Ÿé˜Ÿåˆ—ä¸­
     * @param id          æ–‡ç« çš„id
     * @param publishTime å‘å¸ƒçš„æ—¶é—´  å¯ä»¥åšä¸ºä»»åŠ¡çš„æ‰§è¡Œæ—¶é—´
     */
    @Override
    @Async
    public void addNewsToTask(Integer id, LocalDateTime publishTime) {

        log.info("æ·»åŠ ä»»åŠ¡åˆ°å»¶è¿ŸæœåŠ¡ä¸­----begin");

        Taskinfo task = new Taskinfo();
        task.setExecuteTime(publishTime);
        task.setTaskType(TaskTypeEnum.NEWS_SCAN_TIME.getTaskType());
        task.setPriority(TaskTypeEnum.NEWS_SCAN_TIME.getPriority());
        WmNews wmNews = new WmNews();
        wmNews.setId(id);
        task.setParameters(ProtostuffUtil.serialize(wmNews));

        scheduleClient.addTask(task);

        log.info("æ·»åŠ ä»»åŠ¡åˆ°å»¶è¿ŸæœåŠ¡ä¸­----end");

    }
    
}
```

<br/>

æšä¸¾ç±»ï¼š

```java
package com.heima.model.common.enums;

import lombok.AllArgsConstructor;
import lombok.Getter;

@Getter
@AllArgsConstructor
public enum TaskTypeEnum {

    NEWS_SCAN_TIME(1001, 1,"æ–‡ç« å®šæ—¶å®¡æ ¸"),
    REMOTEERROR(1002, 2,"ç¬¬ä¸‰æ–¹æ¥å£è°ƒç”¨å¤±è´¥ï¼Œé‡è¯•");
    private final int taskType; //å¯¹åº”å…·ä½“ä¸šåŠ¡
    private final int priority; //ä¸šåŠ¡ä¸åŒçº§åˆ«
    private final String desc; //æè¿°ä¿¡æ¯
}
```

<br/>

ä¿®æ”¹ Taskinfo å­—æ®µ

```java {40}
package com.heima.model.schedule.pojos;

import com.baomidou.mybatisplus.annotation.TableName;
import com.baomidou.mybatisplus.annotation.IdType;
import java.time.LocalDateTime;
import com.baomidou.mybatisplus.annotation.TableId;
import java.sql.Blob;
import java.io.Serializable;
import io.swagger.annotations.ApiModel;
import io.swagger.annotations.ApiModelProperty;
import lombok.Data;
import lombok.EqualsAndHashCode;
import lombok.experimental.Accessors;

/**
 * <p>
 * 
 * </p>
 *
 * @author mousse
 * @since 2024-03-07
 */
@Data
@EqualsAndHashCode(callSuper = false)
@Accessors(chain = true)
@TableName("taskinfo")
@ApiModel(value="Taskinfoå¯¹è±¡", description="")
public class Taskinfo implements Serializable {

    private static final long serialVersionUID = 1L;

    @ApiModelProperty(value = "ä»»åŠ¡id")
    @TableId(value = "task_id", type = IdType.ASSIGN_ID)
    private Long taskId;

    @ApiModelProperty(value = "æ‰§è¡Œæ—¶é—´")
    private LocalDateTime executeTime;

    @ApiModelProperty(value = "å‚æ•°")
    private byte[] parameters;

    @ApiModelProperty(value = "ä¼˜å…ˆçº§")
    private Integer priority;

    @ApiModelProperty(value = "ä»»åŠ¡ç±»å‹")
    private Integer taskType;
    
}
```

<br/>

åºåˆ—åŒ–å·¥å…·å¯¹æ¯”

- JdkSerializeï¼šJava å†…ç½®çš„åºåˆ—åŒ–èƒ½å°†å®ç°äº† Serilazable æ¥å£çš„å¯¹è±¡è¿›è¡Œåºåˆ—åŒ–å’Œååºåˆ—åŒ–ï¼Œ ObjectOutputStream çš„ writeObject() æ–¹æ³•å¯åºåˆ—åŒ–å¯¹è±¡ç”Ÿæˆå­—èŠ‚æ•°ç»„

  :::details JdkSerialize

  ```java
  package com.heima.utils.common;
  
  import java.io.ByteArrayInputStream;
  import java.io.ByteArrayOutputStream;
  import java.io.ObjectInputStream;
  import java.io.ObjectOutputStream;
  
  /**
   * jdkåºåˆ—åŒ–
   */
  public class JdkSerializeUtil {
  
      /**
       * åºåˆ—åŒ–
       * @param obj
       * @param <T>
       * @return
       */
      public static <T> byte[] serialize(T obj) {
  
          if (obj  == null){
              throw new NullPointerException();
          }
  
          ByteArrayOutputStream bos = new ByteArrayOutputStream();
          try {
              ObjectOutputStream oos = new ObjectOutputStream(bos);
  
              oos.writeObject(obj);
              return bos.toByteArray();
          } catch (Exception ex) {
              ex.printStackTrace();
          }
          return new byte[0];
      }
  
      /**
       * ååºåˆ—åŒ–
       * @param data
       * @param clazz
       * @param <T>
       * @return
       */
      public static <T> T deserialize(byte[] data, Class<T> clazz) {
          ByteArrayInputStream bis = new ByteArrayInputStream(data);
  
          try {
              ObjectInputStream ois = new ObjectInputStream(bis);
              T obj = (T)ois.readObject();
              return obj;
          } catch (Exception ex) {
              ex.printStackTrace();
          }
  
          return  null;
      }
  }
  ```

  :::

- Protostuffï¼šgoogle å¼€æºçš„ protostuff é‡‡ç”¨æ›´ä¸ºç´§å‡‘çš„äºŒè¿›åˆ¶æ•°ç»„ï¼Œè¡¨ç°æ›´åŠ ä¼˜å¼‚ï¼Œç„¶åä½¿ç”¨protostuff çš„ç¼–è¯‘å·¥å…·ç”Ÿæˆpojoç±»

  :::details Protostuff

  ```java
  package com.heima.utils.common;
  
  
  import com.heima.model.wemedia.pojos.WmNews;
  import io.protostuff.LinkedBuffer;
  import io.protostuff.ProtostuffIOUtil;
  import io.protostuff.Schema;
  import io.protostuff.runtime.RuntimeSchema;
  
  public class ProtostuffUtil {
  
      /**
       * åºåˆ—åŒ–
       * @param t
       * @param <T>
       * @return
       */
      public static <T> byte[] serialize(T t){
          Schema schema = RuntimeSchema.getSchema(t.getClass());
          return ProtostuffIOUtil.toByteArray(t,schema,
                  LinkedBuffer.allocate(LinkedBuffer.DEFAULT_BUFFER_SIZE));
   
      }
  
      /**
       * ååºåˆ—åŒ–
       * @param bytes
       * @param c
       * @param <T>
       * @return
       */
      public static <T> T deserialize(byte []bytes,Class<T> c) {
          T t = null;
          try {
              t = c.newInstance();
              Schema schema = RuntimeSchema.getSchema(t.getClass());
               ProtostuffIOUtil.mergeFrom(bytes,t,schema);
          } catch (InstantiationException e) {
              e.printStackTrace();
          } catch (IllegalAccessException e) {
              e.printStackTrace();
          }
          return t;
      }
  
      /**
       * jdkåºåˆ—åŒ–ä¸protostuffåºåˆ—åŒ–å¯¹æ¯”
       * @param args
       */
      public static void main(String[] args) {
          long start =System.currentTimeMillis();
          for (int i = 0; i <1000000 ; i++) {
              WmNews wmNews =new WmNews();
              JdkSerializeUtil.serialize(wmNews);
          }
          System.out.println(" jdk èŠ±è´¹ "+(System.currentTimeMillis()-start));
  
          start =System.currentTimeMillis();
          for (int i = 0; i <1000000 ; i++) {
              WmNews wmNews =new WmNews();
              ProtostuffUtil.serialize(wmNews);
          }
          System.out.println(" protostuff èŠ±è´¹ "+(System.currentTimeMillis()-start));
      }
  
   
   
  }
  ```

  :::

<br/>

æ‹·è´èµ„æ–™ä¸­çš„ä¸¤ä¸ªç±»åˆ° `heima-leadnews-utils`ä¸‹

Protostuff éœ€è¦å¼•å¯¼ä¾èµ–ï¼š

```xml
<dependency>
    <groupId>io.protostuff</groupId>
    <artifactId>protostuff-core</artifactId>
    <version>1.6.0</version>
</dependency>

<dependency>
    <groupId>io.protostuff</groupId>
    <artifactId>protostuff-runtime</artifactId>
    <version>1.6.0</version>
</dependency>
```

<br/>

ä¿®æ”¹å‘å¸ƒæ–‡ç« ä»£ç ï¼š

æŠŠä¹‹å‰ WmNewsServiceImpl çš„ submitNewsæ–¹æ³• å¼‚æ­¥è°ƒç”¨ä¿®æ”¹ä¸ºè°ƒç”¨å»¶è¿Ÿä»»åŠ¡

```java
@Autowired
private WmNewsTaskService wmNewsTaskService;

/**
 * å‘å¸ƒä¿®æ”¹æ–‡ç« æˆ–ä¿å­˜ä¸ºè‰ç¨¿
 * @param dto
 * @return
 */
@Override
@GlobalTransactional // [!code --]
public ResponseResult submitNews(WmNewsDto dto) {

    //0.æ¡ä»¶åˆ¤æ–­
    if (dto == null || dto.getContent() == null) {
        return ResponseResult.errorResult(AppHttpCodeEnum.PARAM_INVALID);
    }

    //1.ä¿å­˜æˆ–ä¿®æ”¹æ–‡ç« 
    WmNews wmNews = new WmNews();
    //å±æ€§æ‹·è´ å±æ€§åè¯å’Œç±»å‹ç›¸åŒæ‰èƒ½æ‹·è´
    BeanUtils.copyProperties(dto, wmNews);
    //å°é¢å›¾ç‰‡  list---> string
    if (dto.getImages() != null && dto.getImages().size() > 0) {
        //[1dddfsd.jpg,sdlfjldk.jpg]-->   1dddfsd.jpg,sdlfjldk.jpg
        String imageStr = StringUtils.join(dto.getImages(), ",");
        wmNews.setImages(imageStr);
    }
    //å¦‚æœå½“å‰å°é¢ç±»å‹ä¸ºè‡ªåŠ¨ -1
    if (dto.getType().equals(WeMediaConstants.WM_NEWS_TYPE_AUTO)) {
        wmNews.setType(null);
    }

    saveOrUpdateWmNews(wmNews);

    //2.åˆ¤æ–­æ˜¯å¦ä¸ºè‰ç¨¿  å¦‚æœä¸ºè‰ç¨¿ç»“æŸå½“å‰æ–¹æ³•
    if (dto.getStatus().equals(WmNews.Status.NORMAL.getCode())) {
        return ResponseResult.okResult(AppHttpCodeEnum.SUCCESS);
    }

    //3.ä¸æ˜¯è‰ç¨¿ï¼Œä¿å­˜æ–‡ç« å†…å®¹å›¾ç‰‡ä¸ç´ æçš„å…³ç³»
    //è·å–åˆ°æ–‡ç« å†…å®¹ä¸­çš„å›¾ç‰‡ä¿¡æ¯
    List<String> materials = ectractUrlInfo(dto.getContent());
    saveRelativeInfoForContent(materials, wmNews.getId());

    //4.ä¸æ˜¯è‰ç¨¿ï¼Œä¿å­˜æ–‡ç« å°é¢å›¾ç‰‡ä¸ç´ æçš„å…³ç³»ï¼Œå¦‚æœå½“å‰å¸ƒå±€æ˜¯è‡ªåŠ¨ï¼Œéœ€è¦åŒ¹é…å°é¢å›¾ç‰‡
    saveRelativeInfoForCover(dto, wmNews, materials);

    //5.å®¡æ ¸æ–‡ç« 
    wmNewsAutoScanService.autoScanWmNews(wmNews.getId()); // [!code --]
    wmNewsTaskService.addNewsToTask(wmNews.getId(),wmNews.getPublishTime());  // [!code ++]

    return ResponseResult.okResult(AppHttpCodeEnum.SUCCESS);
}
```

::: warning ğŸ’¡æ€è€ƒï¼šSeata ç®¡ç†çš„ @GlobalTransactional ä¸ºä»€ä¹ˆå¯ä»¥æ³¨è§£æ‰

- å› ä¸ºæ–‡ç« é€šè¿‡å»¶è¿Ÿé˜Ÿåˆ—æ¥å£ï¼Œå°†æ–‡ç« çš„å‘å¸ƒåŠŸèƒ½å’Œæ–‡ç« çš„å®¡æ ¸åŠŸèƒ½è¿›è¡Œäº†è§£è—•ã€‚é€šè¿‡æ¶ˆæ¯é˜Ÿåˆ—çš„æ–¹å¼å®ç°äº†åˆ†å¸ƒå¼äº‹åŠ¡ã€‚

:::

<br/>

**æ¶ˆè´¹ä»»åŠ¡è¿›è¡Œå®¡æ ¸æ–‡ç« **

![image-20240111194434548](assets/image-20240111194434548.png)

WmNewsTaskService æ·»åŠ æ–¹æ³•

```java
/**
 * é€šè¿‡æ¶ˆè´¹å»¶è¿Ÿé˜Ÿåˆ—æ‰§è¡Œæ–‡ç« å®¡æ ¸
 */
public void scanNewsByTask();
```

WmNewsTaskServiceImpl å®ç°

```java
/**
 * æ¶ˆè´¹å»¶è¿Ÿé˜Ÿåˆ—æ•°æ®
 */
@Scheduled(fixedRate = 1000)
@Override
@SneakyThrows
public void scanNewsByTask() {

    log.info("æ–‡ç« å®¡æ ¸---æ¶ˆè´¹ä»»åŠ¡æ‰§è¡Œ---begin---");

    ResponseResult responseResult = scheduleClient.poll(TaskTypeEnum.NEWS_SCAN_TIME.getTaskType(), TaskTypeEnum.NEWS_SCAN_TIME.getPriority());
    if(responseResult.getCode().equals(200) && responseResult.getData() != null){
        String json_str = JSON.toJSONString(responseResult.getData());
        Taskinfo task = JSON.parseObject(json_str, Taskinfo.class);
        byte[] parameters = task.getParameters();
        WmNews wmNews = ProtostuffUtil.deserialize(parameters, WmNews.class);
        System.out.println(wmNews.getId()+"-----------");
        wmNewsAutoScanService.autoScanWmNews(wmNews.getId());
    }
    log.info("æ–‡ç« å®¡æ ¸---æ¶ˆè´¹ä»»åŠ¡æ‰§è¡Œ---end---");
}
```

<br/>

åœ¨WemediaApplicationè‡ªåª’ä½“çš„å¼•å¯¼ç±»ä¸­æ·»åŠ å¼€å¯ä»»åŠ¡è°ƒåº¦æ³¨è§£`@EnableScheduling`

```java {21}
package com.heima.wemedia;

import com.baomidou.mybatisplus.annotation.DbType;
import com.baomidou.mybatisplus.extension.plugins.MybatisPlusInterceptor;
import com.baomidou.mybatisplus.extension.plugins.inner.PaginationInnerInterceptor;
import lombok.extern.slf4j.Slf4j;
import org.mybatis.spring.annotation.MapperScan;
import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.cloud.client.discovery.EnableDiscoveryClient;
import org.springframework.cloud.openfeign.EnableFeignClients;
import org.springframework.context.annotation.Bean;
import org.springframework.scheduling.annotation.EnableScheduling;


@Slf4j
@SpringBootApplication
@EnableDiscoveryClient
@MapperScan("com.heima.wemedia.mapper")
@EnableFeignClients(basePackages = "com.heima.apis")
@EnableScheduling
public class WeMediaApplication {
    public static void main(String[] args) {
        SpringApplication.run(WeMediaApplication.class, args);
    }

    @Bean
    public MybatisPlusInterceptor mybatisPlusInterceptor() {
        MybatisPlusInterceptor interceptor = new MybatisPlusInterceptor();
        interceptor.addInnerInterceptor(new PaginationInnerInterceptor(DbType.MYSQL));
        return interceptor;
    }
}
```





å­¦ä¹ æ€»ç»“
--------

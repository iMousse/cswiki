# Day07-ç§¯åˆ†ç³»ç»Ÿ

å­¦ä¹ æ˜¯éœ€è¦æ­£åé¦ˆçš„ï¼Œè¿™æ ·å­¦å‘˜æ‰èƒ½æœ‰æºæºä¸æ–­çš„åŠ¨åŠ›å»ç»§ç»­å­¦ä¹ ã€‚

<br/>

ä¸ºäº†æ¿€åŠ±å­¦å‘˜ï¼Œæˆ‘ä»¬éœ€è¦è®¾å®šä¸€ä¸ªå­¦ä¹ **ç§¯åˆ†çš„æ’è¡Œæ¦œ**ç³»ç»Ÿã€‚ä¼˜ç§€çš„å­¦å‘˜ç»™äºˆä¸€å®šçš„å¥–åŠ±ï¼Œæ¯”å¦‚å¥–åŠ±ä¼˜æƒ åˆ¸ã€‚å¤§å®¶äº’ç›¸æ¯”æ‹¼çš„ï¼Œåˆºæ¿€å­¦å‘˜æŒç»­å­¦ä¹ ï¼Œäº’ç›¸å·èµ·æ¥ã€‚

<br/>

è€Œä¸”ä¸ä»…åœ¨å¤©æœºå­¦å ‚é¡¹ç›®ï¼Œå¾ˆå¤šå…¶å®ƒç±»å‹é¡¹ç›®ä¸­ä¹Ÿéƒ½ä¼šæœ‰ç§¯åˆ†ã€æ’è¡Œæ¦œåŠŸèƒ½ã€‚å› æ­¤è¿™å¥—æ–¹æ¡ˆé€‚ç”¨æ€§å¾ˆå¹¿ï¼Œå¯ä»¥ç»™å¤§å®¶ä»¥åå®ç°ç›¸å…³åŠŸèƒ½æä¾›æ€è·¯ã€‚



## éœ€æ±‚åˆ†æ

ä¸ä»¥å¾€ç±»ä¼¼ï¼Œæˆ‘ä»¬å…ˆç±»åˆ†æä¸€ä¸‹äº§å“åŸå‹ï¼Œç»Ÿè®¡ä¸€ä¸‹è¦å®ç°çš„æ¥å£ï¼Œç„¶åè®¾è®¡æ•°æ®åº“è¡¨ç»“æ„ã€‚

### æ¦‚å¿µå’Œè§„åˆ™

é¦–å…ˆæˆ‘ä»¬è¦çŸ¥é“å‡ ä¸ªæ¦‚å¿µï¼š

- ç§¯åˆ†ï¼šç”¨æˆ·åœ¨å¤©æœºå­¦å ‚ç½‘ç«™çš„å„ç§äº¤äº’è¡Œä¸ºéƒ½å¯ä»¥äº§ç”Ÿç§¯åˆ†ï¼Œç§¯åˆ†å€¼ä¸è¡Œä¸ºç±»å‹æœ‰å…³
- å­¦éœ¸å¤©æ¢¯æ¦œï¼šæŒ‰ç…§æ¯ä¸ªå­¦å‘˜çš„æ€»ç§¯åˆ†æ’åºå¾—åˆ°çš„æ’è¡Œæ¦œï¼Œç§°ä¸ºå­¦éœ¸å¤©æ¢¯æ¦œã€‚æ’åå‰ä¸‰çš„æœ‰å¥–åŠ±ã€‚å¤©æ¢¯æ¦œæ¯ä¸ªè‡ªç„¶æœˆä¸ºä¸€ä¸ªèµ›å­£ï¼Œæœˆåˆæ¸…é›¶ã€‚

<br/>

å…·ä½“çš„ç§¯åˆ†è·å–çš„ç»†åˆ™å¦‚ä¸‹ï¼š

:::tip  ğŸ”–ï¼šç§¯åˆ†è·å–è§„åˆ™

1. ç­¾åˆ°è§„åˆ™

è¿ç»­7å¤©å¥–åŠ±10åˆ†  è¿ç»­14å¤© å¥–åŠ±20  è¿ç»­28å¤©å¥–åŠ±40åˆ†ï¼Œ æ¯æœˆç­¾åˆ°è¿›åº¦å½“æœˆç¬¬ä¸€å¤©é‡ç½®

<br/>

2. å­¦ä¹ è§„åˆ™

æ¯å­¦ä¹ ä¸€å°èŠ‚ï¼Œç§¯åˆ†+10ï¼Œæ¯å¤©è·å¾—ä¸Šé™50åˆ†

<br/>

3. äº¤äº’è§„åˆ™ï¼ˆæœ‰æ•ˆäº¤äº’æ•°æ®å‚ä¸ç§¯åˆ†è§„åˆ™ï¼Œæ— æ•ˆæ•°æ®ä¼šè¢«åˆ é™¤ï¼‰

- å†™è¯„ä»· ç§¯åˆ†+10 
- å†™é—®ç­” ç§¯åˆ†+5 æ¯æ—¥è·å¾—ä¸Šé™ä¸º20åˆ†
- å†™ç¬”è®° ç§¯åˆ†+3 æ¯æ¬¡è¢«é‡‡é›†+2 æ¯æ—¥è·å¾—ä¸Šé™ä¸º20åˆ†

:::

ç”¨æˆ·è·å–ç§¯åˆ†çš„é€”å¾„æœ‰5ç§ï¼š

- ç­¾åˆ°ï¼šåœ¨ä¸ªäººç§¯åˆ†é¡µé¢å¯ä»¥æ¯æ—¥ç­¾åˆ°ï¼Œæ¯æ¬¡ç­¾åˆ°å¾—1åˆ†ï¼Œè¿ç»­ç­¾åˆ°æœ‰é¢å¤–ç§¯åˆ†å¥–åŠ±ã€‚
- å­¦ä¹ ï¼šä¹Ÿå°±æ˜¯çœ‹è§†é¢‘
- å†™å›ç­”ï¼šå°±æ˜¯ç»™å…¶ä»–å­¦å‘˜æé—®çš„é—®é¢˜å›ç­”ï¼Œç»™å›ç­”åšè¯„è®ºæ˜¯æ²¡æœ‰ç§¯åˆ†çš„ã€‚
- å†™ç¬”è®°ï¼šå°±æ˜¯å­¦ä¹ çš„è¿‡ç¨‹ä¸­è®°å½•å…¬å¼€çš„å­¦ä¹ ç¬”è®°ï¼Œåˆ†äº«ç»™æ‰€æœ‰äººçœ‹ã€‚æˆ–è€…ä½ çš„ç¬”è®°è¢«äººç‚¹èµã€‚
- å†™è¯„ä»·ï¼šå¯¹ä½ å­¦ä¹ è¿‡çš„è¯¾ç¨‹è¯„ä»·ï¼Œå¯ä»¥è·å–ç§¯åˆ†ã€‚ä½†è¯¾ç¨‹åªèƒ½è¯„ä»·ä¸€æ¬¡ã€‚

<br/>

### äº§å“åŸå‹å’Œæ¥å£ç»Ÿè®¡

åœ¨ç”¨æˆ·çš„ã€Šä¸ªäººä¸­å¿ƒã€‹-ã€Šæˆ‘çš„ç§¯åˆ†ã€‹é¡µé¢ï¼Œä¼šæœ‰ç§¯åˆ†ç›¸å…³å†…å®¹ï¼ŒåŸå‹é¡µé¢å¦‚ä¸‹ï¼š

![img](./assets/20230725154230890.jpg)

<br/>

è¿™ä¸ªé¡µé¢ä¿¡æ¯æ¯”è¾ƒå¯†é›†ï¼Œä»ä¸Šå¾€ä¸‹æ¥çœ‹åˆ†ä¸‰éƒ¨åˆ†ï¼š

- é¡¶éƒ¨ï¼šå½“å‰ç”¨æˆ·åœ¨æ¦œå•ä¸­çš„ä¿¡æ¯
- ä¸­éƒ¨ï¼šç­¾åˆ°è¡¨
- ä¸‹éƒ¨ï¼šåˆ†ä¸ºå·¦å³ä¸¤ä¾§
  - å·¦ä¾§ï¼šç”¨æˆ·å½“å¤©è·å–çš„ç§¯åˆ†æ˜ç»†
  - å³ä¾§ï¼šæ¦œå•

<br/>

#### æ¦œå•

é¡¶éƒ¨å±•ç¤ºçš„å½“å‰ç”¨æˆ·åœ¨æ¦œå•ä¸­çš„ä¿¡æ¯ï¼Œå…¶å®ä¹Ÿå±äºæ’è¡Œæ¦œä¿¡æ¯çš„ä¸€éƒ¨åˆ†ã€‚å› ä¸ºæ’è¡Œæ¦œæŸ¥å‡ºæ¥äº†ï¼Œå½“å‰ç”¨æˆ·æ˜¯ç¬¬å‡ åï¼Œç§¯äº†å¤šå°‘åˆ†ä¹Ÿå°±çŸ¥é“äº†ã€‚

å› æ­¤ï¼Œè¿™é‡Œå¯ä»¥åˆå¹¶ä¸ºä¸€ä¸ªæ¥å£ï¼š**æŸ¥è¯¢å½“å‰èµ›å­£çš„ç§¯åˆ†æ’è¡Œæ¦œä¿¡æ¯ã€‚**

<br/>

ä¸ºä»€ä¹ˆè¯´æ˜¯å½“å‰èµ›å­£å‘¢ï¼Ÿ

å› ä¸ºç§¯åˆ†æ¦œæ˜¯ä»¥è‡ªç„¶æœˆä¸ºèµ›å­£çš„ã€‚é¡µé¢è¯´æ˜ä¸­æœ‰è®²ï¼š

![img](./assets/20230725154230505.jpg)

<br/>

å½“æˆ‘ä»¬ç‚¹å‡»æ›´å¤šæ—¶ï¼Œä¼šè¿›å…¥å†å²æ¦œå•é¡µé¢ï¼š

![img](./assets/20230725154230959.jpg)

åœ¨è¿™é‡Œé¦–å…ˆå¯ä»¥é€šè¿‡ä¸‹æ‹‰é€‰æ¡†é€‰æ‹©å†å²èµ›å­£ï¼Œå½“é€‰å®šä»¥åå°±å¯ä»¥å±•ç¤ºå¯¹åº”èµ›å­£çš„å†å²æ¦œå•ã€‚

å› æ­¤ï¼Œè¿™é‡Œæœ‰ä¸¤ä¸ªæ¥å£ï¼š

- **æŸ¥è¯¢å†å²èµ›å­£åˆ—è¡¨**
- **æŸ¥è¯¢å†å²æ¦œå•ä¿¡æ¯**

<br/>

#### ç§¯åˆ†

é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œç”¨æˆ·ç§¯åˆ†æ˜¯å¦‚ä½•è·å–çš„å‘¢ï¼Ÿä¹‹å‰åˆ†æè¿‡ï¼Œè·å–ç§¯åˆ†çš„é€”å¾„æœ‰äº”ç§ä¹‹å¤šï¼š

- ç­¾åˆ°ï¼šæ¯æ¬¡1åˆ†ï¼Œè¿ç»­ç­¾åˆ°æœ‰å¥–åŠ±
- å­¦ä¹ ï¼šå­¦ä¸€ä¸ªè§†é¢‘10åˆ†ï¼Œæ¯æ—¥ä¸Šé™50åˆ†
- å›ç­”é—®é¢˜ï¼šå›ç­”ä¸€ä¸ªé—®é¢˜5åˆ†ï¼Œæ¯æ—¥ä¸Šé™20åˆ†
- å†™ç¬”è®°ï¼šè®°å½•ç¬”è®°å¾—3åˆ†ï¼Œç¬”è®°è¢«é‡‡é›†å¾—2åˆ†ï¼Œæ¯æ—¥ä¸Šé™20åˆ†
- è¯„è®ºï¼šå¾—10åˆ†

<br/>

å¯ä»¥çœ‹åˆ°ï¼Œç­¾åˆ°ã€è¯„è®ºå—åˆ°ä¸šåŠ¡æœ¬èº«çš„é™åˆ¶ï¼Œæœ‰æ¬¡æ•°é™åˆ¶ï¼Œå› æ­¤æ²¡æœ‰ç§¯åˆ†ä¸Šé™ã€‚ä½†å­¦ä¹ ã€å›ç­”ã€ç¬”è®°éƒ½æœ‰æ¯æ—¥ç§¯åˆ†ä¸Šé™ã€‚å› æ­¤å½“ç”¨æˆ·äº§ç”Ÿäº†ç§¯åˆ†è¡Œä¸ºæ—¶ï¼Œæˆ‘ä»¬å¿…é¡»åˆ¤æ–­å½“ç„¶è¯¥è¡Œä¸ºäº§ç”Ÿçš„ç§¯åˆ†æ˜¯å¦å·²ç»è¾¾åˆ°ä¸Šé™ï¼Œå¦‚æœæ²¡æœ‰è¾¾åˆ°æ‰èƒ½å¢åŠ ç§¯åˆ†ã€‚

ä½†é—®é¢˜æ¥äº†ï¼šæˆ‘ä»¬è¯¥å¦‚ä½•çŸ¥é“ç”¨æˆ·çš„è¿™ç±»è¡Œä¸ºæ˜¯å¦è¾¾åˆ°ç§¯åˆ†ä¸Šé™å‘¢ï¼Ÿ

é™¤éï¼Œæˆ‘ä»¬è¯¦ç»†è®°å½•ä¸‹ç”¨æˆ·æ¯ä¸€æ¬¡è·å–ç§¯åˆ†çš„æ˜ç»†ä¿¡æ¯ï¼š

- è·å–ç§¯åˆ†æ–¹å¼
- è·å–ç§¯åˆ†åˆ†å€¼
- è·å–ç§¯åˆ†æ—¶é—´

åªæœ‰è¿™æ ·ï¼Œæˆ‘ä»¬æ‰èƒ½ç»Ÿè®¡å‡ºç”¨æˆ·å½“æ—¥æ¯ä¸€ç§æ–¹å¼å·²ç»è·å–çš„ç§¯åˆ†ï¼Œæ‰èƒ½åˆ¤æ–­ç§¯åˆ†æ˜¯å¦åˆ°è¾¾ä¸Šé™ã€‚

å› æ­¤ï¼Œç¬¬ä¸‰ä¸ªæ¥å£å°±æ˜¯ï¼š**è®°å½•ç”¨æˆ·ç§¯åˆ†æ˜ç»†**ã€‚

<br/>

é™¤äº†è¿™ä¸ªæ¥å£ä»¥å¤–ï¼Œåœ¨ä¸ªäººç§¯åˆ†é¡µé¢ï¼Œè¿˜éœ€è¦ç»Ÿè®¡ç”¨æˆ·å½“æ—¥çš„ç§¯åˆ†æƒ…å†µï¼š

![img](./assets/20230725154230549.jpg)

è¿™æ˜¯ç§¯åˆ†ç›¸å…³çš„ç¬¬äºŒä¸ªæ¥å£ï¼š**ç»Ÿè®¡ç”¨æˆ·å½“æ—¥è·å–ç§¯åˆ†æƒ…å†µ**ã€‚

<br/>

#### ç­¾åˆ°

å›åˆ°ä¸ªäººç§¯åˆ†é¡µé¢ï¼Œåœ¨é¡µé¢ä¸­éƒ¨æœ‰ä¸€ä¸ªç­¾åˆ°è¡¨ï¼š

![img](./assets/20230725154230538.jpg)

å¯ä»¥çœ‹åˆ°è¿™å°±æ˜¯ä¸€ä¸ªæ—¥å†ï¼Œå¯¹åº”äº†æ¯ä¸€å¤©çš„ç­¾åˆ°æƒ…å†µã€‚æ—¥å†ä¸­å½“å¤©çš„æ—¥æœŸä¼šé«˜äº®æ˜¾ç¤ºä¸ºã€Šæ‰“å¡ã€‹çŠ¶æ€ï¼Œç‚¹å‡»å³å¯å®Œæˆå½“æ—¥æ‰“å¡ï¼ŒæœåŠ¡ç«¯è‡ªç„¶è¦è®°å½•æ‰“å¡æƒ…å†µã€‚

å› æ­¤è¿™é‡Œå°±æœ‰ä¸€ä¸ªæ¥å£éœ€è¦å®ç°ï¼š**ç­¾åˆ°æ¥å£**

é™¤æ­¤ä»¥å¤–ï¼Œå¯ä»¥çœ‹åˆ°æœ¬æœˆç¬¬ä¸€å¤©åˆ°ä»Šå¤©ä¸ºæ­¢çš„æ‰€æœ‰æ‰“å¡æ—¥æœŸä¹Ÿéƒ½é«˜äº®æ˜¾ç¤ºæ ‡è®°å‡ºæ¥äº†ã€‚ä¹Ÿå°±æ˜¯è¯´é¡µé¢è¿˜éœ€è¦çŸ¥é“æœ¬æœˆåˆ°ä»Šå¤©ä¸ºæ­¢æ¯ä¸€å¤©çš„æ‰“å¡æƒ…å†µã€‚è¿™æ ·å¯¹äºäº†ä¸€ä¸ªæ¥å£ï¼š**æŸ¥è¯¢æœ¬æœˆç­¾åˆ°è®°å½•**

<br/>

#### æ€»ç»“

ç»¼ä¸Šï¼Œæˆ‘ä»¬è¦å®ç°çš„æ¥å£æœ‰ï¼š

![image-20240213173920531](assets/image-20240213173920531.png)

<br/>

### æ•°æ®åº“è®¾è®¡

æˆ‘ä»¬è¦å®ç°çš„æ¥å£å…³è”çš„å®ä½“æœ‰ä¸‰ç±»ï¼š

- ç­¾åˆ°è®°å½•
- ç§¯åˆ†è®°å½•
- æ’è¡Œæ¦œ

å› æ­¤ï¼Œåœ¨è®¾è®¡æ•°æ®åº“è¡¨çš„æ—¶å€™ä¸»è¦åŒ…å«è¿™ä¸‰å¼ è¡¨ã€‚

<br/>

#### ç­¾åˆ°è®°å½•

ç­¾åˆ°æœ€æ ¸å¿ƒçš„åŒ…å«ä¸¤ä¸ªè¦ç´ ï¼š

- è°ç­¾åˆ°ï¼šç”¨æˆ·id
- ä»€ä¹ˆæ—¶å€™ç­¾çš„ï¼šç­¾åˆ°æ—¥æœŸ

åŒæ—¶è¦è€ƒè™‘ä¸€äº›åŠŸèƒ½è¦ç´ ï¼Œæ¯”å¦‚ï¼š

- è¡¥ç­¾åŠŸèƒ½ï¼Œæ‰€ä»¥è¦æœ‰è¡¥ç­¾æ ‡ç¤º
- æŒ‰ç…§å¹´ã€æœˆç»Ÿè®¡çš„åŠŸèƒ½ï¼šæ‰€ä»¥ç­¾åˆ°æ—¥æœŸå¯ä»¥æŒ‰ç…§å¹´ã€æœˆã€æ—¥åˆ†ç¦»ä¿å­˜

æœ€ç»ˆï¼Œç­¾åˆ°çš„ERå›¾å¦‚ä¸‹ï¼š

![image-20240213174032258](assets/image-20240213174032258.png)

å¯¹åº”çš„æ•°æ®åº“è¡¨ç»“æ„ï¼š

```SQL
 CREATE TABLE `sign_record` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT 'ä¸»é”®',
  `user_id` bigint NOT NULL COMMENT 'ç”¨æˆ·id',
  `year` year NOT NULL COMMENT 'ç­¾åˆ°å¹´ä»½',
  `month` tinyint NOT NULL COMMENT 'ç­¾åˆ°æœˆä»½',
  `date` date NOT NULL COMMENT 'ç­¾åˆ°æ—¥æœŸ',
  `is_backup` bit(1) NOT NULL COMMENT 'æ˜¯å¦è¡¥ç­¾',
  PRIMARY KEY (`id`),
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='ç­¾åˆ°è®°å½•è¡¨';
```

<br/>

#### ç§¯åˆ†è®°å½•

ç§¯åˆ†è®°å½•çš„ç›®çš„æœ‰ä¸¤ä¸ªï¼šä¸€ä¸ªæ˜¯ç»Ÿè®¡ç”¨æˆ·å½“æ—¥æŸä¸€ç§æ–¹å¼è·å–çš„ç§¯åˆ†æ˜¯å¦è¾¾åˆ°ä¸Šé™ï¼›ä¸€ä¸ªæ˜¯ç»Ÿè®¡ç§¯åˆ†æ’è¡Œæ¦œã€‚

è¦è¾¾æˆä¸Šè¿°ç›®çš„æˆ‘ä»¬è‡³å°‘è¦è®°å½•ä¸‹åˆ—ä¿¡æ¯ï¼š

- æœ¬æ¬¡å¾—åˆ°ç§¯åˆ†å€¼
- ç§¯åˆ†æ–¹å¼
- è·å–ç§¯åˆ†æ—¶é—´
- è·å–ç§¯åˆ†çš„äºº

å› æ­¤ï¼Œç§¯åˆ†è®°å½•çš„ERå›¾å¦‚ä¸‹ï¼š

![image-20240213174154026](assets/image-20240213174154026.png)

å¯¹åº”çš„æ•°æ®åº“è¡¨ç»“æ„ï¼š

```SQL
CREATE TABLE IF NOT EXISTS `points_record` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT 'ç§¯åˆ†è®°å½•è¡¨id',
  `user_id` bigint NOT NULL COMMENT 'ç”¨æˆ·id',
  `type` tinyint NOT NULL COMMENT 'ç§¯åˆ†æ–¹å¼ï¼š1-è¯¾ç¨‹å­¦ä¹ ï¼Œ2-æ¯æ—¥ç­¾åˆ°ï¼Œ3-è¯¾ç¨‹é—®ç­”ï¼Œ 4-è¯¾ç¨‹ç¬”è®°ï¼Œ5-è¯¾ç¨‹è¯„ä»·',
  `points` tinyint NOT NULL COMMENT 'ç§¯åˆ†å€¼',
  `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
  PRIMARY KEY (`id`) USING BTREE,
  KEY `idx_user_id` (`user_id`,`type`) USING BTREE,
  KEY `idx_create_time` (`create_time`) USING BTREE
) ENGINE=InnoDB AUTO_INCREMENT=41 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ROW_FORMAT=DYNAMIC COMMENT='å­¦ä¹ ç§¯åˆ†è®°å½•ï¼Œæ¯ä¸ªæœˆåº•æ¸…é›¶';
```

<br/>

#### æ’è¡Œæ¦œ

æ’è¡Œæ¦œæ˜¯åˆ†èµ›å­£çš„ï¼Œè€Œä¸”é¡µé¢ä¹Ÿéœ€è¦æŸ¥è¯¢åˆ°å†å²èµ›å­£çš„åˆ—è¡¨ã€‚å› æ­¤èµ›å­£ä¹Ÿæ˜¯ä¸€ä¸ªå®ä½“ï¼Œç”¨æ¥è®°å½•æ¯ä¸€ä¸ªèµ›å­£çš„ä¿¡æ¯ã€‚å½“ç„¶èµ›å­£ä¿¡æ¯éå¸¸ç®€å•ï¼š

- èµ›å­£åç§°
- èµ›å­£å¼€å§‹æ—¶é—´
- èµ›å­£ç»“æŸæ—¶é—´

å› æ­¤èµ›å­£è¡¨éå¸¸ç®€å•ï¼š

```SQL
CREATE TABLE IF NOT EXISTS `points_board_season` (
  `id` int NOT NULL AUTO_INCREMENT COMMENT 'è‡ªå¢é•¿idï¼Œseasonæ ‡ç¤º',
  `name` varchar(32) CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci DEFAULT NULL COMMENT 'èµ›å­£åç§°ï¼Œä¾‹å¦‚ï¼šç¬¬1èµ›å­£',
  `begin_time` date NOT NULL COMMENT 'èµ›å­£å¼€å§‹æ—¶é—´',
  `end_time` date NOT NULL COMMENT 'èµ›å­£ç»“æŸæ—¶é—´',
  PRIMARY KEY (`id`) USING BTREE
) ENGINE=InnoDB AUTO_INCREMENT=13 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ROW_FORMAT=DYNAMIC;
```

æ’è¡Œæ¦œä¹Ÿä¸å¤æ‚ï¼Œæ ¸å¿ƒè¦ç´ åŒ…æ‹¬ï¼š

- ç”¨æˆ·id
- æœ¬èµ›å­£å½“å‰ç§¯åˆ†
- æœ¬èµ›å­£å½“å‰æ’å

å½“ç„¶ï¼Œç”±äºè¦åŒºåˆ†èµ›å­£ï¼Œè¿˜åº”è¯¥å…³è”èµ›å­£ä¿¡æ¯ï¼š

- èµ›å­£id

å› æ­¤ï¼Œæ’è¡Œæ¦œçš„ERå›¾å¦‚ä¸‹ï¼š

![image-20240213174231048](assets/image-20240213174231048.png)

å¯¹åº”çš„æ•°æ®åº“è¡¨ç»“æ„ï¼š

```SQL
CREATE TABLE IF NOT EXISTS `points_board` (
  `id` bigint NOT NULL COMMENT 'æ¦œå•id',
  `user_id` bigint NOT NULL COMMENT 'å­¦ç”Ÿid',
  `points` int NOT NULL COMMENT 'ç§¯åˆ†å€¼',
  `rank` tinyint NOT NULL COMMENT 'åæ¬¡ï¼Œåªè®°å½•èµ›å­£å‰100',
  `season` smallint NOT NULL COMMENT 'èµ›å­£ï¼Œä¾‹å¦‚ 1,å°±æ˜¯ç¬¬ä¸€èµ›å­£ï¼Œ2-å°±æ˜¯ç¬¬äºŒèµ›å­£',
  PRIMARY KEY (`id`) USING BTREE,
  UNIQUE KEY `idx_season_user` (`season`,`user_id`) USING BTREE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ROW_FORMAT=DYNAMIC COMMENT='å­¦éœ¸å¤©æ¢¯æ¦œ';
```

<br/>

### åŸºç¡€ä»£ç 

#### åˆ›å»ºåˆ†æ”¯

é¦–å…ˆåœ¨DEVåˆ†æ”¯åŸºç¡€ä¸Šåˆ›å»ºä¸€ä¸ªæ–°çš„åŠŸèƒ½åˆ†æ”¯ï¼š

```Bash
git checkout -b feature-points-board
```

<br/>

#### ç”Ÿæˆä»£ç 

ç„¶ååˆ©ç”¨mpæ’ä»¶è‡ªåŠ¨ç”Ÿæˆä»£ç å³å¯ã€‚è¿™é‡Œä¸å†èµ˜è¿°ã€‚

![img](./assets/20230725154234339.jpg)

<br/>

#### ç±»å‹æšä¸¾

äº§ç”Ÿç§¯åˆ†çš„ä¸šåŠ¡ç±»å‹ä»å¤§çš„æ¥è¯´æœ‰5ç§ï¼Œæˆ‘ä»¬å®šä¹‰æˆä¸€ä¸ªæšä¸¾ã€‚

<br/>

å…·ä½“ä»£ç ï¼š

```Java
package com.tianji.learning.enums;

import com.baomidou.mybatisplus.annotation.EnumValue;
import com.fasterxml.jackson.annotation.JsonCreator;
import com.fasterxml.jackson.annotation.JsonValue;
import com.tianji.common.enums.BaseEnum;
import lombok.Getter;

@Getter
public enum PointsRecordType implements BaseEnum {
    LEARNING(1, "è¯¾ç¨‹å­¦ä¹ ", 50),
    SIGN(2, "æ¯æ—¥ç­¾åˆ°", 0),
    QA(3, "è¯¾ç¨‹é—®ç­”", 20),
    NOTE(4, "è¯¾ç¨‹ç¬”è®°", 20),
    COMMENT(5, "è¯¾ç¨‹è¯„ä»·", 0),
    ;
    @EnumValue
    @JsonValue
    int value;
    String desc;
    int maxPoints;

    PointsRecordType(int value, String desc, int maxPoints) {
        this.value = value;
        this.desc = desc;
        this.maxPoints = maxPoints;
    }

    @JsonCreator(mode = JsonCreator.Mode.DELEGATING)
    public static PointsRecordType of(Integer value){
        if (value == null) {
            return null;
        }
        for (PointsRecordType status : values()) {
            if (status.equalsValue(value)) {
                return status;
            }
        }
        return null;
    }
}
```

<br/>

éœ€è¦ç‰¹åˆ«æ³¨æ„çš„æ˜¯ï¼Œåœ¨æšä¸¾ä¸­é™¤äº†æšä¸¾å¯¹åº”çš„intå€¼å¤–ï¼Œè¿˜è®°å½•äº†æ¯ç§ç±»å‹çš„ç§¯åˆ†ä¸Šé™ï¼Œæ–¹ä¾¿åç»­ä¸šåŠ¡ä¸­åšåˆ¤æ–­ï¼š

![img](./assets/20230725154232914.jpg)

å½“ç„¶è¿™ä¸ªç§¯åˆ†ä¸Šé™ä¹Ÿå¯ä»¥ä¸å®šä¹‰åœ¨æšä¸¾ï¼Œè€Œæ˜¯äº¤ç»™NacosåšåŠ¨æ€é…ç½®ï¼Œå®ç°çº¿ä¸Šçƒ­åŠ è½½ã€‚å¦‚æœæœ‰å…´è¶£çš„è¯å¤§å®¶å¯ä»¥è‡ªå·±å®ç°ã€‚



## ç­¾åˆ°åŠŸèƒ½

### æ€è·¯åˆ†æ

ä¹‹å‰æˆ‘ä»¬è®¾è®¡äº†ç­¾åˆ°åŠŸèƒ½å¯¹åº”çš„æ•°æ®åº“è¡¨ï¼š

```SQL
 CREATE TABLE `sign_record` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT 'ä¸»é”®',
  `user_id` bigint NOT NULL COMMENT 'ç”¨æˆ·id',
  `year` year NOT NULL COMMENT 'ç­¾åˆ°å¹´ä»½',
  `month` tinyint NOT NULL COMMENT 'ç­¾åˆ°æœˆä»½',
  `date` date NOT NULL COMMENT 'ç­¾åˆ°æ—¥æœŸ',
  `is_backup` bit(1) NOT NULL COMMENT 'æ˜¯å¦è¡¥ç­¾',
  PRIMARY KEY (`id`),
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='ç­¾åˆ°è®°å½•è¡¨';
```

è¿™å¼ è¡¨ä¸­çš„ä¸€æ¡è®°å½•æ˜¯ä¸€ä¸ªç”¨æˆ·ä¸€æ¬¡çš„ç­¾åˆ°è®°å½•ã€‚å‡å¦‚ä¸€ä¸ªç”¨æˆ·1å¹´ç­¾åˆ°100æ¬¡ï¼Œè€Œç½‘ç«™æœ‰100ä¸‡ç”¨æˆ·ï¼Œå°±ä¼šäº§ç”Ÿ1äº¿æ¡è®°å½•ã€‚

éšç€ç”¨æˆ·é‡å¢å¤šã€æ—¶é—´çš„æ¨ç§»ï¼Œè¿™å¼ è¡¨ä¸­çš„æ•°æ®åªä¼šè¶Šæ¥è¶Šå¤šï¼Œå ç”¨çš„ç©ºé—´ä¹Ÿä¼šè¶Šæ¥è¶Šå¤§ã€‚

<br/>

æœ‰æ²¡æœ‰ä»€ä¹ˆåŠæ³•èƒ½å¤Ÿå‡å°‘ç­¾åˆ°çš„æ•°æ®è®°å½•ï¼Œå‡å°‘ç©ºé—´å ç”¨å‘¢ï¼Ÿ

å¤§å®¶å›å¿†ä¸€ä¸‹ï¼Œå°æ—¶å€™ä¸Šè¡¥ä¹ ç­æ—¶çš„ç­¾åˆ°å¡ï¼š

![img](./assets/20230725154230909.jpg)

åœ¨è¿™å¼ å°å°çš„å¡ç‰‡ä¸Šé¢ï¼Œå°±è®°å½•äº†ä»ä¸€ä¸ªæœˆçš„ç¬¬ä¸€å¤©åˆ°æœ€åä¸€å¤©çš„æ‰€æœ‰çš„ç­¾åˆ°æƒ…å†µã€‚è¯¶ï¼Œä½ ä»Šå¤©æ¥ä¸Šè¯¾äº†é‚£å°±å‹¾ä¸€ä¸‹ï¼Œæ²¡æ¥å°±ç©ºç€ã€‚è¿™æ ·å‘¢ï¼Œé€šè¿‡ä¸€ä¸ªå°å°çš„å¡ç‰‡å°±èƒ½å¤Ÿè®°å½•ä¸€ä¸ªåŒå­¦è¿™ä¸€ä¸ªæœˆçš„ç­¾åˆ°çš„æƒ…å†µäº†ã€‚è™½ç„¶å¾ˆåŸå§‹ï¼Œä½†æ˜¯éå¸¸é«˜æ•ˆã€‚

<br/>

å¦‚æœæˆ‘ä»¬èƒ½ç”¨ç¨‹åºæ¥æ¨¡æ‹Ÿè¿™æ ·çš„ç­¾åˆ°å¡ï¼Œç”¨ä¸€è¡Œæ•°æ®å»è®°å½•ä¸€ä¸ªç”¨æˆ·ä¸€ä¸ªæœˆçš„ç­¾åˆ°æƒ…å†µï¼Œå¯æƒ³è€ŒçŸ¥ï¼Œé‚£æ¯”è¿™ç§æ•°æ®åº“çš„æ–¹å¼æ˜¯ä¸æ˜¯è¦å¤§å¤§åœ°èŠ‚çœç©ºé—´ã€‚

é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œæˆ‘ä»¬è¯¥æ€ä¹ˆæ ·å»æ¨¡æ‹Ÿè¿™æ ·çš„ä¸€ä¸ªç­¾åˆ°å¡ï¼Ÿ

<br/>

å…¶å®å¹¶ä¸å¤æ‚ï¼Œä½ æƒ³å˜›ï¼Ÿä¸€ä¸ªç”¨æˆ·ç­¾åˆ°çš„æƒ…å†µæ— éå°±ä¸¤ç§ï¼Œè¦ä¹ˆç­¾äº†ï¼Œè¦ä¹ˆæ²¡ç­¾ã€‚è¿™å°±åƒæˆ‘ä»¬ç”µè·¯å½“ä¸­çš„è¿™ä¸ªäºŒæç®¡ï¼Œé‚£è¦ä¹ˆé€šç”µï¼Œè¦ä¹ˆä¸é€šï¼Œé‚£ç”¨ç¨‹åºæ€ä¹ˆè¡¨ç¤ºè¿™ç§çŠ¶æ€å‘¢ï¼Ÿ

æ²¡é”™ï¼Œå°±æ˜¯ 0 æˆ–è€…1

<br/>

å¦‚æœæˆ‘ä»¬æŒ‰æœˆæ¥ç»Ÿè®¡ç”¨æˆ·ç­¾åˆ°ä¿¡æ¯ï¼Œç­¾åˆ°è®°å½•ä¸º1ï¼Œæœªç­¾åˆ°åˆ™è®°å½•ä¸º0ï¼Œå°±å¯ä»¥ç”¨ä¸€ä¸ªé•¿åº¦ä¸º31ä½çš„äºŒçº§åˆ¶æ•°æ¥è¡¨ç¤ºä¸€ä¸ªç”¨æˆ·ä¸€ä¸ªæœˆçš„ç­¾åˆ°æƒ…å†µã€‚æœ€ç»ˆæ•ˆæœå¦‚ä¸‹ï¼š

![img](./assets/20230725154230817.jpg)

<br/>

æˆ‘ä»¬çŸ¥é“äºŒè¿›åˆ¶æ˜¯è®¡ç®—æœºåº•å±‚æœ€åŸºç¡€çš„å­˜å‚¨æ–¹å¼äº†ï¼Œå…¶ä¸­çš„æ¯ä¸€ä½æ•°å­—å°±æ˜¯è®¡ç®—æœºä¿¡æ¯é‡çš„æœ€å°å•ä½äº†ï¼Œç§°ä¹‹ä¸ºbitï¼Œä¸€ä¸ªæœˆæœ€å¤šä¹Ÿå°± 31 å¤©ï¼Œå› æ­¤ä¸€ä¸ªæœˆçš„ç­¾åˆ°è®°å½•æœ€å¤šä¹Ÿå°±ä½¿ç”¨ 31 bit å°±èƒ½ä¿å­˜äº†ï¼Œè¿˜ä¸åˆ° 4 ä¸ªå­—èŠ‚ã€‚

è€Œå¦‚æœç”¨åˆ°æˆ‘ä»¬å‰é¢è®²çš„æ•°æ®åº“æ–¹å¼æ¥ä¿å­˜ç›¸åŒæ•°æ®ï¼Œåˆ™è¦ä½¿ç”¨æ•°ç™¾å­—èŠ‚ï¼Œæ˜¯è¿™ç§æ–¹å¼çš„ä¸Šç™¾å€éƒ½ä¸æ­¢ã€‚

å¯è§ï¼Œè¿™ç§ç”¨äºŒè¿›åˆ¶ä½ä¿å­˜ç­¾åˆ°è®°å½•çš„æ–¹å¼ï¼Œæ˜¯ä¸æ˜¯éå¸¸é«˜æ•ˆå•Šï¼

<br/>

åƒè¿™ç§æŠŠæ¯ä¸€ä¸ªäºŒè¿›åˆ¶ä½ï¼Œä¸æŸäº›ä¸šåŠ¡æ•°æ®ä¸€ä¸€æ˜ å°„ï¼ˆæœ¬ä¾‹ä¸­æ˜¯ä¸ä¸€ä¸ªæœˆçš„æ¯ä¸€å¤©æ˜ å°„ï¼‰ï¼Œç„¶åç”¨äºŒè¿›åˆ¶ä½ä¸Šçš„æ•°å­—0å’Œ1æ¥æ ‡è¯†ä¸šåŠ¡çŠ¶æ€çš„æ€è·¯ï¼Œç§°ä¸º**ä½å›¾**ã€‚ä¹Ÿå«åš**BitMap**.

<br/>

è¿™ç§æ•°æ®ç»Ÿè®¡çš„æ–¹å¼éå¸¸èŠ‚çœç©ºé—´ï¼Œå› æ­¤ç»å¸¸ç”¨æ¥åšå„ç§æ•°æ®ç»Ÿè®¡ã€‚æ¯”å¦‚å¤§åé¼é¼çš„å¸ƒéš†è¿‡æ»¤å™¨å°±æ˜¯åŸºäºBitMapæ¥å®ç°çš„ã€‚

<br/>

OKï¼Œé‚£ä¹ˆåˆ©ç”¨BitMapæˆ‘ä»¬å°±èƒ½ç›´æ¥å®ç°ç­¾åˆ°åŠŸèƒ½ï¼Œå¹¶ä¸”éå¸¸èŠ‚çœå†…å­˜ï¼Œè¿˜å¾ˆé«˜æ•ˆã€‚æ‰€ä»¥å°±æ— éœ€é€šè¿‡æ•°æ®åº“æ¥æ“ä½œäº†ã€‚

é‚£ä¹ˆBitMapè¯¥æ€ä¹ˆä½¿ç”¨å‘¢ï¼Ÿ

<br/>

### BitMapç”¨æ³•

Redisä¸­å°±æä¾›äº†BitMapè¿™ç§ç»“æ„ä»¥åŠä¸€äº›ç›¸å…³çš„æ“ä½œå‘½ä»¤ã€‚

https://redis.io/commands/?group=bitmap

ä¾‹å¦‚ï¼Œä¿®æ”¹æŸä¸ªbitä½ä¸Šçš„æ•°æ®ï¼š

![img](./assets/20230725154231262.jpg)

- offsetï¼šè¦ä¿®æ”¹ç¬¬å‡ ä¸ªbitä½çš„æ•°æ®
- valueï¼š0æˆ–1

å¦‚æœè¦ç­¾åˆ°å°±å¯ä»¥åˆ©ç”¨ä¸Šé¢çš„è¿™ä¸ªå‘½ä»¤ï¼Œä¾‹å¦‚è¿™ä¸ªæœˆçš„ç¬¬1ã€2ã€3ã€6ã€7ã€8å‡ å¤©ç­¾åˆ°äº†ï¼Œå°±å¯ä»¥è¿™æ ·ï¼š

```Shell
# ç¬¬1å¤©ç­¾åˆ°
SETBIT bm 0 1
# ç¬¬2å¤©ç­¾åˆ°
SETBIT bm 1 1
# ç¬¬3å¤©ç­¾åˆ°
SETBIT bm 2 1
# ç¬¬6å¤©ç­¾åˆ°
SETBIT bm 5 1
# ç¬¬7å¤©ç­¾åˆ°
SETBIT bm 6 1
# ç¬¬8å¤©ç­¾åˆ°
SETBIT bm 7 1
```

æœ€ç»ˆRedisä¸­ä¿å­˜çš„æ•ˆæœï¼š

![img](./assets/20230725154232982.jpg)

ä¸­é—´æœ‰ä¸¤å¤©ç©ºç€æ²¡ç­¾ï¼Œæ‰€ä»¥æ˜¯0

<br/>

é‚£å¦‚æœæˆ‘ä»¬è¦æŸ¥è¯¢ç­¾åˆ°è®°å½•æ€ä¹ˆåŠï¼Ÿ

é‚£å°±æ˜¯è¦è¯»å–BitMapä¸­çš„æ•°æ®ï¼Œå¯ä»¥ç”¨è¿™ä¸ªå‘½ä»¤ï¼š

![img](./assets/20230725154231506.jpg)

è¿™ä¸ªå‘½ä»¤æ¯”è¾ƒå¤æ‚ï¼Œæ˜¯ä¸€ä¸ªç»„åˆå‘½ä»¤ï¼Œå¯ä»¥å®ç°æŸ¥è¯¢ã€ä¿®æ”¹ç­‰å¤šç§æ“ä½œã€‚ä¸è¿‡æˆ‘ä»¬åªå…³å¿ƒè¯»å–ï¼Œæ‰€ä»¥åªçœ‹ç¬¬ä¸€ç§æ“ä½œï¼ŒGETå³å¯:

```Bash
BITFIELD key GET encoding offset
```

- keyï¼šå°±æ˜¯BitMapçš„key
- GETï¼šä»£è¡¨æŸ¥è¯¢
- encodingï¼šè¿”å›ç»“æœçš„ç¼–ç æ–¹å¼ï¼ŒBitMapä¸­æ˜¯äºŒè¿›åˆ¶ä¿å­˜ï¼Œè€Œè¿”å›ç»“æœä¼šè½¬ä¸º10è¿›åˆ¶ï¼Œä½†éœ€è¦ä¸€ä¸ªè½¬æ¢è§„åˆ™ï¼Œä¹Ÿå°±æ˜¯è¿™é‡Œçš„ç¼–ç æ–¹å¼
  - uï¼šæ— ç¬¦å·æ•´æ•°ï¼Œä¾‹å¦‚ u2ï¼Œä»£è¡¨è¯»2ä¸ªbitä½ï¼Œè½¬ä¸ºæ— ç¬¦å·æ•´æ•°è¿”å›
  - iï¼šæœ‰ç¬¦å·æ•´æ•°ï¼Œä¾‹å¦‚ i2ï¼Œä»£è¡¨è¯»2ä¸ªbitä½ï¼Œè½¬ä¸ºæœ‰ç¬¦å·æ•´æ•°è¿”å›
- offsetï¼šä»ç¬¬å‡ ä¸ªbitä½å¼€å§‹è¯»å–ï¼Œä¾‹å¦‚0ï¼šä»£è¡¨ä»ç¬¬ä¸€ä¸ªbitä½å¼€å§‹

<br/>

ä¾‹å¦‚ï¼Œæˆ‘æƒ³æŸ¥è¯¢ä»ç¬¬1å¤©åˆ°ç¬¬3å¤©çš„ç­¾åˆ°è®°å½•ï¼Œå¯ä»¥è¿™æ ·ï¼š

![img](./assets/20230725154234710.jpg)

å¯ä»¥çœ‹åˆ°ï¼Œè¿”å›çš„ç»“æœæ˜¯7.  ä¸ºä»€ä¹ˆæ˜¯7å‘¢ï¼Ÿ

ç­¾åˆ°è®°å½•æ˜¯ 11100111ï¼Œä»0å¼€å§‹ï¼Œå–3ä¸ªbitä½ï¼Œåˆšå¥½æ˜¯111ï¼Œè½¬æ— ç¬¦å·æ•´æ•°ï¼Œåˆšå¥½æ˜¯7

<br/>

OKï¼Œè¿™æ ·BitMapçš„åŸºæœ¬ç”¨æ³•æˆ‘ä»¬å°±å­¦ä¼šäº†ï¼Œå°†æ¥æˆ‘ä»¬å°±å¯ä»¥åˆ©ç”¨SETBITå‘½ä»¤æ¥å®ç°ç­¾åˆ°ï¼Œåˆ©ç”¨BITFIELDå‘½ä»¤æ¥å®ç°æŸ¥è¯¢ç­¾åˆ°è®°å½•åŠŸèƒ½äº†ã€‚

:::tip æ‹“å±•

Redisæœ€åŸºç¡€çš„æ•°æ®ç±»å‹åªæœ‰5ç§ï¼šStringã€Listã€Setã€SortedSetã€Hashï¼Œå…¶å®ƒç‰¹æ®Šæ•°æ®ç»“æ„å¤§å¤šéƒ½æ˜¯åŸºäºä»¥ä¸Š5è¿™ç§æ•°æ®ç±»å‹ã€‚

BitMapä¹Ÿä¸ä¾‹å¤–ï¼Œå®ƒæ˜¯åŸºäºStringç»“æ„çš„ã€‚å› ä¸ºRedisçš„Stringç±»å‹åº•å±‚æ˜¯SDSï¼Œä¹Ÿä¼šå­˜åœ¨ä¸€ä¸ªå­—èŠ‚æ•°ç»„ç”¨æ¥ä¿å­˜æ•°æ®ã€‚è€ŒRediså°±æä¾›äº†å‡ ä¸ªæŒ‰ä½æ“ä½œè¿™ä¸ªæ•°ç»„ä¸­æ•°æ®çš„å‘½ä»¤ï¼Œå®ç°äº†BitMapæ•ˆæœã€‚

ç”±äºStringç±»å‹çš„æœ€å¤§ç©ºé—´æ˜¯512MBï¼Œä¹Ÿå°±æ˜¯2çš„31æ¬¡å¹‚ä¸ªbitï¼Œå› æ­¤å¯ä»¥ä¿å­˜çš„æ•°æ®é‡çº§æ˜¯ååˆ†ææ€–çš„ã€‚

:::

æƒ³è¦äº†è§£Redisçš„SDSç»“æ„ï¼Œå¯ä»¥å‚è€ƒä¸‹é¢è§†é¢‘ï¼š

https://www.bilibili.com/video/BV1cr4y1671t?p=146&vd_source=1ff0c1b434581723cf696ccc2f59ceaa

<br/>

### ç­¾åˆ°æ¥å£

åœ¨ä¸ªäººä¸­å¿ƒçš„ç§¯åˆ†é¡µé¢ï¼Œç”¨æˆ·æ¯å¤©éƒ½å¯ä»¥ç­¾åˆ°ä¸€æ¬¡ï¼Œè¿ç»­ç­¾åˆ°åˆ™æœ‰ç§¯åˆ†å¥–åŠ±ï¼Œè¯·å®ç°ç­¾åˆ°æ¥å£ï¼Œè®°å½•ç”¨æˆ·æ¯å¤©ç­¾åˆ°ä¿¡æ¯ï¼Œæ–¹ä¾¿åšç­¾åˆ°ç»Ÿè®¡ã€‚

<br/>

#### æ¥å£è®¾è®¡å’Œåˆ†æ

åœ¨ä¸ªäººä¸­å¿ƒçš„ç§¯åˆ†é¡µé¢ï¼Œç”¨æˆ·æ¯å¤©éƒ½å¯ä»¥ç­¾åˆ°ä¸€æ¬¡ï¼š

![img](./assets/20230725154232444.jpg)

è€Œåœ¨åå°ï¼Œè¦åšçš„äº‹æƒ…å°±æ˜¯æŠŠBitMapä¸­çš„ä¸ç­¾åˆ°æ—¥æœŸå¯¹åº”çš„bitä½ï¼Œç½®ä¸º1.

å¦å¤–ï¼Œä¸ºäº†ä¾¿äºç»Ÿè®¡ï¼Œæˆ‘ä»¬è®¡åˆ’æ¯ä¸ªæœˆä¸ºæ¯ä¸ªç”¨æˆ·ç”Ÿæˆä¸€ä¸ªç‹¬ç«‹çš„KEYï¼Œå› æ­¤KEYä¸­å¿…é¡»åŒ…å«ç”¨æˆ·ä¿¡æ¯ã€æœˆä»½ä¿¡æ¯ï¼Œé•¿è¿™æ ·ï¼š

```Shell
sign:uid:xxx:202401
```

æˆ‘ä»¬å¯ä»¥æå‰å®šä¹‰è¿™æ ·ä¸€ä¸ªKEYå‰ç¼€çš„å¸¸é‡ï¼š

![img](./assets/20230725154232370.jpg)

ç”±KEYçš„ç»“æ„å¯çŸ¥ï¼Œè¦ç­¾åˆ°ï¼Œå°±å¿…é¡»çŸ¥é“æ˜¯**è°**åœ¨**å“ªä¸€å¤©**ç­¾åˆ°ï¼Œä¹Ÿå°±æ˜¯ä¸¤ä¸ªä¿¡æ¯ï¼š

- å½“å‰ç”¨æˆ·
- å½“å‰æ—¶é—´

è¿™ä¸¤ä¸ªä¿¡æ¯æˆ‘ä»¬éƒ½å¯ä»¥è‡ªå·±è·å–ï¼Œå› æ­¤ç­¾åˆ°æ—¶ï¼Œå‰ç«¯æ— éœ€ä¼ é€’ä»»ä½•å‚æ•°ã€‚

<br/>

é‚£ä¹ˆç­¾åˆ°ä»¥åæ˜¯å¦éœ€è¦è¿”å›æ•°æ®å‘¢ï¼Ÿ

éœ€æ±‚ä¸­è¯´è¿ç»­ç­¾åˆ°ä¼šæœ‰ç§¯åˆ†å¥–åŠ±ï¼Œé‚£ä¹ˆä¸ºäº†æå‡ç”¨æˆ·ä½“éªŒï¼Œåœ¨ç”¨æˆ·ç­¾åˆ°æˆåŠŸä»¥åæ˜¯ä¸æ˜¯åº”è¯¥è¿”å›è¿ç»­ç­¾åˆ°å¤©æ•°å’Œè·å–çš„ç§¯åˆ†å¥–åŠ±å‘¢ã€‚

ç»¼ä¸Šï¼Œæœ€ç»ˆç­¾åˆ°çš„æ¥å£ä¿¡æ¯å¦‚ä¸‹ï¼š

![image-20240213174815046](assets/image-20240213174815046.png)<br/>

#### å®ä½“

ç­¾åˆ°æ¥å£åªéœ€è¦ä¸€ä¸ªè¿”å›å€¼VOï¼Œåœ¨è¯¾å‰èµ„æ–™ä¸­å·²ç»æä¾›äº†ï¼š

![img](./assets/20230725154233209.jpg)

å…·ä½“ä»£ç ï¼š

```Java
package com.tianji.learning.domain.vo;

import com.fasterxml.jackson.annotation.JsonIgnore;
import io.swagger.annotations.ApiModel;
import io.swagger.annotations.ApiModelProperty;
import lombok.Data;

@Data
@ApiModel(description = "ç­¾åˆ°ç»“æœ")
public class SignResultVO {
    @ApiModelProperty("è¿ç»­ç­¾åˆ°å¤©æ•°")
    private Integer signDays;
    @ApiModelProperty("ç­¾åˆ°å¾—åˆ†")
    private Integer signPoints = 1;
    @ApiModelProperty("è¿ç»­ç­¾åˆ°å¥–åŠ±ç§¯åˆ†ï¼Œè¿ç»­ç­¾åˆ°è¶…è¿‡7å¤©ä»¥ä¸Šæ‰æœ‰å¥–åŠ±")
    private Integer rewardPoints;

    @JsonIgnore
    public int totalPoints(){
        return signPoints + rewardPoints;
    }
}
```

<br/>

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œç«Ÿç„¶æ˜¯3ä¸ªå­—æ®µï¼š

- signDaysï¼šè¿ç»­ç­¾åˆ°å¤©æ•°
- signPointsï¼šç­¾åˆ°å¾—åˆ†ï¼Œå›ºå®šä¸º1
- rewardPointsï¼šè¿ç»­ç­¾åˆ°çš„å¥–åŠ±ç§¯åˆ†

è¿™ä¸äº§å“çš„éœ€æ±‚æ˜¯ä¸€è‡´çš„ï¼Œæ­£å¸¸ç­¾åˆ°å¾—1åˆ†ï¼Œè¿ç»­ç­¾åˆ°åˆ™æœ‰ç§¯åˆ†å¥–åŠ±ã€‚è¿™é‡Œæ˜¯æŠŠç§¯åˆ†æ˜ç»†è¿”å›äº†ï¼Œå‰ç«¯å¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€æ±‚å±•ç¤ºã€‚

é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œæˆ‘ä»¬è¯¥å¦‚ä½•ç»Ÿè®¡ç”¨æˆ·è¿ç»­ç­¾åˆ°äº†å‡ å¤©å‘¢ï¼Ÿ

<br/>

#### è¿ç»­ç­¾åˆ°ç»Ÿè®¡

å¦‚ä½•å¾—åˆ°è¿ç»­ç­¾åˆ°å¤©æ•°ï¼Ÿéœ€è¦ä¸‹é¢å‡ æ­¥ï¼š

- è·å–æœ¬æœˆåˆ°ä»Šå¤©ä¸ºæ­¢çš„æ‰€æœ‰ç­¾åˆ°æ•°æ®
- ä»ä»Šå¤©å¼€å§‹ï¼Œå‘å‰ç»Ÿè®¡ï¼Œç›´åˆ°é‡åˆ°ç¬¬ä¸€æ¬¡æœªç­¾åˆ°ä¸ºæ­¢ï¼Œè®¡ç®—æ€»çš„ç­¾åˆ°æ¬¡æ•°ï¼Œå°±æ˜¯è¿ç»­ç­¾åˆ°å¤©æ•°

å¦‚å›¾ï¼š

![img](./assets/20230725154231772.jpg)

<br/>

å¦‚æœç”¨ä¸€ä¸ªä¼ªä»£ç æ¥è¡¨ç¤ºï¼Œå¤§æ¦‚æ˜¯è¿™æ ·ï¼š

```Shell
int count = 0; // å®šä¹‰ä¸€ä¸ªè®¡æ•°å™¨
for(/*ä»åå‘å‰éå†ç­¾åˆ°è®°å½•ä¸­çš„æ¯ä¸€ä¸ªbitä½*/){
    // åˆ¤æ–­æ˜¯å¦æ˜¯1
    // å¦‚æœæ˜¯ï¼Œåˆ™count++
}
```

<br/>

è¿™é‡Œå­˜åœ¨å‡ ä¸ªé—®é¢˜ï¼š

- å¦‚ä½•æ‰èƒ½å¾—åˆ°æœ¬æœˆåˆ°ä»Šå¤©ä¸ºæ­¢çš„æ‰€æœ‰ç­¾åˆ°è®°å½•ï¼Ÿ
- å¦‚ä½•ä»åå‘å‰éå†æ¯ä¸€ä¸ªbitä½ï¼Ÿ

<br/>

è‡³äºç­¾åˆ°è®°å½•ï¼Œå¯ä»¥åˆ©ç”¨æˆ‘ä»¬ä¹‹å‰è®²çš„BITFIELDå‘½ä»¤æ¥è·å–ï¼Œä»0å¼€å§‹ï¼Œåˆ°ä»Šå¤©ä¸ºæ­¢çš„è®°å½•ï¼Œå‘½ä»¤æ˜¯è¿™æ ·çš„ï¼š

```Shell
BITFIELD key GET u[dayOfMonth] 0
```

<br/>

ä½†æ˜¯éå†bitä½è¯¥æ€ä¹ˆæ“ä½œï¼Ÿæˆ‘ä»¬ä»æ²¡å­¦è¿‡äºŒè¿›åˆ¶æ•°å­—çš„éå†å•Šï¼

<br/>

**ä½ å¯ä»¥æŠŠäºŒè¿›åˆ¶æ•°ä¸­çš„æ¯ä¸€ä¸ªbitä½å½“åšå¼¹å¤¹ä¸­çš„ä¸€ä¸ªä¸ªçš„å­å¼¹ã€‚éå†bitä½çš„è¿‡ç¨‹ï¼Œå°±æ˜¯æ‰“ç©ºå¼¹å¤¹çš„è¿‡ç¨‹**ï¼š

- å°†å¼¹å¤¹æœ€ä¸Šæ–¹çš„å­å¼¹ä¸Šè†›ï¼ˆæ‰¾åˆ°æœ€åä¸€ä¸ªbitä½ï¼Œå¹¶è·å–å®ƒï¼‰
- å‘å°„å­å¼¹ï¼ˆç§»é™¤è¿™ä¸ªbitä½ï¼Œä¸‹ä¸€ä¸ªbitä½å°±æˆä¸ºæœ€åä¸€ä¸ªï¼‰
- å›åˆ°æ­¥éª¤1

æœ€ç»ˆï¼Œæ¯ä¸€å‘å­å¼¹éƒ½ä¼šä»å¤‡å‘å°„ï¼Œè¿™å°±åƒæ¯ä¸€ä¸ªbitä½éƒ½ä¼šè¢«éå†ã€‚

<br/>

å› æ­¤ï¼Œç°åœ¨é—®é¢˜å°±è½¬åŒ–ä¸ºä¸¤ä»¶äº‹æƒ…ï¼š

- å¦‚ä½•æ‰¾åˆ°å¹¶è·å–ç­¾åˆ°è®°å½•ä¸­æœ€åä¸€ä¸ªbitä½
  - ä»»ä½•æ•°ä¸1åšä¸è¿ç®—ï¼Œå¾—åˆ°çš„ç»“æœå°±æ˜¯å®ƒæœ¬èº«ã€‚å› æ­¤æˆ‘ä»¬è®©ç­¾åˆ°è®°å½•ä¸1åšä¸è¿ç®—ï¼Œå°±å¾—åˆ°äº†æœ€åä¸€ä¸ªbitä½
- å¦‚ä½•ç§»é™¤è¿™ä¸ªbitä½
  - æŠŠæ•°å­—å³ç§»ä¸€ä½ï¼Œæœ€åä¸€ä½åˆ°äº†å°æ•°ç‚¹å³ä¾§ï¼Œç”±äºæˆ‘ä»¬ä¿ç•™æ•´æ•°ï¼Œæœ€åä¸€ä½è‡ªç„¶å°±è¢«ä¸¢å¼ƒäº†

<br/>

#### å®ç°æ¥å£

é¦–å…ˆï¼Œåœ¨`tj-learning`æœåŠ¡ä¸­çš„`com.tianji.learning.controller.SignRecordController`ä¸­å®šä¹‰æ¥å£ï¼š

```Java
package com.tianji.learning.controller;

import com.tianji.learning.domain.vo.SignResultVO;
import com.tianji.learning.service.ISignRecordService;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import lombok.RequiredArgsConstructor;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

@Api(tags = "ç­¾åˆ°ç›¸å…³æ¥å£")
@RestController
@RequestMapping("sign-records")
@RequiredArgsConstructor
public class SignRecordController {

    private final ISignRecordService recordService;

    @PostMapping
    @ApiOperation("ç­¾åˆ°åŠŸèƒ½æ¥å£")
    public SignResultVO addSignRecords(){
        return recordService.addSignRecords();
    }
}
```

<br/>

ç„¶åï¼Œåœ¨`com.tianji.learning.service.ISignRecordService`ä¸­å®šä¹‰serviceæ–¹æ³•ï¼š

```Java
package com.tianji.learning.service;

import com.tianji.learning.domain.vo.SignResultVO;

public interface ISignRecordService {
    SignResultVO addSignRecords();
}
```

<br/>

æœ€åï¼Œåœ¨`com.tianji.learning.service.impl.SignRecordServiceImpl`ä¸­å®ç°æ–¹æ³•ï¼š

```Java
package com.tianji.learning.service.impl;

import com.tianji.common.autoconfigure.mq.RabbitMqHelper;
import com.tianji.common.constants.MqConstants;
import com.tianji.common.exceptions.BizIllegalException;
import com.tianji.common.utils.BooleanUtils;
import com.tianji.common.utils.CollUtils;
import com.tianji.common.utils.DateUtils;
import com.tianji.common.utils.UserContext;
import com.tianji.learning.constants.RedisConstants;
import com.tianji.learning.domain.vo.SignResultVO;
import com.tianji.learning.mq.message.SignInMessage;
import com.tianji.learning.service.ISignRecordService;
import lombok.RequiredArgsConstructor;
import org.springframework.data.redis.connection.BitFieldSubCommands;
import org.springframework.data.redis.core.StringRedisTemplate;
import org.springframework.stereotype.Service;

import java.time.LocalDate;
import java.util.List;

@Service
@RequiredArgsConstructor
public class SignRecordServiceImpl implements ISignRecordService {

    private final StringRedisTemplate redisTemplate;

    @Override
    public SignResultVO addSignRecords() {
        // 1.ç­¾åˆ°
        // 1.1.è·å–ç™»å½•ç”¨æˆ·
        Long userId = UserContext.getUser();
        // 1.2.è·å–æ—¥æœŸ
        LocalDate now = LocalDate.now();
        // 1.3.æ‹¼æ¥key
        String key = RedisConstants.SIGN_RECORD_KEY_PREFIX
                + userId
                + now.format(DateUtils.SIGN_DATE_SUFFIX_FORMATTER);
        // 1.4.è®¡ç®—offset
        int offset = now.getDayOfMonth() - 1;
        // 1.5.ä¿å­˜ç­¾åˆ°ä¿¡æ¯
        Boolean exists = redisTemplate.opsForValue().setBit(key, offset, true);
        if (BooleanUtils.isTrue(exists)) {
            throw new BizIllegalException("ä¸å…è®¸é‡å¤ç­¾åˆ°ï¼");
        }
        // 2.è®¡ç®—è¿ç»­ç­¾åˆ°å¤©æ•°
        int signDays = countSignDays(key, now.getDayOfMonth());
        // 3.è®¡ç®—ç­¾åˆ°å¾—åˆ†
        int rewardPoints = 0;
        switch (signDays) {
            case 7:
                rewardPoints = 10;
                break;
            case 14:
                rewardPoints = 20;
                break;
            case 28:
                rewardPoints = 40;
                break;
        }
        // TODO 4.ä¿å­˜ç§¯åˆ†æ˜ç»†è®°å½• 
        
        // 5.å°è£…è¿”å›
        SignResultVO vo = new SignResultVO();
        vo.setSignDays(signDays);
        vo.setRewardPoints(rewardPoints);
        return vo;
    }

    private int countSignDays(String key, int len) {
        // 1.è·å–æœ¬æœˆä»ç¬¬ä¸€å¤©å¼€å§‹ï¼Œåˆ°ä»Šå¤©ä¸ºæ­¢çš„æ‰€æœ‰ç­¾åˆ°è®°å½•
        List<Long> result = redisTemplate.opsForValue()
                .bitField(key, BitFieldSubCommands.create().get(
                        BitFieldSubCommands.BitFieldType.unsigned(len)).valueAt(0));
        if (CollUtils.isEmpty(result)) {
            return 0;
        }
        int num = result.get(0).intValue();
        // 2.å®šä¹‰ä¸€ä¸ªè®¡æ•°å™¨
        int count = 0;
        // 3.å¾ªç¯ï¼Œä¸1åšä¸è¿ç®—ï¼Œå¾—åˆ°æœ€åä¸€ä¸ªbitï¼Œåˆ¤æ–­æ˜¯å¦ä¸º0ï¼Œä¸º0åˆ™ç»ˆæ­¢ï¼Œä¸º1åˆ™ç»§ç»­
        while ((num & 1) == 1) {
            // 4.è®¡æ•°å™¨+1
            count++;
            // 5.æŠŠæ•°å­—å³ç§»ä¸€ä½ï¼Œæœ€åä¸€ä½è¢«èˆå¼ƒï¼Œå€’æ•°ç¬¬äºŒä½æˆäº†æœ€åä¸€ä½
            num >>>= 1;
        }
        return count;
    }
}
```



## ç§¯åˆ†åŠŸèƒ½

 ç”¨æˆ·ç­¾åˆ°ã€å­¦ä¹ ã€å‚ä¸äº’åŠ¨é—®ç­”ã€æäº¤å­¦ä¹ ç¬”è®°ç­‰è¡Œä¸ºéƒ½å¯ä»¥äº§ç”Ÿç§¯åˆ†ï¼Œå¹¶åŸºäºç§¯åˆ†å½¢æˆæ’è¡Œæ¦œã€‚ç§¯åˆ†å½“æœˆæœ‰æ•ˆï¼Œæœˆåº•æ¸…é›¶ã€‚

### æ–°å¢ç§¯åˆ†

ç”±ç§¯åˆ†è§„åˆ™å¯çŸ¥ï¼Œè·å–ç§¯åˆ†çš„è¡Œä¸ºå¤šç§å¤šæ ·ï¼Œè€Œä¸”æ¯ä¸€ç§è¡Œä¸ºéƒ½æœ‰è‡ªå·±çš„ç‹¬ç«‹ä¸šåŠ¡ã€‚è€Œè¿™äº›è¡Œä¸ºäº§ç”Ÿçš„æ—¶å€™éœ€è¦ä¿å­˜ä¸€æ¡ç§¯åˆ†æ˜ç»†åˆ°æ•°æ®åº“ã€‚

æˆ‘ä»¬æ˜¾ç„¶ä¸èƒ½è¦æ±‚å…¶å®ƒä¸šåŠ¡çš„å¼€å‘è€…åœ¨å¼€å‘æ—¶å¸®æˆ‘ä»¬æ–°å¢ä¸€æ¡ç§¯åˆ†è®°å½•ï¼Œè¿™æ ·ä¼šå¯¼è‡´åŸæœ‰ä¸šåŠ¡ä¸ç§¯åˆ†ä¸šåŠ¡è€¦åˆã€‚å› æ­¤å¿…é¡»é‡‡ç”¨å¼‚æ­¥æ–¹å¼ï¼Œå°†åŸæœ‰ä¸šåŠ¡ä¸ç§¯åˆ†ä¸šåŠ¡è§£è€¦ã€‚

å¦‚æœæœ‰å¿…è¦ï¼Œç”šè‡³å¯ä»¥å°†ç§¯åˆ†ä¸šåŠ¡æŠ½ç¦»ï¼Œä½œä¸ºç‹¬ç«‹å¾®æœåŠ¡ã€‚

<br/>

#### æ€è·¯åˆ†æ

å¼‚æ­¥è§£è€¦çš„æ–¹å¼æœ‰å¾ˆå¤šï¼Œæ¯”å¦‚ï¼š

- åˆ©ç”¨Springçš„`@EventListener`åŠŸèƒ½ï¼šå¾€å¾€åœ¨åŒä¸€ä¸ªæœåŠ¡å†…ä½¿ç”¨
- åˆ©ç”¨MQï¼šå¾€å¾€ç”¨åœ¨è·¨æœåŠ¡ä¸šåŠ¡ä¸­ä½¿ç”¨

<br/>

è™½ç„¶æˆ‘ä»¬ç§¯åˆ†åŠŸèƒ½ç›®å‰æ˜¯åœ¨å­¦ä¹ ä¸­å¿ƒå®ç°çš„ï¼Œä¸è¿‡è€ƒè™‘çš„ä»¥åçš„æ‰©å±•æ€§ï¼Œæ­¤å¤„æˆ‘ä»¬è¿˜æ˜¯è€ƒè™‘ä½¿ç”¨MQæ¥å®ç°å¼‚æ­¥è§£è€¦ã€‚

å¤§æ¦‚çš„é€šä¿¡æ¨¡å¼æ˜¯è¿™æ ·çš„ï¼š

![image-20240213175055770](assets/image-20240213175055770.png)

<br/>

å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦ä¸ºæ¯ä¸€ç§ç§¯åˆ†è¡Œä¸ºå®šä¹‰ä¸€ä¸ªä¸åŒçš„RoutingKeyï¼Œåœ¨tj-commonæ¨¡å—ä¸­å·²ç»å®šä¹‰å¥½äº†ï¼š

![img](./assets/20230725154233810.jpg)

é‚£ç°åœ¨åªéœ€è¦è€ƒè™‘MQä¼ é€’çš„æ¶ˆæ¯æ ¼å¼å°±å¯ä»¥äº†ã€‚

<br/>

æœ€åä¿å­˜çš„ç§¯åˆ†è®°å½•æ ¼å¼å¦‚ä¸‹ï¼š

```SQL
CREATE TABLE IF NOT EXISTS `points_record` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT 'ç§¯åˆ†è®°å½•è¡¨id',
  `user_id` bigint NOT NULL COMMENT 'ç”¨æˆ·id',
  `type` tinyint NOT NULL COMMENT 'ç§¯åˆ†æ–¹å¼ï¼š1-è¯¾ç¨‹å­¦ä¹ ï¼Œ2-æ¯æ—¥ç­¾åˆ°ï¼Œ3-è¯¾ç¨‹é—®ç­”ï¼Œ 4-è¯¾ç¨‹ç¬”è®°ï¼Œ5-è¯¾ç¨‹è¯„ä»·',
  `points` tinyint NOT NULL COMMENT 'ç§¯åˆ†å€¼',
  `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
  PRIMARY KEY (`id`) USING BTREE,
  KEY `idx_user_id` (`user_id`,`type`) USING BTREE,
  KEY `idx_create_time` (`create_time`) USING BTREE
) ENGINE=InnoDB AUTO_INCREMENT=41 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ROW_FORMAT=DYNAMIC COMMENT='å­¦ä¹ ç§¯åˆ†è®°å½•ï¼Œæ¯ä¸ªæœˆåº•æ¸…é›¶';
```

æˆ‘ä»¬éœ€è¦çŸ¥é“ï¼š

- userIdï¼šç”¨æˆ·ä¿¡æ¯ï¼Œå¿…é¡»ä¼ é€’
- typeï¼šç§¯åˆ†ç±»å‹ï¼Œç”±äºä¸åŒç±»å‹é€šè¿‡ä¸åŒçš„RoutingKeyæ¥å‘é€ï¼Œé€šè¿‡RoutingKeyå¯ä»¥åˆ¤æ–­ç§¯åˆ†ç±»å‹ï¼Œæ— éœ€ä¼ é€’
- pointsï¼šç§¯åˆ†å€¼ï¼Œç§¯åˆ†å€¼ä¹Ÿéšç§¯åˆ†æ–¹å¼å˜åŒ–ï¼Œæ— éœ€ä¼ é€’
- createTimeï¼šæ—¶é—´ï¼Œå°±æ˜¯å½“å‰æ—¶é—´ï¼Œæ— éœ€ä¼ é€’

<br/>

ç»¼ä¸Šï¼Œåœ¨MQä¸­æˆ‘ä»¬åªéœ€è¦ä¼ é€’ç”¨æˆ·idä¸€ä¸ªå‚æ•°å³å¯ã€‚

<br/>

#### å‘é€MQæ¶ˆæ¯

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±å¯ä»¥æ”¹é€ ä¹‹å‰çš„ä¸šåŠ¡ï¼Œå†æ‰€æœ‰å¯ä»¥è·å–ç§¯åˆ†çš„ä¸šåŠ¡ä¸­å‘é€MQæ¶ˆæ¯äº†ã€‚åŒ…æ‹¬ä¸‹åˆ—åœ°æ–¹ï¼š

- ç­¾åˆ°
- å®Œæˆä¸€å°èŠ‚çš„å­¦ä¹ ï¼ˆè§†é¢‘ã€è€ƒè¯•å‡å¯ï¼‰
- å›ç­”é—®é¢˜
- å†™ç¬”è®°ï¼ˆæœªå®ç°ï¼‰
- ç¬”è®°è¢«é‡‡é›†ï¼ˆæœªå®ç°ï¼‰

<br/>

è¿™é‡Œæˆ‘ä»¬ä»¥ç­¾åˆ°åŠŸèƒ½ä¸ºä¾‹ï¼Œç»™å¤§å®¶ç¤ºèŒƒä¸€ä¸‹æ¶ˆæ¯å‘é€çš„ä»£ç ã€‚ç­¾åˆ°åŠŸèƒ½æ¯”è¾ƒç‰¹æ®Šï¼Œå› ä¸ºç­¾åˆ°ç§¯åˆ†ä¸æ˜¯å›ºå®šçš„ï¼Œæˆ‘ä»¬æ— æ³•ç¡®å®šï¼Œå¿…é¡»ç”±ä¸šåŠ¡æ–¹é€šè¿‡MQæ¶ˆæ¯ä¼ é€’ç»™æˆ‘ä»¬ã€‚å› æ­¤éœ€è¦å…ˆå®šä¹‰ä¸€ä¸ªMQæ¶ˆæ¯ä½“ï¼š

![img](./assets/20230725154232170.jpg)

<br/>

ç»“æ„å¦‚ä¸‹ï¼š

```Java
package com.tianji.learning.mq.message;

import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.NoArgsConstructor;

@Data
@NoArgsConstructor
@AllArgsConstructor(staticName = "of")
public class SignInMessage {
    private Long userId;
    private Integer points;
}
```

<br/>

ç„¶åæ”¹é€ `com.tianji.learning.service.impl.SignRecordServiceImpl`ä¸­çš„ç­¾åˆ°åŠŸèƒ½ï¼š

```Java
package com.tianji.learning.service.impl;

// ... ç•¥

@Service
@RequiredArgsConstructor
public class SignRecordServiceImpl implements ISignRecordService {

    private final StringRedisTemplate redisTemplate;

    private final RabbitMqHelper mqHelper;

    @Override
    public SignResultVO addSignRecords() {
        // 1.ç­¾åˆ°
        // 1.1.è·å–ç™»å½•ç”¨æˆ·
        Long userId = UserContext.getUser();
        // 1.2.è·å–æ—¥æœŸ
        LocalDate now = LocalDate.now();
        // 1.3.æ‹¼æ¥key
        String key = RedisConstants.SIGN_RECORD_KEY_PREFIX
                + userId
                + now.format(DateUtils.SIGN_DATE_SUFFIX_FORMATTER);
        // 1.4.è®¡ç®—offset
        int offset = now.getDayOfMonth() - 1;
        // 1.5.ä¿å­˜ç­¾åˆ°ä¿¡æ¯
        Boolean exists = redisTemplate.opsForValue().setBit(key, offset, true);
        if (BooleanUtils.isTrue(exists)) {
            throw new BizIllegalException("ä¸å…è®¸é‡å¤ç­¾åˆ°ï¼");
        }
        // 2.è®¡ç®—è¿ç»­ç­¾åˆ°å¤©æ•°
        int signDays = countSignDays(key, now.getDayOfMonth());
        // 3.è®¡ç®—ç­¾åˆ°å¾—åˆ†
        int rewardPoints = 0;
        switch (signDays) {
            case 7:
                rewardPoints = 10;
                break;
            case 14:
                rewardPoints = 20;
                break;
            case 28:
                rewardPoints = 40;
                break;
        }
        // 4.ä¿å­˜ç§¯åˆ†æ˜ç»†è®°å½•
        mqHelper.send(
                MqConstants.Exchange.LEARNING_EXCHANGE,
                MqConstants.Key.SIGN_IN,
                SignInMessage.of(userId, rewardPoints + 1));// ç­¾åˆ°ç§¯åˆ†æ˜¯åŸºæœ¬å¾—åˆ†+å¥–åŠ±ç§¯åˆ†
        // 5.å°è£…è¿”å›
        SignResultVO vo = new SignResultVO();
        vo.setSignDays(signDays);
        vo.setRewardPoints(rewardPoints);
        return vo;
    }
}
```

<br/>

#### ç¼–å†™æ¶ˆæ¯ç›‘å¬å™¨

æ¥ä¸‹æ¥ï¼Œå°±å¯ä»¥å»ç¼–å†™æ¶ˆæ¯ç›‘å¬å™¨äº†ã€‚6ç§ä¸åŒç§¯åˆ†è·å–æ–¹å¼ï¼Œå°±éœ€è¦6ç§æ¶ˆæ¯ç›‘å¬å™¨ï¼Œè¿™é‡Œæˆ‘ä»¬å…ˆå®ç°ä¸¤ä¸ªï¼š

- ç­¾åˆ°
- å†™äº’åŠ¨é—®ç­”

å‰©ä¸‹çš„å¤§å®¶è‡ªå·±å®Œæˆã€‚

åœ¨`tj-learning`æ¨¡å—å®šä¹‰ä¸€ä¸ªæ¶ˆæ¯ç›‘å¬å™¨ç±»ï¼š

![img](./assets/20230725154233094.jpg)

<br/>

å…·ä½“ä»£ç å¦‚ä¸‹ï¼š

```Java
package com.tianji.learning.mq;

import com.tianji.common.constants.MqConstants;
import com.tianji.learning.enums.PointsRecordType;
import com.tianji.learning.mq.message.SignInMessage;
import com.tianji.learning.service.IPointsRecordService;
import lombok.RequiredArgsConstructor;
import org.springframework.amqp.core.ExchangeTypes;
import org.springframework.amqp.rabbit.annotation.Exchange;
import org.springframework.amqp.rabbit.annotation.Queue;
import org.springframework.amqp.rabbit.annotation.QueueBinding;
import org.springframework.amqp.rabbit.annotation.RabbitListener;
import org.springframework.stereotype.Component;

@Component
@RequiredArgsConstructor
public class LearningPointsListener {

    private final IPointsRecordService recordService;
    // ç›‘å¬æ–°å¢äº’åŠ¨é—®ç­”äº‹ä»¶
    @RabbitListener(bindings = @QueueBinding(
            value = @Queue(name = "qa.points.queue", durable = "true"),
            exchange = @Exchange(name = MqConstants.Exchange.LEARNING_EXCHANGE, type = ExchangeTypes.TOPIC),
            key = MqConstants.Key.WRITE_REPLY
    ))
    public void listenWriteReplyMessage(Long userId){
        recordService.addPointsRecord(userId, 5, PointsRecordType.QA);
    }
    // ç›‘å¬ç­¾åˆ°äº‹ä»¶
    @RabbitListener(bindings = @QueueBinding(
            value = @Queue(name = "sign.points.queue", durable = "true"),
            exchange = @Exchange(name = MqConstants.Exchange.LEARNING_EXCHANGE, type = ExchangeTypes.TOPIC),
            key = MqConstants.Key.SIGN_IN
    ))
    public void listenSignInMessage(SignInMessage message){
        recordService.addPointsRecord(message.getUserId(), message.getPoints(), PointsRecordType.SIGN);
    }
}
```

<br/>

ç›‘å¬åˆ°æ¶ˆæ¯åï¼Œè¿™é‡Œå¹¶æ²¡æœ‰å†™åç»­çš„ä¸šåŠ¡å¤„ç†ï¼Œè€Œæ˜¯äº¤ç»™äº†`com.tianji.learning.service.IPointsRecordService`ç±»ä¸­çš„`addPointsRecord`æ–¹æ³•æ¥å¤„ç†ï¼Œå¹¶ä¸”ä¼ é€’äº†3ä¸ªå‚æ•°ï¼š

- ç”¨æˆ·id
- ç§¯åˆ†å€¼
- ç§¯åˆ†ç±»å‹æšä¸¾ï¼šå…¶ä¸­åŒ…å«äº†ç§¯åˆ†çš„æœ€å¤§å€¼ï¼Œæ–¹ä¾¿åšä¸šåŠ¡å¤„ç†ã€‚

<br/>

æˆ‘ä»¬åœ¨tj-learningæ¨¡å—çš„`com.tianji.learning.service.IPointsRecordService`ä¸­æ·»åŠ serviceæ–¹æ³•ï¼š

```Java
package com.tianji.learning.service;

import com.baomidou.mybatisplus.extension.service.IService;
import com.tianji.learning.domain.po.PointsRecord;
import com.tianji.learning.enums.PointsRecordType;

import java.util.List;

/**
 * <p>
 * å­¦ä¹ ç§¯åˆ†è®°å½•ï¼Œæ¯ä¸ªæœˆåº•æ¸…é›¶ æœåŠ¡ç±»
 * </p>
 *
 * @author è™å“¥
 */
public interface IPointsRecordService extends IService<PointsRecord> {
    void addPointsRecord(Long userId, int points, PointsRecordType type);
}
```

<br/>

ç„¶ååœ¨`com.tianji.learning.service.impl.PointsRecordServiceImpl`ä¸­å®ç°è¯¥æ–¹æ³•ï¼š

```Java
package com.tianji.learning.service.impl;

// ... ç•¥
import java.util.List;

/**
 * <p>
 * å­¦ä¹ ç§¯åˆ†è®°å½•ï¼Œæ¯ä¸ªæœˆåº•æ¸…é›¶ æœåŠ¡å®ç°ç±»
 * </p>
 */
@Service
@RequiredArgsConstructor
public class PointsRecordServiceImpl extends ServiceImpl<PointsRecordMapper, PointsRecord> implements IPointsRecordService {

    @Override
    public void addPointsRecord(Long userId, int points, PointsRecordType type) {
        // TODO ä¿å­˜ç§¯åˆ†æ˜ç»†
    }
}
```

<br/>

#### ä¿å­˜ç§¯åˆ†æ˜ç»†

åœ¨ç›‘å¬åˆ°æ¶ˆæ¯é€šçŸ¥åï¼Œä¸èƒ½è¯´ç›´æ¥ä¿å­˜ç§¯åˆ†æ˜ç»†åˆ°æ•°æ®åº“ã€‚å› ä¸ºç§¯åˆ†è§„åˆ™ä¸­å¾ˆå¤šç±»å‹çš„ç§¯åˆ†æ˜¯æœ‰ä¸Šé™çš„ï¼š

å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ä¿å­˜åˆ°æ•°æ®åº“ä¹‹å‰ï¼Œå…ˆåˆ¤æ–­æ˜¯å¦è¶…è¿‡ç§¯åˆ†ä¸Šé™ã€‚

å¦‚ä½•åˆ¤æ–­å‘¢ï¼Ÿ

<br/>

ç¬¬ä¸€ï¼šæˆ‘ä»¬è¦çŸ¥é“ç§¯åˆ†ä¸Šé™ã€‚è¿™ä¸ªåœ¨ç§¯åˆ†ç±»å‹æšä¸¾ä¸­å®šä¹‰äº†ï¼Œç®—æ˜¯å·²çŸ¥ã€‚

ç¬¬äºŒï¼šæˆ‘ä»¬è¦çŸ¥é“ç”¨æˆ·ä»Šå¤©å·²ç»å¾—äº†å¤šå°‘åˆ†ã€‚è¿™ä¸ªå°±è¦å»æ•°æ®åº“æŸ¥è¯¢ç»Ÿè®¡äº†ã€‚

<br/>

ç»¼ä¸Šï¼Œæˆ‘ä»¬æœ€ç»ˆçš„ä¸šåŠ¡æµç¨‹åº”è¯¥æ˜¯è¿™æ ·çš„ï¼š

![image-20240213175536785](assets/image-20240213175536785.png)

<br/>

æ¥ä¸‹æ¥ï¼Œåœ¨`com.tianji.learning.service.impl.PointsRecordServiceImpl`ä¸­å®ç°è¿™æ®µé€»è¾‘ï¼š

```Java
@Override
public void addPointsRecord(Long userId, int points, PointsRecordType type) {
    LocalDateTime now = LocalDateTime.now();
    int maxPoints = type.getMaxPoints();
    // 1.åˆ¤æ–­å½“å‰æ–¹å¼æœ‰æ²¡æœ‰ç§¯åˆ†ä¸Šé™
    int realPoints = points;
    if(maxPoints > 0) {
        // 2.æœ‰ï¼Œåˆ™éœ€è¦åˆ¤æ–­æ˜¯å¦è¶…è¿‡ä¸Šé™
        LocalDateTime begin = DateUtils.getDayStartTime(now);
        LocalDateTime end = DateUtils.getDayEndTime(now);
        // 2.1.æŸ¥è¯¢ä»Šæ—¥å·²å¾—ç§¯åˆ†
        int currentPoints = queryUserPointsByTypeAndDate(userId, type, begin, end);
        // 2.2.åˆ¤æ–­æ˜¯å¦è¶…è¿‡ä¸Šé™
        if(currentPoints >= maxPoints) {
            // 2.3.è¶…è¿‡ï¼Œç›´æ¥ç»“æŸ
            return;
        }
        // 2.4.æ²¡è¶…è¿‡ï¼Œä¿å­˜ç§¯åˆ†è®°å½•
        if(currentPoints + points > maxPoints){
            realPoints = maxPoints - currentPoints;
        }
    }
    // 3.æ²¡æœ‰ï¼Œç›´æ¥ä¿å­˜ç§¯åˆ†è®°å½•
    PointsRecord p = new PointsRecord();
    p.setPoints(realPoints);
    p.setUserId(userId);
    p.setType(type);
    save(p);
}

private int queryUserPointsByTypeAndDate(
        Long userId, PointsRecordType type, LocalDateTime begin, LocalDateTime end) {
    // 1.æŸ¥è¯¢æ¡ä»¶
    QueryWrapper<PointsRecord> wrapper = new QueryWrapper<>();
    wrapper.lambda()
            .eq(PointsRecord::getUserId, userId)
            .eq(type != null, PointsRecord::getType, type)
            .between(begin != null && end != null, PointsRecord::getCreateTime, begin, end);
    // 2.è°ƒç”¨mapperï¼ŒæŸ¥è¯¢ç»“æœ
    Integer points = getBaseMapper().queryUserPointsByTypeAndDate(wrapper);
    // 3.åˆ¤æ–­å¹¶è¿”å›
    return points == null ? 0 : points;
}
```

<br/>

æ³¨æ„ï¼Œè¿™é‡Œç»Ÿè®¡ç§¯åˆ†çš„æ—¶å€™éœ€è¦è‡ªå®šä¹‰SQLï¼Œå› æ­¤è¦åœ¨`com.tianji.learning.mapper.PointsRecordMapper`ä¸­å®šä¹‰æ–¹æ³•ï¼š

```Java
package com.tianji.learning.mapper;

import com.baomidou.mybatisplus.core.conditions.query.QueryWrapper;
import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.baomidou.mybatisplus.core.toolkit.Constants;
import com.tianji.learning.domain.po.PointsRecord;
import org.apache.ibatis.annotations.Param;
import org.apache.ibatis.annotations.Select;

import java.util.List;

/**
 * <p>
 * å­¦ä¹ ç§¯åˆ†è®°å½•ï¼Œæ¯ä¸ªæœˆåº•æ¸…é›¶ Mapper æ¥å£
 * </p>
 */
public interface PointsRecordMapper extends BaseMapper<PointsRecord> {

    @Select("SELECT SUM(points) FROM points_record ${ew.customSqlSegment}")
    Integer queryUserPointsByTypeAndDate(@Param(Constants.WRAPPER) QueryWrapper<PointsRecord> wrapper);
}
```

<br/>

### æŸ¥è¯¢ä»Šæ—¥ç§¯åˆ†æƒ…å†µ

#### æ€è·¯åˆ†æ

åœ¨ä¸ªäººä¸­å¿ƒï¼Œç”¨æˆ·å¯ä»¥æŸ¥çœ‹å½“å¤©å„ç§ä¸åŒç±»å‹çš„å·²è·å¾—çš„ç§¯åˆ†å’Œç§¯åˆ†ä¸Šé™ï¼š

![img](./assets/20230725154232690.jpg)

å¯ä»¥çœ‹åˆ°ï¼Œé¡µé¢éœ€è¦çš„æ•°æ®ï¼š

- ç§¯åˆ†ç±»å‹æè¿°
- ä»Šæ—¥å·²è·å–ç§¯åˆ†å€¼
- ç§¯åˆ†ä¸Šé™

è€Œä¸”ç§¯åˆ†ç±»å‹ä¸æ­¢ä¸€ä¸ªï¼Œæ‰€ä»¥ç»“æœåº”è¯¥æ˜¯é›†åˆã€‚

<br/>

å¦å¤–ï¼Œè¿™ä¸ªè¯·æ±‚æ˜¯æŸ¥è¯¢å½“å‰ç”¨æˆ·çš„ç§¯åˆ†ä¿¡æ¯ï¼Œæ‰€ä»¥åªéœ€è¦çŸ¥é“å½“å‰ç”¨æˆ·å³å¯ï¼Œ æ— éœ€ä¼ å‚ã€‚

ç»¼ä¸Šï¼Œæ¥å£ä¿¡æ¯å¦‚ä¸‹ï¼š

![image-20240213175704310](assets/image-20240213175704310.png)

<br/>

#### å®ç°æ¥å£

åœ¨tj-learningæ¨¡å—çš„`com.tianji.learning.controller.PointsRecordController`ä¸­å®šä¹‰æ¥å£ï¼š

```Java
package com.tianji.learning.controller;

import com.tianji.learning.domain.vo.PointsStatisticsVO;
import com.tianji.learning.service.IPointsRecordService;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import lombok.RequiredArgsConstructor;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

import java.util.List;

/**
 * <p>
 * å­¦ä¹ ç§¯åˆ†è®°å½•ï¼Œæ¯ä¸ªæœˆåº•æ¸…é›¶ æ§åˆ¶å™¨
 * </p>
 */
@RestController
@RequiredArgsConstructor
@RequestMapping("/points")
@Api(tags = "ç§¯åˆ†ç›¸å…³æ¥å£")
public class PointsRecordController {

    private final IPointsRecordService pointsRecordService;

    @ApiOperation("æŸ¥è¯¢æˆ‘çš„ä»Šæ—¥ç§¯åˆ†")
    @GetMapping("today")
    public List<PointsStatisticsVO> queryMyPointsToday(){
        return pointsRecordService.queryMyPointsToday();
    }
}
```

<br/>

ç„¶ååœ¨ä¸­å®šä¹‰serviceæ–¹æ³•ï¼š

```Java
package com.tianji.learning.service;

import com.baomidou.mybatisplus.extension.service.IService;
import com.tianji.learning.domain.po.PointsRecord;
import com.tianji.learning.domain.vo.PointsStatisticsVO;
import com.tianji.learning.enums.PointsRecordType;

import java.util.List;

/**
 * <p>
 * å­¦ä¹ ç§¯åˆ†è®°å½•ï¼Œæ¯ä¸ªæœˆåº•æ¸…é›¶ æœåŠ¡ç±»
 * </p>
 */
public interface IPointsRecordService extends IService<PointsRecord> {
    
    void addPointsRecord(Long userId, int points, PointsRecordType type);

    List<PointsStatisticsVO> queryMyPointsToday();

}
```

<br/>

ç„¶ååœ¨`com.tianji.learning.service.impl.PointsRecordServiceImpl`ä¸­å®ç°è¯¥æ–¹æ³•ï¼š

```Java
@Override
public List<PointsStatisticsVO> queryMyPointsToday() {
    // 1.è·å–ç”¨æˆ·
    Long userId = UserContext.getUser();
    // 2.è·å–æ—¥æœŸ
    LocalDateTime now = LocalDateTime.now();
    LocalDateTime begin = DateUtils.getDayStartTime(now);
    LocalDateTime end = DateUtils.getDayEndTime(now);
    // 3.æ„å»ºæŸ¥è¯¢æ¡ä»¶
    QueryWrapper<PointsRecord> wrapper = new QueryWrapper<>();
    wrapper.lambda()
            .eq(PointsRecord::getUserId, userId)
            .between(PointsRecord::getCreateTime, begin, end);
    // 4.æŸ¥è¯¢
    List<PointsRecord> list = getBaseMapper().queryUserPointsByDate(wrapper);
    if (CollUtils.isEmpty(list)) {
        return CollUtils.emptyList();
    }
    // 5.å°è£…è¿”å›
    List<PointsStatisticsVO> vos = new ArrayList<>(list.size());
    for (PointsRecord p : list) {
        PointsStatisticsVO vo = new PointsStatisticsVO();
        vo.setType(p.getType().getDesc());
        vo.setMaxPoints(p.getType().getMaxPoints());
        vo.setPoints(p.getPoints());
        vos.add(vo);
    }
    return vos;
}
```

<br/>

æ³¨æ„ï¼Œè¿™é‡Œç»Ÿè®¡ç§¯åˆ†çš„æ—¶å€™éœ€è¦è‡ªå®šä¹‰SQLï¼Œå› æ­¤è¦åœ¨`com.tianji.learning.mapper.PointsRecordMapper`ä¸­å®šä¹‰æ–¹æ³•ï¼š

```Java
package com.tianji.learning.mapper;

import com.baomidou.mybatisplus.core.conditions.query.QueryWrapper;
import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.baomidou.mybatisplus.core.toolkit.Constants;
import com.tianji.learning.domain.po.PointsRecord;
import org.apache.ibatis.annotations.Param;
import org.apache.ibatis.annotations.Select;

import java.util.List;

/**
 * <p>
 * å­¦ä¹ ç§¯åˆ†è®°å½•ï¼Œæ¯ä¸ªæœˆåº•æ¸…é›¶ Mapper æ¥å£
 * </p>
 *
 */
public interface PointsRecordMapper extends BaseMapper<PointsRecord> {

    @Select("SELECT SUM(points) FROM points_record ${ew.customSqlSegment}")
    Integer queryUserPointsByTypeAndDate(@Param(Constants.WRAPPER) QueryWrapper<PointsRecord> wrapper);

    @Select("SELECT type, SUM(points) AS points FROM points_record ${ew.customSqlSegment} GROUP BY type")
    List<PointsRecord> queryUserPointsByDate(@Param(Constants.WRAPPER) QueryWrapper<PointsRecord> wrapper);
}
```



## ç»ƒä¹ 

### æŸ¥è¯¢ç­¾åˆ°è®°å½•

åœ¨ç­¾åˆ°æ—¥å†ä¸­ï¼Œéœ€è¦æŠŠæœ¬æœˆç¬¬ä¸€å¤©åˆ°ä»Šå¤©ä¸ºæ­¢çš„æ‰€æœ‰ç­¾åˆ°è¿‡çš„æ—¥æœŸé«˜äº®æ˜¾ç¤ºã€‚å› æ­¤æˆ‘ä»¬å¿…é¡»æŠŠç­¾åˆ°è®°å½•è¿”å›ï¼Œå…·ä½“æ¥è¯´å°±æ˜¯æ¯ä¸€å¤©æ˜¯å¦ç­¾åˆ°çš„æ•°æ®ã€‚æ˜¯å¦ç­¾åˆ°ï¼Œå°±æ˜¯0æˆ–1ï¼Œåˆšå¥½åœ¨å‰ç«¯0å’Œ1ä»£è¡¨falseå’Œtrueï¼Œä¹Ÿå°±æ˜¯ç­¾åˆ°æˆ–æ²¡ç­¾åˆ°ã€‚

å› æ­¤ï¼Œæ¯ä¸€å¤©çš„ç­¾åˆ°ç»“æœå°±æ˜¯ä¸€ä¸ª0æˆ–1çš„æ•°å­—ï¼Œæˆ‘ä»¬æœ€ç»ˆè¿”å›çš„ç»“æœæ˜¯ä¸€ä¸ª0æˆ–1ç»„æˆçš„æ•°ç»„ï¼Œå¯¹åº”ä»æœ¬æœˆç¬¬1å¤©åˆ°ä»Šå¤©ä¸ºæ­¢æ¯ä¸€å¤©çš„ç­¾åˆ°æƒ…å†µã€‚

<br/>

ç»¼ä¸Šï¼Œæœ€ç»ˆçš„æ¥å£å¦‚ä¸‹ï¼š

![image-20240213175751468](assets/image-20240213175751468.png)

<br/>

### å®Œå–„ç§¯åˆ†åŠŸèƒ½

ç”¨æˆ·çš„5ç±»ï¼ˆç»†åˆ†æ˜¯6ç±»ï¼‰ä¸åŒè¡Œä¸ºéƒ½å¯ä»¥äº§ç”Ÿç§¯åˆ†ï¼š

- ç­¾åˆ°
- å›ç­”é—®é¢˜
- å­¦ä¹ ï¼ˆè§†é¢‘æˆ–è€ƒè¯•ï¼‰
- å†™ç¬”è®°
- ç¬”è®°è¢«é‡‡é›†
- è¯„è®º

<br/>

å…¶ä¸­ï¼Œ**ç¬”è®°**ã€**è¯„è®º**åŠŸèƒ½æš‚æœªå®ç°ï¼Œå…ˆä¸è€ƒè™‘ã€‚æˆ‘ä»¬è¯¾å ‚ä¸Šå®ç°äº†ç­¾åˆ°çš„ç§¯åˆ†åŠŸèƒ½ï¼Œè¿˜å‰©ä¸‹**å›ç­”**ã€**å­¦ä¹ **åŠŸèƒ½éœ€è¦å®Œå–„ã€‚

- ç¬¬ä¸€æ˜¯ç¼–å†™åœ¨å›ç­”ã€å­¦ä¹ å®Œæˆä¸€èŠ‚åå‘é€MQæ¶ˆæ¯
- ç¬¬äºŒæ˜¯ç¼–å†™æ¶ˆæ¯ç›‘å¬å™¨ï¼Œå¤„ç†ç§¯åˆ†ç´¯åŠ äº‹ä»¶

<br/>

### æŸ¥è¯¢èµ›å­£åˆ—è¡¨åŠŸèƒ½

åœ¨å†å²èµ›å­£æ¦œå•ä¸­ï¼Œæœ‰ä¸€ä¸ªä¸‹æ‹‰é€‰æ¡†ï¼Œå¯ä»¥é€‰æ‹©å†å²èµ›å­£ä¿¡æ¯ï¼š

![img](./assets/20230725154233370.jpg)

å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦å®ç°ä¸€ä¸ªæ¥å£ï¼ŒæŠŠå†å²èµ›å­£å…¨éƒ¨æŸ¥è¯¢å‡ºæ¥ã€‚

æ¥å£ä¿¡æ¯å¦‚ä¸‹ï¼š

![image-20240213175830584](assets/image-20240213175830584.png)

<br/>

### æ€è€ƒé¢˜

ç›®å‰ç§¯åˆ†åŠŸèƒ½æˆ‘ä»¬å·²ç»å®ç°ï¼Œç”¨æˆ·ç§¯åˆ†æ˜ç»†ä¹Ÿè®°å½•ä¸‹æ¥äº†ã€‚å¤§å®¶éœ€è¦æ€è€ƒä¸€ä¸‹ï¼Œç§¯åˆ†æ’è¡Œæ¦œè¯¥å¦‚ä½•å®ç°ï¼Ÿ

<br/>

## æ€»ç»“

:::warning  ğŸ’¡æ€è€ƒï¼šä½ é¡¹ç›®ä¸­ä½¿ç”¨è¿‡Redisçš„é‚£äº›æ•°æ®ç»“æ„å•Šï¼Ÿ

å¾ˆå¤šï¼Œæ¯”å¦‚Stringã€Hashã€Setã€SortedSetã€BitMapç­‰

æ¯”å¦‚å¾ˆå¤šçš„ç¼“å­˜ï¼Œæˆ‘ä»¬å°±ä½¿ç”¨äº†Stringç»“æ„æ¥å­˜å‚¨ã€‚è¿˜æœ‰ç‚¹èµåŠŸèƒ½ï¼Œæˆ‘ä»¬ç”¨äº†Setç»“æ„å’ŒSortedSetç»“æ„ã€‚ç­¾åˆ°åŠŸèƒ½ï¼Œæˆ‘ä»¬ç”¨äº†BitMapç»“æ„ã€‚

å°±æ‹¿ç­¾åˆ°æ¥è¯´å§ã€‚å› ä¸ºç­¾åˆ°æ•°æ®é‡éå¸¸å¤§å˜›ï¼Œè€ŒBitMapåˆ™æ˜¯ç”¨bitä½æ¥è¡¨ç¤ºç­¾åˆ°æ•°æ®ï¼Œ31bitä½å°±èƒ½è¡¨ç¤º1ä¸ªæœˆçš„ç­¾åˆ°è®°å½•ï¼Œéå¸¸èŠ‚çœç©ºé—´ï¼Œè€Œä¸”æŸ¥è¯¢æ•ˆç‡ä¹Ÿæ¯”è¾ƒé«˜ã€‚

<br/>

ğŸ’¡**æ€è€ƒï¼šä½ ä½¿ç”¨Redisä¿å­˜ç­¾åˆ°è®°å½•ï¼Œé‚£å¦‚æœRediså®•æœºæ€ä¹ˆåŠï¼Ÿ**

ç­”ï¼šå¯¹äºRedisçš„é«˜å¯ç”¨æ•°æ®å®‰å…¨é—®é¢˜ï¼Œæœ‰å¾ˆå¤šç§æ–¹æ¡ˆã€‚

æ¯”å¦‚ï¼šæˆ‘ä»¬å¯ä»¥ç»™Redisæ·»åŠ æ•°æ®æŒä¹…åŒ–æœºåˆ¶ï¼Œæ¯”å¦‚ä½¿ç”¨AOFæŒä¹…åŒ–ã€‚è¿™æ ·å®•æœºåä¹Ÿä¸¢å¤±çš„æ•°æ®é‡ä¸å¤šï¼Œå¯ä»¥æ¥å—ã€‚

æˆ–è€…å‘¢ï¼Œæˆ‘ä»¬å¯ä»¥æ­å»ºRedisä¸»ä»é›†ç¾¤ï¼Œå†ç»“åˆRediså“¨å…µã€‚ä¸»èŠ‚ç‚¹ä¼šæŠŠæ•°æ®æŒç»­çš„åŒæ­¥ç»™ä»èŠ‚ç‚¹ï¼Œå½“å³åä¹Ÿä¼šæœ‰å“¨å…µé‡æ–°é€‰ä¸»ï¼ŒåŸºæœ¬ä¸ç”¨æ‹…å¿ƒæ•°æ®ä¸¢å¤±é—®é¢˜ã€‚

å½“ç„¶ï¼Œå¦‚æœå¯¹äºæ•°æ®çš„å®‰å…¨æ€§è¦æ±‚éå¸¸é«˜ã€‚è‚¯å®šè¿˜æ˜¯è¦ç”¨ä¼ ç»Ÿæ•°æ®åº“æ¥å®ç°çš„ã€‚ä½†æ˜¯ä¸ºäº†è§£å†³ç­¾åˆ°æ•°æ®é‡è¾ƒå¤§çš„é—®é¢˜ï¼Œæˆ‘ä»¬å¯èƒ½å°±éœ€è¦å¯¹æ•°æ®åšåˆ†è¡¨å¤„ç†äº†ã€‚æˆ–è€…åŠæ—¶å°†å†å²æ•°æ®å­˜æ¡£ã€‚

æ€»çš„æ¥è¯´ï¼Œç­¾åˆ°æ•°æ®ä½¿ç”¨Redisçš„BitMapæ— è®ºæ˜¯å®‰å…¨æ€§è¿˜æ˜¯æ•°æ®å†…å­˜å ç”¨æƒ…å†µï¼Œéƒ½æ˜¯å¯ä»¥æ¥å—çš„ã€‚ä½†æ˜¯å…·ä½“æ˜¯é€‰æ‹©Redisè¿˜æ˜¯æ•°æ®åº“æ–¹æ¡ˆï¼Œæœ€ç»ˆè¿˜æ˜¯è¦çœ‹å…¬å¸çš„è¦æ±‚æ¥é€‰æ‹©ã€‚

:::

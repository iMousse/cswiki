Day06-ç‚¹èµç³»ç»Ÿ
==============

æˆ‘ä»¬å·²ç»å®ç°äº†å­¦ä¹ è¾…åŠ©ä¸­çš„äº’åŠ¨é—®ç­”åŠŸèƒ½ï¼Œä¸è¿‡å­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼Œä»…ä»…é è€å¸ˆæ¥ç»™å­¦ç”Ÿå›ç­”é—®é¢˜å­˜åœ¨ä¸€äº›å¼Šç«¯ï¼š

- è€å¸ˆå¯èƒ½å¿™ä¸è¿‡æ¥
- éš¾ä»¥è°ƒåŠ¨æ‰€æœ‰å­¦å‘˜äº’åŠ¨çƒ­æƒ…
- äº’åŠ¨çš„æ°›å›´æ„Ÿè¾ƒå·®

<br/>

å› æ­¤ï¼Œäº§å“æå‡ºäº†æ–°çš„éœ€æ±‚ï¼š

> å½“çƒ­å¿ƒç”¨æˆ·æˆ–è€…è€å¸ˆç»™å­¦ç”Ÿå›ç­”äº†é—®é¢˜ä»¥åï¼Œæ‰€æœ‰å­¦å‘˜å¯ä»¥ç»™è‡ªå·±å¿ƒä»ªçš„å›ç­”ç‚¹èµï¼Œç‚¹èµè¶Šé«˜ï¼Œæ’åä¹Ÿè¶Šé å‰ã€‚

è¿™æ ·ä¸€æ¥ï¼Œç”¨æˆ·å›ç­”å’Œè¯„è®ºçš„æ¬²æœ›å°±ä¼šå¢åŠ ï¼Œç½‘ç«™çš„æ´»è·ƒåº¦ä¹Ÿä¼šè¶Šæ¥è¶Šé«˜ã€‚

ç‚¹èµåŠŸèƒ½æ˜¯ç¤¾äº¤ã€ç”µå•†ç­‰å‡ ä¹æ‰€æœ‰çš„äº’è”ç½‘é¡¹ç›®ä¸­éƒ½å¹¿æ³›ä½¿ç”¨ã€‚è™½ç„¶çœ‹èµ·æ¥ç®€å•ï¼Œä¸è¿‡è•´å«çš„æŠ€æœ¯æ–¹æ¡ˆå’Œæ‰‹æ®µè¿˜æ˜¯æ¯”è¾ƒå¤šçš„ã€‚ 

ä»Šå¤©ï¼Œæˆ‘ä»¬å°±ä¸€èµ·æ¥æ­å¼€ç‚¹èµåŠŸèƒ½çš„ç¥ç§˜é¢çº±ã€‚

<br/>

### éœ€æ±‚åˆ†æ

ç‚¹èµåŠŸèƒ½ä¸å…¶å®ƒåŠŸèƒ½ä¸åŒï¼Œæ²¡æœ‰å¤æ‚çš„åŸå‹å’Œéœ€æ±‚ï¼Œä»…ä»…æ˜¯ä¸€ä¸ªç‚¹èµã€å–æ¶ˆç‚¹èµçš„æ“ä½œã€‚æ‰€ä»¥ï¼Œä»Šå¤©æˆ‘ä»¬å°±ä¸éœ€è¦ä»åŸå‹å›¾æ¥åˆ†æï¼Œè€Œæ˜¯ä»…ä»…ä»è¿™ä¸ªåŠŸèƒ½çš„å®ç°æ–¹æ¡ˆæ¥æ€è€ƒã€‚

<br/>

#### ä¸šåŠ¡éœ€æ±‚

é¦–å…ˆæˆ‘ä»¬æ¥åˆ†ææ•´ç†ä¸€ä¸‹ç‚¹èµä¸šåŠ¡çš„éœ€æ±‚ï¼Œä¸€ä¸ªé€šç”¨ç‚¹èµç³»ç»Ÿéœ€è¦æ»¡è¶³ä¸‹åˆ—ç‰¹æ€§ï¼š

![img](./assets/20230725154106472.jpg)

- é€šç”¨ï¼šç‚¹èµä¸šåŠ¡åœ¨è®¾è®¡çš„æ—¶å€™ä¸è¦ä¸ä¸šåŠ¡ç³»ç»Ÿè€¦åˆï¼Œå¿…é¡»åŒæ—¶æ”¯æŒä¸åŒä¸šåŠ¡çš„ç‚¹èµåŠŸèƒ½
- ç‹¬ç«‹ï¼šç‚¹èµåŠŸèƒ½æ˜¯ç‹¬ç«‹ç³»ç»Ÿï¼Œå¹¶ä¸”ä¸ä¾èµ–å…¶å®ƒæœåŠ¡ã€‚è¿™æ ·æ‰å…·å¤‡å¯è¿ç§»æ€§ã€‚
- å¹¶å‘ï¼šä¸€äº›çƒ­ç‚¹ä¸šåŠ¡ç‚¹èµä¼šå¾ˆå¤šï¼Œæ‰€ä»¥ç‚¹èµåŠŸèƒ½å¿…é¡»æ”¯æŒé«˜å¹¶å‘
- å®‰å…¨ï¼šè¦åšå¥½å¹¶å‘å®‰å…¨æ§åˆ¶ï¼Œé¿å…é‡å¤ç‚¹èµ

<br/>

#### å®ç°æ€è·¯

è¦ä¿è¯å®‰å…¨ï¼Œé¿å…é‡å¤ç‚¹èµï¼Œæˆ‘ä»¬å°±å¿…é¡»ä¿å­˜æ¯ä¸€æ¬¡ç‚¹èµè®°å½•ã€‚åªæœ‰è¿™æ ·åœ¨ä¸‹æ¬¡ç”¨æˆ·ç‚¹èµæ—¶æˆ‘ä»¬æ‰èƒ½æŸ¥è¯¢æ•°æ®ï¼Œåˆ¤æ–­æ˜¯å¦æ˜¯é‡å¤ç‚¹èµã€‚åŒæ—¶ï¼Œå› ä¸ºä¸šåŠ¡æ–¹ç»å¸¸éœ€è¦æ ¹æ®ç‚¹èµæ•°é‡æ’åºï¼Œå› æ­¤æ¯ä¸ªä¸šåŠ¡çš„ç‚¹èµæ•°é‡ä¹Ÿéœ€è¦è®°å½•ä¸‹æ¥ã€‚

ç»¼ä¸Šï¼Œç‚¹èµçš„åŸºæœ¬æ€è·¯å¦‚ä¸‹ï¼š

![image-20240213171309914](assets/image-20240213171309914.png)

<br/>

ä½†é—®é¢˜æ¥äº†ï¼Œæˆ‘ä»¬è¯´è¿‡ç‚¹èµæœåŠ¡å¿…é¡»ç‹¬ç«‹ï¼Œå› æ­¤å¿…é¡»æŠ½å–ä¸ºä¸€ä¸ª**ç‹¬ç«‹æœåŠ¡**ã€‚å¤šä¸ªå…¶å®ƒå¾®æœåŠ¡ä¸šåŠ¡çš„ç‚¹èµæ•°æ®éƒ½æœ‰ç‚¹èµç³»ç»Ÿæ¥ç»´æŠ¤ã€‚ä½†æ˜¯é—®é¢˜æ¥äº†ï¼š

> å¦‚æœä¸šåŠ¡æ–¹éœ€è¦æ ¹æ®ç‚¹èµæ•°æ’åºï¼Œå°±å¿…é¡»åœ¨æ•°æ®åº“ä¸­ç»´æŠ¤ç‚¹èµæ•°å­—æ®µã€‚ä½†æ˜¯ç‚¹èµç³»ç»Ÿæ— æ³•ä¿®æ”¹å…¶å®ƒä¸šåŠ¡æœåŠ¡çš„æ•°æ®åº“ï¼Œå¦åˆ™å°±å‡ºç°äº†ä¸šåŠ¡è€¦åˆã€‚è¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿ

<br/>

ç‚¹èµç³»ç»Ÿå¯ä»¥åœ¨ç‚¹èµæ•°å˜æ›´æ—¶ï¼Œé€šè¿‡MQé€šçŸ¥ä¸šåŠ¡æ–¹ï¼Œè¿™æ ·ä¸šåŠ¡æ–¹å°±å¯ä»¥æ›´æ–°è‡ªå·±çš„ç‚¹èµæ•°é‡äº†ã€‚å¹¶ä¸”è¿˜é¿å…äº†ç‚¹èµç³»ç»Ÿä¸ä¸šåŠ¡æ–¹çš„è€¦åˆã€‚

äºæ˜¯ï¼Œå®ç°æ€è·¯å˜æˆäº†è¿™æ ·ï¼š

![image-20240213171339459](assets/image-20240213171339459.png)

<br/>

### æ•°æ®ç»“æ„

ç‚¹èµçš„æ•°æ®ç»“æ„åˆ†ä¸¤éƒ¨åˆ†ï¼Œä¸€æ˜¯**ç‚¹èµè®°å½•**ï¼ŒäºŒæ˜¯ä¸ä¸šåŠ¡å…³è”çš„**ç‚¹èµæ•°**ã€‚

ç‚¹èµæ•°è‡ªç„¶æ˜¯ä¸å…·ä½“ä¸šåŠ¡è¡¨å…³è”åœ¨ä¸€èµ·è®°å½•ï¼Œæ¯”å¦‚äº’åŠ¨é—®ç­”çš„ç‚¹èµï¼Œè‡ªç„¶æ˜¯åœ¨é—®ç­”è¡¨ä¸­è®°å½•ç‚¹èµæ•°ã€‚å­¦å‘˜ç¬”è®°ç‚¹èµï¼Œè‡ªç„¶æ˜¯åœ¨ç¬”è®°è¡¨ä¸­è®°å½•ç‚¹èµæ•°ã€‚

åœ¨ä¹‹å‰å®ç°äº’åŠ¨é—®ç­”çš„æ—¶å€™ï¼Œæˆ‘ä»¬å·²ç»ç»™å›ç­”è¡¨è®¾è®¡äº†ç‚¹èµæ•°å­—æ®µäº†ï¼š

![img](./assets/20230725154106640.jpg)

å…¶å®ƒä¸šåŠ¡ä¹Ÿæ˜¯ç±»ä¼¼çš„ã€‚

<br/>

å› æ­¤ï¼Œæœ¬èŠ‚æˆ‘ä»¬åªéœ€è¦å®ç°ç‚¹èµè®°å½•çš„è¡¨ç»“æ„è®¾è®¡å³å¯ã€‚

#### ERå›¾

ç‚¹èµè®°å½•æœ¬è´¨å°±æ˜¯è®°å½•**è°ç»™ä»€ä¹ˆå†…å®¹ç‚¹äº†èµ**ï¼Œæ‰€ä»¥æ ¸å¿ƒå±æ€§åŒ…æ‹¬ï¼š

- ç‚¹èµç›®æ ‡id
- ç‚¹èµäººid

ä¸è¿‡ç‚¹èµçš„å†…å®¹å¤šç§å¤šæ ·ï¼Œä¸ºäº†åŠ ä»¥åŒºåˆ†ï¼Œæˆ‘ä»¬è¿˜éœ€è¦æŠŠç‚¹èµå†…çš„ç±»å‹è®°å½•ä¸‹æ¥ï¼š

- ç‚¹èµå¯¹è±¡ç±»å‹ï¼ˆä¸ºäº†é€šç”¨æ€§ï¼‰

å½“ç„¶è¿˜æœ‰ç‚¹èµæ—¶é—´ï¼Œç»¼ä¸Šå¯¹åº”çš„æ•°æ®åº“ERå›¾å¦‚ä¸‹ï¼š

![image-20240213171438925](assets/image-20240213171438925.png)

<br/>

#### è¡¨ç»“æ„

ç”±äºç‚¹èµç³»ç»Ÿæ˜¯ç‹¬ç«‹äºå…¶å®ƒä¸šåŠ¡çš„ï¼Œè¿™é‡Œæˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ªæ–°çš„æ•°æ®åº“ï¼š`tj_remark`

ç„¶ååœ¨ERå›¾åŸºç¡€ä¸Šï¼ŒåŠ ä¸Šä¸€äº›é€šç”¨å±æ€§ï¼Œç‚¹èµè®°å½•è¡¨ç»“æ„å¦‚ä¸‹ï¼š

```SQL
-- å¯¼å‡º tj_remark çš„æ•°æ®åº“ç»“æ„
CREATE DATABASE IF NOT EXISTS `tj_remark` /*!40100 DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci */ /*!80016 DEFAULT ENCRYPTION='N' */;
USE `tj_remark`;

CREATE TABLE IF NOT EXISTS `liked_record` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT 'ä¸»é”®id',
  `user_id` bigint NOT NULL COMMENT 'ç”¨æˆ·id',
  `biz_id` bigint NOT NULL COMMENT 'ç‚¹èµçš„ä¸šåŠ¡id',
  `biz_type` VARCHAR(16) NOT NULL COMMENT 'ç‚¹èµçš„ä¸šåŠ¡ç±»å‹',
  `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
  `update_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
  PRIMARY KEY (`id`),
  UNIQUE KEY `idx_biz_user` (`biz_id`,`user_id`)
) ENGINE=InnoDB AUTO_INCREMENT=8 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='ç‚¹èµè®°å½•è¡¨';
```

<br/>

#### ä»£ç ç”Ÿæˆ

ç”±äºç‚¹èµç³»ç»Ÿæ˜¯ä¸€ä¸ªç‹¬ç«‹å¾®æœåŠ¡ï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ªæ–°çš„å¾®æœåŠ¡æ¨¡å—ã€‚

<br/>

##### åˆ›å»ºå¾®æœåŠ¡

åˆ›å»ºæ¨¡å—ï¼š

![img](./assets/20230725154106438.jpg)

<br/>

é€‰æ‹©mavenæ¨¡å—ï¼š

![img](./assets/20230725154106727.jpg)

<br/>

å¡«å†™é¡¹ç›®åç§°ï¼š

![image-20240214144845578](assets/image-20240214144845578.png)

<br/>

åœ¨pom.xmlä¸­å¡«å…¥ä¾èµ–ï¼š

```XML
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <parent>
        <artifactId>tjxt</artifactId>
        <groupId>com.tianji</groupId>
        <version>1.0.0</version>
    </parent>
    <modelVersion>4.0.0</modelVersion>

    <artifactId>tj-remark</artifactId>

    <properties>
        <maven.compiler.source>11</maven.compiler.source>
        <maven.compiler.target>11</maven.compiler.target>
    </properties>
    <dependencies>
        <!--auth-sdk-->
        <dependency>
            <groupId>com.tianji</groupId>
            <artifactId>tj-auth-resource-sdk</artifactId>
            <version>1.0.0</version>
        </dependency>
        <!--api-->
        <dependency>
            <groupId>com.tianji</groupId>
            <artifactId>tj-api</artifactId>
            <version>1.0.0</version>
        </dependency>
        <!--web-->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>
        <!--mybatis-->
        <dependency>
            <groupId>com.baomidou</groupId>
            <artifactId>mybatis-plus-boot-starter</artifactId>
        </dependency>
        <dependency>
            <groupId>mysql</groupId>
            <artifactId>mysql-connector-java</artifactId>
        </dependency>
        <!--Redis-->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-data-redis</artifactId>
        </dependency>
        <!--discovery-->
        <dependency>
            <groupId>com.alibaba.cloud</groupId>
            <artifactId>spring-cloud-starter-alibaba-nacos-discovery</artifactId>
        </dependency>
        <!--config-->
        <dependency>
            <groupId>com.alibaba.cloud</groupId>
            <artifactId>spring-cloud-starter-alibaba-nacos-config</artifactId>
        </dependency>
        <!--mq-->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-amqp</artifactId>
        </dependency>
        <!--loadbalancer-->
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-loadbalancer</artifactId>
        </dependency>
    </dependencies>
    <build>
        <finalName>${project.artifactId}</finalName>
        <plugins>
            <plugin>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-maven-plugin</artifactId>
                <executions>
                    <execution>
                        <goals>
                            <goal>build-info</goal>
                        </goals>
                    </execution>
                </executions>
                <configuration>
                    <mainClass>com.tianji.remark.RemarkApplication</mainClass>
                </configuration>
            </plugin>
        </plugins>
    </build>
</project>
```

<br/>

ç„¶åæ˜¯é…ç½®æ–‡ä»¶ï¼š`bootstrap.yml`

```YAML
server:
  port: 8091  #ç«¯å£
  tomcat:
    uri-encoding: UTF-8   #æœåŠ¡ç¼–ç 
spring:
  profiles:
    active: dev
  application:
    name: remark-service
  cloud:
    nacos:
      config:
        file-extension: yaml
        shared-configs: # å…±äº«é…ç½®
          - data-id: shared-spring.yaml # å…±äº«springé…ç½®
            refresh: false
          - data-id: shared-redis.yaml # å…±äº«redisé…ç½®
            refresh: false
          - data-id: shared-mybatis.yaml # å…±äº«mybatisé…ç½®
            refresh: false
          - data-id: shared-logs.yaml # å…±äº«æ—¥å¿—é…ç½®
            refresh: false
          - data-id: shared-feign.yaml # å…±äº«feigné…ç½®
            refresh: false
          - data-id: shared-mq.yaml # å…±äº«mqé…ç½®
            refresh: false
tj:
  swagger:
    enable: true
    enableResponseWrap: true
    package-path: com.tianji.remark.controller
    title: å¤©æœºå­¦å ‚ - è¯„ä»·ä¸­å¿ƒæ¥å£æ–‡æ¡£
    description: è¯¥æœåŠ¡åŒ…å«è¯„ä»·ã€ç‚¹èµç­‰åŠŸèƒ½
    contact-name: ä¼ æ™ºæ•™è‚²Â·ç ”ç©¶é™¢
    contact-url: http://www.itcast.cn/
    contact-email: zhanghuyi@itcast.cn
    version: v1.0
  jdbc:
    database: tj_remark
  auth:
    resource:
      enable: true # ç™»å½•æ‹¦æˆªåŠŸèƒ½
```

<br/>

æ¥ç€æ˜¯`bootstrap-dev.yml`:

```YAML
spring:
  cloud:
    nacos:
      server-addr: 192.168.150.101:8848 # nacosæ³¨å†Œä¸­å¿ƒ
      discovery:
        namespace: f923fb34-cb0a-4c06-8fca-ad61ea61a3f0
        group: DEFAULT_GROUP
        ip: 192.168.150.101
logging:
  level:
    com.tianji: debug
```

<br/>

ç„¶åæ˜¯`bootstrap-local.yml`:

```YAML
spring:
  cloud:
    nacos:
      server-addr: 192.168.150.101:8848 # nacosæ³¨å†Œä¸­å¿ƒ
      discovery:
        namespace: f923fb34-cb0a-4c06-8fca-ad61ea61a3f0
        group: DEFAULT_GROUP
        ip: 192.168.150.1
logging:
  level:
    com.tianji: debug
```

<br/>

æœ€åï¼Œæ–°å»ºä¸€ä¸ªå¯åŠ¨ç±»ï¼š

```Java
package com.tianji.remark;

import lombok.extern.slf4j.Slf4j;
import org.mybatis.spring.annotation.MapperScan;
import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.boot.builder.SpringApplicationBuilder;
import org.springframework.core.env.Environment;
import org.springframework.scheduling.annotation.EnableScheduling;

import java.net.InetAddress;
import java.net.UnknownHostException;

@Slf4j
@EnableScheduling
@SpringBootApplication
@MapperScan("com.tianji.remark.mapper")
public class RemarkApplication {
    public static void main(String[] args) throws UnknownHostException {
        SpringApplication app = new SpringApplicationBuilder(RemarkApplication.class).build(args);
        Environment env = app.run(args).getEnvironment();
        String protocol = "http";
        if (env.getProperty("server.ssl.key-store") != null) {
            protocol = "https";
        }
        log.info("--/\n---------------------------------------------------------------------------------------\n\t" +
                        "Application '{}' is running! Access URLs:\n\t" +
                        "Local: \t\t{}://localhost:{}\n\t" +
                        "External: \t{}://{}:{}\n\t" +
                        "Profile(s): \t{}" +
                        "\n---------------------------------------------------------------------------------------",
                env.getProperty("spring.application.name"),
                protocol,
                env.getProperty("server.port"),
                protocol,
                InetAddress.getLocalHost().getHostAddress(),
                env.getProperty("server.port"),
                env.getActiveProfiles());
    }
}
```

<br/>

é¡¹ç›®ç»“æ„ï¼š

![img](./assets/20230725154106829.jpg)

<br/>

å¾®æœåŠ¡æ­å»ºåï¼Œä¸€å®šä¸è¦å¿˜äº†åœ¨ç½‘å…³é…ç½®æœåŠ¡è·¯ç”±ï¼Œæ‰¾åˆ°`tj-gateway`æœåŠ¡çš„`bootstrap.yml`æ–‡ä»¶ï¼Œæ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š

```YAML
# ã€‚ã€‚ã€‚å…¶å®ƒç•¥
spring:
        # ã€‚ã€‚ã€‚å…¶å®ƒç•¥
  cloud:
          # ã€‚ã€‚ã€‚å…¶å®ƒç•¥
    gateway:
      routes:
        - id: rs
          uri: lb://remark-service
          predicates:
            - Path=/rs/**
              # ã€‚ã€‚ã€‚å…¶å®ƒç•¥
      default-filters:
        - StripPrefix=1
# ã€‚ã€‚ã€‚å…¶å®ƒç•¥
```

<br/>

ä¸ºäº†æ–¹ä¾¿æœ¬åœ°å¯åŠ¨æµ‹è¯•ï¼Œæœ€åç»™remark-serviceæ·»åŠ ä¸€ä¸ªSpringBootå¯åŠ¨é¡¹ï¼š

![img](./assets/20230725154106882.jpg)

<br/>

##### ä»£ç ç”Ÿæˆ

åˆ©ç”¨MybatisPlusçš„æ’ä»¶ç”Ÿæˆå®ä½“ã€mapperã€serviceã€controllerç­‰ä»£ç ã€‚

<br/>

æ³¨æ„è¦å…ˆé…ç½®æ•°æ®åº“åœ°å€ï¼š

![img](./assets/20230725154106701.jpg)

<br/>

å¡«å†™æ•°æ®åº“ä¿¡æ¯ï¼š

![img](./assets/20230725154107053.jpg)

<br/>

ç„¶åç”Ÿæˆä»£ç ï¼š

![img](./assets/20230725154107056.jpg)

<br/>

ä»£ç ç»“æ„å¦‚ä¸‹ï¼š

![img](./assets/20230725154109523.jpg)

<br/>

### å®ç°ç‚¹èµåŠŸèƒ½

ä»è¡¨é¢æ¥çœ‹ï¼Œç‚¹èµåŠŸèƒ½è¦å®ç°çš„æ¥å£å°±æ˜¯ä¸€ä¸ªç‚¹èµæ¥å£ã€‚ä¸è¿‡ä»”ç»†è§‚å¯Ÿæ‰€æœ‰çš„ç‚¹èµé¡µé¢ï¼Œä½ ä¼šå‘ç°ç‚¹èµæŒ‰é’®æœ‰ç°è‰²å’Œç‚¹äº®ä¸¤ç§çŠ¶æ€ã€‚

ä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬è¿˜éœ€è¦å®ç°æŸ¥è¯¢ç”¨æˆ·ç‚¹èµçŠ¶æ€çš„æ¥å£ï¼Œè¿™æ ·å‰ç«¯æ‰èƒ½æ ¹æ®ç‚¹èµçŠ¶æ€æ¸²æŸ“ä¸åŒæ•ˆæœã€‚å› æ­¤æˆ‘ä»¬è¦å®ç°çš„æ¥å£åŒ…æ‹¬ï¼š

- ç‚¹èµ/å–æ¶ˆç‚¹èµ
- æ ¹æ®å¤šä¸ªä¸šåŠ¡idæ‰¹é‡æŸ¥è¯¢ç”¨æˆ·æ˜¯å¦ç‚¹èµå¤šä¸ªä¸šåŠ¡

<br/>

#### ç‚¹èµæˆ–å–æ¶ˆç‚¹èµ

##### æ¥å£ä¿¡æ¯

å½“ç”¨æˆ·ç‚¹å‡»ç‚¹èµæŒ‰é’®çš„æ—¶å€™ï¼Œç¬¬ä¸€æ¬¡ç‚¹å‡»æ˜¯ç‚¹èµï¼ŒæŒ‰é’®ä¼šé«˜äº®ï¼›ç¬¬äºŒæ¬¡ç‚¹å‡»æ˜¯å–æ¶ˆï¼Œç‚¹èµæŒ‰é’®å˜ç°ï¼š

![img](./assets/20230725154109441.jpg)

ä»åå°å®ç°æ¥çœ‹ï¼Œç‚¹èµå°±æ˜¯æ–°å¢ä¸€æ¡ç‚¹èµè®°å½•ï¼Œå–æ¶ˆå°±æ˜¯åˆ é™¤è¿™æ¡è®°å½•ã€‚ä¸ºäº†æ–¹ä¾¿å‰ç«¯äº¤äº’ï¼Œè¿™ä¸¤ä¸ªåˆå¹¶ä¸ºä¸€ä¸ªæ¥å£å³å¯ã€‚

å› æ­¤ï¼Œè¯·æ±‚å‚æ•°é¦–å…ˆè¦åŒ…å«ç‚¹èµæœ‰å…³çš„æ•°æ®ï¼Œå¹¶ä¸”è¦æ ‡è®°æ˜¯ç‚¹èµè¿˜æ˜¯å–æ¶ˆï¼š

- ç‚¹èµçš„ç›®æ ‡ä¸šåŠ¡idï¼šbizId
- è°åœ¨ç‚¹èµï¼ˆå°±æ˜¯ç™»é™†ç”¨æˆ·ï¼Œå¯ä»¥ä¸ç”¨æäº¤ï¼‰
- ç‚¹èµè¿˜æ˜¯å–æ¶ˆ

<br/>

é™¤æ­¤ä»¥å¤–ï¼Œæˆ‘ä»¬ä¹‹å‰è¯´è¿‡ï¼Œåœ¨é—®ç­”ã€ç¬”è®°ç­‰åŠŸèƒ½ä¸­éƒ½ä¼šå‡ºç°ç‚¹èµåŠŸèƒ½ï¼Œæ‰€ä»¥ç‚¹èµå¿…é¡»å…·å¤‡é€šç”¨æ€§ã€‚å› æ­¤è¿˜éœ€è¦åœ¨æäº¤ä¸€ä¸ªå‚æ•°æ ‡è®°ç‚¹èµçš„ç±»å‹ï¼š

- ç‚¹èµç›®æ ‡çš„ç±»å‹

<br/>

è¿”å›å€¼æœ‰ä¸¤ç§è®¾è®¡ï¼š

- æ–¹æ¡ˆä¸€ï¼šæ— è¿”å›å€¼ï¼Œ200å°±æ˜¯æˆåŠŸï¼Œé¡µé¢ç›´æ¥æŠŠç‚¹èµæ•°+1å±•ç¤ºç»™ç”¨æˆ·å³å¯
- æ–¹æ¡ˆäºŒï¼šè¿”å›ç‚¹èµæ•°é‡ï¼Œé¡µé¢æ¸²æŸ“

è¿™é‡Œæ¨èä½¿ç”¨æ–¹æ¡ˆä¸€ï¼Œå› ä¸ºæ¯æ¬¡ç»Ÿè®¡ç‚¹èµæ•°é‡ä¹Ÿæœ‰å¾ˆå¤§çš„æ€§èƒ½æ¶ˆè€—ã€‚

<br/>

ç»¼ä¸Šï¼ŒæŒ‰ç…§Restfulé£æ ¼è®¾è®¡ï¼Œæ¥å£ä¿¡æ¯å¦‚ä¸‹ï¼š

![image-20240214145304967](assets/image-20240214145304967.png)

<br/>

##### å®ä½“

è¯·æ±‚å‚æ•°éœ€è¦å®šä¹‰ä¸€ä¸ªDTOå®ä½“ç±»æ¥æ¥æ”¶ï¼šLikeRecordFormDTO

```java
package com.tianji.remark.domain.dto;

import io.swagger.annotations.ApiModel;
import io.swagger.annotations.ApiModelProperty;
import lombok.Data;

import javax.validation.constraints.NotNull;

@Data
@ApiModel(description = "ç‚¹èµè®°å½•è¡¨å•å®ä½“")
public class LikeRecordFormDTO {
    @ApiModelProperty("ç‚¹èµä¸šåŠ¡id")
    @NotNull(message = "ä¸šåŠ¡idä¸èƒ½ä¸ºç©º")
    private Long bizId;

    @ApiModelProperty("ç‚¹èµä¸šåŠ¡ç±»å‹")
    @NotNull(message = "ä¸šåŠ¡ç±»å‹ä¸èƒ½ä¸ºç©º")
    private String bizType;

    @ApiModelProperty("æ˜¯å¦ç‚¹èµï¼Œtrueï¼šç‚¹èµï¼›falseï¼šå–æ¶ˆç‚¹èµ")
    @NotNull(message = "æ˜¯å¦ç‚¹èµä¸èƒ½ä¸ºç©º")
    private Boolean liked;
}
```

<br/>

##### ä»£ç å®ç°

é¦–å…ˆæ˜¯`tj-remark`çš„`com.tianji.remark.controller.LikedRecordController`ï¼š

```Java
package com.tianji.remark.controller;

import com.tianji.remark.domain.dto.LikeRecordFormDTO;
import com.tianji.remark.service.ILikedRecordService;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import lombok.RequiredArgsConstructor;
import org.springframework.web.bind.annotation.*;

import javax.validation.Valid;
import java.util.List;
import java.util.Set;

/**
 * <p>
 * ç‚¹èµè®°å½•è¡¨ æ§åˆ¶å™¨
 * </p>
 */
@RestController
@RequiredArgsConstructor
@RequestMapping("/likes")
@Api(tags = "ç‚¹èµä¸šåŠ¡ç›¸å…³æ¥å£")
public class LikedRecordController {

    private final ILikedRecordService likedRecordService;

    @PostMapping
    @ApiOperation("ç‚¹èµæˆ–å–æ¶ˆç‚¹èµ")
    public void addLikeRecord(@Valid @RequestBody LikeRecordFormDTO recordDTO) {
        likedRecordService.addLikeRecord(recordDTO);
    }
}
```

<br/>

ç„¶åæ˜¯`tj-remark`çš„`com.tianji.remark.service.ILikedRecordService`ï¼š

```Java
public interface ILikedRecordService extends IService<LikedRecord> {

    void addLikeRecord(LikeRecordFormDTO recordFormDTO);
}
```

<br/>

æœ€åæ˜¯`tj-remark`çš„å®ç°ç±»`com.tianji.remark.service.impl.LikedRecordServiceImpl`ï¼š

```Java
@Service
public class LikedRecordServiceImpl extends ServiceImpl<LikedRecordMapper, LikedRecord> implements ILikedRecordService {

    @Override
    public void addLikeRecord(LikeRecordFormDTO recordFormDTO) {
        // TODO å®ç°ç‚¹èµæˆ–å–æ¶ˆç‚¹èµ
    }
}
```

<br/>

##### ä¸šåŠ¡æµç¨‹

æˆ‘ä»¬å…ˆæ¢³ç†ä¸€ä¸‹ç‚¹èµä¸šåŠ¡çš„å‡ ç‚¹éœ€æ±‚ï¼š

- ç‚¹èµå°±æ–°å¢ä¸€æ¡ç‚¹èµè®°å½•ï¼Œå–æ¶ˆç‚¹èµå°±åˆ é™¤è®°å½•
- ç”¨æˆ·ä¸èƒ½é‡å¤ç‚¹èµ
- ç‚¹èµæ•°ç”±å…·ä½“çš„ä¸šåŠ¡æ–¹ä¿å­˜ï¼Œéœ€è¦é€šçŸ¥ä¸šåŠ¡æ–¹æ›´æ–°ç‚¹èµæ•°

ç”±äºä¸šåŠ¡æ–¹çš„ç±»å‹å¾ˆå¤šï¼Œæ¯”å¦‚äº’åŠ¨é—®ç­”ã€ç¬”è®°ã€è¯¾ç¨‹ç­‰ã€‚æ‰€ä»¥é€šçŸ¥æ–¹å¼å¿…é¡»æ˜¯**ä½è€¦åˆ**çš„ï¼Œè¿™é‡Œå»ºè®®ä½¿ç”¨MQæ¥å®ç°ã€‚

å½“ç‚¹èµæˆ–å–æ¶ˆç‚¹èµåï¼Œç‚¹èµæ•°å‘ç”Ÿå˜åŒ–ï¼Œæˆ‘ä»¬å°±å‘é€MQé€šçŸ¥ã€‚æ•´ä½“ä¸šåŠ¡æµç¨‹å¦‚å›¾ï¼š

![image-20240214145341549](assets/image-20240214145341549.png)

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç”±äº**æ¯æ¬¡ç‚¹èµçš„ä¸šåŠ¡ç±»å‹ä¸åŒï¼Œæ‰€ä»¥æ²¡æœ‰å¿…è¦é€šçŸ¥åˆ°æ‰€æœ‰ä¸šåŠ¡æ–¹ï¼Œè€Œæ˜¯ä»…ä»…é€šçŸ¥ä¸å½“å‰ç‚¹èµä¸šåŠ¡å…³è”çš„ä¸šåŠ¡æ–¹å³å¯**ã€‚

åœ¨RabbitMQä¸­ï¼Œåˆ©ç”¨TOPICç±»å‹çš„äº¤æ¢æœºï¼Œç»“åˆä¸åŒçš„RoutingKeyï¼Œå¯ä»¥å®ç°é€šçŸ¥å¯¹è±¡çš„å˜åŒ–ã€‚æˆ‘ä»¬éœ€è¦è®©ä¸åŒçš„ä¸šåŠ¡æ–¹ç›‘å¬ä¸åŒçš„RoutingKeyï¼Œç„¶åå‘é€é€šçŸ¥æ—¶æ ¹æ®ç‚¹èµç±»å‹ä¸åŒï¼Œå‘é€ä¸åŒRoutingKeyï¼š

![image-20240214145358582](assets/image-20240214145358582.png)

å½“ç„¶ï¼ŒçœŸå®çš„RoutingKeyä¸ä¸€å®šå¦‚å›¾ä¸­æ‰€ç¤ºï¼Œè¿™é‡Œåªæ˜¯åšä¸€ä¸ªç¤ºæ„ã€‚

å…¶å®åœ¨tj-commonä¸­ï¼Œæˆ‘ä»¬å·²ç»å®šä¹‰äº†MQçš„å¸¸é‡ï¼š

![img](./assets/20230725154107189.jpg)

å¹¶ä¸”å®šä¹‰äº†ç‚¹èµæœ‰å…³çš„`Exchange`å’Œ`RoutingKey`å¸¸é‡ï¼š

![img](./assets/20230725154108096.jpg)

å…¶ä¸­çš„`RoutingKey`åªæ˜¯ä¸€ä¸ªæ¨¡æ¿ï¼Œå…¶ä¸­`{}`éƒ¨åˆ†æ˜¯å ä½ç¬¦ï¼Œä¸åŒä¸šåŠ¡ç±»å‹å°±å¡«å†™ä¸åŒçš„å…·ä½“å€¼ã€‚

<br/>

##### å®ç°å®Œæ•´ä¸šåŠ¡

é¦–å…ˆæˆ‘ä»¬éœ€è¦å®šä¹‰ä¸€ä¸ªMQé€šçŸ¥çš„æ¶ˆæ¯ä½“ï¼Œç”±äºè¿™ä¸ªæ¶ˆæ¯ä½“ä¼šåœ¨å„ä¸ªç›¸å…³å¾®æœåŠ¡ä¸­ä½¿ç”¨ï¼Œéœ€è¦å®šä¹‰åˆ°å…¬ç”¨çš„æ¨¡å—ä¸­ï¼Œè¿™é‡Œæˆ‘ä»¬å®šä¹‰åˆ°`tj-api`æ¨¡å—ï¼š

![img](./assets/20230725154107296.jpg)

å…·ä½“ä»£ç å¦‚ä¸‹ï¼šLikedTimesDTO

```java
@Data
@NoArgsConstructor
@AllArgsConstructor(staticName = "of")
public class LikedTimesDTO {
    /**
     * ç‚¹èµçš„ä¸šåŠ¡id
     */
    private Long bizId;
    /**
     * æ€»çš„ç‚¹èµæ¬¡æ•°
     */
    private Integer likedTimes;
}
```

`tj-remark` çš„ä»£ç å¦‚ä¸‹ï¼šLikeRecordFormDTO

```Java
package com.tianji.remark.domain.dto;

import io.swagger.annotations.ApiModel;
import io.swagger.annotations.ApiModelProperty;
import lombok.Data;

import javax.validation.constraints.NotNull;

@Data
@ApiModel(description = "ç‚¹èµè®°å½•è¡¨å•å®ä½“")
public class LikeRecordFormDTO {
    @ApiModelProperty("ç‚¹èµä¸šåŠ¡id")
    @NotNull(message = "ä¸šåŠ¡idä¸èƒ½ä¸ºç©º")
    private Long bizId;

    @ApiModelProperty("ç‚¹èµä¸šåŠ¡ç±»å‹")
    @NotNull(message = "ä¸šåŠ¡ç±»å‹ä¸èƒ½ä¸ºç©º")
    private String bizType;

    @ApiModelProperty("æ˜¯å¦ç‚¹èµï¼Œtrueï¼šç‚¹èµï¼›falseï¼šå–æ¶ˆç‚¹èµ")
    @NotNull(message = "æ˜¯å¦ç‚¹èµä¸èƒ½ä¸ºç©º")
    private Boolean liked;
}
```

ç„¶åæ˜¯`com.tianji.remark.service.impl.LikedRecordServiceImpl`å®Œæ•´çš„ä¸šåŠ¡é€»è¾‘ï¼š

```Java
package com.tianji.remark.service.impl;

import com.baomidou.mybatisplus.core.conditions.query.QueryWrapper;
import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.tianji.common.autoconfigure.mq.RabbitMqHelper;
import com.tianji.common.utils.StringUtils;
import com.tianji.common.utils.UserContext;
import com.tianji.remark.domain.dto.LikeRecordFormDTO;
import com.tianji.remark.domain.po.LikedRecord;
import com.tianji.remark.mapper.LikedRecordMapper;
import com.tianji.remark.service.ILikedRecordService;
import lombok.RequiredArgsConstructor;

import java.util.List;
import java.util.Set;
import java.util.stream.Collectors;

import static com.tianji.common.constants.MqConstants.Exchange.LIKE_RECORD_EXCHANGE;
import static com.tianji.common.constants.MqConstants.Key.LIKED_TIMES_KEY_TEMPLATE;

/**
 * <p>
 * ç‚¹èµè®°å½•è¡¨ æœåŠ¡å®ç°ç±»
 * </p>
 */
@Service
@RequiredArgsConstructor
public class LikedRecordServiceImpl extends ServiceImpl<LikedRecordMapper, LikedRecord> implements ILikedRecordService {

    private final RabbitMqHelper mqHelper;

    @Override
    public void addLikeRecord(LikeRecordFormDTO recordDTO) {
        // 1.åŸºäºå‰ç«¯çš„å‚æ•°ï¼Œåˆ¤æ–­æ˜¯æ‰§è¡Œç‚¹èµè¿˜æ˜¯å–æ¶ˆç‚¹èµ
        boolean success = recordDTO.getLiked() ? like(recordDTO) : unlike(recordDTO);
        // 2.åˆ¤æ–­æ˜¯å¦æ‰§è¡ŒæˆåŠŸï¼Œå¦‚æœå¤±è´¥ï¼Œåˆ™ç›´æ¥ç»“æŸ
        if (!success) {
            return;
        }
        // 3.å¦‚æœæ‰§è¡ŒæˆåŠŸï¼Œç»Ÿè®¡ç‚¹èµæ€»æ•°
        Integer likedTimes = lambdaQuery()
                .eq(LikedRecord::getBizId, recordDTO.getBizId())
                .count();
        // 4.å‘é€MQé€šçŸ¥
        mqHelper.send(
                LIKE_RECORD_EXCHANGE,
                StringUtils.format(LIKED_TIMES_KEY_TEMPLATE, recordDTO.getBizType()),
                LikedTimesDTO.of(recordDTO.getBizId(), likedTimes));
    }

    private boolean unlike(LikeRecordFormDTO recordDTO) {
        return remove(new QueryWrapper<LikedRecord>().lambda()
                .eq(LikedRecord::getUserId, UserContext.getUser())
                .eq(LikedRecord::getBizId, recordDTO.getBizId()));
    }

    private boolean like(LikeRecordFormDTO recordDTO) {
        Long userId = UserContext.getUser();
        // 1.æŸ¥è¯¢ç‚¹èµè®°å½•
        Integer count = lambdaQuery()
                .eq(LikedRecord::getUserId, userId)
                .eq(LikedRecord::getBizId, recordDTO.getBizId())
                .count();
        // 2.åˆ¤æ–­æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœå·²ç»å­˜åœ¨ï¼Œç›´æ¥ç»“æŸ
        if (count > 0) {
            return false;
        }
        // 3.å¦‚æœä¸å­˜åœ¨ï¼Œç›´æ¥æ–°å¢
        LikedRecord r = new LikedRecord();
        r.setUserId(userId);
        r.setBizId(recordDTO.getBizId());
        r.setBizType(recordDTO.getBizType());
        save(r);
        return true;
    }
}
```

<br/>

#### æ‰¹é‡æŸ¥è¯¢ç‚¹èµçŠ¶æ€

ç”±äºè¿™ä¸ªæ¥å£æ˜¯ä¾›å…¶å®ƒå¾®æœåŠ¡è°ƒç”¨ï¼Œå®ç°å®Œæˆæ¥å£åï¼Œè¿˜éœ€è¦å®šä¹‰å¯¹åº”çš„FeignClient

<br/>

##### æ¥å£ä¿¡æ¯

è¿™é‡Œæ˜¯æŸ¥è¯¢å¤šä¸ªä¸šåŠ¡çš„ç‚¹èµçŠ¶æ€ï¼Œå› æ­¤è¯·æ±‚å‚æ•°è‡ªç„¶æ˜¯ä¸šåŠ¡idçš„é›†åˆã€‚ç”±äºæ˜¯æŸ¥è¯¢å½“å‰ç”¨æˆ·çš„ç‚¹èµçŠ¶æ€ï¼Œå› æ­¤æ— éœ€ä¼ é€’ç”¨æˆ·ä¿¡æ¯ã€‚

ç»è¿‡ç­›é€‰åˆ¤æ–­åï¼Œæˆ‘ä»¬æŠŠç‚¹èµè¿‡çš„ä¸šåŠ¡idé›†åˆè¿”å›å³å¯ã€‚

ç»¼ä¸Šï¼ŒæŒ‰ç…§Restfulæ¥è®¾è®¡è¯¥æ¥å£ï¼Œæ¥å£ä¿¡æ¯å¦‚ä¸‹ï¼š

![image-20240214145628888](assets/image-20240214145628888.png)

<br/>

##### ä»£ç 

é¦–å…ˆæ˜¯`tj-remark`çš„`com.tianji.remark.controller.LikedRecordController`ï¼š

```Java
package com.tianji.remark.controller;

import com.tianji.remark.domain.dto.LikeRecordFormDTO;
import com.tianji.remark.service.ILikedRecordService;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import lombok.RequiredArgsConstructor;
import org.springframework.web.bind.annotation.*;

import javax.validation.Valid;
import java.util.List;
import java.util.Set;

/**
 * <p>
 * ç‚¹èµè®°å½•è¡¨ æ§åˆ¶å™¨
 * </p>
 */
@RestController
@RequiredArgsConstructor
@RequestMapping("/likes")
@Api(tags = "ç‚¹èµä¸šåŠ¡ç›¸å…³æ¥å£")
public class LikedRecordController {

    private final ILikedRecordService likedRecordService;

    @PostMapping
    @ApiOperation("ç‚¹èµæˆ–å–æ¶ˆç‚¹èµ")
    public void addLikeRecord(@Valid @RequestBody LikeRecordFormDTO recordDTO) {
        likedRecordService.addLikeRecord(recordDTO);
    }

    @GetMapping("list")
    @ApiOperation("æŸ¥è¯¢æŒ‡å®šä¸šåŠ¡idçš„ç‚¹èµçŠ¶æ€")
    public Set<Long> isBizLiked(@RequestParam("bizIds") List<Long> bizIds){
        return likedRecordService.isBizLiked(bizIds);
    }
}
```

<br/>

ç„¶åæ˜¯`tj-remark`çš„`com.tianji.remark.service.ILikedRecordService`ï¼š

```Java
package com.tianji.remark.service;

import com.tianji.remark.domain.dto.LikeRecordFormDTO;
import com.tianji.remark.domain.po.LikedRecord;
import com.baomidou.mybatisplus.extension.service.IService;

import java.util.List;
import java.util.Set;

/**
 * <p>
 * ç‚¹èµè®°å½•è¡¨ æœåŠ¡ç±»
 * </p>
 */
public interface ILikedRecordService extends IService<LikedRecord> {

    void addLikeRecord(LikeRecordFormDTO recordDTO);

    Set<Long> isBizLiked(List<Long> bizIds);
}
```

<br/>

æœ€åæ˜¯`tj-remark`çš„å®ç°ç±»`com.tianji.remark.service.impl.LikedRecordServiceImpl`ï¼š

```Java
@Override
public Set<Long> isBizLiked(List<Long> bizIds) {
    // 1.è·å–ç™»å½•ç”¨æˆ·id
    Long userId = UserContext.getUser();
    // 2.æŸ¥è¯¢ç‚¹èµçŠ¶æ€
    List<LikedRecord> list = lambdaQuery()
            .in(LikedRecord::getBizId, bizIds)
            .eq(LikedRecord::getUserId, userId)
            .list();
    // 3.è¿”å›ç»“æœ
    return list.stream().map(LikedRecord::getBizId).collect(Collectors.toSet());
}
```

<br/>

##### æš´éœ²Feignæ¥å£

ç”±äºè¯¥æ¥å£æ˜¯ç»™å…¶å®ƒå¾®æœåŠ¡è°ƒç”¨çš„ï¼Œæ‰€ä»¥å¿…é¡»æš´éœ²å‡ºFeignå®¢æˆ·ç«¯ï¼Œå¹¶ä¸”å®šä¹‰å¥½fallbacké™çº§å¤„ç†ï¼š

æˆ‘ä»¬åœ¨tj-apiæ¨¡å—ä¸­å®šä¹‰ä¸€ä¸ªå®¢æˆ·ç«¯ï¼š

![img](./assets/20230725154107446.jpg)

<br/>

å…¶ä¸­RemarkClientå¦‚ä¸‹ï¼š

```Java
package com.tianji.api.client.remark;

import com.tianji.api.client.remark.fallback.RemarkClientFallback;
import org.springframework.cloud.openfeign.FeignClient;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestParam;

import java.util.Set;

@FeignClient(value = "remark-service", fallbackFactory = RemarkClientFallback.class)
public interface RemarkClient {
    @GetMapping("/likes/list")
    Set<Long> isBizLiked(@RequestParam("bizIds") Iterable<Long> bizIds);
}
```

<br/>

å¯¹åº”çš„fallbacké€»è¾‘ï¼š

```Java
package com.tianji.api.client.remark.fallback;

import com.tianji.api.client.remark.RemarkClient;
import com.tianji.common.utils.CollUtils;
import lombok.extern.slf4j.Slf4j;
import org.springframework.cloud.openfeign.FallbackFactory;

import java.util.Set;

@Slf4j
public class RemarkClientFallback implements FallbackFactory<RemarkClient> {

    @Override
    public RemarkClient create(Throwable cause) {
        log.error("æŸ¥è¯¢remark-serviceæœåŠ¡å¼‚å¸¸", cause);
        return new RemarkClient() {

            @Override
            public Set<Long> isBizLiked(Iterable<Long> bizIds) {
                return CollUtils.emptySet();
            }
        };
    }
}
```

<br/>

ç”±äº`RemarkClientFallback`æ˜¯å®šä¹‰åœ¨`tj-api`çš„`com.tianji.api`åŒ…ï¼Œç”±äºæ¯ä¸ªå¾®æœåŠ¡æ‰«æåŒ…ä¸ä¸€è‡´ã€‚å› æ­¤å…¶å®ƒå¼•ç”¨`tj-api`çš„å¾®æœåŠ¡æ˜¯æ— æ³•é€šè¿‡æ‰«æåŒ…åŠ è½½åˆ°è¿™ä¸ªç±»çš„ã€‚

æˆ‘ä»¬éœ€è¦é€šè¿‡SpringBootçš„è‡ªåŠ¨åŠ è½½æœºåˆ¶æ¥åŠ è½½è¿™äº›fallbackç±»ï¼š

![img](./assets/20230725154107557.jpg)

<br/>

ç”±äºSpringBootä¼šåœ¨å¯åŠ¨æ—¶è¯»å–`/META-INF/spring.factories`æ–‡ä»¶ï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨è¯¥æ–‡ä»¶ä¸­æŒ‡å®šäº†è¦åŠ è½½

`FallbackConig`ç±»ï¼š

```Java
@Configuration
public class FallbackConfig {
    @Bean
    public LearningClientFallback learningClientFallback(){
        return new LearningClientFallback();
    }

    @Bean
    public TradeClientFallback tradeClientFallback(){
        return new TradeClientFallback();
    }

    @Bean
    public RemarkClientFallback remarkClientFallback(){
        return new RemarkClientFallback();
    }
}
```

è¿™æ ·æ‰€æœ‰åœ¨å…¶ä¸­å®šä¹‰çš„fallbackç±»éƒ½ä¼šè¢«åŠ è½½äº†ã€‚

<br/>

##### æ”¹é€ æŸ¥è¯¢å›å¤æ¥å£

å¼€å‘æŸ¥è¯¢ç‚¹èµçŠ¶æ€æ¥å£çš„ç›®çš„ï¼Œæ˜¯ä¸ºäº†åœ¨æŸ¥è¯¢ç”¨æˆ·å›ç­”å’Œè¯„è®ºæ—¶ï¼Œèƒ½çœ‹åˆ°å½“å‰ç”¨æˆ·æ˜¯å¦ç‚¹èµäº†ã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦æ”¹é€ ä¹‹å‰å®ç°çš„åˆ†é¡µæŸ¥è¯¢å›ç­”æˆ–è¯„è®ºçš„æ¥å£ã€‚

é¦–å…ˆæ‰¾åˆ°`tj-api`ä¸­çš„`com.tianji.learning.service.impl.InteractionReplyServiceImpl`ï¼Œæ³¨å…¥è¯„ä»·æœåŠ¡çš„Feignå®¢æˆ·ç«¯ï¼š

![img](./assets/20230725154107959.jpg)

ç„¶åæ”¹é€ åˆ†é¡µæŸ¥è¯¢å›ç­”çš„ä¸šåŠ¡å³å¯ï¼Œç”±äºåˆ†é¡µæŸ¥è¯¢å›ç­”æ˜¯å¤§å®¶å„è‡ªå®ç°çš„ï¼Œè¿™éƒ¨åˆ†æ”¹é€ ä¹Ÿæœ‰å¤§å®¶æ¥å®ç°ã€‚

<br/>

#### ç›‘å¬ç‚¹èµå˜æ›´çš„æ¶ˆæ¯

æ—¢ç„¶ç‚¹èµåä¼šå‘é€MQæ¶ˆæ¯é€šçŸ¥ä¸šåŠ¡æœåŠ¡ï¼Œé‚£ä¹ˆæ¯ä¸€ä¸ªæœ‰å…³çš„ä¸šåŠ¡æœåŠ¡éƒ½åº”è¯¥ç›‘å¬ç‚¹èµæ•°å˜æ›´çš„æ¶ˆæ¯ï¼Œæ›´æ–°æœ¬åœ°çš„ç‚¹èµæ•°é‡ã€‚

ä¾‹å¦‚äº’åŠ¨é—®ç­”ï¼Œæˆ‘ä»¬éœ€è¦åœ¨`tj-learning`æœåŠ¡ä¸­å®šä¹‰MQç›‘å¬å™¨ï¼š

![img](./assets/20230725154107960.jpg)

<br/>

å…·ä½“ä»£ç å¦‚ä¸‹ï¼š

```Java
package com.tianji.learning.mq;

import com.tianji.api.dto.remark.LikedTimesDTO;
import com.tianji.learning.domain.po.InteractionReply;
import com.tianji.learning.service.IInteractionReplyService;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.amqp.core.ExchangeTypes;
import org.springframework.amqp.rabbit.annotation.Exchange;
import org.springframework.amqp.rabbit.annotation.Queue;
import org.springframework.amqp.rabbit.annotation.QueueBinding;
import org.springframework.amqp.rabbit.annotation.RabbitListener;
import org.springframework.stereotype.Component;

import java.util.ArrayList;
import java.util.List;

import static com.tianji.common.constants.MqConstants.Exchange.LIKE_RECORD_EXCHANGE;
import static com.tianji.common.constants.MqConstants.Key.QA_LIKED_TIMES_KEY;

@Slf4j
@Component
@RequiredArgsConstructor
public class LikeTimesChangeListener {

    private final IInteractionReplyService replyService;

    @RabbitListener(bindings = @QueueBinding(
            value = @Queue(name = "qa.liked.times.queue", durable = "true"),
            exchange = @Exchange(name = LIKE_RECORD_EXCHANGE, type = ExchangeTypes.TOPIC),
            key = QA_LIKED_TIMES_KEY
    ))
    public void listenReplyLikedTimesChange(LikedTimesDTO dto){
        log.debug("ç›‘å¬åˆ°å›ç­”æˆ–è¯„è®º{}çš„ç‚¹èµæ•°å˜æ›´:{}", dto.getBizId(), dto.getLikedTimes());

        List<InteractionReply> list = new ArrayList<>(likedTimesDTOs.size());
        InteractionReply r = new InteractionReply();
        r.setId(dto.getBizId());
        r.setLikedTimes(dto.getLikedTimes());
        replyService.updateById(r);
    }
}
```

<br/>

### ç‚¹èµåŠŸèƒ½æ”¹è¿›

è™½ç„¶æˆ‘ä»¬åˆæ­¥å®ç°äº†ç‚¹èµåŠŸèƒ½ï¼Œä¸è¿‡æœ‰ä¸€ä¸ªéå¸¸ä¸¥é‡çš„é—®é¢˜ï¼Œç‚¹èµä¸šåŠ¡åŒ…å«å¤šæ¬¡æ•°æ®åº“è¯»å†™æ“ä½œï¼š

![img](./assets/20230725154108877.jpg)

æ›´é‡è¦çš„æ˜¯ï¼Œç‚¹èµæ“ä½œæ³¢åŠ¨è¾ƒå¤§ï¼Œæœ‰å¯èƒ½ä¼šåœ¨çŸ­æ—¶é—´å†…è®¿é—®é‡æ¿€å¢ã€‚ä¾‹å¦‚æœ‰äººéå¸¸é¢‘ç¹çš„ç‚¹èµã€å–æ¶ˆç‚¹èµã€‚è¿™æ ·å°±ä¼šç»™æ•°æ®åº“å¸¦æ¥éå¸¸å¤§çš„å‹åŠ›ã€‚

æ€ä¹ˆåŠå‘¢ï¼Ÿ

<br/>

#### æ”¹è¿›æ€è·¯åˆ†æ

å…¶å®åœ¨å®ç°æäº¤å­¦ä¹ è®°å½•çš„æ—¶å€™ï¼Œæˆ‘ä»¬å°±ç»™å¤§å®¶åˆ†æè¿‡é«˜å¹¶å‘é—®é¢˜çš„å¤„ç†æ–¹æ¡ˆã€‚ç‚¹èµä¸šåŠ¡ä¸æäº¤æ’­æ”¾è®°å½•ç±»ä¼¼ï¼Œéƒ½æ˜¯é«˜å¹¶å‘å†™æ“ä½œã€‚

<br/>

æŒ‰ç…§ä¹‹å‰æˆ‘ä»¬è®²çš„ï¼Œé«˜å¹¶å‘å†™æ“ä½œå¸¸è§çš„ä¼˜åŒ–æ‰‹æ®µæœ‰ï¼š

- ä¼˜åŒ–SQLå’Œä»£ç 
- å˜åŒæ­¥å†™ä¸ºå¼‚æ­¥å†™
- åˆå¹¶å†™è¯·æ±‚

æœ‰åŒå­¦å¯èƒ½ä¼šè¯´ï¼Œæˆ‘ä»¬æ›´æ–°ä¸šåŠ¡æ–¹ç‚¹èµæ•°é‡çš„æ—¶å€™ï¼Œä¸å°±æ˜¯åˆ©ç”¨MQå¼‚æ­¥å†™æ¥å®ç°çš„å—ï¼Ÿ

<br/>

æ²¡é”™ï¼Œç¡®å®å¦‚æ­¤ï¼Œè™½ç„¶å¼‚æ­¥å†™å‡å°‘äº†ä¸šåŠ¡æ‰§è¡Œæ—¶é—´ï¼Œé™ä½äº†æ•°æ®åº“å†™é¢‘ç‡ã€‚ä¸è¿‡æ­¤å¤„æ›´é‡è¦çš„æ˜¯åˆ©ç”¨MQæ¥è§£è€¦ã€‚è€Œä¸”æ•°æ®åº“çš„å†™æ¬¡æ•°æ²¡æœ‰å‡å°‘ï¼Œå‹åŠ›ä¾ç„¶å¾ˆå¤§ã€‚

æ‰€ä»¥ï¼Œæˆ‘ä»¬åº”è¯¥åƒä¹‹å‰æ’­æ”¾è®°å½•ä¸šåŠ¡ä¸€æ ·ï¼Œé‡‡ç”¨åˆå¹¶å†™è¯·æ±‚çš„æ–¹æ¡ˆã€‚å½“ç„¶ï¼Œç°åœ¨çš„å¼‚æ­¥å¤„ç†ä¹Ÿä¿ç•™ï¼Œè¿™æ ·å°±å…¼é¡¾äº†**å¼‚æ­¥å†™**ã€**åˆå¹¶å†™**çš„ä¼˜åŠ¿ã€‚

<br/>

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåˆå¹¶å†™æ˜¯æœ‰ä½¿ç”¨åœºæ™¯çš„ï¼Œå¿…é¡»æ˜¯å¯¹ä¸­é—´çš„Næ¬¡å†™æ“ä½œä¸æ•æ„Ÿçš„æƒ…å†µä¸‹ã€‚ç‚¹èµä¸šåŠ¡æ˜¯å¦ç¬¦åˆè¿™ä¸€éœ€æ±‚å‘¢ï¼Ÿ

æ— è®ºç”¨æˆ·ä¸­é—´æ‰§è¡Œç‚¹èµã€å–æ¶ˆã€å†ç‚¹èµã€å†å–æ¶ˆå¤šå°‘æ¬¡ï¼Œç‚¹èµæ¬¡æ•°å‘ç”Ÿäº†å¤šå°‘æ¬¡å˜åŒ–ï¼Œä¸šåŠ¡æ–¹åªå…³æ³¨æœ€ç»ˆçš„ç‚¹èµç»“æœå³å¯ï¼š

- ç”¨æˆ·æ˜¯å¦ç‚¹èµäº†
- ä¸šåŠ¡çš„æ€»ç‚¹èµæ¬¡æ•°

å› æ­¤ï¼Œç‚¹èµåŠŸèƒ½å¯ä»¥ä½¿ç”¨åˆå¹¶å†™æ–¹æ¡ˆã€‚æœ€ç»ˆæˆ‘ä»¬çš„ç‚¹èµä¸šåŠ¡æµç¨‹å˜æˆè¿™æ ·ï¼š

![img](./assets/20230725154108519.jpg)

<br/>

åˆå¹¶å†™è¯·æ±‚æœ‰ä¸¤ä¸ªå…³é”®ç‚¹è¦è€ƒè™‘ï¼š

- æ•°æ®å¦‚ä½•ç¼“å­˜
- ç¼“å­˜ä½•æ—¶å†™å…¥æ•°æ®åº“

<br/>

##### ç‚¹èµæ•°æ®ç¼“å­˜

ç‚¹èµè®°å½•ä¸­æœ€ä¸¤ä¸ªå…³é”®ä¿¡æ¯ï¼š

- ç”¨æˆ·æ˜¯å¦ç‚¹èµ
- æŸä¸šåŠ¡çš„ç‚¹èµæ€»æ¬¡æ•°

<br/>

è¿™ä¸¤ä¸ªä¿¡æ¯éœ€è¦åˆ†åˆ«è®°å½•ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬éœ€è¦åœ¨Redisä¸­è®¾è®¡ä¸¤ç§æ•°æ®ç»“æ„åˆ†åˆ«å­˜å‚¨ã€‚



###### ç”¨æˆ·æ˜¯å¦ç‚¹èµ

è¦çŸ¥é“æŸä¸ªç”¨æˆ·æ˜¯å¦ç‚¹èµæŸä¸ªä¸šåŠ¡ï¼Œå°±å¿…é¡»è®°å½•ä¸šåŠ¡idä»¥åŠç»™ä¸šåŠ¡ç‚¹èµçš„æ‰€æœ‰ç”¨æˆ·id . ç”±äºä¸€ä¸ªä¸šåŠ¡å¯ä»¥è¢«å¾ˆå¤šç”¨æˆ·ç‚¹èµï¼Œæ˜¾ç„¶æ˜¯éœ€è¦ä¸€ä¸ªé›†åˆæ¥è®°å½•ã€‚è€ŒRedisä¸­çš„é›†åˆç±»å‹åŒ…å«å››ç§ï¼š

- List
- Set
- SortedSet
- Hash

è€Œè¦åˆ¤æ–­ç”¨æˆ·æ˜¯å¦ç‚¹èµï¼Œå°±æ˜¯åˆ¤æ–­å­˜åœ¨ä¸”å”¯ä¸€ã€‚æ˜¾ç„¶ï¼ŒSeté›†åˆæ˜¯æœ€åˆé€‚çš„ã€‚æˆ‘ä»¬å¯ä»¥ç”¨ä¸šåŠ¡idä¸ºKeyï¼Œåˆ›å»ºSeté›†åˆï¼Œå°†ç‚¹èµçš„æ‰€æœ‰ç”¨æˆ·ä¿å­˜å…¶ä¸­ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š

![image-20240214150244272](assets/image-20240214150244272.png)

<br/>

å¯ä»¥ä½¿ç”¨Seté›†åˆçš„ä¸‹åˆ—å‘½ä»¤å®Œæˆç‚¹èµåŠŸèƒ½ï¼š

```Shell
# åˆ¤æ–­ç”¨æˆ·æ˜¯å¦ç‚¹èµ
SISMEMBER bizId userId
# ç‚¹èµï¼Œå¦‚æœè¿”å›1åˆ™ä»£è¡¨ç‚¹èµæˆåŠŸï¼Œè¿”å›0åˆ™ä»£è¡¨ç‚¹èµå¤±è´¥
SADD bizId userId
# å–æ¶ˆç‚¹èµï¼Œå°±æ˜¯åˆ é™¤ä¸€ä¸ªå…ƒç´ 
SREM bizId userId
# ç»Ÿè®¡ç‚¹èµæ€»æ•°
SCARD bizId
```

<br/>

ç”±äºRedisæœ¬èº«å…·å¤‡æŒä¹…åŒ–æœºåˆ¶ï¼ŒAOFæä¾›çš„æ•°æ®å¯é æ€§å·²ç»èƒ½å¤Ÿæ»¡è¶³ç‚¹èµä¸šåŠ¡çš„å®‰å…¨éœ€æ±‚ï¼Œå› æ­¤æˆ‘ä»¬å®Œå…¨å¯ä»¥ç”¨Rediså­˜å‚¨æ¥ä»£æ›¿æ•°æ®åº“çš„ç‚¹èµè®°å½•ã€‚

ä¹Ÿå°±æ˜¯è¯´ï¼Œç”¨æˆ·çš„ä¸€åˆ‡ç‚¹èµè¡Œä¸ºï¼Œä»¥åŠå°†æ¥æŸ¥è¯¢ç‚¹èµçŠ¶æ€æˆ‘ä»¬å¯ä»¥éƒ½èµ°Redisï¼Œä¸å†ä½¿ç”¨æ•°æ®åº“æŸ¥è¯¢ã€‚

<br/>

:::warning ğŸ’¡æ€è€ƒï¼šæœ‰åŒå­¦ä¼šæ‹…å¿ƒï¼Œå¦‚æœç‚¹èµæ•°æ®éå¸¸åºå¤§ï¼Œè¾¾åˆ°æ•°ç™¾äº¿ï¼Œé‚£ä¹ˆè¯¥æ€åŠå‘¢ï¼Ÿ

å¤§å¤šæ•°ä¼ä¸šæ ¹æœ¬è¾¾ä¸åˆ°è¿™æ ·çš„è§„æ¨¡ï¼Œå¦‚æœçœŸçš„è¾¾åˆ°ä¹Ÿæ²¡æœ‰å…³ç³»ã€‚è¿™ä¸ªæ—¶å€™æˆ‘ä»¬å¯ä»¥å°†Redisä¸æ•°æ®åº“ç»“åˆã€‚

- å…ˆåˆ©ç”¨Redisæ¥è®°å½•ç‚¹èµçŠ¶æ€ï¼Œå¹¶è®¾ç½®ç¼“å­˜è¿‡æœŸæ—¶é—´
- å¹¶ä¸”å®šæœŸçš„å°†Redisä¸­çš„ç‚¹èµçŠ¶æ€æŒä¹…åŒ–åˆ°æ•°æ®åº“
- å½“æŸä¸ªè®°å½•ç‚¹èµæ—¶ï¼Œä¼˜å…ˆå»RedisæŸ¥è¯¢å¹¶åˆ¤æ–­ï¼Œå¦‚æœRedisä¸­ä¸å­˜åœ¨ï¼Œå†å»æŸ¥è¯¢æ•°æ®åº“æ•°æ®å¹¶ç¼“å­˜åˆ°Redisã€‚

:::

<br/>

**ç‚¹èµæ¬¡æ•°**

ç”±äºç‚¹èµæ¬¡æ•°éœ€è¦åœ¨ä¸šåŠ¡æ–¹æŒä¹…åŒ–å­˜å‚¨åˆ°æ•°æ®åº“ï¼Œå› æ­¤Redisåªèµ·åˆ°ç¼“å­˜ä½œç”¨å³å¯ã€‚

ç”±äºéœ€è¦è®°å½•ä¸šåŠ¡idã€ä¸šåŠ¡ç±»å‹ã€ç‚¹èµæ•°ä¸‰ä¸ªä¿¡æ¯ï¼š

- ä¸€ä¸ªä¸šåŠ¡ç±»å‹ä¸‹åŒ…å«å¤šä¸ªä¸šåŠ¡id
- æ¯ä¸ªä¸šåŠ¡idå¯¹åº”ä¸€ä¸ªç‚¹èµæ•°ã€‚

<br/>

å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠæ¯ä¸€ä¸ªä¸šåŠ¡ç±»å‹ä½œä¸ºä¸€ç»„ï¼Œä½¿ç”¨Redisçš„ä¸€ä¸ªkeyï¼Œç„¶åä¸šåŠ¡idä½œä¸ºé”®ï¼Œç‚¹èµæ•°ä½œä¸ºå€¼ã€‚è¿™æ ·çš„é”®å€¼å¯¹é›†åˆï¼Œæœ‰ä¸¤ç§ç»“æ„éƒ½å¯ä»¥æ»¡è¶³ï¼š

- Hashï¼šä¼ ç»Ÿé”®å€¼å¯¹é›†åˆï¼Œæ— åº
- SortedSetï¼šåŸºäºHashç»“æ„ï¼Œå¹¶ä¸”å¢åŠ äº†è·³è¡¨ã€‚å› æ­¤å¯æ’åºï¼Œä½†æ›´å ç”¨å†…å­˜

å¦‚æœæ˜¯ä»èŠ‚çœå†…å­˜è§’åº¦æ¥è€ƒè™‘ï¼ŒHashç»“æ„æ— ç–‘æ˜¯æœ€ä½³çš„é€‰æ‹©ï¼›ä½†æ˜¯è€ƒè™‘åˆ°å°†æ¥æˆ‘ä»¬è¦ä»Redisè¯»å–ç‚¹èµæ•°ï¼Œç„¶åç§»é™¤ï¼ˆé¿å…é‡å¤å¤„ç†ï¼‰ã€‚ä¸ºäº†ä¿è¯çº¿ç¨‹å®‰å…¨ï¼ŒæŸ¥è¯¢ã€ç§»é™¤æ“ä½œå¿…é¡»å…·å¤‡åŸå­æ€§ã€‚è€ŒSortedSetåˆ™æä¾›äº†å‡ ä¸ªç§»é™¤å¹¶è·å–çš„åŠŸèƒ½ï¼Œå¤©ç”Ÿå…·å¤‡åŸå­æ€§ã€‚å¹¶ä¸”æˆ‘ä»¬æ¯éš”ä¸€æ®µæ—¶é—´å°±ä¼šå°†æ•°æ®ä»Redisç§»é™¤ï¼Œå¹¶ä¸ä¼šå ç”¨å¤ªå¤šå†…å­˜ã€‚å› æ­¤ï¼Œè¿™é‡Œæˆ‘ä»¬è®¡åˆ’ä½¿ç”¨SortedSetç»“æ„ã€‚

<br/>

æ ¼å¼å¦‚ä¸‹ï¼š

![image-20240214150316753](assets/image-20240214150316753.png)

å½“ç”¨æˆ·å¯¹æŸä¸ªä¸šåŠ¡ç‚¹èµæ—¶ï¼Œæˆ‘ä»¬ç»Ÿè®¡ç‚¹èµæ€»æ•°ï¼Œå¹¶å°†å…¶ç¼“å­˜åœ¨Redisä¸­ã€‚è¿™æ ·ä¸€æ¥åœ¨ä¸€æ®µæ—¶é—´å†…ï¼Œä¸ç®¡æœ‰å¤šå°‘ç”¨æˆ·å¯¹è¯¥ä¸šåŠ¡ç‚¹èµï¼ˆçƒ­ç‚¹ä¸šåŠ¡æ•°æ®ï¼Œæ¯”å¦‚æŸä¸ªå¾®åšå¤§Vï¼‰ï¼Œéƒ½åªåœ¨Redisä¸­ä¿®æ”¹ç‚¹èµæ€»æ•°ï¼Œæ— éœ€ä¿®æ”¹æ•°æ®åº“ã€‚

<br/>

##### ç‚¹èµæ•°æ®å…¥åº“

ç‚¹èµæ•°æ®å†™å…¥ç¼“å­˜äº†ï¼Œä½†æ˜¯è¿™é‡Œæœ‰ä¸€ä¸ªæ–°çš„é—®é¢˜ï¼š

ä½•æ—¶æŠŠç¼“å­˜çš„ç‚¹èµæ•°ï¼Œé€šè¿‡MQé€šçŸ¥åˆ°ä¸šåŠ¡æ–¹ï¼ŒæŒä¹…åŒ–åˆ°ä¸šåŠ¡æ–¹çš„æ•°æ®åº“å‘¢ï¼Ÿ

<br/>

åœ¨ä¹‹å‰çš„æäº¤æ’­æ”¾è®°å½•ä¸šåŠ¡ä¸­ï¼Œç”±äºæ’­æ”¾è®°å½•æ˜¯å®šæœŸæ¯éš”15ç§’å‘é€ä¸€æ¬¡è¯·æ±‚ï¼Œé¢‘ç‡å›ºå®šã€‚å› æ­¤æˆ‘ä»¬å¯ä»¥é€šè¿‡æ¥æ”¶åˆ°æ’­æ”¾è®°å½•åå»¶è¿Ÿ20ç§’æ£€æµ‹æ•°æ®å˜æ›´æ¥ç¡®å®šæ˜¯å¦æœ‰æ–°æ•°æ®åˆ°è¾¾ã€‚

ä½†æ˜¯ç‚¹èµåˆ™ä¸ç„¶ï¼Œç”¨æˆ·ä½•æ—¶ç‚¹èµã€ç‚¹èµé¢‘ç‡å¦‚ä½•å®Œå…¨ä¸ç¡®å®šã€‚å› æ­¤æ— æ³•é‡‡ç”¨å»¶è¿Ÿæ£€æµ‹è¿™æ ·çš„æ‰‹æ®µã€‚æ€ä¹ˆåŠï¼Ÿ

<br/>

äº‹å®ä¸Šè¿™ä¹Ÿæ˜¯å¤§å¤šæ•°**åˆå¹¶å†™è¯·æ±‚**ä¸šåŠ¡é¢ä¸´çš„é—®é¢˜ï¼Œè€Œå¤šæ•°æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬åªèƒ½é€šè¿‡**å®šæ—¶ä»»åŠ¡**ï¼Œå®šæœŸå°†ç¼“å­˜çš„æ•°æ®æŒä¹…åŒ–åˆ°æ•°æ®åº“ä¸­ã€‚

<br/>

##### æµç¨‹å›¾

ç»¼ä¸Šæ‰€è¿°ï¼ŒåŸºäºRedisåšå†™ç¼“å­˜åï¼Œç‚¹èµæµç¨‹å¦‚ä¸‹ï¼š

![img](./assets/20230725154108802.jpg)

<br/>

#### æ”¹é€ ç‚¹èµé€»è¾‘

éœ€è¦æ”¹é€ çš„å†…å®¹åŒ…æ‹¬ï¼š

- `tj-remark`ä¸­æ‰€æœ‰ç‚¹èµæœ‰å…³æ¥å£
  - ç‚¹èµæ¥å£
  - æŸ¥è¯¢å•ä¸ªç‚¹èµçŠ¶æ€
  - æ‰¹é‡æŸ¥è¯¢ç‚¹èµçŠ¶æ€
- `tj-remark`å¤„ç†ç‚¹èµæ•°æ®æŒä¹…åŒ–çš„å®šæ—¶ä»»åŠ¡
- `tj-learning`ç›‘å¬ç‚¹èµæ•°å˜æ›´æ¶ˆæ¯çš„ä¸šåŠ¡

<br/>

ç”±äºéœ€è¦è®¿é—®Redisï¼Œæˆ‘ä»¬æå‰å®šä¹‰ä¸€ä¸ªå¸¸é‡ç±»ï¼ŒæŠŠRedisç›¸å…³çš„Keyå®šä¹‰ä¸ºå¸¸é‡ï¼š

![img](./assets/20230725154109090.jpg)

ä»£ç å¦‚ä¸‹ï¼š

```Java
public interface RedisConstants {
    /*ç»™ä¸šåŠ¡ç‚¹èµçš„ç”¨æˆ·é›†åˆçš„KEYå‰ç¼€ï¼Œåç¼€æ˜¯ä¸šåŠ¡id*/
    String LIKE_BIZ_KEY_PREFIX = "likes:set:biz:";
    /*ä¸šåŠ¡ç‚¹èµæ•°ç»Ÿè®¡çš„KEYå‰ç¼€ï¼Œåç¼€æ˜¯ä¸šåŠ¡ç±»å‹*/
    String LIKE_COUNT_KEY_PREFIX = "likes:times:type:";
}
```

<br/>

##### ç‚¹èµæ¥å£

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å®šä¹‰ä¸€ä¸ªæ–°çš„ç‚¹èµä¸šåŠ¡å®ç°ç±»ï¼š

![img](./assets/20230725154108393.jpg)

<br/>

å¹¶å°†LikedRecordServiceImplæ³¨é‡Šï¼š

![img](./assets/20230725154109156.jpg)

<br/>

ä»£ç å¦‚ä¸‹ï¼š

```Java
package com.tianji.remark.service.impl;

import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.tianji.api.dto.remark.LikedTimesDTO;
import com.tianji.common.autoconfigure.mq.RabbitMqHelper;
import com.tianji.common.utils.CollUtils;
import com.tianji.common.utils.StringUtils;
import com.tianji.common.utils.UserContext;
import com.tianji.remark.constants.RedisConstants;
import com.tianji.remark.domain.dto.LikeRecordFormDTO;
import com.tianji.remark.domain.po.LikedRecord;
import com.tianji.remark.mapper.LikedRecordMapper;
import com.tianji.remark.service.ILikedRecordService;
import lombok.RequiredArgsConstructor;
import org.springframework.data.redis.connection.StringRedisConnection;
import org.springframework.data.redis.core.RedisCallback;
import org.springframework.data.redis.core.StringRedisTemplate;
import org.springframework.data.redis.core.ZSetOperations;
import org.springframework.stereotype.Service;

import java.util.ArrayList;
import java.util.List;
import java.util.Set;
import java.util.stream.Collectors;
import java.util.stream.IntStream;

import static com.tianji.common.constants.MqConstants.Exchange.LIKE_RECORD_EXCHANGE;
import static com.tianji.common.constants.MqConstants.Key.LIKED_TIMES_KEY_TEMPLATE;

/**
 * <p>
 * ç‚¹èµè®°å½•è¡¨ æœåŠ¡å®ç°ç±»
 * </p>
 */
@Service
@RequiredArgsConstructor
public class LikedRecordServiceRedisImpl extends ServiceImpl<LikedRecordMapper, LikedRecord> implements ILikedRecordService {

    private final RabbitMqHelper mqHelper;
    private final StringRedisTemplate redisTemplate;

    @Override
    public void addLikeRecord(LikeRecordFormDTO recordDTO) {
        // 1.åŸºäºå‰ç«¯çš„å‚æ•°ï¼Œåˆ¤æ–­æ˜¯æ‰§è¡Œç‚¹èµè¿˜æ˜¯å–æ¶ˆç‚¹èµ
        boolean success = recordDTO.getLiked() ? like(recordDTO) : unlike(recordDTO);
        // 2.åˆ¤æ–­æ˜¯å¦æ‰§è¡ŒæˆåŠŸï¼Œå¦‚æœå¤±è´¥ï¼Œåˆ™ç›´æ¥ç»“æŸ
        if (!success) {
            return;
        }
        // 3.å¦‚æœæ‰§è¡ŒæˆåŠŸï¼Œç»Ÿè®¡ç‚¹èµæ€»æ•°
        Long likedTimes = redisTemplate.opsForSet()
                .size(RedisConstants.LIKES_BIZ_KEY_PREFIX + recordDTO.getBizId());
        if (likedTimes == null) {
            return;
        }
        // 4.ç¼“å­˜ç‚¹æ€»æ•°åˆ°Redis
        redisTemplate.opsForZSet().add(
                RedisConstants.LIKES_TIMES_KEY_PREFIX + recordDTO.getBizType(),
                recordDTO.getBizId().toString(),
                likedTimes
        );
    }

    private boolean unlike(LikeRecordFormDTO recordDTO) {
        // 1.è·å–ç”¨æˆ·id
        Long userId = UserContext.getUser();
        // 2.è·å–Key
        String key = RedisConstants.LIKES_BIZ_KEY_PREFIX + recordDTO.getBizId();
        // 3.æ‰§è¡ŒSREMå‘½ä»¤
        Long result = redisTemplate.opsForSet().remove(key, userId.toString());
        return result != null && result > 0;
    }

    private boolean like(LikeRecordFormDTO recordDTO) {
        // 1.è·å–ç”¨æˆ·id
        Long userId = UserContext.getUser();
        // 2.è·å–Key
        String key = RedisConstants.LIKES_BIZ_KEY_PREFIX + recordDTO.getBizId();
        // 3.æ‰§è¡ŒSADDå‘½ä»¤
        Long result = redisTemplate.opsForSet().add(key, userId.toString());
        return result != null && result > 0;
    }
}
```

<br/>

##### æ‰¹é‡æŸ¥è¯¢ç‚¹èµçŠ¶æ€ç»Ÿè®¡

ç›®å‰æˆ‘ä»¬çš„Redisç‚¹èµè®°å½•æ•°æ®ç»“æ„å¦‚ä¸‹ï¼š

![image-20240214150401214](assets/image-20240214150401214.png)

å½“æˆ‘ä»¬åˆ¤æ–­æŸç”¨æˆ·æ˜¯å¦ç‚¹èµæ—¶ï¼Œéœ€è¦ä½¿ç”¨ä¸‹é¢å‘½ä»¤ï¼š

```Shell
# åˆ¤æ–­ç”¨æˆ·æ˜¯å¦ç‚¹èµ
SISMEMBER bizId userId
```

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™ä¸ªå‘½ä»¤åªèƒ½åˆ¤æ–­**ä¸€ä¸ªç”¨æˆ·å¯¹æŸä¸€ä¸ªä¸šåŠ¡**çš„ç‚¹èµçŠ¶æ€ã€‚è€Œæˆ‘ä»¬çš„æ¥å£æ˜¯è¦æŸ¥è¯¢å½“å‰ç”¨æˆ·å¯¹å¤šä¸ªä¸šåŠ¡çš„ç‚¹èµçŠ¶æ€ã€‚

å› æ­¤ï¼Œæˆ‘ä»¬å°±éœ€è¦å¤šæ¬¡è°ƒç”¨`SISMEMBER`å‘½ä»¤ï¼Œä¹Ÿå°±éœ€è¦å‘Rediså¤šæ¬¡å‘èµ·ç½‘ç»œè¯·æ±‚ï¼Œç»™ç½‘ç»œå¸¦å®½å¸¦æ¥éå¸¸å¤§çš„å‹åŠ›ï¼Œå½±å“ä¸šåŠ¡æ€§èƒ½ã€‚

<br/>

é‚£ä¹ˆï¼Œæœ‰æ²¡æœ‰åŠæ³•èƒ½å¤Ÿä¸€ä¸ªå‘½ä»¤å®Œæˆå¤šä¸ªä¸šåŠ¡ç‚¹èµçŠ¶æ€åˆ¤æ–­å‘¢ï¼Ÿ

éå¸¸é—æ†¾ï¼Œç­”æ¡ˆæ˜¯æ²¡æœ‰ï¼åªèƒ½å¤šæ¬¡æ‰§è¡Œ`SISMEMBER`å‘½ä»¤æ¥åˆ¤æ–­ã€‚

<br/>

ä¸è¿‡ï¼ŒRedisä¸­æä¾›äº†ä¸€ä¸ªåŠŸèƒ½ï¼Œå¯ä»¥åœ¨ä¸€æ¬¡è¯·æ±‚ä¸­æ‰§è¡Œå¤šä¸ªå‘½ä»¤ï¼Œå®ç°æ‰¹å¤„ç†æ•ˆæœã€‚è¿™ä¸ªåŠŸèƒ½å°±æ˜¯Pipeline 

https://redis.io/docs/manual/pipelining/

ä¸­æ–‡æ–‡æ¡£ï¼š

https://www.redis.com.cn/topics/pipelining.html

<br/>

:::warning  ä¸è¦åœ¨ä¸€æ¬¡æ‰¹å¤„ç†ä¸­ä¼ è¾“å¤ªå¤šå‘½ä»¤ï¼Œå¦åˆ™å•æ¬¡å‘½ä»¤å ç”¨å¸¦å®½è¿‡å¤šï¼Œä¼šå¯¼è‡´ç½‘ç»œé˜»å¡

:::

<br/>

Springæä¾›çš„RedisTemplateä¹Ÿå…·å¤‡pipelineåŠŸèƒ½ï¼Œæœ€ç»ˆæ‰¹é‡æŸ¥è¯¢ç‚¹èµçŠ¶æ€åŠŸèƒ½å®ç°å¦‚ä¸‹ï¼š

```Java
@Override
public Set<Long> isBizLiked(List<Long> bizIds) {
    // 1.è·å–ç™»å½•ç”¨æˆ·id
    Long userId = UserContext.getUser();
    // 2.æŸ¥è¯¢ç‚¹èµçŠ¶æ€
    List<Object> objects = redisTemplate.executePipelined((RedisCallback<Object>) connection -> {
        StringRedisConnection src = (StringRedisConnection) connection;
        for (Long bizId : bizIds) {
            String key = RedisConstants.LIKES_BIZ_KEY_PREFIX + bizId;
            src.sIsMember(key, userId.toString());
        }
        return null;
    });
    // 3.è¿”å›ç»“æœ
    return IntStream.range(0, objects.size()) // åˆ›å»ºä»0åˆ°é›†åˆsizeçš„æµ
            .filter(i -> (boolean) objects.get(i)) // éå†æ¯ä¸ªå…ƒç´ ï¼Œä¿ç•™ç»“æœä¸ºtrueçš„è§’æ ‡i
            .mapToObj(bizIds::get)// ç”¨è§’æ ‡iå–bizIdsä¸­çš„å¯¹åº”æ•°æ®ï¼Œå°±æ˜¯ç‚¹èµè¿‡çš„id
            .collect(Collectors.toSet());// æ”¶é›†
}
```

<br/>

##### å®šæ—¶ä»»åŠ¡

ç‚¹èµæˆåŠŸåï¼Œä¼šæ›´æ–°ç‚¹èµæ€»æ•°å¹¶å†™å…¥Redisä¸­ã€‚è€Œæˆ‘ä»¬éœ€è¦å®šæ—¶è¯»å–è¿™äº›ç‚¹èµæ€»æ•°çš„å˜æ›´æ•°æ®ï¼Œé€šè¿‡MQå‘é€ç»™ä¸šåŠ¡æ–¹ã€‚è¿™å°±éœ€è¦å®šæ—¶ä»»åŠ¡æ¥å®ç°äº†ã€‚

å®šæ—¶ä»»åŠ¡çš„å®ç°æ–¹æ¡ˆæœ‰å¾ˆå¤šï¼Œç®€å•çš„ä¾‹å¦‚ï¼š

- SpringTask
- Quartz

è¿˜æœ‰ä¸€äº›ä¾èµ–ç¬¬ä¸‰æ–¹æœåŠ¡çš„åˆ†å¸ƒå¼ä»»åŠ¡æ¡†æ¶ï¼š

- Elastic-Job
- XXL-Job

<br/>

æ­¤å¤„æˆ‘ä»¬å…ˆä½¿ç”¨ç®€å•çš„SpringTaskæ¥å®ç°å¹¶æµ‹è¯•æ•ˆæœã€‚

<br/>

é¦–å…ˆï¼Œåœ¨`tj-remark`æ¨¡å—çš„`RemarkApplication`å¯åŠ¨ç±»ä¸Šæ·»åŠ æ³¨è§£ï¼š

![img](./assets/20230725154109311.jpg)

å…¶ä½œç”¨å°±æ˜¯å¯ç”¨Springçš„å®šæ—¶ä»»åŠ¡åŠŸèƒ½ã€‚

<br/>

ç„¶åï¼Œå®šä¹‰ä¸€ä¸ªå®šæ—¶ä»»åŠ¡å¤„ç†å™¨ç±»ï¼š

![img](./assets/20230725154109419.jpg)

<br/>

ä»£ç å¦‚ä¸‹ï¼š

```Java
package com.tianji.remark.task;

import com.tianji.remark.service.ILikedRecordService;
import lombok.RequiredArgsConstructor;
import org.springframework.scheduling.annotation.Scheduled;
import org.springframework.stereotype.Component;

import java.util.List;

@Component
@RequiredArgsConstructor
public class LikedTimesCheckTask {

    private static final List<String> BIZ_TYPES = List.of("QA", "NOTE");
    private static final int MAX_BIZ_SIZE = 30;

    private final ILikedRecordService recordService;

    @Scheduled(fixedDelay = 20000)
    public void checkLikedTimes(){
        for (String bizType : BIZ_TYPES) {
            recordService.readLikedTimesAndSendMessage(bizType, MAX_BIZ_SIZE);
        }
    }
}
```

ç”±äºå¯èƒ½å­˜åœ¨å¤šä¸ªä¸šåŠ¡ç±»å‹ï¼Œä¸èƒ½åšæ­¤è–„å½¼åªå¤„ç†éƒ¨åˆ†ä¸šåŠ¡ã€‚æ‰€ä»¥æˆ‘ä»¬ä¼šéå†å¤šç§ä¸šåŠ¡ç±»å‹ï¼Œåˆ†åˆ«å¤„ç†ã€‚åŒæ—¶ä¸ºäº†é¿å…ä¸€æ¬¡å¤„ç†çš„ä¸šåŠ¡è¿‡å¤šï¼Œè¿™é‡Œè®¾å®šäº†æ¯æ¬¡å¤„ç†çš„ä¸šåŠ¡æ•°é‡ä¸º30ï¼Œå½“ç„¶è¿™äº›éƒ½æ˜¯å¯ä»¥è°ƒæ•´çš„ã€‚

<br/>

çœŸæ­£å¤„ç†ä¸šåŠ¡çš„é€»è¾‘å°è£…åˆ°äº†`ILikedRecordService`ä¸­ï¼š

```Java
public interface ILikedRecordService extends IService<LikedRecord> {
   // ... ç•¥

    void readLikedTimesAndSendMessage(String bizType, int maxBizSize);
}
```

å…¶å®ç°ç±»ï¼š

```Java
@Override
public void readLikedTimesAndSendMessage(String bizType, int maxBizSize) {
    // 1.è¯»å–å¹¶ç§»é™¤Redisä¸­ç¼“å­˜çš„ç‚¹èµæ€»æ•°
    String key = RedisConstants.LIKES_TIMES_KEY_PREFIX + bizType;
    Set<ZSetOperations.TypedTuple<String>> tuples = redisTemplate.opsForZSet().popMin(key, maxBizSize);
    if (CollUtils.isEmpty(tuples)) {
        return;
    }
    // 2.æ•°æ®è½¬æ¢
    List<LikedTimesDTO> list = new ArrayList<>(tuples.size());
    for (ZSetOperations.TypedTuple<String> tuple : tuples) {
        String bizId = tuple.getValue();
        Double likedTimes = tuple.getScore();
        if (bizId == null || likedTimes == null) {
            continue;
        }
        list.add(LikedTimesDTO.of(Long.valueOf(bizId), likedTimes.intValue()));
    }
    // 3.å‘é€MQæ¶ˆæ¯
    mqHelper.send(
            LIKE_RECORD_EXCHANGE,
            StringUtils.format(LIKED_TIMES_KEY_TEMPLATE, bizType),
            list);
}
```

<br/>

##### ç›‘å¬ç‚¹èµæ•°å˜æ›´

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç”±äºåœ¨å®šæ—¶ä»»åŠ¡ä¸­ä¸€æ¬¡æœ€å¤šå¤„ç†20æ¡æ•°æ®ï¼Œè¿™äº›æ•°æ®å°±éœ€è¦é€šè¿‡MQä¸€æ¬¡å‘é€åˆ°ä¸šåŠ¡æ–¹ï¼Œä¹Ÿå°±æ˜¯è¯´MQçš„æ¶ˆæ¯ä½“å˜æˆäº†ä¸€ä¸ªé›†åˆï¼š

![img](assets/20240214150606213.jpg)

<br/>

å› æ­¤ï¼Œä½œä¸ºä¸šåŠ¡æ–¹ï¼Œåœ¨ç›‘å¬MQæ¶ˆæ¯çš„æ—¶å€™ä¹Ÿå¿…é¡»æ¥æ”¶é›†åˆæ ¼å¼ã€‚

æˆ‘ä»¬ä¿®æ”¹`tj-learning`ä¸­çš„ç±»`com.tianji.learning.mq.LikeTimesChangeListener`ï¼š

```Java
package com.tianji.learning.mq;

import com.tianji.api.dto.remark.LikedTimesDTO;
import com.tianji.learning.domain.po.InteractionReply;
import com.tianji.learning.service.IInteractionReplyService;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.amqp.core.ExchangeTypes;
import org.springframework.amqp.rabbit.annotation.Exchange;
import org.springframework.amqp.rabbit.annotation.Queue;
import org.springframework.amqp.rabbit.annotation.QueueBinding;
import org.springframework.amqp.rabbit.annotation.RabbitListener;
import org.springframework.stereotype.Component;

import java.util.ArrayList;
import java.util.List;

import static com.tianji.common.constants.MqConstants.Exchange.LIKE_RECORD_EXCHANGE;
import static com.tianji.common.constants.MqConstants.Key.QA_LIKED_TIMES_KEY;

@Slf4j
@Component
@RequiredArgsConstructor
public class LikeTimesChangeListener {

    private final IInteractionReplyService replyService;

    @RabbitListener(bindings = @QueueBinding(
            value = @Queue(name = "qa.liked.times.queue", durable = "true"),
            exchange = @Exchange(name = LIKE_RECORD_EXCHANGE, type = ExchangeTypes.TOPIC),
            key = QA_LIKED_TIMES_KEY
    ))
    public void listenReplyLikedTimesChange(List<LikedTimesDTO> likedTimesDTOs){
        log.debug("ç›‘å¬åˆ°å›ç­”æˆ–è¯„è®ºçš„ç‚¹èµæ•°å˜æ›´");

        List<InteractionReply> list = new ArrayList<>(likedTimesDTOs.size());
        for (LikedTimesDTO dto : likedTimesDTOs) {
            InteractionReply r = new InteractionReply();
            r.setId(dto.getBizId());
            r.setLikedTimes(dto.getLikedTimes());
            list.add(r);
        }
        replyService.updateBatchById(list);
    }
}
```

### ç»ƒä¹ 

#### å®Œå–„äº’åŠ¨é—®ç­”åŠŸèƒ½

åœ¨äº’åŠ¨é—®ç­”åŠŸèƒ½ä¸­ï¼Œæœ‰ä¸€äº›ä¸ç‚¹èµæœ‰å…³çš„ä¹‹å‰æš‚æœªå®ç°ï¼Œè¯·è¡¥å……å®Œæ•´



#### ç‚¹èµä¸šåŠ¡ç±»å‹çš„åŠ¨æ€é…ç½®

ç›®å‰ï¼Œç‚¹èµä¸šåŠ¡ç±»å‹æ˜¯å†™æ­»åœ¨ä»£ç ä¸­çš„ã€‚å°†å…¶å®šä¹‰åˆ°é…ç½®æ–‡ä»¶ï¼Œäº¤ç»™nacosç®¡ç†ï¼Œå®ç°åŠ¨æ€åŠ è½½æ•ˆæœã€‚å¹¶å°†ä¸šåŠ¡ä¸­ä¸ç‚¹èµç±»å‹æœ‰å…³çš„â€œé­”æ³•å€¼â€å»é™¤ï¼Œæ”¹ä¸ºè¯»å–é…ç½®æ–‡ä»¶ä¸­çš„ä¸šåŠ¡ç±»å‹ã€‚



#### ç‚¹èµè®°å½•æŒä¹…åŒ–ï¼ˆéš¾åº¦è¾ƒå¤§ï¼Œé€‰åšï¼‰

æ€è€ƒä¸€ä¸‹ï¼Œå¦‚æœè¦æŠŠç‚¹èµè®°å½•å®šæœŸæŒä¹…åŒ–åˆ°æ•°æ®åº“ï¼ŒæŸ¥è¯¢æ—¶å†åŠ è½½ï¼Œè¯¥å¦‚ä½•å®ç°ï¼Ÿè®²è§£ä¸€ä¸‹ä½ çš„æ€è·¯ã€‚

å¦‚æœæœ‰èƒ½åŠ›çš„è¯è‡ªå·±å°è¯•å®ç°ä¸€ä¸‹ã€‚



#### å®šæ—¶ä»»åŠ¡ï¼ˆéš¾åº¦è¾ƒå¤§ï¼Œé€‰åšï¼‰

ç ”ç©¶ä¸€ä¸‹XXL-JOBè¿™ä¸ªå®šæ—¶ä»»åŠ¡æ¡†æ¶ï¼Œå°è¯•åˆ©ç”¨å®ƒæ¥ä»£æ›¿SpringTaskã€‚



### æ€»ç»“

:::warning ğŸ’¡æ€è€ƒï¼šçœ‹ä½ é¡¹ç›®ä¸­ä»‹ç»ï¼Œä½ è´Ÿè´£ç‚¹èµåŠŸèƒ½çš„è®¾è®¡å’Œå¼€å‘ï¼Œé‚£ä½ èƒ½ä¸èƒ½è®²è®²ä½ ä»¬çš„ç‚¹èµç³»ç»Ÿæ˜¯å¦‚ä½•è®¾è®¡çš„ï¼Ÿ

é¦–å…ˆåœ¨è®¾è®¡ä¹‹åˆæˆ‘ä»¬åˆ†æäº†ä¸€ä¸‹ç‚¹èµä¸šåŠ¡å¯èƒ½éœ€è¦çš„ä¸€äº›è¦æ±‚ã€‚

ä¾‹å¦‚ï¼Œåœ¨æˆ‘ä»¬é¡¹ç›®ä¸­éœ€è¦ç”¨åˆ°ç‚¹èµçš„ä¸šåŠ¡ä¸æ­¢ä¸€ä¸ªï¼Œå› æ­¤ç‚¹èµç³»ç»Ÿå¿…é¡»å…·å¤‡é€šç”¨æ€§ï¼Œç‹¬ç«‹æ€§ï¼Œä¸èƒ½è·Ÿå…·ä½“ä¸šåŠ¡è€¦åˆã€‚

å†æ¯”å¦‚ï¼Œç‚¹èµä¸šåŠ¡å¯èƒ½ä¼šæœ‰è¾ƒé«˜çš„å¹¶å‘ï¼Œæˆ‘ä»¬è¦è€ƒè™‘åˆ°é«˜å¹¶å‘å†™åº“çš„å‹åŠ›é—®é¢˜ã€‚

æ‰€ä»¥å‘¢ï¼Œæˆ‘ä»¬åœ¨è®¾è®¡çš„æ—¶å€™ï¼Œå°±å°†ç‚¹èµåŠŸèƒ½æŠ½ç¦»å‡ºæ¥ä½œä¸ºç‹¬ç«‹æœåŠ¡ã€‚å½“ç„¶è¿™ä¸ªæœåŠ¡ä¸­é™¤äº†ç‚¹èµåŠŸèƒ½ä»¥å¤–ï¼Œè¿˜æœ‰ä¸ä¹‹å…³è”çš„è¯„ä»·åŠŸèƒ½ï¼Œä¸è¿‡è¿™éƒ¨åˆ†æˆ‘å°±æ²¡æœ‰å‚ä¸äº†ã€‚åœ¨æ•°æ®å±‚é¢ä¹Ÿä¼šç”¨ä¸šåŠ¡ç±»å‹å¯¹ä¸åŒç‚¹èµæ•°æ®åšéš”ç¦»ã€‚

ä»å…·ä½“å®ç°ä¸Šæ¥è¯´ï¼Œä¸ºäº†å‡å°‘æ•°æ®åº“å‹åŠ›ï¼Œæˆ‘ä»¬ä¼šåˆ©ç”¨Redisæ¥ä¿å­˜ç‚¹èµè®°å½•ã€ç‚¹èµæ•°é‡ä¿¡æ¯ã€‚ç„¶ååˆ©ç”¨å®šæ—¶ä»»åŠ¡å®šæœŸçš„å°†ç‚¹èµæ•°é‡åŒæ­¥ç»™ä¸šåŠ¡æ–¹ï¼ŒæŒä¹…åŒ–åˆ°æ•°æ®åº“ä¸­ã€‚

æ³¨æ„äº‹é¡¹ï¼šå›ç­”æ—¶è¦å…ˆè¯´è‡ªå·±çš„æ€è€ƒè¿‡ç¨‹ï¼Œå†è¯´å…·ä½“è®¾è®¡ï¼Œå½°æ˜¾ä½ çš„é€»è¾‘æ¸…æ™°ã€‚è®¾è®¡çš„æ—¶å€™å…ˆä¸è¯´ç»†èŠ‚ï¼Œåªè¯´å¤§æ¦‚ï¼Œåœé¡¿ä¸€ä¸‹ï¼Œå¸å¼•é¢è¯•å®˜å»è¿½é—®ç»†èŠ‚ã€‚å¦‚æœé¢è¯•å®˜ä¸è¿½é—®ï¼Œåœé¡¿ä¸€ä¸‹åï¼Œè‡ªå·±æ¥ç€è¯´ä¸‹é¢çš„

<br/>

ğŸ’¡**æ€è€ƒï¼šé‚£ä½ ä»¬Redisä¸­å…·ä½“ä½¿ç”¨äº†å“ªç§æ•°æ®ç»“æ„å‘¢ï¼Ÿ**

ç­”ï¼šæˆ‘ä»¬ä½¿ç”¨äº†ä¸¤ç§æ•°æ®ç»“æ„ï¼Œsetå’Œzset

é¦–å…ˆä¿å­˜ç‚¹èµè®°å½•ï¼Œä½¿ç”¨äº†setç»“æ„ï¼Œkeyæ˜¯ä¸šåŠ¡ç±»å‹+ä¸šåŠ¡idï¼Œå€¼æ˜¯ç‚¹èµè¿‡çš„ç”¨æˆ·idã€‚å½“ç”¨æˆ·ç‚¹èµæ—¶å°±`SADD`ç”¨æˆ·idè¿›å»ï¼Œå½“ç”¨æˆ·å–æ¶ˆç‚¹èµæ—¶å°±`SREM`åˆ é™¤ç”¨æˆ·idã€‚å½“åˆ¤æ–­æ˜¯å¦ç‚¹èµæ—¶ä½¿ç”¨`SISMEMBER`å³å¯ã€‚å½“è¦ç»Ÿè®¡ç‚¹èµæ•°é‡æ—¶ï¼Œåªéœ€è¦`SCARD`å°±è¡Œï¼Œ**è€ŒRedisçš„SETç»“æ„ä¼šåœ¨å¤´ä¿¡æ¯ä¸­ä¿å­˜å…ƒç´ æ•°é‡ï¼Œå› æ­¤SCARDç›´æ¥è¯»å–è¯¥å€¼ï¼Œæ—¶é—´å¤æ‚åº¦ä¸ºO(1)**ï¼Œæ€§èƒ½éå¸¸å¥½ã€‚

ä¸è¿‡è¿™é‡Œå­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯é¡µé¢éœ€è¦åˆ¤æ–­å½“å‰ç”¨æˆ·æœ‰æ²¡æœ‰å¯¹æŸäº›ä¸šåŠ¡ç‚¹èµã€‚è¿™ä¸ªæ—¶å€™ä¼šä¼ æ¥å¤šä¸ªä¸šåŠ¡idçš„é›†åˆï¼Œè€ŒSISMEMBERåªèƒ½ä¸€æ¬¡åˆ¤æ–­ä¸€ä¸ªä¸šåŠ¡çš„ç‚¹èµçŠ¶æ€ï¼Œè¦åˆ¤æ–­å¤šä¸ªä¸šåŠ¡çš„ç‚¹èµçŠ¶æ€ï¼Œå°±å¿…é¡»å¤šæ¬¡è°ƒç”¨SISMEMBERå‘½ä»¤ï¼Œä¸Rediså¤šæ¬¡äº¤äº’ï¼Œè¿™æ˜¾ç„¶æ˜¯ä¸åˆé€‚çš„ã€‚ï¼ˆæ­¤å¤„ç•¥åœé¡¿ï¼Œç­‰å¾…é¢è¯•å®˜è¿½é—®ï¼Œé¢è¯•å®˜å¯èƒ½ä¼šé—®â€œé‚£ä½ ä»¬æ€ä¹ˆè§£å†³çš„â€ã€‚å¦‚æœæ²¡è¿½é—®ï¼Œè‡ªå·±æ¥ç€è¯´ï¼‰ï¼Œæ‰€ä»¥å‘¢æˆ‘ä»¬å°±é‡‡ç”¨äº†Pipelineç®¡é“æ–¹å¼ï¼Œè¿™æ ·å°±å¯ä»¥ä¸€æ¬¡è¯·æ±‚å®ç°å¤šä¸ªä¸šåŠ¡ç‚¹èµçŠ¶æ€çš„åˆ¤æ–­äº†ã€‚

<br/>

ğŸ’¡æ€è€ƒï¼š**é‚£ä½ ZSETå¹²ä»€ä¹ˆç”¨çš„ï¼Ÿ**

ç­”ï¼šä¸¥æ ¼æ¥è¯´ZSETå¹¶ä¸æ˜¯ç”¨æ¥å®ç°ç‚¹èµä¸šåŠ¡çš„ï¼Œå› ä¸ºç‚¹èµåªé SETå°±èƒ½å®ç°äº†ã€‚ä½†æ˜¯è¿™é‡Œæœ‰ä¸€ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬è¦å®šæœŸå°†ä¸šåŠ¡æ–¹çš„ç‚¹èµæ€»æ•°é€šè¿‡MQåŒæ­¥ç»™ä¸šåŠ¡æ–¹ï¼Œå¹¶æŒä¹…åŒ–åˆ°æ•°æ®åº“ã€‚ä½†æ˜¯å¦‚æœåªæœ‰SETï¼Œæˆ‘æ²¡åŠæ³•çŸ¥é“å“ªäº›ä¸šåŠ¡çš„ç‚¹èµæ•°å‘ç”Ÿäº†å˜åŒ–ï¼Œéœ€è¦åŒæ­¥åˆ°ä¸šåŠ¡æ–¹ã€‚

å› æ­¤ï¼Œæˆ‘ä»¬åˆæ·»åŠ äº†ä¸€ä¸ªZSETç»“æ„ï¼Œç”¨æ¥è®°å½•ç‚¹èµæ•°å˜åŒ–çš„ä¸šåŠ¡åŠå¯¹åº”çš„ç‚¹èµæ€»æ•°ã€‚å¯ä»¥ç†è§£ä¸ºä¸€ä¸ªå¾…æŒä¹…åŒ–çš„ç‚¹èµä»»åŠ¡é˜Ÿåˆ—ã€‚

æ¯å½“ä¸šåŠ¡è¢«ç‚¹èµï¼Œé™¤äº†è¦ç¼“å­˜ç‚¹èµè®°å½•ï¼Œè¿˜è¦æŠŠä¸šåŠ¡idåŠç‚¹èµæ€»æ•°å†™å…¥ZSETã€‚è¿™æ ·å®šæ—¶ä»»åŠ¡å¼€å¯æ—¶ï¼Œåªéœ€è¦ä»ZSETä¸­è·å–å¹¶ç§»é™¤æ•°æ®ï¼Œç„¶åå‘é€MQç»™ä¸šåŠ¡æ–¹ï¼Œå¹¶æŒä¹…åŒ–åˆ°æ•°æ®åº“å³å¯ã€‚

<br/>

 ğŸ’¡**æ€è€ƒï¼šé‚£ä¸ºä»€ä¹ˆä¸€å®šè¦ç”¨ZSETç»“æ„ï¼ŒæŠŠæ›´æ–°è¿‡çš„ä¸šåŠ¡æ‰”åˆ°ä¸€ä¸ªListä¸­ä¸è¡Œå—ï¼Ÿ**

ç­”ï¼šæ‰”åˆ°Listç»“æ„ä¸­è™½ç„¶ä¹Ÿèƒ½å®ç°ï¼Œä½†æ˜¯å­˜åœ¨ä¸€äº›é—®é¢˜ï¼š

é¦–å…ˆï¼Œå‡è®¾å®šæ—¶ä»»åŠ¡æ¯éš”2åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡ï¼Œä¸€ä¸ªä¸šåŠ¡å¦‚æœåœ¨2åˆ†é’Ÿå†…å¤šæ¬¡è¢«ç‚¹èµï¼Œé‚£å°±ä¼šå¤šæ¬¡å‘Listä¸­æ·»åŠ åŒä¸€ä¸ªä¸šåŠ¡åŠå¯¹åº”çš„ç‚¹èµæ€»æ•°ï¼Œæ•°æ®åº“ä¹Ÿè¦æŒä¹…åŒ–å¤šæ¬¡ã€‚è¿™æ˜¾ç„¶æ˜¯å¤šä½™çš„ï¼Œå› ä¸ºåªæœ‰æœ€åä¸€æ¬¡æ‰æ˜¯æœ‰æ•ˆçš„ã€‚è€Œä½¿ç”¨ZSETåˆ™å› ä¸ºmemberçš„å”¯ä¸€æ€§ï¼Œå¤šæ¬¡æ·»åŠ ä¼šè¦†ç›–æ—§çš„ç‚¹èµæ•°é‡ï¼Œæœ€ç»ˆä¹Ÿåªä¼šæŒä¹…åŒ–ä¸€æ¬¡ã€‚

å½“ç„¶è¦è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œä¹Ÿå¯ä»¥ç”¨SETç»“æ„ä»£æ›¿Listï¼Œç„¶åå½“ä¸šåŠ¡è¢«ç‚¹èµæ—¶ï¼Œåªå­˜ä¸šåŠ¡idåˆ°SETå¹¶é€šçŸ¥ä¸šåŠ¡æ–¹ã€‚ä¸šåŠ¡æ–¹æ¥æ”¶åˆ°MQé€šçŸ¥åï¼Œæ ¹æ®idå†æ¬¡æŸ¥è¯¢ç‚¹èµæ€»æ•°ä»è€Œé¿å…å¤šæ¬¡æ›´æ–°çš„é—®é¢˜ã€‚ä½†æ˜¯è¿™ç§åšæ³•ä¼šå¯¼è‡´å¤šæ¬¡ç½‘ç»œé€šä¿¡ï¼Œå¢åŠ ç³»ç»Ÿç½‘ç»œè´Ÿæ‹…ã€‚è€ŒZSETåˆ™å¯ä»¥åŒæ—¶ä¿å­˜ä¸šåŠ¡idåŠæœ€æ–°ç‚¹èµæ•°é‡ï¼Œé¿å…å¤šæ¬¡ç½‘ç»œæŸ¥è¯¢ã€‚

ä¸è¿‡ï¼Œå¹¶ä¸æ˜¯è¯´ZSETæ–¹æ¡ˆå°±æ˜¯å®Œå…¨æ²¡é—®é¢˜çš„ï¼Œ**æ¯•ç«ŸZSETåº•å±‚æ˜¯å“ˆå¸Œç»“æ„+è·³è¡¨**ï¼Œå¯¹å†…å­˜ä¼šæœ‰é¢å¤–çš„å ç”¨ã€‚ä½†æ˜¯è€ƒè™‘åˆ°æˆ‘ä»¬çš„å®šæ—¶ä»»åŠ¡æ¯æ¬¡ä¼šæŸ¥è¯¢å¹¶åˆ é™¤ZSETæ•°æ®ï¼ŒZSETä¸­çš„æ•°æ®é‡å§‹ç»ˆä¼šç»´æŒåœ¨ä¸€ä¸ªè¾ƒä½çº§åˆ«ï¼Œå†…å­˜å ç”¨ä¹Ÿæ˜¯å¯ä»¥æ¥å—çš„ã€‚

æ³¨æ„ï¼šåŠ é»‘çš„åœ°æ–¹ä¸€å®šè¦è¯´ï¼Œå½°æ˜¾ä½ å¯¹Redisåº•å±‚æ•°æ®ç»“æ„å’Œç®—æ³•æœ‰æ·±å…¥äº†è§£ã€‚

:::

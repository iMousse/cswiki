Day08-æ’è¡Œæ¦œåŠŸèƒ½
================

åœ¨æ˜¨å¤©çš„å­¦ä¹ ä¸­ï¼Œæˆ‘ä»¬å®ç°äº†ç§¯åˆ†åŠŸèƒ½ï¼Œå¹¶ä¸”ä¹Ÿå°†ç”¨æˆ·çš„ç§¯åˆ†æ˜ç»†ä¿å­˜åˆ°äº†æ•°æ®åº“ã€‚ä½†æ˜¯å¹¶æ²¡æœ‰å½¢æˆæ’è¡Œæ¦œã€‚

é‚£ä¹ˆæ’è¡Œæ¦œè¯¥å¦‚ä½•å®ç°å‘¢ï¼Ÿ

æ˜¯ä¸æ˜¯ç®€å•çš„SQLæŸ¥è¯¢å°±å¯ä»¥å½¢æˆæ¦œå•å‘¢ï¼Ÿ

ä»Šå¤©æˆ‘ä»¬å°±ä¸€èµ·æ¥åˆ†æä¸€ä¸‹ã€‚

## å®æ—¶æ’è¡Œæ¦œ

æ¦œå•åˆ†ä¸ºä¸¤ç±»ï¼š

- å®æ—¶æ¦œå•ï¼šä¹Ÿå°±æ˜¯æœ¬èµ›å­£çš„æ¦œå•
- å†å²æ¦œå•ï¼šä¹Ÿå°±æ˜¯å†å²èµ›å­£çš„æ¦œå•

æœ¬èŠ‚æˆ‘ä»¬å…ˆåˆ†æä¸€ä¸‹å®ç°å®æ—¶æ¦œå•åŠŸèƒ½ã€‚

ğŸ’¡æ€è€ƒï¼š

### æ€è·¯åˆ†æ

ç›®å‰ï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ªç§¯åˆ†è®°å½•æ˜ç»†è¡¨ï¼Œç»“æ„å¦‚ä¸‹ï¼š

![img](./assets/20230725154301601.jpg)

ä¸€ä¸ªç”¨æˆ·å¯èƒ½äº§ç”Ÿå¾ˆå¤šæ¡ç§¯åˆ†è®°å½•ï¼Œæ•°æ®ç»“æ„å¤§æ¦‚åƒè¿™æ ·ï¼š

| **id** | **userId** | **type** | **points** | **c_time** |
| :----: | :--------: | :------: | :--------: | :--------: |
|   1    |    9527    |    1     |     10     |            |
|   2    |    9528    |    4     |     3      |            |
|   3    |    9529    |    2     |     1      |            |
|   4    |    9528    |    2     |     7      |            |
|   5    |    9529    |    4     |     3      |            |
|   6    |    9528    |    2     |     1      |            |
|   7    |    9527    |    1     |     10     |            |
|   8    |    9529    |    4     |     3      |            |
|   9    |    9527    |    3     |     5      |            |

è¦æƒ³å½¢æˆæ’è¡Œæ¦œï¼Œæˆ‘ä»¬åœ¨æŸ¥è¯¢æ•°æ®åº“æ—¶ï¼Œéœ€è¦å…ˆå¯¹ç”¨æˆ·åˆ†ç»„ï¼Œå†å¯¹ç§¯åˆ†æ±‚å’Œï¼Œæœ€ç»ˆæŒ‰ç…§ç§¯åˆ†å’Œæ’åºï¼ŒSqlè¯­å¥æ˜¯è¿™æ ·ï¼š

```SQL
SELECT user_id, SUM(points) 
FROM points_record 
GROUP BY user_id ORDER BY SUM(points)
```

è¦çŸ¥é“ï¼Œæ¯ä¸ªç”¨æˆ·éƒ½å¯èƒ½ä¼šæœ‰æ•°åç”šè‡³ä¸Šç™¾æ¡ç§¯åˆ†è®°å½•ï¼Œå½“ç”¨æˆ·è§„æ¨¡è¾¾åˆ°ç™¾ä¸‡è§„æ¨¡ï¼Œå¯èƒ½äº§ç”Ÿçš„ç§¯åˆ†è®°å½•å°±æ˜¯æ•°ä»¥**äº¿**è®¡ã€‚

è¦åœ¨æ¯æ¬¡æŸ¥è¯¢æ’è¡Œæ¦œæ—¶ï¼Œåœ¨å†…å­˜ä¸­å¯¹è¿™ä¹ˆå¤šæ•°æ®åšåˆ†ç»„ã€æ±‚å’Œã€æ’åºï¼Œå¯¹å†…å­˜å’ŒCPUçš„å ç”¨ä¼šéå¸¸ææ€–ï¼Œä¸å¤ªé è°±ã€‚

é‚£è¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿ

<br/>

åœ¨è¿™é‡Œç»™å¤§å®¶ä»‹ç»ä¸¤ç§ä¸åŒçš„å®ç°æ€è·¯ï¼š

- æ–¹æ¡ˆä¸€ï¼šåŸºäºMySQLçš„ç¦»çº¿æ’åº
- æ–¹æ¡ˆäºŒï¼šåŸºäºRedisçš„SortedSet

<br/>

é¦–å…ˆè¯´æ–¹æ¡ˆä¸€ï¼šç®€å•æ¥è¯´ï¼Œå°±æ˜¯å°†æ•°æ®åº“ä¸­çš„æ•°æ®æŸ¥è¯¢å‡ºæ¥ï¼Œåœ¨å†…å­˜ä¸­è‡ªå·±åˆ©ç”¨ç®—æ³•å®ç°æ’åºï¼Œè€Œåå°†æ’åºå¾—åˆ°çš„æ¦œå•ä¿å­˜åˆ°æ•°æ®åº“ä¸­ã€‚ä½†ç”±äºè¿™ä¸ªæ’åºæ¯”è¾ƒå¤æ‚ï¼Œæˆ‘ä»¬æ— æ³•å®æ—¶æ›´æ–°æ’è¡Œæ¦œï¼Œè€Œæ˜¯æ¯éš”å‡ åˆ†é’Ÿè®¡ç®—ä¸€æ¬¡æ’è¡Œæ¦œã€‚è¿™ç§æ–¹æ¡ˆå®ç°èµ·æ¥æ¯”è¾ƒå¤æ‚ï¼Œè€Œä¸”å®æ—¶æ€§è¾ƒå·®ã€‚ä¸è¿‡ä¼˜ç‚¹æ˜¯ä¸ä¼šä¸€ç›´å ç”¨ç³»ç»Ÿèµ„æºã€‚

<br/>

å†è¯´æ–¹æ¡ˆäºŒï¼šRedisçš„SortedSetåº•å±‚é‡‡ç”¨äº†è·³è¡¨çš„æ•°æ®ç»“æ„ï¼Œå› æ­¤å¯ä»¥éå¸¸é«˜æ•ˆçš„å®ç°æ’åºåŠŸèƒ½ï¼Œç™¾ä¸‡ç”¨æˆ·æ’åºè½»æ¾æå®šã€‚è€Œä¸”æ¯å½“ç”¨æˆ·ç§¯åˆ†å‘ç”Ÿå˜æ›´æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥å®æ—¶æ›´æ–°Redisä¸­çš„ç”¨æˆ·ç§¯åˆ†ï¼Œè€ŒSortedSetä¹Ÿä¼šå®æ—¶æ›´æ–°æ’åã€‚å®ç°èµ·æ¥ç®€å•ã€é«˜æ•ˆï¼Œå®æ—¶æ€§ä¹Ÿéå¸¸å¥½ã€‚ç¼ºç‚¹å°±æ˜¯éœ€è¦ä¸€ç›´å ç”¨Redisçš„å†…å­˜ï¼Œå½“ç”¨æˆ·é‡è¾¾åˆ°æ•°åƒä¸‡ä¸‡æ—¶ï¼Œæ€§èƒ½æœ‰ä¸€å®šçš„ä¸‹é™ã€‚

å½“ç³»ç»Ÿç”¨æˆ·é‡è§„æ¨¡è¾¾åˆ°æ•°åƒä¸‡ï¼Œä¹ƒè‡³æ•°äº¿æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥é‡‡ç”¨åˆ†æ²»çš„æ€æƒ³ï¼Œå°†ç”¨æˆ·æ•°æ®æŒ‰ç…§ç§¯åˆ†èŒƒå›´åˆ’åˆ†ä¸ºå¤šä¸ªæ¡¶ï¼Œä¾‹å¦‚ï¼š

0 ~ 100åˆ†ã€101 ~ 200åˆ†ã€201 ~ 300åˆ†ã€301 ~ 500åˆ†ã€501 ~ 800åˆ†ã€801 ~ 1200åˆ†ã€1201 ~ 1500åˆ†ã€1501 ~ 2000åˆ†

åœ¨Rediså†…ä¸ºæ¯ä¸ªæ¡¶åˆ›å»ºä¸€ä¸ªSortedSetç±»å‹çš„keyï¼Œè¿™æ ·å°±å¯ä»¥å°†æ•°æ®åˆ†æ•£ï¼Œå‡å°‘å•ä¸ªKEYçš„æ•°æ®è§„æ¨¡äº†ã€‚è€Œè¦è®¡ç®—æ’åæ—¶ï¼Œåªéœ€è¦æŒ‰ç…§èŒƒå›´æŸ¥è¯¢å‡ºç”¨æˆ·ç§¯åˆ†æ‰€åœ¨çš„æ¡¶ï¼Œå†ç´¯åŠ åˆ†å€¼æ¯”ä»–é«˜çš„æ¡¶çš„ç”¨æˆ·æ•°é‡å³å¯ã€‚ä¾ç„¶éå¸¸ç®€å•ã€é«˜æ•ˆã€‚

<br/>

ç»¼ä¸Šï¼Œæˆ‘ä»¬æ¨èåŸºäºRedisçš„SortedSetæ¥å®ç°æ’è¡Œæ¦œåŠŸèƒ½ã€‚

SortedSetçš„å¸¸ç”¨å‘½ä»¤ï¼Œå¯ä»¥å‚è€ƒå®˜ç½‘ï¼šhttps://redis.io/commands/?group=sorted-set

<br/>

### ç”Ÿæˆå®æ—¶æ¦œå•

æ—¢ç„¶è¦ä½¿ç”¨Redisçš„SortedSetæ¥å®ç°æ’è¡Œæ¦œï¼Œå°±éœ€è¦åœ¨**ç”¨æˆ·æ¯æ¬¡ç§¯åˆ†å˜æ›´æ—¶ï¼Œç´¯åŠ ç§¯åˆ†åˆ°Redisçš„SortedSetä¸­**ã€‚å› æ­¤ï¼Œæˆ‘ä»¬è¦å¯¹ä¹‹å‰çš„æ–°å¢ç§¯åˆ†åŠŸèƒ½åšç®€å•æ”¹é€ ï¼Œå¦‚å›¾ä¸­ç»¿è‰²éƒ¨åˆ†ï¼š

![image-20240214023218815](assets/image-20240214023218815.png)

åœ¨Redisä¸­ï¼Œä½¿ç”¨SortedSetç»“æ„ï¼Œ**ä»¥èµ›å­£çš„æ—¥æœŸä¸ºkeyï¼Œä»¥ç”¨æˆ·idä¸ºmemberï¼Œä»¥ç§¯åˆ†å’Œä¸ºscore. æ¯å½“ç”¨æˆ·æ–°å¢ç§¯åˆ†ï¼Œå°±ç´¯åŠ åˆ°scoreä¸­**ï¼ŒSortedSetæ’åå°±ä¼šå®æ—¶æ›´æ–°ã€‚è¿™æ ·ä¸€ä¸ªå®æ—¶çš„å½“å‰èµ›å­£æ¦œå•å°±å‡ºç°äº†ã€‚

<br/>

#### å®šä¹‰Redisçš„KEYå‰ç¼€

åœ¨`tj-learning`çš„`RedisConstants`ä¸­å®šä¹‰ä¸€ä¸ªæ–°çš„KEYå‰ç¼€ï¼š

![img](./assets/20230725154303923.jpg)

æ³¨æ„ï¼ŒKEYçš„åç¼€æ˜¯æ—¶é—´æˆ³ï¼Œæˆ‘ä»¬æœ€å¥½å®šä¹‰ä¸€ä¸ª`DateTimeFormatter`ï¼Œæ–¹ä¾¿åæœŸä½¿ç”¨ã€‚å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦ä¿®æ”¹`tj-commom`ä¸­çš„`DateUtils`ï¼Œæ·»åŠ ä¸€ä¸ª`DateTimeFormatter`çš„å¸¸é‡ï¼š

![img](./assets/20230725154302494.jpg)

<br/>

#### æ›´æ–°ç§¯åˆ†åˆ°Redis

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ”¹é€ tj-learningä¸­çš„`com.tianji.learning.service.impl.PointsRecordServiceImpl`ï¼Œé¦–å…ˆæ³¨å…¥`StringRedisTemplate`ï¼š

![img](./assets/20230725154301670.jpg)

<br/>

ç„¶åï¼Œæ”¹é€ å…¶ä¸­çš„`addPointsRecord`æ–¹æ³•ï¼Œæ·»åŠ ç§¯åˆ†åˆ°Redisä¸­ï¼š

```Java
@Override
public void addPointsRecord(Long userId, int points, PointsRecordType type) {
    LocalDateTime now = LocalDateTime.now();
    int maxPoints = type.getMaxPoints();
    // 1.åˆ¤æ–­å½“å‰æ–¹å¼æœ‰æ²¡æœ‰ç§¯åˆ†ä¸Šé™
    int realPoints = points;
    if(maxPoints > 0) {
        // 2.æœ‰ï¼Œåˆ™éœ€è¦åˆ¤æ–­æ˜¯å¦è¶…è¿‡ä¸Šé™
        LocalDateTime begin = DateUtils.getDayStartTime(now);
        LocalDateTime end = DateUtils.getDayEndTime(now);
        // 2.1.æŸ¥è¯¢ä»Šæ—¥å·²å¾—ç§¯åˆ†
        int currentPoints = queryUserPointsByTypeAndDate(userId, type, begin, end);
        // 2.2.åˆ¤æ–­æ˜¯å¦è¶…è¿‡ä¸Šé™
        if(currentPoints >= maxPoints) {
            // 2.3.è¶…è¿‡ï¼Œç›´æ¥ç»“æŸ
            return;
        }
        // 2.4.æ²¡è¶…è¿‡ï¼Œä¿å­˜ç§¯åˆ†è®°å½•
        if(currentPoints + points > maxPoints){
            realPoints = maxPoints - currentPoints;
        }
    }
    // 3.æ²¡æœ‰ï¼Œç›´æ¥ä¿å­˜ç§¯åˆ†è®°å½•
    PointsRecord p = new PointsRecord();
    p.setPoints(realPoints);
    p.setUserId(userId);
    p.setType(type);
    save(p);
    // 4.æ›´æ–°æ€»ç§¯åˆ†åˆ°Redis
    String key = RedisConstants.POINTS_BOARD_KEY_PREFIX + now.format(DateUtils.POINTS_BOARD_SUFFIX_FORMATTER);
    redisTemplate.opsForZSet().incrementScore(key, userId.toString(), realPoints);
}
```

<br/>

### æŸ¥è¯¢ç§¯åˆ†æ¦œ

 åœ¨ä¸ªäººä¸­å¿ƒï¼Œå­¦ç”Ÿå¯ä»¥æŸ¥çœ‹æŒ‡å®šèµ›å­£ç§¯åˆ†æ’è¡Œæ¦œï¼ˆåªæ˜¾ç¤ºå‰100 ï¼‰ï¼Œè¿˜å¯ä»¥æŸ¥çœ‹è‡ªå·±æ€»ç§¯åˆ†å’Œæ’åã€‚è€Œä¸”æ’è¡Œæ¦œåˆ†ä¸ºæœ¬èµ›å­£æ¦œå•å’Œå†å²èµ›å­£æ¦œå•ã€‚

æˆ‘ä»¬å¯ä»¥åœ¨ä¸€ä¸ªæ¥å£ä¸­åŒæ—¶å®ç°è¿™ä¸¤ç±»æ¦œå•çš„æŸ¥è¯¢ã€‚

<br/>

#### åˆ†æå’Œè®¾è®¡æ¥å£

é¦–å…ˆï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹é¡µé¢åŸå‹ï¼ˆè¿™é‡Œæˆ‘ç»™å‡ºçš„æ˜¯åŸå‹å¯¹åº”çš„è®¾è®¡ç¨¿ï¼Œä¹Ÿå°±æ˜¯æœ€ç»ˆå‰ç«¯è®¾è®¡çš„é¡µé¢æ•ˆæœï¼‰ï¼š

![img](./assets/20230725154302362.jpg)

é¦–å…ˆæˆ‘ä»¬åˆ†æä¸€ä¸‹è¯·æ±‚å‚æ•°ï¼š

- æ¦œå•æ•°æ®éå¸¸å¤šï¼Œä¸å¯èƒ½ä¸€æ¬¡æ€§æŸ¥è¯¢å‡ºæ¥ï¼Œå› æ­¤è¿™é‡Œä¸€å®šæ˜¯åˆ†é¡µæŸ¥è¯¢ï¼ˆæ»šåŠ¨åˆ†é¡µï¼‰ï¼Œéœ€è¦åˆ†é¡µå‚æ•°ã€‚
- ç”±äºè¦æŸ¥è¯¢å†å²æ¦œå•éœ€è¦çŸ¥é“èµ›å­£ï¼Œå› æ­¤å‚æ•°ä¸­éœ€è¦æŒ‡å®šèµ›å­£idã€‚å½“èµ›å­£idä¸ºç©ºï¼Œæˆ‘ä»¬è®¤å®šæ˜¯æŸ¥è¯¢å½“å‰èµ›å­£ã€‚è¿™æ ·å°±å¯ä»¥æŠŠä¸¤ä¸ªæ¥å£åˆäºŒä¸ºä¸€ã€‚

ç„¶åæ˜¯è¿”å›å€¼ï¼Œæ— è®ºæ˜¯å†å²æ¦œå•è¿˜æ˜¯å½“å‰æ¦œå•ï¼Œç»“æ„éƒ½ä¸€æ ·ã€‚åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼š

- å½“å‰ç”¨æˆ·çš„ç§¯åˆ†å’Œæ’åã€‚å½“å‰ç”¨æˆ·ä¸ä¸€å®šä¸Šæ¦œï¼Œå› æ­¤éœ€è¦å•ç‹¬æŸ¥è¯¢
- æ¦œå•æ•°æ®ã€‚å°±æ˜¯Nä¸ªç”¨æˆ·çš„ç§¯åˆ†ã€æ’åå½¢æˆçš„é›†åˆã€‚

<br/>

ç»¼ä¸Šï¼Œæ¥å£ä¿¡æ¯å¦‚ä¸‹ï¼š

![image-20240214023326783](assets/image-20240214023326783.png)
<br/>

#### å®ä½“ç±»

æŸ¥è¯¢ç§¯åˆ†æ’è¡Œæ¦œæ¥å£ä¸­åŒ…æ‹¬3ä¸ªå®ä½“ï¼š

- æŸ¥è¯¢æ¡ä»¶QUERYå®ä½“
- åˆ†é¡µè¿”å›ç»“æœVOå®ä½“
- åˆ†é¡µä¸­æ¯ä¸€æ¡æ•°æ®çš„VOå®ä½“

è¿™äº›åœ¨è¯¾å‰èµ„æ–™ä¸­éƒ½æä¾›å¥½äº†ã€‚

é¦–å…ˆæ˜¯QUERYå®ä½“ï¼š

![img](./assets/20230725154301894.jpg)

ç„¶åæ˜¯åˆ†é¡µVOå®ä½“ã€åˆ†é¡µæ¡ç›®VOå®ä½“ï¼š

![img](./assets/20230725154301753.jpg)

<br/>

#### å®ç°æ¥å£

é¦–å…ˆï¼Œåœ¨`tj-learning`çš„`com.tianji.learning.controller.PointsBoardController`ä¸­å®šä¹‰æ¥å£ï¼š

```Java
package com.tianji.learning.controller;

import com.tianji.common.utils.BeanUtils;
import com.tianji.common.utils.CollUtils;
import com.tianji.learning.domain.po.PointsBoardSeason;
import com.tianji.learning.domain.query.PointsBoardQuery;
import com.tianji.learning.domain.vo.PointsBoardVO;
import com.tianji.learning.service.IPointsBoardService;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import lombok.RequiredArgsConstructor;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

import java.time.LocalDateTime;
import java.util.List;

/**
 * <p>
 * å­¦éœ¸å¤©æ¢¯æ¦œ æ§åˆ¶å™¨
 * </p>
 */
@RestController
@RequiredArgsConstructor
@RequestMapping("/boards")
@Api(tags = "ç§¯åˆ†ç›¸å…³æ¥å£")
public class PointsBoardController {

    private final IPointsBoardService pointsBoardService;

    @GetMapping
    @ApiOperation("åˆ†é¡µæŸ¥è¯¢æŒ‡å®šèµ›å­£çš„ç§¯åˆ†æ’è¡Œæ¦œ")
    public PointsBoardVO queryPointsBoardBySeason(PointsBoardQuery query){
        return pointsBoardService.queryPointsBoardBySeason(query);
    }

}
```

<br/>

ç„¶åï¼Œåœ¨`com.tianji.learning.service.IPointsBoardService`ä¸­å®šä¹‰serviceæ–¹æ³•ï¼š

```Java
package com.tianji.learning.service;

import com.baomidou.mybatisplus.extension.service.IService;
import com.tianji.learning.domain.po.PointsBoard;
import com.tianji.learning.domain.query.PointsBoardQuery;
import com.tianji.learning.domain.vo.PointsBoardVO;

import java.util.List;

/**
 * <p>
 * å­¦éœ¸å¤©æ¢¯æ¦œ æœåŠ¡ç±»
 * </p>
 */
public interface IPointsBoardService extends IService<PointsBoard> {
    PointsBoardVO queryPointsBoardBySeason(PointsBoardQuery query);
}
```

<br/>

ç„¶åï¼Œåœ¨`com.tianji.learning.service.impl.PointsBoardServiceImpl`ä¸­å®ç°æ–¹æ³•ï¼š

```Java
package com.tianji.learning.service.impl;

import com.baomidou.mybatisplus.extension.plugins.pagination.Page;
import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.tianji.api.client.user.UserClient;
import com.tianji.api.dto.user.UserDTO;
import com.tianji.common.utils.CollUtils;
import com.tianji.common.utils.DateUtils;
import com.tianji.common.utils.UserContext;
import com.tianji.learning.constants.RedisConstants;
import com.tianji.learning.domain.po.PointsBoard;
import com.tianji.learning.domain.query.PointsBoardQuery;
import com.tianji.learning.domain.vo.PointsBoardItemVO;
import com.tianji.learning.domain.vo.PointsBoardVO;
import com.tianji.learning.mapper.PointsBoardMapper;
import com.tianji.learning.service.IPointsBoardService;
import com.tianji.learning.utils.TableInfoContext;
import lombok.RequiredArgsConstructor;
import org.springframework.data.redis.core.BoundZSetOperations;
import org.springframework.data.redis.core.StringRedisTemplate;
import org.springframework.data.redis.core.ZSetOperations;
import org.springframework.stereotype.Service;

import java.time.LocalDateTime;
import java.util.*;
import java.util.stream.Collectors;

import static com.tianji.learning.constants.LearningConstants.POINTS_BOARD_TABLE_PREFIX;

/**
 * <p>
 * å­¦éœ¸å¤©æ¢¯æ¦œ æœåŠ¡å®ç°ç±»
 * </p>
 *
 * @author è™å“¥
 */
@Service
@RequiredArgsConstructor
public class PointsBoardServiceImpl extends ServiceImpl<PointsBoardMapper, PointsBoard> implements IPointsBoardService {

    private final StringRedisTemplate redisTemplate;

    private final UserClient userClient;

    @Override
    public PointsBoardVO queryPointsBoardBySeason(PointsBoardQuery query) {
        // 1.åˆ¤æ–­æ˜¯å¦æ˜¯æŸ¥è¯¢å½“å‰èµ›å­£
        Long season = query.getSeason();
        boolean isCurrent = season == null || season == 0;
        // 2.è·å–Redisçš„Key
        LocalDateTime now = LocalDateTime.now();
        String key = RedisConstants.POINTS_BOARD_KEY_PREFIX + now.format(DateUtils.POINTS_BOARD_SUFFIX_FORMATTER);
        // 2.æŸ¥è¯¢æˆ‘çš„ç§¯åˆ†å’Œæ’å
        PointsBoard myBoard = isCurrent ?
                queryMyCurrentBoard(key) : // æŸ¥è¯¢å½“å‰æ¦œå•ï¼ˆRedisï¼‰
                queryMyHistoryBoard(season); // æŸ¥è¯¢å†å²æ¦œå•ï¼ˆMySQLï¼‰
        // 3.æŸ¥è¯¢æ¦œå•åˆ—è¡¨
        List<PointsBoard> list = isCurrent ?
                queryCurrentBoardList(key, query.getPageNo(), query.getPageSize()) :
                queryHistoryBoardList(query);
        // 4.å°è£…VO
        PointsBoardVO vo = new PointsBoardVO();
        // 4.1.å¤„ç†æˆ‘çš„ä¿¡æ¯
        if (myBoard != null) {
            vo.setPoints(myBoard.getPoints());
            vo.setRank(myBoard.getRank());
        }
        if (CollUtils.isEmpty(list)) {
            return vo;
        }
        // 4.2.æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯
        Set<Long> uIds = list.stream().map(PointsBoard::getUserId).collect(Collectors.toSet());
        List<UserDTO> users = userClient.queryUserByIds(uIds);
        Map<Long, String> userMap = new HashMap<>(uIds.size());
        if(CollUtils.isNotEmpty(users)) {
            userMap = users.stream().collect(Collectors.toMap(UserDTO::getId, UserDTO::getName));
        }
        // 4.3.è½¬æ¢VO
        List<PointsBoardItemVO> items = new ArrayList<>(list.size());
        for (PointsBoard p : list) {
            PointsBoardItemVO v = new PointsBoardItemVO();
            v.setPoints(p.getPoints());
            v.setRank(p.getRank());
            v.setName(userMap.get(p.getUserId()));
            items.add(v);
        }
        vo.setBoardList(items);
        return vo;
    }

    private List<PointsBoard> queryHistoryBoardList(PointsBoardQuery query) {
        // TODO
        return null;
    }

    public List<PointsBoard> queryCurrentBoardList(String key, Integer pageNo, Integer pageSize) {
        // 1.è®¡ç®—åˆ†é¡µ
        int from = (pageNo - 1) * pageSize;
        // 2.æŸ¥è¯¢
        Set<ZSetOperations.TypedTuple<String>> tuples = redisTemplate.opsForZSet()
                .reverseRangeWithScores(key, from, from + pageSize - 1);
        if (CollUtils.isEmpty(tuples)) {
            return CollUtils.emptyList();
        }
        // 3.å°è£…
        int rank = from + 1;
        List<PointsBoard> list = new ArrayList<>(tuples.size());
        for (ZSetOperations.TypedTuple<String> tuple : tuples) {
            String userId = tuple.getValue();
            Double points = tuple.getScore();
            if (userId == null || points == null) {
                continue;
            }
            PointsBoard p = new PointsBoard();
            p.setUserId(Long.valueOf(userId));
            p.setPoints(points.intValue());
            p.setRank(rank++);
            list.add(p);
        }
        return list;
    }

    private PointsBoard queryMyHistoryBoard(Long season) {
        // TODO
        return null;
    }

    private PointsBoard queryMyCurrentBoard(String key) {
        // 1.ç»‘å®škey
        BoundZSetOperations<String, String> ops = redisTemplate.boundZSetOps(key);
        // 2.è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
        String userId = UserContext.getUser().toString();
        // 3.æŸ¥è¯¢ç§¯åˆ†
        Double points = ops.score(userId);
        // 4.æŸ¥è¯¢æ’å
        Long rank = ops.reverseRank(userId);
        // 5.å°è£…è¿”å›
        PointsBoard p = new PointsBoard();
        p.setPoints(points == null ? 0 : points.intValue());
        p.setRank(rank == null ? 0 : rank.intValue() + 1);
        return p;
    }
}
```



## å†å²æ’è¡Œæ¦œ

åœ¨å¤©æœºå­¦å ‚é¡¹ç›®ä¸­ï¼Œç§¯åˆ†æ’è¡Œæ¦œæ˜¯åˆ†èµ›å­£çš„ï¼Œæ¯ä¸€ä¸ªæœˆæ˜¯ä¸€ä¸ªèµ›å­£ã€‚å› æ­¤æ¯åˆ°æ¯ä¸ªæœˆçš„æœˆåˆï¼Œå°±ä¼šè¿›å…¥ä¸€ä¸ªæ–°çš„èµ›å­£ã€‚æ‰€æœ‰ç”¨æˆ·çš„ç§¯åˆ†åº”è¯¥æ¸…é›¶ï¼Œé‡æ–°ç´¯ç§¯ã€‚

ä½†æ˜¯ï¼Œæˆ‘ä»¬èƒ½æŠŠRedisä¸­çš„æ¦œå•æ•°æ®ç›´æ¥æ¸…ç©ºå—ï¼Ÿæ˜¾ç„¶ä¸è¡Œï¼Redisä¸­çš„æ¦œå•æ•°æ®æ˜¯ä¸Šä¸ªæœˆçš„æ•°æ®ï¼Œå±äºå†å²æ¦œå•äº†ï¼Œç›´æ¥æ¸…ç©ºå°±ä¸¢å¤±äº†ä¸€ä¸ªèµ›å­£çš„æ•°æ®ã€‚

å› æ­¤ï¼Œæˆ‘ä»¬å¿…é¡»å°†Redisä¸­çš„å†å²æ•°æ®æŒä¹…åŒ–åˆ°æ•°æ®åº“ä¸­ï¼Œç„¶åå†æ¸…é›¶ã€‚å¦‚å›¾ï¼š

![image-20240214023844466](assets/image-20240214023844466.png)

ä¸è¿‡ï¼Œè¿™é‡Œå°±æœ‰ä¸€ä¸ªé—®é¢˜éœ€è¦è§£å†³ï¼š

å‡å¦‚æœ‰æ•°ç™¾ä¸‡ç”¨æˆ·ï¼Œè¿™å°±æ„å‘³ç€æ¯ä¸ªèµ›å­£æ¦œå•éƒ½æœ‰æ•°ç™¾ä¸‡æ•°æ®ã€‚éšç€æ—¶é—´æ¨ç§»ï¼Œå†å²èµ›å­£è¶Šæ¥è¶Šå¤šï¼Œå¦‚æœå…¨éƒ¨ä¿å­˜åˆ°ä¸€å¼ è¡¨ä¸­ï¼Œæ•°æ®é‡ä¼šéå¸¸ææ€–ï¼

è¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿ

<br/>

### æµ·é‡æ•°æ®å­˜å‚¨ç­–ç•¥

å¯¹äºæ•°æ®åº“çš„æµ·é‡æ•°æ®å­˜å‚¨ï¼Œæ–¹æ¡ˆæœ‰å¾ˆå¤šï¼Œå¸¸è§çš„æœ‰ï¼š

![img](./assets/20230725154302135.jpg)

<br/>

#### åˆ†åŒº

 è¡¨åˆ†åŒºï¼ˆPartitionï¼‰æ˜¯ä¸€ç§æ•°æ®å­˜å‚¨æ–¹æ¡ˆï¼Œå¯ä»¥è§£å†³å•è¡¨æ•°æ®è¾ƒå¤šçš„é—®é¢˜ã€‚MySQL5.1å¼€å§‹æ”¯æŒè¡¨åˆ†åŒºåŠŸèƒ½ã€‚

<br/>

æ•°æ®åº“çš„è¡¨æœ€ç»ˆè‚¯å®šæ˜¯ä¿å­˜åœ¨ç£ç›˜ä¸­ï¼Œå¯¹äºInoDBå¼•æ“ï¼Œä¸€å¼ è¡¨çš„æ•°æ®åœ¨ç£ç›˜ä¸Šå¯¹åº”ä¸€ä¸ªibdæ–‡ä»¶ã€‚å¦‚å›¾ï¼Œæˆ‘ä»¬çš„ç§¯åˆ†æ¦œå•è¡¨å¯¹åº”çš„æ–‡ä»¶ï¼š

![img](./assets/20230725154302438.jpg)

<br/>

å¦‚æœè¡¨æ•°æ®è¿‡å¤šï¼Œå°±ä¼šå¯¼è‡´æ–‡ä»¶ä½“ç§¯éå¸¸å¤§ã€‚æ–‡ä»¶å°±ä¼šè·¨è¶Šå¤šä¸ªç£ç›˜åˆ†åŒºï¼Œæ•°æ®æ£€ç´¢æ—¶çš„é€Ÿåº¦å°±ä¼šéå¸¸æ…¢ã€‚

<br/>

ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒMySQLåœ¨5.1ç‰ˆæœ¬å¼•å…¥è¡¨åˆ†åŒºåŠŸèƒ½ã€‚ç®€å•æ¥è¯´ï¼Œå°±æ˜¯æŒ‰ç…§æŸç§è§„åˆ™ï¼ŒæŠŠè¡¨æ•°æ®å¯¹åº”çš„ibdæ–‡ä»¶æ‹†åˆ†æˆå¤šä¸ªæ–‡ä»¶æ¥å­˜å‚¨ã€‚ä»ç‰©ç†ä¸Šæ¥çœ‹ï¼Œä¸€å¼ è¡¨çš„æ•°æ®è¢«æ‹†åˆ°å¤šä¸ªè¡¨æ–‡ä»¶å­˜å‚¨äº†ï¼›ä»é€»è¾‘ä¸Šæ¥çœ‹ï¼Œä»–ä»¬å¯¹å¤–è¡¨ç°æ˜¯ä¸€å¼ è¡¨ã€‚

ä¾‹å¦‚ï¼Œæˆ‘ä»¬çš„å†å²æ¦œå•æ•°æ®ï¼Œå¯ä»¥æŒ‰ç…§èµ›å­£åˆ‡åˆ†ï¼š

![img](./assets/20230725154302350.jpg)

æ­¤æ—¶ï¼Œèµ›å­£æ¦œå•è¡¨çš„ç£ç›˜æ–‡ä»¶å°±è¢«åˆ†æˆäº†ä¸¤ä¸ªæ–‡ä»¶ã€‚ä½†é€»è¾‘ä¸Šè¿˜æ˜¯ä¸€å¼ è¡¨ã€‚å¢åˆ æ”¹æŸ¥çš„æ–¹å¼ä¸ä¼šæœ‰ä»€ä¹ˆå˜åŒ–ï¼Œåªä¸è¿‡åº•å±‚MySQLåº•å±‚çš„å¤„ç†ä¸Šä¼šæœ‰å˜æ›´ã€‚ä¾‹å¦‚æ£€ç´¢æ—¶å¯ä»¥åªæ£€ç´¢æŸä¸ªæ–‡ä»¶ï¼Œè€Œä¸æ˜¯å…¨éƒ¨ã€‚

<br/>

è¿™æ ·åšæœ‰å‡ ä¸ªå¥½å¤„ï¼š

- å¯ä»¥å­˜å‚¨æ›´å¤šçš„æ•°æ®ï¼Œçªç ´å•è¡¨ä¸Šé™ã€‚ç”šè‡³å¯ä»¥å­˜å‚¨åˆ°ä¸åŒç£ç›˜ï¼Œçªç ´ç£ç›˜ä¸Šé™
- æŸ¥è¯¢æ—¶å¯ä»¥æ ¹æ®è§„åˆ™åªæ£€ç´¢æŸä¸€ä¸ªæ–‡ä»¶ï¼Œæé«˜æŸ¥è¯¢æ•ˆç‡
- æ•°æ®ç»Ÿè®¡æ—¶ï¼Œå¯ä»¥å¤šæ–‡ä»¶å¹¶è¡Œç»Ÿè®¡ï¼Œæœ€åæ±‡æ€»ç»“æœï¼Œæé«˜ç»Ÿè®¡æ•ˆç‡
- å¯¹äºä¸€äº›å†å²æ•°æ®ï¼Œå¦‚æœä¸éœ€è¦æ—¶ï¼Œå¯ä»¥ç›´æ¥åˆ é™¤åˆ†åŒºæ–‡ä»¶ï¼Œæé«˜åˆ é™¤æ•ˆç‡

<br/>

è¡¨åˆ†åŒºçš„æœ¬è´¨æ˜¯å¯¹æ•°æ®çš„**æ°´å¹³æ‹†åˆ†**ï¼Œè€Œæ‹†åˆ†çš„æ–¹å¼ä¹Ÿæœ‰å¤šç§ï¼Œå¸¸è§çš„æœ‰ï¼š

- Rangeåˆ†åŒºï¼šæŒ‰ç…§æŒ‡å®šå­—æ®µçš„å–å€¼èŒƒå›´åˆ†åŒº
- Liståˆ†åŒºï¼šæŒ‰ç…§æŒ‡å®šå­—æ®µçš„æšä¸¾å€¼åˆ†åŒºï¼Œå¿…é¡»æå‰æŒ‡å®šå¥½æ‰€æœ‰çš„åˆ†åŒºå€¼ï¼Œå¦‚æœæ•°æ®æ‰¾ä¸åˆ°åˆ†åŒºä¼šæŠ¥é”™
- Hashåˆ†åŒºï¼šåŸºäºå­—æ®µåšhashè¿ç®—ååˆ†åŒºï¼Œä¸€èˆ¬åšhashè¿ç®—çš„å­—æ®µéƒ½æ˜¯æ•°å€¼ç±»å‹
- Keyåˆ†åŒºï¼šæ ¹æ®æŒ‡å®šå­—æ®µçš„å€¼åšè¿ç®—çš„ç»“æœåˆ†åŒºï¼Œä¸hashåˆ†åŒºç±»ä¼¼ï¼Œä½†ä¸é™å®šå­—æ®µç±»å‹

<br/>

å¯¹äºèµ›å­£æ¦œå•æ¥è¯´ï¼Œæœ€åˆé€‚çš„åˆ†åŒºæ–¹å¼æ˜¯åŸºäºèµ›å­£å€¼åˆ†åŒºï¼Œæˆ‘ä»¬å¸Œæœ›åŒä¸€ä¸ªèµ›å­£æ”¾åˆ°ä¸€ä¸ªåˆ†åŒºã€‚è¿™å°±åªèƒ½ä½¿ç”¨Liståˆ†åŒºï¼Œè€ŒListåˆ†åŒºå´éœ€è¦æšä¸¾å‡ºæ‰€æœ‰å¯èƒ½çš„åˆ†åŒºå€¼ã€‚ä½†æ˜¯èµ›å­£åˆ†åŒºidæ˜¯æ— é™çš„ï¼Œæ— æ³•å…¨éƒ¨æšä¸¾ï¼Œæ‰€ä»¥å°±éå¸¸å°´å°¬ã€‚

<br/>

MySQLçš„è¡¨åˆ†åŒºè¯¦ç»†ä¿¡æ¯å¯å‚è€ƒä¸‹é¢çš„æ–‡æ¡£ï¼š

https://www.cnblogs.com/wenxuehai/p/15901779.html

<br/>

#### åˆ†è¡¨

**åˆ†è¡¨**æ˜¯ä¸€ç§è¡¨è®¾è®¡æ–¹æ¡ˆï¼Œç”±å¼€å‘è€…åœ¨åˆ›å»ºè¡¨æ—¶æŒ‰ç…§è‡ªå·±çš„ä¸šåŠ¡éœ€æ±‚æ‹†åˆ†è¡¨ã€‚ä¹Ÿå°±æ˜¯è¯´è¿™æ˜¯å¼€å‘è€…è‡ªå·±å¯¹è¡¨çš„å¤„ç†ï¼Œä¸æ•°æ®åº“æ— å…³ã€‚

<br/>

è€Œä¸”ï¼Œä¸€æ—¦åšäº†åˆ†è¡¨ï¼Œæ— è®ºæ˜¯é€»è¾‘ä¸Šï¼Œè¿˜æ˜¯ç‰©ç†ä¸Šï¼Œå°±ä»ä¸€å¼ è¡¨å˜æˆäº†å¤šå¼ è¡¨ï¼å¢åˆ æ”¹æŸ¥çš„æ–¹å¼å°±å‘ç”Ÿäº†å˜åŒ–ï¼Œå¿…é¡»è‡ªå·±è€ƒè™‘è¦å»å“ªå¼ è¡¨åšæ•°æ®å¤„ç†ã€‚

åˆ†åŒºåˆ™åœ¨é€»è¾‘ä¸Šæ˜¯åŒä¸€å¼ è¡¨ï¼Œå¢åˆ æ”¹æŸ¥ä¸ä»¥å‰æ²¡æœ‰åŒºåˆ«ã€‚è¿™å°±æ˜¯åˆ†åŒºå’Œåˆ†è¡¨æœ€å¤§çš„ä¸€ç§åŒºåˆ«ã€‚

<br/>

**æ°´å¹³åˆ†è¡¨**

ä¾‹å¦‚ï¼Œå¯¹äºèµ›å­£æ¦œå•ï¼Œæˆ‘ä»¬å¯ä»¥æŒ‰ç…§èµ›å­£æ‹†åˆ†ä¸ºå¤šå¼ è¡¨ï¼Œ**æ¯ä¸€ä¸ªèµ›å­£ä¸€å¼ æ–°çš„è¡¨**ã€‚å¦‚å›¾ï¼š

![img](./assets/20230725154302639.jpg)

è¿™ç§æ–¹å¼å°±æ˜¯æ°´å¹³åˆ†è¡¨ï¼Œ**è¡¨ç»“æ„ä¸å˜**ï¼Œä»…ä»…æ˜¯æ¯å¼ è¡¨**æ•°æ®ä¸åŒ**ã€‚æŸ¥è¯¢èµ›å­£1ï¼Œå°±æ‰¾ç¬¬ä¸€å¼ è¡¨ã€‚æŸ¥è¯¢èµ›å­£2ï¼Œå°±æ‰¾ç¬¬äºŒå¼ è¡¨ã€‚

ç”±äºåˆ†è¡¨æ˜¯å¼€å‘è€…çš„è¡Œä¸ºï¼Œå› æ­¤æ‹†åˆ†æ–¹å¼æ›´åŠ çµæ´»ã€‚é™¤äº†æ°´å¹³åˆ†è¡¨ï¼Œä¹Ÿå¯ä»¥åš**å‚ç›´åˆ†è¡¨**ã€‚

<br/>

**å‚ç›´åˆ†è¡¨**

ä»€ä¹ˆæ˜¯å‚ç›´åˆ†è¡¨å‘¢ï¼Ÿ

å¦‚æœä¸€å¼ è¡¨çš„å­—æ®µéå¸¸å¤šï¼Œæ¯”å¦‚è¾¾åˆ°30ä¸ªä»¥ä¸Šï¼Œè¿™æ ·çš„è¡¨æˆ‘ä»¬ç§°ä¸º**å®½è¡¨**ã€‚å®½è¡¨ç”±äºå­—æ®µå¤ªå¤šï¼Œå•è¡Œæ•°æ®ä½“ç§¯å°±ä¼šéå¸¸å¤§ï¼Œè™½ç„¶æ•°æ®ä¸å¤šï¼Œä½†å¯èƒ½è¡¨ä½“ç§¯ä¹Ÿä¼šéå¸¸å¤§ï¼ä»è€Œå½±å“æŸ¥è¯¢æ•ˆç‡ã€‚

ä¾‹å¦‚ä¸€ä¸ªç”¨æˆ·ä¿¡æ¯è¡¨ï¼Œé™¤äº†ç”¨æˆ·åŸºæœ¬ä¿¡æ¯ï¼Œè¿˜åŒ…å«å¾ˆå¤šå…¶å®ƒåŠŸèƒ½ä¿¡æ¯ï¼š

![img](./assets/20230725154302631.jpg)

è¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬å°±å¯ä»¥æŠŠå…¶ä¸­çš„ä¸€äº›ä¸å¸¸ç”¨å­—æ®µæ‹†åˆ†å‡ºå»ã€‚ä¸€å¼ è¡¨ä¸­åŒ…å«ç™»å½•å¸¸ç”¨å­—æ®µï¼Œå¦ä¸€å¼ è¡¨åŒ…å«å…¶å®ƒå­—æ®µï¼š

![img](./assets/20230725154302982.jpg)

è¿™ä¸ªæ—¶å€™ä¸€å¼ è¡¨å°±å˜æˆäº†ä¸¤å¼ è¡¨ã€‚è€Œä¸”ä¸¤å¼ è¡¨çš„**ç»“æ„ä¸åŒ**ï¼Œ**æ•°æ®ä¹Ÿä¸åŒ**ã€‚è¿™ç§æŒ‰ç…§å­—æ®µæ‹†åˆ†è¡¨çš„æ–¹å¼ï¼Œç§°ä¸º**å‚ç›´æ‹†åˆ†**ã€‚

<br/>

**ä¼˜ç¼ºç‚¹**

åˆ†è¡¨æ–¹æ¡ˆä¸åˆ†åŒºæ–¹æ¡ˆç›¸æ¯”æœ‰ä¸€äº›ä¼˜ç‚¹ï¼š

- æ‹†åˆ†æ–¹å¼æ›´åŠ çµæ´»
- è€Œä¸”å¯ä»¥è§£å†³å•è¡¨å­—æ®µè¿‡å¤šçš„é—®é¢˜

ä½†æ˜¯ä¹Ÿæœ‰ä¸€äº›ç¡®å®šï¼š

- å¢åˆ æ”¹æŸ¥æ—¶ï¼Œéœ€è¦è‡ªå·±åˆ¤æ–­è®¿é—®å“ªå¼ è¡¨
- å‚ç›´æ‹†åˆ†è¿˜ä¼šå¯¼è‡´äº‹åŠ¡é—®é¢˜åŠæ•°æ®å…³è”é—®é¢˜ï¼šåŸæœ¬ä¸€å¼ è¡¨çš„æ“ä½œï¼Œå˜ä¸ºå¤šå¼ è¡¨æ“ä½œã€‚

<br/>

ä¸è¿‡ï¼Œåœ¨å¼€å‘ä¸­æˆ‘ä»¬å¾ˆå¤šæƒ…å†µä¸‹ä¸šåŠ¡éœ€æ±‚å¤æ‚ï¼Œæ›´çœ‹é‡åˆ†è¡¨çš„çµæ´»æ€§ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å¤§å¤šæ•°æƒ…å†µä¸‹éƒ½ä¼šé€‰æ‹©åˆ†è¡¨æ–¹æ¡ˆã€‚

<br/>

#### åˆ†åº“å’Œé›†ç¾¤

æ— è®ºæ˜¯åˆ†åŒºï¼Œè¿˜æ˜¯åˆ†è¡¨ï¼Œæˆ‘ä»¬åˆšæ‰çš„åˆ†æéƒ½æ˜¯å»ºç«‹åœ¨å•ä¸ªæ•°æ®åº“çš„åŸºç¡€ä¸Šã€‚ä½†æ˜¯å•ä¸ªæ•°æ®åº“ä¹Ÿå­˜åœ¨ä¸€äº›é—®é¢˜ï¼š

- å•ç‚¹æ•…éšœé—®é¢˜ï¼šæ•°æ®åº“å‘ç”Ÿæ•…éšœï¼Œæ•´ä¸ªç³»ç»Ÿå°±ä¼šç˜«ç—ª
- å•åº“çš„æ€§èƒ½ç“¶é¢ˆé—®é¢˜ï¼šå•åº“å—æœåŠ¡å™¨é™åˆ¶ï¼Œå…¶ç½‘ç»œå¸¦å®½ã€CPUã€è¿æ¥æ•°éƒ½æœ‰ç“¶é¢ˆ
- å•åº“çš„å­˜å‚¨ç“¶é¢ˆé—®é¢˜ï¼šå•åº“çš„ç£ç›˜ç©ºé—´æœ‰ä¸Šé™ï¼Œå¦‚æœç£ç›˜è¿‡å¤§ï¼Œæ•°æ®æ£€ç´¢çš„é€Ÿåº¦åˆä¼šå˜æ…¢

<br/>

ç»¼ä¸Šï¼Œåœ¨å¤§å‹ç³»ç»Ÿä¸­ï¼Œæˆ‘ä»¬é™¤äº†è¦åšåˆ†è¡¨ã€è¿˜éœ€è¦å¯¹æ•°æ®åšåˆ†åº“ï¼Œå»ºç«‹ç»¼åˆé›†ç¾¤ã€‚

<br/>

é¦–å…ˆï¼Œåœ¨å¾®æœåŠ¡é¡¹ç›®ä¸­ï¼Œæˆ‘ä»¬ä¼šæŒ‰ç…§é¡¹ç›®æ¨¡å—ï¼Œæ¯ä¸ªå¾®æœåŠ¡ä½¿ç”¨ç‹¬ç«‹çš„æ•°æ®åº“ï¼Œå› æ­¤æ¯ä¸ªåº“çš„è¡¨æ˜¯ä¸åŒçš„ï¼Œè¿™ç§åˆ†åº“æ¨¡å¼æˆä¸º**å‚ç›´åˆ†åº“**ã€‚

è€Œä¸ºäº†ä¿è¯å•èŠ‚ç‚¹çš„é«˜å¯ç”¨æ€§ï¼Œæˆ‘ä»¬ä¼šç»™æ•°æ®åº“å»ºç«‹ä¸»ä»é›†ç¾¤ï¼Œä¸»èŠ‚ç‚¹å‘ä»èŠ‚ç‚¹åŒæ­¥æ•°æ®ã€‚ä¸¤è€…ç»“æ„ä¸€æ ·ï¼Œå¯ä»¥çœ‹åšæ˜¯**æ°´å¹³æ‰©å±•**ã€‚

<br/>

è¿™ä¸ªæ—¶å€™å°±ä¼šå‡ºç°å‚ç›´åˆ†åº“ã€æ°´å¹³æ‰©å±•çš„ç»¼åˆé›†ç¾¤ï¼Œå¦‚å›¾ï¼š

![img](./assets/20230725154303860.jpg)

<br/>

è¿™ç§æ¨¡å¼çš„ä¼˜ç¼ºç‚¹ï¼š

ä¼˜ç‚¹ï¼š

- è§£å†³äº†æµ·é‡æ•°æ®å­˜å‚¨é—®é¢˜ï¼Œçªç ´äº†å•æœºå­˜å‚¨ç“¶é¢ˆ
- æé«˜äº†å¹¶å‘èƒ½åŠ›ï¼Œçªç ´äº†å•æœºæ€§èƒ½ç“¶é¢ˆ
- é¿å…äº†å•ç‚¹æ•…éšœ

ç¼ºç‚¹ï¼š

- æˆæœ¬éå¸¸é«˜
- æ•°æ®èšåˆç»Ÿè®¡æ¯”è¾ƒéº»çƒ¦
- ä¸»ä»åŒæ­¥çš„ä¸€è‡´æ€§é—®é¢˜
- åˆ†å¸ƒå¼äº‹åŠ¡é—®é¢˜

<br/>

### å†å²æ¦œå•çš„å­˜å‚¨ç­–ç•¥

å¤©æœºå­¦å ‚é¡¹ç›®æ˜¯ä¸€ä¸ªæ•™è‚²ç±»é¡¹ç›®ï¼Œç”¨æˆ·è§„æ¨¡å¹¶ä¸ä¼šå¾ˆé«˜ï¼Œä¸€èˆ¬åœ¨åå¤šä¸‡åˆ°ç™¾ä¸‡çº§åˆ«ã€‚å› æ­¤æœ€ç»ˆçš„æ•°æ®è§„æ¨¡ä¹Ÿå¹¶ä¸ä¼šéå¸¸åºå¤§ã€‚

ç»¼åˆä¹‹å‰çš„åˆ†æï¼Œç»“åˆå¤©æœºå­¦å ‚çš„é¡¹ç›®æƒ…å†µï¼Œæˆ‘ä»¬å¯ä»¥å¯¹æ¦œå•æ•°æ®åšåˆ†è¡¨ï¼Œä½†æ˜¯æš‚æ—¶ä¸éœ€è¦åšåˆ†åº“å’Œé›†ç¾¤ã€‚

<br/>

ç”±äºæˆ‘ä»¬è¦è§£å†³çš„æ˜¯æ•°æ®è¿‡å¤šé—®é¢˜ï¼Œå› æ­¤åˆ†è¡¨çš„æ–¹å¼é€‰æ‹©**æ°´å¹³åˆ†è¡¨**ã€‚å…·ä½“æ¥è¯´ï¼Œå°±æ˜¯æŒ‰ç…§èµ›å­£æ‹†åˆ†ï¼Œæ¯ä¸€ä¸ªèµ›å­£æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„è¡¨ï¼Œå¦‚å›¾ï¼š

![img](./assets/20230725154303021.jpg)

ä¸è¿‡è¿™é‡Œæˆ‘ä»¬å¯ä»¥åšä¸€äº›ç®€åŒ–ï¼š

- æˆ‘ä»¬å¯ä»¥å°†idé‡‡ç”¨è‡ªå¢idï¼Œé‚£ä¹ˆidå°±æ˜¯æ’åï¼Œæ’åå­—æ®µå°±ä¸éœ€è¦äº†ã€‚
- ä¸åŒèµ›å­£ç”¨ä¸åŒè¡¨ï¼Œé‚£ä¹ˆèµ›å­£å­—æ®µå°±ä¸éœ€è¦äº†ã€‚

ç»¼ä¸Šï¼Œæœ€ç»ˆè¡¨ç»“æ„å¯ä»¥æ˜¯è¿™æ ·ï¼š

![img](./assets/20230725154302911.jpg)

ä¸è¿‡è¿™å°±å­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼Œæ¯ä¸ªèµ›å­£è¦æœ‰ä¸åŒçš„è¡¨ï¼Œè¿™äº›è¡¨ä»€ä¹ˆæ—¶å€™åˆ›å»ºå‘¢ï¼Ÿ

<br/>

æ˜¾ç„¶ï¼Œåº”è¯¥åœ¨æ¯ä¸ªèµ›å­£åˆšå¼€å§‹çš„æ—¶å€™ï¼ˆæœˆåˆï¼‰æ¥åˆ›å»ºæ–°çš„èµ›å­£æ¦œå•è¡¨ã€‚æ¯ä¸ªæœˆçš„æœˆåˆæ‰§è¡Œä¸€ä¸ªåˆ›å»ºè¡¨çš„ä»»åŠ¡ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨å®šæ—¶ä»»åŠ¡æ¥å®ç°ã€‚

ç”±äºè¡¨çš„åç§°ä¸­åŒ…å«èµ›å­£idï¼Œå› æ­¤åœ¨å®šæ—¶ä»»åŠ¡ä¸­æˆ‘ä»¬è¿˜è¦å…ˆæŸ¥è¯¢èµ›å­£ä¿¡æ¯ï¼Œè·å–èµ›å­£idï¼Œæ‹¼æ¥å¾—åˆ°è¡¨åï¼Œæœ€ååˆ›å»ºè¡¨ã€‚

<br/>

å¤§æ¦‚æµç¨‹å¦‚å›¾ï¼š

![img](./assets/20230725154303194.jpg)

<br/>

è¡¨ç»“æ„å¦‚ä¸‹ï¼š

```SQL
 CREATE TABLE IF NOT EXISTS `points_board_X`
 (
    `id`      BIGINT NOT NULL AUTO_INCREMENT COMMENT 'æ¦œå•id',
    `user_id` BIGINT NOT NULL COMMENT 'å­¦ç”Ÿid',
    `points`  INT    NOT NULL COMMENT 'ç§¯åˆ†å€¼',
    PRIMARY KEY (`id`) USING BTREE,
    INDEX `idx_user_id` (`user_id`) USING BTREE
 )
    COMMENT ='å­¦éœ¸å¤©æ¢¯æ¦œ'
    COLLATE = 'utf8mb4_0900_ai_ci'
    ENGINE = InnoDB
    ROW_FORMAT = DYNAMIC
 ;
```

<br/>

è¡¨åç§°çš„å‰ç¼€æ˜¯`points_board_`ï¼Œæˆ‘ä»¬åº”è¯¥å°†å…¶å®šä¹‰ä¸ºå¸¸é‡ã€‚åœ¨`tj-learning`æ¨¡å—ä¸­å®šä¹‰ï¼š

![img](./assets/20230725154304334.jpg)

<br/>

åŒæ—¶ï¼Œè¡¨ä¸­çš„å­—æ®µå°‘äº†2ä¸ªï¼ˆrankã€seasonï¼‰ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦ä¿®æ”¹å¯¹åº”çš„å®ä½“ç±»ï¼š

![img](./assets/20230725154304413.jpg)

<br/>

### å®šæ—¶ä»»åŠ¡ç”Ÿæˆæ¦œå•è¡¨

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬é€šè¿‡SpringTaskå®šä¹‰ä¸€ä¸ªå®šæ—¶ä»»åŠ¡ï¼Œåœ¨æ¯æœˆåˆåŠ¨æ€ç”Ÿæˆèµ›å­£æ¦œå•è¡¨ã€‚

<br/>

#### å®šæ—¶ä»»åŠ¡

é¦–å…ˆï¼Œåœ¨`tj-learning`æ¨¡å—ä¸‹å®šä¹‰ä¸€ä¸ªä»»åŠ¡å¤„ç†ç±»ï¼š

![img](./assets/20230725154303561.jpg)

ä»£ç å¦‚ä¸‹ï¼š

```Java
package com.tianji.learning.handler;

import com.tianji.common.utils.CollUtils;
import com.tianji.common.utils.DateUtils;
import com.tianji.learning.service.IPointsBoardSeasonService;
import com.tianji.learning.service.IPointsBoardService;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Component;

import java.time.LocalDateTime;
import java.util.List;

import static com.tianji.learning.constants.LearningConstants.POINTS_BOARD_TABLE_PREFIX;

@Component
@RequiredArgsConstructor
public class PointsBoardPersistentHandler {

    private final IPointsBoardSeasonService seasonService;

    private final IPointsBoardService pointsBoardService;

    @Scheduled(cron = "0 0 3 1 * ?") // æ¯æœˆ1å·ï¼Œå‡Œæ™¨3ç‚¹æ‰§è¡Œ
    public void createPointsBoardTableOfLastSeason(){
        // 1.è·å–ä¸Šæœˆæ—¶é—´
        LocalDateTime time = LocalDateTime.now().minusMonths(1);
        // 2.æŸ¥è¯¢èµ›å­£id
        Integer season = seasonService.querySeasonByTime(time);
        if (season == null) {
            // èµ›å­£ä¸å­˜åœ¨
            return;
        }
        // 3.åˆ›å»ºè¡¨
        pointsBoardService.createPointsBoardTableBySeason(season);
    }
}
```

è¿™é‡Œè°ƒç”¨äº†ä¸¤ä¸ªserviceçš„æ–¹æ³•ï¼Œä¸€ä¸ªæ˜¯æŸ¥è¯¢èµ›å­£ï¼Œä¸€ä¸ªæ˜¯åˆ›å»ºè¡¨ã€‚

<br/>

#### æŸ¥è¯¢èµ›å­£id

é¦–å…ˆï¼Œæˆ‘ä»¬åœ¨`tj-learning`æ¨¡å—çš„`com.tianji.learning.service.IPointsBoardSeasonService`ä¸­å®šä¹‰æŸ¥è¯¢èµ›å­£çš„æ–¹æ³•ï¼š

```Java
package com.tianji.learning.service;

import com.baomidou.mybatisplus.extension.service.IService;
import com.tianji.learning.domain.po.PointsBoardSeason;

import java.time.LocalDateTime;

/**
 * <p>
 *  æœåŠ¡ç±»
 * </p>
 */
public interface IPointsBoardSeasonService extends IService<PointsBoardSeason> {

    Integer querySeasonByTime(LocalDateTime time);
}
```

<br/>

ç„¶ååœ¨`com.tianji.learning.service.impl.PointsBoardSeasonServiceImpl`ä¸­å®ç°è¯¥æ–¹æ³•ï¼š

```Java
package com.tianji.learning.service.impl;

import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.tianji.learning.domain.po.PointsBoardSeason;
import com.tianji.learning.mapper.PointsBoardSeasonMapper;
import com.tianji.learning.service.IPointsBoardSeasonService;
import org.springframework.stereotype.Service;

import java.time.LocalDateTime;
import java.util.Optional;

/**
 * <p>
 *  æœåŠ¡å®ç°ç±»
 * </p>
 */
@Service
public class PointsBoardSeasonServiceImpl extends ServiceImpl<PointsBoardSeasonMapper, PointsBoardSeason> implements IPointsBoardSeasonService {

    @Override
    public Integer querySeasonByTime(LocalDateTime time) {
        Optional<PointsBoardSeason> optional = lambdaQuery()
                .le(PointsBoardSeason::getBeginTime, time)
                .ge(PointsBoardSeason::getEndTime, time)
                .oneOpt();
        return optional.map(PointsBoardSeason::getId).orElse(null);
    }
}
```

<br/>

#### åˆ›å»ºè¡¨

åœ¨`tj-learning`æ¨¡å—çš„`com.tianji.learning.service.IPointsBoardService`ä¸­å®šä¹‰åˆ›å»ºè¡¨çš„æ–¹æ³•ï¼š

```Java
package com.tianji.learning.service;

import com.baomidou.mybatisplus.extension.service.IService;
import com.tianji.learning.domain.po.PointsBoard;
import com.tianji.learning.domain.query.PointsBoardQuery;
import com.tianji.learning.domain.vo.PointsBoardVO;

import java.util.List;

/**
 * <p>
 * å­¦éœ¸å¤©æ¢¯æ¦œ æœåŠ¡ç±»
 * </p>
 */
public interface IPointsBoardService extends IService<PointsBoard> {
    PointsBoardVO queryPointsBoardBySeason(PointsBoardQuery query);

    void createPointsBoardTableBySeason(Integer season);
}
```

<br/>

ç„¶ååœ¨`com.tianji.learning.service.impl.PointsBoardServiceImpl`ä¸­å®ç°è¯¥æ–¹æ³•ï¼š

```Java
@Override
public void createPointsBoardTableBySeason(Integer season) {
    getBaseMapper().createPointsBoardTable(POINTS_BOARD_TABLE_PREFIX + season);
}
```

<br/>

è¿™é‡Œçš„å»ºè¡¨è¯­å¥è‚¯å®šæ˜¯è‡ªå®šä¹‰SQLï¼Œéœ€è¦ç°åœ¨åœ¨`com.tianji.learning.mapper.PointsBoardMapper`ä¸­å®šä¹‰å‡ºæ–¹æ³•ï¼š

```Java
package com.tianji.learning.mapper;

import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.tianji.learning.domain.po.PointsBoard;
import org.apache.ibatis.annotations.Param;

/**
 * <p>
 * å­¦éœ¸å¤©æ¢¯æ¦œ Mapper æ¥å£
 * </p>
 */
public interface PointsBoardMapper extends BaseMapper<PointsBoard> {

    void createPointsBoardTable(@Param("tableName") String tableName);
}
```

<br/>

ç„¶ååœ¨`tj-learning`æ¨¡å—çš„`src/resources/mapper/PointsBoardMapper.xml`ä¸­ç¼–å†™SQLï¼š

```XML
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.tianji.learning.mapper.PointsBoardMapper">

    <insert id="createPointsBoardTable" parameterType="java.lang.String">
        CREATE TABLE `${tableName}`
        (
            `id`      BIGINT NOT NULL AUTO_INCREMENT COMMENT 'æ¦œå•id',
            `user_id` BIGINT NOT NULL COMMENT 'å­¦ç”Ÿid',
            `points`  INT    NOT NULL COMMENT 'ç§¯åˆ†å€¼',
            PRIMARY KEY (`id`) USING BTREE,
            INDEX `idx_user_id` (`user_id`) USING BTREE
        )
            COMMENT ='å­¦éœ¸å¤©æ¢¯æ¦œ'
            COLLATE = 'utf8mb4_0900_ai_ci'
            ENGINE = InnoDB
            ROW_FORMAT = DYNAMIC
    </insert>
</mapper>
```

<br/>

### åˆ†å¸ƒå¼ä»»åŠ¡è°ƒåº¦

ç›®å‰ï¼Œæˆ‘ä»¬çš„å®šæ—¶ä»»åŠ¡éƒ½æ˜¯åŸºäºSpringTaskæ¥å®ç°çš„ã€‚ä½†æ˜¯SpringTaskå­˜åœ¨ä¸€äº›é—®é¢˜ï¼š

- å½“å¾®æœåŠ¡å¤šå®ä¾‹éƒ¨ç½²æ—¶ï¼Œå®šæ—¶ä»»åŠ¡ä¼šè¢«æ‰§è¡Œå¤šæ¬¡ã€‚è€Œäº‹å®ä¸Šæˆ‘ä»¬åªéœ€è¦è¿™ä¸ªä»»åŠ¡è¢«æ‰§è¡Œä¸€æ¬¡å³å¯ã€‚
- æˆ‘ä»¬é™¤äº†è¦å®šæ—¶åˆ›å»ºè¡¨ï¼Œè¿˜è¦å®šæ—¶æŒä¹…åŒ–Redisæ•°æ®åˆ°æ•°æ®åº“ï¼Œæˆ‘ä»¬å¸Œæœ›è¿™å¤šä¸ªå®šæ—¶ä»»åŠ¡èƒ½å¤ŸæŒ‰ç…§é¡ºåºä¾æ¬¡æ‰§è¡Œï¼ŒSpringTaskæ— æ³•æ§åˆ¶ä»»åŠ¡é¡ºåº

<br/>

ä¸ä»…ä»…æ˜¯SpringTaskï¼Œå…¶å®ƒå•æœºä½¿ç”¨çš„å®šæ—¶ä»»åŠ¡å·¥å…·ï¼Œéƒ½æ— æ³•å®ç°åƒè¿™ç§ä»»åŠ¡æ‰§è¡Œè€…çš„è°ƒåº¦ã€ä»»åŠ¡æ‰§è¡Œé¡ºåºçš„ç¼–æ’ã€ä»»åŠ¡ç›‘æ§ç­‰åŠŸèƒ½ã€‚è¿™äº›åŠŸèƒ½å¿…é¡»è¦ç”¨åˆ°åˆ†å¸ƒå¼ä»»åŠ¡è°ƒåº¦ç»„ä»¶ã€‚

<br/>

#### åˆ†å¸ƒå¼ä»»åŠ¡è°ƒåº¦åŸç†

é‚£ä¹ˆåˆ†å¸ƒå¼ä»»åŠ¡è°ƒåº¦æ˜¯å¦‚ä½•å®ç°ä»»åŠ¡è°ƒåº¦å’Œç¼–æ’çš„å‘¢ï¼Ÿ

æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹æ™®é€šå®šæ—¶ä»»åŠ¡çš„å®ç°åŸç†ï¼Œä¸€èˆ¬å®šæ—¶ä»»åŠ¡ä¸­ä¼šæœ‰ä¸¤ä¸ªç»„ä»¶ï¼š

- ä»»åŠ¡ï¼šè¦æ‰§è¡Œçš„ä»£ç 
- ä»»åŠ¡è§¦å‘å™¨ï¼šåŸºäºå®šä¹‰å¥½çš„è§„åˆ™è§¦å‘ä»»åŠ¡

<br/>

å› æ­¤åœ¨å¤šå®ä¾‹éƒ¨ç½²çš„æ—¶å€™ï¼Œæ¯ä¸ªå¯åŠ¨çš„æœåŠ¡å®ä¾‹éƒ½ä¼šæœ‰è‡ªå·±çš„**ä»»åŠ¡è§¦å‘å™¨**ï¼Œè¿™æ ·å°±ä¼šå¯¼è‡´å„ä¸ªå®ä¾‹å„è‡ªè¿è¡Œï¼Œæ— æ³•ç»Ÿä¸€æ§åˆ¶ï¼š

![img](./assets/20230725154304079.jpg)

é‚£å¦‚æœæˆ‘ä»¬æƒ³è¦ç»Ÿä¸€æ§åˆ¶å„ä¸ªæœåŠ¡å®ä¾‹çš„ä»»åŠ¡æ‰§è¡Œå’Œè°ƒåº¦è¯¥æ€ä¹ˆåŠï¼Ÿ

<br/>

å¤§å®¶åº”è¯¥èƒ½æƒ³åˆ°ï¼šå°±æ˜¯è¦æŠŠä»»åŠ¡è§¦å‘å™¨æå–åˆ°å„ä¸ªæœåŠ¡å®ä¾‹ä¹‹å¤–ï¼Œå»åšç»Ÿä¸€çš„è§¦å‘ã€ç»Ÿä¸€çš„è°ƒåº¦ã€‚

äº‹å®ä¸Šï¼Œå¤§å¤šæ•°çš„åˆ†å¸ƒå¼ä»»åŠ¡è°ƒåº¦ç»„ä»¶éƒ½æ˜¯è¿™æ ·åšçš„ï¼š

![img](./assets/20230725141106785.jpg)

<br/>

è¿™æ ·ä¸€æ¥ï¼Œå…·ä½“å“ªä¸ªä»»åŠ¡è¯¥æ‰§è¡Œï¼Œä»€ä¹ˆæ—¶å€™æ‰§è¡Œï¼Œäº¤ç»™å“ªä¸ªåº”ç”¨å®ä¾‹æ¥æ‰§è¡Œï¼Œå…¨éƒ¨éƒ½æœ‰ç»Ÿä¸€çš„ä»»åŠ¡è°ƒåº¦æœåŠ¡æ¥ç»Ÿä¸€æ§åˆ¶ã€‚å¹¶ä¸”æ‰§è¡Œè¿‡ç¨‹ä¸­çš„ä»»åŠ¡ç»“æœè¿˜å¯ä»¥é€šè¿‡å›è°ƒæ¥å£è¿”å›ï¼Œè®©æˆ‘ä»¬æ–¹ä¾¿çš„æŸ¥çœ‹ä»»åŠ¡æ‰§è¡ŒçŠ¶æ€ã€æ‰§è¡Œæ—¥å¿—ã€‚è¿™æ ·çš„æœåŠ¡å°±æ˜¯**åˆ†å¸ƒå¼è°ƒåº¦æœåŠ¡**äº†ã€‚

<br/>

#### åˆ†å¸ƒå¼ä»»åŠ¡è°ƒåº¦æŠ€æœ¯å¯¹æ¯”

èƒ½å¤Ÿå®ç°åˆ†å¸ƒå¼ä»»åŠ¡è°ƒåº¦çš„æŠ€æœ¯æœ‰å¾ˆå¤šï¼Œå¸¸è§çš„æœ‰ï¼š

|                  | **Quartz** |   **XXL-Job**    |       **SchedulerX**       |           **PowerJob**           |
| :--------------: | :--------: | :--------------: | :------------------------: | :------------------------------: |
|   **å®šæ—¶ç±»å‹**   |    CRON    | é¢‘ç‡ã€é—´éš”ã€CRON | é¢‘ç‡ã€é—´éš”ã€CRONã€OpenAPI  |    é¢‘ç‡ã€é—´éš”ã€CRONã€OpenAPI     |
|   **ä»»åŠ¡ç±»å‹**   |    Java    |    å¤šè¯­è¨€è„šæœ¬    |         å¤šè¯­è¨€è„šæœ¬         |            å¤šè¯­è¨€è„šæœ¬            |
| **ä»»åŠ¡è°ƒåº¦æ–¹å¼** |    éšæœº    |    å•æœºã€åˆ†ç‰‡    | å•æœºã€å¹¿æ’­ã€Mapã€MapReduce | å•æœºã€å¹¿æ’­ã€åˆ†ç‰‡ã€Mapã€MapReduce |
|  **ç®¡ç†æ§åˆ¶å°**  |     æ—      |       æ”¯æŒ       |            æ”¯æŒ            |               æ”¯æŒ               |
|   **æ—¥å¿—ç™½å±**   |     æ—      |       æ”¯æŒ       |            æ”¯æŒ            |               æ”¯æŒ               |
|   **æŠ¥è­¦ç›‘æ§**   |     æ—      |       æ”¯æŒ       |            æ”¯æŒ            |               æ”¯æŒ               |
|    **å·¥ä½œæµ**    |     æ—      |       æœ‰é™       |            æ”¯æŒ            |               æ”¯æŒ               |

å…¶ä¸­ï¼š

- Quartzç”±äºåŠŸèƒ½ç›¸å¯¹æ¯”è¾ƒè½åï¼Œç°åœ¨å·²ç»å¾ˆå°‘è¢«ä½¿ç”¨äº†ã€‚
- SchedulerXæ˜¯é˜¿é‡Œå·´å·´çš„äº‘äº§å“ï¼Œæ”¶è´¹ã€‚
- PowerJobæ˜¯é˜¿é‡Œå‘˜å·¥è‡ªå·±å¼€æºçš„ä¸€ä¸ªç»„ä»¶ï¼ŒåŠŸèƒ½éå¸¸å¼ºå¤§ï¼Œä¸è¿‡ç›®å‰å¸‚å€¼å æ¯”è¿˜ä¸é«˜ï¼Œè¿˜éœ€è¦ç­‰å¾…å¸‚åœºæ£€éªŒã€‚
- XXL-JOBï¼šå¼€æºå…è´¹ï¼ŒåŠŸèƒ½è™½ç„¶ä¸å¦‚PowerJobï¼Œä¸è¿‡ç›®å‰å¸‚åœºå æ¯”æœ€é«˜ï¼Œç¨³å®šæ€§æœ‰ä¿è¯ã€‚

<br/>

æˆ‘ä»¬è¯¾å ‚ä¸­ä¼šé€‰æ‹©XXL-JOBè¿™ä¸ªç»„ä»¶ï¼Œå¦‚æœä½ ä»¬ä¼ä¸šå…·å¤‡æ¢ç´¢ç²¾ç¥ï¼Œè€Œä¸”éœ€è¦ä¸€äº›åˆ†å¸ƒå¼è¿ç®—åŠŸèƒ½ï¼Œæ¨èä½¿ç”¨PowerJobã€‚

<br/>

#### XXL-JOBä»‹ç»

å®˜ç½‘åœ°å€ï¼šhttps://www.xuxueli.com/xxl-job/

XXL-JOBçš„è¿è¡ŒåŸç†å’Œæ¶æ„å¦‚å›¾ï¼š

![img](./assets/20230725154304200.jpg)

XXL-JOBåˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼š

- **æ‰§è¡Œå™¨**ï¼šæˆ‘ä»¬çš„æœåŠ¡å¼•å…¥ä¸€ä¸ªXXL-JOBçš„ä¾èµ–ï¼Œå°±å¯ä»¥é€šè¿‡é…ç½®åˆ›å»ºä¸€ä¸ªæ‰§è¡Œå™¨ã€‚è´Ÿè´£ä¸XXL-JOBè°ƒåº¦ä¸­å¿ƒäº¤äº’ï¼Œæ‰§è¡Œæœ¬åœ°ä»»åŠ¡ã€‚
- **è°ƒåº¦ä¸­å¿ƒ**ï¼šä¸€ä¸ªç‹¬ç«‹æœåŠ¡ï¼Œè´Ÿè´£ç®¡ç†æ‰§è¡Œå™¨ã€ç®¡ç†ä»»åŠ¡ã€ä»»åŠ¡æ‰§è¡Œçš„è°ƒåº¦ã€ä»»åŠ¡ç»“æœå’Œæ—¥å¿—æ”¶é›†ã€‚

<br/>

#### XXL-JOBå®šæ—¶åˆ›å»ºæ¦œå•è¡¨

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±æ¥ä¸€ä¸ªXXL-JOBçš„å¿«é€Ÿå…¥é—¨ï¼Œé¡ºä¾¿æ”¹é€ ä¸€ä¸‹ä¹‹å‰ç”¨SpringTaskå®ç°çš„å®šæ—¶åˆ›å»ºæ¦œå•è¡¨çš„åŠŸèƒ½ã€‚

<Br/>

**éƒ¨ç½²è°ƒåº¦ä¸­å¿ƒ**

è°ƒåº¦ä¸­å¿ƒåœ¨æˆ‘ä»¬æä¾›çš„è™šæ‹Ÿæœºå¼€å‘ç¯å¢ƒä¸­å·²ç»éƒ¨ç½²å®Œæˆäº†ã€‚è®¿é—®ï¼š[http://xxljob.tianji.com](http://xxljob.tianji.com/)å³å¯æŸ¥çœ‹è°ƒåº¦ä¸­å¿ƒæ§åˆ¶å°é¡µé¢ã€‚é»˜è®¤çš„è´¦å·å¯†ç æ˜¯ï¼šadmin/123456

![img](./assets/20230725154304337.jpg)

å¦‚æœè¦è‡ªå·±éƒ¨ç½²ï¼Œåˆ†ä¸ºä¸¤æ­¥ï¼š

- è¿è¡Œåˆå§‹åŒ–SQLï¼Œåˆ›å»ºæ•°æ®åº“è¡¨
- åˆ©ç”¨Dockerå‘½ä»¤ï¼Œåˆ›å»ºå¹¶è¿è¡Œå®¹å™¨

è¯¾å‰èµ„æ–™å·²ç»ç»™å‡ºäº†è„šæœ¬ï¼š

<br/>

Dockerå¯åŠ¨å‘½ä»¤

```sh
docker run \
-e PARAMS="--spring.datasource.url=jdbc:mysql://192.168.150.101:3306/xxl_job?Unicode=true&characterEncoding=UTF-8 \
--spring.datasource.username=root \
--spring.datasource.password=123" \
--restart=always \
-p 28080:8080 \
-v xxl-job-admin-applogs:/data/applogs \
--name xxl-job-admin \
-d \
xuxueli/xxl-job-admin:2.3.0
```

![img](./assets/20230725154304602.jpg)

æœ€ç»ˆXXL-JOBçš„è¡¨ç»“æ„å¦‚ä¸‹ï¼š

![img](./assets/20230725154304734.jpg)

è¯´æ˜ï¼š

- xxl_job_lockï¼šä»»åŠ¡è°ƒåº¦é”è¡¨ï¼›
- xxl_job_groupï¼šæ‰§è¡Œå™¨ä¿¡æ¯è¡¨ï¼Œç»´æŠ¤ä»»åŠ¡æ‰§è¡Œå™¨ä¿¡æ¯ï¼›
- xxl_job_infoï¼šè°ƒåº¦æ‰©å±•ä¿¡æ¯è¡¨ï¼š ç”¨äºä¿å­˜XXL-JOBè°ƒåº¦ä»»åŠ¡çš„æ‰©å±•ä¿¡æ¯ï¼Œå¦‚ä»»åŠ¡åˆ†ç»„ã€ä»»åŠ¡åã€æœºå™¨åœ°å€ã€æ‰§è¡Œå™¨ã€æ‰§è¡Œå…¥å‚å’ŒæŠ¥è­¦é‚®ä»¶ç­‰ç­‰ï¼›
- xxl_job_logï¼šè°ƒåº¦æ—¥å¿—è¡¨ï¼š ç”¨äºä¿å­˜XXL-JOBä»»åŠ¡è°ƒåº¦çš„å†å²ä¿¡æ¯ï¼Œå¦‚è°ƒåº¦ç»“æœã€æ‰§è¡Œç»“æœã€è°ƒåº¦å…¥å‚ã€è°ƒåº¦æœºå™¨å’Œæ‰§è¡Œå™¨ç­‰ç­‰ï¼›
- xxl_job_log_reportï¼šè°ƒåº¦æ—¥å¿—æŠ¥è¡¨ï¼šç”¨æˆ·å­˜å‚¨XXL-JOBä»»åŠ¡è°ƒåº¦æ—¥å¿—çš„æŠ¥è¡¨ï¼Œè°ƒåº¦ä¸­å¿ƒæŠ¥è¡¨åŠŸèƒ½é¡µé¢ä¼šç”¨åˆ°ï¼›
- xxl_job_logglueï¼šä»»åŠ¡GLUEæ—¥å¿—ï¼šç”¨äºä¿å­˜GLUEæ›´æ–°å†å²ï¼Œç”¨äºæ”¯æŒGLUEçš„ç‰ˆæœ¬å›æº¯åŠŸèƒ½ï¼›
- xxl_job_registryï¼šæ‰§è¡Œå™¨æ³¨å†Œè¡¨ï¼Œç»´æŠ¤åœ¨çº¿çš„æ‰§è¡Œå™¨å’Œè°ƒåº¦ä¸­å¿ƒæœºå™¨åœ°å€ä¿¡æ¯ï¼›
- xxl_job_userï¼šç³»ç»Ÿç”¨æˆ·è¡¨ï¼›

<Br/>

**å¾®æœåŠ¡é›†æˆæ‰§è¡Œå™¨**

é¦–å…ˆéœ€è¦åœ¨tj-learningæœåŠ¡å¼•å…¥ä¾èµ–ï¼š

```XML
<!--xxl-job-->
<dependency>
    <groupId>com.xuxueli</groupId>
    <artifactId>xxl-job-core</artifactId>
</dependency>
```

ç„¶åè¿˜éœ€è¦é…ç½®æ‰§è¡Œå™¨ï¼Œä¸‹é¢æ˜¯ä¸€ä¸ªé…ç½®æ‰§è¡Œå™¨çš„ç¤ºä¾‹ï¼š

```Java
@Bean
public XxlJobSpringExecutor xxlJobExecutor() {
    logger.info(">>>>>>>>>>> xxl-job config init.");
    XxlJobSpringExecutor xxlJobSpringExecutor = new XxlJobSpringExecutor();
    xxlJobSpringExecutor.setAdminAddresses(adminAddresses);
    xxlJobSpringExecutor.setAppname(appname);
    xxlJobSpringExecutor.setIp(ip);
    xxlJobSpringExecutor.setPort(port);
    xxlJobSpringExecutor.setAccessToken(accessToken);
    xxlJobSpringExecutor.setLogPath(logPath);
    xxlJobSpringExecutor.setLogRetentionDays(logRetentionDays);

    return xxlJobSpringExecutor;
}
```

å‚æ•°è¯´æ˜ï¼š

- adminAddressï¼šè°ƒåº¦ä¸­å¿ƒåœ°å€ï¼Œå¤©æœºå­¦å ‚ä¸­å°±æ˜¯å¡«è™šæ‹Ÿæœºåœ°å€
- appnameï¼šå¾®æœåŠ¡åç§°
- ipå’Œportï¼šå½“å‰æ‰§è¡Œå™¨çš„ipå’Œç«¯å£ï¼Œæ— éœ€é…ç½®ï¼Œè‡ªåŠ¨è·å–
- accessTokenï¼šè®¿é—®ä»¤ç‰Œï¼Œåœ¨è°ƒåº¦ä¸­å¿ƒä¸­é…ç½®ä»¤ç‰Œï¼Œæ‰€æœ‰æ‰§è¡Œå™¨è®¿é—®æ—¶éƒ½å¿…é¡»æºå¸¦è¯¥ä»¤ç‰Œï¼Œå¦åˆ™æ— æ³•è®¿é—®ã€‚å’±ä»¬é¡¹ç›®çš„ä»¤ç‰Œå·²ç»é…å¥½ï¼Œå°±æ˜¯`tianji`ã€‚å¦‚æœè¦ä¿®æ”¹ï¼Œå¯ä»¥åˆ°è™šæ‹Ÿæœºçš„`/usr/local/src/xxl-job/application.properties`æ–‡ä»¶ä¸­ï¼Œä¿®æ”¹`xxl.job.accessToken`å±æ€§ï¼Œç„¶åé‡å¯XXL-JOBå³å¯ã€‚
- logPathï¼šä»»åŠ¡è¿è¡Œæ—¥å¿—çš„ä¿å­˜ç›®å½•
- logRetentionDaysï¼šæ—¥å¿—æœ€é•¿ä¿ç•™æ—¶é•¿

<br/>

ä½†æ˜¯å‘¢ï¼Œå¤§å®¶å®Œå…¨ä¸éœ€è¦è‡ªå·±é…ç½®è°ƒåº¦å™¨äº†ï¼Œå› ä¸ºåœ¨å¤©æœºå­¦å ‚çš„tj-commonæ¨¡å—å·²ç»å®ç°äº†XXL-JOBçš„è‡ªåŠ¨è£…é…ï¼š 

![img](./assets/20230725154304969.jpg)

é…ç½®ä¸­çš„å…³é”®å±æ€§éƒ½å·²ç»åœ¨Nacosä¸­å…±äº«äº†ï¼š

![img](./assets/20230725154304691.jpg)

<br/>

æ‰€ä»¥ï¼Œæˆ‘ä»¬é¡¹ç›®çš„å¾®æœåŠ¡æ¨¡å—åªè¦å¼•å…¥`äº†tj-common`ï¼Œå¹¶ä¸”å¼•å…¥äº†XXL-JOBçš„ä¾èµ–ï¼Œå°±å¯ä»¥ç›´æ¥ä½¿ç”¨äº†ã€‚

```yml {27,28}
server:
  port: 8090  #ç«¯å£
  tomcat:
    uri-encoding: UTF-8   #æœåŠ¡ç¼–ç 
spring:
  profiles:
    active: dev
  application:
    name: learning-service
  cloud:
    nacos:
      config:
        file-extension: yaml
        shared-configs: # å…±äº«é…ç½®
          - data-id: shared-spring.yaml # å…±äº«springé…ç½®
            refresh: false
          - data-id: shared-redis.yaml # å…±äº«redisé…ç½®
            refresh: false
          - data-id: shared-mybatis.yaml # å…±äº«mybatisé…ç½®
            refresh: false
          - data-id: shared-logs.yaml # å…±äº«æ—¥å¿—é…ç½®
            refresh: false
          - data-id: shared-feign.yaml # å…±äº«feigné…ç½®
            refresh: false
          - data-id: shared-mq.yaml # å…±äº«mqé…ç½®
            refresh: false
          - data-id: shared-xxljob.yaml # å…±äº«mqé…ç½®
            refresh: false
```

<br/>

**å®šä¹‰ä»»åŠ¡**

 æ¥ä¸‹æ¥ï¼ŒæŠŠä¹‹å‰çš„SpringTaskä»»åŠ¡æ”¹æˆXXL-JOBçš„ä»»åŠ¡ã€‚

æˆ‘ä»¬ä¿®æ”¹tj-learningæ¨¡å—ä¸‹çš„`com.tianji.learning.handler.PointsBoardPersistentHandler`ï¼Œå°†åŸæœ¬çš„`@Scheduled`æ³¨è§£æ›¿æ¢ä¸º`@XXLJob`æ³¨è§£ï¼š

![img](./assets/20230725154305607.jpg)

å…¶ä¸­ï¼Œ`@XxlJob`æ³¨è§£ä¸­å®šä¹‰çš„å°±æ˜¯å½“å‰**ä»»åŠ¡çš„åç§°**ã€‚

<br/>

æ³¨å†Œæ‰§è¡Œå™¨

æ¥ä¸‹æ¥ï¼Œé‡å¯`tj-learning`æœåŠ¡ï¼Œç™»å½•XXL-JOBæ§åˆ¶å°ï¼Œæ³¨å†Œæ‰§è¡Œå™¨ã€‚

![img](./assets/20230725154305471.jpg)

åœ¨å¼¹å‡ºçš„çª—å£ä¸­å¡«å†™ä¿¡æ¯ï¼š

![img](./assets/20230725154305685.jpg)

ç­‰å¾…ä¸€æ®µæ—¶é—´ï¼Œä¼šå‘ç°`learning-service`å·²ç»æˆåŠŸæ³¨å†Œäº†ï¼š

![img](./assets/20230725154305473.jpg)

<br/>

**é…ç½®ä»»åŠ¡è°ƒåº¦**

ç°åœ¨ï¼Œæ‰§è¡Œå™¨å·²ç»æˆåŠŸæ³¨å†Œï¼Œä»»åŠ¡ä¹Ÿå·²ç»æ³¨å†Œåˆ°è°ƒåº¦ä¸­å¿ƒã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±å¯ä»¥æ¥åšä»»åŠ¡è°ƒåº¦äº†ï¼Œä¹Ÿå°±æ˜¯ï¼š

- åˆ†é…ä»»åŠ¡ä»€ä¹ˆæ—¶å€™æ‰§è¡Œ
- å¦‚æœæœ‰å¤šä¸ªæ‰§è¡Œå™¨ï¼Œåº”è¯¥ç”±å“ªä¸ªæ‰§è¡Œå™¨æ‰§è¡Œï¼ˆè·¯ç”±ç­–ç•¥ï¼‰

<br/>

æˆ‘ä»¬è¿›å…¥ä»»åŠ¡ç®¡ç†èœå•ï¼Œé€‰ä¸­å­¦ä¹ ä¸­å¿ƒæ‰§è¡Œå™¨ï¼Œç„¶åæ–°å¢ä»»åŠ¡ï¼š

![img](./assets/20230725154305606.jpg)

<br/>

åœ¨å¼¹å‡ºè¡¨å•ä¸­ï¼Œå¡«å†™ä»»åŠ¡è°ƒåº¦ä¿¡æ¯ï¼š

![img](./assets/20230725154305260.jpg)

å…¶ä¸­æ¯”è¾ƒå…³é”®çš„å‡ ä¸ªé…ç½®ï¼š

- è°ƒåº¦é…ç½®ï¼šä¹Ÿå°±æ˜¯ä»€ä¹ˆæ—¶å€™æ‰§è¡Œï¼Œä¸€èˆ¬é€‰æ‹©cronè¡¨è¾¾å¼
- ä»»åŠ¡é…ç½®ï¼šé‡‡ç”¨BEANæ¨¡å¼ï¼ŒæŒ‡å®šJobHandlerï¼Œè¿™é‡ŒæŒ‡å®šçš„å°±æ˜¯åœ¨é¡¹ç›®ä¸­`@XxlJob`æ³¨è§£ä¸­çš„ä»»åŠ¡åç§°
- è·¯ç”±ç­–ç•¥ï¼šå°±æ˜¯æŒ‡å¦‚æœæœ‰å¤šä¸ªä»»åŠ¡æ‰§è¡Œå™¨ï¼Œè¯¥ç”±è°æ‰§è¡Œï¼Ÿè¿™é‡Œæ”¯æŒçš„ç­–ç•¥éå¸¸å¤šï¼š
  
  ![img](./assets/20230725154305765.jpg)

<br/>

è·¯ç”±ç­–ç•¥è¯´æ˜ï¼š

- FIRSTï¼ˆç¬¬ä¸€ä¸ªï¼‰ï¼šå›ºå®šé€‰æ‹©ç¬¬ä¸€ä¸ªæ‰§è¡Œå™¨ï¼›
- LASTï¼ˆæœ€åä¸€ä¸ªï¼‰ï¼šå›ºå®šé€‰æ‹©æœ€åä¸€ä¸ªæ‰§è¡Œå™¨ï¼›
- ROUNDï¼ˆè½®è¯¢ï¼‰ï¼šåœ¨çº¿çš„æ‰§è¡Œå™¨æŒ‰ç…§è½®è¯¢ç­–ç•¥é€‰æ‹©ä¸€ä¸ªæ‰§è¡Œ
- RANDOMï¼ˆéšæœºï¼‰ï¼šéšæœºé€‰æ‹©åœ¨çº¿çš„æ‰§è¡Œå™¨ï¼›
- CONSISTENT_HASHï¼ˆä¸€è‡´æ€§HASHï¼‰ï¼šæ¯ä¸ªä»»åŠ¡æŒ‰ç…§Hashç®—æ³•å›ºå®šé€‰æ‹©æŸä¸€å°æ‰§è¡Œå™¨ï¼Œä¸”æ‰€æœ‰ä»»åŠ¡å‡åŒ€æ•£åˆ—åœ¨ä¸åŒæ‰§è¡Œå™¨ä¸Šã€‚
- LEAST_FREQUENTLY_USEDï¼ˆæœ€ä¸ç»å¸¸ä½¿ç”¨ï¼‰ï¼šä½¿ç”¨é¢‘ç‡æœ€ä½çš„æ‰§è¡Œå™¨ä¼˜å…ˆè¢«é€‰ä¸¾ï¼›
- LEAST_RECENTLY_USEDï¼ˆæœ€è¿‘æœ€ä¹…æœªä½¿ç”¨ï¼‰ï¼šæœ€ä¹…æœªä½¿ç”¨çš„æ‰§è¡Œå™¨ä¼˜å…ˆè¢«é€‰ä¸¾ï¼›
- FAILOVERï¼ˆæ•…éšœè½¬ç§»ï¼‰ï¼šæŒ‰ç…§é¡ºåºä¾æ¬¡è¿›è¡Œå¿ƒè·³æ£€æµ‹ï¼Œç¬¬ä¸€ä¸ªå¿ƒè·³æ£€æµ‹æˆåŠŸçš„æ‰§è¡Œå™¨é€‰å®šä¸ºç›®æ ‡æ‰§è¡Œå™¨å¹¶å‘èµ·è°ƒåº¦ï¼›
- BUSYOVERï¼ˆå¿™ç¢Œè½¬ç§»ï¼‰ï¼šæŒ‰ç…§é¡ºåºä¾æ¬¡è¿›è¡Œç©ºé—²æ£€æµ‹ï¼Œç¬¬ä¸€ä¸ªç©ºé—²æ£€æµ‹æˆåŠŸçš„æ‰§è¡Œå™¨é€‰å®šä¸ºç›®æ ‡æ‰§è¡Œå™¨å¹¶å‘èµ·è°ƒåº¦ï¼›
- SHARDING_BROADCAST(åˆ†ç‰‡å¹¿æ’­)ï¼šå¹¿æ’­è§¦å‘å¯¹åº”é›†ç¾¤ä¸­æ‰€æœ‰æ‰§è¡Œå™¨æ‰§è¡Œä¸€æ¬¡ä»»åŠ¡ï¼ŒåŒæ—¶ç³»ç»Ÿè‡ªåŠ¨ä¼ é€’åˆ†ç‰‡å‚æ•°ï¼›å¯æ ¹æ®åˆ†ç‰‡å‚æ•°å¼€å‘åˆ†ç‰‡ä»»åŠ¡

<Br/>

**æ‰§è¡Œä¸€æ¬¡**

å½“ä»»åŠ¡é…ç½®å®Œæˆåï¼Œå°±ä¼šæŒ‰ç…§è®¾ç½®çš„è°ƒåº¦ç­–ç•¥ï¼Œå®šæœŸå»æ‰§è¡Œäº†ã€‚ä¸è¿‡ï¼Œæˆ‘ä»¬æƒ³è¦æµ‹è¯•çš„è¯ä¹Ÿå¯ä»¥æ‰‹åŠ¨æ‰§è¡Œä¸€æ¬¡ä»»åŠ¡ã€‚

åœ¨ä»»åŠ¡ç®¡ç†ç•Œé¢ï¼Œç‚¹å‡»è¦æ‰§è¡Œçš„ä»»åŠ¡åé¢çš„`æ“ä½œ`æŒ‰é’®ï¼Œç‚¹å‡»`æ‰§è¡Œä¸€æ¬¡`ï¼š

![img](./assets/20230725154306809.jpg)

ç„¶ååœ¨å¼¹å‡ºçš„çª—å£ä¸­ï¼Œç›´æ¥ç‚¹ä¿å­˜å³å¯æ‰§è¡Œï¼š

![img](./assets/20230725154305821.jpg)

æ³¨æ„ï¼Œå¦‚æœæ˜¯åˆ†ç‰‡å¹¿æ’­æ¨¡å¼ï¼Œ è¿™é‡Œè¿˜å¯ä»¥å¡«å†™ä¸€äº›ä»»åŠ¡å‚æ•°ã€‚

ç„¶ååœ¨è°ƒåº¦æ—¥å¿—ä¸­ï¼Œå¯ä»¥çœ‹åˆ°æ‰§è¡ŒæˆåŠŸçš„æ—¥å¿—ä¿¡æ¯ï¼š

![img](./assets/20230725154308184.jpg)

<br/>

### æ¦œå•æŒä¹…åŒ–

æ¦œå•æŒä¹…åŒ–çš„åŸºæœ¬æµç¨‹æ˜¯è¿™æ ·çš„ï¼š

- åˆ›å»ºè¡¨
- æŒä¹…åŒ–Redisæ•°æ®åˆ°æ•°æ®åº“
- æ¸…ç†Redisæ•°æ®

<br/>

ç°åœ¨ï¼Œåˆ›å»ºè¡¨çš„åŠ¨ä½œå·²ç»å®Œæˆï¼Œæ¥ä¸‹æ¥å°±è½®åˆ°Redisæ•°æ®çš„æŒä¹…åŒ–äº†ã€‚æŒä¹…åŒ–çš„æ­¥éª¤å¦‚ä¸‹ï¼š

- è¯»å–Redisæ•°æ®
- åˆ¤æ–­æ•°æ®æ˜¯å¦å­˜åœ¨
  - ä¸å­˜åœ¨ï¼Œç›´æ¥ç»“æŸ
  - å­˜åœ¨ï¼Œåˆ™ç»§ç»­
- ä¿å­˜æ•°æ®åˆ°æ•°æ®åº“

<br/>

ä¸è¿‡ï¼ŒRedisçš„æ•°æ®ç»“æ„å¦‚å›¾ï¼š

![img](./assets/20230725154305885.jpg)

å…¶KEYä¸­åŒ…å«ä¸€ä¸ªä¸Šèµ›å­£å¯¹åº”çš„æ—¥æœŸï¼Œå› æ­¤è¦è¯»å–Redisæ•°æ®ï¼Œæˆ‘ä»¬å¿…é¡»å…ˆå¾—åˆ°ä¸Šèµ›å­£çš„æ—¥æœŸã€‚

å¦å¤–ï¼Œæˆ‘ä»¬é‡‡ç”¨äº†æ°´å¹³åˆ†è¡¨çš„ç­–ç•¥ï¼Œæ¯ä¸€ä¸ªèµ›å­£éƒ½æ˜¯ä¸€ä¸ªç‹¬ç«‹è¡¨ã€‚é‚£ä¹ˆåœ¨å†™æ•°æ®åˆ°æ•°æ®åº“æ—¶ï¼Œå¿…é¡»å…ˆçŸ¥é“è¡¨åç§°ã€‚

<br/>

ç»¼ä¸Šï¼Œæœ€ç»ˆæŒä¹…åŒ–çš„ä¸šåŠ¡æµç¨‹å¦‚å›¾ï¼š

![image-20240214024255526](assets/image-20240214024255526.png)

<br/>

#### åŠ¨æ€è¡¨å

æŒä¹…åŒ–çš„æµç¨‹ä¸­å­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬çš„æ•°æ®åº“æŒä¹…åŒ–é‡‡ç”¨çš„æ˜¯MybatisPlusæ¥å®ç°çš„ã€‚è€ŒMybatisPlusè¯»å–è¡¨åçš„æ–¹å¼æ˜¯é€šè¿‡å®ä½“ç±»ä¸Šçš„`@Table`æ³¨è§£ï¼Œè€Œæ³¨è§£å¾€å¾€æ˜¯å†™æ­»çš„ï¼š

![img](./assets/20230725154306147.jpg)

é‚£æˆ‘ä»¬è¯¥å¦‚ä½•è®©MybatisPlusåœ¨æ‰§è¡Œçš„æ—¶å€™æ”¹å˜æ•°æ®å†™å…¥çš„è¡¨åç§°å‘¢ï¼Ÿ

<br/>

**åŠ¨æ€è¡¨åæ’ä»¶**

MybatisPlusä¸­æä¾›äº†ä¸€ä¸ªåŠ¨æ€è¡¨åçš„æ’ä»¶ï¼š

https://baomidou.com/pages/2a45ff/#dynamictablenameinnerinterceptor

æ’ä»¶çš„éƒ¨åˆ†æºç å¦‚ä¸‹ï¼š

![img](./assets/20230725154308818.jpg)

å¯è§è¡¨åç§°åŠ¨æ€è·å–å°±æ˜¯ä¾èµ–äºtableNameHandlerMappingä¸­çš„å…·ä½“çš„TableNameHandlerï¼Œè¿™ä¸ªMapå¦‚å›¾ï¼š

![img](./assets/20230725154306390.jpg)

è¿™ä¸ªMapçš„keyæ˜¯æ—§çš„è¡¨åç§°ï¼Œvalueæ˜¯TableNameHandlerï¼Œå°±æ˜¯è¡¨çš„åç§°å¤„ç†å™¨ï¼Œç”¨äºæ ¹æ®æ—§åç§°è·å–æ–°åç§°ã€‚

<br/>

TableNameHandlerçš„æºç å¦‚ä¸‹ï¼š

```Java
public interface TableNameHandler {

    /**
     * ç”ŸæˆåŠ¨æ€è¡¨å
     *
     * @param sql       å½“å‰æ‰§è¡Œ SQL
     * @param tableName è¡¨å
     * @return String
     */
    String dynamicTableName(String sql, String tableName);
}
```

OKï¼Œå› æ­¤æˆ‘ä»¬è¦åšçš„äº‹æƒ…å°±å¾ˆç®€å•äº†ï¼Œå®šä¹‰`DynamicTableNameInnterInterceptor`ï¼Œå‘å…¶ä¸­æ·»åŠ ä¸€ä¸ª`TableNameHandler`ï¼Œå°†`points_board`è¿™ä¸ªè¡¨åï¼Œæ›¿æ¢ä¸º`points_board_èµ›å­£id`çš„åç§°ã€‚

<br/>

ä¸è¿‡ï¼Œæ–°çš„é—®é¢˜æ¥äº†ï¼Œè¿™ä¸ªæ’ä»¶ä¸­çš„TableNameHandlerè¯¥å¦‚ä½•è·å–èµ›å­£å¯¹åº”çš„è¡¨åç§°å‘¢ï¼Ÿ

è®¡ç®—è¡¨åçš„æ–¹å¼æ˜¯è·å–è·å–ä¸Šèµ›å­£æ—¶é—´ï¼ŒæŸ¥è¯¢æ•°æ®åº“ä¸­ä¸Šèµ›å­£ä¿¡æ¯ï¼Œå¾—åˆ°ä¸Šèµ›å­£idã€‚ç„¶åæ‹¼æ¥å¾—åˆ°è¡¨åã€‚

<br/>

å½“æˆ‘ä»¬æ‰¹é‡çš„å†™æ•°æ®åˆ°æ•°æ®åº“æ—¶ï¼Œ**å¦‚æœæ¯æ¬¡æ’å…¥éƒ½è®¡ç®—ä¸€æ¬¡è¡¨åï¼Œé‚£æ€§èƒ½ä¹Ÿå¤ªå·®äº†**ã€‚å› æ­¤ï¼Œæˆ‘ä»¬è‚¯å®šæ˜¯å¸Œæœ›ä¸€æ¬¡è®¡ç®—ï¼Œåœ¨TableNameHandlerä¸­å¯ä»¥éšæ—¶è·å–ã€‚

é‚£ä¹ˆè¯¥å¦‚ä½•å®ç°å‘¢ï¼Ÿ

<br/>

**ä¼ é€’è¡¨å**

æˆ‘ä»¬å…ˆå›é¡¾ä¸€ä¸‹æ•´ä½“ä¸šåŠ¡æµç¨‹ï¼š

![image-20240214024407842](assets/image-20240214024407842.png)

æµç¨‹ä¸­ï¼Œæˆ‘ä»¬ä¼šå…ˆè®¡ç®—è¡¨åï¼Œç„¶åå»æ‰§è¡ŒæŒä¹…åŒ–ï¼Œè€ŒåŠ¨æ€è¡¨åæ’ä»¶å°±ä¼šç”Ÿæ•ˆï¼Œå»æ›¿æ¢è¡¨åã€‚

å› æ­¤ï¼Œä¸€æ—¦æˆ‘ä»¬è®¡ç®—å®Œè¡¨åï¼Œä»¥æŸç§æ–¹å¼ä¼ é€’ç»™æ’ä»¶ä¸­çš„TableNameHandlerï¼Œé‚£ä¹ˆå°±æ— éœ€é‡å¤è®¡ç®—è¡¨åäº†ã€‚

ä¸è¿‡ï¼Œé—®é¢˜æ¥äº†ï¼šè¦çŸ¥é“åŠ¨æ€è¡¨åç§°æ’ä»¶ï¼Œä»¥åŠTableNameHandlerï¼Œéƒ½æ˜¯ç”±MybatisPluså†…éƒ¨è°ƒç”¨çš„ã€‚æˆ‘ä»¬æ— æ³•ä¼ é€’å‚æ•°ã€‚

é‚£ä¹ˆè¯¥å¦‚ä½•ä¼ é€’è¡¨åç§°å‘¢ï¼Ÿ

<br/>

è™½ç„¶æ— æ³•ä¼ å‚ï¼Œä½†æ˜¯ä»è®¡ç®—è¡¨åï¼Œåˆ°åŠ¨æ€è¡¨åæ’ä»¶æ‰§è¡Œï¼Œè°ƒç”¨TableNameHandlerï¼Œéƒ½æ˜¯åœ¨ä¸€ä¸ªçº¿ç¨‹å†…å®Œæˆçš„ã€‚è¦åœ¨ä¸€ä¸ªçº¿ç¨‹å†…å®ç°æ•°æ®å…±äº«ï¼Œè¯¥ç”¨ä»€ä¹ˆå‘¢ï¼Ÿ

å¤§å®¶åº”è¯¥å¾ˆå®¹æ˜“æƒ³åˆ°ï¼Œå°±æ˜¯ThreadLocal.

æˆ‘ä»¬å¯ä»¥åœ¨å®šæ—¶ä»»åŠ¡ä¸­è®¡ç®—å®ŒåŠ¨æ€è¡¨ååï¼Œå°†è¡¨åå­˜å…¥ThreadLocalï¼Œç„¶ååœ¨æ’ä»¶ä¸­ä»ThreadLocalä¸­è¯»å–å³å¯ï¼š

![image-20240214024424868](assets/image-20240214024424868.png)

<br/>

æˆ‘ä»¬åœ¨`tj-learning`çš„`com.tianji.learning.utils`åŒ…ä¸‹å®šä¹‰ä¸€ä¸ªä¼ é€’è¡¨åç§°çš„å·¥å…·ï¼š

![img](./assets/20230725154308109.jpg)

å…·ä½“ä»£ç å¦‚ä¸‹ï¼š

```Java
package com.tianji.learning.utils;

public class TableInfoContext {
    private static final ThreadLocal<String> TL = new ThreadLocal<>();

    public static void setInfo(String info) {
        TL.set(info);
    }

    public static String getInfo() {
        return TL.get();
    }

    public static void remove() {
        TL.remove();
    }
}
```

<br/>

ç„¶ååœ¨`tj-learning`æ¨¡å—ä¸‹å®šä¹‰ä¸€ä¸ªé…ç½®ç±»ï¼Œç”¨äºå®šä¹‰`DynamicTableNameInnterInterceptor`æ’ä»¶ï¼š

![img](./assets/20230725154306323.jpg)

å…·ä½“ä»£ç å¦‚ä¸‹ï¼š

```Java
package com.tianji.learning.config;

import com.baomidou.mybatisplus.extension.plugins.handler.TableNameHandler;
import com.baomidou.mybatisplus.extension.plugins.inner.DynamicTableNameInnerInterceptor;
import com.tianji.learning.utils.TableInfoContext;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

import java.util.HashMap;
import java.util.Map;

@Configuration
public class MybatisConfiguration {

    @Bean
    public DynamicTableNameInnerInterceptor dynamicTableNameInnerInterceptor() {
        // å‡†å¤‡ä¸€ä¸ªMapï¼Œç”¨äºå­˜å‚¨TableNameHandler
        Map<String, TableNameHandler> map = new HashMap<>(1);
        // å­˜å…¥ä¸€ä¸ªTableNameHandlerï¼Œç”¨æ¥æ›¿æ¢points_boardè¡¨åç§°
        // æ›¿æ¢æ–¹å¼ï¼Œå°±æ˜¯ä»TableInfoContextä¸­è¯»å–ä¿å­˜å¥½çš„åŠ¨æ€è¡¨å
        map.put("points_board", (sql, tableName) -> TableInfoContext.getInfo());
        return new DynamicTableNameInnerInterceptor(map);
    }
}
```

<br/>

æ’ä»¶è™½ç„¶å®šä¹‰å¥½äº†ï¼Œä½†æ˜¯è¯¥å¦‚ä½•ç»§æ‰¿åˆ°MybatisPlusä¸­å‘¢ï¼Ÿ

åœ¨å¤©æœºå­¦å ‚é¡¹ç›®ä¸­çš„tj-commonæ¨¡å—ä¸­ï¼Œå·²ç»å®ç°äº†MybatisPlusçš„è‡ªåŠ¨è£…é…ï¼Œå¹¶ä¸”å®šä¹‰äº†å¾ˆå¤šçš„MPæ’ä»¶ã€‚å¦‚æœæˆ‘ä»¬åœ¨è‡ªå·±çš„é¡¹ç›®ä¸­é‡æ–°å®šä¹‰MPé…ç½®ï¼Œå°±ä¼šå¯¼è‡´tj-commonä¸­çš„æ’ä»¶å¤±æ•ˆã€‚

<br/>

æ‰€ä»¥ï¼Œæˆ‘ä»¬åº”è¯¥ä¿®æ”¹`tj-common`ä¸­çš„MPé…ç½®ï¼Œå°†`DynamicTableNameInnerInterceptor`é…ç½®è¿›å»ã€‚æ‰¾åˆ°`tj-common`æ¨¡å—ä¸‹çš„`MybatisConfig`é…ç½®ï¼š

![img](./assets/20230725154307757.jpg)

ä¿®æ”¹å…¶ä¸­çš„æ‹¦æˆªå™¨é…ç½®ï¼š

![img](./assets/20230725154308002.jpg)

**æ³¨æ„**ï¼š

- ç”±äº`DynamicTableNameInnerInterceptor`å¹¶ä¸æ˜¯æ¯ä¸€ä¸ªå¾®æœåŠ¡éƒ½ç”¨äº†ï¼Œæ‰€ä»¥è¿™é‡ŒåŠ å…¥äº†@Autowired(required= false)ï¼Œé¿å…æœªå®šä¹‰è¯¥æ‹¦æˆªå™¨çš„å¾®æœåŠ¡æŠ¥é”™ã€‚
- MybatisPlusçš„æ’ä»¶å®šä¹‰é¡ºåºéå¸¸é‡è¦ï¼Œå¿…é¡»æŒ‰ç…§ä¸€å®šçš„é¡ºåºæ¥å®šä¹‰ã€‚å‚è€ƒï¼šhttps://baomidou.com/pages/2976a3/#innerinterceptor

<br/>

#### å®šæ—¶æŒä¹…åŒ–ä»»åŠ¡

åŠ¨æ€è¡¨åå·²ç»å‡†å¤‡å°±ç»ªï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°±å¯ä»¥å»å®šä¹‰å®šæ—¶ä»»åŠ¡ï¼Œå®ç°æ¦œå•æŒä¹…åŒ–äº†ã€‚

åœ¨`tj-learning`æ¨¡å—çš„`com.tianji.learning.handler.PointsBoardPersistentHandler`ä¸­æ·»åŠ ä¸€ä¸ªå®šæ—¶ä»»åŠ¡ï¼š

```Java
@XxlJob("savePointsBoard2DB")
public void savePointsBoard2DB(){
    // 1.è·å–ä¸Šæœˆæ—¶é—´
    LocalDateTime time = LocalDateTime.now().minusMonths(1);

    // 2.è®¡ç®—åŠ¨æ€è¡¨å
    // 2.1.æŸ¥è¯¢èµ›å­£ä¿¡æ¯
    Integer season = seasonService.querySeasonByTime(time);
    // 2.2.å°†è¡¨åå­˜å…¥ThreadLocal
    TableInfoContext.setInfo(POINTS_BOARD_TABLE_PREFIX + season);

    // 3.æŸ¥è¯¢æ¦œå•æ•°æ®
    // 3.1.æ‹¼æ¥KEY
    String key = RedisConstants.POINTS_BOARD_KEY_PREFIX + time.format(DateUtils.POINTS_BOARD_SUFFIX_FORMATTER);
    // 3.2.æŸ¥è¯¢æ•°æ®
    int pageNo = 1;
    int pageSize = 1000;
    while (true) {
        List<PointsBoard> boardList = pointsBoardService.queryCurrentBoardList(key, pageNo, pageSize);
        if (CollUtils.isEmpty(boardList)) {
            break;
        }
        // 4.æŒä¹…åŒ–åˆ°æ•°æ®åº“
        // 4.1.æŠŠæ’åä¿¡æ¯å†™å…¥id
        boardList.forEach(b -> {
            b.setId(b.getRank().longValue());
            b.setRank(null);
        });
        // 4.2.æŒä¹…åŒ–
        pointsBoardService.saveBatch(boardList);
        // 5.ç¿»é¡µ
        pageNo++;
    }
    // ä»»åŠ¡ç»“æŸï¼Œç§»é™¤åŠ¨æ€è¡¨å
    TableInfoContext.remove();
}
```

<br/>

éœ€è¦æ³¨æ„çš„ï¼Œç”±äºæ¦œå•æ•°æ®éå¸¸å¤šï¼Œä¸å¯èƒ½ä¸€æ¬¡æ€§æŸ¥å®Œï¼Œå› æ­¤è¿™é‡Œé‡‡ç”¨çš„æ˜¯åˆ†é¡µæŸ¥è¯¢çš„æ–¹å¼ã€‚è€Œåˆ†é¡µæŸ¥è¯¢è°ƒç”¨çš„æ˜¯`com.tianji.learning.service.IPointsBoardService`ä¸­çš„`queryCurrentBoardList`æ–¹æ³•ã€‚è¿™ä¸ªæ–¹æ³•åœ¨serviceå®ç°ç±»ä¸­æœ¬æ¥å°±æœ‰ï¼Œåªä¸è¿‡æ²¡æœ‰æŠ½å–åˆ°serviceæ¥å£ã€‚

å› æ­¤è¿™é‡Œè¦åœ¨`com.tianji.learning.service.IPointsBoardService`ä¸­æŠ½å–è¿™ä¸ªæ¥å£ï¼š

```Java
package com.tianji.learning.service;

import com.baomidou.mybatisplus.extension.service.IService;
import com.tianji.learning.domain.po.PointsBoard;
import com.tianji.learning.domain.query.PointsBoardQuery;
import com.tianji.learning.domain.vo.PointsBoardVO;

import java.util.List;

/**
 * <p>
 * å­¦éœ¸å¤©æ¢¯æ¦œ æœåŠ¡ç±»
 * </p>
 */
public interface IPointsBoardService extends IService<PointsBoard> {
    PointsBoardVO queryPointsBoardBySeason(PointsBoardQuery query);

    void createPointsBoardTableBySeason(Integer season);

    List<PointsBoard> queryCurrentBoardList(String key, Integer pageNo, Integer pageSize);
}
```

<br/>

æŠŠ`com.tianji.learning.service.impl.PointsBoardServiceImpl`ä¸­çš„æ–¹æ³•æ”¹ä¸ºpublicï¼š

![img](./assets/20230725154307410.jpg)

<br/>

#### XXL-JOBä»»åŠ¡åˆ†ç‰‡

åˆšæ‰å®šä¹‰çš„å®šæ—¶æŒä¹…åŒ–ä»»åŠ¡ï¼Œé€šè¿‡whileæ­»å¾ªç¯ï¼Œä¸åœçš„æŸ¥è¯¢æ•°æ®ï¼Œç›´åˆ°æŠŠæ‰€æœ‰æ•°æ®éƒ½æŒä¹…åŒ–ä¸ºæ­¢ã€‚è¿™æ ·å¦‚æœæ•°æ®é‡è¾¾åˆ°æ•°ç™¾ä¸‡ï¼Œäº¤ç»™ä¸€ä¸ªä»»åŠ¡æ‰§è¡Œå™¨æ¥å¤„ç†ä¼šè€—è´¹éå¸¸å¤šæ—¶é—´ã€‚

å› æ­¤ï¼Œå°†æ¥è‚¯å®šä¼šå°†å­¦ä¹ æœåŠ¡å¤šå®ä¾‹éƒ¨ç½²ï¼Œè¿™æ ·å°±ä¼šæœ‰å¤šä¸ªæ‰§è¡Œå™¨å¹¶è¡Œæ‰§è¡Œã€‚**ä½†æ˜¯ï¼Œ**å¦‚æœäº¤ç»™å¤šä¸ªä»»åŠ¡æ‰§è¡Œå™¨ï¼Œå¤§å®¶æ‰§è¡Œç›¸åŒä»£ç ï¼Œéƒ½ä»ç¬¬1é¡µé€é¡µå¤„ç†æ•°æ®ï¼Œåˆä¼šå‡ºç°é‡å¤å¤„ç†çš„æƒ…å†µã€‚

æ€ä¹ˆåŠï¼Ÿ

è¿™å°±è¦ç”¨åˆ°ä»»åŠ¡åˆ†ç‰‡çš„æ–¹æ¡ˆäº†ã€‚

<br/>

æ€æ ·æ‰èƒ½ç¡®ä¿ä»»åŠ¡ä¸é‡å¤å‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥å‚è€ƒæ‰‘å…‹ç‰Œå‘ç‰Œçš„åŸç†ï¼š

- é€ä¸€ç»™æ¯ä¸ªäººå‘ç‰Œ
- å‘å®Œä¸€åœˆåï¼Œå†å›å¤´ç»™ç¬¬ä¸€ä¸ªäººå‘
- é‡å¤ä¸Šè¿°åŠ¨ä½œï¼Œç›´åˆ°ç‰Œå‘å®Œä¸ºæ­¢

![img](./assets/20230725154310238.jpg)

ä¸æ­¤ç±»ä¼¼ï¼Œæ¯”å¦‚æˆ‘ä»¬å¯åŠ¨äº†3ä¸ªæœåŠ¡å®ä¾‹ï¼Œå°±æœ‰3ä¸ªæ‰§è¡Œå™¨ã€‚æˆ‘ä»¬å¯ä»¥æŠŠæ‰§è¡Œå™¨å½“åšæ‰“ç‰Œçš„äººï¼Œç„¶åæŠŠæ¯ä¸€é¡µæ•°æ®ä½œä¸ºä¸€å¼ ç‰Œï¼š

- æŠŠæ¯é¡µæ•°æ®é€ä¸€åˆ†å‘ç»™æ¯ä¸ªæ‰§è¡Œå™¨ï¼Œ
- å‘å®Œä¸€åœˆåï¼Œå†å›åˆ°ç¬¬ä¸€ä¸ªæ‰§è¡Œå™¨ã€‚
- ç›´åˆ°æ‰€æœ‰é¡µæ•°æ®éƒ½å‘æ”¾å®Œæ¯•ã€‚

é‚£ä¹ˆæ•°æ®åˆ†å‘çš„è¿‡ç¨‹å¦‚å›¾ï¼š

![img](./assets/20230725154311054.jpg)

æœ€ç»ˆï¼Œæ¯ä¸ªæ‰§è¡Œå™¨å¤„ç†çš„æ•°æ®é¡µæƒ…å†µï¼š

- æ‰§è¡Œå™¨1ï¼šå¤„ç†ç¬¬1ã€4ã€7ã€10ã€13ã€...é¡µæ•°æ®
- æ‰§è¡Œå™¨2ï¼šå¤„ç†ç¬¬2ã€5ã€8ã€11ã€14ã€...é¡µæ•°æ®
- æ‰§è¡Œå™¨3ï¼šå¤„ç†ç¬¬3ã€6ã€9ã€12ã€15ã€...é¡µæ•°æ®

<br/>

è¦æƒ³çŸ¥é“æ¯ä¸€ä¸ªæ‰§è¡Œå™¨æ‰§è¡Œå“ªäº›é¡µæ•°æ®ï¼Œåªè¦å¼„æ¸…æ¥šä¸¤ä¸ªå…³é”®å‚æ•°å³å¯ï¼š

- èµ·å§‹é¡µç ï¼špageNo
- ä¸‹ä¸€é¡µçš„è·¨åº¦ï¼šstep

<br/>

è€Œè¿™ä¸¤ä¸ªå‚æ•°æ˜¯æœ‰è§„å¾‹çš„ï¼š

- èµ·å§‹é¡µç ï¼šæ‰§è¡Œå™¨ç¼–å·æ˜¯å¤šå°‘ï¼Œèµ·å§‹é¡µç å°±æ˜¯å¤šå°‘
- é¡µè·¨åº¦ï¼šæ‰§è¡Œå™¨æœ‰å‡ ä¸ªï¼Œè·¨åº¦å°±æ˜¯å¤šå°‘ã€‚ä¹Ÿå°±æ˜¯è¯´ä½ è¦è·³è¿‡åˆ«äººè¯»å–è¿‡çš„é¡µç 

<br/>

å› æ­¤ï¼Œç°åœ¨çš„å…³é”®å°±æ˜¯è·å–ä¸¤ä¸ªæ•°æ®ï¼š

- æ‰§è¡Œå™¨ç¼–å·
- æ‰§è¡Œå™¨æ•°é‡

è¿™ä¸¤ä¸ªå‚æ•°XXL-JOBä½œä¸ºä»»åŠ¡è°ƒåº¦ä¸­å¿ƒï¼Œè‚¯å®šæ˜¯çŸ¥é“çš„ï¼Œè€Œä¸”ä¹Ÿæä¾›äº†APIå¸®åŠ©æˆ‘ä»¬è·å–ï¼š

![img](./assets/20230725154308382.jpg)

<br/>

è¿™é‡Œçš„åˆ†ç‰‡åºå·å…¶å®å°±æ˜¯æ‰§è¡Œå™¨åºå·ï¼Œä¸è¿‡æ˜¯ä»0å¼€å§‹ï¼Œé‚£æˆ‘ä»¬åªè¦å¯¹åºå·+1ï¼Œå°±å¯ä»¥ä½œä¸ºèµ·å§‹é¡µç äº†ã€‚

<br/>

å› æ­¤ï¼Œæœ€ç»ˆæˆ‘ä»¬æ”¹é€ ä»£ç ï¼Œå®ç°æ•°æ®åˆ†ç‰‡å¦‚å›¾ï¼š

```Java
@XxlJob("savePointsBoard2DB")
public void savePointsBoard2DB(){
    // 1.è·å–ä¸Šæœˆæ—¶é—´
    LocalDateTime time = LocalDateTime.now().minusMonths(1);

    // 2.è®¡ç®—åŠ¨æ€è¡¨å
    // 2.1.æŸ¥è¯¢èµ›å­£ä¿¡æ¯
    Integer season = seasonService.querySeasonByTime(time);
    // 2.2.å­˜å…¥ThreadLocal
    TableInfoContext.setInfo(POINTS_BOARD_TABLE_PREFIX + season);

    // 3.æŸ¥è¯¢æ¦œå•æ•°æ®
    // 3.1.æ‹¼æ¥KEY
    String key = RedisConstants.POINTS_BOARD_KEY_PREFIX + time.format(DateUtils.POINTS_BOARD_SUFFIX_FORMATTER);
    // 3.2.æŸ¥è¯¢æ•°æ®
    int index = XxlJobHelper.getShardIndex();
    int total = XxlJobHelper.getShardTotal();
    int pageNo = index + 1; // èµ·å§‹é¡µï¼Œå°±æ˜¯åˆ†ç‰‡åºå·+1
    int pageSize = 10;
    while (true) {
        List<PointsBoard> boardList = pointsBoardService.queryCurrentBoardList(key, pageNo, pageSize);
        if (CollUtils.isEmpty(boardList)) {
            break;
        }
        // 4.æŒä¹…åŒ–åˆ°æ•°æ®åº“
        // 4.1.æŠŠæ’åä¿¡æ¯å†™å…¥id
        boardList.forEach(b -> {
            b.setId(b.getRank().longValue());
            b.setRank(null);
        });
        // 4.2.æŒä¹…åŒ–
        pointsBoardService.saveBatch(boardList);
        // 5.ç¿»é¡µï¼Œè·³è¿‡Nä¸ªé¡µï¼ŒNå°±æ˜¯åˆ†ç‰‡æ•°é‡
        pageNo+=total;
    }

    TableInfoContext.remove();
}
```

<br/>

#### æ¸…ç†Redisç¼“å­˜ä»»åŠ¡

å½“ä»»åŠ¡æŒä¹…åŒ–ä»¥åï¼Œæˆ‘ä»¬è¿˜è¦æ¸…ç†Redisä¸­çš„ä¸Šèµ›å­£çš„æ¦œå•æ•°æ®ï¼Œé¿å…è¿‡å¤šçš„å†…å­˜å ç”¨ã€‚

åœ¨`tj-learning`æ¨¡å—çš„`com.tianji.learning.handler.PointsBoardPersistentHandler`ä¸­æ·»åŠ ä¸€ä¸ªå®šæ—¶ä»»åŠ¡ï¼š

```Java
package com.tianji.learning.handler;

import com.tianji.common.utils.CollUtils;
import com.tianji.common.utils.DateUtils;
import com.tianji.learning.constants.RedisConstants;
import com.tianji.learning.domain.po.PointsBoard;
import com.tianji.learning.service.IPointsBoardSeasonService;
import com.tianji.learning.service.IPointsBoardService;
import com.tianji.learning.utils.TableInfoContext;
import com.xxl.job.core.context.XxlJobHelper;
import com.xxl.job.core.handler.annotation.XxlJob;
import lombok.RequiredArgsConstructor;
import org.springframework.data.redis.core.StringRedisTemplate;
import org.springframework.stereotype.Component;

import java.time.LocalDateTime;
import java.util.List;

import static com.tianji.learning.constants.LearningConstants.POINTS_BOARD_TABLE_PREFIX;

@Component
@RequiredArgsConstructor
public class PointsBoardPersistentHandler {

    private final IPointsBoardSeasonService seasonService;

    private final IPointsBoardService pointsBoardService;

    private final StringRedisTemplate redisTemplate;

    // ... ç•¥

    @XxlJob("clearPointsBoardFromRedis")
    public void clearPointsBoardFromRedis(){
        // 1.è·å–ä¸Šæœˆæ—¶é—´
        LocalDateTime time = LocalDateTime.now().minusMonths(1);
        // 2.è®¡ç®—key
        String key = RedisConstants.POINTS_BOARD_KEY_PREFIX + time.format(DateUtils.POINTS_BOARD_SUFFIX_FORMATTER);
        // 3.åˆ é™¤
        redisTemplate.unlink(key);
    }
}
```

<br/>

#### ä»»åŠ¡é“¾

ç°åœ¨ï¼Œæ‰€æœ‰ä»»åŠ¡éƒ½å·²ç»å®šä¹‰å®Œæ¯•ã€‚æ¥ä¸‹æ¥å°±ç»™é…ç½®ä»»åŠ¡è°ƒåº¦äº†ã€‚

æˆ‘ä»¬æœ€ç»ˆæœŸæœ›çš„ä»»åŠ¡æ‰§è¡Œé¡ºåºæ˜¯è¿™æ ·çš„ï¼š

![image-20240214024455682](assets/image-20240214024455682.png)

ä½†é—®é¢˜æ¥äº†ï¼Œæˆ‘ä»¬è¯¥å¦‚ä½•æ§åˆ¶ä¸‰ä¸ªä»»åŠ¡çš„æ‰§è¡Œé¡ºåºå‘¢ï¼Ÿ

è¿™å°±è¦å€ŸåŠ©äºXXL-JOBä¸­çš„å­ä»»åŠ¡åŠŸèƒ½äº†ã€‚

<br/>

é¦–å…ˆï¼Œæˆ‘ä»¬æŠŠæŒä¹…åŒ–æ¦œå•æ•°æ®ã€æ¸…ç†Redisä¸­å†å²æ¦œå•çš„ä»»åŠ¡ä¹Ÿåœ¨XXL-JOBä¸­å®šä¹‰å‡ºæ¥ã€‚

é¦–å…ˆæ˜¯æŒä¹…åŒ–æ¦œå•ï¼š

![img](./assets/20230725154309412.jpg)

<br/>

ç„¶åæ˜¯æ¸…ç†Redisçš„ä»»åŠ¡ï¼š

![img](./assets/20230725154308512.jpg)

<br/>

æ¥ä¸‹æ¥ï¼Œå›åˆ°ä»»åŠ¡ç®¡ç†é¡µé¢ï¼Œä¼šçœ‹åˆ°3ä¸ªä»»åŠ¡éƒ½æ·»åŠ æˆåŠŸï¼Œå¹¶ä¸”æ¯ä¸ªä»»åŠ¡éƒ½æœ‰è‡ªå·±çš„IDï¼š

![img](./assets/20230725154309279.jpg)

è¦æƒ³è®©ä»»åŠ¡Aã€Bä¾æ¬¡æ‰§è¡Œï¼Œå…¶å®å°±æ˜¯é…ç½®ä»»åŠ¡Bä½œä¸ºä»»åŠ¡Açš„å­ä»»åŠ¡ã€‚å› æ­¤ï¼Œæˆ‘ä»¬æŒ‰ç…§ä¸‹é¢æ–¹å¼é…ç½®ï¼š

- åˆ›å»ºå†å²æ¦œå•è¡¨ï¼ˆ10ï¼‰çš„å­ä»»åŠ¡æ˜¯æŒä¹…åŒ–æ¦œå•æ•°æ®ä»»åŠ¡ï¼ˆ12ï¼‰
- æŒä¹…åŒ–æ¦œå•æ•°æ®ä»»åŠ¡ï¼ˆ12ï¼‰çš„å­ä»»åŠ¡æ˜¯æ¸…ç†Redisä¸­çš„å†å²æ¦œå•ï¼ˆ13ï¼‰

<br/>

ä¹Ÿå°±æ˜¯è¯´ï¼š10çš„å­ä»»åŠ¡æ˜¯12,  12çš„å­ä»»åŠ¡æ˜¯13

<br/>

é¦–å…ˆï¼Œç‚¹å‡»åˆ›å»ºå†å²ç»‘å®šè¡¨åé¢çš„æ“ä½œï¼Œç„¶åç¼–è¾‘ï¼š

![img](./assets/20230725154309486.jpg)

<br/>

ç„¶ååœ¨å­ä»»åŠ¡ä¸­ï¼Œå¡«å†™æŒä¹…åŒ–æ¦œå•æ•°æ®ä»»åŠ¡çš„idï¼Œæœ¬ä¾‹ä¸­æ˜¯12ï¼š

![img](./assets/20230725154308821.jpg)

ä¿å­˜ã€‚

<br/>

ç„¶åç‚¹å‡»æŒä¹…åŒ–æ¦œå•æ•°æ®ä»»åŠ¡åé¢çš„æ“ä½œï¼Œç¼–è¾‘ï¼š

![img](./assets/20230725154309174.jpg)

<br/>

ç„¶ååœ¨å­ä»»åŠ¡ä¸€æ ï¼Œå¡«å†™æ¸…ç†Redisä¸­çš„å†å²æ¦œå•çš„ä»»åŠ¡idï¼Œæœ¬ä¾‹ä¸­æ˜¯13ï¼š

![img](./assets/20230725154309693.jpg)

å¥½äº†ï¼Œä»»åŠ¡é“¾å½¢æˆäº†ã€‚

<br/>

æ¥ä¸‹æ¥ï¼Œæ‰§è¡Œä¸€æ¬¡åˆ›å»ºæ¦œå•è¡¨ä»»åŠ¡ï¼Œå°±ä¼šå‘ç°åç»­çš„ä¸¤ä¸ªä»»åŠ¡ä¹Ÿä¾æ¬¡æ‰§è¡Œäº†ã€‚

## ç»ƒä¹ 

### æŸ¥è¯¢ç§¯åˆ†æ¦œ

å®Œå–„æŸ¥è¯¢å­¦éœ¸ç§¯åˆ†æ¦œåŠŸèƒ½ï¼Œè¯¾å ‚ä¸­åªå®ç°äº†å¯¹å½“å‰èµ›å­£æ¦œå•çš„æŸ¥è¯¢ï¼Œå¤§å®¶éœ€è¦å®Œå–„å¯¹å†å²æ¦œå•æ•°æ®çš„æŸ¥è¯¢ã€‚

æ³¨æ„ï¼šå†å²æ¦œå•æ•°æ®åœ¨ä¸åŒçš„è¡¨ä¸­ã€‚

<br/>

### æ¸…ç†ç§¯åˆ†æ˜ç»†

ç§¯åˆ†æ˜ç»†æ•°æ®æ¯”ç§¯åˆ†æ¦œå•æ•°æ®é‡æ›´å¤§ï¼Œå…¨éƒ¨æ”¾åˆ°ä¸€å¼ è¡¨ä¸­ä¸å¤ªåˆé€‚ã€‚å»ºè®®æŒ‰ç…§èµ›å­£çš„æ—¥æœŸå¯¹ç§¯åˆ†æ˜ç»†æ•°æ®åšæ°´å¹³æ‹†åˆ†ï¼š

- å½“å‰èµ›å­£çš„æ•°æ®ä¾ç„¶ä¿å­˜åœ¨points_recordè¡¨ä¸å˜
- æ¯ä¸ªå†å²èµ›å­£çš„ç§¯åˆ†æ˜ç»†éœ€è¦ä»points_recordè¡¨è¿ç§»åˆ°ä¸€å¼ ç‹¬ç«‹çš„è¡¨ä¸­
- è¡¨åç§°è§„åˆ™points_record_xxï¼Œè¿™é‡Œçš„xxå°±æ˜¯èµ›å­£id

é€šè¿‡ä¸€ä¸ªå®šæ—¶ä»»åŠ¡åœ¨æ¯æœˆåˆå®Œæˆæ•°æ®è¿ç§»ã€‚

<br/>

## æ€»ç»“

:::warning  ğŸ’¡æ€è€ƒï¼šä½ åœ¨é¡¹ç›®ä¸­è´Ÿè´£ç§¯åˆ†æ’è¡Œæ¦œåŠŸèƒ½ï¼Œè¯´è¯´çœ‹ä½ ä»¬æ’è¡Œæ¦œæ€ä¹ˆè®¾è®¡å®ç°çš„ï¼Ÿ

ç­”ï¼šæˆ‘ä»¬çš„æ’è¡Œæ¦œåŠŸèƒ½åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼šä¸€ä¸ªæ˜¯å½“å‰èµ›å­£æ’è¡Œæ¦œï¼Œä¸€ä¸ªæ˜¯å†å²æ’è¡Œæ¦œã€‚

å› ä¸ºæˆ‘ä»¬çš„äº§å“è®¾è®¡æ˜¯æ¯ä¸ªæœˆä¸ºä¸€ä¸ªèµ›å­£ï¼Œæœˆåˆæ¸…é›¶ç§¯åˆ†è®°å½•ï¼Œè¿™æ ·å­¦å‘˜å°±æœ‰æŒç»­çš„åŠ¨åŠ›å»å­¦ä¹ ã€‚è¿™å°±æœ‰äº†èµ›å­£çš„æ¦‚å¿µï¼Œå› æ­¤ä¹Ÿå°±æœ‰äº†å½“å‰èµ›å­£æ¦œå•å’Œå†å²æ¦œå•çš„åŒºåˆ†ï¼Œå…¶å®ç°æ€è·¯ä¹Ÿä¸ä¸€æ ·ã€‚

é¦–å…ˆè¯´å½“å‰èµ›å­£æ¦œå•ï¼Œæˆ‘ä»¬é‡‡ç”¨äº†Redisçš„SortedSetæ¥å®ç°ã€‚memberæ˜¯ç”¨æˆ·idï¼Œscoreå°±æ˜¯å½“æœˆç§¯åˆ†æ€»å€¼ã€‚æ¯å½“ç”¨æˆ·äº§ç”Ÿç§¯åˆ†è¡Œä¸ºçš„æ—¶å€™ï¼Œè·å–ç§¯åˆ†æ—¶ï¼Œå°±ä¼šæ›´æ–°scoreå€¼ã€‚è¿™æ ·Rediså°±ä¼šè‡ªåŠ¨å½¢æˆæ¦œå•äº†ã€‚éå¸¸æ–¹ä¾¿ä¸”é«˜æ•ˆã€‚

ç„¶åå†è¯´å†å²æ¦œå•ï¼Œå†å²æ¦œå•è‚¯å®šæ˜¯ä¿å­˜åˆ°æ•°æ®åº“äº†ã€‚ä¸è¿‡ç”±äºæ•°æ®è¿‡å¤šï¼Œæ‰€ä»¥éœ€è¦å¯¹æ•°æ®åšæ°´å¹³æ‹†åˆ†ï¼Œæˆ‘ä»¬ç›®å‰çš„æ€è·¯æ˜¯æŒ‰ç…§èµ›å­£æ¥æ‹†åˆ†ï¼Œä¹Ÿå°±æ˜¯æ¯ä¸€ä¸ªèµ›å­£çš„æ¦œå•å•ç‹¬ä¸€å¼ è¡¨ã€‚è¿™æ ·åšæœ‰å‡ ä¸ªå¥½å¤„ï¼š

- æ‹†åˆ†æ•°æ®æ—¶æ¯”è¾ƒè‡ªç„¶ï¼Œæ— éœ€åšé¢å¤–å¤„ç†
- æŸ¥è¯¢æ•°æ®æ—¶å¾€å¾€éƒ½æ˜¯æŒ‰ç…§èµ›å­£æ¥æŸ¥è¯¢ï¼Œè¿™æ ·ä¸€æ¬¡åªéœ€è¦æŸ¥ä¸€å¼ è¡¨ï¼Œä¸å­˜åœ¨è·¨è¡¨æŸ¥è¯¢é—®é¢˜

å› æ­¤æˆ‘ä»¬å°±ä¸éœ€è¦ç”¨åˆ°åˆ†åº“åˆ†è¡¨çš„æ’ä»¶äº†ï¼Œç›´æ¥åœ¨ä¸šåŠ¡å±‚åˆ©ç”¨MybatisPluså°±å¯ä»¥å®ç°åŠ¨æ€è¡¨åï¼ŒåŠ¨æ€æ’å…¥äº†ã€‚ç®€å•é«˜æ•ˆã€‚

æˆ‘ä»¬ä¼šåˆ©ç”¨ä¸€ä¸ªå®šæ—¶ä»»åŠ¡åœ¨æ¯æœˆåˆç”Ÿæˆä¸Šèµ›å­£çš„æ¦œå•è¡¨ï¼Œç„¶åå†ç”¨ä¸€ä¸ªå®šæ—¶ä»»åŠ¡è¯»å–Redisä¸­çš„ä¸Šèµ›å­£æ¦œå•æ•°æ®ï¼ŒæŒä¹…åŒ–åˆ°æ•°æ®åº“ä¸­ã€‚æœ€åå†æœ‰ä¸€ä¸ªå®šæ—¶ä»»åŠ¡æ¸…ç†Redisä¸­çš„å†å²æ•°æ®ã€‚

è¿™é‡Œè¦è¯´æ˜ä¸€ä¸‹ï¼Œè¿™é‡Œä¸‰ä¸ªä»»åŠ¡æ˜¯æœ‰å…³è”çš„ï¼Œä¹‹æ‰€ä»¥è®©ä»»åŠ¡åˆ†å¼€å®šä¹‰ï¼Œæ˜¯ä¸ºäº†é¿å…ä»»åŠ¡è€¦åˆã€‚è¿™æ ·åœ¨éƒ¨åˆ†ä»»åŠ¡å¤±è´¥æ—¶ï¼Œå¯ä»¥å•ç‹¬é‡è¯•ï¼Œæ— éœ€æ‰€æœ‰ä»»åŠ¡ä»å¤´é‡è¯•ã€‚

å½“ç„¶ï¼Œæœ€ç»ˆæˆ‘ä»¬è‚¯å®šè¦ç¡®ä¿è¿™ä¸‰ä¸ªä»»åŠ¡çš„æ‰§è¡Œé¡ºåºï¼Œä¸€å®šæ˜¯ä¾æ¬¡æ‰§è¡Œçš„ã€‚

<br/>

ğŸ’¡**æ€è€ƒï¼šä½ ä»¬ä½¿ç”¨Redisçš„SortedSetæ¥ä¿å­˜æ¦œå•æ•°æ®ï¼Œå¦‚æœç”¨æˆ·é‡éå¸¸å¤šæ€ä¹ˆåŠï¼Ÿ**

é¦–å…ˆRedisçš„SortedSetåº•å±‚åˆ©ç”¨äº†è·³è¡¨æœºåˆ¶ï¼Œæ€§èƒ½è¿˜æ˜¯éå¸¸ä¸é”™çš„ã€‚å³ä¾¿æœ‰ç™¾ä¸‡çº§åˆ«çš„ç”¨æˆ·é‡ï¼Œåˆ©ç”¨SortedSetä¹Ÿæ²¡ä»€ä¹ˆé—®é¢˜ï¼Œæ€§èƒ½ä¸Šä¹Ÿèƒ½å¾—åˆ°ä¿è¯ã€‚åœ¨æˆ‘ä»¬çš„é¡¹ç›®ç”¨æˆ·é‡ä¸‹ï¼Œå®Œå…¨è¶³å¤Ÿã€‚

å½“ç³»ç»Ÿç”¨æˆ·é‡è§„æ¨¡è¾¾åˆ°æ•°åƒä¸‡ï¼Œä¹ƒè‡³æ•°äº¿æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥é‡‡ç”¨åˆ†æ²»çš„æ€æƒ³ï¼Œå°†ç”¨æˆ·æ•°æ®æŒ‰ç…§ç§¯åˆ†èŒƒå›´åˆ’åˆ†ä¸ºå¤šä¸ªæ¡¶ã€‚

ç„¶åä¸ºæ¯ä¸ªæ¡¶åˆ›å»ºä¸€ä¸ªSortedSetç±»å‹çš„keyï¼Œè¿™æ ·å°±å¯ä»¥å°†æ•°æ®åˆ†æ•£ï¼Œå‡å°‘å•ä¸ªKEYçš„æ•°æ®è§„æ¨¡äº†ã€‚

è€Œè¦è®¡ç®—æ’åæ—¶ï¼Œåªéœ€è¦æŒ‰ç…§èŒƒå›´æŸ¥è¯¢å‡ºç”¨æˆ·ç§¯åˆ†æ‰€åœ¨çš„æ¡¶ï¼Œå†ç´¯åŠ åˆ†å€¼èŒƒå›´æ¯”ä»–é«˜çš„æ¡¶çš„ç”¨æˆ·æ•°é‡å³å¯ã€‚ä¾ç„¶éå¸¸ç®€å•ã€é«˜æ•ˆã€‚

<br/>

ğŸ’¡**æ€è€ƒï¼šä½ ä»¬ä½¿ç”¨å†å²æ¦œå•é‡‡ç”¨çš„å®šæ—¶ä»»åŠ¡æ¡†æ¶æ˜¯å“ªä¸ªï¼Ÿå¤„ç†æ•°ç™¾ä¸‡çš„æ¦œå•æ•°æ®æ—¶ä»»åŠ¡æ˜¯å¦‚ä½•åˆ†ç‰‡çš„ï¼Ÿä½ ä»¬æ˜¯å¦‚ä½•ç¡®ä¿å¤šä¸ªä»»åŠ¡ä¾æ¬¡æ‰§è¡Œçš„å‘¢ï¼Ÿ**

ç­”ï¼šæˆ‘ä»¬é‡‡ç”¨çš„æ˜¯XXL-JOBæ¡†æ¶ã€‚

XXL-JOBè‡ªå¸¦ä»»åŠ¡åˆ†ç‰‡å¹¿æ’­æœºåˆ¶ï¼Œæ¯ä¸€ä¸ªä»»åŠ¡æ‰§è¡Œå™¨éƒ½èƒ½é€šè¿‡APIå¾—åˆ°è‡ªå·±çš„åˆ†ç‰‡ç¼–å·ã€æ€»åˆ†ç‰‡æ•°é‡ã€‚åœ¨åšæ¦œå•æ•°æ®æ‰¹å¤„ç†æ—¶ï¼Œæˆ‘ä»¬æ˜¯æŒ‰ç…§åˆ†é¡µæŸ¥è¯¢çš„æ–¹å¼ï¼š

- æ¯ä¸ªæ‰§è¡Œå™¨çš„è¯»å–çš„èµ·å§‹é¡µéƒ½æ˜¯è‡ªå·±çš„åˆ†ç‰‡ç¼–å·+1ï¼Œä¾‹å¦‚ç¬¬ä¸€ä¸ªæ‰§è¡Œå™¨ï¼Œå…¶èµ·å§‹é¡µå°±æ˜¯1ï¼Œç¬¬äºŒä¸ªæ‰§è¡Œå™¨ï¼Œå…¶èµ·å§‹é¡µå°±æ˜¯2ï¼Œä»¥æ­¤ç±»æ¨
- ç„¶åä¸æ˜¯é€é¡µæŸ¥è¯¢ï¼Œè€Œæ˜¯æœ‰ä¸€ä¸ªé¡µçš„è·¨åº¦ï¼Œè·¨åº¦å€¼å°±æ˜¯åˆ†ç‰‡æ€»æ•°é‡ã€‚ä¾‹å¦‚åˆ†äº†3ç‰‡ï¼Œé‚£ä¹ˆè·¨åº¦å°±æ˜¯3

æ­¤æ—¶ï¼Œç¬¬ä¸€ä¸ªåˆ†ç‰‡å¤„ç†çš„æ•°æ®å°±æ˜¯ç¬¬1ã€4ã€7ã€10ã€13ç­‰å‡ é¡µæ•°æ®ï¼Œç¬¬äºŒä¸ªåˆ†ç‰‡å¤„ç†çš„å°±æ˜¯ç¬¬2ã€5ã€8ã€11ã€14ç­‰é¡µçš„æ•°æ®ï¼Œç¬¬ä¸‰ä¸ªåˆ†ç‰‡å¤„ç†çš„å°±æ˜¯ç¬¬3ã€6ã€9ã€12ã€15ç­‰é¡µçš„æ•°æ®ã€‚

è¿™æ ·å°±èƒ½ç¡®ä¿æ‰€æœ‰æ•°æ®éƒ½ä¼šè¢«å¤„ç†ï¼Œè€Œä¸”æ¯ä¸€ä¸ªæ‰§è¡Œå™¨éƒ½æ‰§è¡Œçš„æ˜¯ä¸åŒçš„æ•°æ®äº†ã€‚

æœ€åï¼Œè¦ç¡®ä¿å¤šä¸ªä»»åŠ¡çš„æ‰§è¡Œé¡ºåºï¼Œå¯ä»¥åˆ©ç”¨XXL-JOBä¸­çš„å­ä»»åŠ¡åŠŸèƒ½ã€‚æ¯”å¦‚æœ‰ä»»åŠ¡Aã€Bã€Cï¼Œè¦æŒ‰ç…§å­—æ¯é¡ºåºä¾æ¬¡æ‰§è¡Œï¼Œæˆ‘ä»¬å°±å¯ä»¥å°†Cè®¾ç½®ä¸ºBçš„å­ä»»åŠ¡ï¼Œå†å°†Bè®¾ç½®ä¸ºAçš„å­ä»»åŠ¡ã€‚ç„¶åç»™Aè®¾ç½®ä¸€ä¸ªè§¦å‘å™¨ã€‚

è¿™æ ·ï¼Œå½“Aè§¦å‘æ—¶ï¼Œå°±ä¼šä¾æ¬¡æ‰§è¡Œè¿™ä¸‰ä¸ªä»»åŠ¡äº†ã€‚

:::
